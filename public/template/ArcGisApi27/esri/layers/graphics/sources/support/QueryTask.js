// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Error ../../../../core/has ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../support/infoFor3D ../../../support/source/DataLayerSource ../../../../rest/utils ../../../../rest/query/executeForCount ../../../../rest/query/executeForExtent ../../../../rest/query/executeForIds ../../../../rest/query/executeQueryJSON ../../../../rest/query/executeQueryPBF ../../../../rest/support/FeatureSet ../../../../rest/support/Query".split(" "),
function(k,v,l,h,y,z,n,A,m,W,X,B,r,w,C,D,E,F,G,H,I,J){const x=t=>Object.freeze(Object.defineProperty({__proto__:null,default:t},Symbol.toStringTag,{value:"Module"}));h=function(t){function u(a){a=t.call(this,a)||this;a.dynamicDataSource=null;a.fieldsIndex=null;a.gdbVersion=null;a.infoFor3D=null;a.pbfSupported=!1;a.queryAttachmentsSupported=!1;a.sourceSpatialReference=null;a.url=null;return a}v._inherits(u,t);var f=u.prototype;f.execute=async function(a,b){const c=await this.executeJSON(a,b);return this.featureSetFromJSON(a,
c,b)};f.executeJSON=async function(a,b){const c=this._normalizeQuery(a);a=null!=a.outStatistics?.[0];const e=z("featurelayer-pbf-statistics");a=!a||e;let d;if(this.pbfSupported&&a)try{d=await H.executeRawQueryPBF(this.url,c,b)}catch(g){if("query:parsing-pbf"===g.name)this.pbfSupported=!1;else throw g;}this.pbfSupported&&a||(d=await G.executeRawQueryJSON(this.url,c,b));this._normalizeFields(d.fields);return d};f.featureSetFromJSON=async function(a,b,c){if(!this._queryIs3DObjectFormat(a)||null==this.infoFor3D||
!b.features)return I.fromJSON(b);({meshFeatureSetFromJSON:c}=await n.whenOrAbort(new Promise((e,d)=>k(["../../../../rest/support/meshFeatureSet"],e,d)),c));return c(a,this.infoFor3D,b)};f.executeForCount=function(a,b){return D.executeForCount(this.url,this._normalizeQuery(a),b)};f.executeForExtent=function(a,b){return E.executeForExtent(this.url,this._normalizeQuery(a),b)};f.executeForIds=function(a,b){return F.executeForIds(this.url,this._normalizeQuery(a),b)};f.executeRelationshipQuery=async function(a,
b){const [{default:c},{executeRelationshipQuery:e}]=await n.whenOrAbort(Promise.all([new Promise((d,g)=>k(["../../../../rest/support/RelationshipQuery"],q=>d(x(q)),g)),new Promise((d,g)=>k(["../../../../rest/query/executeRelationshipQuery"],d,g))]),b);a=c.from(a);if(this.gdbVersion||this.dynamicDataSource)a=a.clone(),a.gdbVersion=a.gdbVersion||this.gdbVersion,a.dynamicDataSource=a.dynamicDataSource||this.dynamicDataSource;return e(this.url,a,b)};f.executeRelationshipQueryForCount=async function(a,
b){const [{default:c},{executeRelationshipQueryForCount:e}]=await n.whenOrAbort(Promise.all([new Promise((d,g)=>k(["../../../../rest/support/RelationshipQuery"],q=>d(x(q)),g)),new Promise((d,g)=>k(["../../../../rest/query/executeRelationshipQuery"],d,g))]),b);a=c.from(a);if(this.gdbVersion||this.dynamicDataSource)a=a.clone(),a.gdbVersion=a.gdbVersion||this.gdbVersion,a.dynamicDataSource=a.dynamicDataSource||this.dynamicDataSource;return e(this.url,a,b)};f.executeAttachmentQuery=async function(a,b){const {executeAttachmentQuery:c,
fetchAttachments:e,processAttachmentQueryResult:d}=await n.whenOrAbort(new Promise((q,p)=>k(["../../../../rest/query/operations/queryAttachments"],q,p)),b),g=C.parseUrl(this.url);a=await (this.queryAttachmentsSupported?c(g,a,b):e(g,a,b));return d(g,a)};f.executeTopFeaturesQuery=async function(a,b){const {executeTopFeaturesQuery:c}=await n.whenOrAbort(new Promise((e,d)=>k(["../../../../rest/query/executeTopFeaturesQuery"],e,d)),b);return c(this.parsedUrl,a,this.sourceSpatialReference,b)};f.executeForTopIds=
async function(a,b){const {executeForTopIds:c}=await n.whenOrAbort(new Promise((e,d)=>k(["../../../../rest/query/executeForTopIds"],e,d)),b);return c(this.parsedUrl,a,b)};f.executeForTopExtents=async function(a,b){const {executeForTopExtents:c}=await n.whenOrAbort(new Promise((e,d)=>k(["../../../../rest/query/executeForTopExtents"],e,d)),b);return c(this.parsedUrl,a,b)};f.executeForTopCount=async function(a,b){const {executeForTopCount:c}=await n.whenOrAbort(new Promise((e,d)=>k(["../../../../rest/query/executeForTopCount"],
e,d)),b);return c(this.parsedUrl,a,b)};f._normalizeQuery=function(a){let b=J.from(a);b.sourceSpatialReference=b.sourceSpatialReference||this.sourceSpatialReference;if(this.gdbVersion||this.dynamicDataSource)b=b===a?b.clone():b,b.gdbVersion=a.gdbVersion||this.gdbVersion,b.dynamicDataSource=a.dynamicDataSource?w.DataLayerSource.from(a.dynamicDataSource):this.dynamicDataSource;const {infoFor3D:c}=this;if(null!=c&&this._queryIs3DObjectFormat(a)){b=b===a?b.clone():b;b.formatOf3DObjects=null;const {supportedFormats:e,
queryFormats:d}=c,g=r.getMimeTypeFormatId("model/gltf-binary",e)??r.getFilenameFormatId("glb",e),q=r.getMimeTypeFormatId("model/gltf+json",e)??r.getFilenameFormatId("gtlf",e);for(const p of d){if(p===g){b.formatOf3DObjects=p;break}p!==q||b.formatOf3DObjects||(b.formatOf3DObjects=p)}if(!b.formatOf3DObjects)throw new y("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==b.outFields||!b.outFields.includes("*")){b=
b===a?b.clone():b;null==b.outFields&&(b.outFields=[]);const {originX:p,originY:K,originZ:L,translationX:M,translationY:N,translationZ:O,scaleX:P,scaleY:Q,scaleZ:R,rotationX:S,rotationY:T,rotationZ:U,rotationDeg:V}=c.transformFieldRoles;b.outFields.push(p,K,L,M,N,O,P,Q,R,S,T,U,V)}}return b};f._normalizeFields=function(a){if(null!=this.fieldsIndex&&null!=a)for(const b of a)(a=this.fieldsIndex.get(b.name))&&Object.assign(b,a.toJSON())};f._queryIs3DObjectFormat=function(a){return null!=this.infoFor3D&&
!0===a.returnGeometry&&"xyFootprint"!==a.multipatchOption&&!a.outStatistics};v._createClass(u,[{key:"parsedUrl",get:function(){return A.urlToObject(this.url)}}]);return u}(h);l.__decorate([m.property({type:w.DataLayerSource})],h.prototype,"dynamicDataSource",void 0);l.__decorate([m.property()],h.prototype,"fieldsIndex",void 0);l.__decorate([m.property()],h.prototype,"gdbVersion",void 0);l.__decorate([m.property()],h.prototype,"infoFor3D",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,
"parsedUrl",null);l.__decorate([m.property()],h.prototype,"pbfSupported",void 0);l.__decorate([m.property()],h.prototype,"queryAttachmentsSupported",void 0);l.__decorate([m.property()],h.prototype,"sourceSpatialReference",void 0);l.__decorate([m.property({type:String})],h.prototype,"url",void 0);return h=l.__decorate([B.subclass("esri.tasks.QueryTask")],h)});
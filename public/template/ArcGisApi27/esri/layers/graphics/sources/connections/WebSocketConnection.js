// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/zscale ../../../support/StreamConnection".split(" "),function(m,q,t,k,h,w,z,x,D,
E,F,A,B,C){var n;(function(g){g[g.CONNECTING=0]="CONNECTING";g[g.OPEN=1]="OPEN";g[g.CLOSING=2]="CLOSING";g[g.CLOSED=3]="CLOSED"})(n||(n={}));m.WebSocketConnection=function(g){function p(a){var b=g.call(this)||this;b._outstandingMessages=[];b.errorString=null;const {geometryType:d,spatialReference:c,sourceSpatialReference:e}=a;b._config=a;b._featureZScaler=B.getGeometryZScaler(d,e,c);b._open();return b}q._inherits(p,g);var f=p.prototype;f._open=async function(){await this._tryCreateWebSocket();this.destroyed||
await this._handshake()};f.destroy=function(){q._get(q._getPrototypeOf(p.prototype),"destroy",this).call(this);null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};f.sendMessageToSocket=function(a){null==this._websocket?this._outstandingMessages.push(a):this._websocket.send(JSON.stringify(a))};f.sendMessageToClient=function(a){this._onMessage(a)};f.updateCustomParameters=
function(a){this._config.customParameters=a;null!=this._websocket&&this._websocket.close()};f._tryCreateWebSocket=async function(a=this._config.source.path,b=1E3,d=0){try{if(!this.destroyed){var c=z.addQueryParameters(a,this._config.customParameters??{});this._websocket=await this._createWebSocket(c);this.notifyChange("connectionStatus")}}catch(e){if(c=b/1E3,this._config.maxReconnectionAttempts&&d>=this._config.maxReconnectionAttempts)h.getLogger(this).error(new k("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),
this.destroy();else return h.getLogger(this).error(new k("websocket-connection",`Failed to connect. Attempting to reconnect in ${c}s`,e)),await w.after(b),this._tryCreateWebSocket(a,Math.min(1.5*b,1E3*this._config.maxReconnectionInterval),d+1)}};f._setWebSocketJSONParseHandler=function(a){a.onmessage=b=>{try{const d=JSON.parse(b.data);this._onMessage(d)}catch(d){h.getLogger(this).error(new k("websocket-connection","Failed to parse message, invalid JSON",{error:d}))}}};f._createWebSocket=function(a){return new Promise((b,
d)=>{const c=new WebSocket(a);c.onopen=()=>{c.onopen=null;this.destroyed?(c.onclose=null,c.close()):(c.onclose=e=>this._onClose(e),c.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(c),b(c))};c.onclose=e=>{c.onopen=c.onclose=null;d(e)}})};f._handshake=async function(a=1E4){const b=this._websocket;if(null!=b){var d=w.createResolver(),c=b.onmessage,{filter:e,outFields:u,spatialReference:v}=this._config;d.timeout(a);b.onmessage=r=>{let l=null;try{l=JSON.parse(r.data)}catch(y){}l&&"object"===
typeof l||(h.getLogger(this).error(new k("websocket-connection","Protocol violation. Handshake failed - malformed message",r.data)),d.reject(),this.destroy());l.spatialReference?.wkid!==v?.wkid&&(h.getLogger(this).error(new k("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${v.wkid}`,r.data)),d.reject(),this.destroy());"json"!==l.format&&(h.getLogger(this).error(new k("websocket-connection","Protocol violation. Handshake failed - format is not set",r.data)),d.reject(),
this.destroy());e&&l.filter!==e&&h.getLogger(this).error(new k("websocket-connection","Tried to set filter, but server doesn't support it"));u&&l.outFields!==u&&h.getLogger(this).error(new k("websocket-connection","Tried to set outFields, but server doesn't support it"));b.onmessage=c;for(const y of this._outstandingMessages)b.send(JSON.stringify(y));this._outstandingMessages=[];d.resolve()};b.send(JSON.stringify({filter:e,outFields:u,format:"json",spatialReference:{wkid:v.wkid}}));return d.promise}};
f._onMessage=function(a){this.onMessage(a);if("type"in a)switch(a.type){case "features":case "featureResult":for(const b of a.features)null!=this._featureZScaler&&this._featureZScaler(b.geometry),this.onFeature(b)}};f._onError=function(a){this._set("errorString","Encountered an error over WebSocket connection");h.getLogger(this).error("websocket-connection","Encountered an error over WebSocket connection")};f._onClose=function(a){this._websocket=null;this.notifyChange("connectionStatus");1E3!==a.code&&
h.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${a.code}`);this.destroyed||this._open()};q._createClass(p,[{key:"connectionStatus",get:function(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case n.CONNECTING:case n.OPEN:return"connected";case n.CLOSING:case n.CLOSED:return"disconnected"}}}]);return p}(C);t.__decorate([x.property()],m.WebSocketConnection.prototype,"connectionStatus",null);t.__decorate([x.property()],
m.WebSocketConnection.prototype,"errorString",void 0);m.WebSocketConnection=t.__decorate([A.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],m.WebSocketConnection);Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
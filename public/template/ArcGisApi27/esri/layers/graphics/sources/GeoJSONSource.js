// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/promiseUtils ../../../core/workers/workers ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ./support/clientSideDefaults ../../../rest/support/FeatureSet ../../../geometry/Extent ../../../geometry/Polygon ../../../geometry/support/typeUtils".split(" "),
function(g,t,h,J,u,x,y,z,A,B,l,K,L,C,D,E,F,G,H){const v=z.getLogger("esri.layers.graphics.sources.GeoJSONSource");g.GeoJSONSource=function(w){function q(){var a=w.apply(this,arguments)||this;a.type="geojson";a.refresh=A.debounce(async b=>{await a.load();const {extent:e,timeExtent:f}=await a._connection.invoke("refresh",b);a.sourceJSON.extent=e;f&&(a.sourceJSON.timeInfo.timeExtent=[f.start,f.end]);return{dataChanged:!0,updates:{extent:a.sourceJSON.extent,timeInfo:a.sourceJSON.timeInfo}}});return a}
t._inherits(q,w);var c=q.prototype;c.load=function(a){this.addResolvingPromise(this._startWorker(null!=a?a.signal:null));return Promise.resolve(this)};c.destroy=function(){this._connection?.close();this._connection=null};c.applyEdits=function(a){return this.load().then(()=>this._applyEdits(a))};c.openPorts=function(){return this.load().then(()=>this._connection.openPorts())};c.queryFeatures=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatures",a?a.toJSON():null,b)).then(e=>
E.fromJSON(e))};c.queryFeaturesJSON=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatures",a?a.toJSON():null,b))};c.queryFeatureCount=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatureCount",a?a.toJSON():null,b))};c.queryObjectIds=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryObjectIds",a?a.toJSON():null,b))};c.queryExtent=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryExtent",
a?a.toJSON():null,b)).then(e=>({count:e.count,extent:F.fromJSON(e.extent)}))};c.querySnapping=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("querySnapping",a,b))};c._applyEdits=function(a){if(!this._connection)throw new u("geojson-layer-source:edit-failure","Memory source not loaded");const b=this.layer.objectIdField,e=[],f=[],m=[];if(a.addFeatures)for(const d of a.addFeatures)e.push(this._serializeFeature(d));if(a.deleteFeatures)for(const d of a.deleteFeatures)"objectId"in
d&&null!=d.objectId?f.push(d.objectId):"attributes"in d&&null!=d.attributes[b]&&f.push(d.attributes[b]);if(a.updateFeatures)for(const d of a.updateFeatures)m.push(this._serializeFeature(d));return this._connection.invoke("applyEdits",{adds:e,updates:m,deletes:f}).then(({extent:d,timeExtent:k,featureEditResults:n})=>{this.sourceJSON.extent=d;k&&(this.sourceJSON.timeInfo.timeExtent=[k.start,k.end]);return this._createEditsResult(n)})};c._createEditsResult=function(a){return{addFeatureResults:a.addResults?
a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}};c._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new u("geojson-layer-source:edit-failure",
b.description,{code:b.code}):null}};c._serializeFeature=function(a){const {attributes:b}=a;return(a=this._geometryForSerialization(a))?{geometry:a.toJSON(),attributes:b}:{attributes:b}};c._geometryForSerialization=function(a){({geometry:a}=a);return null==a?null:"mesh"===a.type||"extent"===a.type?G.fromExtent(a.extent):a};c._startWorker=async function(a){this._connection=await B.open("GeoJSONSourceWorker",{strategy:x("feature-layers-workers")?"dedicated":"local",signal:a});const {fields:b,spatialReference:e,
hasZ:f,geometryType:m,objectIdField:d,url:k,timeInfo:n,customParameters:I}=this.layer;var r="defaults"===this.layer.originOf("spatialReference");r={url:k,customParameters:I,fields:b&&b.map(p=>p.toJSON()),geometryType:H.featureGeometryTypeKebabDictionary.toJSON(m),hasZ:f,objectIdField:d,timeInfo:n?n.toJSON():null,spatialReference:r?null:e&&e.toJSON()};a=await this._connection.invoke("load",r,{signal:a});for(const p of a.warnings)v.warn(p.message,{layer:this.layer,warning:p});a.featureErrors.length&&
v.warn(`Encountered ${a.featureErrors.length} validation errors while loading features`,a.featureErrors);this.sourceJSON=a.layerDefinition;this.capabilities=D.createCapabilities(this.sourceJSON.hasZ,!0)};return t._createClass(q)}(y);h.__decorate([l.property()],g.GeoJSONSource.prototype,"capabilities",void 0);h.__decorate([l.property()],g.GeoJSONSource.prototype,"type",void 0);h.__decorate([l.property({constructOnly:!0})],g.GeoJSONSource.prototype,"layer",void 0);h.__decorate([l.property()],g.GeoJSONSource.prototype,
"sourceJSON",void 0);g.GeoJSONSource=h.__decorate([C.subclass("esri.layers.graphics.sources.GeoJSONSource")],g.GeoJSONSource);Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
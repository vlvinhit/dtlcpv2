// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../kernel ../../../request ../../../TimeExtent ../../../core/arrayUtils ../../../core/Error ../../../core/has ../../../core/jsonMap ../../../core/Loadable ../../../core/Logger ../../../core/object ../../../core/promiseUtils ../../../core/unitUtils ../../../core/urlUtils ../../../core/uuid ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/projection ../../../geometry/support/jsonUtils ../../../geometry/support/meshVertexSpaceUtils ../../../geometry/support/meshUtils/External ../editingSupport ./support/clientSideDefaults ./support/QueryTask ../../support/arcgisLayerUrl ../../support/infoFor3D ../../../rest/query/executeQueryJSON ../../../rest/query/operations/editsZScale ../../../rest/support/Query ../../../geometry/SpatialReference".split(" "),
function(N,E,w,t,O,P,n,Q,z,v,F,G,R,x,S,A,H,B,T,C,na,U,V,I,W,X,Y,J,Z,aa,ba,ca,da,ea,fa,ha){const ia=new G.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),ja=new Set(["Feature Layer","Oriented Imagery Layer","Table"]),ka=new G.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});t=function(K){function y(){var a=K.apply(this,arguments)||this;a.type="feature-layer";a.refresh=A.debounce(async()=>{await a.load();var b=a.sourceJSON.editingInfo?.lastEditDate;
if(null==b)return{dataChanged:!0,updates:{}};try{await a._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}b=b!==a.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:b,updates:b?{editingInfo:a.sourceJSON.editingInfo,extent:a.sourceJSON.extent}:null}});a._ongoingAssetUploads=new Map;return a}E._inherits(y,K);var g=y.prototype;g.load=function(a){this.addResolvingPromise(this._fetchService(this.layer.sourceJSON,null!=a?a.signal:null));return Promise.resolve(this)};g.addAttachment=async function(a,
b){await this.load();a=a.attributes[this.layer.objectIdField];const c=this.layer.parsedUrl.path+"/"+a+"/addAttachment",e=this._getLayerRequestOptions();b=this._getFormDataForAttachment(b,e.query);try{const d=await n(c,{body:b});return this._createFeatureEditResult(d.data.addAttachmentResult)}catch(d){throw this._createAttachmentErrorResult(a,d);}};g.updateAttachment=async function(a,b,c){await this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/updateAttachment";
b=this._getLayerRequestOptions({query:{attachmentId:b}});c=this._getFormDataForAttachment(c,b.query);try{const d=await n(e,{body:c});return this._createFeatureEditResult(d.data.updateAttachmentResult)}catch(d){throw this._createAttachmentErrorResult(a,d);}};g.applyEdits=async function(a,b){await this.load();const {layer:c}=this,e=c.infoFor3D;var d=null!=e,f=d||(b?.globalIdUsed??!1);const k=d?await this._uploadMeshesAndGetAssetMapEditsJSON(a):null;var h=a.addFeatures?.map(u=>this._getFeatureJSON(u,
e))??[];h=(await Promise.all(h)).filter(z.isSome);var l=a.updateFeatures?.map(u=>this._getFeatureJSON(u,e))??[];l=(await Promise.all(l)).filter(z.isSome);const p=this._getFeatureIds(a.deleteFeatures,f);ea.unapplyEditsZUnitScaling(h,l,c.spatialReference);a=await this._getAttachmentEditsJSON(a);d=c.capabilities.editing.supportsAsyncApplyEdits&&d;const m={gdbVersion:b?.gdbVersion||c.gdbVersion,rollbackOnFailure:b?.rollbackOnFailureEnabled,useGlobalIds:f,returnEditMoment:b?.returnEditMoment,usePreviousEditMoment:b?.usePreviousEditMoment,
sessionId:b?.sessionId,async:d};b?.returnServiceEditsOption?(m.edits=JSON.stringify([{id:c.layerId,adds:h,updates:l,deletes:p,attachments:a,assetMaps:k}]),m.returnServiceEditsOption=ia.toJSON(b?.returnServiceEditsOption),m.returnServiceEditsInSourceSR=b?.returnServiceEditsInSourceSR):(m.adds=h.length?JSON.stringify(h):null,m.updates=l.length?JSON.stringify(l):null,m.deletes=p.length?f?JSON.stringify(p):p.join(","):null,m.attachments=a&&JSON.stringify(a),m.assetMaps=null!=k?JSON.stringify(k):void 0);
f=this._getLayerRequestOptions({method:"post",query:m});b=b?.returnServiceEditsOption?c.url:c.parsedUrl.path;b=d?await this._asyncApplyEdits(b+"/applyEdits",f):await n(b+"/applyEdits",f);!c.capabilities.operations?.supportsEditing&&c.effectiveCapabilities?.operations?.supportsEditing&&await P.id?.findCredential(c.url)?.refreshToken();return this._createEditsResult(b)};g.deleteAttachments=async function(a,b){await this.load();a=a.attributes[this.layer.objectIdField];const c=this.layer.parsedUrl.path+
"/"+a+"/deleteAttachments";try{return(await n(c,this._getLayerRequestOptions({query:{attachmentIds:b.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(e){throw this._createAttachmentErrorResult(a,e);}};g.fetchRecomputedExtents=function(a={}){return this.load({signal:a.signal}).then(async()=>{var b=this._getLayerRequestOptions({...a,query:{returnUpdates:!0}});const {layerId:c,url:e}=this.layer;({data:b}=await n(`${e}/${c}`,b));const {id:d,extent:f,fullExtent:k,
timeExtent:h}=b;b=f||k;return{id:d,fullExtent:b&&V.fromJSON(b),timeExtent:h&&Q.fromJSON({start:h[0],end:h[1]})}})};g.queryAttachments=async function(a,b={}){await this.load();b=this._getLayerRequestOptions(b);return this.queryTask.executeAttachmentQuery(a,b)};g.queryFeatures=async function(a,b){await this.load();return this.queryTask.execute(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryFeaturesJSON=async function(a,b){await this.load();return this.queryTask.executeJSON(a,{...b,query:this._createRequestQueryOptions(b)})};
g.queryObjectIds=async function(a,b){await this.load();return this.queryTask.executeForIds(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryFeatureCount=async function(a,b){await this.load();return this.queryTask.executeForCount(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryExtent=async function(a,b){await this.load();return this.queryTask.executeForExtent(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryRelatedFeatures=async function(a,b){await this.load();return this.queryTask.executeRelationshipQuery(a,
{...b,query:this._createRequestQueryOptions(b)})};g.queryRelatedFeaturesCount=async function(a,b){await this.load();return this.queryTask.executeRelationshipQueryForCount(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryTopFeatures=async function(a,b){await this.load();return this.queryTask.executeTopFeaturesQuery(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryTopObjectIds=async function(a,b){await this.load();return this.queryTask.executeForTopIds(a,{...b,query:this._createRequestQueryOptions(b)})};
g.queryTopExtents=async function(a,b){await this.load();return this.queryTask.executeForTopExtents(a,{...b,query:this._createRequestQueryOptions(b)})};g.queryTopCount=async function(a,b){await this.load();return this.queryTask.executeForTopCount(a,{...b,query:this._createRequestQueryOptions(b)})};g.fetchPublishingStatus=async function(){if(!ba.isHostedAgolService(this.layer.url))return"unavailable";var a=B.join(this.layer.url,"status");a=await n(a,{query:{f:"json"}});return ka.fromJSON(a.data.status)};
g.uploadAssets=async function(a,b){const {uploadAssets:c}=await new Promise((e,d)=>N(["./support/uploadAssets"],e,d));return c(a,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},b)};g._asyncApplyEdits=async function(a,b){for(a=(await n(a,b)).data.statusUrl;;){b=(await n(a,{query:{f:"json"},responseType:"json"})).data;switch(b.status){case "Completed":return n(b.resultUrl,{query:{f:"json"},responseType:"json"});case "CompletedWithErrors":throw new v("async-applyEdits-failed","asynchronous applyEdits call failed.");
case "Failed ImportChanges":case "InProgress":case "Pending":case "ExportAttachments":case "ExportChanges":case "ExportingData":case "ExportingSnapshot":case "ImportAttachments":case "ProvisioningReplica":case "UnRegisteringReplica":break;default:throw new v("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)");}await A.after(1E3)}};g._createRequestQueryOptions=function(a){a={...this.layer.customParameters,token:this.layer.apiKey,...a?.query};this.layer.datesInUnknownTimezone&&
(a.timeReferenceUnknownClient=!0);return a};g._fetchService=async function(a,b){a||({data:a}=await n(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:F("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:b})));this.sourceJSON=await this._patchServiceJSON(a,b);b=a.type;if(!ja.has(b))throw new v("feature-layer-source:unsupported-type",`Source type "${b}" is not supported`);};g._patchServiceJSON=async function(a,b){if("Table"!==a.type&&a.geometryType&&!a?.drawingInfo?.renderer&&
!a.defaultSymbol){const c=Z.createDrawingInfo(a.geometryType).renderer;S.setDeepValue("drawingInfo.renderer",c,a)}"esriGeometryMultiPatch"===a.geometryType&&a.infoFor3D&&(a.geometryType="mesh");if(null==a.extent)try{const {data:c}=await n(this.layer.url,this._getLayerRequestOptions({signal:b}));c.spatialReference&&(a.extent={xmin:0,ymin:0,xmax:0,ymax:0,spatialReference:c.spatialReference})}catch(c){A.throwIfAbortError(c)}return a};g._getFeatureJSON=async function(a,b){var {geometry:c}=a;a={...a.attributes};
if(null!=b&&"mesh"===c?.type){({transformFieldRoles:b}=b);const {origin:e,spatialReference:d,transform:f}=c,k=this.layer.spatialReference;await I.initializeProjection(d,k);const h=I.project(e,k);a[b.originX]=h.x;a[b.originY]=h.y;a[b.originZ]=h.z??0;if(null!=f){const {translation:l,scale:p,rotation:m}=f;({vertexSpace:c}=c);c=c.isGeoreferenced?1:H.getMetersPerCartesianUnitForSR(d)/H.getMetersPerCartesianUnitForSR(k);a[b.translationX]=l[0]*c;a[b.translationY]=-l[2]*c;a[b.translationZ]=l[1]*c;a[b.scaleX]=
p[0];a[b.scaleY]=p[2];a[b.scaleZ]=p[1];a[b.rotationX]=m[0];a[b.rotationY]=m[2];a[b.rotationZ]=m[1];a[b.rotationDeg]=m[3]}return{geometry:null,attributes:a}}return null==c?{attributes:a}:"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:a}};g._getAttachmentEditsJSON=async function(a){const b=await Promise.all((a.addAttachments??[]).map(e=>this._getAttachmentEditJSON(e))),c=await Promise.all((a.updateAttachments??[]).map(e=>this._getAttachmentEditJSON(e)));a=a.deleteAttachments??
[];return b.length||c.length||a.length?{adds:b,updates:c,deletes:[...a]}:null};g._getAttachmentEditJSON=async function(a){const {feature:b,attachment:c}=a,{globalId:e,name:d,contentType:f,data:k,uploadId:h}=c;a={globalId:e,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};b&&(a.parentGlobalId="attributes"in b?b.attributes&&b.attributes[this.layer.globalIdField]:b.globalId);if(h)a.uploadId=h;else if(k){const l=await B.parseData(k);l&&(a.contentType=l.mediaType,a.data=l.data);
k instanceof File&&(a.name=k.name)}d&&(a.name=d);f&&(a.contentType=f);return a};g._uploadMeshesAndGetAssetMapEditsJSON=async function(a){var {addAssetFeatures:b}=a;if(!b?.length)return null;a=await this._filterRedundantAssetMaps(b);if(!b?.length)return null;b=[];const c=new Map;for(const d of a){const {geometry:f}=d;var {vertexSpace:e}=f;e.isRelative?b.push(f):(e=X.toRelativeVertexSpace(f),c.set(e,f),d.geometry=e,b.push(e))}await this.uploadAssets(b);for(const [d,f]of c)f.addExternalSources(d.metadata.externalSources.items);
return{adds:this._getAssetMapEditsJSON(a),updates:[],deletes:[]}};g._getAssetMapEditsJSON=function(a){const b=[],c=this.layer.globalIdField,e=this.layer.parsedUrl;for(const k of a){var d=k.geometry;({metadata:a}=d);var f=a.getExternalSourcesOnService(e);a=k.getAttribute(c);if(0===f.length)x.getLogger(this).error(`Skipping feature ${a}. The mesh it is associated with has not been uploaded to the service and cannot be mapped to it.`);else{({source:f}=f.find(Y.isOriginalExternal)??f[0]);({vertexSpace:d}=
d);d=d.isGeoreferenced?["PROJECT_VERTICES"]:[];for(const h of f)1!==h.parts.length?x.getLogger(this).error(`Skipping asset ${h.assetName}. It does not have exactly one part, so we cannot map it to a feature.`):b.push({globalId:T.generateBracedUUID(),parentGlobalId:a,assetName:h.assetName,assetHash:h.parts[0].partHash,flags:d})}}return b};g._getFeatureIds=function(a,b){if(!a||0===a.length)return[];if(b&&J.isFeatureIdentifierArrayWithGlobalId(a))return a.map(d=>d.globalId);if(J.isFeatureIdentifierArrayWithObjectId(a))return a.map(d=>
d.objectId);const {layer:c}=this,e=b?c.globalIdField:c.objectIdField;return e?a.map(d=>d.getAttribute(e)):[]};g._createEditsResult=function(a){const b=a.data,{layerId:c}=this.layer;a=[];let e=null;if(Array.isArray(b))for(var d of b)a.push({id:d.id,editedFeatures:d.editedFeatures}),d.id===c&&(e={addResults:d.addResults??[],updateResults:d.updateResults??[],deleteResults:d.deleteResults??[],attachments:d.attachments,editMoment:d.editMoment});else e=b;if(d=e?.assetMaps){for(var f of d.addResults)f.success||
x.getLogger(this).error(`Failed to map asset to feature with globalId ${f.globalId}.`);for(const k of d.updateResults)k.success||x.getLogger(this).error(`Failed to map asset to feature with globalId ${k.globalId}.`)}f=e?.attachments;f={addFeatureResults:e?.addResults?.map(this._createFeatureEditResult,this)??[],updateFeatureResults:e?.updateResults?.map(this._createFeatureEditResult,this)??[],deleteFeatureResults:e?.deleteResults?.map(this._createFeatureEditResult,this)??[],addAttachmentResults:f&&
f.addResults?f.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:f&&f.updateResults?f.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:f&&f.deleteResults?f.deleteResults.map(this._createFeatureEditResult,this):[]};e?.editMoment&&(f.editMoment=e.editMoment);if(0<a.length){f.editedFeatureResults=[];for(const k of a){({editedFeatures:a}=k);const h=a?.spatialReference?new ha(a.spatialReference):null;f.editedFeatureResults.push({layerId:k.id,
editedFeatures:{adds:a?.adds?.map(l=>this._createEditedFeature(l,h))||[],updates:a?.updates?.map(l=>({original:this._createEditedFeature(l[0],h),current:this._createEditedFeature(l[1],h)}))||[],deletes:a?.deletes?.map(l=>this._createEditedFeature(l,h))||[],spatialReference:h}})}}return f};g._createEditedFeature=function(a,b){return new O({attributes:a.attributes,geometry:W.fromJSON({...a.geometry,spatialReference:b})})};g._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,
description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new v("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};g._createAttachmentErrorResult=function(a,b){return{objectId:a,globalId:null,error:new v("feature-layer-source:attachment-failure",b.details.messages&&b.details.messages[0]||b.message,{code:b.details.httpStatus||b.details.messageCode})}};g._getFormDataForAttachment=function(a,b){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(const c in b){const e=
b[c];null!=e&&(a.set?a.set(c,e):a.append(c,e))}return a};g._getLayerRequestOptions=function(a={}){const {parsedUrl:b,gdbVersion:c,dynamicDataSource:e}=this.layer;return{...a,query:{gdbVersion:c,layer:e?JSON.stringify({source:e}):void 0,...b.query,f:"json",...this._createRequestQueryOptions(a)},responseType:"json"}};g._filterRedundantAssetMaps=async function(a){var {layer:b}=this;const {globalIdField:c,infoFor3D:e,parsedUrl:d}=b;if(null==e||null==c)return a;b=ca.getAssetMapTable(e);if(null==b)return a;
var f=B.join(d.path,`../${b.id}`);b=[];const k=[];for(var h of a)0<h.geometry.metadata.getExternalSourcesOnService(d).length?k.push(h):b.push(h);h=k.map(q=>q.getAttribute(c)).filter(z.isSome);if(0===h.length)return a;const {assetMapFieldRoles:{parentGlobalId:l,assetHash:p}}=e,m=new fa;m.where=`${l} IN (${h.map(q=>`'${q}'`)})`;m.outFields=[p,l];m.returnGeometry=!1;f=await da.executeQueryJSON(f,m);const {features:u}=f;return 0===u.length?a:[...b,...k.filter(q=>{const L=q.getAttribute(c);if(!L)return!0;
({metadata:q}=q.geometry);const M=u.filter(r=>r.getAttribute(l)===L);if(0===M.length)return!0;const la=M.map(r=>r.getAttribute(p));return q.getExternalSourcesOnService(d).flatMap(({source:r})=>r.flatMap(D=>D.parts.map(ma=>ma.partHash))).some(r=>la.every(D=>r!==D))})]};E._createClass(y,[{key:"queryTask",get:function(){const {capabilities:a,parsedUrl:b,dynamicDataSource:c,infoFor3D:e,gdbVersion:d,spatialReference:f,fieldsIndex:k}=this.layer,h=F("featurelayer-pbf")&&a?.query.supportsFormatPBF&&null==
e;return new aa({url:b.path,pbfSupported:h,fieldsIndex:k,infoFor3D:e,dynamicDataSource:c,gdbVersion:d,sourceSpatialReference:f,queryAttachmentsSupported:a?.operations?.supportsQueryAttachments??!1})}}]);return y}(R);w.__decorate([C.property()],t.prototype,"type",void 0);w.__decorate([C.property({constructOnly:!0})],t.prototype,"layer",void 0);w.__decorate([C.property({readOnly:!0})],t.prototype,"queryTask",null);return t=w.__decorate([U.subclass("esri.layers.graphics.sources.FeatureLayerSource")],
t)});
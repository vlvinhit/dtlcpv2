// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/Logger ../../../core/PooledArray ../../../core/Promise ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../dehydratedFeatures ../../support/PromiseQueue ../../../views/ViewingMode ../../../views/3d/layers/i3s/I3SClientNodeLoader ../../../views/3d/layers/i3s/I3SFrameTask ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNode ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SStreamDataController ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SViewportQueries ../../../views/3d/layers/support/I3SLayerView ../../../views/3d/support/extentUtils ../../../views/3d/support/index ../../../views/support/layerViewUtils ../../../views/support/Scheduler".split(" "),
function(K,k,h,O,P,Q,x,R,y,m,l,fa,ha,S,L,B,T,U,V,W,X,Y,Z,u,aa,M,C,ba,ca,da,D,E,ea){function F(n,p){return null!=n&&n.length===p.length&&n.every(d=>0<=G(p,d.name))}function G(n,p){p=p.toLowerCase();for(let d=0;d<n.length;d++)if(n[d].name.toLowerCase()===p)return d;return-1}const v=Q.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");h=function(n){function p(a){a=n.call(this,a)||this;a.screenSizeFactor=0;a.featureTarget=5E4;a.fixedFeatureTarget=!1;a.updating=!0;a.updatingProgress=1;
a.leavesReached=!1;a.scaleVisibilityEnabled=!0;a.worker=null;a._featureLOD=1;a._stableFeatureLOD=!1;a._isIdle=!1;a._cameraDirty=!0;a._invisibleDirty=!1;a._idleStateCallbacks=null;a._newLoadingNodes=new x({deallocator:null});a._loadedNodeScales=new Map;a._modificationsNodeFilteringArray=new x;a._downloadingCount=0;a._loadingNodes=new Map;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._requiredAttributes=[];a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableIDBCache=!1;a._disableMemCache=
!1;a._restartNodeLoading=!1;a._fields=null;a._attributeStorageInfo=null;a._handles=new O;a._idleQueue=new U.PromiseQueue;a._elevationUpdateNodes=new x({deallocator:null});a._errorCount=0;return a}K._inherits(p,n);var d=p.prototype;d.initialize=function(){const {layerView:a,layer:b}=this;this._disableMemCache=!a.loadCachedGPUData||!a.addCachedGPUData;this._lodHandling=new Z(a);this._defaultGeometrySchema=b.store.defaultGeometrySchema;this.disableIDBCache=P("disable-feature:idb-cache");"fields"in b&&
(this._fields=b.fields,this._attributeStorageInfo=b.attributeStorageInfo);this.addResolvingPromise(Promise.all([b.indexInfo,b.when(),a.when()]).then(([c])=>{if(!this.destroyed&&a&&!a.destroyed&&c){var {view:e,clientGeometry:g}=a,{resourceController:q}=e;this._setClippingArea(e.clippingArea);this.addHandles([m.watch(()=>e?.pointsOfInterest?.focus?.renderLocation,f=>this._pointOfInterestChanged(f),m.initial),m.watch(()=>q.memoryController.memoryFactor,()=>this._setCameraDirty(),m.sync),m.watch(()=>
a.contentVisible,f=>{const r=f?()=>this._updateIdleState(!0):()=>this._updateViewData(),z=f?()=>this._updateIdleState(!1):()=>{};f&&null!=this._index&&this._index.invalidateAllElevationRanges();this._idleStateCallbacks?(f||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=r,this._idleStateCallbacks.idleEnd=z):this._idleStateCallbacks=q.scheduler.registerIdleStateCallbacks(r,z)},m.initial),X.addCallback(a.view.resourceController.scheduler,this),m.watch(()=>a.uncompressedTextureDownsamplingEnabled,
()=>this.restartNodeLoading()),m.watch(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty();this._stableFeatureLOD=!1}),m.watch(()=>e.state?.contentCamera,()=>this._setCameraDirty()),m.watch(()=>b.elevationInfo,f=>this._elevationInfoChanged(f)),m.watch(()=>b.effectiveScaleRange,()=>this._scaleBoundsChanged()),m.watch(()=>a.lodFactor,()=>this._setCameraDirty()),m.watch(()=>a.availableFields,()=>this._requiredFieldsChange()),m.watch(()=>a.holeFilling,f=>null!=this._index&&(this._index.holeFilling=
f))]);this._updateScaleHandles();this._viewportQueries=new ba(this.crsIndex,e.renderCoordsHelper,e.state.contentCamera,!e.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?e.basemapTerrain:e.elevationProvider,V.viewingModeFromString(e.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:.5>this._lod});this._clientNodeLoader=new W.I3SClientNodeLoader(this.layer.uid,this.crsIndex,
e.renderCoordsHelper.spatialReference,e.state.viewingMode,e.resourceController.memoryController,this.worker);this._index=new Y.I3SIndex(b,c,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,v,a.holeFilling,f=>a.isNodeLoaded(f),f=>a.isNodeReloading(f),f=>this._shouldLoadNode(f),f=>this._enableFromGPUCache(f,u.NodeState.Leaf),f=>this._needsUpdate(f),()=>!this.indexStreamController.busy,f=>a.computeVisibilityObb?a.computeVisibilityObb(f):null,a?.computeNodeFiltering?f=>a.computeNodeFiltering(f):
void 0);this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D);this._index.imModificationsChanged(!!a.hasModifications);this._index.layerFilterChanged(!!a.hasGeometryFilter);if(null!=g){for(const f of g)this._addMesh(f.mesh,f.oid);this.addHandles(g.on("change",f=>{for(const r of f.removed)this._removeMesh(r.oid);for(const r of f.added)this._addMesh(r.mesh,r.oid)}))}this._startNodeLoading()}}));this._tmpPoint=T.makeDehydratedPoint(0,0,0,this.crsIndex)};d.updateNodeModificationStatus=
function(a){const b=this._index,c=this.layerView;null!=b&&c?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),a.forAll(e=>{e=b.getNode(e);null!=e&&this._modificationsNodeFilteringArray.push(e)}),c.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)};d.destroy=function(){this.cancelNodeLoading();this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null);this._handles.destroy();this._nodeLoader=
null;t.prune();null!=H&&(H.hide(),H=null)};d._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const a=this._attributeStorageInfo,b=this._fields,c=this.layer.objectIdField;return this.layerView.availableFields.map(e=>{const g=G(a,e);e=G(b,e);return 0<=g&&0<=e?{index:g,name:b[e].name,field:b[e],attributeStorageInfo:a[g]}:null}).filter(e=>null!=e&&e.name!==c)};d._requiredFieldsChange=function(){const a=this._getRequiredAttributes();
F(this._requiredAttributes,a)||(this._requiredAttributes=a,this._requiredAttributesDirty=!1,this.restartNodeLoading())};d.requestUpdate=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};d._setClippingArea=function(a){const b=B.create();da.toBoundingRect(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null};d._pointOfInterestChanged=function(a){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(a),null!=this._index&&(this._index.progressiveLoadPenalty=
N.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))};d.updateClippingArea=function(a){this._setClippingArea(a);null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache());this._setCameraDirty()};d._setCameraDirty=function(){this._cameraDirty=!0;this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};d._addMesh=function(a,b){null!=this._index&&(a=this._clientNodeLoader.createMeshNodeInfo(a,
b),b=this._index.addClientNodeToIndex(a.id,a.mbs),this._clientNodeLoader.addMeshNode(b,a),this._evaluateUpdating(),this.notifyChange("rootNodeVisible"))};d._removeMesh=function(a){a=this._clientNodeLoader.getMeshNodeIndex(a);if(null!=a)if(null!=this._index)this._index.removeClientNodeFromIndex(a,(b,c)=>{this.layerView.removeNode(c);this._loadedNodeScales.delete(c);this._clientNodeLoader.removeNode(b);this.layerView.deleteCachedNodeData&&null!=b&&this.layerView.deleteCachedNodeData(b);this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(c))},
(b,c,e)=>{this._clientNodeLoader.updateNodeIndex(b,c,e);this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(c,e)}),this.notifyChange("rootNodeVisible");else throw Error("delayed removal of client side i3s node geometry not supported yet.");};d.updateElevationChanged=function(a,b){const c=this._index;if(null==c||null==c.rootNode||null==b)return null;this.crsIndex.equals(b)||(L.projectBoundingRect(a,b,A,this.crsIndex),a=A);const e=this._elevationUpdateNodes;e.clear();C.findIntersectingNodes(a,
c.rootNode,c,g=>e.push(g.index));e.length&&(e.forAll(g=>c.updateElevationChanged(g)),this._setCameraDirty());return e};d.removeAllGeometryObbs=function(){null!=this._index&&this._index.removeAllGeometryObbs()};d.getRenderMbs=function(a){return null!=this._viewportQueries?this._viewportQueries.getRenderMbs(a):null};d._elevationInfoChanged=function(a){null!=this._index&&(this._index.updateElevationInfo(a,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())};d._updateScaleHandles=function(){this._handles.remove("scale-bounds");
this._areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",a=>this._scaleUpdateHandler(a)),"scale-bounds")};d._scaleBoundsChanged=function(){this._areScaleBoundsActive||this._loadedNodeScales.clear();this._updateScaleHandles();this._setCameraDirty()};d._scaleUpdateHandler=function(a){this._updateScaleInBoundingRect(a.extent,a.spatialReference);this._setCameraDirty()};d._updateScaleInBoundingRect=function(a,b){const c=this._index;null!=c&&null!=c.rootNode&&L.projectBoundingRect(a,
b,A,this.crsIndex)&&this._loadedNodeScales.forEach((e,g)=>{e=c.getNode(g);null!=e&&B.intersectsSphere(A,e.mbs)&&this._loadedNodeScales.set(g,this._computeScale(e))})};d.restartNodeLoading=function(){this._restartNodeLoading=!0;this.cancelNodeLoading();this._evaluateUpdating()};d.schedule=function(a,b){return this._idleQueue.push(a,b)};d.reschedule=function(a,b){return this._idleQueue.unshift(a,b)};d._loadNodeData=async function(a,b){return(0>a.index?this._clientNodeLoader:this._nodeLoader).loadNodeData(a,
b)};d._loadAttributes=async function(a,b,c){return(0>a.index?this._clientNodeLoader:this._nodeLoader).loadAttributes(a,b,c)};d.runTask=function(a,b){if(!this.layerView.contentVisible)return this._updateViewData(),this._evaluateUpdating(),-Infinity;if(!this.layerView.visible||null==this._index)return-Infinity;this._processWithErrorLogging(a,b);return this._index.maxPriority};d._processWithErrorLogging=function(a,b){try{this._process(a,b)}catch(c){50>this._errorCount?v.error("Error during processing: "+
c):50===this._errorCount&&v.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};d._process=function(a,b){this._restartNodeLoading&&this._startNodeLoading();null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(a)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(a.enabled=!1),a.run(()=>this._processIndex(a)),this._updateFeatureLOD(),a.run(()=>this._processCache(a)),this._isIntegratedMesh&&
(a.enabled=!0),a.run(()=>this._processNodes(a,b)),this._idleQueue.runTask(a),a.run(()=>this._prefetchIndex()),b.numIndexLoading+=this._index.indexLoading,b.numNodesLoading+=this._downloadingCount,a.run(()=>this._lodHandling.lodGlobalHandling(a)),this._evaluateUpdating())};d._processIndex=function(a){if(null==this._index)return!1;this._index.dirty&&(this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),a,b=>this.updateNodeModificationStatus(b)),this._disableMemCache||
(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length)),a=this._index.featureEstimate.leavesReached,this._index.isLoading||a===this._get("leavesReached")||this._set("leavesReached",a));return this._index.load()};d._prefetchIndex=function(){return null==this._index||0<this._loadingNodes.size||0<this._index.updates.add.length?!1:this._index.prefetch()};d._updateFeatureLOD=
function(){if(this.useMaximumNumberOfFeatures&&null!=this._index&&null!=this._viewportQueries){var a=!this._index.isLoading,b=this.featureTarget*this._baseLOD,c=this._index.featureEstimate;c.estimate=c.estimate||b/2;if(500<this._index.indexMissing){if(1E-4>=this._featureLOD)return;this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(a&&c.estimate<b){if(c.leavesReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;this._featureLOD*=Math.min(10,Math.max(b/c.estimate,1.001));a=this._lod;b=
this._index.checkFeatureTarget(b,a);b!==a&&(this._featureLOD=b/this._baseLOD,this._stableFeatureLOD=!0)}else if(c.estimate>1.2*b||a&&c.estimate>b){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(c.estimate/b-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,Math.max(1E-4,this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this._lod);this._index.requestUpdate()}};d._processCache=function(a){const b=this._index;if(null==b)return!1;for(;0<this._newLoadingNodes.length&&
!a.done;){var c=this._newLoadingNodes.pop();for(c=b.getParent(c);null!=c&&!this.layerView.isNodeLoaded(c.index)&&this._isNodeInScaleBounds(c);c=b.getParent(c.index))if(this._enableFromGPUCache(c,u.NodeState.Hole)){a.madeProgress();break}}return a.hasProgressed};d._processNodes=function(a,b){if(null==this._index)return!1;let c=(this._isIdle?100:2)-this._loadingNodes.size;const e=this._index.updates;e.cancel.forEach(this._cancelNode,this);for(e.cancel=[];0<e.remove.length&&!a.done;)this.layerView.removeNode(e.remove.pop()),
a.madeProgress();for(;0<e.update.length&&!a.done;){var g=this._index.getNode(e.update.pop());null!=g&&(this._updateLoadedNode(g),a.madeProgress())}for(;0<e.add.length&&!a.done&&0<c;){--c;g=this._index.getNode(e.add.back());if(null==g||g.cacheState!==u.CacheState.Cached&&!this._hasNodeLoadToken(b))break;e.add.pop();this._loadNode(g);a.madeProgress()}return a.hasProgressed};d._cancelAllNodes=function(){this._loadingNodes.forEach(a=>a.abort());this._loadingNodes.clear();this._updatingNodes.forEach(a=>
a.abort());this._updatingNodes.clear()};d._cancelNode=function(a){const b=this._loadingNodes.get(a);b&&(b.abort(),this._loadingNodes.delete(a))};d._hasNodeLoadToken=function(a){return!this._isIdle&&2<=a.numNodesLoading+this._loadingNodes.size?!1:this._downloadingCount<D.maxDownloadSlots&&!this.dataStreamController.busy};d._evaluateUpdating=function(){let a=!1;var b=0;this.layerView&&(this.layerView.contentVisible?(b=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:
0)+2*this._loadingNodes.size,a=!!(0<b||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===b&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(b,this._progressMaxNumNodes),b=1-b/this._progressMaxNumNodes):b=(a=this._cameraDirty)?0:1,this.updating=a,this.updatingProgress=b)};d._updateViewData=function(){if(this._cameraDirty&&
null!=this._index&&null!=this._viewportQueries){var a=this.layerView.view,{contentCamera:b,fixedContentCamera:c}=a.state;this.screenSizeFactor=1/(b.perScreenPixelRatio/2);this._viewportQueries.updateCamera(b,!c||this.isGraphics3D);this._viewportQueries.setPointOfInterest(a.pointsOfInterest.focus.renderLocation);this._viewportQueries.updateScreenSpaceErrorBias(this._lod);this._index.invalidateVisibilityCache();this._index.progressiveLoadPenalty=N.distancePenalty*this._viewportQueries.distCameraToPOI();
this._index.requestUpdate();this._stableFeatureLOD=!1;this._invisibleDirty=!0;this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};d._getProgressiveLoadFactor=function(){return 1>this.layerView.view.resourceController.memoryController.memoryFactor?1:this.layerView.progressiveLoadFactor};d.isGeometryVisible=function(a){return null!=this._index&&this._index.isGeometryVisible(a.index)};d.updateVisibility=function(a){null!=this._index&&this._index.invalidateNodeVisibilityCache(a)};d.invalidateGeometryVisibility=
function(a){null!=this._index&&this._index.invalidateGeometryVisibility(a)};d.invalidateVisibilityObbs=function(){null!=this._index&&this._index.invalidateVisibilityObbs()};d.modificationsChanged=function(){null!=this._index&&this._index.imModificationsChanged(!!this.layerView.hasModifications);this._invisibleDirty=!0};d._shouldLoadNode=function(a){return this._lodHandling.shouldLoadNode(a)&&!this._shouldDropNode(a)&&null!=this._index&&this._index.isGeometryVisible(a.index)?this._isNodeInScaleBounds(a):
!1};d._shouldDropNode=function(a){if(null==this._viewportQueries)return!1;const b=this._lodDropFactor;return 1<=b||!this._lodHandling.hasNoVisibleChildren(a)?!1:Math.abs(this._viewportQueries.calcCameraDistanceToCenter(a))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*b};d._startNodeLoading=function(){this._restartNodeLoading=!1;const a=this._index;this._updatesDisabled||null==a||null==this._viewportQueries||(this._updateViewData(),this._requiredAttributesDirty&&
(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1),this._nodeLoader=new aa(this.layer,this.dataStreamController,v,this._defaultGeometrySchema,this._requiredAttributes,{textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures}),a.requestUpdate(),this._lodHandling.startNodeLoading(b=>
this._isNodeInScaleBounds(b),(b,c)=>this._removeNodes(b,c,w.fadeout),a,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating())};d.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index};d.cancelNodeLoading=function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())};d._removeInvisibleNodes=function(a){const b=this._index;
if(null==b||null==this._viewportQueries)return!1;t.clear();this.layerView.getLoadedNodeIndices(t);const c=0===this._viewportQueries.maxDistance,e=c?()=>!1:g=>this._shouldDropNode(g);t.filterInPlace(g=>{const q=b.getNode(g);return null==q||!b.isGeometryVisible(g)||e(q)||!this._isNodeInScaleBounds(q)});0<t.length&&this._lodHandling.setLodGlobalDirty();this._removeNodes(t,a,w.pop);if(c&&1>this._lodDropFactor)return!1;if(0===t.length)return!0;t.clear();return!1};d.markNodeToRemove=function(a){t.push(a)};
d.removeMarkedNodes=function(){this._removeNodes(t,ea.noBudget,w.pop)};d._removeNodes=function(a,b,c){const e=a.length;if(0!==e&&!b.done){for(null!=this._index&&this._index.requestUpdate();0<a.length&&!b.done;){const g=a.pop(),q=this._index;c===w.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=q&&q.isGeometryVisible(g)?this.layerView.fadeNode(g,ca.FadeDirection.FadeOut,!0):this.layerView.removeNode(g);b.madeProgress()}if(0<this._loadedNodeScales.size)for(b=a.length;b<e;b++)this._loadedNodeScales.delete(a.data[b])}};
d._needsUpdate=function(a){if(a.resources.isEmpty||this._updatingNodes.has(a.index))return!1;a=this.layerView.getLoadedAttributes(a.index);return null!=a&&a!==this._requiredAttributes};d._updateLoadedNode=async function(a){const b=new AbortController;this._updatingNodes.set(a.index,b);this._evaluateUpdating();try{const c=this.layerView.getLoadedAttributes(a.index);let e=null;e=F(c,this._requiredAttributes)?await Promise.resolve(this.layerView.getAttributeData(a.index)):await this._loadAttributes(a,
this._requiredAttributes,b.signal);await this.schedule(()=>this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:e},b.signal),b.signal)}catch(c){if(!y.isAbortError(c))return this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},b.signal)}this._updatingNodes.delete(a.index);this._evaluateUpdating()};d._loadNode=function(a){if(this._loadingNodes.has(a.index))v.error("already loading node "+a.index);else{var b=
new AbortController;this._loadingNodes.set(a.index,b);this._evaluateUpdating();this._loadAndAddNode(a,b.signal).then(c=>{c&&null!=this._index&&this._loadingNodes.get(a.index)===b&&(this._loadingNodes.delete(a.index),this._index.requestUpdate())}).catch(c=>{if(!y.isAbortError(c))throw c;}).finally(()=>{this._loadingNodes.get(a.index)===b&&this._loadingNodes.delete(a.index);this._evaluateUpdating()})}};d._loadAndAddNode=function(a,b){return a.cacheState===u.CacheState.Uncached?this._loadUncached(a,
b).then(()=>!1):this._loadCached(a,b).then(c=>{if(c)return!1;a.cacheState=u.CacheState.Uncached;return!0}).catch(c=>y.isAbortError(c)?!1:(a.cacheState=u.CacheState.Uncached,!0))};d._enableFromGPUCache=function(a,b){if(this._disableMemCache||null==this._index)return!1;if(b===u.NodeState.Hole&&!this._index.useNodeAsHole(a.index))return!0;const c=this._loadCachedGPUData(a);if(!c)return!1;this.layerView.addCachedGPUData(a,c,b);this._nodeAdded();return!0};d._loadCachedGPUData=function(a){a=this.layerView.loadCachedGPUData(a.index);
if(null!=a&&null!=a.attributeInfo&&F(a.attributeInfo.loadedAttributes,this._requiredAttributes))return a;this.layerView.deleteCachedGPUData(a);return null};d._nodeAdded=function(){null!=this._index&&this._index.requestUpdate();this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};d.updateLoadStatus=function(a,b){const c=this._index;null!=c&&c.updateChildrenLoaded(a,b?1:-1)};d._loadCached=async function(a,b){if(this._enableFromGPUCache(a,u.NodeState.Leaf))return!0;const c=this.layerView;
if(this.disableIDBCache||!c.loadCachedNodeData||!c.addCachedNodeData)return!1;const e=(I,J)=>this._nodeLoader.loadTextures(a,I,J),g=(I,J)=>this._clientNodeLoader.loadTextures(a,I,J),q=0<=a.index?e:g,f=await this.schedule(()=>c.loadCachedNodeData(a,b,q),b);if(null==f)return!1;const r=this._requiredAttributes,z=await this.reschedule(()=>this._loadAttributes(a,r,b),b);await this.reschedule(()=>c.addCachedNodeData(a,f,{loadedAttributes:r,attributeData:z},b),b);this._nodeAdded();return!0};d._loadUncached=
function(a,b){this._downloadingCount++;return this._loadNodeData(a,b).catch(c=>{this._downloadingCount--;throw c;}).then(c=>{this._downloadingCount--;return this.schedule(()=>this.layerView.addNode(a,c,b),b)}).then(()=>{this._nodeAdded();a.cacheState=u.CacheState.Cached}).catch(c=>{if(!y.isAbortError(c))throw v.error("#loadNodeData()",this.layer,`Failed to load node '${a.id}'`,c),a.failed=!0,null!=this._index&&this._index.requestUpdate(),c;})};d._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=
a,this._evaluateUpdating(),a&&this._index&&null!=this._index&&this._index.resetFailedNodes())};d._getScale=function(a){if(this._loadedNodeScales.has(a.index))return this._loadedNodeScales.get(a.index);const b=this._computeScale(a);this.layerView.isNodeLoaded(a.index)&&this._loadedNodeScales.set(a.index,b);return b};d._computeScale=function(a){this._tmpPoint.x=a.mbs[0];this._tmpPoint.y=a.mbs[1];this._tmpPoint.z=a.mbs[2];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,a.mbs[3])};
d._isNodeInScaleBounds=function(a){if(!this._areScaleBoundsActive)return!0;a=this._getScale(a);const {minScale:b,maxScale:c}=E.extractSafeScaleBounds(this.layer);return E.scaleBoundsPredicate(a,b,c)};d.updateStats=function(a){a.index=null!=this._index?this._index.size:0;this.isGraphics3D&&(a.detail=this._featureLOD,a.target=this.featureTarget*this._baseLOD);null!=this._index&&this._index.updateStats(a)};d.notifyLODUpdate=function(){this._lodHandling.setLodGlobalDirty();this._evaluateUpdating();null!=
this._index&&this._index.requestUpdate()};d.geometryFilterChanged=function(a){const b=this._index;null!=b&&b.layerFilterChanged(a);this._setCameraDirty()};K._createClass(p,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"useMaximumNumberOfFeatures",get:function(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}},
{key:"indexStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(D.ClientType.I3S_INDEX);return new M.I3SStreamDataController(a,this.layer.apiKey)}},{key:"dataStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(D.ClientType.I3S_DATA);return new M.I3SStreamDataController(a,this.layer.apiKey)}},{key:"crsVertex",get:function(){return C.getVertexCrs(this.layer)}},{key:"crsIndex",get:function(){return C.getIndexCrs(this.layer)}},
{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"running",get:function(){return this.updating}},{key:"rootNodeVisible",get:function(){if(null!=this._index){const a=this._index.rootNode;if(null!=a)return this._updateViewData(),this._index.isNodeVisible(a.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"_isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"_areScaleBoundsActive",get:function(){const {minScale:a,maxScale:b}=E.extractSafeScaleBounds(this.layer);
return this.scaleVisibilityEnabled&&(0<a||0<b)}},{key:"unloadedMemoryEstimate",get:function(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}},{key:"indexDepth",get:function(){return null!=this._index?this._index.maxLevel:0}},{key:"disableMemCache",set:function(a){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0);this._disableMemCache=a}},{key:"_lod",get:function(){return this._featureLOD*
this._baseLOD}},{key:"_baseLOD",get:function(){const a=this.layerView.lodFactor,b=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(0<a?a:1)*b}},{key:"_lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;const a=this.layerView.view.resourceController.memoryController;return(Math.min(a.memoryFactor,.5)-a.minQuality)/(.5-a.minQuality)}},{key:"test",get:function(){const a=this;return{index:this._index,set disableUpdates(b){(a._updatesDisabled=
b)?a.cancelNodeLoading():a.requestUpdate()},set disableIDBCache(b){a.disableIDBCache=b},set ignoreServiceObb(b){null!=a._index&&(a._index.ignoreServiceObb=b)},shouldLoadNode:b=>a._shouldLoadNode(b)}}}]);return p}(R.EsriPromiseMixin(h));k.__decorate([l.property({readOnly:!0})],h.prototype,"isMeshPyramid",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"isGraphics3D",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"useMaximumNumberOfFeatures",null);k.__decorate([l.property({readOnly:!0})],
h.prototype,"indexStreamController",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"dataStreamController",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"crsVertex",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"crsIndex",null);k.__decorate([l.property()],h.prototype,"screenSizeFactor",void 0);k.__decorate([l.property()],h.prototype,"featureTarget",void 0);k.__decorate([l.property()],h.prototype,"fixedFeatureTarget",void 0);k.__decorate([l.property()],h.prototype,
"layerView",void 0);k.__decorate([l.property()],h.prototype,"layer",null);k.__decorate([l.property()],h.prototype,"updating",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"running",null);k.__decorate([l.property()],h.prototype,"updatingProgress",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"leavesReached",void 0);k.__decorate([l.property({constructOnly:!0})],h.prototype,"scaleVisibilityEnabled",void 0);k.__decorate([l.property({constructOnly:!0})],h.prototype,"worker",
void 0);k.__decorate([l.property({readOnly:!0,dependsOn:[]})],h.prototype,"rootNodeVisible",null);h=k.__decorate([S.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],h);const t=new x({deallocator:null});let H;const N={factorIM:.2,factor3dObject:.05,distancePenalty:10},A=B.create();var w;(function(n){n[n.pop=0]="pop";n[n.fadeout=1]="fadeout"})(w||(w={}));return h});
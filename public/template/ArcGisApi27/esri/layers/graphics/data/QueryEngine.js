// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../../support/arcadeOnDemand ../../../views/support/Scheduler".split(" "),
function(H,L,M,x,N,E,O,T,I,F,J,U,G,P,y,V,p,v,W,q,z,Q,r,X,Y,R){function Z(A){return null!=A&&A.every(h=>"exceedslimit"!==h.statisticType)}let aa=L._createClass(function(A,h=null,a,b,c){this.attributes=A;this.geometry=a;this.centroid=b;this.filterFlags=c;this.groupId=-1;this.displayId=h});const ba=new O.MemCacheStorage(2E6);let ca=0,ha=function(){function A(a){this._changeHandle=this._geometryQueryCache=null;this.capabilities={query:W.queryCapabilities};this.geometryType=a.geometryType;this.hasM=!!a.hasM;
this.hasZ=!!a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.featureStore=a.featureStore;this.aggregateAdapter=a.aggregateAdapter;this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=a.timeInfo;a.cacheSpatialQueries&&(this._geometryQueryCache=new O.MemCache(ca++ +"$$",ba));this.fieldsIndex=new X(a.fields);a.scheduler&&a.priority&&(this._frameTask=a.scheduler.registerTask(a.priority))}
var h=A.prototype;h.destroy=function(){this._frameTask=E.removeMaybe(this._frameTask);this.clearCache();E.destroyMaybe(this._geometryQueryCache);this._changeHandle=E.removeMaybe(this._changeHandle);E.destroyMaybe(this.fieldsIndex)};h.clearCache=function(){this._geometryQueryCache?.clear();this._timeExtentPromise=this._allFeaturesPromise=null};h.executeQuery=async function(a,b){try{return(await this._executeQuery(a,{},b)).createQueryResponse()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return(new q.QueryEngineResult([],
a,this)).createQueryResponse()}};h.executeQueryForCount=async function(a={},b){try{return(await this._executeQuery(a,{returnGeometry:!1,returnCentroid:!1,outSR:null},b)).createQueryResponseForCount()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return 0}};h.executeQueryForExtent=async function(a,b){const c=a.outSR;try{const d=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),e=d.size;if(!e)return{count:0,extent:null};const g=await this._getBounds(d.items,d.spatialReference,
c||this.spatialReference);return{count:e,extent:g}}catch(d){if(d===r.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw d;}};h.executeQueryForIds=async function(a,b){return this.executeQueryForIdSet(a,b).then(c=>Array.from(c))};h.executeQueryForIdSet=async function(a,b){try{const c=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),d=c.items,e=new Set;await this._reschedule(()=>{for(const g of d)e.add(c.featureAdapter.getObjectId(g))},b);return e}catch(c){if(c===
r.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw c;}};h.executeQueryForSnapping=async function(a,b){const {point:c,distance:d,returnEdge:e,returnVertex:g}=a;if(!e&&!g)return{candidates:[]};const k=await this._reschedule(()=>this._checkQuerySupport(a.query),b),l=!y.equals(c.spatialReference,this.spatialReference);l&&await v.checkProjectionSupport(c.spatialReference,this.spatialReference);var f="number"===typeof d?d:d.x,m="number"===typeof d?d:d.y;f={xmin:c.x-f,xmax:c.x+f,ymin:c.y-m,ymax:c.y+m,spatialReference:c.spatialReference};
f=l?v.project(f,this.spatialReference):f;if(!f)return{candidates:[]};m=(await P.normalizeCentralMeridian(G.fromJSON(c),null,{signal:b}))[0];const u=(await P.normalizeCentralMeridian(G.fromJSON(f),null,{signal:b}))[0];if(null==m||null==u)return{candidates:[]};const n=new q.QueryEngineResult(await this._reschedule(()=>this._searchFeatures(this._getQueryBBoxes(u.toJSON())),b),k,this);await this._reschedule(()=>this._executeObjectIdsQuery(n),b);await this._reschedule(()=>this._executeTimeQuery(n),b);
await this._reschedule(()=>this._executeAttributesQuery(n),b);b=m.toJSON();b=l?v.project(b,this.spatialReference):b;return n.createSnappingResponse({...a,point:b,distance:l?Math.max(f.xmax-f.xmin,f.ymax-f.ymin)/2:d},c.spatialReference)};h.executeQueryForLatestObservations=async function(a,b){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new x("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});try{const c=await this._executeQuery(a,
{},b);await this._reschedule(()=>this._filterLatest(c),b);return c.createQueryResponse()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return(new q.QueryEngineResult([],a,this)).createQueryResponse()}};h.executeQueryForSummaryStatistics=async function(a={},b,c){const {field:d,normalizationField:e,valueExpression:g}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:g},c)).createSummaryStatisticsResponse(b)};h.executeQueryForUniqueValues=async function(a=
{},b,c){const {field:d,field2:e,field3:g,valueExpression:k}=b;return(await this._getQueryEngineResultForStats(a,{field:d,field2:e,field3:g,valueExpression:k},c)).createUniqueValuesResponse(b)};h.executeQueryForClassBreaks=async function(a={},b,c){const {field:d,normalizationField:e,valueExpression:g}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:g},c)).createClassBreaksResponse(b)};h.executeQueryForHistogram=async function(a={},b,c){const {field:d,
normalizationField:e,valueExpression:g}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:g},c)).createHistogramResponse(b)};h.fetchRecomputedExtents=async function(a){const [b,c]=await Promise.all(["getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getBounds(await this._getAllFeatures(),this.spatialReference,this.spatialReference),null!=this._timeExtentPromise?
this._timeExtentPromise:this._timeExtentPromise=Q.getTimeExtent(this.timeInfo,this.featureStore)]);T.throwIfAborted(a);return{fullExtent:b,timeExtent:c}};h._getBounds=async function(a,b,c){const d=F.set(F.create(),F.NEGATIVE_INFINITY);await this.featureStore.forEachBounds(a,e=>F.expandWithAABB(d,e));a={xmin:d[0],ymin:d[1],xmax:d[3],ymax:d[4],spatialReference:r.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(d[2])&&isFinite(d[5])&&(a.zmin=d[2],a.zmax=d[5]);b=v.project(a,b,c);b.spatialReference=
r.cleanFromGeometryEngine(c);0===b.xmax-b.xmin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.xmin-=c,b.xmax+=c);0===b.ymax-b.ymin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.ymin-=c,b.ymax+=c);this.hasZ&&null!=b.zmin&&null!=b.zmax&&0===b.zmax-b.zmin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.zmin-=c,b.zmax+=c);return b};h._schedule=async function(a,b){return null!=this._frameTask?this._frameTask.schedule(a,b):a(R.noBudget)};h._reschedule=async function(a,b){return null!=this._frameTask?
this._frameTask.reschedule(a,b):a(R.noBudget)};h._getAllFeaturesQueryEngineResult=async function(a){return new q.QueryEngineResult(await this._getAllFeatures(),a,this)};h._getAllFeatures=async function(){if(null==this._allFeaturesPromise){const c=[];this._allFeaturesPromise=(async()=>{await this.featureStore.forEach(d=>c.push(d))})().then(()=>c)}const a=this._allFeaturesPromise,b=await a;return a===this._allFeaturesPromise?b.slice():this._getAllFeatures()};h._executeQuery=async function(a,b,c){a=
N.clone(a);a=await this._schedule(()=>r.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>this._checkQuerySupport(a),c);a={...a,...b};const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),c);await this._reschedule(()=>this._executeTimeQuery(e),c);
await this._reschedule(()=>this._executeAttributesQuery(e),c);return e};h._executeSceneFilterQuery=async function(a,b){if(null==a.sceneFilter)return null;const {outSR:c,returnGeometry:d,returnCentroid:e}=a;var g=this.featureStore.featureSpatialReference,k=a.sceneFilter.geometry;const l=null==g||y.equals(g,k.spatialReference)?k:v.project(k,g);if(!l)return null;g=d||e;g=y.isValid(c)&&!y.equals(this.spatialReference,c)&&g?async n=>this._project(n,c):n=>n;const f=this.featureAdapter;k=await this._reschedule(()=>
this._searchFeatures(this._getQueryBBoxes(l)),b);if("disjoint"===a.sceneFilter.spatialRelationship){if(!k.length)return null;const n=new Set;for(var m of k)n.add(f.getObjectId(m));const B=await this._reschedule(()=>this._getAllFeatures(),b);m=await this._reschedule(async()=>{const D=await z.getSpatialQueryOperator("esriSpatialRelDisjoint",l,this.geometryType,this.hasZ,this.hasM),w=await this._runSpatialFilter(B,C=>!n.has(f.getObjectId(C))||D(f.getGeometry(C)),b);return new q.QueryEngineResult(w,a,
this)},b);return g(m)}if(!k.length)return new q.QueryEngineResult([],a,this);if(this._canExecuteSinglePass(l,a))return g(new q.QueryEngineResult(k,a,this));const u=await z.getSpatialQueryOperator("esriSpatialRelContains",l,this.geometryType,this.hasZ,this.hasM);m=await this._runSpatialFilter(k,n=>u(f.getGeometry(n)),b);return g(new q.QueryEngineResult(m,a,this))};h._executeGeometryQuery=async function(a,b,c){if(null!=b&&0===b.items.length)return b;a=null!=b?b.query:a;const {geometry:d,outSR:e,spatialRel:g,
returnGeometry:k,returnCentroid:l}=a;var f=this.featureStore.featureSpatialReference;const m=!d||null==f||y.equals(f,d.spatialReference)?d:v.project(d,f),u=k||l,n=y.isValid(e)&&!y.equals(this.spatialReference,e),B=this._geometryQueryCache&&null==b?n&&u?JSON.stringify({originalFilterGeometry:d,spatialRelationship:g,outSpatialReference:e}):JSON.stringify({originalFilterGeometry:d,spatialRelationship:g}):null;f=B?this._geometryQueryCache.get(B):null;if(null!=f)return new q.QueryEngineResult(f,a,this);
f=async t=>{n&&u&&await this._project(t,e);B&&this._geometryQueryCache.put(B,t.items,t.items.length+1);return t};if(!m)return f(null!=b?b:await this._getAllFeaturesQueryEngineResult(a));const D=this.featureAdapter;let w=await this._reschedule(()=>this._searchFeatures(this._getQueryBBoxes(d)),c);if("esriSpatialRelDisjoint"===g){if(!w.length)return f(null!=b?b:await this._getAllFeaturesQueryEngineResult(a));const t=new Set;for(var C of w)t.add(D.getObjectId(C));const K=null!=b?b.items:await this._reschedule(()=>
this._getAllFeatures(),c);C=await this._reschedule(async()=>{const da=await z.getSpatialQueryOperator(g,m,this.geometryType,this.hasZ,this.hasM),ea=await this._runSpatialFilter(K,S=>!t.has(D.getObjectId(S))||da(D.getGeometry(S)),c);return new q.QueryEngineResult(ea,a,this)},c);return f(C)}if(null!=b){const t=new M.PositionHint;w=w.filter(K=>0<=M.indexOf(b.items,K,b.items.length,t))}if(!w.length)return f=new q.QueryEngineResult([],a,this),B&&this._geometryQueryCache.put(B,f.items,1),f;if(this._canExecuteSinglePass(m,
a))return f(new q.QueryEngineResult(w,a,this));const fa=await z.getSpatialQueryOperator(g,m,this.geometryType,this.hasZ,this.hasM);C=await this._runSpatialFilter(w,t=>fa(D.getGeometry(t)),c);return f(new q.QueryEngineResult(C,a,this))};h._executeAggregateIdsQuery=function(a){if(0!==a.items.length&&a.query.aggregateIds&&a.query.aggregateIds.length&&null!=this.aggregateAdapter){var b=new Set;for(const d of a.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>b.add(e));var c=
this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}};h._executeObjectIdsQuery=function(a){if(0!==a.items.length&&a.query.objectIds&&a.query.objectIds.length){var b=new Set(a.query.objectIds),c=this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}};h._executeTimeQuery=function(a){if(0!==a.items.length){var b=Q.getTimeOperator(this.timeInfo,a.query.timeExtent,this.featureAdapter);null!=b&&(a.items=a.items.filter(b))}};h._executeAttributesQuery=function(a){if(0!==
a.items.length){var b=p.getWhereClause(a.query.where,this.fieldsIndex);if(b){if(!b.isStandardized)throw new TypeError("Where clause is not standardized");a.items=a.items.filter(c=>b.testFeature(c,this.featureAdapter))}}};h._runSpatialFilter=async function(a,b,c){if(!b)return a;if(null==this._frameTask)return a.filter(k=>b(k));let d=0;const e=[],g=async k=>{for(;d<a.length;){const l=a[d++];b(l)&&(e.push(l),k.madeProgress());k.done&&await this._reschedule(f=>g(f),c)}};return this._reschedule(k=>g(k),
c).then(()=>e)};h._filterLatest=function(a){const {trackIdField:b,startTimeField:c,endTimeField:d}=this.timeInfo,e=d||c,g=new Map,k=this.featureAdapter.getAttribute;for(const l of a.items){const f=k(l,b),m=k(l,e),u=g.get(f);(!u||m>k(u,e))&&g.set(f,l)}a.items=Array.from(g.values())};h._canExecuteSinglePass=function(a,b){({spatialRel:b}=b);return z.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===
b||"esriSpatialRelWithin"===b))};h._project=async function(a,b){if(!b||y.equals(this.spatialReference,b))return a;const c=this.featureAdapter;b=await v.projectMany(a.items.map(d=>r.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(d))),this.spatialReference,b);a.items=b.map((d,e)=>c.cloneWithGeometry(a.items[e],V.convertFromGeometry(d,this.hasZ,this.hasM)));return a};h._getQueryBBoxes=function(a){if(z.canQueryWithRBush(a)){if(G.isExtent(a))return[J.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];
if(G.isPolygon(a))return a.rings.map(b=>J.fromValues(Math.min(b[0][0],b[2][0]),Math.min(b[0][1],b[2][1]),Math.max(b[0][0],b[2][0]),Math.max(b[0][1],b[2][1])))}return[U.getBoundsXY(J.create(),a)]};h._searchFeatures=async function(a){const b=new Set;await Promise.all(a.map(c=>this.featureStore.forEachInBounds(c,d=>b.add(d))));a=Array.from(b.values());b.clear();return a};h._checkStatisticsSupport=async function(a,b){if(0>(a.distance??0)||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||
a.text||a.outStatistics||a.groupByFieldsForStatistics||a.having||a.orderByFields)throw new x("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);return Promise.all([this._checkStatisticsParamsSupport(b,a),z.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),v.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)};h._checkStatisticsParamsSupport=async function(a,b){var c=[];a.valueExpression&&({arcadeUtils:c}=
await Y.loadArcade(),c=c.extractFieldNames(a.valueExpression));a.field&&c.push(a.field);a.field2&&c.push(a.field2);a.field3&&c.push(a.field3);a.normalizationField&&c.push(a.normalizationField);if(!c.length&&!a.valueExpression)throw new x("feature-store:unsupported-query","field or valueExpression is required",{params:a});p.validateFields(this.fieldsIndex,c,{errorMessage:"Cannot calculate statistics for missing fields",query:b});p.validateFieldTypes(this.fieldsIndex,c,{expressionName:"statistics",
query:b})};h._checkQuerySupport=async function(a){if(0>(a.distance??0)||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new x("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);this._checkStatisticsQuerySupport(a);return Promise.all([z.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),v.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)};h._checkAttributesQuerySupport=
function(a){const {outFields:b,orderByFields:c,returnDistinctValues:d,outStatistics:e}=a,g=e?e.map(k=>k.outStatisticFieldName&&k.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(c&&0<c.length){const k=c.map(l=>{const f=l.toLowerCase();return f.includes(" asc")?f.split(" asc")[0]:f.includes(" desc")?f.split(" desc")[0]:l}).filter(l=>!g.includes(l));p.validateFields(this.fieldsIndex,k,{expressionName:"orderByFields",query:a})}if(b&&0<b.length)p.validateFields(this.fieldsIndex,b,{expressionName:"outFields",
query:a});else if(d)throw new x("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});p.validateWhere(this.fieldsIndex,a.where,a)};h._checkStatisticsQuerySupport=function(a){const {outStatistics:b,groupByFieldsForStatistics:c,having:d}=a;var e=c&&c.length,g=b&&b.length;if(d){if(!e||!g)throw new x("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});p.validateHaving(this.fieldsIndex,
d,b,a)}if(g&&Z(b)){g=b.map(k=>k.onStatisticField).filter(Boolean);p.validateFields(this.fieldsIndex,g,{expressionName:"onStatisticFields",query:a});e&&p.validateFields(this.fieldsIndex,c,{expressionName:"groupByFieldsForStatistics",query:a});e=new Set([...p.validNumericTypesKebabDict.jsonValues,...p.validDateTypesKebabDict.jsonValues]);g=(new Intl.ListFormat("en-US",{type:"conjunction"})).format([...p.validNumericTypesKebabDict.apiValues,...p.validDateTypesKebabDict.apiValues]);for(const k of b){const {onStatisticField:l,
statisticType:f}=k;if(("percentile_disc"===f||"percentile_cont"===f)&&"statisticParameters"in k){const {statisticParameters:m}=k;if(!m)throw new x("feature-store:unsupported-query","statisticParameters should be set for percentile type",{definition:k,query:a});}else if("count"!==f&&"min"!==f&&"max"!==f&&l&&p.hasInvalidFieldType(l,this.fieldsIndex,e))throw new x("feature-store:unsupported-query",`outStatistics with '${f}' statistic type, only supports ${g} field types`,{definition:k,query:a});}}};
h._getQueryEngineResultForStats=async function(a,b,c){a=N.clone(a);try{a=await this._schedule(()=>r.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>this._checkStatisticsSupport(a,b),c);const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),c);await this._reschedule(()=>
this._executeTimeQuery(e),c);await this._reschedule(()=>this._executeAttributesQuery(e),c);return e}catch(d){if(d!==r.QUERY_ENGINE_EMPTY_RESULT)throw d;return new q.QueryEngineResult([],a,this)}};L._createClass(A,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}}]);return A}();H.Feature=aa;H.QueryEngine=ha;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});
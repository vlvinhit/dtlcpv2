// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../geometry/support/centroid ../../../geometry/support/extentUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ./AttributesBuilder ./projectionSupport ./SnappingCandidate ./utils ../../support/fieldUtils ../../../statistics/utils".split(" "),function(aa,P,Q,R,M,S,N,K,T,U,D,V,A){function ba(C,l,a,b){const c=b.x-a.x;b=b.y-a.y;l=Math.min(1,Math.max(0,((l.x-a.x)*c+(l.y-a.y)*b)/(c*c+
b*b)));C.x=a.x+c*l;C.y=a.y+b*l}function W(C,l){return C?l?4:3:l?3:2}let ea=function(){function C(a,b,c){this.items=a;this.query=b;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.fieldsIndex=c.fieldsIndex;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.featureAdapter=c.featureAdapter}var l=C.prototype;l.createQueryResponseForCount=function(){const a=new K(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return a.countDistinctValues(this.items);
const {groupByFieldsForStatistics:b,having:c,outStatistics:g}=this.query;if(!b?.length)return 1;const d=new Map,e=new Map,h=new Set;for(const m of g){var {statisticType:f}=m;f="exceedslimit"!==f?m.onStatisticField:void 0;if(!e.has(f)){var k=[];for(const q of b){const n=this._getAttributeValues(a,q,d);k.push(n)}e.set(f,this._calculateUniqueValues(k,a.returnDistinctValues))}f=e.get(f);for(const q in f){const {data:n,items:t}=f[q];k=n.join(",");c&&!a.validateItems(t,c)||h.add(k)}}return h.size};l.createQueryResponse=
async function(){let a;a=this.query.outStatistics?this.query.outStatistics.some(b=>"exceedslimit"===b.statisticType)?this._createExceedsLimitQueryResponse(this.query):await this._createStatisticsQueryResponse(this.query):this._createFeatureQueryResponse(this.query);if(this.query.returnQueryGeometry){const b=this.query.geometry;N.isValid(this.query.outSR)&&!N.equals(b.spatialReference,this.query.outSR)?a.queryGeometry=D.cleanFromGeometryEngine({spatialReference:this.query.outSR,...T.project(b,b.spatialReference,
this.query.outSR)}):a.queryGeometry=D.cleanFromGeometryEngine({spatialReference:this.query.outSR,...b})}return a};l.createSnappingResponse=function(a,b){const c=this.featureAdapter,g=W(this.hasZ,this.hasM),{point:d,mode:e}=a,h="number"===typeof a.distance?a.distance:a.distance.x,f="number"===typeof a.distance?a.distance:a.distance.y,k={candidates:[]},m="esriGeometryPolygon"===this.geometryType;b=this._getPointCreator(e,this.spatialReference,b);const q=new X(null,0),n=new X(null,0),t={x:0,y:0,z:0};
for(const u of this.items){var w=c.getGeometry(u);if(null==w)continue;const {coords:y,lengths:B}=w;q.coords=y;n.coords=y;if(a.returnEdge){w=0;for(var z=0;z<B.length;z++){var r=B[z];for(var p=0;p<r;p++,w+=g){var v=q;v.coordsIndex=w;if(p!==r-1){const F=n;F.coordsIndex=w+g;const E=t;ba(t,d,v,F);var x=(d.x-E.x)/h;const L=(d.y-E.y)/f;x=x*x+L*L;1>=x&&k.candidates.push(U.makeEdgeCandidate(c.getObjectId(u),b(E),Math.sqrt(x),b(v),b(F)))}}}}if(a.returnVertex)for(w=m?y.length-g:y.length,z=0;z<w;z+=g)r=q,r.coordsIndex=
z,p=(d.x-r.x)/h,v=(d.y-r.y)/f,p=p*p+v*v,1>=p&&k.candidates.push(U.makeVertexCandidate(c.getObjectId(u),b(r),Math.sqrt(p)))}k.candidates.sort((u,y)=>u.distance-y.distance);return k};l._getPointCreator=function(a,b,c){const g=null==c||N.equals(b,c)?e=>e:e=>T.project(e,b,c),{hasZ:d}=this;return"3d"===a?d?({x:e,y:h,z:f})=>g({x:e,y:h,z:f}):({x:e,y:h})=>g({x:e,y:h,z:0}):({x:e,y:h})=>g({x:e,y:h})};l.createSummaryStatisticsResponse=async function(a){const {field:b,valueExpression:c,normalizationField:g,normalizationType:d,
normalizationTotal:e,minValue:h,maxValue:f,scale:k}=a;a=this.fieldsIndex.isDateField(b);var m=await this._getDataValues({field:b,valueExpression:c,normalizationField:g,normalizationType:d,normalizationTotal:e,scale:k});const q=A.isNullCountSupported({normalizationType:d,normalizationField:g,minValue:h,maxValue:f}),n=this.fieldsIndex.get(b),t={value:.5,fieldType:n?.type};m=V.isStringField(n)?A.calculateStringStatistics({values:m,supportsNullCount:q,percentileParams:t}):A.calculateStatistics({values:m,
minValue:h,maxValue:f,useSampleStdDev:!d,supportsNullCount:q,percentileParams:t});return A.processSummaryStatisticsResult(m,a)};l.createUniqueValuesResponse=async function(a){const {field:b,valueExpression:c,domains:g,returnAllCodedValues:d,scale:e}=a;var h=await this._getDataValues({field:b,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,valueExpression:c,scale:e});h=A.calculateUniqueValuesCount(h);return A.createUVResult(h,g,d,a.fieldDelimiter)};l.createClassBreaksResponse=async function(a){const {field:b,
valueExpression:c,normalizationField:g,normalizationType:d,normalizationTotal:e,classificationMethod:h,standardDeviationInterval:f,minValue:k,maxValue:m,numClasses:q,scale:n}=a;a=await this._getDataValues({field:b,valueExpression:c,normalizationField:g,normalizationType:d,normalizationTotal:e,scale:n});a=A.calculateClassBreaks(a,{field:b,normalizationField:g,normalizationType:d,normalizationTotal:e,classificationMethod:h,standardDeviationInterval:f,minValue:k,maxValue:m,numClasses:q});return A.resolveCBResult(a,
h)};l.createHistogramResponse=async function(a){const {field:b,valueExpression:c,normalizationField:g,normalizationType:d,normalizationTotal:e,classificationMethod:h,standardDeviationInterval:f,minValue:k,maxValue:m,numBins:q,scale:n}=a;a=await this._getDataValues({field:b,valueExpression:c,normalizationField:g,normalizationType:d,normalizationTotal:e,scale:n});return A.calculateHistogram(a,{field:b,normalizationField:g,normalizationType:d,normalizationTotal:e,classificationMethod:h,standardDeviationInterval:f,
minValue:k,maxValue:m,numBins:q})};l._sortFeatures=function(a,b,c){if(1<a.length&&b&&b.length)for(const g of b.reverse()){b=g.split(" ");const d=b[0],e=this.fieldsIndex.get(d);b=b[1]?"desc"===b[1].toLowerCase():!1;const h=A.getAttributeComparator(e?.type,b);a.sort((f,k)=>{f=c(f,d,e);k=c(k,d,e);return h(f,k)})}};l._createFeatureQueryResponse=function(a){const b=this.items,{geometryType:c,hasM:g,hasZ:d,objectIdField:e,spatialReference:h}=this,{outFields:f,outSR:k,quantizationParameters:m,resultRecordCount:q,
resultOffset:n,returnZ:t,returnM:w}=a,z=null!=q?b.length>(n||0)+q:!1,r=f&&(f.includes("*")?[...this.fieldsIndex.fields]:f.map(p=>this.fieldsIndex.get(p)));return{exceededTransferLimit:z,features:this._createFeatures(a,b),fields:r,geometryType:c,hasM:g&&w,hasZ:d&&t,objectIdFieldName:e,spatialReference:D.cleanFromGeometryEngine(k||h),transform:m&&S.toQuantizationTransform(m)||null}};l._createFeatures=function(a,b){const c=new K(a,this.featureAdapter,this.fieldsIndex),{hasM:g,hasZ:d}=this,{orderByFields:e,
quantizationParameters:h,returnGeometry:f,returnCentroid:k,maxAllowableOffset:m,resultOffset:q,resultRecordCount:n,returnZ:t=!1,returnM:w=!1}=a,z=d&&t,r=g&&w;a=[];var p=0;b=[...b];this._sortFeatures(b,e,(u,y,B)=>c.getFieldValue(u,y,B));if(f||k){var v=S.toQuantizationTransform(h)??void 0;if(f&&!k)for(var x of b)a[p++]={attributes:c.getAttributes(x),geometry:D.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(x),m,v,z,r)};else if(!f&&k)for(const u of b)a[p++]={attributes:c.getAttributes(u),
centroid:D.transformCentroid(this,this.featureAdapter.getCentroid(u,this),v)};else for(const u of b)a[p++]={attributes:c.getAttributes(u),centroid:D.transformCentroid(this,this.featureAdapter.getCentroid(u,this),v),geometry:D.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(u),m,v,z,r)}}else for(v of b)(x=c.getAttributes(v))&&(a[p++]={attributes:x});p=q||0;null!=n&&(a=a.slice(p,Math.min(a.length,p+n)));return a};l._createExceedsLimitQueryResponse=function(a){var b=
!1;let c=Number.POSITIVE_INFINITY,g=Number.POSITIVE_INFINITY;b=Number.POSITIVE_INFINITY;for(const d of a.outStatistics??[])if("exceedslimit"===d.statisticType){c=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;g=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)b=this.items.length>c;else if(this.items.length>g)b=!0;else{a=W(this.hasZ,this.hasM);const d=
this.featureAdapter;b=this.items.reduce((e,h)=>{h=d.getGeometry(h);return e+(null!=h&&h.coords.length||0)},0)/a>b}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};l._createStatisticsQueryResponse=async function(a){var b={attributes:{}};const c=[],g=new Map,d=new Map,e=new Map,h=new Map,f=new K(a,this.featureAdapter,this.fieldsIndex);var k=a.outStatistics;
const {groupByFieldsForStatistics:m,having:q,orderByFields:n}=a;a=m&&m.length;const t=!!a,w=t?m[0]:null,z=t&&!this.fieldsIndex.get(w);for(const u of k??[]){const {outStatisticFieldName:y,statisticType:B}=u;k=u;var r="exceedslimit"!==B?u.onStatisticField:void 0;const F="percentile_disc"===B||"percentile_cont"===B,E="EnvelopeAggregate"===B||"CentroidAggregate"===B||"ConvexHullAggregate"===B,L=t&&1===a&&(r===w||z)&&"count"===B;if(t){if(!e.has(r)){var p=[];for(const I of m){var v=this._getAttributeValues(f,
I,g);p.push(v)}e.set(r,this._calculateUniqueValues(p,E?!1:f.returnDistinctValues))}p=e.get(r);for(const I in p){const {count:O,data:Y,items:Z,itemPositions:ca}=p[I];v=Y.join(",");if(!q||f.validateItems(Z,q)){const G=h.get(v)||{attributes:{}};if(E){G.aggregateGeometries||(G.aggregateGeometries={});const {aggregateGeometries:H,outStatisticFieldName:J}=await this._getAggregateGeometry(k,Z);G.aggregateGeometries[J]=H}else{var x=null;if(L)x=O;else{const H=this._getAttributeValues(f,r,g);x=ca.map(J=>H[J]);
x=F&&"statisticParameters"in k?this._getPercentileValue(k,x):this._getStatisticValue(k,x,null,f.returnDistinctValues)}G.attributes[y]=x}let da=0;m.forEach((H,J)=>G.attributes[this.fieldsIndex.get(H)?H:`EXPR_${++da}`]=Y[J]);h.set(v,G)}}}else if(E){b.aggregateGeometries||(b.aggregateGeometries={});const {aggregateGeometries:I,outStatisticFieldName:O}=await this._getAggregateGeometry(k,this.items);b.aggregateGeometries[O]=I}else r=this._getAttributeValues(f,r,g),b.attributes[y]=F&&"statisticParameters"in
k?this._getPercentileValue(k,r):this._getStatisticValue(k,r,d,f.returnDistinctValues);c.push({name:y,alias:y,type:"esriFieldTypeDouble"})}b=t?Array.from(h.values()):[b];this._sortFeatures(b,n,(u,y)=>u.attributes[y]);return{fields:c,features:b}};l._getAggregateGeometry=async function(a,b){const {convexHull:c,union:g}=await new Promise((t,w)=>aa(["../../../geometry/geometryEngineJSON"],t,w)),{statisticType:d,outStatisticFieldName:e}=a,{featureAdapter:h,spatialReference:f,geometryType:k,hasZ:m,hasM:q}=
this;b=b.map(t=>D.getGeometry(k,m,q,h.getGeometry(t)));const n=c(f,b,!0)[0];a={aggregateGeometries:null,outStatisticFieldName:null};"EnvelopeAggregate"===d?(b=n?M.getPolygonExtent(n):M.getGeometryExtent(g(f,b)),a.aggregateGeometries={...b,spatialReference:f},a.outStatisticFieldName=e||"extent"):"CentroidAggregate"===d?(b=n?R.polygonCentroid(n):R.extentCentroid(M.getGeometryExtent(g(f,b))),a.aggregateGeometries={x:b[0],y:b[1],spatialReference:f},a.outStatisticFieldName=e||"centroid"):"ConvexHullAggregate"===
d&&(a.aggregateGeometries=n,a.outStatisticFieldName=e||"convexHull");return a};l._getStatisticValue=function(a,b,c,g){const {onStatisticField:d,statisticType:e}=a;a=null;a=c?.has(d)?c.get(d):V.isStringField(this.fieldsIndex.get(d))?A.calculateStringStatistics({values:b,returnDistinct:g}):A.calculateStatistics({values:g?[...(new Set(b))]:b,minValue:null,maxValue:null,useSampleStdDev:!0});c&&c.set(d,a);return a["var"===e?"variance":e]};l._getPercentileValue=function(a,b){const {onStatisticField:c,statisticParameters:g,
statisticType:d}=a,{value:e,orderBy:h}=g;a=this.fieldsIndex.get(c);return A.calculatePercentile(b,{value:e,orderBy:h,fieldType:a?.type,isDiscrete:"percentile_disc"===d})};l._getAttributeValues=function(a,b,c){if(c.has(b))return c.get(b);const g=this.fieldsIndex.get(b),d=this.items.map(e=>a.getFieldValue(e,b,g));c.set(b,d);return d};l._calculateUniqueValues=function(a,b){const c={},g=this.items,d=g.length;for(let e=0;e<d;e++){const h=g[e],f=[];for(const m of a)f.push(m[e]);const k=f.join(",");null==
c[k]?c[k]={count:1,data:f,items:[h],itemPositions:[e]}:(b||c[k].count++,c[k].items.push(h),c[k].itemPositions.push(e))}return c};l._getDataValues=async function(a){const b=new K(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:c,scale:g}=a,d=c?{viewingMode:"map",scale:g,spatialReference:this.query.outSR||this.spatialReference}:null;return c?b.getExpressionValues(this.items,c,d,{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM}):b.getDataValues(this.items,{field:a.field,
field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,normalizationField:a.normalizationField,normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal})};Q._createClass(C,[{key:"size",get:function(){return this.items.length}}]);return C}(),X=function(){function C(l,a){this.coords=l;this.coordsIndex=a}Q._createClass(C,[{key:"x",get:function(){return this.coords[this.coordsIndex]}},{key:"y",get:function(){return this.coords[this.coordsIndex+1]}},{key:"z",get:function(){return this.coords[this.coordsIndex+
2]}}]);return C}();P.QueryEngineResult=ea;Object.defineProperty(P,Symbol.toStringTag,{value:"Module"})});
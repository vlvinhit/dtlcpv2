// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../chunks/_rollupPluginBabelHelpers","./attributeSupport","./utils","../../../statistics/utils","../../../support/arcadeOnDemand"],function(n,h,p,l,q){return function(){function m(b,a,d){this._fieldDataCache=new Map;this._returnDistinctMap=new Map;this.returnDistinctValues=b.returnDistinctValues??!1;this.fieldsIndex=d;this.featureAdapter=a;if((a=b.outFields)&&!a.includes("*")){this.outFields=a;b=0;for(const c of a){var e=h.getExpressionFromFieldName(c);e=(a=this.fieldsIndex.get(e))?
null:h.getWhereClause(e,d);a=a?a.name:h.getAliasFromFieldName(c)||`FIELD_EXP_${b++}`;this._fieldDataCache.set(c,{alias:a,clause:e})}}}var g=m.prototype;g.countDistinctValues=function(b){if(!this.returnDistinctValues)return b.length;b.forEach(a=>this.getAttributes(a));return this._returnDistinctMap.size};g.getAttributes=function(b){b=this._processAttributesForOutFields(b);return this._processAttributesForDistinctValues(b)};g.getFieldValue=function(b,a,d){const e=d?d.name:a;let c=null;this._fieldDataCache.has(e)?
c=this._fieldDataCache.get(e)?.clause:d||(c=h.getWhereClause(a,this.fieldsIndex),this._fieldDataCache.set(e,{alias:e,clause:c}));return d?this.featureAdapter.getAttribute(b,e):c?.calculateValue(b,this.featureAdapter)};g.getDataValues=function(b,a){const d=a.normalizationType,e=a.normalizationTotal;return b.map(c=>{let f=a.field&&this.getFieldValue(c,a.field,this.fieldsIndex.get(a.field));a.field2&&(f=`${l.processNullValue(f)}${a.fieldDelimiter}${l.processNullValue(this.getFieldValue(c,a.field2,this.fieldsIndex.get(a.field2)))}`,
a.field3&&(f=`${f}${a.fieldDelimiter}${l.processNullValue(this.getFieldValue(c,a.field3,this.fieldsIndex.get(a.field3)))}`));d&&Number.isFinite(f)&&(c="field"===d&&a.normalizationField?this.getFieldValue(c,a.normalizationField,this.fieldsIndex.get(a.normalizationField)):null,f=l.getNormalizedValue(f,d,c,e));return f})};g.getExpressionValues=async function(b,a,d,e){const {arcadeUtils:c}=await q.loadArcade(),f=c.hasGeometryOperations(a);f&&await c.enableGeometryOperations();const r=c.createFunction(a),
t=d&&c.getViewInfo(d),u={fields:this.fieldsIndex.fields};return b.map(k=>{k={attributes:this.featureAdapter.getAttributes(k),layer:u,geometry:f?{...p.getGeometry(e.geometryType,e.hasZ,e.hasM,this.featureAdapter.getGeometry(k)),spatialReference:d?.spatialReference}:null};k=c.createExecContext(k,t);return c.executeFunction(r,k)})};g.validateItem=function(b,a){this._fieldDataCache.has(a)||this._fieldDataCache.set(a,{alias:a,clause:h.getWhereClause(a,this.fieldsIndex)});return this._fieldDataCache.get(a)?.clause?.testFeature(b,
this.featureAdapter)??!1};g.validateItems=function(b,a){this._fieldDataCache.has(a)||this._fieldDataCache.set(a,{alias:a,clause:h.getWhereClause(a,this.fieldsIndex)});return this._fieldDataCache.get(a)?.clause?.testSet(b,this.featureAdapter)??!1};g._processAttributesForOutFields=function(b){const a=this.outFields;if(!a||!a.length)return this.featureAdapter.getAttributes(b);const d={};for(const e of a){const {alias:c,clause:f}=this._fieldDataCache.get(e);d[c]=f?f.calculateValue(b,this.featureAdapter):
this.featureAdapter.getAttribute(b,c)}return d};g._processAttributesForDistinctValues=function(b){if(null==b||!this.returnDistinctValues)return b;var a=this.outFields,d=[];if(a)for(const c of a){var {alias:e}=this._fieldDataCache.get(c);d.push(b[e])}else for(e in b)d.push(b[e]);a=`${(a||["*"]).join(",")}=${d.join(",")}`;d=this._returnDistinctMap.get(a)||0;this._returnDistinctMap.set(a,++d);return 1<d?null:b};return n._createClass(m)}()});
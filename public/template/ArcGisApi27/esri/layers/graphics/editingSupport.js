// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../Graphic ../../core/Collection ../../core/Error ../../core/lang ../../core/Logger ../../core/promiseUtils ../../core/urlUtils ../../geometry/support/normalizeUtils ../mixins/EditBusLayer ../support/infoFor3D ../support/layerUtils".split(" "),function(m,A,n,f,B,C,D,E,F,t,u,p){function v(a){return"object"===typeof a&&null!=a&&"objectId"in a&&!!a.objectId}function w(a){return"object"===typeof a&&null!=a&&"globalId"in a&&!!a.globalId}async function G(a,b,g,d){await a.load();if(!b||
null==b.applyEdits)throw new f(`${a.type}-layer:no-editing-support`,"Layer source does not support applyEdits capability",{layer:a});if(!p.getEffectiveEditingEnabled(a))throw new f(`${a.type}-layer:editing-disabled`,"Editing is disabled for layer",{layer:a});const {edits:c,options:h}=await H(a,g,d);return c.addFeatures?.length||c.updateFeatures?.length||c.deleteFeatures?.length||c.addAttachments?.length||c.updateAttachments?.length||c.deleteAttachments?.length?{edits:c,results:await b.applyEdits(c,
h)}:{edits:c,results:{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}}async function H(a,b,g){var d=b&&(b.addFeatures||b.updateFeatures||b.deleteFeatures),c=b&&(b.addAttachments||b.updateAttachments||b.deleteAttachments);const h=null!=a.infoFor3D;if(!b||!d&&!c)throw new f(`${a.type}-layer:missing-parameters`,"'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required");
d=p.getEffectiveLayerCapabilities(a);if(!d.data.isVersioned&&g?.gdbVersion)throw new f(`${a.type}-layer:invalid-parameter`,"'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");if(!d.editing.supportsRollbackOnFailure&&g?.rollbackOnFailureEnabled)throw new f(`${a.type}-layer:invalid-parameter`,"This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'");if(!d.editing.supportsGlobalId&&
g?.globalIdUsed)throw new f(`${a.type}-layer:invalid-parameter`,"This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'");if(!d.editing.supportsGlobalId&&c)throw new f(`${a.type}-layer:invalid-parameter`,"'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'");if(!g?.globalIdUsed&&c)throw new f(`${a.type}-layer:invalid-parameter`,"When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true");
c={...g};null!=c.rollbackOnFailureEnabled||d.editing.supportsRollbackOnFailure||(c.rollbackOnFailureEnabled=!0);c.rollbackOnFailureEnabled||"original-and-current-features"!==c.returnServiceEditsOption||(!1===c.rollbackOnFailureEnabled&&C.getLogger("esri.layers.graphics.editingSupport").warn(`${a.type}-layer:invalid-parameter`,"'original-and-current-features' is valid for 'returnServiceEditsOption' only when 'rollBackOnFailure' is true, but 'rollBackOnFailure' was set to false. 'rollBackOnFailure' has been overwrritten and set to true."),
c.rollbackOnFailureEnabled=!0);if(!d.editing.supportsReturnServiceEditsInSourceSpatialReference&&c.returnServiceEditsInSourceSR)throw new f(`${a.type}-layer:invalid-parameter`,"This layer does not support 'returnServiceEditsInSourceSR' parameter. See: 'capabilities.editing.supportsReturnServiceEditsInSourceSpatialReference'");if(c.returnServiceEditsInSourceSR&&"original-and-current-features"!==c.returnServiceEditsOption)throw new f(`${a.type}-layer:invalid-parameter`,"'returnServiceEditsInSourceSR' is valid only when 'returnServiceEditsOption' is set to 'original-and-current-features'");
const e={...b};e.addFeatures=b&&n.isCollection(b.addFeatures)?b.addFeatures.toArray():e.addFeatures||[];e.updateFeatures=b&&n.isCollection(b.updateFeatures)?b.updateFeatures.toArray():e.updateFeatures||[];e.deleteFeatures=b&&n.isCollection(b.deleteFeatures)?b.deleteFeatures.toArray():e.deleteFeatures||[];if(e.addFeatures.length&&!d.operations.supportsAdd)throw new f(`${a.type}-layer:unsupported-operation`,"Layer does not support adding features.");if(e.updateFeatures.length&&!d.operations.supportsUpdate)throw new f(`${a.type}-layer:unsupported-operation`,
"Layer does not support updating features.");if(e.deleteFeatures.length&&!d.operations.supportsDelete)throw new f(`${a.type}-layer:unsupported-operation`,"Layer does not support deleting features.");e.addAttachments=e.addAttachments||[];e.updateAttachments=e.updateAttachments||[];e.deleteAttachments=e.deleteAttachments||[];e.addFeatures=e.addFeatures.map(x);e.updateFeatures=e.updateFeatures.map(x);e.addAssetFeatures=[];const l=g?.globalIdUsed||h;e.addFeatures.forEach(k=>{q(k,a,l);y(k,a)});e.updateFeatures.forEach(k=>
{q(k,a,l);y(k,a);const r=p.getEffectiveLayerCapabilities(a);if("geometry"in k&&null!=k.geometry&&!r?.editing.supportsGeometryUpdate)throw new f(`${a.type}-layer:unsupported-operation`,"Layer does not support geometry updates.");});e.deleteFeatures.forEach(k=>{q(k,a,l)});e.addAttachments.forEach(k=>z(k,a));e.updateAttachments.forEach(k=>z(k,a));h&&await I(e,a);return{edits:await J(e),options:c}}function q(a,b,g){if(g){if("attributes"in a&&!a.attributes[b.globalIdField])throw new f(`${b.type}-layer:invalid-parameter`,
"Feature should have 'globalId' when 'globalIdUsed' is true");if(!("attributes"in a||a.globalId))throw new f(`${b.type}-layer:invalid-parameter`,"'globalId' of the feature should be passed when 'globalIdUsed' is true");}if("geometry"in a&&null!=a.geometry){if(a.geometry.hasZ&&!1===b.capabilities?.data.supportsZ)throw new f(`${b.type}-layer:z-unsupported`,"Layer does not support z values while feature has z values.");if(a.geometry.hasM&&!1===b.capabilities?.data.supportsM)throw new f(`${b.type}-layer:m-unsupported`,
"Layer does not support m values while feature has m values.");}}function y(a,b){if("geometry"in a&&"mesh"===a.geometry?.type&&({geometry:a}=a,a.vertexSpace.isGeoreferenced))throw new f(`${b.type}-layer:georeferenced-mesh-unsupported`,"Uploading georeferenced meshes to a layer is not supported.");}function z(a,b){const {feature:g,attachment:d}=a;if(!g||"attributes"in g&&!g.attributes[b.globalIdField])throw new f(`${b.type}-layer:invalid-parameter`,"Attachment should have reference to a feature with 'globalId'");
if(!("attributes"in g||g.globalId))throw new f(`${b.type}-layer:invalid-parameter`,"Attachment should have reference to 'globalId' of the parent feature");if(!d.globalId)throw new f(`${b.type}-layer:invalid-parameter`,"Attachment should have 'globalId'");if(!d.data&&!d.uploadId)throw new f(`${b.type}-layer:invalid-parameter`,"Attachment should have 'data' or 'uploadId'");if(!(d.data instanceof File&&d.data.name||d.name))throw new f(`${b.type}-layer:invalid-parameter`,"'name' is required when attachment is specified as Base64 encoded string using 'data'");
if(!b.capabilities?.editing.supportsUploadWithItemId&&d.uploadId)throw new f(`${b.type}-layer:invalid-parameter`,"This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'");if("string"===typeof d.data&&(a=E.dataComponents(d.data))&&!a.isBase64)throw new f(`${b.type}-layer:invalid-parameter`,"Attachment 'data' should be a Blob, File or Base64 encoded string");}async function J(a){const b=a.addFeatures??[],g=a.updateFeatures??[];var d=b.concat(g).map(e=>
e.geometry);d=await F.normalizeCentralMeridian(d);const c=b.length,h=g.length;d.slice(0,c).forEach((e,l)=>b[l].geometry=e);d.slice(c,c+h).forEach((e,l)=>g[l].geometry=e);return a}function x(a){const b=new A;a.attributes||(a.attributes={});b.geometry=a.geometry;b.attributes=a.attributes;return b}async function I(a,b){if(null!=b.infoFor3D){var {infoFor3D:g}=b,d=u.getMimeTypeFormatId("model/gltf-binary",g.supportedFormats)??u.getFilenameFormatId("glb",g.supportedFormats);if(!d||!g.editFormats.includes(d))throw new f(`${b.type}-layer:binary-gltf-asset-not-supported`,
"3DObjectFeatureLayer requires binary glTF (.glb) support for updating mesh geometry.");a.addAssetFeatures??(a.addAssetFeatures=[]);({addAssetFeatures:b}=a);for(const c of a.addFeatures??[])"mesh"===c?.geometry?.type&&b.push(c);for(const c of a.updateFeatures??[])"mesh"===c?.geometry?.type&&b.push(c)}}m.applyEdits=async function(a,b,g,d={}){let c;t.isEditBusLayer(a)&&a.url?c=t.emitApplyEditsEvent(a.url,a.layerId,"original-and-current-features"===d.returnServiceEditsOption):(c=D.createResolver(),c.promise.then(h=>
{(h.addedFeatures.length||h.updatedFeatures.length||h.deletedFeatures.length||h.addedAttachments.length||h.updatedAttachments.length||h.deletedAttachments.length)&&a.emit("edits",h)}),a.emit("apply-edits",{result:c.promise}));try{const {results:h,edits:e}=await G(a,b,g,d);b=k=>k.filter(r=>!r.error).map(B.clone);const l={edits:e,addedFeatures:b(h.addFeatureResults),updatedFeatures:b(h.updateFeatureResults),deletedFeatures:b(h.deleteFeatureResults),addedAttachments:b(h.addAttachmentResults),updatedAttachments:b(h.updateAttachmentResults),
deletedAttachments:b(h.deleteAttachmentResults),exceededTransferLimit:!1};h.editedFeatureResults?.length&&(l.editedFeatures=h.editedFeatureResults);c.resolve(l);return h}catch(h){throw c.reject(h),h;}};m.isFeatureIdentifierArrayWithGlobalId=function(a){return a.every(w)};m.isFeatureIdentifierArrayWithObjectId=function(a){return a.every(v)};m.isFeatureIdentifierWithGlobalId=w;m.isFeatureIdentifierWithObjectId=v;m.uploadAssets=function(a,b,g,d){if(!b||null==b.applyEdits)throw new f(`${a.type}-layer:no-editing-support`,
"Layer source does not support applyEdits capability",{layer:a});if(!b.uploadAssets)throw new f(`${a.type}-layer:no-asset-upload-support`,"Layer source does not support uploadAssets capability",{layer:a});return b.uploadAssets(g,d)};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
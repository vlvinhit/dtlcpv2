// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Collection ../core/Error ../core/HandleOwner ../core/loadAll ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/PropertyOrigin ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/Subtype ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query".split(" "),
function(A,p,f,u,q,e,B,C,w,x,D,y,g,r,aa,ba,E,F,v,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,h,U,V,W,t,X,Y,Z){function z(k,l){return new q("layer:unsupported",`Layer (${k.title}, ${k.id}) of type '${k.declaredClass}' ${l}`,{layer:k})}r=U.defineFieldProperties();e=function(k){function l(...a){var b=k.call(this,...a)||this;b._sublayersCollectionChanged=!1;b._sublayerLookup=new Map;b.fields=null;b.fieldsIndex=null;b.outFields=null;b.subtypes=null;b.sublayers=new (u.ofType(t));b.timeInfo=null;b.title="Layer";b.type=
"subtype-group";b.addHandles(x.watch(()=>b.sublayers,(d,m)=>b._handleSublayersChange(d,m),x.sync));return b}p._inherits(l,k);var c=l.prototype;c.destroy=function(){this.source?.destroy()};c.normalizeCtorArgs=function(a,b){return"string"===typeof a?{url:a,...b}:a};c.load=function(a){const b=null!=a?a.signal:null,d=this.loadFromPortal({supportedTypes:["Feature Service"]},a).catch(w.throwIfAbortError).then(async()=>{if(!this.url)throw new q("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");
if(null==this.layerId)throw new q("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return this._initLayerProperties(await this.createGraphicsSource(b))}).then(()=>this._setUserPrivileges(this.serviceItemId,a)).then(()=>h.ensureLayerCredential(this,a));this.addResolvingPromise(d);return Promise.resolve(this)};c.readTitleFromService=function(a,{name:b}){return this.url?S.titleFromUrlAndName(this.url,b):b};c.addAttachment=async function(a,b){return h.addAttachment(this,
a,b,"SubtypeGroupLayer")};c.updateAttachment=async function(a,b,d){return h.updateAttachment(this,a,b,d,"SubtypeGroupLayer")};c.applyEdits=async function(a,b){return h.applyEdits(this,a,b)};c.on=function(a,b){return p._get(p._getPrototypeOf(l.prototype),"on",this).call(this,a,b)};c.createGraphicsSource=async function(a){const {default:b}=await w.whenOrAbort(new Promise((d,m)=>A(["./graphics/sources/FeatureLayerSource"],n=>d(Object.freeze(Object.defineProperty({__proto__:null,default:n},Symbol.toStringTag,
{value:"Module"}))),m)),a);return(new b({layer:this})).load({signal:a})};c.createQuery=function(){const a=h.createQuery(this),b=this.sublayers.map(d=>d.subtypeCode);a.where=D.sqlAnd(`${this.subtypeField} IN (${b.join(",")})`,this.definitionExpression);return a};c.deleteAttachments=async function(a,b){return h.deleteAttachments(this,a,b,"SubtypeGroupLayer")};c.fetchRecomputedExtents=async function(a){return h.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")};c.findSublayerForFeature=function(a){const b=
this.fieldsIndex.get(this.subtypeField);return this.findSublayerForSubtypeCode(a.attributes[b.name])};c.findSublayerForSubtypeCode=function(a){return this._sublayerLookup.get(a)};c.getFieldDomain=function(a,b){return this._getLayerDomain(a)};c.getField=function(a){return this.fieldsIndex.get(a)};c.loadAll=function(){return B.loadAll(this,a=>{a(this.sublayers)})};c.queryAttachments=async function(a,b){return h.queryAttachments(this,a,b,"SubtypeGroupLayer")};c.queryFeatures=async function(a,b){const d=
await this.load();a=Z.from(a)??d.createQuery();const m=a.outFields??[];m.includes(this.subtypeField)||(m.push(this.subtypeField),a.outFields=m);b=await d.source.queryFeatures(a,b);if(b?.features)for(const n of b.features)n.layer=n.sourceLayer=this.findSublayerForFeature(n);return b};c.queryObjectIds=async function(a,b){return h.queryObjectIds(this,a,b,"SubtypeGroupLayer")};c.queryFeatureCount=async function(a,b){return h.queryFeatureCount(this,a,b,"SubtypeGroupLayer")};c.queryExtent=async function(a,
b){return h.queryExtent(this,a,b,"SubtypeGroupLayer")};c.queryRelatedFeatures=async function(a,b){return h.queryRelatedFeatures(this,a,b,"SubtypeGroupLayer")};c.queryRelatedFeaturesCount=async function(a,b){return h.queryRelatedFeaturesCount(this,a,b,"SubtypeGroupLayer")};c.write=function(a,b){const {origin:d,layerContainerType:m,messages:n}=b;if(this.isTable){if("web-scene"===d||"web-map"===d&&"tables"!==m)return n?.push(z(this,"using a table source cannot be written to web scenes and web maps")),
null}else if(this.loaded&&"web-map"===d&&"tables"===m)return n?.push(z(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?p._get(p._getPrototypeOf(l.prototype),"write",this).call(this,a,b):(n?.push(new q("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)};c.serviceSupportsSpatialReference=
function(a){return this.loaded?Y.serviceSupportsSpatialReference(this,a):!1};c._getLayerDomain=function(a){return(a=this.fieldsIndex.get(a))?a.domain:null};c._initLayerProperties=async function(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=a,this.read(a,{origin:"service",url:this.parsedUrl}));if(this.isTable)throw new q("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new q("subtype-grouplayer:missing-subtypes",
"SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();V.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)};c.hasDataChanged=async function(){return h.hasDataChanged(this)};c._verifyFields=function(){const a=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+a+")");this.isTable||-1!==a.search(/\/FeatureServer\//i)||this.fields?.some(b=>"geometry"===b.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+
a+")")};c._handleSublayersChange=function(a,b){b&&(b.forEach(d=>{d.parent=null}),this.handles.remove("sublayers-owner"),this._sublayerLookup.clear());a&&(a.forEach(d=>{d.parent=this;this._sublayerLookup.set(d.subtypeCode,d)}),this._sublayersCollectionChanged=!1,this.handles.add([a.on("after-add",({item:d})=>{d.parent=this;this._sublayerLookup.set(d.subtypeCode,d)}),a.on("after-remove",({item:d})=>{d.parent=null;this._sublayerLookup.delete(d.subtypeCode)}),a.on("after-changes",()=>{this._sublayersCollectionChanged=
!0})],"sublayers-owner"))};p._createClass(l,[{key:"createQueryVersion",get:function(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");this.commitProperty("capabilities");this.commitProperty("returnM");return(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&
null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"effectiveEditingEnabled",get:function(){return h.computeEffectiveEditingEnabled(this)}},{key:"parsedUrl",get:function(){const a=y.urlToObject(this.url);null!=a&&null!=this.layerId&&(a.path=y.join(a.path,this.layerId.toString()));return a}},{key:"source",set:function(a){this._get("source")!==a&&this._set("source",a)}}]);return l}(M.FeatureLayerBase(L.EditBusLayer(J.BlendLayer(R.TemporalLayer(Q.ScaleRangeLayer(P.RefreshableLayer(I.ArcGISService(N.OperationalLayer(O.PortalLayer(C.MultiOriginJSONMixin(K.CustomParametersMixin(H.APIKeyMixin(e.HandleOwnerMixin(G))))))))))))));
f.__decorate([g.property({readOnly:!0})],e.prototype,"createQueryVersion",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"editingEnabled",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"effectiveEditingEnabled",null);f.__decorate([g.property({...r.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"fields",void 0);f.__decorate([g.property(r.fieldsIndex)],e.prototype,"fieldsIndex",void 0);f.__decorate([g.property(T.id)],e.prototype,"id",void 0);f.__decorate([g.property({type:["show",
"hide","hide-children"]})],e.prototype,"listMode",void 0);f.__decorate([g.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],e.prototype,"operationalLayerType",void 0);f.__decorate([g.property(r.outFields)],e.prototype,"outFields",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"parsedUrl",null);f.__decorate([g.property()],e.prototype,"source",null);f.__decorate([g.property({type:[W],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"subtypes",void 0);
f.__decorate([g.property({type:u.ofType(t),json:{origins:{service:{read:{source:"subtypes",reader:(k,l,c)=>{k=k.map(({code:a})=>{a=new t({subtypeCode:a});a.read(l,c);return a});return new (u.ofType(t))(k)}}}},name:"layers",write:{overridePolicy(k,l,c){l=this.originOf("sublayers");const a=v.OriginId.PORTAL_ITEM;let b=!0;v.nameToId(l)===a&&v.nameToId(c.origin)>a&&(k=k.some(d=>d.hasUserOverrides()),b=this._sublayersCollectionChanged||k);return{enabled:b,ignoreOrigin:!0}}}}})],e.prototype,"sublayers",
void 0);f.__decorate([g.property({type:X})],e.prototype,"timeInfo",void 0);f.__decorate([g.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],e.prototype,"title",void 0);f.__decorate([E.reader("service","title",["name"])],e.prototype,"readTitleFromService",null);f.__decorate([g.property({json:{read:!1}})],e.prototype,"type",void 0);return e=f.__decorate([F.subclass("esri.layers.SubtypeGroupLayer")],e)});
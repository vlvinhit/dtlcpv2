// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/MapUtils ../../core/promiseUtils ../../core/urlUtils ../../core/Version ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/PropertyOrigin ../../geometry/Extent ../../geometry/SpatialReference ../support/arcgisLayerUrl ../support/commonProperties ../../portal/support/portalItemUtils".split(" "),
function(p,q,f,r,B,t,u,C,h,M,N,O,v,D,w,E,F,G,x,y){p.ArcGISMapService=e=>{e=function(z){function n(){var a=z.apply(this,arguments)||this;a.capabilities=void 0;a.copyright=null;a.fullExtent=null;a.legendEnabled=!0;a.spatialReference=null;a.version=void 0;a._allLayersAndTablesMap=null;return a}q._inherits(n,z);var k=n.prototype;k.readCapabilities=function(a,b){var d=b.capabilities&&b.capabilities.split(",").map(H=>H.toLowerCase().trim());if(!d)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,
supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};var c=this.type;a="tile"!==c&&!!b.supportsDynamicLayers;const g=d.includes("query"),l=d.includes("map"),A=!!b.exportTilesAllowed,I=d.includes("tilemap");d=d.includes("data");const J="tile"!==c&&(!b.tileInfo||a),K="tile"!==c&&(!b.tileInfo||a);c="tile"!==c;var m=b.cimVersion&&C.Version.parse(b.cimVersion);const L=m?.since(1,4)??!1;m=m?.since(2,0)??!1;return{operations:{supportsExportMap:l,supportsExportTiles:A,
supportsIdentify:g,supportsQuery:d,supportsTileMap:I},exportMap:l?{supportsArcadeExpressionForLabeling:L,supportsSublayersChanges:c,supportsDynamicLayers:a,supportsSublayerVisibility:J,supportsSublayerDefinitionExpression:K,supportsCIMSymbols:m}:null,exportTiles:A?{maxExportTilesCount:+b.maxExportTilesCount}:null}};k.readVersion=function(a,b){(a=b.currentVersion)||(a=b.hasOwnProperty("capabilities")||b.hasOwnProperty("tables")?10:b.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3);return a};k.fetchRelatedService=
async function(a){var b=this.portalItem;if(!b||!y.isHostedLayer(b))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=b.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},a).then(d=>d.find(c=>"Feature Service"===c.type)??null,()=>null));b=await this._relatedFeatureServicePromise;t.throwIfAborted(a);return b?{itemId:b.id,url:b.url}:null};k.fetchSublayerInfo=async function(a,b){const {source:d}=a;if(this?.portalItem&&"tile"===this.type&&"map-layer"===
d?.type&&y.isHostedLayer(this.portalItem)&&a.originIdOf("url")<w.OriginId.SERVICE){var c=await this.fetchRelatedService(b);c&&(a.url=u.join(c.url,d.mapLayerId.toString()),a.layerItemId=c.itemId)}({url:c}=a);let g;if("data-layer"===d.type)g=(await r(c,{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey},...b})).data;else if(c&&a.originIdOf("url")>w.OriginId.SERVICE)try{g=(await this._fetchAllLayersAndTablesFromService(c)).get(d.mapLayerId)}catch{}else{a=a.id;"map-layer"===
d?.type&&(a=d.mapLayerId);try{g=(await this.fetchAllLayersAndTables(b)).get(a)}catch{}}return g};k.fetchAllLayersAndTables=async function(a){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,a)};k._fetchAllLayersAndTablesFromService=async function(a,b){await this.load(b);this._allLayersAndTablesMap||(this._allLayersAndTablesMap=new Map);const d=G.parse(a);a=await B.getOrCreateMapValue(this._allLayersAndTablesMap,d?.url.path,()=>r(u.join(d?.url.path,"/layers"),{responseType:"json",
query:{f:"json",...this.customParameters,token:this.apiKey}}).then(c=>{const g=new Map;for(const l of c.data.layers)g.set(l.id,l);return{result:g}},c=>({error:c})));t.throwIfAborted(b);if("result"in a)return a.result;throw a.error;};return q._createClass(n)}(e);f.__decorate([h.property({readOnly:!0})],e.prototype,"capabilities",void 0);f.__decorate([v.reader("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],e.prototype,"readCapabilities",
null);f.__decorate([h.property({json:{read:{source:"copyrightText"}}})],e.prototype,"copyright",void 0);f.__decorate([h.property({type:E})],e.prototype,"fullExtent",void 0);f.__decorate([h.property(x.id)],e.prototype,"id",void 0);f.__decorate([h.property({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],e.prototype,"legendEnabled",void 0);f.__decorate([h.property(x.popupEnabled)],e.prototype,"popupEnabled",void 0);f.__decorate([h.property({type:F})],
e.prototype,"spatialReference",void 0);f.__decorate([h.property({readOnly:!0})],e.prototype,"version",void 0);f.__decorate([v.reader("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],e.prototype,"readVersion",null);return e=f.__decorate([D.subclass("esri.layers.mixins.ArcGISMapService")],e)};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../config ../../kernel ../../request ../../core/asyncUtils ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../support/layerUtils ../../portal/Portal ../../portal/PortalItem ../../portal/PortalUser ../../portal/support/portalItemUtils".split(" "),
function(B,u,m,h,C,r,D,E,F,G,H,k,q,p,N,O,P,I,J,K,L,v,t,M,w){var x=null,y=null;u.PortalLayer=e=>{e=function(z){function n(){var a=z.apply(this,arguments)||this;a.resourceReferences={portalItem:null,paths:[]};a.userHasEditingPrivileges=!0;a.userHasFullEditingPrivileges=!1;a.userHasUpdateItemPrivileges=!1;return a}m._inherits(n,z);var d=n.prototype;d.destroy=function(){this.portalItem=H.destroyMaybe(this.portalItem);this.resourceReferences.portalItem=null;this.resourceReferences.paths.length=0};d.readPortalItem=
function(a,b,c){if(b.itemId)return new t({id:b.itemId,portal:c&&c.portal})};d.writePortalItem=function(a,b){a&&a.id&&(b.itemId=a.id)};d.loadFromPortal=async function(a,b){if(this.portalItem&&this.portalItem.id)try{const {load:c}=await new Promise((f,g)=>B(["../../portal/support/layersLoader"],f,g));k.throwIfAborted(b);return await c({instance:this,supportedTypes:a.supportedTypes,validateItem:a.validateItem,supportsData:a.supportsData,layerModuleTypeMap:a.layerModuleTypeMap},b)}catch(c){throw k.isAbortError(c)||
G.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${c}`),c;}};d.finishLoadEditablePortalLayer=async function(a){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(a).catch(b=>{k.throwIfAbortError(b);return!0}))};d._setUserPrivileges=async function(a,b){if(!C.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(b);if(this.url)try{const {features:{edit:c,fullEdit:f},content:{updateItem:g}}=await this._fetchUserPrivileges(a,
b);this._set("userHasEditingPrivileges",c);this._set("userHasFullEditingPrivileges",f);this._set("userHasUpdateItemPrivileges",g)}catch(c){k.throwIfAbortError(c)}};d._fetchUserPrivileges=async function(a,b){let c=this.portalItem;if(!a||!c||!c.loaded||c.sourceUrl)return this._fetchFallbackUserPrivileges(b);const f=a===c.id;if(f&&c.portal.user)return w.getUserPrivileges(c);let g;if(f)g=c.portal.url;else try{g=await L.getOwningPortalUrl(this.url,b)}catch(l){k.throwIfAbortError(l)}if(!g||!q.hasSameCanonicalPortal(g,
c.portal.url))return this._fetchFallbackUserPrivileges(b);let A;try{const l=null!=b?b.signal:null;A=await r.id?.getCredential(`${g}/sharing`,{prompt:!1,signal:l})}catch(l){k.throwIfAbortError(l)}if(!A)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(f?await c.reload():(c=new t({id:a,portal:{url:g}}),await c.load(b)),c.portal.user)return w.getUserPrivileges(c)}catch(l){k.throwIfAbortError(l)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}};d._fetchFallbackUserPrivileges=
async function(a){let b=!0;try{b=await this._fetchUserHasEditingPrivileges(a)}catch(c){k.throwIfAbortError(c)}return{features:{edit:b,fullEdit:!1},content:{updateItem:!1}}};d._fetchUserHasEditingPrivileges=async function(a){const b=this.url?r.id?.findCredential(this.url):null;if(!b)return!0;a=x===b?y:await this._fetchEditingUser(a);x=b;y=a;return null==a||null==a.privileges||a.privileges.includes("features:user:edit")};d._fetchEditingUser=async function(a){var b=this.portalItem?.portal?.user;if(b)return b;
b=r.id.findServerInfo(this.url??"");if(!b?.owningSystemUrl)return null;b=`${b.owningSystemUrl}/sharing/rest`;const c=v.getDefault();if(c&&c.loaded&&q.normalize(c.restUrl)===q.normalize(b))return c.user;a=await E.result(D(`${b}/community/self`,{authMode:"no-prompt",query:{f:"json"},signal:null!=a?a.signal:null}));return a.ok?M.fromJSON(a.value.data):null};d.read=function(a,b){b&&(b.layer=this);m._get(m._getPrototypeOf(n.prototype),"read",this).call(this,a,b)};d.write=function(a,b){const c=b&&b.portal,
f=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||v.getDefault());return c&&f&&!q.hasSamePortal(f.restUrl,c.restUrl)?(b.messages&&b.messages.push(new F("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):m._get(m._getPrototypeOf(n.prototype),"write",this).call(this,
a,{...b,layer:this})};m._createClass(n,[{key:"portalItem",set:function(a){a!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",a))}}]);return n}(e);h.__decorate([p.property({type:t})],e.prototype,"portalItem",null);h.__decorate([I.reader("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null);h.__decorate([K.writer("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null);h.__decorate([p.property({clonable:!1})],e.prototype,
"resourceReferences",void 0);h.__decorate([p.property({type:Boolean,readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0);h.__decorate([p.property({type:Boolean,readOnly:!0})],e.prototype,"userHasFullEditingPrivileges",void 0);h.__decorate([p.property({type:Boolean,readOnly:!0})],e.prototype,"userHasUpdateItemPrivileges",void 0);return e=h.__decorate([J.subclass("esri.layers.mixins.PortalLayer")],e)};Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../geometry ../../PopupTemplate ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../renderers/support/types ../../core/workers/workers ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/projection ../../geometry/support/spatialReferenceUtils ../Layer ../graphics/data/FeatureStore ../graphics/data/QueryEngine ../graphics/sources/support/clientSideDefaults ./KnowledgeGraphLayerDataManager ./KnowledgeGraphSublayerBase ../mixins/BlendLayer ../mixins/FeatureReductionLayer ../mixins/RefreshableLayer ../mixins/ScaleRangeLayer ../support/Field ../support/fieldUtils ../../rest/support/FeatureSet ../../rest/support/Query ../../support/popupUtils ../../geometry/Extent ../../geometry/Polygon ../../geometry/Polyline ../../core/workers/RemoteClient ../../geometry/support/typeUtils".split(" "),
function(v,e,d,z,R,S,T,U,V,W,X,Y,t,A,Z,f,aa,ba,ca,B,n,p,C,D,E,q,u,F,G,H,I,J,w,K,L,m,M,x,N,O,P,l){d=function(y){function r(b){var a=y.call(this,b)||this;a.capabilities=q.createCapabilities(!1,!1);a.definitionExpression="";a.displayField="";a.elevationInfo=null;a.geometryType=null;a.geometryFieldName=null;a.graphType=null;a.hasM=!1;a.hasZ=!1;a.labelsVisible=null;a.labelingInfo=null;a.objectIdField=u.MOCK_OID_FIELD_NAME;a.objectType=null;a.parentCompositeLayer=null;a.popupTemplate=null;a.source={openPorts:()=>
a.load().then(()=>{const g=new MessageChannel;new P(g.port1,{channel:g,client:{queryFeatures:(k,Q={})=>{k=m.fromJSON(k);return a.queryFeaturesJSON(k,Q)}}},()=>null);return[g.port2]})};a.type="knowledge-graph-sublayer";if("link-chart"===b.parentCompositeLayer.type)a.geometryType="relationship"===b.graphType?"polyline":"point",a.geometryFieldName=u.MOCK_LAYOUT_GEOMETRY_FIELD_NAME;else if(b.parentCompositeLayer.dataManager.geographicLookup.get(b.objectType.name)?.geometryType&&"esriGeometryNull"!==b.parentCompositeLayer.dataManager.geographicLookup.get(b.objectType.name)?.geometryType){var c=
b.parentCompositeLayer.dataManager.geographicLookup.get(b.objectType.name);a.geometryFieldName=c?.name??null;a.geometryType=c?.geometryType?l.featureGeometryTypeKebabDictionary.fromJSON(c.geometryType):null;(c=(c=c?.name)?b.objectType.properties?.[c]:null)?(a.hasM=c.hasM??!1,a.hasZ=c.hasZ??!1):(a.hasM=!1,a.hasZ=!1)}else a.geometryType=null;b.objectType.properties?.forEach(g=>{let k=g.fieldType;"esriFieldTypeOID"===k&&(k="esriFieldTypeInteger");a.fields.push(w.fromJSON({name:g.name,type:k,alias:g.alias,
defaultValue:null,editable:g.editable,nullable:g.nullable}))});a.fields.push(w.fromJSON({name:a.objectIdField,type:"esriFieldTypeString",alias:a.objectIdField,editable:!1}));a._set("fields",[...a.fields]);b.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(a.spatialReference=b.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference);a.renderer="link-chart"===b.parentCompositeLayer.type?"relationship"===b.graphType?t.fromJSON(q.createDrawingInfo(l.featureGeometryTypeKebabDictionary.toJSON("polyline")).renderer):
t.fromJSON(q.createDrawingInfo(l.featureGeometryTypeKebabDictionary.toJSON("point")).renderer):t.fromJSON(q.createDrawingInfo(l.featureGeometryTypeKebabDictionary.toJSON(a.geometryType)).renderer);return a}v._inherits(r,y);var h=r.prototype;h.createPopupTemplate=function(b){return M.createPopupTemplate(this,b)};h.createQuery=function(){return new m({where:"1\x3d1",outFields:["*"]})};h.getField=function(b){for(let a=0;a<this.fields.length;a++)if(this.fields[a].name===b)return this.fields[a];throw Error("Field not found");
};h.getFieldDomain=function(b,a){return null};h.queryFeatures=async function(b,a){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects(b);b=L.fromJSON(await g.executeQuery(c.toJSON(),a?.signal));b.features.forEach(k=>{k.sourceLayer=this});return b};h.queryFeaturesJSON=async function(b,a){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects(b);return await g.executeQuery(c.toJSON(),a?.signal)};h.queryFeatureCount=async function(b,a){const {resolvedQuery:c,queryEngine:g}=
await this._setupQueryObjects(b);return g.executeQueryForCount(c.toJSON(),a?.signal)};h.queryExtent=async function(b={},a){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects({...b,returnGeometry:!0});b=await g.executeQueryForExtent(c.toJSON(),a?.signal);a=null!=b.extent?.xmin&&null!=b.extent?.xmax&&null!=b.extent?.ymin&&null!=b.extent?.ymax?new x(b.extent):new x;return{count:b.count,extent:a}};h.queryObjectIds=async function(b,a){b=m.from(b);if("link-chart"===this.parentCompositeLayer.type&&
this._cachedQueryEngine)var c=this._cachedQueryEngine;else c=await this.parentCompositeLayer.dataManager.getData(b,this,a),c=this.loadQueryEngine(c);return c.executeQueryForIds(b.toJSON(),a?.signal)};h.loadQueryEngine=function(b){var a=new D({geometryType:l.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ});a=new E.QueryEngine({fields:this.fields.map(c=>c.toJSON()),geometryType:l.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,
hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:a});a.featureStore.addMany(b);return a};h.refreshCachedQueryEngine=async function(){const b=await this.parentCompositeLayer.dataManager.getData(new m({where:"1\x3d1",outFields:[u.MOCK_OID_FIELD_NAME]}),this);this._cachedQueryEngine=this.loadQueryEngine(b)};h._setupQueryObjects=async function(b,a){b=m.from(b);const c=b.geometry;c&&!c.spatialReference?.isWGS84&&(await n.initializeProjection(c.spatialReference,
p.WGS84),b.geometry=c instanceof N?n.project(c,p.WGS84):c instanceof O?n.project(c,p.WGS84):n.project(c.extent,p.WGS84));"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine?a=this._cachedQueryEngine:(a=await this.parentCompositeLayer.dataManager.getData(b,this,a),a=this.loadQueryEngine(a));return{resolvedQuery:b,queryEngine:a}};v._createClass(r,[{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"renderer",set:function(b){K.fixRendererFields(b,this.fieldsIndex);
this._set("renderer",b)}}]);return r}(H.FeatureReductionLayer(F.KnowledgeGraphSublayerBase(G.BlendLayer(J.ScaleRangeLayer(I.RefreshableLayer(C))))));e.__decorate([f.property()],d.prototype,"capabilities",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);e.__decorate([f.property()],d.prototype,"definitionExpression",void 0);e.__decorate([f.property()],d.prototype,"displayField",void 0);e.__decorate([f.property()],d.prototype,"elevationInfo",void 0);e.__decorate([f.property()],
d.prototype,"geometryType",void 0);e.__decorate([f.property()],d.prototype,"geometryFieldName",void 0);e.__decorate([f.property()],d.prototype,"graphType",void 0);e.__decorate([f.property()],d.prototype,"hasM",void 0);e.__decorate([f.property()],d.prototype,"hasZ",void 0);e.__decorate([f.property()],d.prototype,"labelsVisible",void 0);e.__decorate([f.property()],d.prototype,"labelingInfo",void 0);e.__decorate([f.property()],d.prototype,"objectIdField",void 0);e.__decorate([f.property()],d.prototype,
"objectType",void 0);e.__decorate([f.property()],d.prototype,"parentCompositeLayer",void 0);e.__decorate([f.property({type:z,json:{name:"popupInfo",write:!0}})],d.prototype,"popupTemplate",void 0);e.__decorate([f.property({types:A.rendererTypes,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],d.prototype,"renderer",null);e.__decorate([f.property()],d.prototype,"source",void 0);e.__decorate([f.property({json:{read:!1}})],d.prototype,"type",void 0);return d=e.__decorate([B.subclass("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],
d)});
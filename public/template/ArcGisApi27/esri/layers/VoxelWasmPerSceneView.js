// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../Graphic ../request ../core/has ../core/Logger ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../chunks/vec3 ../chunks/vec3f64 ../geometry/support/coordinateSystem ../geometry/support/frustum ../libs/vxl/enums ../libs/vxl/VxlModule ../views/ViewingMode ../views/3d/layers/i3s/Intersector ../views/3d/state/Frustum ../views/3d/support/RenderCoordsHelper ../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput ../views/3d/webgl-engine/lib/Intersector ../views/3d/webgl-engine/lib/IntersectorInterfaces ../views/3d/webgl-engine/lib/RenderFeature ../views/3d/webgl-engine/lib/RenderSlot ../views/webgl/contextUtils ../views/webgl/enums".split(" "),
function(E,F,G,C,H,A,I,B,J,K,L,u,t,M,N,O,P,Q,R,S,D,T,U,V,x){const y=H.getLogger("esri.layers.VoxelWasmPerSceneView");var g;(function(w){w[w.Lifetime=1]="Lifetime";w[w.RequestResponse=2]="RequestResponse";w[w.Rendering=3]="Rendering";w[w.Error=4]="Error"})(g||(g={}));return function(){function w(a){this._havePreparedWithAllLayers=this._textureFloatLinearAvailable=this._halfIntTexturesAvailable=!1;this._vxl=this._vxlPromise=this._renderPluginContext=this._timeExtentWatchHandle=this._stationaryWatchHandle=
this._qualityWatchHandle=this._readyWatchHandle=null;this._moreToLoad=this._pluginIsActive=!1;this._viewportHeight=this._viewportWidth=-1;this._newLayers=[];this._layers=new Map;this._shaderOutput=R.ShaderOutput.Color;this._renderSlot=U.RenderSlot.VOXEL;this._renderTargetToRestore=this._rctx=null;this._lastFrameWasStationary=!1;this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536];this._wasmMemBlocks=new Map;this._dbgFlags=new Set;this._captureFrustum=!1;this._frustum=null;this._frustumRenderableId=
-1;this._renderCoordsHelper=null;this.type=D.IntersectorType.VOXEL;this.slicePlaneEnabled=!0;this.isGround=!1;this.layerUid=[];this._view=a;this._initialize()}var e=w.prototype;e._dbg=function(a,b){this._dbgFlags.has(a)&&(a===g.Error?y.error(b):y.warn(b))};e._removeRenderPlugin=function(){this._pluginIsActive&&this._view._stage&&(this._dbg(g.Lifetime,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this));this._pluginIsActive=!1};e._initialize=function(){this._dbg(g.Lifetime,"--initialize--");
for(const a of this._wasmMemBlockSizes)this._wasmMemBlocks.set(a,0);this._readyWatchHandle=B.watch(()=>this._view.ready,a=>{a&&"local"===this._view.viewingMode?(this._dbg(g.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(g.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},{initial:!0});this._qualityWatchHandle=B.watch(()=>
this._view?.qualityProfile,a=>{this._dbg(g.Rendering,"qualityProfile changed to "+a);this._vxl&&this._vxl.set_quality(this._toWasmQuality(a))},{initial:!0});this._timeExtentWatchHandle=B.watch(()=>this._view?.timeExtent,()=>{if(this._vxl){const a=this._getTimeArgs(this._view?.timeExtent);this._dbg(g.Rendering,"sceneView timeExtent changed to useTime\x3d"+a.useTime+" st\x3d"+a.startTime+" et\x3d"+a.endTime);this._vxl.set_scene_time_extent(a.startTime,a.endTime,a.useTime);this._renderPluginContext.requestRender()}},
{initial:!0});this._stationaryWatchHandle=B.watch(()=>this._view?.stationary,a=>{this._vxl&&a&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})};e.initializeRenderContext=function(a){this._dbg(g.Lifetime,"--initializeRenderContext--");const b=a.renderContext.rctx;b.type===V.ContextType.WEBGL2?(this._renderPluginContext=a,this._rctx=a.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear,
this._initializeWasm(b.gl)):this._dbg(g.Error,"WebGL 1 context only!")};e.uninitializeRenderContext=function(){this._rctx=this._renderPluginContext=null;this._dbg(g.Lifetime,"--uninitializeRenderContext--")};e._restoreFramebuffer=function(){if(this._renderTargetToRestore){var a=this._renderTargetToRestore.fbo;this._rctx?(this._rctx.bindFramebuffer(a,!0),a=this._renderTargetToRestore.viewport,this._rctx.setViewport(a.x,a.y,a.width,a.height)):this._dbg(g.Error,"no context in restoreFramebuffer!")}};
e._bindPreviousDepthToSlot=function(a,b){var c=!!this._renderTargetToRestore;if(!this._rctx||!c)return 0;c=this._renderTargetToRestore.fbo.depthStencilTexture;if(!c)return this._dbg(g.Error,"no depth/stencil texture exists!"),0;0===b?this._rctx.bindTexture(null,a,!0):this._rctx.bindTexture(c,a,!0);return 1};e._modifyResourceCount=function(a,b,c){this._rctx?1===c?this._rctx.instanceCounter.increment(a,b):this._rctx.instanceCounter.decrement(a,b):this._dbg(g.Error,"modifyAllocation callback has no rendering context!")};
e._setBlendState=function(a,b,c,d){this._rctx?(this._rctx.setBlendingEnabled(1===a),this._rctx.setBlendFunction(b,c),this._rctx.setBlendEquation(d)):this._dbg(g.Error,"setBlendState callback has no rendering context!")};e._setFrontFace=function(a){this._rctx?this._rctx.setFrontFace(a):this._dbg(g.Error,"setFrontFace callback has no rendering context!")};e._setDepthStencilStateFunction=function(a,b,c){this._rctx?(this._rctx.setDepthFunction(c),this._rctx.setDepthTestEnabled(1===a),this._rctx.setDepthWriteEnabled(1===
b),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(x.CompareFunction.ALWAYS,0,255),this._rctx.setStencilOpSeparate(x.Face.FRONT,x.StencilOperation.KEEP,x.StencilOperation.INCR,x.StencilOperation.KEEP),this._rctx.setStencilOpSeparate(x.Face.BACK,x.StencilOperation.KEEP,x.StencilOperation.DECR,x.StencilOperation.KEEP)):this._dbg(g.Error,"setDepthStencilStateFunction callback has no rendering context!")};e._setRasterizerState=function(a){if(this._rctx)switch(a){case t.WasmCullMode.None:this._rctx.setFaceCullingEnabled(!1);
break;case t.WasmCullMode.Back:this._rctx.setCullFace(x.Face.BACK);this._rctx.setFaceCullingEnabled(!0);break;case t.WasmCullMode.Front:this._rctx.setCullFace(x.Face.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(g.Error,"setRasterizerState callback has no rendering context!")};e._setViewport=function(a,b,c,d){this._rctx?this._rctx.setViewport(a,b,c,d):this._dbg(g.Error,"setViewport callback has no rendering context!")};e._updateMemoryUsage=function(){this._layers.forEach((a,b)=>{a.needMemoryUsageUpdate&&
(b=this._vxl.estimate_memory_usage(b),0<=b&&(a.needMemoryUsageUpdate=!1,a.layerView.setUsedMemory(b)))})};e._syncRequestsResponses=function(){this._layers.forEach((a,b)=>{const c=[];a.responses.forEach((h,n)=>{c.push(n);this._dbg(g.RequestResponse,"responding for requestID:"+n+" size:"+h.size);this._vxl.respond(b,n,h);if(h.requestType===t.VoxelRequestType.TreeIndex||h.requestType===t.VoxelRequestType.Section)a.needMemoryUsageUpdate=!0});const d=a.responses;for(var f of c)d.delete(f);f=this._vxl.get_new_requests(b);
const l=a.abortController.signal;for(const h in f){a.outstandingRequestCount+=1;1===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();const n=f[h],v={responseType:"array-buffer",signal:l};this._dbg(g.RequestResponse,"making requestID:"+h+" url:"+n.url);G(n.url,v).then(m=>{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();this._dbg(g.RequestResponse,"have response for requestID:"+h);let p=0;if(0<m.data.byteLength){p=this._vxl._malloc(m.data.byteLength);
const z=new Uint8Array(this._vxl.HEAPU8.buffer,p,m.data.byteLength),k=new Uint8Array(m.data);for(let r=0;r<m.data.byteLength;++r)z[r]=k[r]}d.set(+h,{responseType:n.responseType,ptr:p,size:m.data.byteLength,success:!0,requestType:n.requestType})}).catch(m=>{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();I.isAbortError(m)||(this._dbg(g.Error,`requestID:${h} failed, error=${m.toString()}`),d.set(+h,{responseType:n.responseType,ptr:0,size:0,success:!1,requestType:n.requestType}))})}})};
e.updateWasmCamera=function(a){this._vxl.set_projection_matrix.apply(this._vxl,a.projectionMatrix);this._vxl.set_view_matrix.apply(this._vxl,a.viewMatrix);this._vxl.set_near_far(a.near,a.far)};e.isUpdating=function(a){return!this._vxl&&this._vxlPromise?!0:(a=this._layers.get(a))?0<a.outstandingRequestCount:!1};e.getLayerTimes=function(a){const b=[];this._layers.forEach((c,d)=>{if(c.layerView.wasmLayerId===a.wasmLayerId)for(c=this._vxl.get_layer_epoch_times(d,a.layer.currentVariableId),d=0;d<c.length;++d)b.push(c[d])});
return b};e.getCurrentLayerTimeIndex=function(a){let b=0;this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(b=this._vxl.get_layer_current_time_id(d))});return b};e.setEnabled=function(a,b){this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(this._vxl.set_enabled(d,b),c.needMemoryUsageUpdate=!0,this._renderPluginContext.requestRender())})};e.setStaticSections=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.StaticSections,staticSections:b},!0)};
e.setCurrentVariable=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.CurrentVariable,currentVariable:b},!0)};e.setRenderMode=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.RenderMode,renderMode:b},!0)};e.setVerticalExaggerationAndOffset=function(a,b,c,d){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.ExaggerationAndOffset,volStyleDesc:{volumeId:b,verticalExaggeration:c,verticalOffset:d}},!0)};e.setVariableStyles=function(a,b){return this._doMaskedUIUpdate(a,
{mask:t.UpdateFlags.VariableStyles,variableStyles:b},!0)};e.setVolumeStyles=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.VolumeStyles,volumeStyles:b},!0)};e.setEnableDynamicSections=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:t.ContainerType.DynamicSections},!0)};e.setEnableIsosurfaces=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:t.ContainerType.Isosurfaces},
!0)};e.setEnableSections=function(a,b){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:t.ContainerType.StaticSections},!0)};e.setAnalysisSlice=function(a,b,c,d){return this._doMaskedUIUpdate(a,{mask:t.UpdateFlags.AnalysisSlice,analysisSlice:{point:c,normal:d,enabled:b}},!0)};e._doMaskedUIUpdate=function(a,b,c){if(!this._vxl)return!1;let d=!1;this._layers.forEach((f,l)=>{f.layerView.wasmLayerId===a.wasmLayerId&&(f={str:JSON.stringify(b),byteCount:0,
ptr:0,isReusable:!1},this._allocateBlock(f)&&(d=1===this._vxl.handle_masked_ui_update(l,f.ptr,f.byteCount),f.isReusable||this._vxl._free(f.ptr)))});d&&c&&this._renderPluginContext.requestRender();return d};e._addTriangleToWasmBuffer=function(a,b,c,d,f){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];b+=1;a[3*b]=d[0];a[3*b+1]=d[1];a[3*b+2]=d[2];b+=1;a[3*b]=f[0];a[3*b+1]=f[1];a[3*b+2]=f[2];return b+1};e._addNormalToWasmBuffer=function(a,b,c){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];return b+1};e._doCaptureFrustum=
function(){if(this._vxl){var a=this._vxl._malloc(108*Float32Array.BYTES_PER_ELEMENT),b=new Float32Array(this._vxl.HEAPF32.buffer,a,108),c=this._vxl._malloc(36*Float32Array.BYTES_PER_ELEMENT),d=new Float32Array(this._vxl.HEAPF32.buffer,c,36),f=this._frustum.points[u.PointIndex.NEAR_BOTTOM_LEFT],l=this._frustum.points[u.PointIndex.NEAR_BOTTOM_RIGHT],h=this._frustum.points[u.PointIndex.NEAR_TOP_RIGHT],n=this._frustum.points[u.PointIndex.NEAR_TOP_LEFT],v=this._frustum.points[u.PointIndex.FAR_BOTTOM_LEFT],
m=this._frustum.points[u.PointIndex.FAR_BOTTOM_RIGHT],p=this._frustum.points[u.PointIndex.FAR_TOP_RIGHT],z=this._frustum.points[u.PointIndex.FAR_TOP_LEFT],k=0,r=this._frustum.planes[u.PlaneIndex.NEAR];var q=this._addTriangleToWasmBuffer(b,0,h,l,f);k=this._addNormalToWasmBuffer(d,k,r);q=this._addTriangleToWasmBuffer(b,q,f,n,h);k=this._addNormalToWasmBuffer(d,k,r);r=this._frustum.planes[u.PlaneIndex.FAR];q=this._addTriangleToWasmBuffer(b,q,v,m,p);k=this._addNormalToWasmBuffer(d,k,r);q=this._addTriangleToWasmBuffer(b,
q,p,z,v);k=this._addNormalToWasmBuffer(d,k,r);r=this._frustum.planes[u.PlaneIndex.TOP];q=this._addTriangleToWasmBuffer(b,q,p,h,n);k=this._addNormalToWasmBuffer(d,k,r);q=this._addTriangleToWasmBuffer(b,q,n,z,p);k=this._addNormalToWasmBuffer(d,k,r);r=this._frustum.planes[u.PlaneIndex.BOTTOM];q=this._addTriangleToWasmBuffer(b,q,f,l,m);k=this._addNormalToWasmBuffer(d,k,r);q=this._addTriangleToWasmBuffer(b,q,m,v,f);k=this._addNormalToWasmBuffer(d,k,r);r=this._frustum.planes[u.PlaneIndex.LEFT];q=this._addTriangleToWasmBuffer(b,
q,n,f,v);k=this._addNormalToWasmBuffer(d,k,r);q=this._addTriangleToWasmBuffer(b,q,v,z,n);k=this._addNormalToWasmBuffer(d,k,r);f=this._frustum.planes[u.PlaneIndex.RIGHT];q=this._addTriangleToWasmBuffer(b,q,h,p,m);k=this._addNormalToWasmBuffer(d,k,f);q=this._addTriangleToWasmBuffer(b,q,m,l,h);k=this._addNormalToWasmBuffer(d,k,f);-1!==this._frustumRenderableId&&this._vxl.remove_generic_mesh(this._frustumRenderableId);this._frustumRenderableId=this._vxl.add_generic_mesh(a,108,c,36,255,0,0,64);this._vxl._free(a);
this._vxl._free(c);this._captureFrustum=!1;this._renderPluginContext.requestRender()}};e.captureFrustum=function(){null===this._renderCoordsHelper&&(this._renderCoordsHelper=Q.RenderCoordsHelper.create(N.ViewingMode.Local,L.renderSRFromViewSR(!1,this._view.spatialReference)));null===this._frustum&&(this._frustum=new P.Frustum(this._renderCoordsHelper));this._captureFrustum=!0;null!==this._renderPluginContext&&this._renderPluginContext.requestRender()};e.toggleFullVolumeExtentDraw=function(a){this._vxl&&
this._layers.forEach((b,c)=>{b.layerView.wasmLayerId===a.wasmLayerId&&(this._vxl.toggle_full_volume_extent_draw(c),this._renderPluginContext.requestRender())})};e.addVoxelLayer=function(a){if(!this._vxl){const b={layerView:a,resolveCallback:null,rejectCallback:null};a=new Promise((c,d)=>{b.resolveCallback=c;b.rejectCallback=d});this._newLayers.push(b);return a}a=this._addVoxelLayer(a);return 0>a?Promise.reject(-1):Promise.resolve(a)};e.removeVoxelLayer=function(a){if(!this._vxl){var b=this._newLayers.findIndex(d=>
a.uid===d.layerView.uid);0<=b&&(this._newLayers[b].resolveCallback(-1),this._newLayers.splice(b,1));b=this._newLayers.length;0===b&&(this._dbg(g.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b}let c=-1;this._layers.forEach((d,f)=>{d.layerView.wasmLayerId===a.wasmLayerId&&(c=f,d.abortController.abort(),this._vxl.remove_layer(c),d=this.layerUid.indexOf(a.layer.uid),-1!==d&&this.layerUid.splice(d,1))});0<=c&&this._layers.delete(c);
b=this._layers.size;0===b&&(this._dbg(g.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b};e._getBlockSize=function(a){for(const b of this._wasmMemBlockSizes)if(a<b)return b;return-1};e._allocateBlock=function(a){a.byteCount=this._vxl.lengthBytesUTF8(a.str)+1;const b=this._getBlockSize(a.byteCount);0>b?(a.isReusable=!1,a.ptr=this._vxl._malloc(a.byteCount)):(a.isReusable=!0,a.ptr=this._wasmMemBlocks.get(b),0===a.ptr&&(a.ptr=this._vxl._malloc(b),
this._wasmMemBlocks.set(b,a.ptr)));return 0!==a.ptr?(this._vxl.stringToUTF8(a.str,a.ptr,a.byteCount),!0):!1};e._getTimeArgs=function(a){let b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=!1;null!=a&&(a.isAllTime?d=!0:(null!=a.start&&(d=!0,b=a.start.getTime()/1E3),null!=a.end&&(d=!0,c=a.end.getTime()/1E3)));return{startTime:b,endTime:c,useTime:d}};e._addVoxelLayer=function(a){var b=a.layer,c=-1;c=b.getConfiguration();if(1>c.length)return-1;var d={str:c,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(d))return-1;
c=this._getTimeArgs(this._view?.timeExtent);const f=this._view.spatialReference.isWGS84&&b.spatialReference.isWGS84?111319.49079327357:1;c=this._vxl.add_layer(b.serviceRoot,d.ptr,d.byteCount,f,f,c.startTime,c.endTime,c.useTime,this._toWasmQuality(this._view.qualityProfile));d.isReusable||this._vxl._free(d.ptr);if(0<=c){b.test?.constantUpscaling&&(this._setUpscalingLimits(0,.25,.25),this._setUpscalingLimits(1,.5,.5),this._setUpscalingLimits(2,.75,.75));b=new AbortController;this._layers.set(c,{layerView:a,
responses:new Map,outstandingRequestCount:0,abortController:b,needMemoryUsageUpdate:!1});this.layerUid.push(a.layer.uid);if(!this._halfIntTexturesAvailable||C("mac")){b=[];d="";for(var l of a.layer.variables)if("Int16"===l.renderingFormat.type||"UInt16"===l.renderingFormat.type)b.push(l.name),l.id===a.layer.currentVariableId&&(d=l.name);""!==d&&y.error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${d}' in this browser`);0<b.length&&y.warn("#addVoxelLayer_warning()",
a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${b.toString()}' in this browser`)}if(!this._textureFloatLinearAvailable){l=[];b="";for(const h of a.layer.variables)"Float32"===h.renderingFormat.type&&(l.push(h.name),h.id===a.layer.currentVariableId&&(b=h.name));""!==b&&y.error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${b}' in this browser`);0<l.length&&y.warn("#addVoxelLayer_warning()",a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${l.toString()}' in this browser`)}C("esri-mobile")&&
y.warnOnce("Mobile support differs across devices. Voxel layer might not display as expected.");return c}return-1};e.prepareRender=function(a){if(this._vxl){var b=a.bindParameters.camera.viewForward;a=a.bindParameters.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],b[0],b[1],b[2]);b=this._vxl.cull();this._dbg(g.RequestResponse,"missingResourceCount\x3d"+b);this._moreToLoad=0<b;this._havePreparedWithAllLayers=0===this._newLayers.length;this._updateMemoryUsage()}};e.render=function(a){if(this._vxl&&
a.output===this._shaderOutput&&a.bindParameters.slot===this._renderSlot){for(var b of this._newLayers){const c=this._addVoxelLayer(b.layerView);-1===c?b.rejectCallback(-1):b.resolveCallback(c)}this._newLayers=[];if(0===this._layers.size)this._dbg(g.Error,"No voxel layers but RenderPlugin instance is being asked to render!");else{this._lastFrameWasStationary=this._view.stationary;this._syncRequestsResponses();this._beforeDraw();this._vxl.begin_color_frame(!this._view._stage.renderer.isFeatureEnabled(T.RenderFeature.HighResolutionVoxel),
a.bindParameters.lighting.mainLight.direction[0],a.bindParameters.lighting.mainLight.direction[1],a.bindParameters.lighting.mainLight.direction[2]);b=this._renderTargetToRestore.viewport;if(b.width!==this._viewportWidth||b.height!==this._viewportHeight)this._viewportWidth=b.width,this._viewportHeight=b.height,this._vxl.set_viewport(b.width,b.height),this._layers.forEach(c=>{c.needMemoryUsageUpdate=!0});0===b.x&&0===b.y||this._dbg(g.Error,"Unsupported viewport parameters detected!");this.updateWasmCamera(a.bindParameters.camera);
this._captureFrustum&&(this._frustum.update(a.bindParameters.camera),this._doCaptureFrustum());this._vxl.draw();this._afterDraw();(this._moreToLoad||!this._havePreparedWithAllLayers&&0<this._layers.size)&&this._renderPluginContext.requestRender()}}};e.destroy=function(){this._dbg(g.Lifetime,"--destroy--");this._removeRenderPlugin();this._readyWatchHandle=A.removeMaybe(this._readyWatchHandle);this._qualityWatchHandle=A.removeMaybe(this._qualityWatchHandle);this._timeExtentWatchHandle=A.removeMaybe(this._timeExtentWatchHandle);
this._stationaryWatchHandle=A.removeMaybe(this._stationaryWatchHandle);this._vxl&&(this._layers.forEach(a=>{a.abortController.abort()}),this._wasmMemBlocks.forEach(a=>{0!==a&&this._vxl._free(a)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)};e._initializeWasm=function(a){if(this._vxl)return Promise.resolve();this._vxlPromise||(this._vxlPromise=M.loadVoxelWASM(a).then(b=>{this._vxl=b;this._vxlPromise=null;if(0>=this._newLayers.length)this._dbg(g.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),
this.destroy();else{b=this._getTimeArgs(this._view?.timeExtent);var c=this._vxl.addFunction(this._restoreFramebuffer.bind(this),"v"),d=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),f=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),l=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),h=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),n=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),v=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),
"iii"),m=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),p=this._halfIntTexturesAvailable&&!C("mac");this._vxl.initialize_voxel_wasm(c,d,f,l,h,n,v,m,b.startTime,b.endTime,b.useTime,p,this._textureFloatLinearAvailable);this._renderPluginContext&&this._renderPluginContext.requestRender()}}).catch(()=>{for(const b of this._newLayers)b.rejectCallback(-2);this._dbg(g.Error," WASM failed to download, removing RenderPlugin and destroying");this.destroy()}));return this._vxlPromise};e.pickDepth=
function(a,b,c){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const d=c.viewport[3]-b;if(0>a||a>c.viewport[2]||0>b||b>c.viewport[3])return this._dbg(g.Error,`[js] pickDepth: outOfRange, screenXY=[${a.toFixed(0)}, ${d.toFixed(0)}]]`),null;this._beforeDraw();b=c.viewForward;const f=c.eye;this._vxl.update_camera_pos_and_direction(f[0],f[1],f[2],b[0],b[1],b[2]);this.updateWasmCamera(c);this._vxl.begin_frame();a=this._vxl.pick_depth(a,d);this._afterDraw();return a.success?a.distanceToCamera:
null};e.pickObject=function(a,b,c,d){if(!this._vxl||!this._rctx||0===this._layers.size)return null;a=Math.round(a);b=Math.round(b);if(0>a||a>c.viewport[2]||0>b||b>c.viewport[3])return this._dbg(g.Error,`[js] pickObject: outOfRange, screenXY=[${a}, ${b}], vp=[${c.viewport.toString()}]`),null;this._beforeDraw();const f=c.viewForward,l=c.eye;this._vxl.update_camera_pos_and_direction(l[0],l[1],l[2],f[0],f[1],f[2]);this.updateWasmCamera(c);this._vxl.begin_frame();c=null;0===d.length?c=this._vxl.pick_object(a,
b,0,0):(d={str:JSON.stringify({layerIds:d}),byteCount:0,ptr:0,isReusable:!1},this._allocateBlock(d)&&(c=this._vxl.pick_object(a,b,d.ptr,d.byteCount),d.isReusable||this._vxl._free(d.ptr)));this._afterDraw();return c};e._beforeDraw=function(){this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};this._rctx.setPolygonOffsetFillEnabled(!1);this._rctx.setScissorTestEnabled(!1);this._rctx.setColorMask(!0,!0,!0,!0)};e._afterDraw=function(){this._renderTargetToRestore.fbo=
null;this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit());this._rctx.externalVertexArrayObjectUpdate();this._rctx.externalVertexBufferUpdate();this._rctx.externalProgramUpdate()};e.intersect=function(a,b,c,d,f){if(this._vxl&&this._rctx&&0!==this._layers.size&&a.options.selectionMode&&!a.options.isFiltered){if(0>f[0]||f[0]>a.camera.viewport[2]||0>f[1]||f[1]>a.camera.viewport[3])return this._dbg(g.Error,`[js] VoxelWasmPerScene.intersect: outOfRange, screenXY=[${f[0].toFixed(0)}, ${f[1].toFixed(0)}]`),
null;var l=[];this._layers.forEach(n=>{a.options.filteredLayerUids.includes(n.layerView.layer.uid)&&l.push(n.layerView.wasmLayerId)});b=this.pickObject(f[0],f[1],a.camera,l);if(null!=b&&-1!==b.layerId){var h=this._layers.get(b.layerId);if(h){const n=h.layerView.layer.uid;f=b.distanceToCamera;c=J.distance(c,d);const v=f/c,m=K.create();m[0]=b.worldX;m[1]=b.worldY;m[2]=b.worldZ;const p={};null!=b.continuousValue&&null!=b.continuousValueUnits?p["Voxel.ServiceValue"]=`${b.continuousValue.toLocaleString()} ${b.continuousValueUnits}`:
null!=b.uniqueValueLabel&&null!=b.uniqueValue?p["Voxel.ServiceValue"]=`${b.uniqueValueLabel} (${b.uniqueValue})`:null!=b.uniqueValue&&(p["Voxel.ServiceValue"]=`${b.uniqueValue}`);p["Voxel.ServiceVariableLabel"]=b.variableLabel;p["Voxel.Position"]=b.voxelSpacePosition;null!=b.epochTime&&null!=b.nativeTime&&null!=b.nativeTimeUnits&&(p["Voxel.ServiceLocalTime"]=(new Date(b.epochTime)).toString(),p["Voxel.ServiceNativeTime"]=`${b.nativeTime.toLocaleString()} ${b.nativeTimeUnits}`);null!=b.depth&&null!=
b.depthUnits&&(p["Voxel.ServiceDepth"]=`${b.depth.toLocaleString()} ${b.depthUnits}`);const z=b.faceNormal;p["Voxel.WorldPosition"]=`[${m[0]}, ${m[1]}, ${m[2]}]`;c=k=>{const r=new O.VoxelTarget(m,n,()=>this._createVoxelGraphic(h.layerView.layer,p));k.set(this.type,r,v,z)};d=a.results;b=a.options.store===D.StoreResults.ALL;(null==d.min.dist||v<d.min.dist)&&c(d.min);(null==d.max.dist||v>d.max.dist)&&c(d.max);b&&(d=S.newIntersectorResult(a.ray),c(d),a.results.all.push(d))}}}};e._createVoxelGraphic=function(a,
b){return new F({layer:a,sourceLayer:a,attributes:b})};e._toWasmQuality=function(a){switch(a){case "low":return 0;case "medium":return 1;case "high":return 2}};e._setUpscalingLimits=function(a,b,c){this._vxl&&this._vxl.set_upscaling_limits(a,b,c)};E._createClass(w,[{key:"canRender",get:function(){return!!this._vxl&&"local"===this._view.viewingMode}}]);return w}()});
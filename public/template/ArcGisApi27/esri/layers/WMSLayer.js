// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/jsonMap ../core/lang ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/spatialReferenceUtils ./Layer ./mixins/BlendLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./ogc/crsUtils ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/imageBitmapUtils ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(x,e,J,K,L,z,C,M,u,N,d,O,r,v,k,P,w,Q,A,R,S,y,D,T,U,V,W,X,Y,Z,aa,ba,ca,E,F,da,B,q){function G(n){return"text/html"===n}function H(n){return"text/plain"===n}function ea(n,p){return n.some(f=>{for(const b in f)if(R.willPropertyWrite(f,b,null,p))return!0;return!1})}function I(n,p,f){n=n??[];const b=new Map;n.every(a=>null==a.id)&&(n=N.clone(n),n.forEach((a,c)=>a.id=c));for(const a of n){const c=new B;c.read(a,p);f&&!f.includes(c.name)&&(c.visible=!1);b.set(c.id,c)}p=[];for(const a of n)if(n=null!=
a.id?b.get(a.id):null)if(null!=a.parentLayerId&&0<=a.parentLayerId){if(f=b.get(a.parentLayerId))f.sublayers||(f.sublayers=new C),f.sublayers.push(n)}else p.push(n);return p}u=new u.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});d=function(n){function p(...b){var a=n.call(this,...b)||this;a.allSublayers=new M({getCollections:()=>[a.sublayers],getChildrenFunction(c){return c.sublayers}});a.customParameters=null;a.customLayerParameters=
null;a.copyright=null;a.description=null;a.dimensions=null;a.fullExtent=null;a.fullExtents=null;a.featureInfoFormats=null;a.featureInfoUrl=null;a.fetchFeatureInfoFunction=null;a.imageFormat=null;a.imageMaxHeight=2048;a.imageMaxWidth=2048;a.imageTransparency=!0;a.legendEnabled=!0;a.mapUrl=null;a.isReference=null;a.operationalLayerType="WMS";a.spatialReference=null;a.spatialReferences=null;a.sublayers=null;a.type="wms";a.version=null;a.addHandles([r.on(()=>a.sublayers,"after-add",({item:c})=>{c.parent=
c.layer=x._assertThisInitialized(a)},r.sync),r.on(()=>a.sublayers,"after-remove",({item:c})=>{c.layer=c.parent=null},r.sync),r.watch(()=>a.sublayers,(c,h)=>{if(h)for(const g of h)g.layer=g.parent=null;if(c)for(const g of c)g.parent=g.layer=x._assertThisInitialized(a)},r.sync)]);return a}x._inherits(p,n);var f=p.prototype;f.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};f.destroy=function(){this.allSublayers.destroy()};f.load=function(b){const a=null!=b?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},
b).catch(O.throwIfAbortError).then(()=>this._fetchService(a)));return Promise.resolve(this)};f.readFullExtentFromItemOrMap=function(b,a){return(b=a.extent)?new S({xmin:b[0][0],ymin:b[0][1],xmax:b[1][0],ymax:b[1][1]}):null};f.writeFullExtent=function(b,a){a.extent=[[b.xmin,b.ymin],[b.xmax,b.ymax]]};f.readImageFormat=function(b,a){return(b=a.supportedImageFormatTypes)&&b.includes("image/png")?"image/png":b&&b[0]};f.readSpatialReferenceFromItemOrDocument=function(b,a){return new y(a.spatialReferences[0])};
f.writeSpatialReferences=function(b,a){const c=this.spatialReference?.wkid;b&&c?(a.spatialReferences=b.filter(h=>h!==c),a.spatialReferences.unshift(c)):a.spatialReferences=b};f.readSublayersFromItemOrMap=function(b,a,c){return I(a.layers,c,a.visibleLayers)};f.readSublayers=function(b,a,c){return I(a.layers,c)};f.writeSublayers=function(b,a,c,h){a.layers=[];c=new Map;b=b.flatten(({sublayers:m})=>m??[]);for(var g of b)if("number"===typeof g.parent?.id){var l=c.get(g.parent.id);null!=l?l.push(g.id):
c.set(g.parent.id,[g.id])}for(const m of b)g={sublayer:m,...h},l=m.write({parentLayerId:"number"===typeof m.parent?.id?m.parent.id:-1},g),c.has(m.id)&&(l.sublayerIds=c.get(m.id)),!m.sublayers&&m.name&&(g=m.write({},g),delete g.id,a.layers.push(g));a.visibleLayers=b.filter(({visible:m,sublayers:t})=>m&&!t).map(({name:m})=>m).toArray()};f.createExportImageParameters=function(b,a,c,h){c=h?.pixelRatio??1;a=D.getScale({extent:b,width:a})*c;a=new F.ExportWMSImageParameters({layer:this,scale:a});const {xmin:g,
ymin:l,xmax:m,ymax:t,spatialReference:fa}=b;b=q.normalizeWKID(fa,this.spatialReferences);c="1.3.0"===this.version&&ba.isAxesOrderReversedForWkid(b)?`${l},${g},${t},${m}`:`${g},${l},${m},${t}`;a=a.toJSON();return{bbox:c,["1.3.0"===this.version?"crs":"srs"]:null==b||isNaN(b)?void 0:"EPSG:"+b,...a}};f.fetchImage=async function(b,a,c,h){var g=this.mapUrl;b=this.createExportImageParameters(b,a,c,h);if(!b.layers)return g=document.createElement("canvas"),g.width=a,g.height=c,g;var l=h?.timeExtent?.start;
const m=h?.timeExtent?.end;l=null!=l&&null!=m?l.getTime()===m.getTime()?q.toISOString(l):`${q.toISOString(l)}/${q.toISOString(m)}`:void 0;a={responseType:"image",query:this._mixCustomParameters({width:a,height:c,...b,time:l,...this.refreshParameters}),signal:h?.signal};return z(g??"",a).then(t=>t.data)};f.fetchImageBitmap=async function(b,a,c,h){const g=this.mapUrl??"";b=this.createExportImageParameters(b,a,c,h);if(!b.layers)return h=document.createElement("canvas"),h.width=a,h.height=c,h;var l=h?.timeExtent?.start;
const m=h?.timeExtent?.end;l=null!=l&&null!=m?l.getTime()===m.getTime()?q.toISOString(l):`${q.toISOString(l)}/${q.toISOString(m)}`:void 0;a={responseType:"blob",query:this._mixCustomParameters({width:a,height:c,...b,time:l,...this.refreshParameters}),signal:h?.signal};({data:a}=await z(g,a));return da.createBitmap(a,g,h?.signal)};f.fetchFeatureInfo=function(b,a,c,h,g){var l=D.getScale({extent:b,width:a});l=new F.ExportWMSImageParameters({layer:this,scale:l});l=q.getPopupLayers(l.visibleSublayers);
if(null==this.featureInfoUrl||null==l||null==this.fetchFeatureInfoFunction&&null==this.featureInfoFormat)return Promise.resolve([]);h={query_layers:l,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:a,height:c,...("1.3.0"===this.version?{I:h,J:g}:{x:h,y:g})};b={...this.createExportImageParameters(b,a,c),...h};b=this._mixCustomParameters(b);return null!=this.fetchFeatureInfoFunction?this.fetchFeatureInfoFunction(b):this._defaultFetchFeatureInfoFunction(v.addQueryParameters(this.featureInfoUrl,
b))};f.findSublayerById=function(b){return this.allSublayers.find(a=>a.id===b)};f.findSublayerByName=function(b){return this.allSublayers.find(a=>a.name===b)};f.serviceSupportsSpatialReference=function(b){return ca.isWmsServer(this.url)||null!=this.spatialReferences&&this.spatialReferences.some(a=>{a=900913===a?y.WebMercator:new y({wkid:a});return T.equals(a,b)})};f._defaultFetchFeatureInfoFunction=function(b){const a=document.createElement("iframe");a.src=v.addProxy(b);a.style.border="none";a.style.margin=
"0";a.style.width="100%";a.setAttribute("sandbox","");b=new L({title:this.title,content:a});b=new K({sourceLayer:this,popupTemplate:b});return Promise.resolve([b])};f._fetchService=async function(b){if(!this.resourceInfo&&this.parsedUrl?.path){const {path:a,query:c}=this.parsedUrl;({data:b}=await z(a,{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...c,...this.customParameters},responseType:"xml",signal:b}));this.resourceInfo=q.parseCapabilities(b)}if(this.parsedUrl){b=new v.Url(this.parsedUrl.path);
const {httpsDomains:a}=J.request;"https"!==b.scheme||b.port&&"443"!==b.port||!b.host||a.includes(b.host)||a.push(b.host)}this.read(this.resourceInfo,{origin:"service"})};f._mixCustomParameters=function(b){if(!this.customLayerParameters&&!this.customParameters)return b;const a={...this.customParameters,...this.customLayerParameters};for(const c in a)b[c.toLowerCase()]=a[c];return b};x._createClass(p,[{key:"featureInfoFormat",get:function(){return null==this.featureInfoFormats?null:this.featureInfoFormats.find(G)??
this.featureInfoFormats.find(H)??null},set:function(b){null!=b?(G(b)||H(b))&&this._override("featureInfoFormat",b):(this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat"))}},{key:"url",set:function(b){if(b){var {path:a,query:c}=v.urlToObject(b);for(const h in c)/^(request|service)$/i.test(h)&&delete c[h];b=v.addQueryParameters(a,c??{});this._set("url",b)}else this._set("url",b)}}]);return p}(V.BlendLayer(aa.TemporalLayer(Y.RefreshableLayer(Z.ScaleRangeLayer(W.OperationalLayer(X.PortalLayer(d.MultiOriginJSONMixin(U))))))));
e.__decorate([k.property({readOnly:!0})],d.prototype,"allSublayers",void 0);e.__decorate([k.property({json:{type:Object,write:!0}})],d.prototype,"customParameters",void 0);e.__decorate([k.property({json:{type:Object,write:!0}})],d.prototype,"customLayerParameters",void 0);e.__decorate([k.property({type:String,json:{write:!0}})],d.prototype,"copyright",void 0);e.__decorate([k.property()],d.prototype,"description",void 0);e.__decorate([k.property({readOnly:!0})],d.prototype,"dimensions",void 0);e.__decorate([k.property({json:{type:[[Number]],
read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],d.prototype,"fullExtent",void 0);e.__decorate([w.reader(["web-document","portal-item"],"fullExtent",["extent"])],d.prototype,"readFullExtentFromItemOrMap",null);e.__decorate([A.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],d.prototype,"writeFullExtent",null);e.__decorate([k.property()],d.prototype,"fullExtents",void 0);e.__decorate([k.property({type:String,
json:{write:{ignoreOrigin:!0}}})],d.prototype,"featureInfoFormat",null);e.__decorate([k.property({type:[String],readOnly:!0})],d.prototype,"featureInfoFormats",void 0);e.__decorate([k.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"featureInfoUrl",void 0);e.__decorate([k.property()],d.prototype,"fetchFeatureInfoFunction",void 0);e.__decorate([k.property({type:String,json:{origins:{"web-document":{default:"image/png",type:u.jsonValues,read:{reader:u.read,source:"format"},write:{writer:u.write,
target:"format"}}}}})],d.prototype,"imageFormat",void 0);e.__decorate([w.reader("imageFormat",["supportedImageFormatTypes"])],d.prototype,"readImageFormat",null);e.__decorate([k.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],d.prototype,"imageMaxHeight",void 0);e.__decorate([k.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],d.prototype,"imageMaxWidth",void 0);e.__decorate([k.property()],d.prototype,"imageTransparency",void 0);
e.__decorate([k.property(E.legendEnabled)],d.prototype,"legendEnabled",void 0);e.__decorate([k.property({type:["show","hide","hide-children"]})],d.prototype,"listMode",void 0);e.__decorate([k.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"mapUrl",void 0);e.__decorate([k.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],d.prototype,"isReference",void 0);e.__decorate([k.property({type:["WMS"]})],d.prototype,"operationalLayerType",void 0);
e.__decorate([k.property()],d.prototype,"resourceInfo",void 0);e.__decorate([k.property({type:y,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],d.prototype,"spatialReference",void 0);e.__decorate([w.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],d.prototype,"readSpatialReferenceFromItemOrDocument",null);e.__decorate([k.property({type:[P.Integer],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},
"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],d.prototype,"spatialReferences",void 0);e.__decorate([A.writer(["web-document","portal-item"],"spatialReferences")],d.prototype,"writeSpatialReferences",null);e.__decorate([k.property({type:C.ofType(B),json:{write:{target:"layers",overridePolicy(n,p,f){if(ea(this.allSublayers,f))return{ignoreOrigin:!0}}}}})],d.prototype,"sublayers",void 0);e.__decorate([w.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],d.prototype,
"readSublayersFromItemOrMap",null);e.__decorate([w.reader("service","sublayers",["layers"])],d.prototype,"readSublayers",null);e.__decorate([A.writer("sublayers",{layers:{type:[B]},visibleLayers:{type:[String]}})],d.prototype,"writeSublayers",null);e.__decorate([k.property({json:{read:!1},readOnly:!0,value:"wms"})],d.prototype,"type",void 0);e.__decorate([k.property(E.url)],d.prototype,"url",null);e.__decorate([k.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"version",void 0);
return d=e.__decorate([Q.subclass("esri.layers.WMSLayer")],d)});
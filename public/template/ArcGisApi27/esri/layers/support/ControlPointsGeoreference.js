// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/Error ../../core/JSONSupport ../../core/Logger ../../core/perspectiveUtils ../../core/screenUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../chunks/mat3 ../../chunks/mat3f64 ../../chunks/vec2 ../../chunks/vec2f64 ../../geometry/Point ../../geometry/Polygon ../../geometry/projection ../../geometry/SpatialReference ./GeoreferenceBase".split(" "),
function(N,p,H,Y,m,U,r,M,A,ja,ka,la,Z,V,aa,ba,O,l,n,B,ca,W,da,ea){function h(d){return null!=d&&null!=d.sourcePoint&&null!=d.mapPoint}function v(d,f,c){l.set(d,c.sourcePoint.x,c.sourcePoint.y);l.set(f,c.mapPoint.x,c.mapPoint.y)}function fa(d,f,c){v(w,x,f);v(y,z,c);l.rotate(I,y,w,P);l.rotate(C,w,y,P);l.rotate(J,z,x,-P);l.rotate(D,x,z,-P);f=x;c=z;var a=J,b=D;return r.getProjectiveTransform(d,L(R,w,y,I,C),L(S,f,c,a,b))}function ha(d,f,c,a){v(w,x,f);v(y,z,c);v(I,J,a);l.lerp(C,w,y,.5);l.rotate(C,I,C,Math.PI);
l.lerp(D,x,z,.5);l.rotate(D,J,D,Math.PI);f=x;c=z;a=J;var b=D;return r.getProjectiveTransform(d,L(R,w,y,I,C),L(S,f,c,a,b))}function X(d,f,c,a,b){v(w,x,f);v(y,z,c);v(I,J,a);v(C,D,b);f=x;c=z;a=J;b=D;return r.getProjectiveTransform(d,L(R,w,y,I,C),L(S,f,c,a,b))}function L(d,f,c,a,b){d[0]=f[0];d[1]=f[1];d[2]=c[0];d[3]=c[1];d[4]=a[0];d[5]=a[1];d[6]=b[0];d[7]=b[1];return d}const T=O.create(),g=n.create();H=function(d){function f(){var c=d.apply(this,arguments)||this;c.sourcePoint=null;c.mapPoint=null;return c}
N._inherits(f,d);return N._createClass(f)}(H);p.__decorate([A.property()],H.prototype,"sourcePoint",void 0);p.__decorate([A.property({type:B})],H.prototype,"mapPoint",void 0);H=p.__decorate([V.subclass("esri.layers.support.ControlPoint")],H);m=function(d){function f(a){a=d.call(this,a)||this;a.controlPoints=null;a.height=0;a.type="control-points";a.width=0;return a}N._inherits(f,d);var c=f.prototype;c.readControlPoints=function(a,b){const q=da.fromJSON(b.spatialReference),k=O.fromValues(...b.coefficients,
1);return a.map(e=>{l.set(g,e.x,e.y);r.transformProjective(g,g,k);return{sourcePoint:e,mapPoint:new B({x:g[0],y:g[1],spatialReference:q})}})};c.writeControlPoints=function(a,b,q,k){null==this.transform?(a=new Y("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:k?.layer,georeference:this}),k?.messages?k.messages.push(a):U.getLogger(this).error(a.name,a.message)):null!=a&&h(a[0])&&(b.controlPoints=a.map(e=>{e=e.sourcePoint;return{x:e.x,y:e.y}}),
b.spatialReference=a[0].mapPoint.spatialReference.toJSON(),b.coefficients=this.transform.slice(0,8))};c.toMap=function(a){if(null==a||null==this.transform||null==this.controlPoints||!h(this.controlPoints[0]))return null;l.set(g,a.x,a.y);a=this.controlPoints[0].mapPoint.spatialReference;r.transformProjective(g,g,this.transform);return new B({x:g[0],y:g[1],spatialReference:a})};c.toSource=function(a){if(null==a||null==this.inverseTransform||null==this.controlPoints||!h(this.controlPoints[0]))return null;
const b=this.controlPoints[0].mapPoint.spatialReference;a=a.normalize();a=W.projectOrLoad(a,b).geometry;if(null==a)return null;l.set(g,a.x,a.y);r.transformProjective(g,g,this.inverseTransform);return M.createScreenPoint(g[0],g[1])};c._updateTransform=function(a){const {controlPoints:b,width:q,height:k}=this;if(!(null!=b&&0<q&&0<k))return null;const [e,t,E,Q]=b;if(!h(e))return null;var u=e.mapPoint.spatialReference;const F=this._projectControlPoint(t,u),G=this._projectControlPoint(E,u);u=this._projectControlPoint(Q,
u);if(!(F.valid&&G.valid&&u.valid&&h(F.controlPoint)))return null;null==a&&(a=O.create());let K=null;K=h(G.controlPoint)&&h(u.controlPoint)?X(a,e,F.controlPoint,G.controlPoint,u.controlPoint):h(G.controlPoint)?ha(a,e,F.controlPoint,G.controlPoint):fa(a,e,F.controlPoint);return K.every(ia=>0===ia)?null:K};c._projectControlPoint=function(a,b){if(!h(a))return{valid:!0,controlPoint:a};const {sourcePoint:q,mapPoint:k}=a,{geometry:e,pending:t}=W.projectOrLoad(k,b);return t?{valid:!1,controlPoint:null}:
t||e?{valid:!0,controlPoint:{sourcePoint:q,mapPoint:e}}:(U.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:a,sourceSpatialReference:k.spatialReference,targetSpatialReference:b}),{valid:!1,controlPoint:null})};N._createClass(f,[{key:"coords",get:function(){if(null==this.controlPoints)return null;const a=this._updateTransform(T);if(null==a||!h(this.controlPoints[0]))return null;var b=this.width,q=this.height,k=this.controlPoints[0].mapPoint.spatialReference;
const e=n.fromValues(0,q),t=n.fromValues(0,0),E=n.fromValues(b,0);b=n.fromValues(b,q);r.transformProjective(e,e,a);r.transformProjective(t,t,a);r.transformProjective(E,E,a);r.transformProjective(b,b,a);return new ca({rings:[[e,t,E,b,e]],spatialReference:k})},set:function(a){if(null!=this.controlPoints&&h(this.controlPoints[0])){var b=this.controlPoints[0].mapPoint.spatialReference;a=this.projectOrWarn(a,b);if(null!=a){var {width:q,height:k}=this,{rings:[[e,t,E,Q]]}=a;a={sourcePoint:M.createScreenPoint(0,
k),mapPoint:new B({x:e[0],y:e[1],spatialReference:b})};var u={sourcePoint:M.createScreenPoint(0,0),mapPoint:new B({x:t[0],y:t[1],spatialReference:b})},F={sourcePoint:M.createScreenPoint(q,0),mapPoint:new B({x:E[0],y:E[1],spatialReference:b})},G={sourcePoint:M.createScreenPoint(q,k),mapPoint:new B({x:Q[0],y:Q[1],spatialReference:b})};h(a)&&h(u)&&h(F)&&h(G)&&(X(T,a,u,F,G),this.controlPoints=this.controlPoints.map(({sourcePoint:K})=>{l.set(g,K.x,K.y);r.transformProjective(g,g,T);return{sourcePoint:K,
mapPoint:new B({x:g[0],y:g[1],spatialReference:b})}}))}}}},{key:"inverseTransform",get:function(){return null==this.transform?null:ba.invert(O.create(),this.transform)}},{key:"transform",get:function(){return this._updateTransform()}}]);return f}(m.JSONSupportMixin(ea));p.__decorate([A.property({type:[H],json:{write:{allowNull:!1,isRequired:!0}}})],m.prototype,"controlPoints",void 0);p.__decorate([Z.reader("controlPoints")],m.prototype,"readControlPoints",null);p.__decorate([aa.writer("controlPoints")],
m.prototype,"writeControlPoints",null);p.__decorate([A.property()],m.prototype,"coords",null);p.__decorate([A.property({json:{write:!0}})],m.prototype,"height",void 0);p.__decorate([A.property({readOnly:!0})],m.prototype,"inverseTransform",null);p.__decorate([A.property({readOnly:!0})],m.prototype,"transform",null);p.__decorate([A.property({json:{write:!0}})],m.prototype,"width",void 0);m=p.__decorate([V.subclass("esri.layers.support.ControlPointsGeoreference")],m);const w=n.create(),y=n.create(),
I=n.create(),C=n.create(),x=n.create(),z=n.create(),J=n.create(),D=n.create(),P=Math.PI/2,R=Array(8).fill(0),S=Array(8).fill(0);return m});
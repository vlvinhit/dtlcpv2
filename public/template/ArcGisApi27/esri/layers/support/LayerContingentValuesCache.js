// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/arrayUtils ../../core/JSONSupport ../../core/Loadable ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(F,A,B,G,u,M,C,P,Q,N,D,H,I,t,O,E,J){var x;u=x=function(K){function z(a){a=
K.call(this,a)||this;a.request=B;a.fieldGroups=null;a.fieldGroupDefinitions=null;return a}F._inherits(z,K);var k=z.prototype;k.initialize=function(){};z.createLoadedLayerContingentValuesCache=async function(a){await a.load();if(void 0===a.layerId)return null;var b=a.sourceJSON.hasContingentValuesDefinition;if(b)return(new x({layer:a})).load();if(void 0===b){b=D.parse(a.url);if(null==b)return null;b=b.url.path;if((await x._staticFetchEnterpriseFeatureRoot(b)).supportsQueryDataElements&&(b=await x._staticFetchEnterpriseFieldGroup(b,
a.layerId.toString())))return b=b.map(c=>({name:c.name,isEditingRestrictive:c.isEditingRestrictive,fields:c.fieldNames.names})),(new x({layer:a,fieldGroupDefinitions:b})).load()}return null};k.load=async function(a){const b=this.layer.load(a).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,a));this.addResolvingPromise(b);return this};k.validateContingencyConstraints=function(a,b){const c=Object.keys(a),e=[],d=[];for(const m of this.fieldGroups){const h=m.isEditingRestrictive?
"error":"warning";if(b&&!m.fields.some(g=>b.includes(g)))continue;if(!m.fields.every(g=>c.includes(g))){d.push(new I({fieldGroup:m,type:h}));continue}let n=!1;const q=a[this.subtypeFieldName];var f=m.contingencies.filter(g=>!g.isRetired&&g.subtype?g.subtype.code===q:!0);for(const g of f){f=!0;for(const r in g.values){const p=g.values[r];if("any"!==p.objectType)if("null"===p.objectType){if(null!=a[r]){f=!1;break}}else if("code"===p.objectType){if(a[r]!==p.codedValue.code){f=!1;break}}else if("range"===
p.objectType){const l=a[r];if(l<p.minValue||l>p.maxValue){f=!1;break}}}if(f){n=!0;break}}n||e.push(new I({fieldGroup:m,type:h}))}return{invalid:e,incomplete:d}};k.getContingentValues=function(a,b,c=!1){const e=a[this.subtypeFieldName],d=void 0!==e&&null!==e,f={};let m=[];const h=this.fieldGroups.filter(q=>q.fields.includes(b));m.push(new t({objectType:"any"}));for(const q of h){let g=[];var n=q.contingencies.filter(l=>!l.isRetired&&(l.subtype&&d?l.subtype.code===e:!0));let r=!1;const p={};for(const l of n){let v;
n=!0;for(const y in l.values){const w=l.values[y];if(b===y)v=w,r=r||"range"===w.objectType;else if(void 0!==a[y]&&"any"!==w.objectType)if("null"===w.objectType)null!==a[y]&&(n=!1);else if("code"===w.objectType)a[y]!==w.codedValue.code&&(n=!1);else if("range"===w.objectType){const L=a[y];if(L<w.minValue||L>w.maxValue)n=!1}}if(v&&n){if("any"===v.objectType){g.length=0;g.push(v);break}n=this._generateKey(v);p[n]||g.push(v);p[n]=!0}}r&&(g=this._joinRange(g));f[q.name]=g;m=c?this._filterIntersection(m,
g):[]}1===h.length&&c&&(m=[]);return new O({contingentValuesAllGroups:m,contingentValuesByFieldGroup:f})};k._generateKey=function(a){switch(a.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return a.codedValue.name+a.codedValue.code.toString();case "range":return a.minValue.toString()+"-"+a.maxValue.toString()}};k._joinRange=function(a){a.sort((d,f)=>"null"===d.objectType?-1:"null"===f.objectType?1:d.minValue-f.minValue);let b,c;const e=[];for(const d of a)"null"===d.objectType?
e.push(d):null==b||null==c?(b=d.minValue,c=d.maxValue):c<d.minValue?(e.push(new t({objectType:"range",minValue:b,maxValue:c})),b=d.minValue,c=d.maxValue):c<d.maxValue&&(c=d.maxValue);e.push(new t({objectType:"range",minValue:b,maxValue:c}));return e};k._filterIntersection=function(a,b){if(0===a.length||0===b.length)return[];if("any"===a[0].objectType)return b;if("any"===b[0].objectType)return a;const c="range"===b[0].objectType||"range"===b[1]?.objectType;return"range"===a[0].objectType||"range"===
a[1]?.objectType||c?this._intersectRanges(a,b):this._intersectValues(a,b)};k._intersectRanges=function(a,b){const c=[];let e=0;for(const d of a)for(;e<b.length;e++){const f=b[e];if("null"===d.objectType&&"null"===f.objectType)c.push(new t({objectType:"null"}));else if("null"===d.objectType)break;else if("null"===f.objectType)continue;if(d.maxValue<f.minValue)break;if(d.maxValue===f.minValue){c.push(new t({objectType:"range",minValue:d.maxValue,maxValue:f.minValue}));break}if(!(d.minValue>f.maxValue))if(d.minValue===
f.maxValue)c.push(new t({objectType:"range",minValue:d.minValue,maxValue:f.maxValue}));else{a=d.minValue>f.minValue?d.minValue:f.minValue;if(d.maxValue<f.maxValue){c.push(new t({objectType:"range",minValue:a,maxValue:d.maxValue}));break}c.push(new t({objectType:"range",minValue:a,maxValue:f.maxValue}))}}return c};k._intersectValues=function(a,b){const c=[];for(const e of a)b.some(d=>{if(e.objectType===d.objectType)switch(e.objectType){case "any":case "null":return!0;case "code":return e.codedValue.code===
d.codedValue.code&&e.codedValue.name===d.codedValue.name}return!1})&&c.push(e);return c};z._staticFetchEnterpriseFeatureRoot=async function(a,b){return B(a,{responseType:"json",query:{f:"json"},...b}).then(c=>c.data)};z._staticFetchEnterpriseFieldGroup=async function(a,b,c){return B(`${a}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...c}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups)};k._initializeContingentValues=async function(a,b){a=a??await this._fetchFieldGroupDefs(b);
this.fieldGroups=0===a.length?[]:await this._fetchContingentValues(a,b)};k._fetchFieldGroupDefs=async function(a){if(void 0===this.layer.layerId)return[];const b=this.layer.sourceJSON,c=this.layer.layerId.toString(),e=D.parse(this.layer.url).url.path;return b.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(e,c,a)).map(d=>({name:d.name,isEditingRestrictive:d.restrictive,fields:d.fields.map(f=>this.layer.fieldsIndex.normalizeFieldName(f))})):void 0!==b.hasContingentValuesDefinition?[]:
this._fetchEnterpriseFeatureRoot(e,a).then(async d=>d.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(e,c,a)).map(f=>({name:f.name,isEditingRestrictive:f.isEditingRestrictive,fields:f.fieldNames.names.map(m=>this.layer.fieldsIndex.normalizeFieldName(m))})):[])};k._fetchAGOLFieldGroup=async function(a,b,c){return B(`${a}/${b}/fieldgroups`,{responseType:"json",query:{f:"json"},...c}).then(e=>e.data.fieldGroups)};k._fetchEnterpriseFieldGroup=async function(a,b,c){return x._staticFetchEnterpriseFieldGroup(a,
b,c)};k._fetchEnterpriseFeatureRoot=async function(a,b){return x._staticFetchEnterpriseFeatureRoot(a,b)};k._fetchContingentValues=async function(a,b){if(void 0===this.layer.layerId)return[];const c=this.layer.sourceJSON,e=this.layer.layerId.toString(),d=D.parse(this.layer.url).url.path;if(c.hasContingentValuesDefinition)return b=await this._fetchAGOLContingentValues(d,e,b),this._constructFieldGroupsAGOL(a,b);b=await this._fetchEnterpriseContingentValues(d,e,b);return this._constructFieldGroupsEnterprise(a,
b)};k._constructFieldGroupsAGOL=function(a,b){return a.map(c=>{const e=b.contingentValuesDefinition.fieldGroups.find(d=>d.name===c.name);if(e){let d=[];d=b.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(c,b,e.subTypes):this._parseAGOLFieldGroup(c,b,e.contingentValues);return new E({name:c.name,isEditingRestrictive:c.isEditingRestrictive,fields:c.fields,contingencies:d})}return null}).filter(G.isSome)};k._parseAGOLFieldGroupSubtype=function(a,b,c){let e=[];c?.forEach(d=>{const f=
this._getSubtypeAGOL(d.name);e=e.concat(this._parseAGOLFieldGroup(a,b,d.contingentValues,f))});return e};k._parseAGOLFieldGroup=function(a,b,c,e=null){const d=[];for(const f of c??[])c=this._parseAGOLContingency(f,a,b,e),d.push(c);return d};k._parseAGOLContingency=function(a,b,c,e){const d=a.id,f=a.retired?1===a.retired:!1,m={};for(let n=0,q=0;n<b.fields.length;n++){const g=b.fields[n];var h=c.typeCodes[a.types[n]];if("Code"===h){let r=a.values[q];q++;const p=this._getDomain(e,g);"string"===this.layer.getField(g)?.type&&
(h=c.stringDicts.find(l=>l.domain===p.name))&&(r=h.entries[r]);h=p.codedValues.find(l=>l.code===r);h=new t({codedValue:h,objectType:"code"});m[g]=h}else"Range"===h?(h=a.values[q],q++,h=new t({minValue:h.range[0],maxValue:h.range[1],objectType:"range"}),m[g]=h):"Any"===h?(h=new t({objectType:"any"}),m[g]=h):(h=new t({objectType:"null"}),m[g]=h)}return new H({id:d,isRetired:f,subtype:e,values:m})};k._constructFieldGroupsEnterprise=function(a,b){const c=b.fieldGroups;return a.map(e=>{var d=c.find(f=>
f.name===e.name);return d?(d=d.contingencies.map(f=>{const m=f.id,h=f.isRetired||!1,n=this._getSubtypeEnterprise(f.subtypeCode),q={};for(let r=0;r<e.fields.length;r++){const p=e.fields[r];let l=f.values[r];if("number"===typeof l||"string"===typeof l){var g=this._getDomain(n,p);const v=this.layer.getField(p);"string"===v?.type?l=b.stringDictionary[l]:"date"===v?.type&&(l=(new Date(`${l}+00:00`)).getTime());g=g.codedValues.find(y=>y.code===l);g=new t({codedValue:g,objectType:"code"});q[p]=g}else"object"===
typeof l?(g=new t({minValue:l.minValue,maxValue:l.maxValue,objectType:"range"}),q[p]=g):l?(g=new t({objectType:"any"}),q[p]=g):(g=new t({objectType:"null"}),q[p]=g)}return new H({id:m,isRetired:h,subtype:n,values:q})}),new E({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:d})):null}).filter(G.isSome)};k._fetchEnterpriseContingentValues=async function(a,b,c){return B(`${a}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},
...c}).then(e=>e.data.contingentValueSets?.[0])};k._fetchAGOLContingentValues=async function(a,b,c){return B(`${a}/${b}/contingentValues`,{responseType:"json",query:{f:"json"},...c}).then(e=>e.data)};k._getSubtypeEnterprise=function(a){var b=this.layer.sourceJSON;let c;b.subtypes&&(b=b.subtypes.find(e=>e.code===a),c=J.fromJSON(b));return c||null};k._getSubtypeAGOL=function(a){var b=this.layer.sourceJSON;let c;b.subtypes&&(b=b.subtypes.find(e=>e.name===a),c=J.fromJSON(b));return c||null};k._getDomain=
function(a,b){a=a?a.domains?.[b]:this.layer.getFieldDomain(b);return"inherited"===a?.type?this.layer.getFieldDomain(b):a};F._createClass(z,[{key:"subtypeFieldName",get:function(){const {layer:a}=this;return"subtype-group"===a.type?a.subtypeField:a.typeIdField}}]);return z}(u.JSONSupportMixin(M));A.__decorate([C.property({constructOnly:!0})],u.prototype,"layer",void 0);A.__decorate([C.property({constructOnly:!0})],u.prototype,"request",void 0);A.__decorate([C.property({type:[E]})],u.prototype,"fieldGroups",
void 0);A.__decorate([C.property({constructOnly:!0})],u.prototype,"fieldGroupDefinitions",void 0);A.__decorate([C.property()],u.prototype,"subtypeFieldName",null);return u=x=A.__decorate([N.subclass("esri.layers.support.LayerContingentValuesCache")],u)});
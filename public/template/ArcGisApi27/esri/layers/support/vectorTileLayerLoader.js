// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../request","../../core/promiseUtils","../../core/urlUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],function(q,u,v,k,w){function n(...c){let b=void 0;for(const a of c)null!=a&&(k.isProtocolRelative(a)?b&&(b=b.split("://")[0]+":"+a.trim()):b=k.isAbsolute(a)?a:k.join(b,a));return b?k.removeTrailingSlash(b):void 0}async function m(c,b,a,h,f){v.throwIfAborted(f);let d,g;if("string"===typeof a){a=k.normalize(a);var e=await u(a,{...f,responseType:"json",query:{f:"json",
...f?.query}});e.ssl&&(d&&(d=d.replace(/^http:/i,"https:")),g&&(g=g.replace(/^http:/i,"https:")));g=d=a}else null!=a&&(e={data:a},d=a.jsonUrl||null,g=h);if((e=e?.data)&&"sources"in e&&e.sources)return c.styleUrl=d||null,x(c,e,g,f);if(!(e&&"sources"in e&&e.sources))return c.sourceUrl?r(c,e,g,!1,b,f):(c.sourceUrl=d||null,r(c,e,g,!0,b,f));throw Error("You must specify the URL or the JSON for a service or for a style.");}async function x(c,b,a,h){a=a?k.removeFile(a):k.getAppBaseUrl();c.styleBase=a;c.style=
b;b["sprite-format"]&&"webp"===b["sprite-format"].toLowerCase()&&(c.spriteFormat="webp");const f=[];if(b.sources&&b.sources.esri){const d=b.sources.esri;d.url?await m(c,"esri",n(a,d.url),void 0,h):f.push(m(c,"esri",d,a,h))}for(const d of Object.keys(b.sources))"esri"!==d&&"vector"===b.sources[d].type&&(b.sources[d].url?f.push(m(c,d,n(a,b.sources[d].url),void 0,h)):b.sources[d].tiles&&f.push(m(c,d,b.sources[d],a,h)));await Promise.all(f)}async function r(c,b,a,h,f,d){a=a?k.removeTrailingSlash(a)+"/":
k.getAppBaseUrl();if(b.hasOwnProperty("tileInfo"))var g=b;else{g={xmin:-2.0037507067161843E7,ymin:-2.0037507067161843E7,xmax:2.0037507067161843E7,ymax:2.0037507067161843E7,spatialReference:{wkid:102100}};var e=78271.51696400007,l=2.958287637957775E8,t=[],y=b.hasOwnProperty("minzoom")?+b.minzoom:0,z=b.hasOwnProperty("maxzoom")?+b.maxzoom:22;for(let p=0;p<=z;p++)p>=y&&t.push({level:p,scale:l,resolution:e}),e/=2,l/=2;g={capabilities:"TilesOnly",initialExtent:g,fullExtent:g,minScale:0,maxScale:0,tiles:b.tiles,
tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},lods:t,spatialReference:{wkid:102100}}}}e=new w(f,k.addQueryParameters(a,d?.query??{}),g);if(!h&&c.primarySourceName in c.sourceNameToSource){l=c.sourceNameToSource[c.primarySourceName];if(!l.isCompatibleWith(e))return;null!=e.fullExtent&&(null!=l.fullExtent?l.fullExtent.union(e.fullExtent):l.fullExtent=e.fullExtent.clone());l.tileInfo&&e.tileInfo&&l.tileInfo.lods.length<e.tileInfo.lods.length&&(l.tileInfo=
e.tileInfo)}h&&(c.sourceBase=a,c.source=b,c.validatedSource=g,c.primarySourceName=f);c.sourceNameToSource[f]=e;if(!c.style){if(null==b.defaultStyles)throw Error();return"string"===typeof b.defaultStyles?m(c,"",n(a,b.defaultStyles,"root.json"),void 0,d):m(c,"",b.defaultStyles,n(a,"root.json"),d)}}q.loadMetadata=async function(c,b){const a={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},
[h,f]="string"===typeof c?[c,null]:[null,c.jsonUrl];await m(a,"esri",c,f,b);return{layerDefinition:a.validatedSource,url:h,serviceUrl:a.sourceUrl,style:a.style,styleUrl:a.styleUrl,spriteUrl:a.style.sprite&&n(a.styleBase,a.style.sprite),spriteFormat:a.spriteFormat,glyphsUrl:a.style.glyphs&&n(a.styleBase,a.style.glyphs),sourceNameToSource:a.sourceNameToSource,primarySourceName:a.primarySourceName}};Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});
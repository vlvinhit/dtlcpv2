// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../core/Error ../../core/object ./domainUtils ../../support/arcadeOnDemand".split(" "),function(T,d,U,B,m,V){function C(a,b,c){if(a)for(const e of a)(a=(a=B.getDeepValue(e,b))&&"function"!==typeof a&&c.get(a))&&B.setDeepValue(e,a.name,b)}function h(a,b){if(!a||!b)return[];t.clear();k(t,a,b);return Array.from(t).sort()}function k(a,b,c){if(c)if(b?.fields?.length)if(c.includes("*"))for(const {name:e}of b.fields)a.add(e);else for(const e of c)l(a,b,e);else if(c.includes("*"))a.clear(),
a.add("*");else for(const e of c)null!=e&&a.add(e)}function l(a,b,c){"string"===typeof c&&(b?(b=b.get(c))&&a.add(b.name):a.add(c))}async function g(a,b,c){if(c){var {arcadeUtils:e}=await V.loadArcade();c=e.extractFieldNames(c,b?.fields?.map(f=>f.name));for(const f of c)l(a,b,f)}}async function D(a,b,c){if(c&&"1\x3d1"!==c){var {WhereClause:e}=await new Promise((f,W)=>T(["../../core/sql/WhereClause"],f,W));e=e.create(c,b);if(!e.isStandardized)throw new U("fieldUtils:collectFilterFields","Where clause is not standardized",
{where:c});k(a,b,e.fieldNames)}}function u(a,b){for(const c of a)if(c&&c.valueType&&c.valueType===b)return c.name;return null}async function E(a,b){if(b){var c=b.elevationInfo?.featureExpressionInfo;if(c)return c.collectRequiredFields(a,b.fieldsIndex)}}async function F(a,b,c){const e=[];c?.expressionInfos&&e.push(...c.expressionInfos.map(f=>g(a,b.fieldsIndex,f.expression)));c=c?.content;if(Array.isArray(c))for(const f of c)"expression"===f.type&&f.expressionInfo&&e.push(g(a,b.fieldsIndex,f.expressionInfo.expression));
await Promise.all(e)}async function X(a,b,c){b&&c&&(c.valueExpression?await g(a,b.fieldsIndex,c.valueExpression):c.field&&l(a,b.fieldsIndex,c.field))}function G(a){if(!a)return[];const b=a.geometryFieldsInfo;return b?h(a.fieldsIndex,[b.shapeAreaField,b.shapeLengthField]):[]}function H(a){const b=new Set;v(a).forEach(c=>b.add(c));G(a).forEach(c=>b.add(c.toLowerCase()));if(a=a&&"infoFor3D"in a?a.infoFor3D:void 0)Object.values(a.assetMapFieldRoles).forEach(c=>b.add(c.toLowerCase())),Object.values(a.transformFieldRoles).forEach(c=>
b.add(c.toLowerCase()));return Array.from(b)}function w(a){if(!a)return[];a="editFieldsInfo"in a&&a.editFieldsInfo;if(!a)return[];const {creationDateField:b,creatorField:c,editDateField:e,editorField:f}=a;return[b,c,e,f].filter(Boolean)}function v(a){return w(a).map(b=>b.toLowerCase())}async function I(a,b){const {labelingInfo:c,fieldsIndex:e}=b;c&&c.length&&await Promise.all(c.map(f=>Y(a,e,f)))}async function Y(a,b,c){if(c){var e=c.getLabelExpression();c=c.where;"arcade"===e.type?await g(a,b,e.expression):
(e=e.expression.match(/{[^}]*}/g))&&e.forEach(f=>{l(a,b,f.slice(1,-1))});await D(a,b,c)}}function x(a){return"number"===typeof a&&!isNaN(a)&&isFinite(a)}function Z(a){return null===a||x(a)}function aa(a){return null===a||n(a)}function J(a){return null!=a&&"string"===typeof a}function ba(a){return null===a||J(a)}function ca(){return!0}function y(a,b){let c;switch(a.type){case "date":case "integer":case "long":case "small-integer":case "esriFieldTypeDate":case "esriFieldTypeInteger":case "esriFieldTypeLong":case "esriFieldTypeSmallInteger":c=
a.nullable?aa:n;break;case "double":case "single":case "esriFieldTypeSingle":case "esriFieldTypeDouble":c=a.nullable?Z:x;break;case "string":case "esriFieldTypeString":c=a.nullable?ba:J;break;default:c=ca}return 1===arguments.length?c:c(b)}function z(a){return null!=a&&da.has(a.type)}function K(a,b){return null==a||a.nullable&&null===b?null:z(a)&&!L(a.type,Number(b))?d.NumericRangeValidationError.OUT_OF_RANGE:y(a,b)?a.domain?m.validateDomainValue(a.domain,b):null:d.TypeValidationError.INVALID_TYPE}
function L(a,b){a="string"===typeof a?A(a):a;if(!a)return!1;const c=a.min,e=a.max;return a.isInteger?n(b)&&b>=c&&b<=e:b>=c&&b<=e}function A(a){switch(a){case "esriFieldTypeSmallInteger":case "small-integer":return p;case "esriFieldTypeInteger":case "integer":return q;case "esriFieldTypeBigInteger":case "big-integer":return M;case "esriFieldTypeSingle":case "single":return r;case "esriFieldTypeDouble":case "double":return N}}function O(a,b,c){if(!b||!b.attributes||!a){if(null!=c)for(var e of a??[])c.add(e);
return!0}b=b.attributes;e=!1;for(const f of a)if(!(f in b))if(e=!0,null!=c)c.add(f);else break;return e}const ea=/^([0-9_])/,fa=/[^a-z0-9_\u0080-\uffff]+/gi,P="field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" "),Q=["field","normalizationField"],t=new Set,ha=["oid","global-id","guid"],ia=["oid","global-id"],ja=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,
/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],n=(()=>"isInteger"in Number?Number.isInteger:a=>"number"===typeof a&&isFinite(a)&&Math.floor(a)===a)(),R=["integer","small-integer","single","double"],da=new Set([...R,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]),S=["date","date-only","time-only","timestamp-offset"],ka=new Set([...S,"esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly",
"esriFieldTypeTimestampOffset"]);d.NumericRangeValidationError=void 0;(d.NumericRangeValidationError||(d.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range";d.TypeValidationError=void 0;(d.TypeValidationError||(d.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";const p={min:-32768,max:32767,isInteger:!0},q={min:-2147483648,max:2147483647,isInteger:!0},M={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0},r={min:-3.4E38,
max:1.2E38,isInteger:!1},N={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};d.bigIntegerRange=M;d.collectArcadeFieldNames=g;d.collectElevationFields=E;d.collectFeatureReductionFields=async function(a,b,c){if(b&&c&&"fields"in c){var e=[];e.push(F(a,b,c.popupTemplate));c.fields&&e.push(...c.fields.map(async f=>{f.onStatisticExpression?g(a,b.fieldsIndex,f.onStatisticExpression.expression):a.add(f.onStatisticField)}));await Promise.all(e)}};d.collectField=l;d.collectFields=k;d.collectFilterFields=
async function(a,b,c){b&&(b.timeInfo&&null!=c&&c.timeExtent&&k(a,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]),b.floorInfo&&k(a,b.fieldsIndex,[b.floorInfo.floorField]),null!=c&&null!=c.where&&await D(a,b.fieldsIndex,c.where))};d.collectLabelingFields=I;d.collectOrderByInfos=async function(a,b,c){b&&c&&await Promise.all(c.map(e=>X(a,b,e)))};d.collectPopupTemplateFields=F;d.dateTypes=S;d.doubleRange=N;d.featureHasFields=function(a,b){return!O(a,b,null)};d.fixFields=h;d.fixRendererFields=
function(a,b){if(null!=a&&null!=b)for(const c of Array.isArray(a)?a:[a])if(C(P,c,b),"visualVariables"in c&&c.visualVariables)for(const e of c.visualVariables)C(Q,e,b)};d.fixTimeInfoFields=function(a,b){if(null!=a&&b?.fields?.length)if("startField"in a){var c=b.get(a.startField);b=b.get(a.endField);a.startField=c?.name??null;a.endField=b?.name??null}else c=b.get(a.startTimeField),b=b.get(a.endTimeField),a.startTimeField=c?.name??null,a.endTimeField=b?.name??null};d.getDisplayFieldName=function({displayField:a,
fields:b}){if(a)return a;if(!b||!b.length)return null;if(!(a=u(b,"name-or-title")||u(b,"unique-identifier")||u(b,"type-or-category")))a:{for(const c of b)if(c&&c.name&&(b=c.name.toLowerCase(),b.includes("name")||b.includes("title"))){a=c.name;break a}a=null}return a};d.getEditTrackingFields=w;d.getElevationFields=async function(a){if(!a)return[];const b=new Set;await E(b,a);return Array.from(b).sort()};d.getExpressionFields=async function(a,b){const c=new Set;for(const e of b)await g(c,a.fieldsIndex,
e);return Array.from(c).sort()};d.getFeatureEditFields=function(a){return a?h(a.fieldsIndex,w(a)):[]};d.getFeatureGeometryFields=G;d.getFieldDefaultValue=function(a){const b=a.defaultValue;if(void 0!==b&&y(a,b))return b;if(a.nullable)return null};d.getFieldRange=function(a){const b=m.getDomainRange(a.domain);if(b)return b;if(z(a))return A(a.type)};d.getLabelingFields=async function(a){if(!a)return[];const b=new Set;await I(b,a);return Array.from(b).sort()};d.getLowerCaseDefaultHiddenFields=H;d.getLowerCaseEditTrackingFields=
v;d.getNumericTypeForValue=function(a){if(!x(a))return null;if(n(a)){if(a>=p.min&&a<=p.max)return"esriFieldTypeSmallInteger";if(a>=q.min&&a<=q.max)return"esriFieldTypeInteger"}return a>=r.min&&a<=r.max?"esriFieldTypeSingle":"esriFieldTypeDouble"};d.getTimeFields=async function(a){if(!a)return[];const b="timeInfo"in a&&a.timeInfo;return b?h(a.fieldsIndex,[a.trackIdField,b.startField,b.endField]):[]};d.integerRange=q;d.isDateField=function(a){return null!=a&&ka.has(a.type)};d.isFieldEditable=function(a,
b){return a.editable&&!ha.includes(a.type)&&!v(b).includes(a.name?.toLowerCase()??"")};d.isFieldVisibleByDefault=function(a,b){const c=a.name?.toLowerCase()??"";return!(null!=b?.objectIdField&&c===b.objectIdField.toLowerCase())&&!(null!=b?.globalIdField&&c===b.globalIdField.toLowerCase())&&!H(b).includes(c)&&!ia.includes(a.type)&&!ja.some(e=>e.test(c))};d.isNumberInRange=L;d.isNumericField=z;d.isRasterPixelValueField=function(a){return a?["raster.itempixelvalue","raster.servicepixelvalue"].some(b=>
a.toLowerCase().startsWith(b)):!1};d.isStringField=function(a){return null!=a&&("string"===a.type||"esriFieldTypeString"===a.type)};d.isValidFieldValue=function(a,b){return null===K(a,b)};d.isValueMatchingFieldType=y;d.normalizeFieldName=function(a){return null==a?null:a.trim().replaceAll(fa,"_").replace(ea,"F$1")||null};d.numericTypes=R;d.packFields=function(a,b,c=1){if(!b||!a)return[];if(b.includes("*"))return["*"];b=h(a,b);return b.length/a.fields.length>=c?["*"]:b};d.populateMissingFields=O;d.rendererFields=
P;d.sanitizeNullFieldValue=function(a){return null==a||"number"===typeof a&&isNaN(a)?null:a};d.singleRange=r;d.smallIntegerRange=p;d.unpackFieldNames=function(a,b){return null==b||null==a?[]:b.includes("*")?(a.fields??[]).map(c=>c.name):b};d.validateFieldValue=K;d.validationErrorToString=function(a,b,c){switch(a){case m.DomainValidationError.INVALID_CODED_VALUE:return`Value ${c} is not in the coded domain - field: ${b.name}, domain: ${JSON.stringify(b.domain)}`;case m.DomainValidationError.VALUE_OUT_OF_RANGE:return`Value ${c} is out of the range of valid values - field: ${b.name}, domain: ${JSON.stringify(b.domain)}`;
case d.TypeValidationError.INVALID_TYPE:return`Value ${c} is not a valid value for the field type - field: ${b.name}, type: ${b.type}, nullable: ${b.nullable}`;case d.NumericRangeValidationError.OUT_OF_RANGE:const {min:e,max:f}=A(b.type);return`Value ${c} is out of range for the number type - field: ${b.name}, type: ${b.type}, value range is ${e} to ${f}`}};d.visualVariableFields=Q;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/arrayUtils ../../../core/Error ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../RasterInfo ../RasterStorageInfo ./BaseRaster ./DBFParser ./pamParser ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags ../rasterFunctions/stretchUtils ../rasterTransforms/PolynomialTransform ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(K,B,y,O,F,G,aa,ba,P,Q,R,S,T,L,z,H,U,V,W,X,M,C){y=function(N){function I(){var b=N.apply(this,arguments)||this;b._files=null;b._headerInfo=null;b._bufferSize=1048576;b.datasetFormat="TIFF";return b}K._inherits(I,N);var v=I.prototype;v.open=async function(b){await this.init();var a=b?b.signal:null,{data:c}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:a});if(!c)throw new F("tiffraster:open","failed to open url "+this.url);this.datasetName=
this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));const {littleEndian:d,firstIFDPos:f,isBigTiff:h}=z.parseSignature(c);var e=[];await this._readIFDs(e,c,d,f,0,h?8:4,a);const {imageInfo:k,rasterInfo:g}=this._parseIFDs(e);a=z.getPyramidIFDs(e);c=z.getMaskIFDs(e);this._headerInfo={littleEndian:d,isBigTiff:h,ifds:e,pyramidIFDs:a,maskIFDs:c,...k};this._set("rasterInfo",g);if(!k.isSupported)throw new F("tiffraster:open","this tiff is not supported: "+k.message);if(!k.tileWidth)throw new F("tiffraster:open",
"none-tiled tiff is not optimized for access, convert to COG and retry.");a=e[0].get("PREDICTOR")?.values?.[0];if(3===e[0].get("SAMPLEFORMAT")?.values?.[0]&&2===a)throw new F("tiffraster:open","unsupported horizontal difference encoding. Predictor\x3d3 is supported for floatting point data");({skipExtensions:e=[]}=this.ioConfig);e.includes("aux.xml")||(a=await this._fetchAuxiliaryMetaData(b),null!=a&&this._processPAMInfo(a,g));e.includes("vat.dbf")||1!==g.bandCount||"u8"!==g.pixelType||(g.attributeTable=
await this._fetchAuxiliaryTable(b),null!=g.attributeTable&&(g.keyProperties.DataType="thematic"));this.updateTileInfo()};v.fetchRawTile=async function(b,a,c,d={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(b,a,c))return null;const f=await this._fetchRawTiffTile(b,a,c,!1,d);null!=f&&this._headerInfo.hasMaskBand&&(b=await this._fetchRawTiffTile(b,a,c,!0,d),null!=b&&b.pixels[0]instanceof Uint8Array&&(f.mask=b.pixels[0]));return f};v._parseIFDs=function(b){const a=z.getImageInfo(b),{width:c,
height:d,tileWidth:f,tileHeight:h,planes:e,pixelType:k,compression:g,firstPyramidLevel:t,maximumPyramidLevel:w,pyramidBlockWidth:x,pyramidBlockHeight:n,tileBoundary:u,affine:l,metadata:r}=a;let p=L.parseSpatialReference(a.extent.spatialReference?.wkt||a.extent.spatialReference?.wkid);var q=!!a.isPseudoGeographic;null==p&&(q=!0,p=new X({wkid:3857}));const m=new M({...a.extent,spatialReference:p});var D=m?new C({x:m.xmin,y:m.ymax,spatialReference:p}):new C({x:0,y:0});D=new R({blockWidth:f,blockHeight:h,
pyramidBlockWidth:x,pyramidBlockHeight:n,compression:g,origin:D,firstPyramidLevel:t,maximumPyramidLevel:w,blockBoundary:u});const Y=new C({x:(m.xmax-m.xmin)/c,y:(m.ymax-m.ymin)/d,spatialReference:p}),Z=r?{BandProperties:r.bandProperties,DataType:r.dataType}:{};let J=null;var E=b[0].get("PHOTOMETRICINTERPRETATION")?.values?.[0];b=b[0].get("COLORMAP")?.values;if(3>=E&&3<b?.length&&0===b.length%3){J=[];E=b.length/3;for(let A=0;A<E;A++)J.push([A,b[A]>>>8,b[A+E]>>>8,b[A+2*E]>>>8])}q=new Q({width:c,height:d,
bandCount:e,pixelType:k,pixelSize:Y,storageInfo:D,spatialReference:p,isPseudoSpatialReference:q,keyProperties:Z,extent:m,colormap:J,statistics:r?r.statistics:null});l?.length&&(q.nativeExtent=new M({xmin:-.5,ymin:.5-d,xmax:c-.5,ymax:.5,spatialReference:p}),q.transform=new V({polynomialOrder:1,forwardCoefficients:[l[2]+l[0]/2,l[5]-l[3]/2,l[0],l[3],-l[1],-l[4]]}),q.extent=q.transform.forwardTransform(q.nativeExtent),q.pixelSize=new C({x:(m.xmax-m.xmin)/c,y:(m.ymax-m.ymin)/d,spatialReference:p}),D.origin.x=
-.5,D.origin.y=.5);return{imageInfo:a,rasterInfo:q}};v._processPAMInfo=function(b,a){a.statistics=b.statistics??a.statistics;(a.histograms=b.histograms)&&null==a.statistics&&(a.statistics=U.estimateStatisticsFromHistograms(b.histograms));if(b.transform&&null==a.transform){a.transform=b.transform;a.nativeExtent=a.extent;const c=a.transform.forwardTransform(a.nativeExtent);a.pixelSize=new C({x:(c.xmax-c.xmin)/a.width,y:(c.ymax-c.ymin)/a.height,spatialReference:a.spatialReference});a.extent=c}a.isPseudoSpatialReference&&
b.spatialReference&&(a.spatialReference=b.spatialReference,a.extent.spatialReference=a.nativeExtent.spatialReference=a.storageInfo.origin.spatialReference=a.spatialReference)};v._readIFDs=async function(b,a,c,d,f,h=4,e){if(!d)return null;if(d>=a.byteLength||0>d)a=(await this.request(this.url,{range:{from:d+f,to:d+f+this._bufferSize},responseType:"array-buffer",signal:e})).data,f=d+f,d=0;d=await this._readIFD(a,c,d,f,H.TIFF_TAGS,h,e);b.push(d.ifd);if(!d.nextIFD)return null;await this._readIFDs(b,a,
c,d.nextIFD-f,f,h,e)};v._readIFD=async function(b,a,c,d,f=H.TIFF_TAGS,h=4,e){if(!b)return null;c=z.parseIFD(b,a,c,d,f,h);if(c.success){const k=[];c.ifd?.forEach(g=>{g.values||k.push(g)});0<k.length&&(h=k.map(g=>g.offlineOffsetSize).filter(O.isSome),f=Math.min.apply(null,h.map(g=>g[0])),Math.min.apply(null,h.map(g=>g[0]+g[1]))-f<=this._bufferSize&&({data:h}=await this.request(this.url,{range:{from:f,to:f+this._bufferSize},responseType:"array-buffer",signal:e}),b=h,d=f,k.forEach(g=>z.parseFieldValues(b,
a,g,d))));c.ifd?.has("GEOKEYDIRECTORY")&&(f=c.ifd.get("GEOKEYDIRECTORY"),(h=f?.values)&&4<h.length&&(h=h[0]+"."+h[1]+"."+h[2],e=await this._readIFD(b,a,f.valueOffset+6-d,d,H.GEO_KEYS,2,e),f.data=e.ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[h]})));return c}if(c.requiredBufferSize&&c.requiredBufferSize!==b.byteLength)return b=(await this.request(this.url,{range:{from:d,to:d+c.requiredBufferSize+4},responseType:"array-buffer",signal:e})).data,b.byteLength<
c.requiredBufferSize?null:this._readIFD(b,a,0,d,H.TIFF_TAGS,4,e)};v._fetchRawTiffTile=async function(b,a,c,d,f={}){a=this._getTileLocation(b,a,c,d);if(!a)return null;const {ranges:h,actualTileWidth:e,actualTileHeight:k,ifd:g}=a;a=h.map(n=>this.request(this.url,{range:n,responseType:"array-buffer",signal:f.signal}));a=await Promise.all(a);c=a.map(n=>n.data.byteLength).reduce((n,u)=>n+u);c=1===a.length?a[0].data:new ArrayBuffer(c);d=[0];var t=[0];if(1<a.length){const n=new Uint8Array(c);for(let u=0,
l=0;u<a.length;u++){const r=a[u].data;n.set(new Uint8Array(r),l);d[u]=l;l+=r.byteLength;t[u]=r.byteLength}}const {blockWidth:w,blockHeight:x}=this.getBlockWidthHeight(b);b=await this.decodePixelBlock(c,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:g,offsets:d,sizes:t},width:w,height:x,planes:null,pixelType:null});if(null==b)return null;if(e!==w||k!==x)if(t=b.mask)for(a=0;a<x;a++)for(d=a*w,c=a<k?e:0;c<w;c++)t[d+c]=0;else for(t=new Uint8Array(w*x),b.mask=t,a=0;a<k;a++)for(d=a*w,c=0;c<
e;c++)t[d+c]=1;return b};v._getTileLocation=function(b,a,c,d=!1){const {firstPyramidLevel:f,blockBoundary:h}=this.rasterInfo.storageInfo;var e=0===b?0:b-(f-1);({_headerInfo:b}=this);if(!b)return null;d=d?b.maskIFDs[e]:0===e?b?.ifds[0]:b?.pyramidIFDs[e-1];if(!d)return null;var k=z.isBSQConfig(d,b);b=d.get("TILEOFFSETS")?.values;if(void 0===b)return null;const g=d.get("TILEBYTECOUNTS")?.values,{minRow:t,minCol:w,maxRow:x,maxCol:n}=h[e];if(a>x||c>n||a<t||c<w)return null;e=d.get("IMAGEWIDTH")?.values?.[0];
const u=d.get("IMAGELENGTH")?.values?.[0],l=d.get("TILEWIDTH")?.values?.[0],r=d.get("TILELENGTH")?.values?.[0],p=[];if(k){({bandCount:k}=this.rasterInfo);for(let q=0;q<k;q++){const m=q*(x+1)*(n+1)+a*(n+1)+c;p[q]={from:b[m],to:b[m]+g[m]-1}}}else k=a*(n+1)+c,p.push({from:b[k],to:b[k]+g[k]-1});for(b=0;b<p.length;b++)if(null==p[b].from||!p[b].to)return null;return{ranges:p,ifd:d,actualTileWidth:c===n?e%l||l:l,actualTileHeight:a===x?u%r||r:r}};v._fetchAuxiliaryMetaData=async function(b){try{const {data:a}=
await this.request(this.url+".aux.xml",{responseType:"xml",signal:b?.signal});return L.parsePAMInfo(a)}catch{return null}};v._fetchAuxiliaryTable=async function(b){try{const {data:a}=await this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:b?.signal}),c=T.parse(a);return c?.recordSet?W.fromJSON(c.recordSet):null}catch{return null}};return K._createClass(I)}(S);B.__decorate([G.property()],y.prototype,"_files",void 0);B.__decorate([G.property()],y.prototype,"_headerInfo",void 0);B.__decorate([G.property()],
y.prototype,"_bufferSize",void 0);B.__decorate([G.property({type:String,json:{write:!0}})],y.prototype,"datasetFormat",void 0);return y=B.__decorate([P.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],y)});
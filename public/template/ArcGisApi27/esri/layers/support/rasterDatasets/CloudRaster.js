// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../LOD ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ./DBFParser ../rasterTransforms/utils ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(H,z,t,A,I,Z,aa,ba,N,O,P,Q,R,S,T,J,U,V,W,K){const p=new Map;p.set("int16","esriFieldTypeSmallInteger");p.set("int32","esriFieldTypeInteger");p.set("int64","esriFieldTypeInteger");p.set("float32","esriFieldTypeSingle");p.set("float64","esriFieldTypeDouble");p.set("text","esriFieldTypeString");t=function(L){function B(){var a=L.apply(this,arguments)||this;a.storageInfo=null;a.datasetFormat="CRF";return a}H._inherits(B,L);var k=B.prototype;k.open=async function(a){await this.init();({data:a}=
await this.request(this.url+"/conf.json",{signal:a?.signal}));if(!this._validateHeader(a))throw new A("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {storageInfo:b,rasterInfo:c}=this._parseHeader(a);"thematic"===c.dataType&&(a=await this._fetchAuxiliaryInformation(),c.attributeTable=a);this._set("storageInfo",b);this._set("rasterInfo",c);this.ioConfig.retryCount=this.ioConfig.retryCount||0};k.fetchRawTile=async function(a,
b,c,e={}){var {transposeInfo:g}=this.rasterInfo.storageInfo,{transposedVariableName:d}=e;a=(g=!(!g||!d))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-a;if(0>a)return null;d=this._buildCacheFilePath(a,b,c,e.multidimensionalDefinition,d);b=this._getIndexRecordFromBundle(b,c,g);c=await this.request(d,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:e.signal});if(!c)return null;c=new Uint8Array(c.data);b=this._getTileEndAndContentType(c,b);if(0===b.recordSize)return null;
e=await this.request(d,{range:{from:b.position,to:b.position+b.recordSize},responseType:"array-buffer",signal:e.signal});if(!e)return null;const [l,u]=this._getTileSize(g);return this.decodePixelBlock(e.data,{width:l,height:u,planes:null,pixelType:null,returnInterleaved:g})};k._validateHeader=function(a){const b="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");return a&&"RasterInfo"===a.type&&!b.some(c=>!a[c])};k._parseHeader=
function(a){var b="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType];const {bandCount:c,histograms:e,colormap:g,blockWidth:d,blockHeight:l,firstPyramidLevel:u,maximumPyramidLevel:C}=a,X=a.statistics&&a.statistics.map(r=>({min:r.min,max:r.max,avg:r.mean,stddev:r.standardDeviation,median:r.median,mode:r.mode}));var n=a.extent.spatialReference,h=a.geodataXform?.spatialReference;n=new V(n?.wkid||n?.wkt?n:h);h=new W({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,
spatialReference:n});const v=new K({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:n}),w=Math.round((h.xmax-h.xmin)/v.x),x=Math.round((h.ymax-h.ymin)/v.y),y=this._parseTransform(a.geodataXform),Y=y?h:null;y&&(h=y.forwardTransform(h),v.x=(h.xmax-h.xmin)/w,v.y=(h.ymax-h.ymin)/x);const D=a.properties??{};var E=a.format.toLowerCase().replace("cache/","");const M=new K(a.origin.x,a.origin.y,n);let F;var f;if(g&&g.colors)for(F=[],f=0;f<g.colors.length;f++){var m=g.colors[f];var q=g.values?g.values[f]:f;
F.push([q,m&255,m<<16>>>24,m<<8>>>24,m>>>24])}m=a.LODInfos;q=[];for(f=0;f<m.levels.length;f++)q.push(new O({level:m.levels[f],resolution:m.resolutions[f],scale:96/.0254*m.resolutions[f]}));m=new R({dpi:96,lods:q,format:E,origin:M,size:[d,l],spatialReference:n});E={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*a.packetSize*8+64};q=[{maxCol:Math.ceil(w/d)-1,maxRow:Math.ceil(x/l)-1,minCol:0,minRow:0}];let G=2;if(0<C)for(f=0;f<C;f++)q.push({maxCol:Math.ceil(w/G/d)-1,maxRow:Math.ceil(x/
G/l)-1,minCol:0,minRow:0}),G*=2;a=a.mdInfo;f=null;a&&D._yxs&&(f=D._yxs,f={packetSize:f.PacketSize,tileSize:[f.TileXSize,f.TileYSize]});b=new P({width:w,height:x,pixelType:b,bandCount:c,extent:h,nativeExtent:Y,transform:y,spatialReference:n,pixelSize:v,keyProperties:D,statistics:X,histograms:e,multidimensionalInfo:a,colormap:F,storageInfo:new Q({blockWidth:d,blockHeight:l,pyramidBlockWidth:d,pyramidBlockHeight:l,origin:M,tileInfo:m,transposeInfo:f,firstPyramidLevel:u,maximumPyramidLevel:C,blockBoundary:q})});
return{storageInfo:E,rasterInfo:b}};k._parseTransform=function(a){if(!J.isTransformSupported(a))throw new A("cloudraster:open","the data contains unsupported geodata transform types");a=J.readTransform(a);if("identity"===a.type)return null;if("polynomial"!==a.type||!a.forwardCoefficients?.length||!a.inverseCoefficients?.length)throw new A("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return a};k._fetchAuxiliaryInformation=
async function(a){var b=this.request(this.url+"/conf.vat.json",{signal:a}).then(e=>e.data).catch(()=>null);a=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:a}).then(e=>e.data).catch(()=>null);b=await Promise.all([b,a]);let c;if(b[0]){a=b[0].fields;const e=b[0].values;if(a&&e){a=a.map(d=>({type:"OID"===d.name?"esriFieldTypeOID":p.get(d.type),name:d.name,alias:d.alias||d.name}));const g=e.map(d=>({attributes:d}));a&&e&&(c={fields:a,features:g})}}!c&&b[1]&&(c=T.parse(b[1]).recordSet);
return U.fromJSON(c)};k._buildCacheFilePath=function(a,b,c,e,g){var d=this._getPackageSize(!!g);c=Math.floor(c/d)*d;b="R"+this._toHexString4(Math.floor(b/d)*d)+"C"+this._toHexString4(c);d="L";d=10<=a?d+a.toString():d+("0"+a.toString());({multidimensionalInfo:a}=this.rasterInfo);const l=e?.[0];if(null==a||!l)return`${this.url}/_alllayers/${d}/${b}.bundle`;e="_yxs";if(!g){e=a.variables.find(u=>u.name===l.variableName).dimensions[0].values.indexOf(l.values[0]).toString(16);a=4-e.length;for(c=0;c<a;c++)e=
"0"+e;e="S"+e}g=this._getVariableFolderName(g||l.variableName);return`${this.url}/_alllayers/${g}/${e}/${d}/${b}.bundle`};k._getPackageSize=function(a=!1){const {transposeInfo:b}=this.rasterInfo.storageInfo;return a&&null!=b?b.packetSize??0:this.storageInfo.packetSize};k._getTileSize=function(a=!1){const {storageInfo:b}=this.rasterInfo,{transposeInfo:c}=b;return a&&null!=c?c.tileSize:b.tileInfo.size};k._getVariableFolderName=function(a){a=a.trim();return""===a?"_v":a.replaceAll(/[\{|\}\-]/g,"_").replace("\\*",
"_v")};k._getIndexRecordFromBundle=function(a,b,c=!1){c=this._getPackageSize(c);a=a%c*c+b%c;if(0>a)throw Error("Invalid level / row / col");return a*this.storageInfo.recordSize+64};k._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;let c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;const e=b&0xffffffffff;b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-5);return{position:e,recordSize:b&0xffffffffff}};k._toHexString4=function(a){a=a.toString(16);if(4!==a.length){let b=4-a.length;for(;0<b--;)a="0"+a}return a};
return H._createClass(B)}(S);z.__decorate([I.property({readOnly:!0})],t.prototype,"storageInfo",void 0);z.__decorate([I.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0);return t=z.__decorate([N.subclass("esri.layers.support.rasterDatasets.CloudRaster")],t)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./BaseRaster ../rasterFunctions/pixelUtils ../../../rest/support/FeatureSet".split(" "),function(v,q,y,r,p,D,E,z,A,B,C){p=function(w){function u(){var f=w.apply(this,arguments)||this;f.datasetFormat="Function";f.tileType=
"Raster";f.rasterFunction=null;return f}v._inherits(u,w);var t=u.prototype;t.open=async function(f){await this.init();const {rasterFunction:b}=this;this.primaryRasters?.rasters?.length?b.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=b.getPrimaryRasters(),this.rasterJobHandler&&this.primaryRasters.rasters?.forEach(a=>a.rasterJobHandler=this.rasterJobHandler));const {rasters:k,rasterIds:c}=this.primaryRasters;var g=k.map(a=>a.rasterInfo?void 0:a.open(f));await Promise.all(g);g=k.map(({rasterInfo:a})=>
a);var l=b.bind({rasterInfos:g,rasterIds:c});if(!l.success||0===g.length)throw new y("raster-function:open",`cannot bind the function: ${l.error??""}`);l="Table"===b.functionName?b:b.functionArguments?.raster;"Table"===l?.functionName&&(b.rasterInfo.attributeTable=C.fromJSON(l.functionArguments.attributeTableAsRecordSet));await this.syncJobHandler();const d=g[0];this.hasUniqueSourceStorageInfo=1===g.length||g.slice(1).every(a=>this._hasSameStorageInfo(a,d));this.set("sourceJSON",k[0].sourceJSON);
this.set("rasterInfo",b.rasterInfo)};t.syncJobHandler=async function(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)};t.fetchPixels=async function(f,b,k,c={}){const {rasters:g,rasterIds:l}=this.primaryRasters;var d=!1,{interpolation:a}=c,e=this.rasterFunction.flatWebGLFunctionChain?.hasSurfaceFunction;!c.requestRawData&&"bilinear"!==a&&e&&(d=1===g.length&&!c.skipRasterFunction,c={...c,interpolation:"bilinear",requestRawData:d});e=g.map(m=>m.fetchPixels(f,b,k,c));e=await Promise.all(e);
var h=e.map(m=>m.pixelBlock),n=d||c.requestRawData?e.map(m=>m.srcTilePixelSize):null;if(c.skipRasterFunction||h.every(m=>null==m))return e[0];const x=e.find(m=>null!=m.pixelBlock)?.extent??f;h=this.rasterJobHandler?await this.rasterJobHandler.process({extent:x,primaryPixelBlocks:h,primaryPixelSizes:n,primaryRasterIds:l}):this.rasterFunction.process({extent:x,primaryPixelBlocks:h,primaryPixelSizes:n,primaryRasterIds:l});({transformGrid:n}=e[0]);if(!d||null==h||null==n)return{...e[0],pixelBlock:h};
d={rows:n.spacing[0],cols:n.spacing[1]};a=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[h],srcMosaicSize:{width:h.width,height:h.height},destDimension:{width:b,height:k},coefs:n.coefficients,sampleSpacing:d,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:a,alignmentInfo:void 0,blockWidths:null},c)).pixelBlock:B.approximateTransform(h,{width:b,height:k},n.coefficients,d,a);return{extent:f,srcExtent:e[0].srcExtent,pixelBlock:a}};t._hasSameStorageInfo=
function(f,b){const {storageInfo:k,pixelSize:c,spatialReference:g,extent:l}=f,{storageInfo:d,pixelSize:a,spatialReference:e,extent:h}=b;return c.x===a.x&&c.y===a.y&&g.equals(e)&&l.equals(h)&&k.blockHeight===d.blockHeight&&k.blockWidth===d.blockWidth&&k.maximumPyramidLevel===d.maximumPyramidLevel};return v._createClass(u)}(A);q.__decorate([r.property({type:String,json:{write:!0}})],p.prototype,"datasetFormat",void 0);q.__decorate([r.property()],p.prototype,"tileType",void 0);q.__decorate([r.property()],
p.prototype,"rasterFunction",void 0);q.__decorate([r.property()],p.prototype,"primaryRasters",void 0);return p=q.__decorate([z.subclass("esri.layers.support.rasterDatasets.FunctionRaster")],p)});
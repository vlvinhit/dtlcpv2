// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/Accessor ../../core/ByteSizeUnit ../../core/Error ../../core/handleUtils ../../core/LRUCache ../../core/PooledArray ../../core/promiseUtils ../../core/reactiveUtils ../../core/scheduling ../../core/urlUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ./TileKey ./Tilemap".split(" "),
function(g,y,q,C,D,E,w,F,G,H,r,z,I,J,t,M,N,O,K,L,u){var p;g.TilemapCache=p=function(A){function v(a){a=A.call(this,a)||this;a._pendingTilemapRequests={};a.request=C;a.size=32;a._prefetchingEnabled=!0;return a}y._inherits(v,A);var l=v.prototype;l.initialize=function(){this._tilemapCache=new G.LRUCache(2*E.ByteSizeUnit.MEGABYTES);this.addHandles([z.watch(()=>{const {layer:a}=this;return[a?.parsedUrl,a?.tileServers,a?.apiKey,a?.customParameters]},()=>this._initializeTilemapDefinition(),z.initial)])};
l.fetchTilemap=function(a,c,d,b){if(!this.layer.tileInfo.lodAt(a)||a<this.effectiveMinLOD||a>this.effectiveMaxLOD)return Promise.reject(new w("tilemap-cache:level-unavailable",`Level ${a} is unavailable in the service`));const e=this._tmpTilemapDefinition;if(a=this._tilemapFromCache(a,c,d,e))return Promise.resolve(a);const m=b&&b.signal;b={...b,signal:null};return new Promise((n,f)=>{r.onAbort(m,()=>f(r.createAbortError()));const h=u.tilemapDefinitionId(e);let k=this._pendingTilemapRequests[h];if(!k){k=
u.Tilemap.fromDefinition(e,b).then(x=>{this._tilemapCache.put(h,x,x.byteSize);return x});const B=()=>delete this._pendingTilemapRequests[h];this._pendingTilemapRequests[h]=k;k.then(B,B)}k.then(n,f)})};l.getAvailability=function(a,c,d){return!this.layer.tileInfo.lodAt(a)||a<this.effectiveMinLOD||a>this.effectiveMaxLOD?"unavailable":(a=this._tilemapFromCache(a,c,d,this._tmpTilemapDefinition))?a.getAvailability(c,d):"unknown"};l.fetchAvailability=function(a,c,d,b){return!this.layer.tileInfo.lodAt(a)||
a<this.effectiveMinLOD||a>this.effectiveMaxLOD?Promise.reject(new w("tile-map:tile-unavailable","Tile is not available",{level:a,row:c,col:d})):this.fetchTilemap(a,c,d,b).catch(e=>e).then(e=>{if(e instanceof u.Tilemap){e=e.getAvailability(c,d);if("unavailable"===e)throw new w("tile-map:tile-unavailable","Tile is not available",{level:a,row:c,col:d});return e}if(r.isAbortError(e))throw e;return"unknown"})};l.fetchAvailabilityUpsample=function(a,c,d,b,e){b.level=a;b.row=c;b.col=d;const m=this.layer.tileInfo;
m.updateTileInfo(b);const n=this.fetchAvailability(a,c,d,e).catch(f=>{if(r.isAbortError(f))throw f;if(m.upsampleTile(b))return this.fetchAvailabilityUpsample(b.level,b.row,b.col,b,e);throw f;});this._fetchAvailabilityUpsamplePrefetch(b.id,a,c,d,e,n);return n};l._fetchAvailabilityUpsamplePrefetch=async function(a,c,d,b,e,m){if(this._prefetchingEnabled&&null!=a){var n=`prefetch-${a}`;if(!this.hasHandles(n)){var f=new AbortController;m.then(()=>f.abort(),()=>f.abort());var h=!1;m=F.makeHandle(()=>{h||
(h=!0,f.abort())});this.addHandles(m,n);await I.waitTicks(10,f.signal).catch(()=>{});h||(h=!0,this.removeHandles(n));if(!r.isAborted(f))for(a=new L.TileKey(a,c,d,b),e={...e,signal:f.signal},c=this.layer.tileInfo,d=0;p._prefetches.length<p._maxPrefetch&&c.upsampleTile(a);++d){const k=this.fetchAvailability(a.level,a.row,a.col,e);p._prefetches.push(k);b=()=>{p._prefetches.removeUnordered(k)};k.then(b,b)}}}};l._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var {parsedUrl:a,apiKey:c,
customParameters:d}=this.layer;this._tilemapCache.clear();this._tmpTilemapDefinition={service:{url:a.path,query:J.objectToQuery({...a.query,...d,token:c??a.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}};l._tilemapFromCache=function(a,c,d,b){b.level=a;b.row=c-c%this.size;b.col=d-d%this.size;a=u.tilemapDefinitionId(b);return this._tilemapCache.get(a)};y._createClass(v,[{key:"effectiveMinLOD",get:function(){return this.minLOD??
this.layer.tileInfo.lods[0].level}},{key:"effectiveMaxLOD",get:function(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}},{key:"test",get:function(){const a=this;return{get prefetchingEnabled(){return a._prefetchingEnabled},set prefetchingEnabled(c){a._prefetchingEnabled=c},hasTilemap(c,d,b){return!!a._tilemapFromCache(c,d,b,a._tmpTilemapDefinition)}}}}]);return v}(D);g.TilemapCache._maxPrefetch=4;g.TilemapCache._prefetches=new H({initialSize:p._maxPrefetch});
q.__decorate([t.property({constructOnly:!0})],g.TilemapCache.prototype,"layer",void 0);q.__decorate([t.property({constructOnly:!0})],g.TilemapCache.prototype,"minLOD",void 0);q.__decorate([t.property({constructOnly:!0})],g.TilemapCache.prototype,"maxLOD",void 0);q.__decorate([t.property({constructOnly:!0})],g.TilemapCache.prototype,"request",void 0);q.__decorate([t.property({constructOnly:!0})],g.TilemapCache.prototype,"size",void 0);g.TilemapCache=p=q.__decorate([K.subclass("esri.layers.support.TilemapCache")],
g.TilemapCache);Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../PixelBlock","../rasterFormats/pixelRangeUtils","../../../renderers/support/stretchRendererUtils"],function(z,C,E,K,L){function F(b,e=256){e=Math.min(e,256);const {size:m,counts:h}=b;b=new Uint8Array(m);var l=h.reduce((d,a)=>d+a/e,0);let p=0;var c=0;let g=0,k=l;for(let d=0;d<m;d++)if(g+=h[d],!(d<m-1&&g+h[d+1]<k)){for(;p<e-1&&k<g;)p++,k+=l;for(;c<=d;c++)b[c]=p;c=d+1}for(l=c;l<m;l++)b[l]=e-1;return b}function G(b,e){b=Math.min(Math.max(b,-100),100);e=Math.min(Math.max(e??
0,-100),100);let m=0,h=0;const l=new Uint8Array(256);for(m=0;256>m;m++)0<b&&100>b?h=(200*m-25500+510*e)/(2*(100-b))+128:0>=b&&-100<b?h=(200*m-25500+510*e)*(100+b)/2E4+128:100===b?(h=200*m-25500+256*(100-b)+510*e,h=0<h?255:0):-100===b&&(h=128),l[m]=255<h?255:0>h?0:h;return l}function M(b,e,m,h){let l=Infinity,p=-Infinity;var c=0,g=0;const k=b.length;for(var d=0;d<k;d++){var a=b[d];if(!e||e[d])l=a<l?a:l,p=a>p?a:p,c+=a,g++}if(0===g)return{statistics:{min:0,max:0,avg:0,stddev:0},histogram:null};c/=g;
d=0;for(a=0;a<k;a++)if(!e||e[a])d+=(b[a]-c)**2;a=e?e.filter(x=>x).length:k;c={min:l,max:p,avg:c,stddev:1>=a?0:Math.sqrt(d/(a-1))};if(!h)return{statistics:c,histogram:null};if(["u8","s8","u4","u2","u1"].includes(m)){g=p-l+1;m=new Uint32Array(g);for(h=0;h<k;h++)e&&!e[h]||m[b[h]-l]++;return{statistics:c,histogram:{min:l-.5,max:p+.5,size:g,counts:m}}}m=new Uint32Array(256);h=(p-l)/256;if(0===h)return{statistics:c,histogram:{min:l,max:p,size:1,counts:(new Uint32Array(1)).fill(g)}};g=new Uint32Array(257);
for(d=0;d<k;d++)e&&!e[d]||g[Math.floor((b[d]-l)/h)]++;for(b=0;255>b;b++)m[b]=g[b];m[255]=g[255]+g[256];return{statistics:c,histogram:{min:l,max:p,size:256,counts:m}}}function H(b){if(null==b||!b.pixels?.length)return null;const {pixels:e,mask:m,bandMasks:h,pixelType:l}=b,p=b.width*b.height,c=e.length;let g,k;let d;var a;const x=[],y=[];for(d=0;d<c;d++){var f=new Uint32Array(256);var q=e[d];var u=h?.[d]??m;if("u8"===l)if(g=-.5,k=255.5,u)for(a=0;a<p;a++)u[a]&&f[q[a]]++;else for(a=0;a<p;a++)f[q[a]]++;
else{a=!1;b.statistics||(b.updateStatistics(),a=!0);var w=b.statistics;g=w[d].minValue;k=w[d].maxValue;var n=(k-g)/256;if(0===n)for(!w||b.validPixelCount||a||b.updateStatistics(),n=(b.validPixelCount||b.width*b.height)/256,a=0;256>a;a++)f[a]=Math.round(n*(a+1))-Math.round(n*a);else{w=new Uint32Array(257);for(a=0;a<p;a++)u&&!u[a]||w[Math.floor((q[a]-g)/n)]++;for(a=0;255>a;a++)f[a]=w[a];f[255]=w[255]+w[256]}}x.push({min:g,max:k,size:256,counts:f});for(a=u=q=n=0;256>a;a++)n+=f[a],q+=a*f[a];q/=n;for(a=
0;256>a;a++)u+=f[a]*(a-q)**2;a=Math.sqrt(u/(n-1));n=(k-g)/256;f=(q+.5)*n+g;n*=a;y.push({min:g,max:k,avg:f,stddev:n})}return{statistics:y,histograms:x}}function N(b,e){if(null==e||0===e.length)return b;const m=Math.max.apply(null,e),{minCutOff:h,maxCutOff:l,outMin:p,outMax:c,histogramLut:g}=b;return h.length===e.length||h.length<=m?b:{minCutOff:e.map(k=>h[k]),maxCutOff:e.map(k=>l[k]),histogramLut:g?e.map(k=>g[k]):null,outMin:p,outMax:c}}function D(b,e){const m=new Float32Array(b);for(let h=0;h<b;h++)m[h]=
1<e[h]?2<e[h]?6.5+(e[h]-2)**2.5:6.5+100*(2-e[h])**4:1;return m}const O=[.299,.587,.114];z.computeGammaCorrection=D;z.computeGammaValues=function(b,e,m){const h=[];for(let k=0;k<e.length;k++){var l=0,p=0,c=0;"min"in e[k]?{min:l,max:p,avg:c}=e[k]:[l,p,c]=e[k];c=c??0;"u8"!==b&&(c=255*(c-l)/(p-l));m&&(c*=O[k]);l=h;p=l.push;if(0>=c||255<=c)c=1;else{var g=0;150!==c&&(g=150>=c?45*Math.cos(.01047*c):17*Math.sin(.021*c));g=Math.log((c+g)/255);0===g?c=1:(c=Math.log(c/255)/g,c=isNaN(c)?1:Math.min(9.9,Math.max(.01,
c)))}p.call(l,c)}return h};z.computeStatisticsHistograms=function(b){const {pixels:e,mask:m,pixelType:h,bandMasks:l}=b;var p=e.map((c,g)=>M(c,l?.[g]??m,h,!0));b=p.map(({statistics:c})=>c);p=p.map(({histogram:c})=>c);return{statistics:b,histograms:p}};z.createContrastBrightnessLUT=G;z.createHistogramEqualizationLUT=F;z.createStretchLUT=function(b){const {minCutOff:e,maxCutOff:m,gamma:h,pixelType:l,rounding:p}=b,c=b.outMin||0,g=b.outMax||255;if(!["u8","u16","s8","s16"].includes(l))return null;const k=
e.length;let d,a,x=0;"s8"===l?x=-127:"s16"===l&&(x=-32767);let y=256;["u16","s16"].includes(l)&&(y=65536);var f=[],q=[];const u=g-c;for(d=0;d<k;d++)q[d]=m[d]-e[d],f[d]=0===q[d]?0:u/q[d];let w;const n=[];let v,r;if(h&&h.length>=k)for(f=D(k,h),d=0;d<k;d++){r=[];for(a=0;a<y;a++)if(0===q[d])r[a]=c;else{var t=a+x;w=(t-e[d])/q[d];v=1;1<h[d]&&(v-=(1/u)**(w*f[d]));t<m[d]&&t>e[d]?(t=v*u*w**(1/h[d])+c,r[a]="floor"===p?Math.floor(t):"round"===p?Math.round(t):t):r[a]=t>=m[d]?g:c}n[d]=r}else for(d=0;d<k;d++){r=
[];for(a=0;a<y;a++)t=a+x,t<=e[d]?r[a]=c:t>=m[d]?r[a]=g:(q=(t-e[d])*f[d]+c,r[a]="floor"===p?Math.floor(q):"round"===p?Math.round(q):q);n[d]=r}if(null!=b.contrastOffset)for(b=G(b.contrastOffset,b.brightnessOffset),d=0;d<k;d++)for(r=n[d],a=0;a<y;a++)r[a]=b[r[a]];return{lut:n,offset:x}};z.estimateStatisticsFromHistograms=function(b){const e=[];for(let p=0;p<b.length;p++){const {min:c,max:g,size:k,counts:d}=b[p];let a=0;var m=0;for(var h=0;h<k;h++)a+=d[h],m+=h*d[h];m/=a;h=0;for(var l=0;l<k;l++)h+=d[l]*
(l-m)**2;l=(g-c)/k;e.push({min:c,max:g,avg:(m+.5)*l+c,stddev:Math.sqrt(h/(a-1))*l})}return e};z.estimateStatisticsHistograms=H;z.getStretchCutoff=function(b,e){const {pixelBlock:m,bandIds:h,returnHistogramLut:l,rasterInfo:p}=e;var c=null;e=null;var g=b.stretchType;"number"===typeof g&&(g=L.stretchTypeFunctionEnum[g]);b.dra?"minMax"===g&&null!=m&&m.statistics?c=m.statistics.map(t=>[t.minValue,t.maxValue,0,0]):(e=H(m),c=null!=e?e.statistics:null,e=null!=e?e.histograms:null):(c=0<b.statistics?.length?
b.statistics:p.statistics,e="histograms"in b?b.histograms:void 0,e||(e=p.histograms));"percentClip"!==g&&"histogramEqualization"!==g||e?.length||(g="minMax");var k=c?.length||e?.length||p.bandCount;const d=[],a=[];let x,y,f,q;c&&!Array.isArray(c[0])&&(c=c.map(t=>[t.min,t.max,t.avg,t.stddev]));const [u,w]=K.getPixelValueRange(p.pixelType);if(!c?.length){c=[];for(f=0;f<k;f++)c.push([u,w,1,1]);"standardDeviation"===g&&(g="minMax")}switch(g){case "none":for(f=0;f<k;f++)d[f]=u,a[f]=w;break;case "minMax":for(f=
0;f<k;f++){var n=c[f];d[f]=n[0];a[f]=n[1]}break;case "standardDeviation":for(f=0;f<k;f++)n=c[f],d[f]=n[2]-b.numberOfStandardDeviations*n[3],a[f]=n[2]+b.numberOfStandardDeviations*n[3],d[f]<n[0]&&(d[f]=n[0]),a[f]>n[1]&&(a[f]=n[1]);break;case "histogramEqualization":C.assertIsSome(e);for(f=0;f<k;f++)d[f]=e[f].min,a[f]=e[f].max;break;case "percentClip":C.assertIsSome(e);for(f=0;f<e.length;f++){c=e[f];x=new Uint32Array(c.size);var v=[...c.counts];20<=v.length&&(v[0]=v[1]=v[2]=v[v.length-1]=v[v.length-
2]=0);n=0;k=(c.max-c.min)/c.size;y=-.5===c.min&&1===k?.5:0;for(q=0;q<c.size;q++)n+=v[q],x[q]=n;v=(b.minPercent||0)*n/100;d[f]=c.min+y;for(q=0;q<c.size;q++)if(x[q]>v){d[f]=c.min+k*(q+y);break}v=(1-(b.maxPercent||0)/100)*n;a[f]=c.max+y;for(q=c.size-2;0<=q;q--)if(x[q]<v){a[f]=c.min+k*(q+2-y);break}a[f]<d[f]&&(c=d[f],d[f]=a[f],a[f]=c)}break;default:for(f=0;f<k;f++)n=c[f],d[f]=n[0],a[f]=n[1]}let r;"histogramEqualization"===g?(C.assertIsSome(e),g=e[0].size||256,b=0,l&&(r=e.map(t=>F(t)))):(g=b.max||255,
b=b.min||0);return N({minCutOff:d,maxCutOff:a,outMax:g,outMin:b,histogramLut:r},h)};z.stretch=function(b,e){if(null==b||!b.pixels?.length)return b;const {mask:m,bandMasks:h,width:l,height:p,pixels:c}=b,{minCutOff:g,maxCutOff:k,gamma:d}=e;var a=e.outMin||0;const x=e.outMax||255,y=l*p,f=e.outputPixelType||"u8";b=b.pixels.map(()=>E.createEmptyBand(f,y));const q=b.length;var u=x-a,w=[],n=[];for(var v=0;v<q;v++)n[v]=k[v]-g[v],w[v]=0===n[v]?0:u/n[v];v=f.startsWith("u")||f.startsWith("s");e=!!e.isRenderer;
if(d&&d.length>=q){w=D(q,d);for(var r=0;r<q;r++){var t=h?.[r]??m;for(let B=0;B<y;B++)if(null==t||t[B]){if(0===n[r]){b[r][B]=a;continue}var A=c[r][B];const I=(A-g[r])/n[r];let J=1;1<d[r]&&(J-=(1/u)**(I*w[r]));A<k[r]&&A>g[r]?(A=J*u*I**(1/d[r])+a,b[r][B]=e?Math.floor(A):v?Math.round(A):A):b[r][B]=A>=k[r]?x:a}}}else for(u=0;u<q;u++)for(n=h?.[u]??m,r=0;r<y;r++)if(null==n||n[r])t=c[u][r],t<k[u]&&t>g[u]?(t=(t-g[u])*w[u]+a,b[u][r]=e?Math.floor(t):v?Math.round(t):t):b[u][r]=t>=k[u]?x:a;a=new E({width:l,height:p,
mask:m,bandMasks:h,pixels:b,pixelType:f});a.updateStatistics();return a};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});
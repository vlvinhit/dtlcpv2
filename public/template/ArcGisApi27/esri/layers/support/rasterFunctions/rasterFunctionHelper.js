// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../core/colorUtils ../../../core/Error ../../../core/lang ./AspectFunction ./BandArithmeticFunction ./ColormapFunction ./CompositeBandFunction ./ConvolutionFunction ./CurvatureFunction ./ExtractBandFunction ./LocalFunction ./MaskFunction ./NDVIFunction ./RemapFunction ./SlopeFunction ./StatisticsHistogramFunction ./StretchFunction ./TableFunction".split(" "),function(n,w,p,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U){function x(a,c){({rasterFunctionArguments:a}=a);a&&(a.rasters||[a.raster]).forEach(b=>
{b&&"number"!==typeof b&&("string"===typeof b?b.startsWith("http")&&(c.includes(b)||c.push(b)):"rasterFunctionArguments"in b&&x(b,c))})}function y(a,c){return"rasters"===c[0]&&Array.isArray(a.rasters)?a.rasters:c.map(b=>a[b])}function z(a){return!!(a&&"object"===typeof a&&a.rasterFunction&&a.rasterFunctionArguments)}function t(a){const {rasterFunction:c,rasterFunctionArguments:b}=a,d={};for(const f in b){let g=b[f];var e=f.toLowerCase();if("rasters"===e&&Array.isArray(g))d.rasters=g.map(h=>z(h)?t(h):
h);else switch(z(g)&&(g=t(g)),e){case "dra":d.dra=g;break;case "pspower":d.psPower=g;break;case "pszfactor":d.psZFactor=g;break;case "bandids":d.bandIds=g;break;default:e=f[0].toLowerCase()+f.slice(1),d[e]=g}}"Local"!==c||d.rasters?.length||(d.rasters=["$$"]);return{...a,rasterFunctionArguments:d}}function A(a,c){const {rasterFunction:b,rasterFunctionArguments:d}=a;var e=a.outputPixelType?.toLowerCase();if(null==b||!k.has(b))throw new p("raster-function-helper",`unsupported raster function: ${b}`);
var f=k.get(b);a=("function"===typeof f.ctor?f.ctor:f.ctor["default"]).fromJSON({...a,outputPixelType:e});({rasterArgumentNames:e}=a);f=[];const g=y(d,e),h="rasters"===e[0],m=[];for(let q=0;q<g.length;q++){const l=g[q];let r;null==l||"string"===typeof l&&l.startsWith("$")?f.push(c?.raster):"string"===typeof l?c[l]&&f.push(c[l]):"number"!==typeof l&&"rasterFunction"in l&&(r=A(l,c),h||(a.functionArguments[e[q]]=r),f.push(r));h&&m.push(r??l)}h&&(a.functionArguments.rasters=m);c&&(a.sourceRasters=f,c=
c.raster?.url)&&(a.mainPrimaryRasterId=c);return a}function B(a,c){if(a&&c)for(const b in a){const d=a[b];d&&"object"===typeof d&&"type"in d&&("RasterFunctionTemplate"===d.type?B(d.arguments,c):"RasterFunctionVariable"===d.type&&null!=c[d.name]&&(d.value=c[d.name]))}}function u(a,c){if(!a||"object"!==typeof a)return a;const {value:b}=a;if(!b||"object"!==typeof b)return a.isDataset?"$$":b;if(Array.isArray(b))return 0===b.length?[]:b.map(e=>"object"===typeof e&&"RasterFunctionVariable"===e.type?u(e,
c):e);if("value"in b&&["number","string","boolean"].includes(typeof b.value))return b.value;if(a.isDataset&&"Scalar"!==b.type)return"$$";if(!("type"in b))return b;a=b;switch(b.type){case "Scalar":a=b.value;break;case "AlgorithmicColorRamp":a=C(b);break;case "MultiPartColorRamp":a={type:"multipart",colorRamps:b.ArrayOfColorRamp.map(C)};break;case "ArgumentArray":if(b.elements?.length&&"RasterStatistics"!==b.elements[0].type){a=[];for(let e=0;e<b.elements.length;e++){const f=b.elements[e];var {type:d}=
f;if(d)if("RasterFunctionTemplate"===d)({renderingRule:d}=D(f,c)),a.push(d),null!=f._object_id&&c.set(f._object_id,d);else if("RasterFunctionVariable"===d)d=u(f,c),a.push(d),null!=f._object_id&&c.set(f._object_id,d);else throw new p("raster-function-helper","unsupported raster function json.");else a.push(f)}}else a=b.elements}null!=b._object_id&&c.set(b._object_id,a);return a}function C(a){const c=a.algorithm??"esriHSVAlgorithm";let {FromColor:b,ToColor:d}=a;if(!Array.isArray(b)){const {r:e,g:f,
b:g}=w.toRGB({h:b.Hue,s:b.Saturation,v:b.Value});b=[e,f,g,b.AlphaValue]}if(!Array.isArray(d)){const {r:e,g:f,b:g}=w.toRGB({h:d.Hue,s:d.Saturation,v:d.Value});d=[e,f,g,d.AlphaValue]}return{type:"algorithmic",algorithm:c,fromColor:b,toColor:d}}function D(a,c,b){b&&B(a,b);c={renderingRule:{},templates:c};E(a,c);return c}function E(a,c){if(a&&c.renderingRule){var {renderingRule:b,templates:d}=c,{function:e,arguments:f,_object_id:g}=a;if(e&&f){null!=g&&d.set(g,b);b.rasterFunction=e.type.replace("Function",
"");b.outputPixelType=e.pixelType;a={};b.rasterFunctionArguments=a;for(const h in f)"type"!==h&&"object_id"!==h&&"_object_ref_id"!==h&&((c=f[h])&&"object"===typeof c&&"type"in c&&("RasterFunctionTemplate"===c.type||"RasterFunctionVariable"===c.type)?("RasterFunctionVariable"===c.type?a[h]=u(c,d):(b.rasterFunctionArguments[h]={},E(c,{renderingRule:b.rasterFunctionArguments[h],templates:d})),null!=c._object_id&&d.set(c._object_id,a[h])):a[h]=c);a.DEM&&!a.Raster&&(a.Raster=a.DEM,delete a.DEM);switch(b.rasterFunction){case "Stretch":V(a);
break;case "Colormap":"randomcolorramp"===a.ColorRamp?.type?.toLowerCase()&&(delete a.ColorRamp,a.ColormapName="Random");0===a.ColorSchemeType&&delete a.ColorRamp;break;case "Convolution":null!=a.ConvolutionType&&(a.Type=a.ConvolutionType,delete a.ConvolutionType);break;case "Mask":W(a)}}}}function v(a){const {renderingRule:c,templates:b}=a;if("object"===typeof c&&c?.rasterFunctionArguments&&b.size){({rasterFunctionArguments:a}=c);for(const d in a){const e=a[d],f="_object_ref_id"===d?e:e&&"object"===
typeof e&&"_object_ref_id"in e?e._object_ref_id:null;if(null!=f){if(!b.has(f))throw new p("raster-function-helper",`unsupported raster function json. _object_ref_id: ${f} does not exist`);const g=b.get(f);"_object_ref_id"!==d?a[d]=g:g&&"object"===typeof g&&Object.assign(a,g)}else e&&"object"===typeof e&&(e.rasterFunctionArguments&&v({renderingRule:e,templates:b}),Array.isArray(e)&&e.forEach((g,h)=>{if("object"===typeof g)if(null!=g._object_ref_id){if(!b.has(g._object_ref_id))throw new p("raster-function-helper",
`unsupported raster function json. _object_ref_id: ${e} does not exist`);const m=b.get(f);m&&"object"===typeof m?Object.assign(g,m):e[h]=m}else v({renderingRule:g,templates:b})}))}}}function V(a){a.Statistics?.length&&"object"===typeof a.Statistics&&(a.Statistics=a.Statistics.map(c=>[c.min,c.max,c.mean,c.standardDeviation]));null!=a.NumberOfStandardDeviation&&(a.NumberOfStandardDeviations=a.NumberOfStandardDeviation,delete a.NumberOfStandardDeviation)}function W(a){a.NoDataValues?.length&&"string"===
typeof a.NoDataValues[0]&&(a.NoDataValues=a.NoDataValues.filter(c=>""!==c).map(c=>Number(c)))}const k=new Map;k.set("Aspect",{desc:"Aspect Function",ctor:G,rasterArgumentNames:["raster"]});k.set("BandArithmetic",{desc:"Band Arithmetic Function",ctor:H,rasterArgumentNames:["raster"]});k.set("Colormap",{desc:"Colormap Function",ctor:I,rasterArgumentNames:["raster"]});k.set("CompositeBand",{desc:"CompositeBand Function",ctor:J,rasterArgumentNames:["rasters"]});k.set("Convolution",{desc:"Convolution Function",
ctor:K,rasterArgumentNames:["raster"]});k.set("ExtractBand",{desc:"ExtractBand Function",ctor:M,rasterArgumentNames:["raster"]});k.set("Curvature",{desc:"Curvature Function",ctor:L,rasterArgumentNames:["raster"]});k.set("Local",{desc:"Local Function",ctor:N,rasterArgumentNames:["rasters"]});k.set("Mask",{desc:"Mask Function",ctor:O,rasterArgumentNames:["raster"]});k.set("NDVI",{desc:"NDVI Function",ctor:P,rasterArgumentNames:["raster"]});k.set("Remap",{desc:"Remap Function",ctor:Q,rasterArgumentNames:["raster"]});
k.set("Slope",{desc:"Slope Function",ctor:R,rasterArgumentNames:["raster"]});k.set("StatisticsHistogram",{desc:"Statistics Histogram Function",ctor:S,rasterArgumentNames:["raster"]});k.set("Stretch",{desc:"Stretch Function",ctor:T,rasterArgumentNames:["raster"]});k.set("Table",{desc:"Attribute Table Function",ctor:U,rasterArgumentNames:["raster"]});n.create=function(a,c){c=c??{};a=F.clone(a);if("function"in a&&"arguments"in a&&a.arguments){const b=new Map;a=D(a,b,c);v(a);if(!a.renderingRule)throw new p("raster-function-helper",
"Unsupported raster function json.");a=a.renderingRule}if("rasterFunction"in a)return a=t(a),A(a,c);throw new p("raster-function-helper","unsupported raster function json.");};n.getPrimaryRasterUrls=x;n.getRasterValues=y;n.getSupportedFunctions=function(){const a=new Set;k.forEach((c,b)=>a.add(b));return a};n.register=function(a,c,b=["raster"],d=""){k.set(a,{desc:d,ctor:c,rasterArgumentNames:b})};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../core/sql ../../geometry/support/jsonUtils ../../geometry/support/scaleUtils ../../layers/support/floorFilterUtils ../../layers/support/sublayerUtils".split(" "),function(r,C,D,E,z,F){function A(a){const {mapExtent:c,floors:m,width:e,sublayers:f,layerIds:h,layerOption:t,gdbVersion:p}=a;var d=f?.find(b=>null!=b.layer)?.layer?.serviceSublayers;const u="popup"===t;a={};const n=E.getScale({extent:c,width:e,spatialReference:c?.spatialReference}),g=[],q=b=>{const k=0===n,v=0===b.minScale||
n<=b.minScale,w=0===b.maxScale||n>=b.maxScale;b.visible&&(k||v&&w)&&(b.sublayers?b.sublayers.forEach(q):!1!==h?.includes(b.id)&&(!u||b.popupTemplate&&b.popupEnabled)&&g.unshift(b))};f?.forEach(q);if(f&&!g.length)a.layerIds=[];else{d=F.isExportDynamic(g,d,p);var l=g.map(b=>{const k=z.getLayerFloorFilterClause(m,b);return b.toExportImageJSON(k)});if(d)a.dynamicLayers=JSON.stringify(l);else if(f?(d=g.map(({id:b})=>b),h&&(d=d.filter(b=>h.includes(b))),a.layerIds=d):h?.length&&(a.layerIds=h),d=G(m,g),
null!=d&&d.length){l={};for(const b of d)b.definitionExpression&&(l[b.id]=b.definitionExpression);Object.keys(l).length&&(a.layerDefs=JSON.stringify(l))}}return a}function G(a,c){const m=!!a?.length;c=c.filter(e=>null!=e.definitionExpression||m&&null!=e.floorInfo);return c.length?c.map(e=>{var f=z.getLayerFloorFilterClause(a,e);f=C.sqlAnd(f,e.definitionExpression);return{id:e.id,definitionExpression:f??void 0}}):null}r.identifyToIdentifyRESTParameters=function(a,c){const {dpi:m,gdbVersion:e,geometry:f,
geometryPrecision:h,height:t,layerOption:p,mapExtent:d,maxAllowableOffset:u,returnFieldName:n,returnGeometry:g,returnUnformattedValues:q,returnZ:l,spatialReference:b,timeExtent:k,tolerance:v,width:w}=a.toJSON(),{dynamicLayers:x,layerDefs:y,layerIds:B}=A(a);c=c&&null!=c.geometry?c.geometry:null;a={geometryPrecision:h,maxAllowableOffset:u,returnFieldName:n,returnGeometry:g,returnUnformattedValues:q,returnZ:l,tolerance:v};c=c&&c.toJSON()||f;a.imageDisplay=`${w},${t},${m}`;e&&(a.gdbVersion=e);c&&(delete c.spatialReference,
a.geometry=JSON.stringify(c),a.geometryType=D.getJsonType(c));b?a.sr=b.wkid||JSON.stringify(b):c&&c.spatialReference?a.sr=c.spatialReference.wkid||JSON.stringify(c.spatialReference):d&&d.spatialReference&&(a.sr=d.spatialReference.wkid||JSON.stringify(d.spatialReference));a.time=k?[k.start,k.end].join():null;if(d){const {xmin:H,ymin:I,xmax:J,ymax:K}=d;a.mapExtent=`${H},${I},${J},${K}`}y&&(a.layerDefs=y);x&&!y&&(a.dynamicLayers=x);a.layers="popup"===p?"visible":p;B&&!x&&(a.layers+=`:${B.join(",")}`);
return a};r.toDynamicLayersJSON=A;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../chunks/vec3 ../../../chunks/vec3f64 ../MeshComponent ../MeshTransform ../MeshVertexAttributes ./georeference".split(" "),function(B,D,A,E,F,G,H,C){function I(a){var c=null,b=null;let e=!0,q=!0,g=null;const l=E.create();let f=0;for(const n of a){const {vertexSpace:m,transform:h}=n;null==b&&(b=m,b.isRelative&&(g=b.origin));if(b.type!==m.type)return z.error("merge()",`Inconsistent mesh vertex space for provided geometries. One was ${b.type} while another is ${m.type}. Unable to merge geometries.`),
null;null==c||null!=h&&h.equals(c)||(e=!1);null!=h&&null==c&&(c=h);m.isRelative&&({origin:a}=m,g&&!A.equals(a,g)&&(q=!1),f++,A.add(l,l,m.origin))}if(null==b)throw Error();b=b.clone();if(!b.isRelative)return{transform:null,vertexSpace:b,rebake:!1};if(q&&e)return{transform:c?.clone(),vertexSpace:b,rebake:!1};c=A.scale(l,l,1/f);b.origin=c;return{transform:new G,vertexSpace:b,rebake:!0}}function x(a,c,b,e,q){if(c){var g=c.position;if(g)if(c=c[a],b=b[a],null==c){c=e[a];var l=r[a];if(null!=b){for(var f=
0;f<g.length;f+=3)for(let n=0;n<l;n++)b[c++]=q;e[a]=c}}else if(null!=b&&null!=c){q=0;g=e[a];l=c.length;for(f=0;f<l;f++)b[g++]=c[q++];e[a]+=c.length}}}const z=D.getLogger("esri.geometry.support.triangleMeshMerge"),r={position:3,normal:3,tangent:4,uv:2,color:4};B.merge=function(a,c){var b,e;if(0===a.length)return z.error("merge()","Must specify one more geometries to merge"),null;const q=a[0].spatialReference;for(var g of a){if(!g.spatialReference.equals(q))return z.error("merge()","Geometries must all be in the same spatial reference"),
null;if(!g.loaded)return z.error("merge()","Geometries must all be loaded before merging"),null}g=I(a);if(null==g)return null;var l=0,f=0,n=0,m=0,h=0,d=b=!1;var p=e=!1;for(v of a){var k=v.vertexAttributes;if(k&&k.position&&(k.uv&&(b=!0),k.normal&&(d=!0),k.tangent&&(p=!0),k.color&&(e=!0),d&&b&&e&&p))break}var v=d;for(u of a)(d=u.vertexAttributes)&&d.position&&(l+=d.position.length,b&&(f+=d.position.length/r.position*r.uv),v&&(n+=d.position.length/r.position*r.normal),e&&(m+=d.position.length/r.position*
r.color),p&&(h+=d.position.length/r.position*r.tangent));var u=new H.MeshVertexAttributes({position:new Float64Array(l),uv:f?new Float32Array(f):null,normal:n?new Float32Array(n):null,tangent:h?new Float32Array(h):null,color:m?new Uint8Array(m):null});l=[];f={position:0,uv:0,normal:0,tangent:0,color:0};n=new Map;m=new Map;for(const w of a){a=w;if(g.rebake){p=a.vertexSpace;h=g.vertexSpace;if(p.type!==h.type)throw Error();p=C.georeferenceApplyTransform(a.vertexAttributes,p,a.transform,a.spatialReference);
a=C.ungeoreference(p,h.getOriginPoint(a.spatialReference),{geographic:!h.isGeoreferenced})}else a=a.vertexAttributes;v=a;if(c&&c.reuseMaterials&&w.components)for(const y of w.components)y.material&&n.set(y.material,y.material);a=w;h=f;e=n;b=m;p=l;if(a.components)for(const y of a.components){d=y.cloneWithDeduplication(e,b);k=h.position/3;if(d.faces)for(var t=0;t<d.faces.length;t++)d.faces[t]+=k;else for(d.faces=new Uint32Array(a.vertexAttributes.position.length/3),t=0;t<d.faces.length;t++)d.faces[t]=
t+k;k=d;0<h.normal&&!a.vertexAttributes.normal&&"source"===k.shading&&(k.shading="flat");p.push(d)}else if(a.vertexAttributes&&a.vertexAttributes.position){e=a.vertexAttributes.position.length/3;b=new Uint32Array(e);d=h.position/3;for(k=0;k<e;k++)b[k]=k+d;e=b=new F({faces:b});0<h.normal&&!a.vertexAttributes.normal&&"source"===e.shading&&(e.shading="flat");p.push(b)}x("position",v,u,f,0);x("normal",v,u,f,0);x("tangent",v,u,f,0);x("uv",w.vertexAttributes,u,f,0);x("color",w.vertexAttributes,u,f,255)}return{vertexAttributes:u,
components:l,vertexSpace:g.vertexSpace,transform:g.transform,spatialReference:q}};Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
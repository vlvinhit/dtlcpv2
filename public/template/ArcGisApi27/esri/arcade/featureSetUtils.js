// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../request ./featureSetCollection ../chunks/languageUtils ./featureset/actions/AttributeFilter ./featureset/actions/GroupBy ./featureset/actions/OrderBy ./featureset/actions/SpatialFilter ./featureset/actions/Top ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/sources/FeatureLayerRelated ./featureset/support/cache ./featureset/support/errorsupport ./featureset/support/FeatureSet ./featureset/support/shared ../core/sql/WhereClause ../layers/FeatureLayer ../portal/PortalItem".split(" "),
function(r,u,v,y,t,E,F,G,H,I,J,K,L,l,z,M,A,B,p,N){async function w(a,h){if(l.applicationCache){var g=l.applicationCache.getLayerInfo(a);if(g)return g=await g,new p({url:a,outFields:h,sourceJSON:g});const c=new p({url:a,outFields:h});h=(async()=>{await c.load();return c.sourceJSON})();if(l.applicationCache){l.applicationCache.setLayerInfo(a,h);try{return await h,c}catch(e){throw l.applicationCache.clearLayerInfo(a),e;}}await h;return c}return new p({url:a,outFields:h})}async function x(a,h,g,c,e,d=
null){a=await w(a,["*"]);return n(a,h,g,c,e,d)}function n(a,h=null,g=null,c=!0,e=null,d=null){return a instanceof p||t.isSubtypeGrouplayer(a)?(h={layer:a,spatialReference:h,outFields:g,includeGeometry:c,lrucache:e,interceptor:d},!0===!(a.url||!a.source)?new K(h):new J(h)):n(a.parent,h,g,c,e,d).filter(B.WhereClause.create(a.parent.subtypeField+"\x3d"+a.subtypeCode.toString(),a.parent?.fieldsIndex))}async function O(a){if(null!==l.applicationCache){var h=l.applicationCache.getLayerInfo(a);if(null!==
h)return h}h=(async()=>{const g=await v(a,{responseType:"json",query:{f:"json"}});return g.data?g.data:null})();if(null!==l.applicationCache){l.applicationCache.setLayerInfo(a,h);try{return await h}catch(g){throw l.applicationCache.clearLayerInfo(a),g;}}return h}async function P(a,h){const g="QUERYDATAELEMTS:"+h.toString()+":"+a;if(null!==l.applicationCache){var c=l.applicationCache.getLayerInfo(g);if(null!==c)return c}c=(async()=>{var e=await v(a+"/queryDataElements",{method:"post",responseType:"json",
query:{layers:JSON.stringify([h.toString()]),f:"json"}});if(e.data&&(e=e.data,e.layerDataElements&&e.layerDataElements[0]))return e.layerDataElements[0];throw new z.FeatureSetError(z.FeatureSetErrorCodes.DataElementsNotFound);})();if(null!==l.applicationCache){l.applicationCache.setLayerInfo(g,c);try{return await c}catch(e){throw l.applicationCache.clearLayerInfo(g),e;}}return c}async function C(a){if(null!==l.applicationCache){var h=l.applicationCache.getLayerInfo(a);if(null!==h)return h}h=(async()=>
{var g=await v(a,{responseType:"json",query:{f:"json"}});return g.data?(g=g.data,g.layers||(g.layers=[]),g.tables||(g.tables=[]),g):{layers:[],tables:[]}})();if(null!==l.applicationCache){l.applicationCache.setLayerInfo(a,h);try{return await h}catch(g){throw l.applicationCache.clearLayerInfo(a),g;}}return h}E.registerAction();F.registerAction();G.registerAction();H.registerAction();I.registerAction();let Q=function(a){function h(c,e=null,d=null,f=null){var k=a.call(this)||this;k._map=c;k._overridespref=
e;k._lrucache=d;k._interceptor=f;k._instantLayers=[];return k}u._inherits(h,a);var g=h.prototype;g._makeAndAddFeatureSet=function(c,e=!0,d=null){const f=n(c,this._overridespref,null===d?["*"]:d,e,this._lrucache,this._interceptor);this._instantLayers.push({featureset:f,opitem:c,includeGeometry:e,outFields:JSON.stringify(d)});return f};g.featureSetByName=async function(c,e=!0,d=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetByName(c,
e,d);null===d&&(d=["*"]);d=d.slice(0);d=d.sort();var f=JSON.stringify(d);for(let b=0;b<this._instantLayers.length;b++){const m=this._instantLayers[b];if(m.opitem.title===c&&m.includeGeometry===e&&m.outFields===f)return this._instantLayers[b].featureset}const k=[];if(f=this._map.allLayers.find(b=>{if(b instanceof p){if(b.title===c)return!0}else if(t.isSubtypeGrouplayer(b)){if(b.title===c)return!0;k.push(b)}return!1}))return this._makeAndAddFeatureSet(f,e,d);if(this._map.tables&&(f=this._map.tables.find(b=>
b.title&&b.title===c||b.title&&b.title===c?!0:!1))){if(f instanceof p)return this._makeAndAddFeatureSet(f,e,d);f._materializedTable||(f._materializedTable=new p(f.outFields?f:{...f,outFields:["*"]}));await f._materializedTable.load();return this._makeAndAddFeatureSet(f._materializedTable,e,d)}for(const b of k){if("not-loaded"===b.loadStatus||"loading"===b.loadStatus)try{await b.load()}catch(m){}if(f=b.sublayers.find(m=>m.title===c?!0:!1))return this._makeAndAddFeatureSet(f,e,d)}return null};g.featureSetById=
async function(c,e=!0,d=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetById(c,e,d);null===d&&(d=["*"]);d=d.slice(0);d=d.sort();var f=JSON.stringify(d);for(let b=0;b<this._instantLayers.length;b++){const m=this._instantLayers[b];if(m.opitem.id===c&&m.includeGeometry===e&&m.outFields===f)return this._instantLayers[b].featureset}const k=[];if(f=this._map.allLayers.find(b=>{if(b instanceof p){if(b.id===c)return!0}else if(t.isSubtypeGrouplayer(b)){if(b.id===
c)return!0;k.push(b)}return!1}))return this._makeAndAddFeatureSet(f,e,d);if(this._map.tables&&(f=this._map.tables.find(b=>b.id===c?!0:!1))){if(f instanceof p)return this._makeAndAddFeatureSet(f,e,d);f._materializedTable||(f._materializedTable=new p({...f,outFields:["*"]}));await f._materializedTable.load();return this._makeAndAddFeatureSet(f._materializedTable,e,d)}for(const b of k){if("not-loaded"===b.loadStatus||"loading"===b.loadStatus)try{await b.load()}catch(m){}if(f=b.sublayers.find(m=>m.id===
c?!0:!1))return this._makeAndAddFeatureSet(f,e,d)}return null};return u._createClass(h)}(y),R=function(a){function h(c,e=null,d=null,f=null){var k=a.call(this)||this;k._url=c;k._overridespref=e;k._lrucache=d;k._interceptor=f;k.metadata=null;k._instantLayers=[];return k}u._inherits(h,a);var g=h.prototype;g._makeAndAddFeatureSet=function(c,e=!0,d=null){const f=n(c,this._overridespref,null===d?["*"]:d,e,this._lrucache);this._instantLayers.push({featureset:f,opitem:c,includeGeometry:e,outFields:JSON.stringify(d)});
return f};g._loadMetaData=async function(){const c=await C(this._url);return this.metadata=c};g.load=function(){return this._loadMetaData()};g.clone=function(){return new h(this._url,this._overridespref,this._lrucache,this._interceptor)};g.featureSetByName=async function(c,e=!0,d=null){null===d&&(d=["*"]);d=d.slice(0);d=d.sort();var f=JSON.stringify(d);for(var k=0;k<this._instantLayers.length;k++){const b=this._instantLayers[k];if(b.opitem.title===c&&b.includeGeometry===e&&b.outFields===f)return this._instantLayers[k].featureset}f=
await this._loadMetaData();k=null;for(const b of f.layers??[])b.name===c&&(k=b);if(!k)for(const b of f.tables??[])b.name===c&&(k=b);return k?(c=await w(this._url+"/"+k.id,["*"]),this._makeAndAddFeatureSet(c,e,d)):null};g.featureSetById=async function(c,e=!0,d=["*"]){null===d&&(d=["*"]);d=d.slice(0);d=d.sort();var f=JSON.stringify(d);c=null!==c&&void 0!==c?c.toString():"";for(var k=0;k<this._instantLayers.length;k++){const b=this._instantLayers[k];if(b.opitem.id===c&&b.includeGeometry===e&&b.outFields===
f)return this._instantLayers[k].featureset}f=await this._loadMetaData();k=null;for(const b of f.layers??[])null!==b.id&&void 0!==b.id&&b.id.toString()===c&&(k=b);if(!k)for(const b of f.tables??[])null!==b.id&&void 0!==b.id&&b.id.toString()===c&&(k=b);return k?(c=await w(this._url+"/"+k.id,["*"]),this._makeAndAddFeatureSet(c,e,d)):null};u._createClass(h,[{key:"url",get:function(){return this._url}}]);return h}(y);r.constructAssociationMetaDataFeatureSetFromUrl=async function(a,h){var g=3,c=[],e=null,
d={},f=null;f=await C(a);if(f.controllerDatasetLayers&&void 0!==f.controllerDatasetLayers.utilityNetworkLayerId&&null!==f.controllerDatasetLayers.utilityNetworkLayerId){if(f.layers)for(var k of f.layers)d[k.id]=k.name;if(f.tables)for(var b of f.tables)d[b.id]=b.name;k=f.controllerDatasetLayers.utilityNetworkLayerId;if(f=await P(a,k)){(e=f)&&e.dataElement&&void 0!==e.dataElement.schemaGeneration&&(g=e.dataElement.schemaGeneration);f={};e.dataElement.domainNetworks||(e.dataElement.domainNetworks=[]);
for(var m of e.dataElement.domainNetworks){for(const q of m.edgeSources??[])b={layerId:q.layerId,sourceId:q.sourceId,className:d[q.layerId]??null},b.className&&(f[b.className]=b);for(const q of m.junctionSources??[])b={layerId:q.layerId,sourceId:q.sourceId,className:d[q.layerId]??null},b.className&&(f[b.className]=b)}if(e.dataElement.terminalConfigurations)for(const q of e.dataElement.terminalConfigurations)for(const D of q.terminals)c.push({terminalId:D.terminalId,terminalName:D.terminalName});d=
await O(a+"/"+k);if(d.systemLayers&&void 0!==d.systemLayers.associationsTableId&&null!==d.systemLayers.associationsTableId)return m=[],4<=g&&(m.push("STATUS"),m.push("PERCENTALONG")),a=await x(a+"/"+d.systemLayers.associationsTableId.toString(),h,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...m],!1,null,null),await a.load(),4<=g&&(a=a.filter(B.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",
a.getFieldsIndex())),await a.load()),{lkp:f,associations:a,unVersion:g,terminals:c}}}return{associations:null,unVersion:g,lkp:null,terminals:[]}};r.constructFeatureSet=n;r.constructFeatureSetFromPortalItem=async function(a,h,g,c,e,d,f,k=null){if(l.applicationCache){var b=l.applicationCache.getLayerInfo(a+":"+d.url);if(b)return a=await b,h=new p({url:A.extractServiceUrl(a.url)+"/"+h,outFields:["*"]}),n(h,g,c,e,f,k)}b=(new N({id:a,portal:d})).load();l.applicationCache&&l.applicationCache.setLayerInfo(a+
":"+d.url,b);try{const m=await b,q=new p({url:A.extractServiceUrl(m.url??"")+"/"+h,outFields:["*"]});return n(q,g,c,e,f,k)}catch(m){throw l.applicationCache&&l.applicationCache.clearLayerInfo(a+":"+d.url),m;}};r.constructFeatureSetFromRelationship=async function(a,h,g,c=null,e=null,d=!0,f=null,k=null){var b=a.serviceUrl();if(!b)return null;b="/"===b.charAt(b.length-1)?b+h.relatedTableId.toString():b+"/"+h.relatedTableId.toString();b=await x(b,c,e,d,f,k);return new L({layer:a,relatedLayer:b,relationship:h,
objectId:g,spatialReference:c,outFields:e,includeGeometry:d,lrucache:f,interceptor:k})};r.constructFeatureSetFromUrl=x;r.convertToFeatureSet=function(a,h,g,c,e){if(null===a)return null;if(a instanceof p){switch(h){case "datasource":return n(a,e,a.outFields,!0,g,c).getDataSourceFeatureSet();case "parent":return n(a,e,a.outFields,!0,g,c);case "root":return n(a,e,a.outFields,!0,g,c)}return null}if(t.isSubtypeGrouplayer(a)){switch(h){case "datasource":return n(a,e,a.outFields,!0,g,c).getDataSourceFeatureSet();
case "parent":return n(a,e,a.outFields,!0,g,c);case "root":return n(a,e,a.outFields,!0,g,c)}return null}if(t.isSubtypeSublayer(a)){switch(h){case "datasource":return n(a.parent,e,a.parent.outFields,!0,g,c).getDataSourceFeatureSet();case "parent":return n(a,e,a.parent.outFields,!0,g,c);case "root":return n(a,e,a.parent.outFields,!0,g,c)}return null}if(a instanceof M)switch(h){case "datasource":return a.getDataSourceFeatureSet();case "parent":return a;case "root":return a.getRootFeatureSet()}return null};
r.createFeatureSetCollectionFromMap=function(a,h,g=null,c=null){return new Q(a,h,g,c)};r.createFeatureSetCollectionFromService=function(a,h,g=null,c=null){return new R(a,h,g,c)};r.initialiseMetaDataCache=function(){null===l.applicationCache&&(l.applicationCache=new l)};Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
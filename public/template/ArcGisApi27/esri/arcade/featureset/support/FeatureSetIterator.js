// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe"],function(q,n){return function(){function p(a,d){this._lastId=-1;this._progress=d;this._parent=a}var m=p.prototype;m.reset=function(){this._lastId=-1};m.nextBatch=function(a){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(e=>this.nextBatch(a),e=>this.nextBatch(a));var d=null,c=!1;const f=[];d=new Promise((e,g)=>{this._parent._getSet(this._progress).then(b=>{const h=n.unwrapOrThrow(b._known,"known");
var l=h.length-1;"GETPAGES"===h[h.length-1]&&--l;if(this._lastId+a>l&&0<h.length&&"GETPAGES"===h[h.length-1])this._parent._expandPagedSet(b,this._parent._maxQueryRate(),0,0,this._progress).then(k=>{c=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(e,g)},k=>{c=!0;this._parent._mainSetInUse=null;g(k)});else{var r=n.unwrapOrThrow(b._candidates,"candidates");if(l>=this._lastId+a||0===r.length){for(b=0;b<a;b++){l=b+this._lastId+1;if(l>=h.length)break;f[b]=h[l]}this._lastId+=f.length;0===f.length&&
(c=!0,this._parent._mainSetInUse=null,e([]));this._parent._getFeatureBatch(f,this._progress).then(k=>{c=!0;this._parent._mainSetInUse=null;e(k)},k=>{c=!0;this._parent._mainSetInUse=null;g(k)})}else this._parent._refineSetBlock(b,this._parent._maxProcessingRate(),this._progress).then(()=>{c=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(e,g)},k=>{c=!0;this._parent._mainSetInUse=null;g(k)})}},b=>{c=!0;this._parent._mainSetInUse=null;g(b)})});!1===c&&(this._parent._mainSetInUse=d,c=!0);return d};
m.next=function(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(c=>this.next(),c=>this.next());var a=null,d=!1;a=new Promise((c,f)=>{this._parent._getSet(this._progress).then(e=>{const g=n.unwrapOrThrow(e._known,"known");this._lastId<g.length-1?"GETPAGES"===g[this._lastId+1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,0,this._progress).then(b=>{d=!0;this._parent._mainSetInUse=null;return this.next()}).then(c,f):(this._lastId+=1,this._parent._getFeature(e,
g[this._lastId],this._progress).then(b=>{d=!0;this._parent._mainSetInUse=null;c(b)},b=>{d=!0;this._parent._mainSetInUse=null;f(b)})):0<n.unwrapOrThrow(e._candidates,"candidates").length?this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then(()=>{d=!0;this._parent._mainSetInUse=null;this.next().then(c,f)},b=>{d=!0;this._parent._mainSetInUse=null;f(b)}):(d=!0,this._parent._mainSetInUse=null,c(null))},e=>{d=!0;this._parent._mainSetInUse=null;f(e)})});!1===d&&(this._parent._mainSetInUse=
a,d=!0);return a};m.count=async function(){if(-1!==this._parent._totalCount)return this._parent._totalCount;var a=await this._parent._getSet(this._progress);a=await this._refineAllSets(a);this._parent._totalCount=a._known.length;return this._parent._totalCount};m._refineAllSets=async function(a){if(0<a._known.length&&"GETPAGES"===a._known[a._known.length-1])return await this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,1,this._progress),this._refineAllSets(a);if(0<a._candidates.length){if("GETPAGES"===
a._known[a._candidates.length-1])return await this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,2,this._progress),this._refineAllSets(a);a=await this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress);return 0<a._candidates.length?this._refineAllSets(a):a}return a};return q._createClass(p)}()});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../ArcadeDate ./shared ../../../core/sql/WhereClause ./errorsupport ../../arcadeTimeUtils ../../../chunks/datetime".split(" "),function(m,E,h,t,k,y,u){function v(a,b){return g(a?.parseTree,b,a?.parameters)}function z(a,b,c){b=y.convertTimeReference(b);c=y.convertTimeReference(c);return g(a.parseTree,h.FeatureServiceDatabaseType.Standardised,null,null,null,{inputTimeReference:b,outputTimeReference:c})}function g(a,b,c,d=null,f=null,e=null){switch(a.type){case "interval":return A(g(a.value,
b,c,d,f,e),a.qualifier,a.op);case "case-expression":var l=" CASE ";"simple"===a.format&&(l+=g(a.operand,b,c,d,f,e));for(var q=0;q<a.clauses.length;q++)l+=" WHEN "+g(a.clauses[q].operand,b,c,d,f,e)+" THEN "+g(a.clauses[q].value,b,c,d,f,e);null!==a.else&&(l+=" ELSE "+g(a.else,b,c,d,f,e));return l+" END ";case "parameter":d=c[a.value.toLowerCase()];if("string"===typeof d)return"'"+c[a.value.toLowerCase()].toString().replaceAll("'","''")+"'";if(h.isDate(d))return r(d,b,e);if(h.isArcadeDate(d))return w(d,
b,e);if(d instanceof Array){a=[];for(c=0;c<d.length;c++)"string"===typeof d[c]?a.push("'"+d[c].toString().replaceAll("'","''")+"'"):h.isDate(d[c])?a.push(r(d[c],b,e)):h.isArcadeDate(d[c])?a.push(w(d[c],b,e)):a.push(d[c].toString());return a}return d.toString();case "expression-list":l=[];for(q of a.value)l.push(g(q,b,c,d,f,e));return l;case "unary-expression":return" ( NOT "+g(a.expr,b,c,d,f,e)+" ) ";case "binary-expression":switch(a.operator){case "AND":return" ("+g(a.left,b,c,d,f,e)+" AND "+g(a.right,
b,c,d,f,e)+") ";case "OR":return" ("+g(a.left,b,c,d,f,e)+" OR "+g(a.right,b,c,d,f,e)+") ";case "IS":if("null"!==a.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(a.left,b,c,d,f,e)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(a.left,b,c,d,f,e)+" IS NOT NULL )";case "IN":l=[];if("expression-list"===a.right.type)return l=g(a.right,b,c,d,f)," ("+g(a.left,b,c,d,f,e)+" IN ("+l.join(",")+")) ";l=g(a.right,
b,c,d,f,e);return l instanceof Array?" ("+g(a.left,b,c,d,f,e)+" IN ("+l.join(",")+")) ":" ("+g(a.left,b,c,d,f,e)+" IN ("+l+")) ";case "NOT IN":l=[];if("expression-list"===a.right.type)return l=g(a.right,b,c,d,f)," ("+g(a.left,b,c,d,f,e)+" NOT IN ("+l.join(",")+")) ";l=g(a.right,b,c,d,f,e);return l instanceof Array?" ("+g(a.left,b,c,d,f,e)+" NOT IN ("+l.join(",")+")) ":" ("+g(a.left,b,c,d,f,e)+" NOT IN ("+l+")) ";case "BETWEEN":return l=g(a.right,b,c,d,f,e)," ("+g(a.left,b,c,d,f,e)+" BETWEEN "+l[0]+
" AND "+l[1]+" ) ";case "NOTBETWEEN":return l=g(a.right,b,c,d,f,e)," ("+g(a.left,b,c,d,f,e)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case "LIKE":return""!==a.escape?" ("+g(a.left,b,c,d,f,e)+" LIKE "+g(a.right,b,c,d,f,e)+" ESCAPE '"+a.escape+"') ":" ("+g(a.left,b,c,d,f,e)+" LIKE "+g(a.right,b,c,d,f,e)+") ";case "NOT LIKE":return""!==a.escape?" ("+g(a.left,b,c,d,f,e)+" NOT LIKE "+g(a.right,b,c,d,f,e)+" ESCAPE '"+a.escape+"') ":" ("+g(a.left,b,c,d,f,e)+" NOT LIKE "+g(a.right,b,c,d,f,e)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+
g(a.left,b,c,d,f,e)+" "+a.operator+" "+g(a.right,b,c,d,f,e)+") ";case "||":return" ("+g(a.left,b,c,d,f,e)+" "+(b===h.FeatureServiceDatabaseType.SqlServer?"+":a.operator)+" "+g(a.right,b,c,d,f,e)+") "}throw new k.SqlError(k.SqlErrorCodes.UnsupportedOperator,{operator:a.operator});case "null":return"null";case "boolean":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replaceAll("'","''")+"'";case "timestamp":return r(a.value,b,e);case "date":return r(a.value,b,e);case "number":return a.value.toString();
case "current-time":return B("date"===a.mode,b);case "column-reference":return d&&d.toLowerCase()===a.column.toLowerCase()?"("+f+")":a.column;case "data-type":return a.value;case "function":return e=g(a.args,b,c,d,f,e),C(a.name,e,b)}throw new k.SqlError(k.SqlErrorCodes.UnsupportedSyntax,{node:a.type});}function C(a,b,c){switch(a.toLowerCase().trim()){case "cos":case "sin":case "tan":case "cosh":case "tanh":case "sinh":case "acos":case "asin":case "atan":case "floor":case "log10":case "log":case "abs":if(1!==
b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a.toLowerCase().trim()});return`${a.toUpperCase().trim()}(${b[0]})`;case "ceiling":case "ceil":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(c){case h.FeatureServiceDatabaseType.Standardised:case h.FeatureServiceDatabaseType.StandardisedNoInterval:return"CEILING("+b[0]+")";default:return"CEILING("+b[0]+")"}case "mod":case "power":case "nullif":if(2!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,
{function:a.toLowerCase().trim()});return`${a.toUpperCase().trim()}(${b[0]},${b[1]})`;case "round":if(2===b.length)return"ROUND("+b[0]+","+b[1]+")";if(1===b.length)return"ROUND("+b[0]+")";throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case "truncate":if(1>b.length||2<b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});switch(c){case h.FeatureServiceDatabaseType.SqlServer:return"ROUND("+b[0]+(1===b.length?"0":","+b[1])+
",1)";default:return"TRUNCATE("+b[0]+(1===b.length?")":","+b[1]+")")}case "char_length":case "len":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(c){case h.FeatureServiceDatabaseType.SqlServer:return"LEN("+b[0]+")";case h.FeatureServiceDatabaseType.Oracle:return"LENGTH("+b[0]+")";default:return"CHAR_LENGTH("+b[0]+")"}case "coalesce":case "concat":if(1>b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a.toLowerCase()});
c=a.toUpperCase().trim()+"(";for(a=0;a<b.length;a++)0!==a&&(c+=","),c+=b[a];return c+")";case "lower":case "lcase":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+b[0]+")";case "upper":case "ucase":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+b[0]+")";case "substring":switch(a="",c){case h.FeatureServiceDatabaseType.Oracle:return a="SUBSTR("+b[0]+","+b[1],3===b.length&&
(a+=","+b[2]),a+")";case h.FeatureServiceDatabaseType.SqlServer:return a=3===b.length?"SUBSTRING("+b[0]+","+b[1]+","+b[2]+")":"SUBSTRING("+b[0]+",  "+b[1]+", LEN("+b[0]+") - "+b[1]+")";default:return a="SUBSTRING("+b[0]+" FROM "+b[1],3===b.length&&(a+=" FOR "+b[2]),a+")"}case "extract":return"EXTRACT("+b[0].replaceAll("'","")+" FROM "+b[1]+")";case "cast":switch(a="",c){case h.FeatureServiceDatabaseType.Oracle:switch(b[1].type){case "date":a="DATE";break;case "float":a="DOUBLE";break;case "integer":a=
"INTEGER";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`;case h.FeatureServiceDatabaseType.Postgres:switch(b[1].type){case "date":a="DATE";break;case "float":a="DOUBLE PRECISION";break;case "integer":a="INT";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+
")"}return`CAST(${b[0]} AS ${a})`;case h.FeatureServiceDatabaseType.SqlServer:switch(b[1].type){case "date":a="DATE";break;case "float":a="FLOAT";break;case "integer":a="INT";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="DATETIME";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`;default:switch(b[1].type){case "date":a="DATE";break;case "float":a="FLOAT";break;case "integer":a="INTEGER";break;case "real":a="REAL";break;
case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`}}throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a});}function w(a,b,c,d){c?.outputTimeReference&&(a=E.ArcadeDate.arcadeDateAndZoneToArcadeDate(a,c?.outputTimeReference));a=a.toDateTime();c=0===a.hour&&0===a.minute&&0===a.second&&0===a.millisecond;switch(b){case h.FeatureServiceDatabaseType.FILEGDB:case h.FeatureServiceDatabaseType.Standardised:case h.FeatureServiceDatabaseType.StandardisedNoInterval:return c?
`date '${a.toFormat("yyyy-LL-dd")}'`:`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case h.FeatureServiceDatabaseType.Oracle:return c?`TO_DATE('${a.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${a.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case h.FeatureServiceDatabaseType.SqlServer:return`'${a.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case h.FeatureServiceDatabaseType.PGDB:return`#${a.toFormat(c?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case h.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${a.toFormat(c?
"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function r(a,b,c,d){a=h.isDate(a)?u.DateTime.fromJSDate(a):u.DateTime.fromSQL(a);d=0===a.hour&&0===a.minute&&0===a.second&&0===a.millisecond;c?.inputTimeReference&&(a=u.DateTime.fromObject({day:a.day,year:a.year,month:a.month,hour:a.hour,minute:a.minute,second:a.second,millisecond:a.millisecond},{zone:c.inputTimeReference}));c?.outputTimeReference&&(a=a.setZone(c.outputTimeReference));switch(b){case h.FeatureServiceDatabaseType.FILEGDB:case h.FeatureServiceDatabaseType.Standardised:case h.FeatureServiceDatabaseType.StandardisedNoInterval:return d?
`date '${a.toFormat("yyyy-LL-dd")}'`:`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case h.FeatureServiceDatabaseType.Oracle:return d?`TO_DATE('${a.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${a.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case h.FeatureServiceDatabaseType.SqlServer:return`'${a.toFormat(d?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case h.FeatureServiceDatabaseType.PGDB:return`#${a.toFormat(d?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case h.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${a.toFormat(d?
"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function B(a,b){switch(b){case h.FeatureServiceDatabaseType.FILEGDB:case h.FeatureServiceDatabaseType.Standardised:case h.FeatureServiceDatabaseType.StandardisedNoInterval:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case h.FeatureServiceDatabaseType.Oracle:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";case h.FeatureServiceDatabaseType.SqlServer:return a?"CAST(GETDATE() AS DATE)":"GETDATE()";case h.FeatureServiceDatabaseType.PGDB:return a?
"CURRENT_DATE":"CURRENT_TIMESTAMP";case h.FeatureServiceDatabaseType.Postgres:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return a?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function n(a,b,c,d){switch(b.type){case "interval":return"integer";case "case-expression":var f=[];if("simple"===b.format)for(var e=0;e<b.clauses.length;e++)f.push(n(a,b.clauses[e].value,c,d));else for(e=0;e<b.clauses.length;e++)f.push(n(a,b.else,c,d));null!==b.else&&f.push(n(a,b.else,c,d));return x(f);case "parameter":a=d[b.value.toLowerCase()];
if(void 0===a&&c){b=c[b.value.toLowerCase()];if(void 0===b||null===b)return"";if("string"===typeof b||b instanceof String)return"string";if("boolean"===typeof b)return"boolean";if(h.isDate(b)||h.isArcadeDate(b))return"date";if("number"===typeof b)return 0===b%1?"integer":"double"}return void 0===a?"":a;case "expression-list":f=[];for(e of b.value)f.push(n(a,e,c,d));return f;case "unary-expression":return"boolean";case "binary-expression":switch(b.operator){case "AND":return"boolean";case "OR":return"boolean";
case "IS":if("null"!==b.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case "ISNOT":if("null"!==b.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case "IN":return"boolean";case "NOT IN":return"boolean";case "BETWEEN":return"boolean";case "NOTBETWEEN":return"boolean";case "LIKE":return"boolean";case "NOT LIKE":return"boolean";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"boolean";case "*":case "-":case "+":case "/":return x([n(a,
b.left,c,d),n(a,b.right,c,d)]);case "||":return"string";default:throw new k.SqlError(k.SqlErrorCodes.UnsupportedOperator,{operator:b.operator});}case "null":return"";case "boolean":return"boolean";case "string":return"string";case "number":return null===b.value?"":0===b.value%1?"integer":"double";case "date":return"date";case "timestamp":return"date";case "current-time":return"date";case "column-reference":return b=a[b.column.toLowerCase()],void 0===b?"":b;case "function":switch(b.name.toLowerCase()){case "cast":switch(b.args?.value[1]?.value.type??
""){case "integer":case "smallint":return"integer";case "real":case "float":return"double";case "date":case "timestamp":return"date";case "varchar":return"string";default:return""}case "position":case "extract":case "char_length":case "mod":return"integer";case "round":b=n(a,b.args,c,d);if(b instanceof Array){if(0>=b.length)return"double";b=b[0]}return b;case "sign":return"integer";case "ceiling":case "floor":case "abs":return b=n(a,b.args,c,d),b instanceof Array&&(b=x(b)),"integer"===b||"double"===
b?b:"double";case "area":case "length":case "log":case "log10":case "sin":case "cos":case "tan":case "asin":case "acos":case "atan":case "cosh":case "sinh":case "tanh":case "power":return"double";case "substring":case "trim":case "concat":case "lower":case "upper":return"string";case "truncate":return"double";case "nullif":b=n(a,b.args,c,d);if(b instanceof Array){if(0<b.length)return b[0];break}return b;case "coalesce":if(b=n(a,b.args,c,d),b instanceof Array){if(0<b.length)return b[0]}else return b}return""}throw new k.SqlError(k.SqlErrorCodes.UnsupportedSyntax,
{node:b.type});}function x(a){if(a){let b="";for(const c of a)""!==c&&(b=""===b?c:D[b]<D[c]?c:b);return b}return""}function p(a,b){if(null===a||void 0===a)return!1;switch(a.type){case "when-clause":return p(a.operand,b)||p(a.value,b);case "case-expression":for(const c of a.clauses)if(p(c,b))return!0;if("simple"===a.format&&p(a.operand,b)||null!==a.else&&p(a.else,b))return!0;break;case "expression-list":for(const c of a.value)if(p(c,b))return!0;break;case "unary-expression":return p(a.expr,b);case "binary-expression":return p(a.left,
b)||p(a.right,b);case "column-reference":return b.toLowerCase()===a.column.toLowerCase();case "function":return p(a.args,b)}return!1}function A(a,b,c){let d="";d="interval-period"===b.type?""+b.period.toUpperCase():""+b.start.period.toUpperCase()+" TO "+b.end.period.toUpperCase();return"INTERVAL "+c+" "+a+" "+d}const D={boolean:1,string:2,integer:3,double:4,date:5};m.arcadeDateToSqlString=w;m.changeSqlTimeZones=function(a,b,c,d){a=t.WhereClause.create(a,b.fieldsIndex);return z(a,c,d)};m.changeWhereClauseTimeZone=
z;m.combine=function(a,b,c="AND"){return t.WhereClause.create("(("+v(a,h.FeatureServiceDatabaseType.Standardised)+")"+c+"("+v(b,h.FeatureServiceDatabaseType.Standardised)+"))",a.fieldsIndex)};m.convertIntervalToSql=A;m.isSingleField=function(a){return"column-reference"===a?.parseTree.type};m.makeDateString=r;m.makeToday=B;m.predictType=function(a,b,c={}){const d={},f={},e={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",
esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",guid:"guid",globalid:"guid",string:"string"};for(var l of b)b=l.type?e[l.type]:void 0,d[l.name.toLowerCase()]=void 0===b?"":b;for(const q in c)l=e[c[q]],f[q.toLowerCase()]=void 0===l?"":l;switch(n(d,a.parseTree,a.parameters,f)){case "double":return"double";
case "integer":return"integer";case "date":return"date";case "string":return"string";case "global-id":return"guid";case "guid":return"guid"}return""};m.reformulateWithoutField=function(a,b,c,d){return t.WhereClause.create(g(a.parseTree,h.FeatureServiceDatabaseType.Standardised,a.parameters,b,c),d)};m.scanForField=function(a,b){return p(a.parseTree,b)};m.toWhereClause=v;m.toWhereClauseFromTree=function(a,b,c){return g(a,b,c)};m.translateFunctionToDatabaseSpecific=C;Object.defineProperty(m,Symbol.toStringTag,
{value:"Module"})});
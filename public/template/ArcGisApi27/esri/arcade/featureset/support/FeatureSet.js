// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../arcadeTimeUtils ./cache ./errorsupport ./FeatureSetIterator ./IdSet ./shared ./stats ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/geometryEngineAsync ../../../geometry/SpatialReference ../../../layers/support/FieldsIndex".split(" "),function(y,z,t,n,A,v,m,q,w,r,u,B,C){let x=function(){function k(a){this.featureSetQueryInterceptor=this.recentlyUsedQueries=null;this._idstates=[];this._mainSetInUse=this._wset=this._parent=
null;this._maxProcessing=200;this._maxQuery=500;this._totalCount=-1;this._databaseType=m.FeatureServiceDatabaseType.NotEvaluated;this._databaseTypeProbed=null;this.declaredRootClass="esri.arcade.featureset.support.FeatureSet";this._featureCache=[];this.fields=this.types=this.typeIdField=null;this.globalIdField=this.objectIdField=this.geometryType="";this.spatialReference=null;this.loaded=this._transparent=this.hasZ=this.hasM=!1;this._dateFieldIndex=this._fieldsIndex=this._loadPromise=null;a&&a.lrucache&&
(this.recentlyUsedQueries=a.lrucache);a&&a.interceptor&&(this.featureSetQueryInterceptor=a.interceptor)}var e=k.prototype;e.optimisePagingFeatureQueries=function(a){this._parent&&this._parent.optimisePagingFeatureQueries(a)};e._hasMemorySource=function(){return!0};e.prop=function(a,b){if(void 0===b)return this[a];void 0!==this[a]&&(this[a]=b);return this};e.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent};e._ensureLoaded=function(){return this.load()};
e.load=function(){null===this._loadPromise&&(this._loadPromise=this.loadImpl());return this._loadPromise};e.loadImpl=async function(){if(!0===this._parent?.loaded)return this._initialiseFeatureSet(),this;await this._parent?.load();this._initialiseFeatureSet();return this};e._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,
this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.globalIdField=this.objectIdField=this.typeIdField="",this.spatialReference=new B({wkid:4326}),this.geometryType=m.layerGeometryEsriConstants.point)};e.getField=function(a,b){let c;if(b=b||this.fields)a=a.toLowerCase(),b.some(d=>{d&&d.name.toLowerCase()===a&&(c=d);return!!c});return c};e.getFieldsIndex=
function(){null===this._fieldsIndex&&(this._fieldsIndex=new C(this.fields));return this._fieldsIndex};e._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())};e._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery};e._checkCancelled=function(a){if(null!=a&&a.aborted)throw new n.FeatureSetError(n.FeatureSetErrorCodes.Cancelled);
};e.nativeCapabilities=function(){return this._parent.nativeCapabilities()};e._canDoAggregates=async function(a,b,c,d,f){return null===this._parent?!1:this._parent._canDoAggregates(a,b,c,d,f)};e._getAggregatePagesDataSourceDefinition=async function(a,b,c,d,f,g,h){if(null===this._parent)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach);return this._parent._getAggregatePagesDataSourceDefinition(a,b,c,d,f,g,h)};e._getAgregagtePhysicalPage=async function(a,b,c){if(null===this._parent)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NeverReach);
return this._parent._getAgregagtePhysicalPage(a,b,c)};e.databaseType=async function(){if(this._databaseType===m.FeatureServiceDatabaseType.NotEvaluated){if(null!==t.applicationCache){const a=t.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==a)return a}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),null!==t.applicationCache&&t.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),
this._databaseTypeProbed)}catch(a){throw null!==t.applicationCache&&t.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),a;}return this._databaseTypeProbed}return this._databaseType};e._getDatabaseTypeImpl=async function(){const a=[{thetype:m.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) \x3d CAST( '2015-01-01' as DATETIME)) AND OBJECTID\x3c0"},{thetype:m.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') \x3d TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID\x3c0"},
{thetype:m.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' \x3d date '2015-01-01 10:10:10') AND OBJECTID\x3c0"}];for(const b of a)if(!0===await this._runDatabaseProbe(b.testwhere))return b.thetype;return m.FeatureServiceDatabaseType.StandardisedNoInterval};e._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"};e._runDatabaseProbe=async function(a){if(null!==this._parent)return this._parent._runDatabaseProbe(a);throw new n.FeatureSetError(n.FeatureSetErrorCodes.NotImplemented);
};e.isTable=function(){return this._parent?.isTable()??!1};e._featureFromCache=function(a){if(void 0!==this._featureCache[a])return this._featureCache[a]};e._isInFeatureSet=function(a){return m.IdState.Unknown};e._getSet=function(a){throw new n.FeatureSetError(n.FeatureSetErrorCodes.NotImplemented);};e._getFeature=async function(a,b,c){this._checkCancelled(c);if(void 0!==this._featureFromCache(b))return this._featureFromCache(b);await this._getFeatures(a,b,this._maxProcessingRate(),c);this._checkCancelled(c);
if(void 0!==this._featureFromCache(b))return this._featureFromCache(b);throw new n.FeatureSetError(n.FeatureSetErrorCodes.MissingFeatures);};e._getFeatureBatch=async function(a,b){this._checkCancelled(b);const c=new v([],a,!1,null),d=[];await this._getFeatures(c,-1,a.length,b);this._checkCancelled(b);for(const f of a)void 0!==this._featureFromCache(f)&&d.push(this._featureFromCache(f));return d};e._getFeatures=async function(a,b,c,d){return"success"};e._getFilteredSet=function(a,b,c,d,f){throw new n.FeatureSetError(n.FeatureSetErrorCodes.NotImplemented);
};e._refineSetBlock=async function(a,b,c){if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQueryRate()))return await this._expandPagedSet(a,this._maxQueryRate(),0,0,c),this._refineSetBlock(a,b,c);this._checkCancelled(c);var d=a._candidates.length;this._refineKnowns(a,b);let f=d-a._candidates.length;if(0===a._candidates.length||f>=b)return a;await this._refineIfParentKnown(a,b-f,c);this._checkCancelled(c);this._refineKnowns(a,b-f);f=d-a._candidates.length;if(f<b&&0<a._candidates.length){d=
b-f;const g=this._prepareFetchAndRefineSet(a._candidates);await this._fetchAndRefineFeatures(g,g.length>d?d:a._candidates.length,c);this._checkCancelled(c);this._refineKnowns(a,b-f)}return a};e._fetchAndRefineFeatures=function(a,b,c){return null};e._prepareFetchAndRefineSet=function(a){const b=[];for(let c=0;c<a.length;c++)this._isPhysicalFeature(a[c])&&b.push(a[c]);return b};e._isPhysicalFeature=function(a){return null===this._parent?!0:this._parent._isPhysicalFeature(a)};e._refineKnowns=function(a,
b){let c=0,d=null;const f=[];b=this._maxQueryRate();for(let g=0;g<a._candidates.length&&"GETPAGES"!==a._candidates[g];g++){let h=!1;const l=this._candidateIdTransform(a._candidates[g]);l!==a._candidates[g]&&(h=!0);const p=this._isInFeatureSet(l);if(p===m.IdState.InFeatureSet)!0===h?a._known.includes(l)||(a._known.push(l),c+=1):(a._known.push(a._candidates[g]),c+=1),null===d?d={start:g,end:g}:d.end===g-1?d.end=g:(f.push(d),d={start:g,end:g});else if(p===m.IdState.NotInFeatureSet)null===d?d={start:g,
end:g}:d.end===g-1?d.end=g:(f.push(d),d={start:g,end:g}),c+=1;else if(p===m.IdState.Unknown&&(c+=1,!0===a._ordered))break;if(c>=b)break}null!==d&&f.push(d);for(b=f.length-1;0<=b;b--)a._candidates.splice(f[b].start,f[b].end-f[b].start+1)};e._refineIfParentKnown=function(a,b,c){const d=new v([],[],a._ordered,null);d._candidates=a._candidates.slice(0);return this._parent._refineSetBlock(d,b,c)};e._candidateIdTransform=function(a){return this._parent._candidateIdTransform(a)};e._checkIfNeedToExpandKnownPage=
function(a,b){if(null===a.pagesDefinition)return!1;let c=0;for(let d=a._lastFetchedIndex;d<a._known.length;d++){if("GETPAGES"===a._known[d])return!0;if(void 0===this._featureCache[a._known[d]]&&(c+=1,c>=b))break}return!1};e._checkIfNeedToExpandCandidatePage=function(a,b){if(null===a.pagesDefinition)return!1;let c=0;for(let d=0;d<a._candidates.length;d++){if("GETPAGES"===a._candidates[d])return!0;c+=1;if(c>=b)break}return!1};e._expandPagedSet=async function(a,b,c,d,f){if(null===this._parent)throw new n.FeatureSetError(n.FeatureSetErrorCodes.NotImplemented);
return this._parent._expandPagedSet(a,b,c,d,f)};e._expandPagedSetFeatureSet=async function(a,b,c,d,f){0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]&&(d=1);0===d&&0<a._candidates.length&&"GETPAGES"===a._candidates[a._candidates.length-1]&&(d=2);if(0===d)return"finished";d=await this._getPage(a,d,f);return c+d<b?this._expandPagedSet(a,b,c+d,0,f):"success"};e._getPage=async function(a,b,c){const d=1===b?a._known:a._candidates;if(a.pagesDefinition.internal.set.length>a.pagesDefinition.resultOffset||
!0===a.pagesDefinition.internal.fullyResolved){--d.length;b=0;for(c=0;c<a.pagesDefinition.resultRecordCount&&!(a.pagesDefinition.resultOffset+c>=a.pagesDefinition.internal.set.length);c++)d[d.length]=a.pagesDefinition.internal.set[a.pagesDefinition.resultOffset+c],b++;a.pagesDefinition.resultOffset+=b;c=!1;!0===a.pagesDefinition.internal.fullyResolved&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset&&(c=!0);!1===c&&d.push("GETPAGES");return b}await this._getPhysicalPage(a,b,
c);return this._getPage(a,b,c)};e._getPhysicalPage=function(a,b,c){return null};e._clonePageDefinition=function(a){return null===this._parent?null:this._parent._clonePageDefinition(a)};e._first=function(a){return this.iterator(a).next()};e.first=function(a){return this._first(a)};e.calculateStatistic=async function(a,b,c,d){await this._ensureLoaded();let f=await this._stat(a,b,"",null,null,c,d);!1===f.calculated&&(f=await this._manualStat(a,b,c,d));return f.result};e._manualStat=async function(a,
b,c,d){let f=null;switch(a.toLowerCase()){case "count":return f=await q.count(this,d),{calculated:!0,result:f};case "distinct":return f=await q.distinct(this,b,c,d),{calculated:!0,result:f};case "avg":case "mean":return f=await q.mean(this,b,d),{calculated:!0,result:f};case "stdev":return f=await q.stdev(this,b,d),{calculated:!0,result:f};case "variance":return f=await q.variance(this,b,d),{calculated:!0,result:f};case "sum":return f=await q.sum(this,b,d),{calculated:!0,result:f};case "min":return f=
await q.min(this,b,d),{calculated:!0,result:f};case "max":return f=await q.max(this,b,d),{calculated:!0,result:f};default:return{calculated:!0,result:0}}};e._stat=async function(a,b,c,d,f,g,h){const l=await this._parent._stat(a,b,c,d,f,g,h);return!1===l.calculated?null===f&&""===c&&null===d?this._manualStat(a,b,g,h):{calculated:!1}:l};e._unionAllGeomSelf=function(a){const b=this.iterator(this._defaultTracker(a)),c=[];return new Promise((d,f)=>{this._unionShapeInBatches(c,b,d,f)})};e._unionAllGeom=
function(a){return new Promise((b,c)=>{const d=this.iterator(this._defaultTracker(a));this._unionShapeInBatches([],d,b,c)})};e._unionShapeInBatches=function(a,b,c,d){b.next().then(f=>{try{null!==f&&null!==f.geometry&&a.push(f.geometry),30<a.length||null===f&&1<a.length?u.union(a).then(g=>{try{null===f?c(g):(a=[g],this._unionShapeInBatches(a,b,c,d))}catch(h){d(h)}},d):null===f?1===a.length?c(a[0]):c(null):this._unionShapeInBatches(a,b,c,d)}catch(g){d(g)}},d)};e.iterator=function(a){return new A(this,
a)};e.intersection=function(a,b=!1){return k._featuresetFunctions.intersection.bind(this)(a,b)};e.difference=function(a,b=!1,c=!0){return k._featuresetFunctions.difference.bind(this)(a,b,c)};e.symmetricDifference=function(a,b=!1,c=!0){return k._featuresetFunctions.symmetricDifference.bind(this)(a,b,c)};e.morphShape=function(a,b,c="unknown",d=null){return k._featuresetFunctions.morphShape.bind(this)(a,b,c,d)};e.morphShapeAndAttributes=function(a,b,c="unknown"){return k._featuresetFunctions.morphShapeAndAttributes.bind(this)(a,
b,c)};e.union=function(a,b=!1){return k._featuresetFunctions.union.bind(this)(a,b)};e.intersects=function(a){return k._featuresetFunctions.intersects.bind(this)(a)};e.envelopeIntersects=function(a){return k._featuresetFunctions.envelopeIntersects.bind(this)(a)};e.contains=function(a){return k._featuresetFunctions.contains.bind(this)(a)};e.overlaps=function(a){return k._featuresetFunctions.overlaps.bind(this)(a)};e.relate=function(a,b){return k._featuresetFunctions.relate.bind(this)(a,b)};e.within=
function(a){return k._featuresetFunctions.within.bind(this)(a)};e.touches=function(a){return k._featuresetFunctions.touches.bind(this)(a)};e.top=function(a){return k._featuresetFunctions.top.bind(this)(a)};e.crosses=function(a){return k._featuresetFunctions.crosses.bind(this)(a)};e.buffer=function(a,b,c,d=!0){return k._featuresetFunctions.buffer.bind(this)(a,b,c,d)};e.filter=function(a,b=null){return k._featuresetFunctions.filter.bind(this)(a,b)};e.orderBy=function(a){return k._featuresetFunctions.orderBy.bind(this)(a)};
e.dissolve=function(a,b){return k._featuresetFunctions.dissolve.bind(this)(a,b)};e.groupby=function(a,b){return k._featuresetFunctions.groupby.bind(this)(a,b)};e.reduce=function(a,b=null,c){return new Promise((d,f)=>{this._reduceImpl(this.iterator(this._defaultTracker(c)),a,b,0,d,f,0)})};e._reduceImpl=function(a,b,c,d,f,g,h){try{h++,1E3<h?setTimeout(()=>{h=0;this._reduceImpl(a,b,c,d,f,g,h)}):a.next().then(l=>{try{if(null===l)f(c);else{const p=b(c,l,d,this);w.isPromiseLike(p)?p.then(D=>{this._reduceImpl(a,
b,D,d+1,f,g,h)},g):this._reduceImpl(a,b,p,d+1,f,g,h)}}catch(p){g(p)}},g)}catch(l){g(l)}};e.removeField=function(a){return k._featuresetFunctions.removeField.bind(this)(a)};e.addField=function(a,b,c=null){return k._featuresetFunctions.addField.bind(this)(a,b,c)};e.sumArea=function(a,b=!1,c){const d=m.convertSquareUnitsToCode(a);return this.reduce((f,g)=>null===g.geometry?0:b?u.geodesicArea(g.geometry,d).then(h=>f+h):u.planarArea(g.geometry,d).then(h=>f+h),0,c)};e.sumLength=function(a,b=!1,c){const d=
m.convertLinearUnitsToCode(a);return this.reduce((f,g)=>null===g.geometry?0:b?u.geodesicLength(g.geometry,d).then(h=>f+h):u.planarLength(g.geometry,d).then(h=>f+h),0,c)};e._substituteVars=function(a,b){if(null!==b){const c={};for(const d in b)c[d.toLowerCase()]=b[d];a.parameters=c}};e.distinct=async function(a,b=1E3,c=null,d){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,c);return this.calculateStatistic("distinct",a,b,this._defaultTracker(d))};e.min=async function(a,
b=null,c){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("min",a,-1,this._defaultTracker(c))};e.max=async function(a,b=null,c){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("max",a,-1,this._defaultTracker(c))};e.avg=async function(a,b=null,c){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("avg",
a,-1,this._defaultTracker(c))};e.sum=async function(a,b=null,c){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("sum",a,-1,this._defaultTracker(c))};e.stdev=async function(a,b=null,c){await this.load();a=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("stdev",a,-1,this._defaultTracker(c))};e.variance=async function(a,b=null,c){await this.load();a=r.WhereClause.create(a,
this.getFieldsIndex());this._substituteVars(a,b);return this.calculateStatistic("variance",a,-1,this._defaultTracker(c))};e.count=async function(a){await this.load();return this.calculateStatistic("count",r.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(a))};e._defaultTracker=function(a){return a??{aborted:!1}};e.forEach=function(a,b){return new Promise((c,d)=>{this._forEachImpl(this.iterator(this._defaultTracker(b)),a,this,c,d,0)})};e._forEachImpl=function(a,b,c,d,f,g){try{g++,
1E3<g?setTimeout(()=>{g=0;this._forEachImpl(a,b,c,d,f,g)},0):a.next().then(h=>{try{if(null===h)d(c);else{const l=b(h);void 0===l||null===l?this._forEachImpl(a,b,c,d,f,g):w.isPromiseLike(l)?l.then(()=>{try{this._forEachImpl(a,b,c,d,f,g)}catch(p){f(p)}},f):this._forEachImpl(a,b,c,d,f,g)}}catch(l){f(l)}},f)}catch(h){f(h)}};e.convertToJSON=function(a){const b={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let c=0;c<this.fields.length;c++)b.layerDefinition.fields.push(m.esriFieldToJson(this.fields[c]));
return this.reduce((c,d)=>{c={geometry:d.geometry&&d.geometry.toJSON(),attributes:{}};for(const f in d.attributes)c.attributes[f]=d.attributes[f];b.featureSet.features.push(c);return 1},0,a).then(()=>b)};e.castToText=function(a){return"object, FeatureSet"};e.queryAttachments=function(a,b,c,d,f){return this._parent.queryAttachments(a,b,c,d,f)};e.serviceUrl=function(){return this._parent.serviceUrl()};e.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map(a=>
({name:a.name,code:a.id})):[]}:null};e.relationshipMetaData=function(){return this._parent.relationshipMetaData()};e.schema=function(){const a=[];for(const b of this.fields)a.push(m.esriFieldToJson(b));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===m.layerGeometryEsriRestConstants[this.geometryType]?"esriGeometryNull":m.layerGeometryEsriRestConstants[this.geometryType],fields:a}};e.convertToText=async function(a,b){if("schema"===a)return await this._ensureLoaded(),
JSON.stringify(this.schema());if("featureset"===a){await this._ensureLoaded();const c=[];await this.reduce((d,f)=>{d={geometry:f.geometry?f.geometry.toJSON():null,attributes:f.attributes};null!==d.geometry&&d.geometry.spatialReference&&delete d.geometry.spatialReference;c.push(d);return 1},0,b);a=this.schema();a.features=c;a.spatialReference=this.spatialReference.toJSON();return JSON.stringify(a)}return this.castToText()};e.getFeatureByObjectId=function(a,b){return this._parent.getFeatureByObjectId(a,
b)};e.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()};e.getIdentityUser=function(){return this._parent.getIdentityUser()};e.getRootFeatureSet=function(){return null!==this._parent?this._parent.getRootFeatureSet():this};e.getDataSourceFeatureSet=function(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this};e.castAsJson=function(a=null){return"keeptype"===a?.featureset?this:"none"===a?.featureset?null:{type:"FeatureSet"}};e.castAsJsonAsync=async function(a=
null,b=null){if("keeptype"===b?.featureset)return this;if("schema"===b?.featureset)return await this._ensureLoaded(),JSON.parse(JSON.stringify(this.schema()));if("none"===b?.featureset)return null;await this._ensureLoaded();const c=[];await this.reduce((d,f)=>{d={geometry:f.geometry?!0===b?.keepGeometryType?f.geometry:f.geometry.toJSON():null,attributes:f.attributes};null!==d.geometry&&d.geometry.spatialReference&&!0!==b?.keepGeometryType&&delete d.geometry.spatialReference;c.push(d);return 1},0,
a);a=this.schema();a.features=c;a.spatialReference=!0===b?.keepGeometryType?this.spatialReference:this.spatialReference?.toJSON();return a};e.fieldTimeZone=function(a){return this.dateTimeReferenceFieldIndex.fieldTimeZone(a)};y._createClass(k,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}},{key:"dateTimeReferenceFieldIndex",get:function(){null===this._dateFieldIndex&&(this._dateFieldIndex=z.DateTimeReferenceFieldIndex.create(this.getFieldsIndex(),this));return this._dateFieldIndex}},
{key:"preferredTimeReference",get:function(){return this._parent?.preferredTimeReference??null}},{key:"dateFieldsTimeReference",get:function(){return this._parent?.dateFieldsTimeReference??null}},{key:"datesInUnknownTimezone",get:function(){return this._parent.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._parent?.editFieldsInfo??null}},{key:"timeInfo",get:function(){return this._parent?.timeInfo??null}}]);return k}();x._featuresetFunctions={};return x});
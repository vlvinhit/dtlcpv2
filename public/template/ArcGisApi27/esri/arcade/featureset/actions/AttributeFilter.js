// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/SpatialReference".split(" "),function(q,r,t,l,g,p,w,u,x){return function(v){function k(a){var b=v.call(this,a)||this;b.declaredClass="esri.arcade.featureset.actions.AttributeFilter";b._maxProcessing=1E3;b._parent=a.parentfeatureset;a.whereclause instanceof u.WhereClause?(b._whereclause=
a.whereclause,b._whereClauseFunction=null):(b._whereClauseFunction=a.whereclause,b._whereclause=null);return b}q._inherits(k,v);var f=k.prototype;f._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=
this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.globalIdField=this.objectIdField=this.typeIdField="",this.spatialReference=new x({wkid:4326}),this.geometryType=g.layerGeometryEsriConstants.point)};f._getSet=async function(a){if(null===this._wset){await this._ensureLoaded();const b=await this._parent._getFilteredSet("",null,this._whereclause,null,a);this._checkCancelled(a);this._wset=null!==this._whereClauseFunction?new l(b._candidates.slice(0).concat(b._known.slice(0)),
[],b._ordered,this._clonePageDefinition(b.pagesDefinition)):new l(b._candidates.slice(0),b._known.slice(0),b._ordered,this._clonePageDefinition(b.pagesDefinition))}return this._wset};f._isInFeatureSet=function(a){let b=this._parent?._isInFeatureSet(a);if(b===g.IdState.NotInFeatureSet)return b;b=this._idstates[a];return void 0===b?g.IdState.Unknown:b};f._getFeature=function(a,b,d){return this._parent._getFeature(a,b,d)};f._getFeatures=function(a,b,d,e){return this._parent._getFeatures(a,b,d,e)};f._featureFromCache=
function(a){return this._parent._featureFromCache(a)};f.executeWhereClause=function(a){return this._whereclause?.testFeature(a)??!1};f.executeWhereClauseDeferred=async function(a){return null!==this._whereClauseFunction?(a=this._whereClauseFunction(a),w.isPromiseLike(a),a):this.executeWhereClause(a)};f._fetchAndRefineFeatures=async function(a,b,d){var e=new l([],a,!1,null),c=Math.min(b,a.length);await this._parent?._getFeatures(e,-1,c,d);this._checkCancelled(d);if(null==this._whereClauseFunction){for(b=
0;b<c;b++)d=this._parent?._featureFromCache(a[b]),!0===this.executeWhereClause(d)?this._idstates[a[b]]=g.IdState.InFeatureSet:this._idstates[a[b]]=g.IdState.NotInFeatureSet;return"success"}d=[];for(e=0;e<c;e++){const h=this._parent?._featureFromCache(a[e]);d.push(await this.executeWhereClauseDeferred(h))}for(c=0;c<b;c++)this._idstates[a[c]]=!0===d[c]?g.IdState.InFeatureSet:g.IdState.NotInFeatureSet;return"success"};f._getFilteredSet=async function(a,b,d,e,c){null===this._whereClauseFunction&&(null!==
d?null!==this._whereclause&&(d=p.combine(this._whereclause,d)):d=this._whereclause);await this._ensureLoaded();a=await this._parent._getFilteredSet(a,b,d,e,c);this._checkCancelled(c);return null!==this._whereClauseFunction?new l(a._candidates.slice(0).concat(a._known.slice(0)),[],a._ordered,this._clonePageDefinition(a.pagesDefinition)):new l(a._candidates.slice(0),a._known.slice(0),a._ordered,this._clonePageDefinition(a.pagesDefinition))};f._stat=async function(a,b,d,e,c,h,m){if(null!==this._whereClauseFunction)return null===
c&&""===d&&null===e?this._manualStat(a,b,h,m):{calculated:!1};var n=this._whereclause;null!==c&&null!==this._whereclause&&(n=p.combine(this._whereclause,c));n=await this._parent._stat(a,b,d,e,n,h,m);return!1===n.calculated?null===c&&""===d&&null===e?this._manualStat(a,b,h,m):{calculated:!1}:n};f._canDoAggregates=async function(a,b,d,e,c){if(null!==this._whereClauseFunction)return!1;null!==c?null!==this._whereclause&&(c=p.combine(this._whereclause,c)):c=this._whereclause;return null===this._parent?
!1:this._parent._canDoAggregates(a,b,d,e,c)};f._getAggregatePagesDataSourceDefinition=async function(a,b,d,e,c,h,m){if(null===this._parent)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);null!==c?null!==this._whereclause&&(c=p.combine(this._whereclause,c)):c=this._whereclause;return this._parent._getAggregatePagesDataSourceDefinition(a,b,d,e,c,h,m)};k.registerAction=function(){t._featuresetFunctions.filter=function(a){if("function"===typeof a)return new k({parentfeatureset:this,whereclause:a});
let b=null;a instanceof u.WhereClause&&(b=a);return new k({parentfeatureset:this,whereclause:b})}};return q._createClass(k)}(t)});
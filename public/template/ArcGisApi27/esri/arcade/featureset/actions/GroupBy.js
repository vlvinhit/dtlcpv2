// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../../chunks/languageUtils ./Adapted ./AttributeFilter ./OrderBy ../support/FeatureSet ../support/IdSet ../support/OrderbyClause ../support/shared ../support/sqlUtils ../support/stats ../support/StatsField ../../../core/MD5 ../../../core/sql/WhereClause ../../../geometry/SpatialReference ../../../layers/support/Field ../../../layers/support/FieldsIndex ../support/errorsupport".split(" "),function(z,A,G,x,H,B,C,t,D,p,m,q,E,F,u,I,
y,J,n){function K(v){if(!v)return"COUNT";switch(v.toLowerCase()){case "max":return"MAX";case "var":case "variance":return"VAR";case "avg":case "average":case "mean":return"AVG";case "min":return"MIN";case "sum":return"SUM";case "stdev":case "stddev":return"STDDEV"}return"COUNT"}return function(v){function w(a){var b=v.call(this,a)||this;b._decodedStatsfield=[];b._decodedGroupbyfield=[];b._candosimplegroupby=!0;b.phsyicalgroupbyfields=[];b.objectIdField="ROW__ID";b._internalObjectIdField="ROW__ID";
b._adaptedFields=[];b.declaredClass="esri.arcade.featureset.actions.Aggregate";b._uniqueIds=1;b._maxQuery=10;b._maxProcessing=10;b._parent=a.parentfeatureset;b._config=a;return b}z._inherits(w,v);var h=w.prototype;h.isTable=function(){return!0};h._getSet=async function(a){null===this._wset&&(this._wset=await this._getFilteredSet("",null,null,null,a));return this._wset};h._isInFeatureSet=function(){return p.IdState.InFeatureSet};h._nextUniqueName=function(a){for(;1===a["T"+this._uniqueIds.toString()];)this._uniqueIds++;
const b="T"+this._uniqueIds.toString();a[b]=1;return b};h._convertToEsriFieldType=function(a){return a};h._initialiseFeatureSet=function(){const a={};var b=!1;let d=1;var c=this._parent?this._parent.getFieldsIndex():new J([]);this.objectIdField="ROW__ID";for(this.globalIdField="";!1===b;){let r=!1;for(var e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){r=!0;break}if(!1===r)for(e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===
this.objectIdField.toLowerCase()){r=!0;break}!1===r?b=!0:(this.objectIdField="ROW__ID"+d.toString(),d++)}for(var g of this._config.statsfields)b=new E,b.field=g.name,b.tofieldname=g.name,b.workingexpr=g.expression instanceof u.WhereClause?g.expression:u.WhereClause.create(g.expression,c),b.typeofstat=K(g.statistic),this._decodedStatsfield.push(b);this._decodedGroupbyfield=[];for(var f of this._config.groupbyfields)g={name:f.name,singlefield:null,tofieldname:f.name,expression:f.expression instanceof
u.WhereClause?f.expression:u.WhereClause.create(f.expression,c)},this._decodedGroupbyfield.push(g);if(null!==this._parent){this.geometryType=this._parent.geometryType;this.spatialReference=this._parent.spatialReference;this.hasM=this._parent.hasM;this.hasZ=this._parent.hasZ;this.typeIdField="";for(const r of this._parent.fields)a[r.name.toUpperCase()]=1;this.types=null}else this.geometryType=p.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new I({wkid:4326});
this.fields=[];c=new E;c.field=this._nextUniqueName(a);c.tofieldname=this.objectIdField;c.workingexpr=u.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex());c.typeofstat="MIN";this._decodedStatsfield.push(c);for(var k of this._decodedGroupbyfield){c=new y;k.name=this._nextUniqueName(a);c.name=k.tofieldname;c.alias=c.name;if(m.isSingleField(k.expression)){f=this._parent.getField(m.toWhereClause(k.expression,p.FeatureServiceDatabaseType.Standardised));if(!f)throw new n.FeatureSetError(n.FeatureSetErrorCodes.AggregationFieldNotFound);
k.name=f.name;k.singlefield=f.name;this.phsyicalgroupbyfields.push(f.name);c.type=f.type}else c.type=this._convertToEsriFieldType(m.predictType(k.expression,this._parent.fields)),f=new y,f.name=k.name,f.alias=f.name,this.phsyicalgroupbyfields.push(k.name),this._adaptedFields.push(new x.SqlExpressionAdapted(f,k.expression)),this._candosimplegroupby=!1;this.fields.push(c)}if(0<this._adaptedFields.length)for(var l of this._parent.fields)this._adaptedFields.push(new x.OriginalField(l));for(k=0;k<this._decodedStatsfield.length;k++){l=
new y;c=null;c=this._decodedStatsfield[k];c.field=this._nextUniqueName(a);c.tofieldname===this.objectIdField&&(this._internalObjectIdField=c.field);l.name=c.tofieldname;l.alias=l.name;c=null!==c.workingexpr?m.isSingleField(c.workingexpr)?m.toWhereClause(c.workingexpr,p.FeatureServiceDatabaseType.Standardised):"":"";switch(this._decodedStatsfield[k].typeofstat){case "SUM":if(""!==c){c=this._parent.getField(c);if(!c)throw new n.FeatureSetError(n.FeatureSetErrorCodes.AggregationFieldNotFound);l.type=
c.type}else l.type="double";break;case "MIN":case "MAX":if(""!==c){c=this._parent.getField(c);if(!c)throw new n.FeatureSetError(n.FeatureSetErrorCodes.AggregationFieldNotFound);l.type=c.type}else l.type="double";break;case "COUNT":l.type="integer";break;case "STDDEV":case "VAR":case "AVG":if(""!==c&&(c=this._parent.getField(c),!c))throw new n.FeatureSetError(n.FeatureSetErrorCodes.AggregationFieldNotFound);l.type="double"}this.fields.push(l)}};h._canDoAggregates=async function(){return!1};h._getFeatures=
async function(a,b,d,c){const e=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(a,e)?(await this._expandPagedSet(a,e,0,0,c),this._getFeatures(a,b,d,c)):"success"};h._getFilteredSet=async function(a,b,d,c,e){if(""!==a)return new t([],[],!0,null);a=null;a=b=!1;await this._ensureLoaded();if(null!==d)for(var g=0;g<this._decodedStatsfield.length;g++)if(!0===m.scanForField(d,this._decodedStatsfield[g].tofieldname)){a=!0;d=null;break}if(null!==c){b=!0;for(g=0;g<this._decodedStatsfield.length;g++)if(!0===
c.scanForField(this._decodedStatsfield[g].tofieldname)){c=null;b=!1;break}if(null!==c)for(var f of this._decodedGroupbyfield)if(null===f.singlefield&&!0===c.scanForField(f.tofieldname)){c=null;b=!1;break}}if(!1===this._candosimplegroupby?0:await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null))return f=null,d&&(f=this._reformulateWhereClauseWithoutGroupByFields(d)),d=null,c&&(d=this._reformulateOrderClauseWithoutGroupByFields(c)),d=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,
this._decodedStatsfield,"",null,f,d,this._internalObjectIdField),this._checkCancelled(e),a=!0===a?new t(d._candidates.slice(0).concat(d._known.slice(0)),[],!0===b?d._ordered:!1,this._clonePageDefinition(d.pagesDefinition)):new t(d._candidates.slice(0),d._known.slice(0),!0===b?d._ordered:!1,this._clonePageDefinition(d.pagesDefinition));e=this._parent;0<this._adaptedFields.length&&(e=new x.AdaptedFeatureSet({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}));!0===a?
a=new t(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:e,orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}):(null!==d&&(c=null,d&&(c=this._reformulateWhereClauseWithoutGroupByFields(d)),e=new H({parentfeatureset:e,whereclause:c})),a=new t(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,
resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:e,orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}));return a};h._reformulateWhereClauseWithoutStatsFields=function(a){for(const b of this._decodedStatsfield)a=m.reformulateWithoutField(a,b.tofieldname,m.toWhereClause(b.workingexpr,p.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex());
return a};h._reformulateWhereClauseWithoutGroupByFields=function(a){for(const b of this._decodedGroupbyfield)b.tofieldname!==b.name&&(a=m.reformulateWithoutField(a,b.tofieldname,m.toWhereClause(b.expression,p.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()));return a};h._reformulateOrderClauseWithoutGroupByFields=function(a){const b=[];for(const d of this._decodedGroupbyfield)d.tofieldname!==d.name&&b.push({field:d.tofieldname,newfield:d.name});return 0<b.length?a.replaceFields(b):
a};h._clonePageDefinition=function(a){return null===a?null:!0===a.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,internal:a.internal}:this._parent._clonePageDefinition(a)};h._refineSetBlock=async function(a,b,d){if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQuery))return await this._expandPagedSet(a,this._maxQuery,0,0,d),this._refineSetBlock(a,b,d);this._checkCancelled(d);this._refineKnowns(a,b);
return a};h._expandPagedSet=function(a,b,d,c,e){return this._expandPagedSetFeatureSet(a,b,d,c,e)};h._getPhysicalPage=async function(a,b,d){if(!0===a.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(a,a.pagesDefinition.resultRecordCount,d,[]);a=await this._getAgregagtePhysicalPage(a,b,d);for(const c of a){b={geometry:c.geometry,attributes:{}};d={};for(const e in c.attributes)d[e.toLowerCase()]=c.attributes[e];for(const e of this._decodedGroupbyfield)b.attributes[e.tofieldname]=
d[e.name.toLowerCase()];for(const e of this._decodedStatsfield)b.attributes[e.tofieldname]=d[e.field.toLowerCase()];this._featureCache[b.attributes[this.objectIdField]]=new A(b)}return a.length};h._sequentialGetPhysicalItem=function(a,b,d,c){return new Promise((e,g)=>{null===a.pagesDefinition.internal.iterator&&(a.pagesDefinition.internal.iterator=a.pagesDefinition.internal.subfeatureset.iterator(d));!0===a.pagesDefinition.internal.fullyResolved?e(c.length):0===b?e(c.length):this._nextAggregateItem(a,
b,d,c,f=>{null===f?e(c.length):(--b,e(this._sequentialGetPhysicalItem(a,b,d,c)))},g)})};h._nextAggregateItem=function(a,b,d,c,e,g){try{G.tick(a.pagesDefinition.internal.iterator.next()).then(f=>{if(null===f)null!==a.pagesDefinition.internal.workingItem&&(f=this._calculateAndAppendAggregateItem(a.pagesDefinition.internal.workingItem),c.push(f),a.pagesDefinition.internal.workingItem=null,a.pagesDefinition.internal.set.push(f.attributes[this.objectIdField])),a.pagesDefinition.internal.fullyResolved=
!0,e(null);else{const k=this._generateAggregateHash(f);if(null===a.pagesDefinition.internal.workingItem)a.pagesDefinition.internal.workingItem={features:[f],id:k};else{if(k!==a.pagesDefinition.internal.workingItem.id){const l=this._calculateAndAppendAggregateItem(a.pagesDefinition.internal.workingItem);c.push(l);a.pagesDefinition.internal.workingItem=null;a.pagesDefinition.internal.set.push(l.attributes[this.objectIdField]);--b;a.pagesDefinition.internal.workingItem={features:[f],id:k};e(l);return}a.pagesDefinition.internal.workingItem.features.push(f)}this._nextAggregateItem(a,
b,d,c,e,g)}},g)}catch(f){g(f)}};h._calculateFieldStat=function(a,b,d){const c=[];for(let e=0;e<a.features.length;e++)if(null!==b.workingexpr){const g=b.workingexpr.calculateValue(a.features[e]);null!==g&&c.push(g)}else c.push(null);switch(b.typeofstat){case "MIN":d.attributes[b.tofieldname]=q.calculateStat("min",c,-1);break;case "MAX":d.attributes[b.tofieldname]=q.calculateStat("max",c,-1);break;case "SUM":d.attributes[b.tofieldname]=q.calculateStat("sum",c,-1);break;case "COUNT":d.attributes[b.tofieldname]=
c.length;break;case "VAR":d.attributes[b.tofieldname]=q.calculateStat("var",c,-1);break;case "STDDEV":d.attributes[b.tofieldname]=q.calculateStat("stddev",c,-1);break;case "AVG":d.attributes[b.tofieldname]=q.calculateStat("avg",c,-1)}return!0};h._calculateAndAppendAggregateItem=function(a){const b={attributes:{},geometry:null};for(var d of this._decodedGroupbyfield){var c=d.singlefield?a.features[0].attributes[d.singlefield]:d.expression.calculateValue(a.features[0]);b.attributes[d.tofieldname]=c}for(const e of this._decodedStatsfield)this._calculateFieldStat(a,
e,b);d=[];for(c=0;c<this._decodedStatsfield.length;c++)d.push(this._calculateFieldStat(a,this._decodedStatsfield[c],b));this._featureCache[b.attributes[this.objectIdField]]=new A({attributes:b.attributes,geometry:b.geometry});return b};h._generateAggregateHash=function(a){let b="";for(const d of this._decodedGroupbyfield){const c=d.singlefield?a.attributes[d.singlefield]:d.expression.calculateValue(a);b=null===c||void 0===c?b+":":b+(":"+c.toString())}return F.createMD5Hash(b,F.outputTypes.String)};
h._stat=async function(){return{calculated:!1}};h.getFeatureByObjectId=async function(){return null};w.registerAction=function(){C._featuresetFunctions.groupby=function(a,b){return new w({parentfeatureset:this,groupbyfields:a,statsfields:b})}};return z._createClass(w)}(C)});
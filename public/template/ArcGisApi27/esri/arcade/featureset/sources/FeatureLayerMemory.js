// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/SubtypeGroupLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../rest/support/Query".split(" "),function(w,A,x,B,r,t,C,D,E,F,G,y,v){return function(z){function p(a){var b=z.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";
b._removeGeometry=!1;b._overrideFields=null;b._forceIsTable=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;!0===a.isTable&&(b._forceIsTable=!0);void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}w._inherits(p,z);var e=p.prototype;e._maxQueryRate=function(){return t.defaultMaxRecords};e.end=function(){return this._layer};e.optimisePagingFeatureQueries=
function(){};e.loadImpl=async function(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),this;await this._layer.load();this._initialiseFeatureSet();return this};e._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const a=
[],b=[];for(const c of this.fields)if("oid"===c.type)a.push(c),b.push(c.name);else for(const d of this._overrideFields)if(d.toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this.objectIdField=this._layer.objectIdField;for(const a of this.fields)"global-id"===a.type&&(this.globalIdField=a.name);this._databaseType=t.FeatureServiceDatabaseType.Standardised;this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ;this.hasM=!0===this._layer?.capabilities?.data?.supportsM;
this._layer instanceof F?(this.typeIdField=this._layer.subtypeField??"",this.types=this._layer.subtypes):(this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types)};e.isTable=function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType};e._isInFeatureSet=function(){return t.IdState.InFeatureSet};e._candidateIdTransform=function(a){return a};e._getSet=async function(a){return null===this._wset?(await this._ensureLoaded(),this._wset=
a=await this._getFilteredSet("",null,null,null,a)):this._wset};e._changeFeature=function(a){const b={};for(const c of this.fields)b[c.name]=a.attributes[c.name];return new A({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};e._getFilteredSet=async function(a,b,c,d,h){let k="",q=!1;null!==d&&(k=d.constructClause(),q=!0);if(this.isTable()&&b&&null!==a&&""!==a)return new r([],[],!0,null);d=new v;d.returnZ=this.hasZ;d.returnM=this.hasM;d.where=null===c?null===b?"1\x3d1":"":C.toWhereClause(c,
t.FeatureServiceDatabaseType.Standardised);d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;d.orderByFields=""!==k?k.split(","):null;d.geometry=null===b?null:b;d.returnGeometry=!0;d.relationParameter=this._makeRelationshipParam(a);a=await this._layer.queryFeatures(d);if(null===a)return new r([],[],q,null);this._checkCancelled(h);const u=[];a.features.forEach(n=>{const f=n.attributes[this._layer.objectIdField];u.push(f);this._featureCache[f]=this._changeFeature(n)});
return new r([],u,q,null)};e._makeRelationshipEnum=function(a){if(a.includes("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};
e._makeRelationshipParam=function(a){return a.includes("esriSpatialRelRelation")?a.split(":")[1]:""};e._queryAllFeatures=async function(){if(this._wset)return this._wset;const a=new v;a.where="1\x3d1";await this._ensureLoaded();if(this._layer.source&&this._layer.source.items){const c=[];this._layer.source.items.forEach(d=>{const h=d.attributes[this._layer.objectIdField];c.push(h);this._featureCache[h]=this._changeFeature(d)});return this._wset=new r([],c,!1,null)}a.returnZ=this.hasZ;a.returnM=this.hasM;
const b=[];(await this._layer.queryFeatures(a)).features.forEach(c=>{const d=c.attributes[this._layer.objectIdField];b.push(d);this._featureCache[d]=this._changeFeature(c)});return this._wset=new r([],b,!1,null)};e._getFeatures=async function(a,b,c){const d=[];-1!==b&&void 0===this._featureCache[b]&&d.push(b);for(let h=a._lastFetchedIndex;h<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[h]]&&(a._known[h]!==b&&d.push(a._known[h]),d.length>c));h++);if(0===d.length)return"success";
throw new x.FeatureSetError(x.FeatureSetErrorCodes.MissingFeatures);};e._refineSetBlock=async function(a){return a};e._stat=async function(){return{calculated:!1}};e._canDoAggregates=async function(){return!1};e.relationshipMetaData=function(){return[]};p._cloneAttr=function(a){const b={};for(const c in a)b[c]=a[c];return b};e.nativeCapabilities=function(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}};
p.create=function(a,b){var c=a.layerDefinition.objectIdField,d=a.layerDefinition.typeIdField??"";const h=[];if(a.layerDefinition.types)for(var k of a.layerDefinition.types)h.push(G.fromJSON(k));let q=a.layerDefinition.geometryType;void 0===q&&(q=a.featureSet.geometryType||"");k=a.featureSet.features;const u=b.toJSON();if(!c){var n=!1;for(var f of a.layerDefinition.fields)if("oid"===f.type||"esriFieldTypeOID"===f.type){c=f.name;n=!0;break}if(!1===n){c="FID";f=!0;for(n=0;f;){let l=!0;for(var m of a.layerDefinition.fields)if(m.name===
c){l=!1;break}!0===l?f=!1:(n++,c="FID"+n.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:c,alias:c});m=[];for(f=0;f<k.length;f++)m.push({geometry:a.featureSet.features[f].geometry,attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):{}}),m[f].attributes[c]=f;k=m}}m=[];for(var g of a.layerDefinition.fields)g instanceof y?m.push(g):m.push(y.fromJSON(g));(g=q)||(g="");switch(g){case "esriGeometryPoint":g="point";break;case "esriGeometryPolyline":g=
"polyline";break;case "esriGeometryPolygon":g="polygon";break;case "esriGeometryEnvelope":g="extent";break;case "esriGeometryMultipoint":g="multipoint";break;case "":case "esriGeometryNull":g="esriGeometryNull"}if("esriGeometryNull"!==g)for(const l of k)l.geometry&&!1===l.geometry instanceof D&&(l.geometry.type=g,void 0===l.geometry.spatialReference&&(l.geometry.spatialReference=u));else for(const l of k)l.geometry&&(l.geometry=null);d={outFields:["*"],source:k,fields:m,hasZ:!0===a?.layerDefinition?.hasZ||
!0===a?.featureSet?.hasZ,hasM:!0===a?.layerDefinition?.hasM||!0===a?.featureSet?.hasM,types:h,typeIdField:d,objectIdField:c,spatialReference:b};a="esriGeometryNull"===g||null===g;a||(d.geometryType=g);d=new E(d);return new p({layer:d,spatialReference:b,isTable:a})};e.queryAttachments=async function(){return[]};e.getFeatureByObjectId=async function(a){const b=new v;b.where=this.objectIdField+"\x3d"+a.toString();b.returnZ=this.hasZ;b.returnM=this.hasM;a=await this._layer.queryFeatures(b);return 1===
a.features.length?a.features[0]:null};e.getOwningSystemUrl=async function(){return""};e.getIdentityUser=async function(){return""};w._createClass(p,[{key:"gdbVersion",get:function(){return""}},{key:"preferredTimeReference",get:function(){return this._layer?.preferredTimeReference?.toJSON()??null}},{key:"dateFieldsTimeReference",get:function(){return this._layer?.dateFieldsTimeReference?.toJSON()??null}},{key:"datesInUnknownTimezone",get:function(){return this._layer?.datesInUnknownTimezone}},{key:"editFieldsInfo",
get:function(){return this._layer?.editFieldsInfo?.toJSON()??null}},{key:"timeInfo",get:function(){return this._layer?.timeInfo?.toJSON()??null}}]);return p}(B)});
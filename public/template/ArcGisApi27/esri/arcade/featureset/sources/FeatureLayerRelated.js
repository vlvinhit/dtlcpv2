// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../../../rest/support/RelationshipQuery".split(" "),function(p,v,q,w,m,r,t){return function(u){function n(a){var b=u.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated";b._findObjectId=-1;b._requestStandardised=!1;b._removeGeometry=!1;b._overrideFields=null;b.featureObjectId=null;a.spatialReference&&(b.spatialReference=
a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;b._findObjectId=a.objectId;b.featureObjectId=a.objectId;b.relationship=a.relationship;b._relatedLayer=a.relatedLayer;void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}p._inherits(n,u);var f=n.prototype;f._maxQueryRate=function(){return r.defaultMaxRecords};f.end=function(){return this._layer};f.optimisePagingFeatureQueries=function(){};
f.loadImpl=async function(){await Promise.all([this._layer.load(),this._relatedLayer?.load()]);this._initialiseFeatureSet();return this};f.nativeCapabilities=function(){return this._relatedLayer.nativeCapabilities()};f._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._relatedLayer.geometryType;this.fields=this._relatedLayer.fields.slice(0);this.hasZ=this._relatedLayer.hasZ;this.hasM=this._relatedLayer.hasM;if(null!==
this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var a=[];const b=[];for(const d of this.fields)if("oid"===d.type)a.push(d),b.push(d.name);else for(const c of this._overrideFields)if(c.toLowerCase()===d.name.toLowerCase()){a.push(d);b.push(d.name);break}this.fields=a;this._overrideFields=b}if(a=this._layer.nativeCapabilities())this._databaseType=a.databaseType,this._requestStandardised=a.requestStandardised;this.objectIdField=this._relatedLayer.objectIdField;
this.globalIdField=this._relatedLayer.globalIdField;this.hasM=this._relatedLayer.supportsM;this.hasZ=this._relatedLayer.supportsZ;this.typeIdField=this._relatedLayer.typeIdField;this.types=this._relatedLayer.types};f.databaseType=async function(){await this._relatedLayer.databaseType();return this._databaseType=this._relatedLayer._databaseType};f.isTable=function(){return this._relatedLayer.isTable()};f._isInFeatureSet=function(){return r.IdState.InFeatureSet};f._candidateIdTransform=function(a){return a};
f._getSet=async function(a){return null===this._wset?(await this._ensureLoaded(),this._wset=a=await this._getFilteredSet("",null,null,null,a)):this._wset};f._changeFeature=function(a){const b={};for(const d of this.fields)b[d.name]=a.attributes[d.name];return new v({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};f._getFilteredSet=async function(a,b,d,c,g){await this.databaseType();if(this.isTable()&&b&&null!==a&&""!==a)return new m([],[],!0,null);var e=this._layer.nativeCapabilities();
if(!1===e.canQueryRelated)return new m([],[],!0,null);if(e.capabilities?.queryRelated&&e.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(a,b,d,c,g);var h="";let k=!1;null!==c&&e.capabilities&&e.capabilities.queryRelated&&!0===e.capabilities.queryRelated.supportsOrderBy&&(h=c.constructClause(),k=!0);c=new t;c.objectIds=[this._findObjectId];var l=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(x=>
x.name):["*"]);c.outFields=l;c.relationshipId=this.relationship.id;c.where="1\x3d1";l=!0;!0===this._removeGeometry&&(l=!1);c.returnGeometry=l;this._requestStandardised&&(c.sqlFormat="standard");c.outSpatialReference=this.spatialReference;c.orderByFields=""!==h?h.split(","):null;e=await e.source.queryRelatedFeatures(c);this._checkCancelled(g);e=e[this._findObjectId]?e[this._findObjectId].features:[];g=[];for(h=0;h<e.length;h++)this._featureCache[e[h].attributes[this._relatedLayer.objectIdField]]=e[h],
g.push(e[h].attributes[this._relatedLayer.objectIdField]);a=b&&null!==a&&""!==a;d=null!==d&&void 0!==d;return new m(a||d?g:[],a||d?[]:g,k,null)};f._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(a.includes("*"))return a;let b=!1;for(const d of a)if(d.toUpperCase()===this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a};f._getFilteredSetUsingPaging=async function(a,b,d,c,g){let e="",h=!1;var k=this._layer.nativeCapabilities();
null!==c&&k&&k.capabilities?.queryRelated&&!0===k.capabilities.queryRelated.supportsOrderBy&&(e=c.constructClause(),h=!0);await this.databaseType();c=this._maxQueryRate();k=k.capabilities?.query.maxRecordCount;null!=k&&k<c&&(c=k);a=b&&null!==a&&""!==a;d=null!==d&&void 0!==d;b=null;b=!0;!0===this._removeGeometry&&(b=!1);k=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(l=>l.name):["*"]);b=new m(a||d?["GETPAGES"]:
[],a||d?[]:["GETPAGES"],h,{outFields:k.join(","),resultRecordCount:c,resultOffset:0,objectIds:[this._findObjectId],where:"1\x3d1",orderByFields:e,returnGeometry:b,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});await this._expandPagedSet(b,c,0,0,g);return b};f._expandPagedSet=function(a,b,d,c,g){return this._expandPagedSetFeatureSet(a,b,d,c,g)};f._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,outFields:a.outFields,resultRecordCount:a.resultRecordCount,
resultOffset:a.resultOffset,where:a.where,objectIds:a.objectIds,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,objectIds:a.objectIds,orderByFields:a.orderByFields,
returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};f._getPhysicalPage=async function(a,b,d){b=a.pagesDefinition.internal.lastRetrieved;var c=a.pagesDefinition.internal.lastPage,g=this._layer.nativeCapabilities();const e=new t;!0===this._requestStandardised&&(e.sqlFormat="standard");e.relationshipId=this.relationship.id;e.objectIds=a.pagesDefinition.objectIds;e.resultOffset=a.pagesDefinition.internal.lastPage;e.resultRecordCount=a.pagesDefinition.resultRecordCount;
e.outFields=a.pagesDefinition.outFields.split(",");e.where=a.pagesDefinition.where;e.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;e.returnGeometry=a.pagesDefinition.returnGeometry;e.outSpatialReference=this.spatialReference;g=await g.source.queryRelatedFeatures(e);this._checkCancelled(d);if(a.pagesDefinition.internal.lastPage!==c)return 0;d=g[this._findObjectId]?g[this._findObjectId].features:[];for(c=0;c<d.length;c++)a.pagesDefinition.internal.set[b+
c]=d[c].attributes[this._relatedLayer.objectIdField];for(c=0;c<d.length;c++)this._featureCache[d[c].attributes[this._relatedLayer.objectIdField]]=d[c];g=g[this._findObjectId]?!1===g[this._findObjectId].exceededTransferLimit:!0;d.length!==a.pagesDefinition.resultRecordCount&&g&&(a.pagesDefinition.internal.fullyResolved=!0);a.pagesDefinition.internal.lastRetrieved=b+d.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return d.length};f._getFeatures=async function(a,b,d,
c){const g=[];-1!==b&&void 0===this._featureCache[b]&&g.push(b);var e=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(a,e))return await this._expandPagedSet(a,e,0,0,c),this._getFeatures(a,b,d,c);c=0;for(e=a._lastFetchedIndex;e<a._known.length;e++){c++;c<=d&&(a._lastFetchedIndex+=1);if("GETPAGES"!==a._known[e]&&void 0===this._featureCache[a._known[e]]&&(a._known[e]!==b&&g.push(a._known[e]),g.length>d))break;if(c>=d&&0===g.length)break}if(0===g.length)return"success";throw new q.FeatureSetError(q.FeatureSetErrorCodes.MissingFeatures);
};f._refineSetBlock=async function(a,b,d){return a};f._stat=async function(a,b,d,c,g,e,h){return{calculated:!1}};f._canDoAggregates=async function(a,b,d,c,g){return!1};f.relationshipMetaData=function(){return this._relatedLayer.relationshipMetaData()};f.serviceUrl=function(){return this._relatedLayer.serviceUrl()};f.queryAttachments=function(a,b,d,c,g){return this._relatedLayer.queryAttachments(a,b,d,c,g)};f.getFeatureByObjectId=function(a,b){return this._relatedLayer.getFeatureByObjectId(a,b)};f.getOwningSystemUrl=
function(){return this._relatedLayer.getOwningSystemUrl()};f.getIdentityUser=function(){return this._relatedLayer.getIdentityUser()};f.getDataSourceFeatureSet=function(){return this._relatedLayer};p._createClass(n,[{key:"gdbVersion",get:function(){return this._relatedLayer.gdbVersion}},{key:"preferredTimeReference",get:function(){return this._relatedLayer?.preferredTimeReference??null}},{key:"dateFieldsTimeReference",get:function(){return this._relatedLayer?.dateFieldsTimeReference??null}},{key:"datesInUnknownTimezone",
get:function(){return this._relatedLayer?.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){return this._relatedLayer?.editFieldsInfo??null}},{key:"timeInfo",get:function(){return this._relatedLayer?.timeInfo??null}}]);return n}(w)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../ArcadeDate ../ArcadePortal ../Dictionary ../executionError ../Feature ../featureSetCollection ../featureSetUtils ../ImmutableArray ../../chunks/languageUtils ../portalUtils ../featureset/actions/Adapted ../featureset/actions/AttributeFilter ../featureset/actions/OrderBy ../featureset/actions/Top ../featureset/sources/Empty ../featureset/sources/FeatureLayerMemory ../featureset/support/OrderbyClause ../featureset/support/shared ../featureset/support/sqlUtils ./fieldStats ../../core/promiseUtils ../../core/sql/WhereClause ../../layers/FeatureLayer ../../layers/support/Field ../../portal/Portal".split(" "),
function(M,S,T,y,k,U,N,z,V,f,W,t,X,Y,Z,aa,ba,ca,G,O,H,da,v,I,C,P){async function J(h,b,e){const c=h.getVariables();if(0<c.length){const d=[];for(let a=0;a<c.length;a++)d.push(await b.evaluateIdentifier(e,{name:c[a]}));b={};for(e=0;e<c.length;e++)b[c[e]]=d[e];h.parameters=b}return h}function q(h,b,e=null){for(const c in h)if(c.toLowerCase()===b.toLowerCase())return h[c];return e}function Q(h){if(null===h)return null;const b={type:q(h,"type",""),name:q(h,"name","")};if("range"===b.type)b.range=q(h,
"range",[]);else{b.codedValues=[];for(const e of q(h,"codedValues",[]))b.codedValues.push({name:q(e,"name",""),code:q(e,"code",null)})}return b}function K(h){if(null===h)return null;const b={},e=q(h,"wkt",null);null!==e&&(b.wkt=e);h=q(h,"wkid",null);null!==h&&(b.wkid=h);return b}function R(h){if(null===h)return null;const b={hasZ:q(h,"hasz",!1),hasM:q(h,"hasm",!1)};var e=q(h,"spatialreference",null);e&&(b.spatialReference=K(e));e=q(h,"x",null);if(null!==e)return b.x=e,b.y=q(h,"y",null),b;e=q(h,"rings",
null);if(null!==e)return b.rings=e,b;e=q(h,"paths",null);if(null!==e)return b.paths=e,b;e=q(h,"points",null);if(null!==e)return b.points=e,b;for(const c of"xmin xmax ymin ymax zmin zmax mmin mmax".split(" "))e=q(h,c,null),null!==e&&(b[c]=e);return b}M.registerFunctions=function(h){"async"===h.mode&&(h.functions.timezone=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,1,2,b,e);if(f.isFeatureSet(a[0])){await a[0].load();if(1===a.length||null===a[1])return a[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone;
if(!(a[1]instanceof y)||!1===a[1].hasField("type"))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);c=a[1].field("type");if(!1===f.isString(c))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);switch(f.toString(c).toLowerCase()){case "preferredtimezone":return a[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone;case "editfieldsinfo":return a[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone;case "timeinfo":return a[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone;
case "field":if(a[1].hasField("fieldname")&&f.isString(a[1].field("fieldname")))return a[0].dateTimeReferenceFieldIndex.fieldTimeZone(f.toString(a[1].field("fieldname")))}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);}a=f.toDate(a[0],f.defaultTimeZone(b));if(null===a)return null;a=a.timeZone;return"system"===a?S.ArcadeDate.systemTimeZoneCanonicalName:a})},h.functions.sqltimestamp=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,1,3,b,e);c=
a[0];if(f.isDate(c)){if(1===a.length)return c.toSQLString();if(2===a.length)return c.changeTimeZone(f.toString(a[1])).toSQLString();throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);}if(f.isFeatureSet(c)){if(3!==a.length)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);await c.load();d=f.toString(a[1]);if(!1===f.isDate(a[2]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);c=c.fieldTimeZone(d);return null===c?a[2].toSQLString():
a[2].changeTimeZone(c).toSQLString()}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"sqltimestamp",min:2,max:4}),h.functions.featuresetbyid=function(b,e){return h.standardFunctionAsync(b,e,(c,d,a)=>{f.pcCheck(a,2,4,b,e);if(a[0]instanceof N){c=f.toString(a[1]);d=f.defaultUndefined(a[2],null);const m=f.toBoolean(f.defaultUndefined(a[3],!0));null===d&&(d=["*"]);if(!1===f.isArray(d))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,
e);return a[0].featureSetById(c,m,d)}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"featuresetbyid",min:2,max:4}),h.functions.getfeatureset=function(b,e){return h.standardFunctionAsync(b,e,(c,d,a)=>{f.pcCheck(a,1,2,b,e);if(f.isFeature(a[0]))return c=f.defaultUndefined(a[1],"datasource"),null===c&&(c="datasource"),c=f.toString(c).toLowerCase(),z.convertToFeatureSet(a[0].fullSchema(),c,b.lrucache,b.interceptor,b.spatialReference);throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"getfeatureset",min:1,max:2}),h.functions.featuresetbyportalitem=function(b,e){return h.standardFunctionAsync(b,e,(c,d,a)=>{f.pcCheck(a,2,5,b,e);if(null===a[0])throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.PortalRequired,e);if(a[0]instanceof T){c=f.toString(a[1]);d=f.toString(a[2]);var m=f.defaultUndefined(a[3],null);const n=f.toBoolean(f.defaultUndefined(a[4],!0));null===m&&(m=["*"]);if(!1===f.isArray(m))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);let g=null;g=b.services&&b.services.portal?b.services.portal:P.getDefault();g=W.getPortal(a[0],g);return z.constructFeatureSetFromPortalItem(c,d,b.spatialReference,m,n,g,b.lrucache,b.interceptor)}if(!1===f.isString(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.PortalRequired,e);c=f.toString(a[0]);d=f.toString(a[1]);m=f.defaultUndefined(a[2],null);a=f.toBoolean(f.defaultUndefined(a[3],!0));null===m&&(m=["*"]);if(!1===f.isArray(m))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);return z.constructFeatureSetFromPortalItem(c,d,b.spatialReference,m,a,b.services?.portal??P.getDefault(),b.lrucache,b.interceptor)})},h.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),h.functions.featuresetbyname=function(b,e){return h.standardFunctionAsync(b,e,(c,d,a)=>{f.pcCheck(a,2,4,b,e);if(a[0]instanceof N){c=f.toString(a[1]);d=f.defaultUndefined(a[2],null);const m=f.toBoolean(f.defaultUndefined(a[3],!0));null===d&&(d=["*"]);if(!1===f.isArray(d))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);return a[0].featureSetByName(c,m,d)}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"featuresetbyname",min:2,max:4}),h.functions.featureset=function(b,e){return h.standardFunction(b,e,(c,d,a)=>{f.pcCheck(a,1,1,b,e);d=a[0];c={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(f.isString(d))d=JSON.parse(d),
void 0!==d.layerDefinition?(c.layerDefinition=d.layerDefinition,c.featureSet=d.featureSet,d.layerDefinition.spatialReference&&(c.layerDefinition.spatialReference=d.layerDefinition.spatialReference)):(c.featureSet.features=d.features,c.featureSet.geometryType=d.geometryType,c.layerDefinition.geometryType=c.featureSet.geometryType,c.layerDefinition.objectIdField=d.objectIdFieldName??"",c.layerDefinition.typeIdField=d.typeIdFieldName,c.layerDefinition.globalIdField=d.globalIdFieldName,c.layerDefinition.fields=
d.fields,d.spatialReference&&(c.layerDefinition.spatialReference=d.spatialReference));else if(a[0]instanceof y)if(d=JSON.parse(a[0].castToText(!0)),a=q(d,"layerdefinition"),null!==a){c.layerDefinition.geometryType=q(a,"geometrytype","");c.featureSet.geometryType=c.layerDefinition.geometryType;c.layerDefinition.globalIdField=q(a,"globalidfield","");c.layerDefinition.objectIdField=q(a,"objectidfield","");c.layerDefinition.typeIdField=q(a,"typeidfield","");c.layerDefinition.hasZ=!0===q(a,"hasz",!1);
c.layerDefinition.hasM=!0===q(a,"hasm",!1);var m=q(a,"spatialreference",null);m&&(c.layerDefinition.spatialReference=K(m));for(const p of q(a,"fields",[]))m={name:q(p,"name",""),alias:q(p,"alias",""),type:q(p,"type",""),nullable:q(p,"nullable",!0),editable:q(p,"editable",!0),length:q(p,"length",null),domain:Q(q(p,"domain"))},c.layerDefinition.fields.push(m);var n=q(d,"featureset",null);if(n){m={};for(const p of c.layerDefinition.fields)m[p.name.toLowerCase()]=p.name;for(var g of q(n,"features",[])){n=
{};d=q(g,"attributes",{});for(var l in d)n[m[l.toLowerCase()]]=d[l];c.featureSet.features.push({attributes:n,geometry:R(q(g,"geometry",null))})}}}else{c.layerDefinition.hasZ=!0===q(d,"hasz",!1);c.layerDefinition.hasM=!0===q(d,"hasm",!1);c.layerDefinition.geometryType=q(d,"geometrytype","");c.featureSet.geometryType=c.layerDefinition.geometryType;c.layerDefinition.objectIdField=q(d,"objectidfieldname","");c.layerDefinition.typeIdField=q(d,"typeidfieldname","");if(g=q(d,"spatialreference",null))c.layerDefinition.spatialReference=
K(g);g=q(d,"fields",null);if(f.isArray(g))for(const p of g)g={name:q(p,"name",""),alias:q(p,"alias",""),type:q(p,"type",""),nullable:q(p,"nullable",!0),editable:q(p,"editable",!0),length:q(p,"length",null),domain:Q(q(p,"domain"))},c.layerDefinition.fields.push(g);else c.layerDefinition.fields=null;g={};for(const p of c.layerDefinition.fields)g[p.name.toLowerCase()]=p.name;l=q(d,"features",null);if(f.isArray(l))for(m of l){l={};d=q(m,"attributes",{});for(n in d)l[g[n.toLowerCase()]]=d[n];c.featureSet.features.push({attributes:l,
geometry:R(q(m,"geometry",null))})}else c.featureSet.features=null}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);if(c.layerDefinition&&c.featureSet){b:{m=["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"];for(r of m)if(r===c.layerDefinition.geometryType){var r=!0;break b}r=!1}r=!1===r||!1===f.isArray(c.layerDefinition.fields)||!1===f.isArray(c.featureSet.features)?!1:!0}else r=
!1;if(!1===r)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);""===(c?.layerDefinition?.geometryType||"")&&(c.layerDefinition.geometryType="esriGeometryNull");return ba.create(c,b.spatialReference)})},h.signatures.push({name:"featureset",min:1,max:1}),h.functions.filter=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,2,2,b,e);if(f.isArray(a[0])||f.isImmutableArray(a[0])){c=[];var m=a[0];m instanceof V&&(m=m.toArray());d=null;if(f.isFunctionParameter(a[1]))d=
a[1].createFunction(b);else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);for(var n of m)a=d(n),da.isPromiseLike(a)?!0===await a&&c.push(n):!0===a&&c.push(n);return c}if(f.isFeatureSet(a[0])){n=await a[0].load();n=v.WhereClause.create(a[1],n.getFieldsIndex());c=n.getVariables();if(0<c.length){d=[];for(m=0;m<c.length;m++)d.push(await h.evaluateIdentifier(b,{name:c[m]}));m={};for(let g=0;g<c.length;g++)m[c[g]]=d[g];n.parameters=m}return new X({parentfeatureset:a[0],whereclause:n})}throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"filter",min:2,max:2}),h.functions.orderby=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,2,2,b,e);if(f.isFeatureSet(a[0]))return c=new ca(a[1]),new Y({parentfeatureset:a[0],orderbyclause:c});throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"orderby",min:2,max:2}),h.functions.top=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,
2,2,b,e);if(f.isFeatureSet(a[0]))return new Z({parentfeatureset:a[0],topnum:a[1]});if(f.isArray(a[0]))return f.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,f.toNumber(a[1]));if(f.isImmutableArray(a[0]))return f.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,f.toNumber(a[1]));throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"top",min:2,max:2}),h.functions.first=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>
{f.pcCheck(a,1,1,b,e);return f.isFeatureSet(a[0])?(c=await a[0].first(c.abortSignal),null!==c?(a=U.createFromGraphicLikeObject(c.geometry,c.attributes,a[0],b.timeReference),a._underlyingGraphic=c,a):c):f.isArray(a[0])?0===a[0].length?null:a[0][0]:f.isImmutableArray(a[0])?0===a[0].length()?null:a[0].get(0):null})},h.signatures.push({name:"first",min:1,max:1}),h.functions.attachments=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,1,2,b,e);d=c=-1;var m=null,n=!1;if(1<a.length)if(a[1]instanceof
y){if(a[1].hasField("minsize")&&(c=f.toNumber(a[1].field("minsize"))),a[1].hasField("metadata")&&(n=f.toBoolean(a[1].field("metadata"))),a[1].hasField("maxsize")&&(d=f.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){var g=f.toStringArray(a[1].field("types"),!1);0<g.length&&(m=g)}}else if(null!==a[1])throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);if(f.isFeature(a[0])){g=a[0]._layer;g instanceof I&&(g=z.constructFeatureSet(g,b.spatialReference,["*"],!0,b.lrucache,
b.interceptor));if(null===g||!1===f.isFeatureSet(g))return[];await g.load();return g.queryAttachments(a[0].field(g.objectIdField),c,d,m,n)}if(null===a[0])return[];throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);})},h.signatures.push({name:"attachments",min:1,max:2}),h.functions.featuresetbyrelationshipname=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,2,4,b,e);c=a[0];const m=f.toString(a[1]);d=f.defaultUndefined(a[2],null);var n=f.toBoolean(f.defaultUndefined(a[3],
!0));null===d&&(d=["*"]);if(!1===f.isArray(d))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);if(null===a[0])return null;if(!f.isFeature(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);a=c._layer;a instanceof I&&(a=z.constructFeatureSet(a,b.spatialReference,["*"],!0,b.lrucache,b.interceptor));if(null===a||!1===f.isFeatureSet(a))return null;a=await a.load();const g=a.relationshipMetaData().filter(r=>r.name===m);if(0===g.length)return null;
if(void 0!==g[0].relationshipTableId&&null!==g[0].relationshipTableId&&-1<g[0].relationshipTableId)return z.constructFeatureSetFromRelationship(a,g[0],c.field(a.objectIdField),a.spatialReference,d,n,b.lrucache,b.interceptor);let l=a.serviceUrl();if(!l)return null;l="/"===l.charAt(l.length-1)?l+g[0].relatedTableId.toString():l+"/"+g[0].relatedTableId.toString();d=await z.constructFeatureSetFromUrl(l,a.spatialReference,d,n,b.lrucache,b.interceptor);await d.load();n=d.relationshipMetaData();n=n.filter(r=>
r.id===g[0].id);if(!1===c.hasField(g[0].keyField)||null===c.field(g[0].keyField))return(c=await a.getFeatureByObjectId(c.field(a.objectIdField),[g[0].keyField]))?(a=v.WhereClause.create(n[0].keyField+"\x3d @id",d.getFieldsIndex()),a.parameters={id:c.attributes[g[0].keyField]},d.filter(a)):new aa({parentfeatureset:d});a=v.WhereClause.create(n[0].keyField+"\x3d @id",d.getFieldsIndex());a.parameters={id:c.field(g[0].keyField)};return d.filter(a)})},h.signatures.push({name:"featuresetbyrelationshipname",
min:2,max:4}),h.functions.featuresetbyassociation=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,2,3,b,e);var m=a[0],n=f.toString(f.defaultUndefined(a[1],"")).toLowerCase(),g=f.isString(a[2])?f.toString(a[2]):null;if(null===a[0])return null;if(!f.isFeature(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);var l=m._layer;l instanceof I&&(l=z.constructFeatureSet(l,b.spatialReference,["*"],!0,b.lrucache,b.interceptor));if(null===l||!1===f.isFeatureSet(l))return null;
await l.load();a=l.serviceUrl();a=await z.constructAssociationMetaDataFeatureSetFromUrl(a,b.spatialReference);let r=d=null;c=!1;if(null!==g&&""!==g&&void 0!==g){for(var p of a.terminals)p.terminalName===g&&(r=p.terminalId);null===r&&(c=!0)}var u=a.associations.getFieldsIndex();p=u.get("TOGLOBALID").name;g=u.get("FROMGLOBALID").name;const w=u.get("TOTERMINALID").name,L=u.get("FROMTERMINALID").name,D=u.get("FROMNETWORKSOURCEID").name,E=u.get("TONETWORKSOURCEID").name,B=u.get("ASSOCIATIONTYPE").name,
ea=u.get("ISCONTENTVISIBLE").name,fa=u.get("OBJECTID").name;for(var F of l.fields)if("global-id"===F.type){d=m.field(F.name);break}let A=null;F=new t.SqlExpressionAdapted(new C({name:"percentalong",alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex()));m=new t.SqlExpressionAdapted(new C({name:"side",alias:"side",type:"string"}),v.WhereClause.create("''",a.associations.getFieldsIndex()));l={};for(var x in a.lkp)l[x]=a.lkp[x].sourceId;x=new t.StringToCodeAdapted(new C({name:"classname",
alias:"classname",type:"string"}),null,l);l="";switch(n){case "midspan":l=`((${p}='${d}') OR ( ${g}='${d}')) AND (${B} IN (5))`;x.codefield=v.WhereClause.create(`CASE WHEN (${p}='${d}') THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());n=G.cloneField(t.AdaptedFeatureSet.findField(a.associations.fields,g));n.name="globalid";n.alias="globalid";A=new t.SqlExpressionAdapted(n,v.WhereClause.create(`CASE WHEN (${g}='${d}') THEN ${p} ELSE ${g} END`,a.associations.getFieldsIndex()));F=4<=a.unVersion?
new t.OriginalField(t.AdaptedFeatureSet.findField(a.associations.fields,u.get("PERCENTALONG").name)):new t.SqlExpressionAdapted(new C({name:"percentalong",alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex()));break;case "junctionedge":l=`((${p}='${d}') OR ( ${g}='${d}')) AND (${B} IN (4,6))`;x.codefield=v.WhereClause.create(`CASE WHEN (${p}='${d}') THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());n=G.cloneField(t.AdaptedFeatureSet.findField(a.associations.fields,
g));n.name="globalid";n.alias="globalid";A=new t.SqlExpressionAdapted(n,v.WhereClause.create(`CASE WHEN (${g}='${d}') THEN ${p} ELSE ${g} END`,a.associations.getFieldsIndex()));m=new t.SqlExpressionAdapted(new C({name:"side",alias:"side",type:"string"}),v.WhereClause.create(`CASE WHEN (${B}=4) THEN 'from' ELSE 'to' END`,a.associations.getFieldsIndex()));break;case "connected":n=`${p}='@T'`;u=`${g}='@T'`;null!==r&&(n+=` AND ${w}=@A`,u+=` AND ${L}=@A`);l="(("+n+") OR ("+u+"))";l=f.multiReplace(l,"@T",
d??"");n=f.multiReplace(n,"@T",d??"");null!==r&&(n=f.multiReplace(n,"@A",r.toString()),l=f.multiReplace(l,"@A",r.toString()));x.codefield=v.WhereClause.create("CASE WHEN "+n+` THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());d=G.cloneField(t.AdaptedFeatureSet.findField(a.associations.fields,g));d.name="globalid";d.alias="globalid";A=new t.SqlExpressionAdapted(d,v.WhereClause.create("CASE WHEN "+n+` THEN ${g} ELSE ${p} END`,a.associations.getFieldsIndex()));break;case "container":l=`${p}='${d}' AND ${B} = 2`;
null!==r&&(l+=` AND ${w} = `+r.toString());x.codefield=D;l="( "+l+" )";A=new t.FieldRename(t.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid","globalid");break;case "content":l=`(${g}='${d}' AND ${B} = 2)`;null!==r&&(l+=` AND ${L} = `+r.toString());x.codefield=E;l="( "+l+" )";A=new t.FieldRename(t.AdaptedFeatureSet.findField(a.associations.fields,p),"globalid","globalid");break;case "structure":l=`(${p}='${d}' AND ${B} = 3)`;null!==r&&(l+=` AND ${w} = `+r.toString());x.codefield=D;
l="( "+l+" )";A=new t.FieldRename(t.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid","globalId");break;case "attached":l=`(${g}='${d}' AND ${B} = 3)`;null!==r&&(l+=` AND ${L} = `+r.toString());x.codefield=E;l="( "+l+" )";A=new t.FieldRename(t.AdaptedFeatureSet.findField(a.associations.fields,p),"globalid","globalId");break;default:throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);}c&&(l="1 \x3c\x3e 1");return new t.AdaptedFeatureSet({parentfeatureset:a.associations,
adaptedFields:[new t.OriginalField(t.AdaptedFeatureSet.findField(a.associations.fields,fa)),new t.OriginalField(t.AdaptedFeatureSet.findField(a.associations.fields,ea)),A,m,x,F],extraFilter:l?v.WhereClause.create(l,a.associations.getFieldsIndex()):null})})},h.signatures.push({name:"featuresetbyassociation",min:2,max:6}),h.functions.groupby=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{f.pcCheck(a,3,3,b,e);if(!f.isFeatureSet(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,
e);const m=await a[0].load();c=[];d=[];let n=!1;var g=[];if(f.isString(a[1]))g.push(a[1]);else if(a[1]instanceof y)g.push(a[1]);else if(f.isArray(a[1]))g=a[1];else if(f.isImmutableArray(a[1]))g=a[1].toArray();else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);for(var l of g)if(f.isString(l)){g=v.WhereClause.create(f.toString(l),m.getFieldsIndex());var r=!0===O.isSingleField(g)?f.toString(l):"%%%%FIELDNAME";c.push({name:r,expression:g});"%%%%FIELDNAME"===r&&(n=!0)}else if(l instanceof
y){g=l.hasField("name")?l.field("name"):"%%%%FIELDNAME";r=l.hasField("expression")?l.field("expression"):"";"%%%%FIELDNAME"===g&&(n=!0);if(!g)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);c.push({name:g,expression:v.WhereClause.create(r||g,m.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);g=[];if(f.isString(a[2]))g.push(a[2]);else if(f.isArray(a[2]))g=a[2];else if(f.isImmutableArray(a[2]))g=a[2].toArray();else if(a[2]instanceof
y)g.push(a[2]);else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);for(var p of g)if(p instanceof y){l=p.hasField("name")?p.field("name"):"";g=p.hasField("statistic")?p.field("statistic"):"";r=p.hasField("expression")?p.field("expression"):"";if(!l||!g||!r)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);d.push({name:l,statistic:g.toLowerCase(),expression:v.WhereClause.create(r,m.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,e);if(n){p={};for(var u of m.fields)p[u.name.toLowerCase()]=1;for(const w of c)"%%%%FIELDNAME"!==w.name&&(p[w.name.toLowerCase()]=1);for(const w of d)"%%%%FIELDNAME"!==w.name&&(p[w.name.toLowerCase()]=1);u=0;for(const w of c)if("%%%%FIELDNAME"===w.name){for(;1===p["field_"+u.toString()];)u++;p["field_"+u.toString()]=1;w.name="FIELD_"+u.toString()}}for(const w of c)await J(w.expression,h,b);for(const w of d)await J(w.expression,h,b);return a[0].groupby(c,d)})},
h.signatures.push({name:"groupby",min:3,max:3}),h.functions.distinct=function(b,e){return h.standardFunctionAsync(b,e,async(c,d,a)=>{if(f.isFeatureSet(a[0])){f.pcCheck(a,2,2,b,e);d=await a[0].load();c=[];var m=[];if(f.isString(a[1]))m.push(a[1]);else if(a[1]instanceof y)m.push(a[1]);else if(f.isArray(a[1]))m=a[1];else if(f.isImmutableArray(a[1]))m=a[1].toArray();else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);let r=!1;for(var n of m)if(f.isString(n)){m=v.WhereClause.create(f.toString(n),
d.getFieldsIndex());var g=!0===O.isSingleField(m)?f.toString(n):"%%%%FIELDNAME";c.push({name:g,expression:m});"%%%%FIELDNAME"===g&&(r=!0)}else if(n instanceof y){m=n.hasField("name")?n.field("name"):"%%%%FIELDNAME";g=n.hasField("expression")?n.field("expression"):"";"%%%%FIELDNAME"===m&&(r=!0);if(!m)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,e);c.push({name:m,expression:v.WhereClause.create(g||m,d.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,
e);if(r){n={};for(var l of d.fields)n[l.name.toLowerCase()]=1;for(const p of c)"%%%%FIELDNAME"!==p.name&&(n[p.name.toLowerCase()]=1);l=0;for(const p of c)if("%%%%FIELDNAME"===p.name){for(;1===n["field_"+l.toString()];)l++;n["field_"+l.toString()]=1;p.name="FIELD_"+l.toString()}}for(const p of c)await J(p.expression,h,b);return a[0].groupby(c,[])}a:{if(1===a.length){if(f.isArray(a[0])){a=H.calculateStat("distinct",a[0],-1);break a}if(f.isImmutableArray(a[0])){a=H.calculateStat("distinct",a[0].toArray(),
-1);break a}}a=H.calculateStat("distinct",a,-1)}return a})})};Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})});
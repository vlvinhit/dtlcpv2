// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/has ../../../core/Cyclical ../../../core/Error ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/scaleUtils ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Geometry".split(" "),
function(v,U,ua,ea,J,V,va,W,C,fa,X,ha,ia,m,D,t,p,Y,ja,ka,x,y,h,Z,E,K,la,ma){function L(a){return 360-W.cyclicalDegrees.normalize(a)}function z(a){return W.cyclicalDegrees.normalize(360-a)}function A(a){null!=a&&a.resolver&&a.resolver.reject();return null}function aa(a,b,c,d=null){if(!b)return A(d);var e=a.spatialReference||K.WGS84;if(null!=b.camera){a=x.project(b.camera.position,e);if(null==a)return A(d);b=b.camera.clone();b.position=a.clone();a=b;null!=d&&d.resolver&&d.resolver.resolve(a);return a}if(null==
b.targetGeometry)return A(d);var f=b.get("targetGeometry.spatialReference");if(f&&!x.canProject(f,e))return A(d);e=h.internalToExternal(a,a.state.camera);f=h.OrientationMode.ADJUST;null!=b.rotation&&(e.heading=L(b.rotation),f=h.OrientationMode.LOCKED);null!=c&&(e.tilt=c);if("point"===b.targetGeometry.type){const g=b.targetGeometry;c=b.targetGeometry.clone();b=null!=b.scale?h.scaleToDistance(a,b.scale,g.latitude):a.state.camera.distance;return h.fromCenterDistance(a,c,b,e,f,d)}return(b=b.targetGeometry.extent)?
h.fromExtent(a,b,e.heading,e.tilt,f,d):A(d)}function M(a,b){return null==b.scale&&null!=b.zoom?h.zoomToScale(a,b.zoom):b.scale}function N(a,b){let c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=L(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function O(a,b,c,d){const e=a.spatialReference||K.WGS84;b=null!=b?b:h.externalToInternal(a,c);if(null==b)return d;d.targetGeometry=t.projectVectorToPoint(b.center,a.renderSpatialReference,
e);d.scale=h.computeScale(a,b);d.rotation=z(c.heading);d.camera=c;return d}function F(a,b,c){var d=()=>new C("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!b)throw d();if(!x.canProject(b.spatialReference,a.spatialReference))throw new C("viewpointutils:incompatible-spatialreference",`Spatial reference (${b.spatialReference?b.spatialReference.wkid:"unknown"}) is incompatible with the view (${a.spatialReference?.wkid})`,{geometry:b});const e=[];if(!b.hasZ&&a.basemapTerrain){switch(b.type){case "point":var f=
b;break;case "multipoint":case "polyline":f=b.extent?.center;break;case "mesh":f=b.origin;break;case "extent":f=b.center;break;case "polygon":f=b.centroid}f&&null!=a.basemapTerrain.spatialReference&&x.canProject(f,a.basemapTerrain.spatialReference)&&a.elevationProvider?l[2]=Z.getElevationAtPoint(a.elevationProvider,f)??0:l[2]=0}(0,na[b.type])(b,g=>{e.push(g[0],g[1],g[2])},l);f=e.length/3;if(0===f)throw d();d=Array(e.length);if(t.projectBuffer(e,b.spatialReference,0,d,a.spatialReference,0,f))for(b.hasZ&&
(c.hasZ=!0),a=0;a<d.length;a+=3)b.hasZ?(l[0]=d[a],l[1]=d[a+1],l[2]=d[a+2]):(l[0]=d[a],l[1]=d[a+1]),p.expandWithVec3(c.boundingBox,l)}async function oa(a,b,c,d){const e=await V.result(a.whenViewForGraphic(b));if(!1!==e.ok&&null!=e.value&&"whenGraphicBounds"in e.value)if(c=await V.result(e.value.whenGraphicBounds(b,{minDemResolution:c})),!1===c.ok)F(a,b.geometry,d);else{var {screenSpaceObjects:f,boundingBox:g}=c.value;p.expandWithAABB(d.boundingBox,g);f&&f.forEach(k=>{d.screenSpaceObjects.push(k)});
isFinite(g[2])&&(d.hasZ=!0)}else F(a,b.geometry,d)}async function ba(a,b,c,d){if(Array.isArray(b)&&2===b.length){const e=b[0],f=b[1];if("number"===typeof e&&"number"===typeof f){n.x=e;n.y=f;n.z=void 0;n.spatialReference=a.spatialReference?.isGeographic?a.spatialReference:K.WGS84;F(a,n,d);return}}b&&"map"in b&&"function"===typeof b.map?await fa.eachAlways(b.map(e=>ba(a,e,c,d))):b instanceof ma?F(a,b,d):b instanceof ea&&await oa(a,b,c,d)}async function pa(a,b,c,d,e){if(null!=b.camera)return ca(a,b.camera,
e);e.scale=b.scale;e.rotation=b.rotation;e.targetGeometry=null!=b.targetGeometry?b.targetGeometry.clone():null;e.camera=null;null!=c.heading?e.rotation=z(c.heading):null!=c.rotation&&(e.rotation=c.rotation);b=M(a,c);null!=b&&(e.scale=b);d=new h.AsyncContext(d);aa(a,e,c.tilt,d);e.camera=await d.resolver.promise;return e}function ca(a,b,c){const d=x.project(b.position,a.spatialReference);if(null==d)return null;b=b.clone();b.fov=a.camera.fov;b.position=d;return O(a,null,b,c)}async function P(a,b,c,d,
e,f){if(null==c)throw new C("createfromcenter","invalid point");f.targetGeometry=c.clone();var g=y.cameraOnContentAlongViewDirection(a);if(b.position)return c=f.targetGeometry,b=b.position,e=a.renderSpatialReference,t.projectPointToVector(b,G,e),t.projectPointToVector(c,Q,e),f.targetGeometry=new E(c),d.position=new E(b),m.subtract(H,Q,G),h.directionToHeadingTilt(a,G,H,g.up,d),f.scale=h.distanceToScale(a,m.distance(G,Q),f.targetGeometry.latitude),f.rotation=z(d.heading),f.camera=d,f;if(b.zoomFactor){var k=
g.distance/b.zoomFactor;const r=m.scale(l,g.viewForward,-k);g.eye=m.add(l,g.center,r);f.scale=h.distanceToScale(a,k,c.latitude)}h.internalToExternal(a,g,d);k=N(d,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;b.zoomFactor||(b=M(a,b),null==b?(t.projectPointToVector(c,l,a.renderSpatialReference),ja.intersectsPoint(g.frustum,l)?f.scale=h.distanceToScale(a,m.distance(g.eye,l),c.latitude):f.scale=h.computeScale(a,g)):f.scale=b,g=new h.AsyncContext(e),h.fromCenterScale(a,f.targetGeometry,f.scale,
d,k,g),f.camera=await g.resolver.promise);return f}async function qa(a,b,c,d,e){var f=y.cameraOnContentAlongViewDirection(a);f=t.projectVectorToPoint(f.center,a.renderSpatialReference,a.spatialReference);return P(a,b,f,c,d,e)}async function ra(a,b,c,d,e,f){f.targetGeometry=c.clone();const g=y.cameraOnContentAlongViewDirection(a);h.internalToExternal(a,g,d);b=N(d,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;e=new h.AsyncContext(e);h.fromExtent(a,c,d.heading,d.tilt,b,e);f.camera=await e.resolver.promise;
return f}async function sa(a,b,c,d,e,f,g,k){k.targetGeometry=c.clone();const r=y.cameraOnContentAlongViewDirection(a);var q=0;null!=c.z?q=c.z:a.basemapTerrain&&a.elevationProvider&&(q=Z.getElevationAtPoint(a.elevationProvider,c));m.set(l,c.x,c.y,q);t.computeTranslationToOriginAndRotation(a.spatialReference,l,da,a.renderSpatialReference);X.fromMat4(I,da);X.transpose(I,I);p.empty(B);c=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(var w=0;w<c.length;w++){const R=c[w];let S=d[R[2]];
isFinite(S)||(S=q);m.set(l,d[R[0]],d[R[1]],S);t.projectVectorToVector(l,a.spatialReference,l,a.renderSpatialReference);p.expandWithVec3(B,m.transformMat3(l,l,I))}d=p.width(B);q=p.height(B);c=p.depth(B);w=1/Math.tan(r.fovY/2);e=Math.max(.5*Math.sqrt(d*d+c*c)*Math.max(w,1/Math.tan(r.fovX/2))+.5*q,.5*q*w+.5*Math.max(d,c))/e;h.internalToExternal(a,r,f);b=N(f,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;k.scale=h.distanceToScale(a,e,k.targetGeometry.latitude);g=new h.AsyncContext(g);h.fromCenterScale(a,
k.targetGeometry,k.scale,f,b,g);k.camera=await g.resolver.promise;return k}function u(a){a&&null!=a.camera&&(a.rotation=z(a.camera.heading));return a}const l=D.create(),da=ia.create(),I=ha.create(),B=p.create(),ta=Y.create(),H=D.create(),G=D.create(),Q=D.create(),T={heading:0,tilt:0},n=new E,na={point(a,b,c){c[0]=a.x;c[1]=a.y;null!=a.z&&(c[2]=a.z);b(c)},polygon(a,b,c){const d=a.hasZ;for(let e=0;e<a.rings.length;e++){const f=a.rings[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=
f[g][2]),b(c)}},polyline(a,b,c){const d=a.hasZ;for(let e=0;e<a.paths.length;e++){const f=a.paths[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=f[g][2]),b(c)}},multipoint(a,b,c){const d=a.points;a=a.hasZ;for(let e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],a&&(c[2]=d[e][2]),b(c)},extent(a,b,c){null!=a.zmin&&null!=a.zmax?(b(m.set(c,a.xmin,a.ymin,a.zmin)),b(m.set(c,a.xmax,a.ymin,a.zmin)),b(m.set(c,a.xmin,a.ymax,a.zmin)),b(m.set(c,a.xmax,a.ymax,a.zmin)),b(m.set(c,a.xmin,a.ymin,a.zmax)),
b(m.set(c,a.xmax,a.ymin,a.zmax)),b(m.set(c,a.xmin,a.ymax,a.zmax)),b(m.set(c,a.xmax,a.ymax,a.zmax))):(b(m.set(c,a.xmin,a.ymin,c[2])),b(m.set(c,a.xmax,a.ymin,c[2])),b(m.set(c,a.xmin,a.ymax,c[2])),b(m.set(c,a.xmax,a.ymax,c[2])))},mesh(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(let d=0;d<a.length;d+=3)b(m.set(c,a[d],a[d+1],a[d+2]))}};v.create=async function(a,b,c){if(b&&a.spatialReference){var d={target:void 0};"declaredClass"in b||Array.isArray(b)?d.target=b:(Object.assign(d,b),
b.center&&!d.target&&(d.target=b.center));b=d}else b=null;if(!b)throw new C("viewpointutils-create:no-target","Missing target for creating viewpoint");d=new U({fov:a.camera.fov});const e=new J({camera:d});if(b.target instanceof J)return a=await pa(a,b.target,b,c,e),u(a);if(b.target instanceof U)return u(ca(a,b.target,e));var f=null!=b.scale||null!=b.zoom;if(b.target instanceof la){var g=b.target.xmin===b.target.xmax||b.target.ymin===b.target.ymax;return f||g?u(await P(a,b,b.target.center,d,c,e)):
u(await ra(a,b,b.target,d,c,e))}g={boundingBox:p.empty(),hasZ:!1,screenSpaceObjects:[]};var k=f?(k=M(a,b))?ka.getResolutionInMetersForScale(k):void 0:void 0;await ba(a,b.target,k,g);if(isFinite(g.boundingBox[0])){p.center(g.boundingBox,l);n.x=l[0];n.y=l[1];n.z=l[2];n.spatialReference=a.spatialReference;isFinite(n.z)&&g.hasZ?k=p.isPoint(g.boundingBox):(n.z=void 0,k=Y.isPoint(p.toRect(g.boundingBox,ta)));if(f||k)return u(await P(a,b,n,d,c,e));f=g.screenSpaceObjects;if(f.length){k=Number.NEGATIVE_INFINITY;
for(let r=0;r<f.length;r++){const q=f[r].screenSpaceBoundingRect;k=Math.max(k,Math.abs(q[0]),Math.abs(q[1]),Math.abs(q[2]),Math.abs(q[3]))}f=.66-k/Math.min(a.width,a.height)*2}else f=.66;return u(await sa(a,b,n,g.boundingBox,f,d,c,e))}return b.position?(c=y.cameraOnContentAlongViewDirection(a),m.copy(H,c.viewForward),h.directionToHeadingTilt(a,c.eye,H,c.up,T),d.position=new E(b.position),d.heading=null!=b.heading?b.heading:T.heading,d.tilt=null!=b.tilt?b.tilt:T.tilt,a=O(a,null,d,e),u(a)):u(await qa(a,
b,d,c,e))};v.fromCamera=function(a,b,c=null){null==c&&(c=new J);return O(a,null,b.clone(),c)};v.headingToRotation=z;v.rotationToHeading=L;v.toCamera=aa;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
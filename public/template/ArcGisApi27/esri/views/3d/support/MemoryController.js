// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Logger ../../../core/MemCache ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./MemoryManagedView".split(" "),function(p,q,c,t,u,r,d,x,y,z,v,w){let b=function(k){function l(a){a=k.call(this,a)||this;a._quality=1;a._usedMemory=0;a._updating=!1;a.minQuality=
.1;a._stableQuality=0;a._downscaleMemoryUsed=0;a._canFastRecover=!1;a._memoryPredicted=0;a._cacheStorage=new r.MemCacheStorage;a._warnMemoryUsage=null;a._numQualityChanges=0;a._maxMemory=750;a._additionalCacheMemory=0;return a}q._inherits(l,k);var f=l.prototype;f.destroy=function(){this._cacheStorage.destroy()};f.newCache=function(a,e){return new r.MemCache(a,this._cacheStorage,e)};f.resetStableQuality=function(){this._stableQuality=0};f.disableMemCache=function(){this.additionalCacheMemory=-4096};
f.update=function(){this._updateMemory();if(!(0>=this._memoryPredicted)||this._updating){var a=this._layersUpdating();if(.6>this._memoryPredicted&&this._canFastRecover)this._stableQuality=this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._updateQuality(1);else if(a){if(1.1<this._memoryPredicted||1<this._usedMemory)0<this._stableQuality?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/
1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)}else this._downscaleMemoryUsed=0,1<this._usedMemory?(this._stableQuality=0,this._canFastRecover=!1,a=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(.75>this._usedMemory&&1>this._quality?(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.05)):1>this._quality&&(this._canFastRecover=!0));this._updating=a}};f._updateQuality=function(a){a=
Math.min(Math.max(a,this.minQuality),1);if(a===this._quality)return!1;this._quality=a;++this._numQualityChanges;return!0};f._layersUpdating=function(){return this.view.allLayerViews.some(a=>!!a.updating)};f._updateMemory=function(){if(this.view){var a=0;this.view.basemapTerrain&&(a+=this.view.basemapTerrain.usedMemory);var e=this.view?._stage&&this.view._stage.renderView&&this.view._stage.renderer?.edgeView;null!=e&&(a+=e.usedMemory);var n=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(g=>
{if(w.isMemoryManagedView(g)){const m=g.ignoresMemoryFactor?this._quality:1;a+=g.usedMemory*m;n+=g.unloadedMemory*m}});var h=null==this._warnMemoryUsage||Math.round(10*a)!==Math.round(10*this._warnMemoryUsage);e=1048576*this.maxMemory;if(a>e&&h){this._warnMemoryUsage=a;h=m=>(m/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB";const g=Math.round(100*this._quality);u.getLogger(this).warn(`Memory Limit exceeded! Limit: ${h(e)} Current: ${h(a)} Projected: ${h(a+n)} Quality: ${g}%`)}this._usedMemory=
a/e;this._memoryPredicted=(a+n)/e;this._cacheStorage.maxSize=Math.max(0,e-a+1048576*this.additionalCacheMemory)}};q._createClass(l,[{key:"maxMemory",get:function(){return this._maxMemory},set:function(a){null==a||0>=a||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<a&&this._updateQuality(1),this._maxMemory=a)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(a){null!=a&&(this._additionalCacheMemory=a)}},{key:"memoryFactor",get:function(){return this._quality}},
{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"test",get:function(){const a=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=a._numQualityChanges;a._numQualityChanges=0;return e}}}}]);return l}(t);c.__decorate([d.property({constructOnly:!0})],b.prototype,"view",void 0);c.__decorate([d.property()],b.prototype,"maxMemory",null);c.__decorate([d.property()],b.prototype,"additionalCacheMemory",null);c.__decorate([d.property()],
b.prototype,"memoryFactor",null);c.__decorate([d.property()],b.prototype,"updating",null);c.__decorate([d.property()],b.prototype,"usedMemory",null);c.__decorate([d.property()],b.prototype,"_quality",void 0);c.__decorate([d.property()],b.prototype,"_usedMemory",void 0);c.__decorate([d.property()],b.prototype,"_updating",void 0);c.__decorate([d.property()],b.prototype,"_stableQuality",void 0);c.__decorate([d.property()],b.prototype,"_maxMemory",void 0);c.__decorate([d.property()],b.prototype,"_additionalCacheMemory",
void 0);b=c.__decorate([v.subclass("esri.views.3d.support.MemoryController")],b);p.newMemoryController=function(k){return new b({view:k})};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
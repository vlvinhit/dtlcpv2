// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(b,u,d,D,E,e,f,U,V,W,F,q,x,y,G,n,H,I,J,v,K,L,M,N,z,O,P,r){b.PointsOfInterest=function(A){function t(a){a=A.call(this,a)||this;a._handles=new E;a._tmpRay=y.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new H.PropertiesPool({renderPointOfView:Q},u._assertThisInitialized(a));a.renderPointOfView=x.create();a._pois=[];a._debugCenters=new Map;return a}u._inherits(t,A);
var k=t.prototype;k.initialize=function(){const {state:a,basemapTerrain:c,renderCoordsHelper:g,map:w}=this.view;this._surfaceIntersector=z.newIntersector(a.viewingMode);this._surfaceIntersector.options.backfacesTerrain=a.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=O.StoreResults.MIN;this._contentIntersector=z.newIntersector(a.viewingMode);var h=()=>this._estimateSurfaceAltitudeAtCenter();const B=this.view.resourceController.scheduler,
C=this.view.basemapTerrain?.elevationQueryCache,p={state:a,scheduler:B,surface:c,renderCoordsHelper:g};this._set("centerOnSurfaceInfrequent",new v.CenterOnSurface({...p,task:r.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnSurfaceFrequent",new v.CenterOnSurface({...p,task:r.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnContent",new v.CenterOnSurface({...p,task:r.TaskPriority.POINT_OF_INTEREST_FREQUENT,
estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",new J.CameraOnSurface({...p,cache:C,task:r.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:w}));this._set("surfaceGeometryUpdates",new N.SurfaceGeometryUpdates({...p,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new K.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:g}));
this._set("surfaceOrigin",new M.StableSurfaceCenter({cache:C,view:this.view}));this._set("focus",new L.Focus({state:a,scheduler:B,surface:c,renderCoordsHelper:g,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(l,R)=>this._estimateSurfaceIntersectionAtRenderPoint(l,this.view.state.contentCamera,R)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);h=this.view.graphics;this._debugCenters.set(this.centerOnContent,
new n.PointGraphics(h,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new n.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new n.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new n.PointGraphics(h,"blue","CameraOnSurface"));this._debugCenters.set(this.focus,new n.PointGraphics(h,"green","Focus"));this._handles.add([e.watch(()=>a.contentCamera,l=>this._cameraChanged(l),e.sync),e.watch(()=>
c.extent,()=>this._updateCenterPointsOfInterest()),e.when(()=>!c.updating,()=>this._updateCenterPointsOfInterest(),e.sync),e.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),e.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),e.when(()=>G.SHOW_POI,l=>this._setDebug(l),e.initial)]);this._cameraChanged(this.view.state.contentCamera);for(const l of this._pois)l.runTask()};k.destroy=function(){this._setDebug(!1);
this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};k._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this._centerRay;if(null==a)return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,m,S)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m):
this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};k._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this._centerRay;if(null==a)return this._surfaceAltitudeAtCenter;const c=a.origin,g=q.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,this.view.state.contentCamera);this.view.basemapTerrain.intersect(this._surfaceIntersector,
null,c,g);this._surfaceIntersector.results.min.getIntersectionPoint(m)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m));return this._surfaceAltitudeAtCenter};k._estimateSurfaceIntersectionAtRenderPoint=function(a,c,g){a=I.fromRenderAtEye(c,a,T);if(null==a)return null;const w=a.origin,h=q.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,c);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,w,h);return this._surfaceIntersector.results.min.getIntersectionPoint(g)?
g:null};k._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;q.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",q.copy(this._propertiesPool.get("renderPointOfView"),a))};k._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};k._updateCenterOnContent=function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};
k._setDebug=function(a){if(a)for(const c of this._pois)this._handles.add(e.watch(()=>c.renderLocation,g=>this._debugCenters.get(c)?.show(g,c.renderCoordsHelper.spatialReference),e.initial),"debug");else this._debugCenters.forEach(c=>c.hide()),this._handles.remove("debug")};u._createClass(t,[{key:"updating",get:function(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(a=>a.updating))}},{key:"_centerRay",get:function(){this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,
this._tmpRay),this._centerRayDirty=!1);return this._centerRayCached}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return t}(D);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnContent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([f.property({readOnly:!0})],
b.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"focus",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceOrigin",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,
"contentGeometryUpdates",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0);d.__decorate([f.property({constructOnly:!0})],b.PointsOfInterest.prototype,"view",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"updating",null);b.PointsOfInterest=d.__decorate([F.subclass("esri.views.3d.support.PointsOfInterest")],b.PointsOfInterest);const Q=Array,m=x.create(),T=y.create(),S={exclude:new Set([P.TERRAIN_ID])};Object.defineProperty(b,
Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Camera ../../../core/Cyclical ../../../core/Logger ../../../core/mathUtils ../../../core/promiseUtils ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/Point ../../../geometry/projection ../../../geometry/SpatialReference ../../ViewingMode ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical ./earthUtils ./ElevationProvider ../../support/spatialReferenceSupport".split(" "),
function(l,U,J,K,V,B,W,w,q,X,t,n,x,G,Y,L,M,Z,N,aa){function u(a){return"global"===a.viewingMode?M.cameraUtilsSpherical:L.cameraUtilsPlanar}function O(a,b,c){const d=a.state.camera,f=d.width/2/d.pixelRatio;a.renderCoordsHelper.viewingMode===G.ViewingMode.Global&&null!=c&&(b*=Math.cos(B.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return f/(96*39.37/b)/Math.tan(d.fovX/2)}function P(a,b,c){const d=a.state.camera;b=96*39.37/(d.width/2/d.pixelRatio/(b*Math.tan(d.fovX/2)));a.renderCoordsHelper.viewingMode===
G.ViewingMode.Global&&null!=c&&(b/=Math.cos(B.deg2rad(c)));return b*a.renderCoordsHelper.unitInMeters}function Q(a,b,c,d,f,e){if(y(e)){const h=new H(e.signal);C(a,d.heading,d.tilt,b,c,f,h);h.resolver.promise.then(g=>{g=D(a,g,d.fov);if(null==g)e.resolver.reject();else return e.resolver.resolve(g)},g=>e.resolver.reject(g))}else return b=C(a,d.heading,d.tilt,b,c,f),D(a,b,d.fov,e)}function R(a,b,c,d,f){return u(a).directionToHeadingTilt(b,c,d,f)}function ba(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,
v,a.spatialReference)&&a.elevationProvider&&(N.getElevationAtPoint(a.elevationProvider,v)??0)>(v.z??0)-1)}async function ca(a,b,c){if(!a.renderCoordsHelper.fromRenderCoords(b,v,a.spatialReference)||!a.elevationProvider)return!1;b=v.z??0;return(await a.elevationProvider.queryElevation(v.x,v.y,b,v.spatialReference,"ground",c)??0)>b-1}async function da(a,b,c){const d=q.create();b?b instanceof t?(n.projectPointToVector(b,d,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&null!=a.elevationProvider&&
(b=await a.elevationProvider.queryElevation(b.x,b.y,b.z??0,b.spatialReference,"ground",c),null!=b&&a.renderCoordsHelper.setAltitude(d,b))):w.copy(d,b):w.copy(d,a.state.camera.center);return d}function ea(a,b){const c=q.create();b&&b instanceof t?(n.projectPointToVector(b,c,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&null!=a.elevationProvider&&(b=N.getElevationAtPoint(a.elevationProvider,b),null!=b&&a.renderCoordsHelper.setAltitude(c,b))):b?w.copy(c,b):w.copy(c,a.state.camera.center);
return c}function C(a,b,c,d,f,e,h){const g=d&&d instanceof t?d:null;if(y(h))return da(a,d,h.signal).then(k=>{I(a,b,c,g,k,f,e,h)},k=>h.resolver.reject(k)),null;d=ea(a,d);return I(a,b,c,g,d,f,e,h)}function I(a,b,c,d,f,e,h,g){if(null==d&&(d=n.projectVectorToPoint(f,a.renderSpatialReference,a.spatialReference||x.WGS84),null==d))return null;e=Math.max(e,a.state.constraints.minimumPoiDistance);var k=fa(a,b,c,f,e,h);const p=u(a).eyeForCenterWithHeadingTilt,m=p(f,e,k.heading,k.tilt);if(h===l.OrientationMode.ADJUST&&
"global"===a.viewingMode&&0<c){const z=()=>{var r=e;var F=e;var E=u(a).eyeTiltToLookAtTilt(c,f,F);a.state.constraints.tilt&&(F=a.state.constraints.tilt(F),E=Math.min(E,.5*Math.PI),E=F.min*(1-.7)+.7*E);r=u(a).lookAtTiltToEyeTilt(E,f,r);h=1>c-r?l.OrientationMode.LOCKED:l.OrientationMode.ADJUST;return I(a,b,r,d,f,e,h,g)};k=a.map.ground.navigationConstraint;if(!k||"stay-above"===k.type){if(ba(a,m.eye))return z();if(y(g))return ca(a,m.eye,g.signal).then(r=>{if(r)return z();g.resolver.resolve({eye:m.eye,
up:m.up,center:q.clone(f),heading:m.heading,tilt:m.tilt});return null}),null}}k=!g||y(g)?{center:q.create(),eye:q.create(),up:q.create(),tilt:0,heading:0}:g;k.eye=m.eye;k.up=m.up;k.center=q.clone(f);k.heading=m.heading;k.tilt=m.tilt;y(g)&&g.resolver.resolve(k);return k}function fa(a,b,c,d,f,e){var h=0;if(e=e===l.OrientationMode.ADJUST)if(h=a.pointsOfInterest.centerOnSurfaceFrequent.distance,8<Math.log(f/h)/Math.LN2)e=!0;else{var g=a.renderSpatialReference,k=a.spatialReference||x.WGS84;e=n.projectVectorToPoint(d,
g,k);g=n.projectVectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,g,k);null==e||null==g?e=!1:(h*=Math.tan(.5*a.state.camera.fov),e=5<g.distance(e)/h)}e?(b=0,c=u(a).eyeTiltToLookAtTilt(c,d,f),a.state.constraints.tilt?(e=a.state.constraints.tilt(f),e.max=Math.min(e.max,.5*Math.PI),h=Math.min(c,e.min*(1-.7)+.7*e.max)):h=c):h=u(a).eyeTiltToLookAtTilt(c,d,f);c=h=a.state.constraints.clampTilt(f,h);c=u(a).lookAtTiltToEyeTilt(c,d,f);return{heading:b,tilt:c}}function D(a,b,c,d){if(null==
b)return null;a=n.projectVectorToPoint(b.eye,a.renderSpatialReference,a.spatialReference||x.WGS84);return null==a?null:null!=d?(d.position=a,d.heading=b.heading,d.tilt=b.tilt,d.fov=c,d):new J(a,b.heading,b.tilt,c)}function y(a){return a&&"resolver"in a}const S=V.getLogger("esri.views.3d.support.cameraUtils"),T=q.create(),ha={heading:0,tilt:0},v=new t,ia=new K.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),ja=new K.Cyclical(-180,180);l.OrientationMode=void 0;(function(a){a[a.LOCKED=0]="LOCKED";
a[a.ADJUST=1]="ADJUST"})(l.OrientationMode||(l.OrientationMode={}));const A=q.create();let H=U._createClass(function(a){this.signal=a;this.resolver=W.createResolver()});l.AsyncContext=H;l.computeScale=function(a,b){n.projectVectorToVector(b.center,a.renderSpatialReference,T,x.WGS84);return P(a,b.distance,T[1])};l.directionToHeadingTilt=R;l.distanceToScale=P;l.externalToInternal=function(a,b){if(null==b)return null;var c=a.renderSpatialReference;const d=u(a).headingTiltToDirectionUp,f=q.create();if(!n.projectPointToVector(b.position,
f,c))return null;c=d(f,b.heading,b.tilt);w.scale(c.direction,c.direction,a.state.camera.distance);w.add(c.direction,c.direction,f);a=Y.cameraOnContentAlongViewDirection(a,f,c.direction,c.up);a.fov=B.deg2rad(b.fov);return a};l.fromCenterDistance=Q;l.fromCenterScale=function(a,b,c,d,f,e){c=O(a,c,b.latitude);return Q(a,b,c,d,f,e)};l.fromExtent=function(a,b,c,d,f,e=null){if(a.state.isGlobal){if(!aa.isSpatialReferenceSupported(b.spatialReference,G.ViewingMode.Global))return y(e)&&e.resolver.reject(),null;
var h=new t(b.xmin,b.ymin,b.spatialReference);const m=new t(b.xmax,b.ymax,b.spatialReference),z=b.spatialReference.isGeographic?ja:ia;var g=new t({x:z.center(h.x,m.x),y:(m.y+h.y)/2,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:b.spatialReference});const r=X.getReferenceEllipsoid(b.spatialReference);var k=Z.getGreatCircleSpanAt(g,h,m);var p=k.lon;k=k.lat;z.diff(h.x,m.x)>z.range/2&&(p+=r.halfCircumference);p=Math.min(p,r.halfCircumference);k=Math.min(k,r.halfCircumference)}else g=
a.renderSpatialReference??b.spatialReference,g.equals(b.spatialReference)||(b=n.project(b,g)),p=b.xmax-b.xmin,k=b.ymax-b.ymin,g=new t({x:b.xmin+.5*p,y:b.ymin+.5*k,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:g});h=a.state.camera;b=Math.max(1/Math.tan(h.fovX/2)*p*.5,1/Math.tan(h.fovY/2)*k*.5,1/Math.tan(h.fov/2)*(null!=b.zmax&&null!=b.zmin?b.zmax-b.zmin:0)*.5)/1;if(y(e))p=new H(e.signal),C(a,c,d,g,b,f,p),p.resolver.promise.then(m=>{m=D(a,m,a.camera.fov);if(null==m)e.resolver.reject();
else return e.resolver.resolve(m)},m=>e.resolver.reject(m));else return c=C(a,c,d,g,b,f),D(a,c,a.camera.fov,e)};l.getObserverForPointAtDistance=C;l.headingTiltToDirectionUp=function(a,b,c,d,f){return u(a).headingTiltToDirectionUp(b,c,d,f)};l.internalToExternal=function(a,b,c){const d=a.renderSpatialReference,f=R(a,b.eye,b.viewForward,b.up,ha);a=a.spatialReference||x.WGS84;n.projectVectorToVector(b.eye,d,A,a)||(a=x.WGS84,n.projectVectorToVector(b.eye,d,A,a));if(null==c)return new J(new t(A,a),f.heading,
f.tilt,B.rad2deg(b.fov));c.position.x=A[0];c.position.y=A[1];c.position.z=A[2];c.position.spatialReference=a;c.heading=f.heading;c.tilt=f.tilt;c.fov=B.rad2deg(b.fov);return c};l.observerToCamera=D;l.scaleToDistance=O;l.scaleToZoom=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.levelAtScale(b);S.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};l.toExtent=function(a,b,c){const d=n.projectVectorToPoint(c,a.renderSpatialReference,a.spatialReference||x.WGS84);
if(null==d)return null;var f=Math.tan(b.fovX/2),e=Math.tan(b.fovY/2);b=w.dist(b.eye,c);f*=2*b;e*=2*b;return"global"===a.viewingMode?M.toExtent(a,d,f,e):L.toExtent(a,d,f,e)};l.zoomToScale=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.scaleAtLevel(b);S.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/handleUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/scheduling ../../../core/signal ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),
function(r,m,b,k,v,n,p,w,x,y,d,D,E,F,t,u,z,A,l){k=function(f){function g(){var e=f.apply(this,arguments)||this;e.updating=!1;return e}m._inherits(g,f);return m._createClass(g)}(k);b.__decorate([d.property({readOnly:!0})],k.prototype,"updating",void 0);k=b.__decorate([t.subclass("esri.views.3d.support.ResourceControllerMain")],k);let c=function(f){function g(){var a=f.apply(this,arguments)||this;a._immediateTask=l.ImmediateTask;a._normalTask=l.ImmediateTask;a._updatingObjects=x.signal([]);a._frameTask=
null;return a}m._inherits(g,f);var e=g.prototype;e.initialize=function(){this._scheduler=l.newScheduler();this._memoryController=z.newMemoryController(this.view);this._streamDataLoader=new A.StreamDataLoader;this._streamDataLoader.setup(u.maxDownloadSlots,u.downloadSlotsPerClient,this._scheduler);this.addHandles([p.watch(()=>this.view.state?.mode,a=>{null!=a&&(this._scheduler.state=a)},p.sync),p.watch(()=>this.view.stationary,()=>this._stationaryChangedHandler())]);this._frameTask=w.addFrameTask({update:a=>
this._frame(a)});this._immediateTask=this._scheduler.registerTask(l.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE);this._normalTask=this._scheduler.registerTask(l.TaskPriority.RESOURCE_CONTROLLER)};e.destroy=function(){this._immediateTask.remove();this._normalTask.remove();this._frameTask=n.removeMaybe(this._frameTask);this._streamDataLoader=n.destroyMaybe(this._streamDataLoader);this._memoryController=n.destroyMaybe(this._memoryController);this._scheduler=n.destroyMaybe(this._scheduler);this.view=null};
e.createStreamDataRequester=function(a){const h=this._streamDataLoader;return{request(q,B,C){return h.request(q,B,a,C)},get busy(){return!h.hasDownloadSlots(a)}}};e.addUpdatingObject=function(a){const h=this._updatingObjects;h.value=[...h.value,a];return v.makeHandle(()=>{h.value=h.value.filter(q=>q!==a)})};e._frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(y.secondsFromMilliseconds(a.deltaTime)),!this._scheduler))return;this._scheduler.updateBudget(a)?
(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};e._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};m._createClass(g,[{key:"immediate",get:function(){return this._immediateTask}},{key:"normal",get:function(){return this._normalTask}},{key:"updating",get:function(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(a=>
a.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"test",get:function(){return{getQueueStats:a=>this._streamDataLoader.test.loadQueue.getStatsForType(a)}}}]);return g}(k);b.__decorate([d.property()],c.prototype,"view",void 0);b.__decorate([d.property()],c.prototype,"_scheduler",void 0);b.__decorate([d.property()],c.prototype,"_memoryController",void 0);b.__decorate([d.property()],c.prototype,"_streamDataLoader",
void 0);b.__decorate([d.property()],c.prototype,"_immediateTask",void 0);b.__decorate([d.property()],c.prototype,"_normalTask",void 0);b.__decorate([d.property()],c.prototype,"_updatingObjects",void 0);b.__decorate([d.property({readOnly:!0})],c.prototype,"updating",null);c=b.__decorate([t.subclass("esri.views.3d.support.ResourceControllerImpl")],c);r.newResourceController=function(f){return new c({view:f})};Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
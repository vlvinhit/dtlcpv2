// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../../SnappingVisualizer3D ../isSupportedGraphicUtils ../manipulatorUtils ../meshFastUpdateUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchTooltipOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(m,w,t,M,N,O,P,y,E,z,v,ka,la,ma,Q,R,A,S,T,U,V,W,X,Y,p,F,Z,aa,G,ba,H,ca,da,I,ea,fa,ha,B,J,ia){let K=w._createClass(function(n){this.allGraphics=n;this.type="graphic-move-start"}),L=w._createClass(function(n,u,l){this.dx=n;this.dy=u;this.allGraphics=l;this.type="graphic-move"}),D=w._createClass(function(n){this.allGraphics=n;this.type="graphic-move-stop"});m.GraphicMoveTool=function(n){function u(a){a=n.call(this,a)||this;a._infos=new Map;a.graphics=new M;a.enableZ=!0;a.tooltipOptions=new I;
a.type="move-3d";a._moveManipulation=null;a._tooltip=null;return a}w._inherits(u,n);var l=u.prototype;l.initialize=function(){const {view:a}=this;this.addHandles([this.graphics.on("change",c=>{c.removed.forEach(e=>this.removeHandles(e));this._updateGraphicInfos(c);this._setupFastTransformUpdates(c.added);this._refreshManipulators()}),z.watch(()=>this.tooltipOptions.enabled,c=>{this._tooltip=c?new ha.Tooltip({view:a}):y.destroyMaybe(this._tooltip)},z.syncAndInitial)]);const b=this.graphics.toArray();
this._updateGraphicInfos({added:b,removed:[]});this._setupFastTransformUpdates(b);this._refreshManipulators();this.finishToolCreation()};l.destroy=function(){this._tooltip=y.destroyMaybe(this._tooltip);this._moveManipulation=y.destroyMaybe(this._moveManipulation);this.removeAllHandles();this._set("view",null)};l.reset=function(){};l._updateGraphicInfos=function({added:a,removed:b}){for(const c of a){if(aa.isSupportedGraphic(c)!==U.SupportedGraphicResult.SUPPORTED)continue;a=new ja(c);const e=this.view.trackGraphicState(a.state);
this._infos.set(a.graphic,{info:a,handle:e})}for(const c of b)this._infos.get(c)?.handle.remove(),this._infos.delete(c)};l._setupFastTransformUpdates=function(a){for(const b of a)({info:a}=this._infos.get(b)),this.addHandles(W.meshTransformFastUpdateHandles(a.state),b)};l._refreshManipulators=function(){this.removeHandles("manipulators");this._moveManipulation=y.destroyMaybe(this._moveManipulation);this.manipulators.removeAll();if(0!==this._infos.size){var a=Array.from(this._infos.values(),({info:b})=>
b);this._createManipulators(a);this._createVisualElements(a);this._updateMoveManipulation(a)}};l._createManipulators=function(a){for(const b of a){const c=b.state;b.manipulationXY=new Z.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:c});b.manipulationXY.forEachManipulator(e=>this.addHandles([e.events.on("immediate-click",d=>{this.emit("immediate-click",{...d,graphic:c.graphic});d.stopPropagation()}),e.events.on("grab-changed",({action:d})=>{const {tooltipOptions:f,_tooltip:g}=this;
null!=g&&("start"===d?g.info=new B.TranslateGraphicTooltipInfo({tooltipOptions:f}):g.clear())})],"manipulators"));this.addHandles(b.manipulationXY.createDragPipeline((e,d,f,g)=>this._buildDragEventPipeline(a,p.ManipulationType.XY,e,d,f,g)),"manipulators")}this._createMoveManipulation(a)};l._createMoveManipulation=function(a){const b=new p.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?p.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):
Y.DISC_RADIUS});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(d=>{this.addHandles(d.events.on("immediate-click",f=>{b.zManipulation.hasManipulator(d)||1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.at(0)});f.stopPropagation()}),"manipulators")});var c=d=>f=>{this.addHandles(f.events.on("focus-changed",({action:g})=>{const k=this._tooltip;null!=k&&("focus"===g?this._updateMoveTooltip(a,d):k.clear())}),"manipulators")};
this._moveManipulation.xyManipulation.forEachManipulator(c(p.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(c(p.ManipulationType.XY_AXIS));this._moveManipulation.zManipulation.forEachManipulator(c(p.ManipulationType.Z));c=()=>this._updateMoveManipulation(a);for(const d of a)this.addHandles([d.state.on("changed",c),z.watch(()=>d.state.displaying,c)],"manipulators");const e=a[a.length-1];this.addHandles(e.state.on("changed",()=>this._updateMoveManipulationAngle(e)),
"manipulators");this.addHandles(b.createDragPipeline((d,f,g,k,q)=>this._buildDragEventPipeline(a,d,f,g,k,q),A.getGraphicEffectiveElevationInfo(e.graphic),e.graphic.geometry.spatialReference,e.graphic),"manipulators");this._updateMoveManipulationAngle(e)};l._createVisualElements=function(a){for(const b of a){const c=X.createVisualElements({view:this.view,graphic:b.graphic,forEachManipulator:e=>{b.manipulationXY?.forEachManipulator(e);this._moveManipulation?.forEachManipulator(e)},onManipulatorsChanged:()=>
P.makeHandle()});null!=c&&(b.geometryRepresentation=c.visualElement,b.geometryRepresentation instanceof G.OutlineVisualElement&&this.addHandles([b.geometryRepresentation.events.on("attachment-origin-changed",()=>{b.state.isDraped||this._updateMoveManipulation(a)}),z.watch(()=>b.state.isDraped,()=>this._updateMoveManipulation(a))],"manipulators"),this.addHandles(c,"manipulators"))}};l._updateMoveManipulationAngle=function(a){this._moveManipulation&&(this._moveManipulation.angle=F.shapeOrientation(a.graphic.geometry))};
l._updateMoveManipulation=function(a){const b=R.makeDehydratedPoint(0,0,0,this.view.spatialReference);let c=0,e=!1;const d=this._moveManipulation;if(d){for(const f of a)if(f.state.displaying&&(a=f.state.graphic,this.enableZ&&V.canMoveZ(a)&&(e=!0),a=f.geometryRepresentation instanceof G.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:S.getGraphicAttachmentOrigin(this.view,a),null!=a)){const {x:g,y:k,z:q}=a;b.x+=g;b.y+=k;q&&(b.z??(b.z=0),b.z+=q);c++}0<c?(b.x/=c,b.y/=
c,b.z??(b.z=0),b.z/=c,d.location=b,d.xyManipulation.available=!0,d.xyAxisManipulation.available=!0,d.zManipulation.available=e):d.available=!1}};l._buildDragEventPipeline=function(a,b,c,e,d,f){const g=[],k=[];let q=null,x=null;const C=()=>{for(const h of g)h.dragging=!1;g.length=0;k.length=0;x=q=null;this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===a.length&&b===p.ManipulationType.XY){const h=a[0].graphic;({steps:e,cancel:d}=this._buildSnappingPipelineSteps(h,A.getGraphicEffectiveElevationInfo(h),
e,d,f))}d=d.next(h=>x?.(h)).next(()=>{this.emit("graphic-move-stop",new D(k));this.destroyed||C();return null});e=e.next(h=>{if("start"===h.action){g.length=0;k.length=0;for(const r of a)r.dragging||!r.manipulationXY?.hasManipulator(c)&&r.manipulationXY?.grabbing||(g.push(r),k.push(r.graphic),r.dragging=!0);if(0!==k.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),q=H.dragGraphicMany(k,this.view.state.viewingMode),x=H.resetGraphicMany(k),this.emit("graphic-move-start",new K(k)),
this.destroyed))return null}return 0!==k.length?h:null}).next(h=>q?.(h)).next(h=>{this._updateMoveTooltip(a,b,h);return h}).next(h=>{switch(h.action){case "start":case "update":if(h.translationX||h.translationY||h.translationZ){const r=this.view.toScreen(h.mapStart);h=this.view.toScreen(h.mapEnd);this.emit("graphic-move",new L(h.x-r.x,h.y-r.y,k))}break;case "end":this.emit("graphic-move-stop",new D(k)),this.destroyed||C()}return null});return{steps:e,cancel:d}};l._updateMoveTooltip=function(a,b,c){const {tooltipOptions:e,
_tooltip:d}=this;if(null!=d){d.clear();var f=0===a.length?"absolute-height":a[0].state.isDraped?"on-the-ground":"absolute-height";switch(b){case p.ManipulationType.XY:d.info=new B.TranslateGraphicTooltipInfo({tooltipOptions:e});this._updateMoveTooltipDistance(d.info,c,(g,k)=>J.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f));break;case p.ManipulationType.XY_AXIS:d.info=new B.TranslateGraphicXYTooltipInfo({tooltipOptions:e});this._updateMoveTooltipDistance(d.info,c,(g,k)=>{g=J.autoHorizontalDistanceByElevationModeBetweenPoints(g,
k,f);return E.scale(g,F.axisConstrainedDragSign(c))});break;case p.ManipulationType.Z:d.info=new B.TranslateGraphicZTooltipInfo({tooltipOptions:e}),this._updateMoveTooltipDistance(d.info,c,ia.verticalSignedDistanceBetweenPoints)}}};l._updateMoveTooltipDistance=function(a,b,c){if(null!=b&&"end"!==b.action){const {mapStart:e,mapEnd:d}=b;b=c(e,d);a.distance=null!=b?b:E.zeroMeters}};l._buildSnappingPipelineSteps=function(a,b,c,e,d){const f=a.geometry;if(null==f||"point"!==f.type&&"mesh"!==f.type)return{steps:c,
cancel:e};const g=("point"===f.type?f:f.anchor).clone(),k=new ea.SnappingContext({elevationInfo:b,pointer:d,editGeometryOperations:da.EditGeometryOperations.fromGeometry(g,this.view.state.viewingMode),visualizer:new T.SnappingVisualizer3D,excludeFeature:a}),{snappingStep:q,cancelSnapping:x}=fa.createSnapDragEventPipelineStep({snappingContext:k,snappingManager:this.snappingManager,updatingHandles:this.updatingHandles});e=e.next(x);c=c.next(C=>{g.z=A.getConvertedElevation(this.view,g,A.getGraphicEffectiveElevationInfo(a),
{mode:"absolute-height",offset:0});const h=k.coordinateHelper.pointToVector(g);return{...C,snapOrigin:h}}).next(...q);return{steps:c,cancel:e}};w._createClass(u,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{tooltip:this._tooltip}}}]);return u}(O.HandleOwnerMixin(N.EventedMixin(ca.InteractiveToolBase)));t.__decorate([v.property({constructOnly:!0,nonNullable:!0})],m.GraphicMoveTool.prototype,"view",void 0);t.__decorate([v.property()],m.GraphicMoveTool.prototype,
"graphics",void 0);t.__decorate([v.property({constructOnly:!0,nonNullable:!0})],m.GraphicMoveTool.prototype,"enableZ",void 0);t.__decorate([v.property({constructOnly:!0,type:I})],m.GraphicMoveTool.prototype,"tooltipOptions",void 0);t.__decorate([v.property({constructOnly:!0})],m.GraphicMoveTool.prototype,"snappingManager",void 0);t.__decorate([v.property()],m.GraphicMoveTool.prototype,"type",void 0);t.__decorate([v.property()],m.GraphicMoveTool.prototype,"updating",null);m.GraphicMoveTool=t.__decorate([Q.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],
m.GraphicMoveTool);let ja=function(){function n(u){this.manipulationXY=this.geometryRepresentation=null;this.dragging=!1;this.state=new ba.GraphicState({graphic:u})}w._createClass(n,[{key:"graphic",get:function(){return this.state.graphic}}]);return n}();m.GraphicMoveEvent=L;m.GraphicMoveStartEvent=K;m.GraphicMoveStopEvent=D;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
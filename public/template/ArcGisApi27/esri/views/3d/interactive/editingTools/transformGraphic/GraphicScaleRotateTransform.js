// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Cyclical ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../../RenderObject ../dragEventPipeline3D ../ManipulatorType ../settings ../manipulations/config ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TransformTooltipInfos ../../../../support/colorUtils".split(" "),
function(U,Z,aa,ba,ca,H,P,G,I,da,ea,E,fa,v,J,K,L,q,ha,ia,ja,z,ka,la,ma,d,na,Q,oa,pa,qa,B,ra,R,sa){function ta(c,f){var a=v.subtract(q.sv3d.get(),f.renderStart,c.origin);c=v.subtract(q.sv3d.get(),f.renderEnd,c.origin);a=v.length(a);c=v.length(c);return 0===a?0:c/a}function ua(c,f,a,b){const {renderStart:e,renderEnd:k}=c;var h=M(e,b,q.sv3d.get());c=M(k,b,q.sv3d.get());if(v.squaredDistance(h,c)<d.DRAG_THRESHOLD_PX*d.DRAG_THRESHOLD_PX)return null;const w=v.subtract(q.sv3d.get(),e,a);f=v.cross(q.sv3d.get(),
w,K.normal(f));f=v.add(q.sv3d.get(),e,f);a=M(a,b,q.sv3d.get());b=M(f,b,q.sv3d.get());f=v.subtract(q.sv3d.get(),b,h);b=v.subtract(q.sv3d.get(),h,a);h=L.wrap(h,f);b=L.wrap(a,b);return L.distance2(h,c)<L.distance2(b,c)?"rotate":"scale"}function M(c,f,a){f.projectToScreen(c,S);return v.set(a,S[0],S[1],0)}function V(c,f){let a=null,b=1;const e=()=>b;return{start:()=>{b=c.getScale();a=c.getScale;c.getScale=e;f()},update:k=>{b+=((b+1)/2-b)*Math.min(k*d.RING_RESET_ANIMATION_SPEED_FACTOR,1);f();return.01>
Math.abs(b-1)?F.STOP:F.CONTINUE},destroy:()=>{a&&(c.getScale=a);f()}}}function va(c,f,a){let b=0,e=null;const k=()=>!1;return{start:()=>{e=c.getFocused;c.getFocused=k;b=0;f()},update:h=>{b+=h;return!e?.()||b>=a.delayMs?F.STOP:F.CONTINUE},destroy:()=>{e&&(c.getFocused=e);f()}}}function N(c){switch(c){case "integer":case "long":return 0;default:return null}}var g;(function(c){c.ScaleIn=B.ManipulatorStateCustomFlags.Custom2;c.ScaleOut=B.ManipulatorStateCustomFlags.Custom3;c.RotateLeft=B.ManipulatorStateCustomFlags.Custom4;
c.RotateRight=B.ManipulatorStateCustomFlags.Custom5;c.Unlocked=B.ManipulatorStateCustomFlags.Custom7;c.DelayedFocused=B.ManipulatorStateCustomFlags.Custom8;c.TouchInput=B.ManipulatorStateCustomFlags.Custom12})(g||(g={}));let wa=function(){function c({adapter:a,tooltipOptions:b,mode:e,tool:k}){this._mode=null;this._handles=new ca;this._activeAnimation=this._scaleRotateDragData=null;this._ringIndicatorDelayMs=d.RING_INDICATOR_DELAY_MS;this.events=new ba;this.getFocused=()=>this._ringManipulator.focused;
this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this._adapter.scale:1;this.tool=k;this._mode=e;this._adapter=a;this._tooltipOptions=b;this._tooltip=new ra.Tooltip({view:k.view});this._createManipulator();this._updateDragState();this._updateManipulatorTransform();this._handles.add(I.when(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),I.initial))}var f=c.prototype;f.destroy=function(){this._activeAnimation?.frameTask.remove();this._activeAnimation=null;this._handles=P.destroyMaybe(this._handles);
this.tool.manipulators.remove(this._ringManipulator);this._ringManipulator=null;this._tooltip=P.destroyMaybe(this._tooltip)};f.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=da.addFrameTask({update:({deltaTime:e})=>{a.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}};f.cancelActiveAnimation=function(){this._activeAnimation?.frameTask.remove();this._activeAnimation=P.destroyMaybe(this._activeAnimation)};f.forEachManipulator=function(a){a(this._ringManipulator,
la.ManipulatorType.SCALE_ROTATE)};f._createManipulator=function(){const a=this._createRingManipulator();this._ringManipulator=a;this.tool.manipulators.add(a);const b=this.tool.graphicState.graphic,e=qa.createManipulatorDragEventPipeline(a,(k,h,w)=>{this._scaleRotateDragData=null;const y=this._adapter.startInteraction(),m={mode:"none",origin:J.clone(k.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=m;this._updateDragState();const x=q.sv3d.get();
this.tool.view.renderCoordsHelper.worldUpAtPosition(k.renderLocation,x);h.next(ka.screenToRenderPlane(this.tool.view,K.fromPositionAndNormal(k.renderLocation,x,K.create()))).next(l=>{var n=K.normal(l.plane);n=ja.calculateInputRotationTransform(l.renderStart,l.renderEnd,m.origin,n);var p=aa.cyclicalPI.shortestSignedDiff(m.angle,n);m.angleDir=H.clamp(m.angleDir+p,-d.ROTATE_INDICATOR_DIRECTION_BUFFER,d.ROTATE_INDICATOR_DIRECTION_BUFFER);m.angle=n;p=ta(m,l);m.scaleDir=H.clamp(m.scaleDir+(p-this._adapter.scale),
-d.SCALE_INDICATOR_DIRECTION_BUFFER,d.SCALE_INDICATOR_DIRECTION_BUFFER);this._onScaleChanged();if("none"===m.mode){const t=this._mode||ua(l,l.plane,m.origin,this.tool.view.state.camera);if(null!=t){switch(t){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:b,angle:0});this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:b,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}m.mode=
t}}switch(m.mode){case "rotate":y.state.angle=m.initialAngle+n;break;case "scale":y.state.scale=p,this._onScaleChanged()}this._updateDragState();this._updateManipulatorTransform();switch(l.action){case "start":case "update":switch(m.mode){case "rotate":this.tool.emit("graphic-rotate",{graphic:b,angle:H.rad2deg(m.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:b,xScale:p,yScale:p})}break;case "end":switch(m.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:H.rad2deg(m.angle)});
break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:p,yScale:p})}}"end"===l.action&&(this.startAnimation(V(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),y.done());return l}).next(this._updateTooltipPipelineStep(m));w.next(()=>{y.cancel();if(null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",
{graphic:b,xScale:1,yScale:1})}this.startAnimation(V(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([e,a.events.on("focus-changed",k=>{"focus"===k.action?this.startAnimation(va(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),a.events.on("immediate-click",k=>{k.stopPropagation()}),I.watch(()=>this.tool.graphicState?.displaying,k=>this._ringManipulator.available=
k,I.initial)])};f._updateTooltipPipelineStep=function(a){return b=>{const e=this._tooltipOptions;if(!e.enabled)return b;if("end"===b.action)return this._updateFocusTooltip(),b;const k=this._tooltip;var h=this._tooltipOptions.visualVariables;switch(a.mode){case "scale":const {size:w,scale:y}=this._adapter;h=h?.size;k.info=new R.TransformScaleTooltipInfo({tooltipOptions:e,scale:{value:y},size:null!=w?G.createLength(w,"meters"):void 0,sizePrecision:N(h?.valueType),sizeUnit:h?.unit});break;case "rotate":const {orientationClockwise:m,
relativeAngleClockwise:x}=this._adapter;h=h?.rotation;const l=N(h?.valueType);k.info=new R.TransformRotateTooltipInfo({tooltipOptions:e,rotation:null!=x?G.createAngle(x,"radians","geographic"):void 0,rotationPrecision:l,rotationType:h?.rotationType??"geographic",orientation:null!=m?G.createAngle(m,"radians","geographic"):void 0,orientationPrecision:l})}return b}};f._updateFocusTooltip=function(){if(this._tooltipOptions.enabled)if(this.getFocused()){var a=this._tooltipOptions.visualVariables;const b=
a?.rotation;a=a?.size;const e=this._mode,{size:k,orientationClockwise:h}=this._adapter,w=null!=k&&(null==e||"scale"===e);this._tooltip.info=new R.TransformAbsoluteTooltipInfo({tooltipOptions:this._tooltipOptions,orientation:null==h||null!=e&&"rotate"!==e?void 0:G.createAngle(h,"radians","geographic"),orientationPrecision:N(b?.valueType),rotationType:b?.rotationType??"geographic",size:w?G.createLength(k,"meters"):void 0,sizeUnit:a?.unit,sizePrecision:N(a?.valueType)})}else this._tooltip.clear()};f._onScaleChanged=
function(){this.events.emit("scale-changed");this._updateManipulatorTransform()};f._updateDelayedFocusedState=function(){this._ringManipulator.updateStateEnabled(g.DelayedFocused,this.getFocused());this._updateFocusTooltip()};f._updateDragState=function(){this._ringManipulator.updateStateEnabled(g.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode));if(null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case "rotate":this._ringManipulator.updateStateEnabled(g.ScaleIn|
g.ScaleOut,!1);this._ringManipulator.updateStateEnabled(g.RotateLeft,0>this._scaleRotateDragData.angleDir);this._ringManipulator.updateStateEnabled(g.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this._ringManipulator.updateStateEnabled(g.RotateLeft|g.RotateRight,!1),this._ringManipulator.updateStateEnabled(g.ScaleIn,0>this._scaleRotateDragData.scaleDir),this._ringManipulator.updateStateEnabled(g.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this._ringManipulator.updateStateEnabled(g.ScaleIn|
g.ScaleOut|g.RotateLeft|g.RotateRight,!1)};f._updateManipulatorTransform=function(){const a=E.fromRotation(q.sm4d.get(),this._adapter.angle,J.fromValues(0,0,1));if(null!=a){var b=this.getScale();b=E.fromScaling(q.sm4d.get(),v.set(q.sv3d.get(),b,b,b));this._ringManipulator.modelTransform=E.multiply(q.sm4d.get(),b,a)}};f._createRingManipulator=function(){var a=(u,C,O)=>{const W=[],X=Math.ceil(d.GEOMETRY_SEGMENTS*(C-u)/(2*Math.PI));for(let T=0;T<X+1;T++){const Y=u+T*(C-u)/X;W.push(J.fromValues(O*Math.cos(Y),
O*Math.sin(Y),0))}return W};const b=this._createMaterial(1);var e=(u,C,O=b)=>Q.createPathExtrusionGeometry(O,[[-C/2,0],[C/2,0],[C/2,d.RING_HEIGHT/2],[-C/2,d.RING_HEIGHT/2]],u,[],[],!1),k=a(0,2*Math.PI,d.RING_RADIUS),h=e(k,d.RING_THICKNESS),w=[],y=[];const m=[];for(var x=0;2>x;x++){var l=x*Math.PI-Math.PI/4,n=Math.PI/2-d.ROTATE_INDICATOR_ARC_LENGTH,p=l+n;l=l+Math.PI/2-n;n=a(p,l,d.INNER_INDICATOR_RADIUS);var t=e(n,d.INDICATOR_THICKNESS);m.push(n);m.push(a(p,l,d.OUTER_INDICATOR_RADIUS-d.RING_THICKNESS/
2));w.push(t);y.push(t.instantiate());for(t=0;2>t;t++){var D=0===t,r=fa.create();if(D){E.scale(r,r,[1,-1,1]);E.rotate(r,r,-p,[0,0,1]);var A=Math.round(d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(n.length-1));r[12]=n[A][0];r[13]=n[A][1];r[14]=n[A][2]}else E.rotate(r,r,l,[0,0,1]),A=Math.round((1-d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(n.length-1)),r[12]=n[A][0],r[13]=n[A][1],r[14]=n[A][2];A=Q.createExtrudedTriangle(b,d.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,d.ROTATE_INDICATOR_ARROW_TIP_RADIUS,
d.RING_HEIGHT);Q.transformInPlace(A,r);(D?w:y).push(A)}}x=[];for(p=0;2>p;p++)l=p*Math.PI-Math.PI/4,n=Math.PI/2-d.SCALE_INDICATOR_ARC_LENGTH,l=a(l+n,l+Math.PI/2-n,d.OUTER_INDICATOR_RADIUS),x.push(e(l,d.INDICATOR_THICKNESS));D=this._createMaterial(.66);p=this._createMaterial(.5);n=this._createMaterial(.33);l=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET1);t=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET2);l=e(l,d.INDICATOR_THICKNESS,D);t=e(t,d.INDICATOR_THICKNESS,n);r=a(0,2*Math.PI,d.RING_RADIUS-
d.SCALE_INDICATOR_OFFSET1);a=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET2);D=e(r,d.INDICATOR_THICKNESS,D);e=e(a,d.INDICATOR_THICKNESS,n);h=[new z.RenderObject(h,g.DelayedFocused),new z.RenderObject(h.instantiate({material:p}),B.ManipulatorStateFlags.None)];this._mode&&"scale"!==this._mode||(h=h.concat([...x.map(u=>new z.RenderObject(u,g.DelayedFocused|g.Unlocked)),new z.RenderObject(l,g.DelayedFocused|g.ScaleIn),new z.RenderObject(t,g.DelayedFocused|g.ScaleIn),new z.RenderObject(D,g.DelayedFocused|
g.ScaleOut),new z.RenderObject(e,g.DelayedFocused|g.ScaleOut)]));this._mode&&"rotate"!==this._mode||(h=h.concat([...y.map(u=>new z.RenderObject(u.instantiate(),g.DelayedFocused|g.Unlocked)),...w.map(u=>new z.RenderObject(u,g.DelayedFocused|g.RotateLeft)),...y.map(u=>new z.RenderObject(u,g.DelayedFocused|g.RotateRight))]));k=[k,...m];return new ia.Manipulator3D({view:this.tool.view,renderObjects:h,autoScaleRenderObjects:!1,worldOriented:!0,radius:d.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,
elevationInfo:ha.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:k,direction:J.fromValues(0,0,1)}})};f._createMaterial=function(a){const b=ma.getSettings(this.tool.view).colors.accent.clone();b.a=a;return new pa.ColorMaterial({color:sa.unitRGBAFromColor(b),transparent:1!==a,cullFace:na.CullFaceOptions.Back,renderOccluded:oa.RenderOccludedFlag.Transparent})};Z._createClass(c,[{key:"angle",get:function(){return this._adapter.angle}},{key:"scale",get:function(){return this._adapter.scale}},
{key:"location",set:function(a){this._ringManipulator.location=a}},{key:"elevationAlignedLocation",set:function(a){this._ringManipulator.elevationAlignedLocation=a}},{key:"grabbing",get:function(){return this._ringManipulator.grabbing}},{key:"interactive",set:function(a){this._ringManipulator.interactive=a}},{key:"test",get:function(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:a=>this._ringIndicatorDelayMs=a,tooltip:this._tooltip}}}]);return c}();var F;(function(c){c[c.CONTINUE=
0]="CONTINUE";c[c.STOP=1]="STOP"})(F||(F={}));const S=ea.createScreenPointArray();U.GraphicScaleRotateTransform=wa;Object.defineProperty(U,Symbol.toStringTag,{value:"Module"})});
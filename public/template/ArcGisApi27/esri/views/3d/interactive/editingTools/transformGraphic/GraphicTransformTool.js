// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Evented ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../geometry/Point ../../../../../support/elevationInfoUtils ../../../../ViewingMode ../../Manipulator3D ../../manipulatorUtils ../../SnappingVisualizer3D ../manipulatorUtils ../meshFastUpdateUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ./GraphicScaleRotateTransform ./ScaleRotateMeshAdapter ./ScaleRotateObjectSymbol3DAdapter ./undoRecords ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchTooltipOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(d,y,g,E,F,G,t,z,r,h,fa,ha,ia,H,I,J,K,L,M,N,A,O,P,Q,l,R,S,T,U,V,W,X,Y,Z,B,aa,ba,ca,w,C,da){d.GraphicTransformTool=function(D){function u(a){a=D.call(this,a)||this;a.enableZ=!0;a.enableRotation=!0;a.enableScaling=!0;a.tooltipOptions=new B;a.type="transform-3d";a._scaleRotate=null;a._tooltip=null;return a}y._inherits(u,D);var e=u.prototype;e.initialize=function(){const {graphic:a,view:c}=this;this.graphicState=new W.GraphicState({graphic:a});this.addHandles(r.watch(()=>this.tooltipOptions.enabled,
b=>{this._tooltip=b?new ca.Tooltip({view:c}):t.destroyMaybe(this._tooltip)},r.syncAndInitial));this._moveManipulation=new l.MoveManipulation({tool:this,view:c,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&A.canMoveZ(a),radius:l.MoveManipulation.radiusForSymbol(a.symbol)});this._moveManipulation.forEachManipulator(b=>this.handles.add(b.events.on("immediate-click",k=>{this.emit("immediate-click",{...k,graphic:a});k.stopPropagation()})));const n=b=>k=>{this.handles.add(k.events.on("focus-changed",
({action:m})=>{const p=this._tooltip;null!=p&&("focus"===m?this._updateMoveTooltip(b):p.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(n(l.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(n(l.ManipulationType.XY_AXIS));this._moveManipulation.zManipulation.forEachManipulator(n(l.ManipulationType.Z));const f=J.getGraphicEffectiveElevationInfo(a);this._moveManipulation.elevationInfo=f;this.addHandles(O.meshTransformFastUpdateHandles(this.graphicState));
const {geometry:q}=a;this._moveManipulation.createGraphicDragPipeline((b,k,m,p,x)=>{if(null!=q&&b===l.ManipulationType.XY){const {snappingStep:v,cancelSnapping:ea}=ba.createSnapDragEventPipelineStep({snappingContext:new aa.SnappingContext({elevationInfo:f,pointer:x,editGeometryOperations:Z.EditGeometryOperations.fromGeometry(new I({spatialReference:q.spatialReference}),c.state.viewingMode),visualizer:new N.SnappingVisualizer3D,excludeFeature:a}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,
useZ:!1});p=p.next(ea);m=m.next(X.sceneSnappingAtProjectedLocation(this.view,f)).next(...v)}m=m.next(v=>{this._updateMoveTooltip(b,v);return v});return{steps:m,cancel:p}},this.graphicState,b=>{const {action:k,graphic:m,dxScreen:p,dyScreen:x}=b;b={graphic:m,dxScreen:p,dyScreen:x};switch(k){case "start":this.emit("graphic-translate-start",b);this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case "update":this.emit("graphic-translate",b);break;case "end":this.emit("graphic-translate-stop",
b)}});this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0;this._scaleRotateAdapter=this._createScaleRotateAdapter();this.handles.add(r.watch(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle()));if(this.enableScaling||this.enableRotation)this._scaleRotate=new S.GraphicScaleRotateTransform({tool:this,mode:this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate",adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",
()=>this._onScaleChanged()));this.handles.add([P.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:b=>this._forEachManipulator(b),onManipulatorsChanged:()=>G.makeHandle()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),r.watch(()=>c.scale,()=>this._updateMoveAngle())]);this.handles.add(this.view.trackGraphicState(this.graphicState));this._onGeometryChanged();this._updateMoveAngle();this._forEachManipulator(b=>{b instanceof
L.Manipulator3D&&this.handles.add(b.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))});this.finishToolCreation()};e.destroy=function(){this._tooltip=t.destroyMaybe(this._tooltip);this._moveManipulation.destroy();this._scaleRotate=t.destroyMaybe(this._scaleRotate);this._scaleRotateAdapter=t.destroyMaybe(this._scaleRotateAdapter);this._set("view",null);this._set("graphic",null)};e._updateManipulatorsInteractive=function(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,
this._moveManipulation.interactive=!this._scaleRotate.grabbing)};e._createScaleRotateAdapter=function(){return null!=this.graphic.geometry&&"mesh"===this.graphic.geometry.type?new T.ScaleRotateMeshAdapter({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new U.ScaleRotateObjectSymbol3DAdapter({graphic:this.graphic,sizeFilter:a=>this._enforceNonZeroSize(a),findLayerView:()=>this.view.allLayerViews.find(a=>a.layer===this.graphic.layer),sizeAxis:this.tooltipOptions?.visualVariables?.size?.axis??
null})};e._forEachManipulator=function(a){this._moveManipulation?.forEachManipulator(a);this._scaleRotate?.forEachManipulator(a)};e._hideManipulatorsForGraphicState=function(){return r.watch(()=>this.graphicState.displaying,a=>{this._forEachManipulator(c=>c.available=a);this._moveManipulation.zManipulation.available=a&&this.enableZ&&A.canMoveZ(this.graphic)})};e._createGeometryUndoRecord=function(){return V.createGraphicGeometryUndoRecord(this.graphic)};e.reset=function(){};e.onHide=function(){this._scaleRotate?.cancelActiveAnimation()};
e._onScaleChanged=function(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())};e._updateMoveAngle=function(){this._moveManipulation.angle=this.view.state.viewingMode===K.ViewingMode.Local||this.view.scale<Q.ALIGN_ARROWS_SCALE_THRESHOLD?this._scaleRotateAdapter.angle:0};e._onGeometryChanged=function(){M.placeAtGraphic(this.view,this,this.graphic)};e._enforceNonZeroSize=function(a){return a||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)};
e._updateMoveTooltip=function(a,c){const {tooltipOptions:n,_tooltip:f}=this;if(null!=f){f.clear();var q=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(a){case l.ManipulationType.XY:f.info=new w.TranslateGraphicTooltipInfo({tooltipOptions:n});this._updateMoveTooltipDistance(f.info,c,(b,k)=>C.autoHorizontalDistanceByElevationModeBetweenPoints(b,k,q));break;case l.ManipulationType.XY_AXIS:f.info=new w.TranslateGraphicXYTooltipInfo({tooltipOptions:n});this._updateMoveTooltipDistance(f.info,
c,(b,k)=>{b=C.autoHorizontalDistanceByElevationModeBetweenPoints(b,k,q);return z.scale(b,R.axisConstrainedDragSign(c))});break;case l.ManipulationType.Z:f.info=new w.TranslateGraphicZTooltipInfo({tooltipOptions:n}),this._updateMoveTooltipDistance(f.info,c,da.verticalSignedDistanceBetweenPoints)}}};e._updateMoveTooltipDistance=function(a,c,n){if(null!=c&&"end"!==c.action){const {mapStart:f,mapEnd:q}=c;c=n(f,q);a.distance=null!=c?c:z.zeroMeters}};y._createClass(u,[{key:"snapToScene",set:function(a){this._moveManipulation&&
(this._moveManipulation.snapToScene=a);this._set("snapToScene",a)}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"location",set:function(a){this._moveManipulation.location=a;this._scaleRotate&&(this._scaleRotate.location=a)}},{key:"elevationAlignedLocation",set:function(a){this._moveManipulation.elevationAlignedLocation=a;this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=a)}},{key:"test",get:function(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,
zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:a=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(a):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}}]);return u}(F.HandleOwnerMixin(E.EventedMixin(Y.InteractiveToolBase)));
g.__decorate([h.property({constructOnly:!0,nonNullable:!0})],d.GraphicTransformTool.prototype,"view",void 0);g.__decorate([h.property({constructOnly:!0,nonNullable:!0})],d.GraphicTransformTool.prototype,"graphic",void 0);g.__decorate([h.property({constructOnly:!0,nonNullable:!0})],d.GraphicTransformTool.prototype,"enableZ",void 0);g.__decorate([h.property()],d.GraphicTransformTool.prototype,"enableRotation",void 0);g.__decorate([h.property()],d.GraphicTransformTool.prototype,"enableScaling",void 0);
g.__decorate([h.property({constructOnly:!0,type:B})],d.GraphicTransformTool.prototype,"tooltipOptions",void 0);g.__decorate([h.property()],d.GraphicTransformTool.prototype,"graphicState",void 0);g.__decorate([h.property({value:!1})],d.GraphicTransformTool.prototype,"snapToScene",null);g.__decorate([h.property({constructOnly:!0})],d.GraphicTransformTool.prototype,"snappingManager",void 0);g.__decorate([h.property({readOnly:!0})],d.GraphicTransformTool.prototype,"type",void 0);g.__decorate([h.property({readOnly:!0})],
d.GraphicTransformTool.prototype,"updating",null);d.GraphicTransformTool=g.__decorate([H.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],d.GraphicTransformTool);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
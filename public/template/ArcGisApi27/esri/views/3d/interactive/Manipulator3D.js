// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../geometry ../../../core/compilerUtils ../../../core/Evented ../../../core/mathUtils ../../../core/maybe ../../../core/screenUtils ../../../core/accessorSupport/utils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/lineSegment ../../../geometry/support/plane ../../../geometry/support/ray ../../../geometry/support/vectorStacks ../../../layers/graphics/hydratedFeatures ../support/ElevationProvider ../support/geometryUtils/ray ../webgl-engine/lib/Camera ../webgl-engine/lib/Object3D ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lib/WebGLLayer ../../interactive/interfaces ../../../geometry/Point".split(" "),
function(H,T,I,U,V,J,W,q,X,K,Y,r,x,Z,k,n,aa,y,ba,t,u,ca,z,D,E,F,da,ea,fa,ha,l,A){function L(p){return 0!==p[12]||0!==p[13]||0!==p[14]}I=function(){function p(a){this.metadata=void 0;this._camera=new da.Camera;this._elevation={offset:0,override:null};this.collisionType={type:"point"};this.collisionPriority=0;this._renderObjects=[];this._available=this.autoScaleRenderObjects=!0;this._noDisplayCount=0;this._radius=10;this._worldSized=!1;this.focusMultiplier=2;this.touchMultiplier=2.5;this.worldOriented=
!1;this._modelTransform=x.create();this._worldFrame=null;this._renderLocation=n.create();this._renderLocationDirty=!0;this._location=new A({x:0,y:0,z:0});this._elevationAlignedLocation=new A;this.interactive=this._elevationAlignedLocationDirty=!0;this.selectable=!1;this.grabbable=!0;this.grabCursor=this.cursor=null;this._selected=this._hovering=this.dragging=this._grabbing=!1;this._state=l.ManipulatorStateCustomFlags.None;this._focused=!1;this.events=new V.EventEmitter;this._screenLocation={screenPointArray:q.createScreenPointArray(),
renderScreenPointArray:q.createRenderScreenPointArray3(),pixelSize:0};this._screenLocationDirty=!0;this._attached=this._engineResourcesAddedToStage=!1;this._location.spatialReference=a.view.spatialReference;Object.assign(this,a);(a=this.view.state?.camera)&&this._camera.copyFrom(a)}var h=p.prototype;h.destroy=function(){this._applyObjectTransform=ia;this._removeResourcesFromStage();this._camera=this.view=this._engineResources=null};h.disableDisplay=function(){this._noDisplayCount++;1===this._noDisplayCount&&
this._updateEngineObject();return{remove:X.once(()=>{this._noDisplayCount--;0===this._noDisplayCount&&this._updateEngineObject()})}};h._notifyLocationChanged=function(){this._elevationAlignedLocationDirty=this._screenLocationDirty=this._renderLocationDirty=!0;this._updateEngineObject();this.events.emit("location-update",{location:this._location})};h._updateElevationAlignedLocation=function(){const a=null!=this._elevation.override?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=
this.location.x;this._elevationAlignedLocation.y=this.location.y;this._elevationAlignedLocation.z=a+this._elevation.offset;this._elevationAlignedLocation.spatialReference=D.hydratedSpatialReference(this.location.spatialReference);this._screenLocationDirty=this._renderLocationDirty=!0;this._elevationAlignedLocationDirty=!1};h.grabbableForEvent=function(){return!0};h.updateStateEnabled=function(a,b){this.state=b?this.state|a:this.state&~a};h._setFocused=function(a){a!==this._focused&&(this._focused=
a,this.events.emit("focus-changed",{action:!0===a?"focus":"unfocus"}))};h._ensureScreenLocation=function(){if(this._screenLocationDirty){this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation);this._screenLocationDirty=!1;if(L(this._modelTransform)){var a=this._calculateModelTransformOffset(ja);a=k.add(a,a,this.renderLocation)}else a=this.renderLocation;this._camera.projectToRenderScreen(a,this._screenLocation.renderScreenPointArray);this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,
this._screenLocation.screenPointArray)}};h.intersectionDistance=function(a,b){if(!this.available)return null;a=q.screenPointObjectToArray(a,ka);var d=this._getCollisionRadius(b);b=-1*this.collisionPriority;switch(this.collisionType.type){case "point":if(Z.squaredDistance(this.screenLocation.screenPointArray,a)<d*d)return this.screenLocation.renderScreenPointArray[2]+b;break;case "line":var g=this.collisionType.paths,c=this._getWorldToScreenObjectScale();c=this._calculateObjectTransform(c,B);d*=this.screenLocation.pixelSize;
a=F.fromScreen(this._camera,a,G);if(null==a)break;for(var e of g)if(0!==e.length){g=k.transformMat4(v,e[0],c);for(var f=1;f<e.length;f++){var m=k.transformMat4(M,e[f],c),w=t.closestRayDistance2(t.fromPoints(g,m,N),a);if(null!=w&&w<d*d)return c=k.add(z.sv3d.get(),g,m),k.scale(c,c,.5),a=q.castRenderScreenPointArray(z.sv3d.get()),this._camera.projectToRenderScreen(c,a),a[2]+b;k.copy(g,m)}}break;case "disc":g=this.collisionType.direction;c=this.collisionType.offset??n.ZEROS;e=this._getWorldToScreenObjectScale();
f=this._calculateObjectTransform(e,B);e=d*this.screenLocation.pixelSize;a=F.fromScreen(this._camera,a,G);if(null==a)break;d=K.fromMat4(O,f);d=k.transformMat3(P,g,d);c=k.transformMat4(Q,c,f);u.fromPositionAndNormal(c,d,C);d=R;if(u.intersectRay(C,a,d)&&k.squaredDistance(d,c)<e*e)return this.screenLocation.renderScreenPointArray[2]+b;break;case "ribbon":const {paths:la,direction:ma}=this.collisionType;e=this._getWorldToScreenObjectScale();e=this._calculateObjectTransform(e,B);d*=this._camera.computeScreenPixelSizeAt(this.renderLocation);
g=F.fromScreen(this._camera,a,G);if(null==g)break;a=K.fromMat4(O,e);a=k.transformMat3(P,ma,a);f=this._calculateModelTransformPosition(Q);u.fromPositionAndNormal(f,a,C);a=R;if(!u.intersectRay(C,g,a))break;for(c of la)if(0!==c.length)for(g=k.transformMat4(v,c[0],e),f=1;f<c.length;f++){m=k.transformMat4(M,c[f],e);w=t.distance2(t.fromPoints(g,m,N),a);if(null!=w&&w<d*d)return c=k.add(z.sv3d.get(),g,m),k.scale(c,c,.5),a=q.castRenderScreenPointArray(z.sv3d.get()),this._camera.projectToRenderScreen(c,a),
a[2]+b;k.copy(g,m)}break;default:U.neverReached(this.collisionType)}return null};h.attach=function(a={manipulator3D:{}}){const b=this._stage;b&&(a=a.manipulator3D,null==a.engineLayerId?(this._engineLayer=new ha.WebGLLayer(b,{pickable:!1,updatePolicy:fa.UpdatePolicy.SYNC}),a.engineLayerId=this._engineLayer.id):b?.getObject&&(this._engineLayer=b.getObject(a.engineLayerId)),a.engineLayerReferences=(a.engineLayerReferences||0)+1,this._materialIdReferences=a.materialIdReferences,null==this._materialIdReferences&&
(this._materialIdReferences=new Map,a.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),y.canProjectWithoutEngine(this._location.spatialReference,this.view.spatialReference)||(this.location=new A({x:0,y:0,z:0,spatialReference:this.view.spatialReference})))};h.detach=function(a={manipulator3D:{}}){a=a.manipulator3D;a.engineLayerReferences--;const b=0===a.engineLayerReferences;this._removeResourcesFromStage();
b&&(a.engineLayerId=null,W.destroyMaybe(this._engineLayer));this._materialIdReferences=this._engineLayer=this._engineResources=null;this._attached=!1};h.onViewChange=function(){this._camera.copyFrom(this.view.state.camera);this._screenLocationDirty=!0;this._updateEngineObject()};h.onElevationChange=function(a){y.projectPoint(this.location,S,a.spatialReference)&&ba.containsPointObject(a.extent,S)&&this._notifyLocationChanged()};h._evaluateElevationAlignment=function(){if(null!=this.elevationInfo){var a=
null,b=0,d=this.elevationInfo.offset??0;switch(this.elevationInfo.mode){case "on-the-ground":a=E.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0;break;case "relative-to-ground":b=(E.getElevationAtPoint(this.view.elevationProvider,this.location,"ground")??0)+d;break;case "relative-to-scene":b=(E.getElevationAtPoint(this.view.elevationProvider,this.location,"scene")??0)+d;break;case "absolute-height":b=d}if(b!==this._elevation.offset||a!==this._elevation.override)this._elevation.offset=
b,this._elevation.override=a}};h._updateEngineObject=function(){if(this._attached)if(this.available){var a=this._getWorldToScreenObjectScale(),b=B;!0===this.autoScaleRenderObjects?(a*=this._getFocusedSize(this._radius,this.focused),this._calculateObjectTransform(a,b)):this._calculateObjectTransform(a,b);var {objectsByState:d}=this._ensureEngineResources();a=(this.focused?l.ManipulatorStateFlags.Focused:l.ManipulatorStateFlags.Unfocused)|(this.selected?l.ManipulatorStateFlags.Selected:l.ManipulatorStateFlags.Unselected);
var g=0<this._noDisplayCount;for(const {stateMask:c,objects:e}of d)if(g)for(const f of e)f.visible=!1;else if(d=(c&l.ManipulatorStateCustomFlags.All)===l.ManipulatorStateCustomFlags.None||(this.state&c)===(c&l.ManipulatorStateCustomFlags.All),(c&l.ManipulatorStateFlags.All)!==l.ManipulatorStateFlags.None&&(a&c)!==(c&l.ManipulatorStateFlags.All)||!d)for(const f of e)f.visible=!1;else for(const f of e)f.visible=!0,f.transformation=b}else this._removeResourcesFromStage()};h._ensureEngineResources=function(){if(null==
this._engineResources){const a=this._engineLayer,b=[],d=new Set;this.renderObjects.forEach(({geometry:{material:e}})=>{d.has(e)||(b.push(e),d.add(e))});const g=new Map;this._renderObjects.forEach(e=>{const f=new ea.Object3D({castShadow:!1,geometries:[e.geometry]}),m=g.get(e.stateMask)||[];m.push(f);g.set(e.stateMask,m)});const c=[];g.forEach((e,f)=>c.push({stateMask:f,objects:e}));this._engineResources={objectsByState:c,layer:a,materials:b}}this._addResourcesToStage();return this._engineResources};
h._addResourcesToStage=function(){const a=this._stage;if(!this._engineResourcesAddedToStage&&null!=this._engineResources&&a){var {objectsByState:b,layer:d,materials:g}=this._engineResources;g.forEach(c=>{const e=this._materialIdReferences,f=e.get(c.id)||0;0===f&&a.add(c);e.set(c.id,f+1)});b.forEach(({objects:c})=>{d.addMany(c);a.addMany(c)});this._engineResourcesAddedToStage=!0}};h._removeResourcesFromStage=function(){const a=this._stage;if(this._engineResourcesAddedToStage&&null!=this._engineResources&&
a){var {objectsByState:b,layer:d,materials:g}=this._engineResources;b.forEach(({objects:c})=>{d.removeMany(c);a.removeMany(c)});g.forEach(c=>{const e=this._materialIdReferences,f=e.get(c.id);1===f?(a.remove(c),e.delete(c.id)):e.set(c.id,f-1)});this._engineResourcesAddedToStage=!1}};h._getCollisionRadius=function(a){return this._getFocusedSize(this.radius,!0)*("touch"===a?this.touchMultiplier:1)};h._getFocusedSize=function(a,b){return a*(b?this.focusMultiplier:1)};h._getWorldToScreenObjectScale=function(){return this._worldSized?
1:this.screenLocation.pixelSize};h._calculateModelTransformPosition=function(a){var b=this._getWorldToScreenObjectScale();b=this._calculateObjectTransform(b,na);return k.set(a,b[12],b[13],b[14])};h._calculateModelTransformOffset=function(a){const b=this._calculateModelTransformPosition(a);return k.subtract(a,b,this.renderLocation)};h._calculateObjectTransform=function(a,b){r.set(b,a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1);this._worldFrame&&r.multiply(b,b,this._worldFrame);r.multiply(b,b,this._modelTransform);
b[12]+=this.renderLocation[0];b[13]+=this.renderLocation[1];b[14]+=this.renderLocation[2];b[15]=1;null!=this._applyObjectTransform&&this._applyObjectTransform(b);return b};T._createClass(p,[{key:"_stage",get:function(){return this.view?._stage}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(a){this._elevationInfo=a;this._renderLocationDirty=this._elevationAlignedLocationDirty=!0;this._updateEngineObject()}},{key:"renderObjects",get:function(){return this._renderObjects},
set:function(a){this._removeResourcesFromStage();this._engineResources=null;this._renderObjects=a.slice();this._updateEngineObject()}},{key:"available",get:function(){return this._available},set:function(a){a!==this._available&&(this._available=a,this._updateEngineObject())}},{key:"radius",get:function(){return this._radius},set:function(a){a!==this._radius&&(this._radius=a,this._updateEngineObject())}},{key:"worldSized",get:function(){return this._worldSized},set:function(a){a!==this._worldSized&&
(this._worldSized=a,this._updateEngineObject())}},{key:"modelTransform",get:function(){return this._modelTransform},set:function(a){L(a)&&(this._screenLocationDirty=!0);r.copy(this._modelTransform,a);this._updateEngineObject()}},{key:"renderLocation",get:function(){if(this._renderLocationDirty)if(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented){this._worldFrame||(this._worldFrame=x.create());a:{var a=this.view,
b=this._renderLocation,d=this._worldFrame;switch(a.viewingMode){case "local":r.identity(d);break a;case "global":a=aa.getReferenceEllipsoid(a.renderCoordsHelper.spatialReference),y.sphericalPCPFtoLonLatElevation(b,0,v,0,a.radius),y.computeENUToSphericalPCPFLocalRotation(J.deg2rad(v[0]),J.deg2rad(v[1]),d)}}}else this._worldFrame&&(this._worldFrame=null);return this._renderLocation},set:function(a){this.view.renderCoordsHelper.fromRenderCoords(a,this._location);this.elevationAlignedLocation=this._location}},
{key:"location",get:function(){return this._location},set:function(a){D.clonePoint(a,this._location);this._notifyLocationChanged()}},{key:"elevationAlignedLocation",get:function(){if(!this._elevationAlignedLocationDirty)return this._elevationAlignedLocation;this._evaluateElevationAlignment();this._updateElevationAlignedLocation();return this._elevationAlignedLocation},set:function(a){D.clonePoint(a,this._location);this._evaluateElevationAlignment();this._location.z-=this._elevation.offset;this._updateElevationAlignedLocation();
this._updateEngineObject();this.events.emit("location-update",{location:this._location})}},{key:"grabbing",get:function(){return this._grabbing},set:function(a){a!==this._grabbing&&(this._grabbing=a,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"hovering",get:function(){return this._hovering},set:function(a){a!==this._hovering&&(this._hovering=a,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"selected",get:function(){return this._selected},
set:function(a){a!==this._selected&&(this._selected=a,this._updateEngineObject(),this.events.emit("select-changed",{action:a?"select":"deselect"}))}},{key:"state",get:function(){return this._state},set:function(a){a!==this._state&&(this._state=a,this._updateEngineObject())}},{key:"focused",get:function(){return this._focused}},{key:"screenLocation",get:function(){this._ensureScreenLocation();return this._screenLocation}},{key:"applyObjectTransform",get:function(){return this._applyObjectTransform},
set:function(a){this._applyObjectTransform=a;this._screenLocationDirty=!0;this._updateEngineObject()}},{key:"attached",get:function(){return this._attached}},{key:"test",get:function(){let a=!1;if(null!=this._engineResources)for(const b in this._engineResources.objectsByState){const d=this._engineResources.objectsByState[b];for(const g of d.objects)if(g.visible){a=!0;break}if(a)break}return{areAnyResourcesVisible:a}}}]);return p}();const ka=q.createScreenPointArray(),N=t.create(),G=ca.create(),O=
Y.create(),na=x.create(),B=x.create(),C=u.create(),v=n.create(),M=n.create(),R=n.create(),P=n.create(),Q=n.create(),ja=n.create(),S=new A({x:0,y:0,z:0,spatialReference:null}),ia=()=>{};H.Manipulator3D=I;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../geometry ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/memoize ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/WatchUpdatingTracking ../../../../../layers/graphics/hydratedFeatures ../../../analysis/support/measurementUtils ../../SnappingVisualizer3D ../../editingTools/dragEventPipeline3D ./DirectLineMeasurement3DView ../../../support/ElevationProvider ../../../../interactive/AnalysisToolBase ../../../../interactive/coordinateHelper ../../../../interactive/dragEventPipeline ../../../../interactive/editGeometry/EditGeometry ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/snapping/SceneSnappingManagerPool ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/snapping/snappingUtils ../../../../support/screenUtils ../../../../../geometry/Point".split(" "),
function(D,d,c,K,y,L,E,e,ia,ja,ka,M,N,O,P,Q,z,R,S,T,U,F,V,W,X,Y,Z,aa,G,ba){function A(q,r,f){q.events.emit("drag",{action:"start",pointerType:r,start:f,screenPoint:f});return{update:a=>q.events.emit("drag",{action:"update",start:a,screenPoint:a}),end:a=>q.events.emit("drag",{action:"end",start:a,screenPoint:a}),cancel:()=>q.events.emit("drag",{action:"cancel"})}}c=function(q){function r(a){var b=q.call(this,a)||this;b._handles=new K;b._updatingHandles=new N.WatchUpdatingTracking;b._emulatedDrag=null;
b.lineState="initial";b.startPointSurfaceLocation=null;b.endPointSurfaceLocation=null;b.cursorPointSurfaceLocation=null;b.startManipulator=null;b.endManipulator=null;b.cursorManipulator=null;b._getSnappingContext=L.memoize(l=>new Y.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:l,editGeometryOperations:new W.EditGeometryOperations(new V.EditGeometry("point",U.createCoordinateHelper(!0,!1,b.view.spatialReference))),visualizer:new Q.SnappingVisualizer3D}));return b}D._inherits(r,
q);var f=r.prototype;f.initialize=function(){const {view:a,analysis:b,analysisViewData:l,visible:t}=this;this.measurementView=new R.DirectLineMeasurement3DView({toolState:this,view:a,analysis:b,analysisViewData:l,visible:t});var h=X.acquire(a);this._snappingManagerResult=h;this._handles.add(h);const {start:m,end:k,cursor:n}=this.measurementView.createManipulators();h=(u,v,B)=>F.createManipulatorDragEventPipeline(u,(C,w,x,H)=>{const I=z.hideManipulatorWhileDragging(C),ca=this._snappingManager,da=this._getSnappingContext(H),
ea=this._updatingHandles,{lineState:fa}=this;x=x.next(I).next(F.resetProperties(this,[B,v])).next(g=>{if("cursorPoint"!==v){const p=this.analysis[v];null!=p&&(C.location=p)}return g});const ha=z.screenToMap3D(this.view);w=w.next(I).next(g=>{g=ha(g);g||"drawing"!==this.lineState&&"initial"!==this.lineState||(this[v]=null,this[B]=null);return g});if("touch"!==H||"editing"===fa){const {snappingStep:g,cancelSnapping:p}=Z.createSnapDragEventPipelineStep({snappingManager:ca,snappingContext:da,updatingHandles:ea});
x=x.next(p);w=w.next(...g)}w.next(g=>"start"!==g.action?g:null).next(g=>{const p=O.clonePoint(g.mapEnd,new ba);this[v]=p;C.location=p;this[B]=this._surfaceLocation(p,g.surfaceType)})});const J=u=>u.events.on("grab-changed",()=>{this.lineState=m.grabbing||k.grabbing?"editing":"measured"});this._handles.add([h(m,"startPoint","startPointSurfaceLocation"),h(k,"endPoint","endPointSurfaceLocation"),h(n,"cursorPoint","cursorPointSurfaceLocation"),J(m),J(k)]);this.manipulators.add(m);this.manipulators.add(k);
this.manipulators.add(n);this.startManipulator=m;this.endManipulator=k;this.cursorManipulator=n;this._handles.add(E.watch(()=>this.state,u=>{"measured"===u&&this.finishToolCreation()},E.syncAndInitial));aa.setupSnappingToggleHandles(this)};f.destroy=function(){this._handles=y.destroyMaybe(this._handles);this._updatingHandles=y.destroyMaybe(this._updatingHandles);this.measurementView=y.destroyMaybe(this.measurementView)};f.onShow=function(){this.measurementView.show();this._updateManipulatorAvailability()};
f.onHide=function(){this.measurementView.hide()};f.onDeactivate=function(){this._emulatedDrag?.cancel();this._emulatedDrag=null};f.onInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a)}this._updateManipulatorAvailability()};f._handlePointerMove=function(a){if(this.active&&!this.view.navigating){var {pointerType:b}=a;if("mouse"===b){var l=G.createScreenPointFromEvent(a),{lineState:t,cursorManipulator:h,endManipulator:m}=
this,k=!1;null==this.cursorPoint&&(this._emulatedDrag?.cancel(),this._emulatedDrag=A(h,b,l),k=!0);"initial"===t&&(this._emulatedDrag?.update(l),k=!0);"drawing"===t&&(m.events.emit("drag",{action:"update",start:l,screenPoint:l}),k=!0);k&&a.stopPropagation()}}};f._handleImmediateClick=function(a){if(this.active&&P.isPrimaryPointerAction(a)){var b=G.createScreenPointFromEvent(a),{pointerType:l}=a,{cursorManipulator:t,startManipulator:h,endManipulator:m,lineState:k}=this,n=!1;null==this.cursorPoint&&
(this._emulatedDrag?.cancel(),this._emulatedDrag=A(t,l,b));switch(k){case "initial":this._emulatedDrag?.update(b);null!=this.cursorPoint&&(this._emulatedDrag?.end(b),this._emulatedDrag=null,{cursorPoint:n}=this,this.startPoint=n,this.startPointSurfaceLocation=this.cursorPointSurfaceLocation,h.location=n,h.interactive=!1,m.interactive=!1,this.lineState="drawing",this._emulatedDrag=A(m,l,b),n=!0);break;case "drawing":this._emulatedDrag?.update(b),null!=this.endPoint&&(this._emulatedDrag?.end(b),this._emulatedDrag=
null,h.interactive=!0,m.interactive=!0,this.lineState="measured",n=!0)}n&&a.stopPropagation()}};f._surfaceLocation=function(a,b){return b===z.SurfaceType.GROUND?"on-the-surface":(a.z??0)>=this._getElevation(a)?"above-the-surface":"below-the-surface"};f._updateManipulatorAvailability=function(){this.startManipulator.available=null!=this.analysis.startPoint;this.endManipulator.available=null!=this.analysis.endPoint};f._getElevation=function(a){return this.view.basemapTerrain.ready?S.getElevationAtPoint(this.view.elevationProvider,
a)??0:0};D._createClass(r,[{key:"_snappingManager",get:function(){return this._snappingManagerResult.snappingManager}},{key:"state",get:function(){var {analysis:a}=this;if(null==a.startPoint&&null==a.endPoint)return"ready";({lineState:a}=this);return this.validMeasurement&&"editing"!==a&&"drawing"!==a?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}},{key:"startPoint",get:function(){return this.analysis.startPoint},set:function(a){this.analysis.startPoint=
a}},{key:"endPoint",get:function(){return this.analysis.endPoint},set:function(a){this.analysis.endPoint=a}},{key:"cursorPoint",get:function(){return this.measurementView.cursorPoint},set:function(a){this.measurementView.cursorPoint=a}},{key:"snappingOptions",get:function(){return this._snappingManager.options}},{key:"validMeasurement",get:function(){return null!=this.analysis.startPoint&&null!=this.analysis.endPoint}},{key:"updating",get:function(){return this._updatingHandles.updating||this._snappingManager.updating}},
{key:"test",get:function(){return{snappingManager:this._snappingManager}}}]);return r}(T.AnalysisToolBase);d.__decorate([e.property({readOnly:!0})],c.prototype,"state",null);d.__decorate([e.property()],c.prototype,"lineState",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"cursor",null);d.__decorate([e.property()],c.prototype,"startPoint",null);d.__decorate([e.property()],c.prototype,"endPoint",null);d.__decorate([e.property()],c.prototype,"cursorPoint",null);d.__decorate([e.property({constructOnly:!0})],
c.prototype,"analysis",void 0);d.__decorate([e.property({constructOnly:!0})],c.prototype,"analysisViewData",void 0);d.__decorate([e.property()],c.prototype,"measurementView",void 0);d.__decorate([e.property({constructOnly:!0})],c.prototype,"view",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"validMeasurement",null);d.__decorate([e.property({value:null})],c.prototype,"startPointSurfaceLocation",void 0);d.__decorate([e.property({value:null})],c.prototype,"endPointSurfaceLocation",void 0);
d.__decorate([e.property({value:null})],c.prototype,"cursorPointSurfaceLocation",void 0);d.__decorate([e.property()],c.prototype,"updating",null);return c=d.__decorate([M.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],c)});
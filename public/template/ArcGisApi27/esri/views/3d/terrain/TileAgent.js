// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ./interfaces ./TerrainConst ./terrainUtils ./tileUtils".split(" "),function(q,r,u,B,C,D){let z=function(){function h(){}var b=h.prototype;b.init=function(a,e,f,c){this.tile=a;this._layerIdx=e;this._layerClass=f;this._suspended=c;this._tileLayerInfo=a.getLayerInfo(e,f);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.startLoading=function(){return this._requestNext()};b.dispose=function(){this._tileRequested&&
(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null);this._tileLayerInfo=this.tile=null};b.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())};b.update=function(){const a=this._findAncestorWithData();this._setUpsampleTile(a);return this._requestNext()};b.dataArrived=
function(a,e){this._setUpsampleTile(a,e);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING,e):this._requestNext()};b.dataMissing=function(){this._tileRequested=null;this._tileLayerInfo.data=null;this._requestNext()};b._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b._requestNext=function(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;
this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}null!=a?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested};b._findNextDownload=function(){const a=this._layerIdx,e=this._layerClass;var f=this.tile.surface.layerViewByIndex(a,e),c=C.getLayerWithExtentRange(f);const {minLevel:v,maxLevel:E}=f.dataLevelRange,k=this._desiredMinLevelDelta,F=this._progressiveLevelModulo+k,G=this._scaleRangeEnabled?
D.fallsWithinLayer:()=>!0;let d=this.tile;const l=d.level;let g;const m=this._tileLayerInfo.upsampleInfo,w=null!=m?m.tile.level:-1,H=null!=m?w-l>=k:!1,I=c?.tilemapCache;for(f="vector-tile-3d"===f.type?f.schemaHelper:null;d&&G(d,c,!1)&&d.level>=v;){const n=d.level,x=l-n,p=d.layerInfo[e][a];if(p.data&&x>=k){(!H||n>w)&&this._setUpsampleTile(d);p.dataInvalidated&&(g=d);break}const y=f?.getLevelRowColumn(d.lij)??d.lij;if("unavailable"!==I?.getAvailability(y[0],y[1],d.lij[2])&&n<=E&&!p.data&&!p.dataMissing){if(!g||
d.level===v||0===n%B.PROGRESSIVE_LOADING_MODULO||l-g.level<k)g=d;if(x>=F)break}d=d.parent}null!=g&&l-g.level<k&&(m?g=null:(c=this._findAncestorWithData(),null!=c&&(this._setUpsampleTile(c),g=c.layerInfo[e][a].dataInvalidated?c:null)));return g};b._findAncestorWithData=function(){const a=this.tile.elevationLevel,e=this._desiredMinLevelDelta;let f;for(let c=this.tile;c;c=c.parent)if(c.hasLayerData(this._layerIdx,this._layerClass)){if(a-c.level>=e)return c;f=c}return f};b._setUpsampleTile=function(a,
e){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING,e)};r._createClass(h,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"test",get:function(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}]);return h}();var t=function(h){function b(){return h.apply(this,arguments)||this}r._inherits(b,h);b.prototype.dispose=function(){};r._createClass(b,[{key:"_desiredMinLevelDelta",get:function(){throw A;
}},{key:"_progressiveLevelModulo",get:function(){throw A;}}]);return b}(z);const A=Error("Abstract method called on TileAgent");t=new t;q.TILE_AGENT_DONE=t;q.TileAgent=z;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});
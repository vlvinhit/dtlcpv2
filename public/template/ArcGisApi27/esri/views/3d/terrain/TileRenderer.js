// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../layers/support/layerUtils ../support/StreamDataLoader ./BlendLayersTechnique ./interfaces ./ITile ./LayerClass ./terrainUtils ./TextureFader ./TextureReference ./TileCompositor ./TileRenderInfo ./TileTexture ./TileUpdate ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor".split(" "),
function(M,T,N,U,V,D,ja,ka,W,u,E,v,O,P,la,ma,F,I,X,q,Y,J,G,na){function Q(f,e){l.layerIndex=e;l.vtlNeighborInfos.clear();const a=f.layerInfo[E.LayerClass.MAP][e];if(a.data)return U.set(l.offset,0,0),l.tile=f,l.scale=1,l.sourceLod=f.lij,l.sourceLayerInfo=a,v.isVectorTileRenderInfo(l)&&f.forEachLoadedNeighbor((b,h)=>{if(b.level===f.level){var k=b.layerInfo[E.LayerClass.MAP][e];if(v.isVectorTilePerLayerInfo(k)&&a.data!==k.data){var w=l.vtlNeighborInfos.pushNew();w.offset=r[h];w.sourceLod=b.lij;w.sourceLayerInfo=
k}}}),l;const c=a.upsampleInfo;if(c){const b=c.tile.layerInfo[E.LayerClass.MAP][e];l.tile=c.tile;U.copy(l.offset,c.offset);l.scale=c.scale;l.sourceLod=c.tile.lij;l.sourceLayerInfo=b;return l}return null}function Z(f){let e="normal"!==f.blendMode;D.isGroupLayer(f.parent)&&(e=Z(f.parent)||e);return e}function aa(f,e){D.isGroupLayer(f.parent)&&aa(f.parent,e);const a=f.get("uid");if(null!=a&&""!==a){const c=K.get(a);c?c.start=e:K.set(a,new ba(e,e,f.blendMode,f.opacity))}}let ba=T._createClass(function(f,
e,a,c){this.start=f;this.end=e;this.blendMode=a;this.opacity=c}),oa=function(){function f(a,c,b){this._rctx=a;this.tileSize=c;this._techniqueRepository=b;this._passParameters=new ka.BlendLayersPassParameters;this._backgroundColor=this._backgroundTexture=null;this._backgroundDirty=!1;this._blackTex=null;this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy;this._composition=new la.TileCompositor(this._rctx,this._techniqueRepository);this._blackTex=new F(Y.createColorTexture(this._rctx,[0,0,0,
1]));this._ensureBackgroundTexture(this.tileSize)}var e=f.prototype;e.dispose=function(){this._composition=N.disposeMaybe(this._composition);this._backgroundTexture=N.releaseMaybe(this._backgroundTexture);this._blackTex=N.releaseMaybe(this._blackTex)};e.updateTileTexture=function(a,c){if(a.renderData){var b=a.surface,h=b.baseOpacity,k=0,w=0,n=this.tileSize,H=!1,L=b.view.state.contentPixelRatio,B=!1;K.clear();C.length=0;for(var t=a.layerInfo[E.LayerClass.MAP],x=t.length,g=0,y=null;g<t.length;g++){const d=
b.layerViewByIndex(g,E.LayerClass.MAP);var z=d.layer.opacity;ca[g]=z;const A=d.fullOpacity;da[g]=A;D.isBaseLayer(d.layer)&&x>=t.length&&(x=g);if(v.isBlendableLayerView(d)){ea[g]=d.layer.blendMode;var p="normal"!==d.layer.blendMode;if(D.isGroupLayer(d.layer.parent)){const m=d.layer.parent.get("uid");null!=m&&""!==m&&(p=Z(d.layer.parent)||p)}p&&(B=p,H=!1)}if(0!==z||B){if(++w,z=Q(a,g))t[g].pendingUpdates&=~(I.TileUpdate.TEXTURE_NOFADING&I.TileUpdate.TEXTURE_FADING),D.isGroupLayer(d.layer.parent)&&(p=
d.layer.parent.get("uid"),null!=p&&""!==p&&aa(d.layer.parent,g)),v.isVectorTileLayerView(d)?n=Math.max(n,this.tileSize*L):1===h&&1===A&&(d.isOpaque||this._dataToTexture(z)&&z.sourceLayerInfo.data.descriptor.isOpaque)&&(H=!0),++k,null===y&&(y=g)}else t[g].pendingUpdates&=~(I.TileUpdate.TEXTURE_NOFADING&I.TileUpdate.TEXTURE_FADING)}b=n/this.tileSize;this._ensureBackgroundTexture(this.tileSize);0===k||null===y?this._useBackgroundTexture(a,w):(1!==k||B||!this._useLayerTexture(a,y,x,da[y]))&&this._composeMapLayers(a,
c,g-1,x,ca,ea,n,b,!H||B,K,B)}};e._ensureBackgroundTexture=function(a){null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(a),this._backgroundDirty=!0);this._backgroundDirty&&(this._composition.bind(a),this._passParameters.offset=V.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=1,null!=this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),
this._composition.unbind(),this._backgroundDirty=!1)};e._useBackgroundTexture=function(a,c){let b=O.ActivationTime.Immediate;if(a.surface.view.layerViewManager.updating||0<c)b=O.ActivationTime.Delayed;c=a.renderData;this._backgroundTexture&&null==c.textureReference&&(b=O.ActivationTime.Immediate);c.setTextureReference(null!=this._backgroundTexture?new P.TextureReference(this._backgroundTexture,W.TextureUpdate.FADING,fa,a.surface.baseOpacity,0,1):null,b)};e._useLayerTexture=function(a,c,b,h){var k=
c<b;b=k?1:a.surface.baseOpacity;k=k?a.surface.baseOpacity:1;c=Q(a,c);return this._dataToTexture(c)?(a.renderData.setTextureReference(new P.TextureReference(c.sourceLayerInfo.data,W.TextureUpdate.FADING,c,b,k,h)),!0):!1};e._composeMapLayers=function(a,c,b,h,k,w,n,H,L,B,t){this._composition.ensureBuffer(n);const x=a.surface.baseOpacity;let g=!1,y=J.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,z=!1,p=0;for(let m=b;0<=m;m--){var d=Q(a,m);if(!d)continue;if(0===k[m]&&!t)continue;var A=m<h&&1>x&&!g;this._passParameters.baseOpacity=
A?x:1;b=1>this._passParameters.baseOpacity?q.BaseOpacityMode.Required:q.BaseOpacityMode.NotRequired;A&&(g=!0);let ha=!1;B.forEach(ia=>{ia.start===m&&(C.push(ia),this._composition.openGroup(n),ha=!0)});A=0===p;const R=ha?q.BlendLayersOutput.GroupBackgroundComposite:L&&A?this.backgroundIsGrid?q.BlendLayersOutput.GridComposite:q.BlendLayersOutput.ColorComposite:q.BlendLayersOutput.Composite,S=X.blendModeFromString[w[m]];v.isVectorTileRenderInfo(d)?(this._passParameters.opacity=k[m],z=this._composition.drawVectorData(this._passParameters,
R,n,S,b,d,H,this.tileSize,z)):v.isImageryTileRenderInfo(d)?(this._passParameters.opacity=k[m],this._composition.drawImageryTileData(this._passParameters,R,n,S,b,d),this._hasNearestInterpolation(d)&&(y=J.TextureSamplingMode.NEAREST)):this._dataToTexture(d)&&(this._passParameters.texture=d.sourceLayerInfo.data.texture,this._passParameters.offset=d.offset,this._passParameters.scale=d.scale,this._passParameters.opacity=k[m],this._composition.drawRasterData(this._passParameters,R,n,S,b));for(;0<C.length&&
C[C.length-1].end===m;)d=C.pop(),this._passParameters.opacity=d.opacity,this._passParameters.offset=V.ZEROS,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,L&&A?this.backgroundIsGrid?q.BlendLayersOutput.GridComposite:q.BlendLayersOutput.ColorComposite:q.BlendLayersOutput.Composite,n,X.blendModeFromString[d.blendMode],b);p++}a=a.renderData;h=a.ensureTexture(n,()=>this._buildTexture(n,y));this._composition.copyFBOToTexture(h);this._composition.unbind();a.setTextureReference(new P.TextureReference(h,
c,fa,g?1:x,0,1))};e._hasNearestInterpolation=function(a){a=a.sourceLayerInfo.data;return a.source?"nearest"===a.interpolation:!1};e._dataToTexture=function(a){if(v.isRasterTileRenderInfo(a)){const c=a.sourceLayerInfo;c.data=this._buildTexture(c.data);a.tile.setMemoryDirty()}return v.isTextureTileRenderInfo(a)};e.setBackground=function(a){this._backgroundColor!==a&&(this._backgroundColor=a,this._backgroundDirty=!0)};e._buildTexture=function(a,c=J.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(null==
a)return null;const b=new na.TextureDescriptor;b.wrapMode=J.TextureWrapMode.CLAMP_TO_EDGE;b.samplingMode=c;b.maxAnisotropy=this._maxAnisotropy;b.preMultiplyAlpha=!0;b.flipped=!0;b.hasMipmap=!0;c=this._rctx;let h;if("number"===typeof a)b.width=b.height=a,h=new F(new G.Texture(c,b));else if(a instanceof ja.ImageWithType)b.isOpaque=a.isOpaque,h=new F(new G.Texture(c,b,a.image)),a.release();else try{b.width=a.width,b.height=a.height,h=new F(new G.Texture(c,b,a))}catch(k){h=new F(Y.createEmptyTexture(c)),
console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}a=c.bindTexture(h.texture,G.Texture.TEXTURE_UNIT_FOR_UPDATES);h.generateMipmap();c.bindTexture(a,G.Texture.TEXTURE_UNIT_FOR_UPDATES);return h};T._createClass(f,[{key:"backgroundIsGrid",get:function(){return null==this._backgroundColor}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);return f}();const ca=
[],da=[],ea=[],K=new Map,C=[],l=new ma.TileRenderInfo,fa={offset:[0,0],scale:1},r=[];r[u.NeighborIndex.NORTH]=[0,-1];r[u.NeighborIndex.NORTH_EAST]=[-1,-1];r[u.NeighborIndex.EAST]=[-1,0];r[u.NeighborIndex.SOUTH_EAST]=[-1,1];r[u.NeighborIndex.SOUTH]=[0,1];r[u.NeighborIndex.SOUTH_WEST]=[1,1];r[u.NeighborIndex.WEST]=[1,0];r[u.NeighborIndex.NORTH_WEST]=[1,-1];M.GroupInfo=ba;M.TileRenderer=oa;Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/reactiveUtils ../../../core/SetUtils ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../ViewingMode ../layers/interfaces ../support/debugFlags ./interfaces ./Overlay ./OverlayFramebufferObject ./OverlayRenderTarget ../webgl-engine/core/shaderLibrary/ShaderOutput ../../../chunks/TextureOnly.glsl ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRepository ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/Material ../webgl-engine/lib/RenderContext ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/ShadowMap ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/SSAOHelper ../webgl-engine/lib/TextureTechnique ../webgl-engine/lib/TextureTechniqueConfiguration ../webgl-engine/lib/TransparencyPassType ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lighting/Lightsources ../../support/Scheduler ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor ../../webgl/Util".split(" "),
function(g,B,l,O,P,Q,w,m,R,q,C,S,n,va,wa,xa,T,H,U,V,W,r,I,p,D,X,Y,y,Z,aa,ba,ca,J,da,ea,fa,E,ha,ia,ja,ka,la,ma,na,oa,K,z,pa,qa,ra){g.OverlayRenderer=function(A){function t(a){a=A.call(this,a)||this;a._overlays=null;a._overlayRenderTarget=null;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._handles=new Q;a._renderers=new Map;a._sortedDrapeSourceRenderersDirty=!1;a._sortedRenderers=new R;a._passParameters=new Z.TextureOnlyPassParameters;a._materialRepository=null;a._screenToWorldRatio=1;
a._localOriginFactory=null;a._camera=new ba.Camera;a.worldToPCSRatio=1;a.events=new P;a.longitudeCyclical=null;return a}B._inherits(t,A);var d=t.prototype;d.initialize=function(){const a=this.view._stage.renderView,{waterTextureRepository:b,stippleTextureRepository:c,markerTextureRepository:e}=a;this._shaderTechniqueRepository=new aa.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:W.ViewingMode.Local,stippleTextureRepository:c,markerTextureRepository:e,waterTextureRepository:b});this._renderContext=
new fa.OverlayRenderContext(this._rctx,new ha.ShadowMap(this._rctx,this.view.state.viewingMode),new ja.SSAOHelper(this.view,this._shaderTechniqueRepository,this._rctx,()=>{}));this._handles.add([q.watch(()=>b.updating,()=>this.events.emit("content-changed"),q.syncAndInitial),q.watch(()=>this.spatialReference,f=>this._localOriginFactory=new da.GridLocalOriginFactory(f),q.syncAndInitial),q.on(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]);this._materialRepository=
new ca.GLMaterialRepository(a.textureRepository,this._shaderTechniqueRepository,f=>{0<(f.renderOccluded&F)!==this._rendersOccluded&&this._updateRendersOccluded();this.events.emit("content-changed");this.notifyChange("updating");this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._bindParameters.slot=E.RenderSlot.DRAPED_MATERIAL;this._bindParameters.highlightDepthTexture=J.createEmptyDepthTexture(this._rctx);this._camera.near=1;this._camera.far=1E4;this._camera.relativeElevation=
null;this._bindParameters.camera=this._camera;this._bindParameters.transparencyPassType=ma.TransparencyPassType.NONE;this._bindParameters.newLighting.noonFactor=0;this._bindParameters.newLighting.globalFactor=0;this._bindParameters.newLighting.set([new oa.AmbientLight(V.fromValues(1,1,1))]);this._handles.add(this.view.resourceController.scheduler.registerTask(K.TaskPriority.STAGE,this))};d.destroy=function(){this._handles.destroy();this._renderers.forEach(a=>a.destroy());this._renderers.clear();this._debugTextureTechnique=
m.releaseMaybe(this._debugTextureTechnique);this._passParameters.texture=m.disposeMaybe(this._passParameters.texture);this._bindParameters.highlightDepthTexture=m.disposeMaybe(this._bindParameters.highlightDepthTexture);this._shaderTechniqueRepository=m.destroyMaybe(this._shaderTechniqueRepository);this._temporaryFBO=m.disposeMaybe(this._temporaryFBO);this._quadVAO=m.disposeMaybe(this._quadVAO);this.disposeOverlays()};d.createGeometryDrapeSourceRenderer=function(a){return this.createDrapeSourceRenderer(a,
ia.SortedRenderGeometryRenderer)};d.createDrapeSourceRenderer=function(a,b,c){const e=this._renderers.get(a);null!=e&&e.destroy();b=new b({...c,rendererContext:this,drapeSource:a});this._renderers.set(a,b);this._sortedDrapeSourceRenderersDirty=!0;"fullOpacity"in a&&this._handles.add(q.watch(()=>a.fullOpacity,()=>this.events.emit("content-changed")),a);return b};d.removeDrapeSourceRenderer=function(a){if(null!=a){var b=this._renderers.get(a);null!=b&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(a),
this._handles.remove(a),b.destroy())}};d.collectUnusedRenderTargetMemory=function(){let a=!1;const b=S.now();if(null!=this._overlayRenderTarget)for(const c of this._overlayRenderTarget.renderTargets)a=this._overlayRenderTarget.validateUsageForTarget(this.overlays[p.OverlayIndex.INNER].validTargets[c.type],c,b)||a;return a};d.ensureDrapeTargets=function(a){null!=this._overlays&&this._overlays.forEach(b=>b.hasTargetWithoutRasterImage=C.someSet(a,c=>c.drapeTargetType===r.DrapeTargetType.WithoutRasterImage))};
d.ensureDrapeSources=function(a){null!=this._overlays&&this._overlays.forEach(b=>{b.hasDrapedFeatureSource=C.someSet(a,c=>c.drapeSourceType===r.DrapeSourceType.Features);b.hasDrapedRasterSource=C.someSet(a,c=>c.drapeSourceType===r.DrapeSourceType.RasterImage)})};d.ensureOverlays=function(a,b){null==this._overlays&&(this._overlayRenderTarget=new Y.OverlayRenderTarget(this._rctx),this._overlays=[new D.Overlay(p.OverlayIndex.INNER,this._overlayRenderTarget),new D.Overlay(p.OverlayIndex.OUTER,this._overlayRenderTarget)]);
this.ensureDrapeTargets(a);this.ensureDrapeSources(b)};d.disposeOverlays=function(){this._overlays=null;this._overlayRenderTarget=m.disposeMaybe(this._overlayRenderTarget);this.events.emit("textures-disposed")};d.runTask=function(a){this._processDrapeSources(a,()=>!0)};d._processDrapeSources=function(a,b){let c=!1;for(const [e,f]of this._renderers){if(a.done)break;(e.destroyed||b(e))&&f.commitChanges()&&(c=!0,a.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=
!1,c=!0,this._updateSortedDrapeSourceRenderers());c&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())};d.processSyncDrapeSources=function(){this._processDrapeSources(K.noBudget,a=>a.updatePolicy===na.UpdatePolicy.SYNC)};d.updateAnimation=function(a){let b=!1;this._renderers.forEach(c=>b=c.updateAnimation(a)||
b);return b};d.updateDrapeSourceOrder=function(){this._sortedDrapeSourceRenderersDirty=!0};d.drawTarget=function(a,b,c){const e=a.canvasGeometries;if(0===e.numViews)return!1;const {alignPixelEnabled:f,contentPixelRatio:k}=c;this._screenToWorldRatio=k*a.mapUnitsPerPixel/D.OverlayStretch;const h=b.output;if(this.isEmpty||h===y.ShaderOutput.Highlight&&!this.hasHighlights||h===y.ShaderOutput.Normal&&!this.hasWater||!a.hasSomeSizedView())return!1;const x=b.fbo;if(!x.isValid())return!1;const L=2*a.resolution,
M=a.resolution;x.resize(L,M);const u=this._rctx;this._camera.pixelRatio=a.pixelRatio*k;this._renderContext.output=h;this._bindParameters.alignPixelEnabled=f;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio;this._bindParameters.slot=h===y.ShaderOutput.Normal?E.RenderSlot.DRAPED_WATER:E.RenderSlot.DRAPED_MATERIAL;a.applyViewport(this._rctx);x.bind(u);a.index===p.OverlayIndex.INNER&&(u.setClearColor(0,
0,0,0),u.clearSafe(z.ClearBufferBit.COLOR_BUFFER_BIT));b.type===p.RenderTargetType.Occluded&&(this._renderContext.renderOccludedMask=F);if(I.OVERLAY_DRAW_DEBUG_TEXTURE&&b.type!==p.RenderTargetType.Occluded)for(c=0;c<e.numViews;c++)this._setViewParameters(e.extents[c],a),this._drawDebugTexture(a.resolution,sa[a.index]);0<this._renderers.size&&this._sortedRenderers.forAll(({drapeSource:v,renderer:ta})=>{if(b.type!==p.RenderTargetType.ColorNoRasterImage||v.drapeSourceType!==r.DrapeSourceType.RasterImage){({fullOpacity:v}=
v);var N=null!=v&&1>v&&h===y.ShaderOutput.Color;N&&(this.bindTemporaryFramebuffer(this._rctx,L,M),u.clearSafe(z.ClearBufferBit.COLOR_BUFFER_BIT));for(let G=0;G<e.numViews;G++)this._setViewParameters(e.extents[G],a),ta.render(this._renderContext);N&&null!=this._temporaryFBO&&(x.bind(u),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),v,a.index))}});u.bindFramebuffer(null);x.generateMipMap();this._renderContext.resetRenderOccludedMask();
return!0};d.bindTemporaryFramebuffer=function(a,b,c){null==this._temporaryFBO&&(this._temporaryFBO=new X.OverlayFramebufferObject(a,!1));this._temporaryFBO.resize(b,c);this._temporaryFBO.bind(a)};d.reloadShaders=async function(){await this._shaderTechniqueRepository.reloadAll()};d.notifyContentChanged=function(){this.events.emit("content-changed")};d.intersect=function(a,b,c,e){let f=0;for(const k of this._renderers.values())f=k.intersect?.(a,b,c,e,f)??f};d._updateSortedDrapeSourceRenderers=function(){this._sortedRenderers.clear();
if(0!==this._renderers.size){var a=this.view.map.allLayers;this._renderers.forEach((b,c)=>{const e=a.indexOf(c.layer),f=0<=e;this._sortedRenderers.push(new ua(c,b,this._renderers.size*(c.renderGroup??(f?r.DrapedRenderGroup.MapLayer:r.DrapedRenderGroup.ViewLayer))+(f?e:0)))});this._sortedRenderers.sort((b,c)=>b.index-c.index)}};d._setViewParameters=function(a,b){const c=this._camera;c.viewport=[0,0,b.resolution,b.resolution];H.ortho(c.projectionMatrix,0,a[2]-a[0],0,a[3]-a[1],c.near,c.far);H.fromTranslation(c.viewMatrix,
[-a[0],-a[1],0])};d._updateHasWater=function(){const a=w.someMap(this._renderers,b=>b.hasWater);a!==this._hasWater&&(this._hasWater=a,this.events.emit("has-water",a))};d._updateHasHighlights=function(){const a=w.someMap(this._renderers,b=>b.hasHighlights);a!==this._hasHighlights&&(this._hasHighlights=a,this.events.emit("has-highlights",a))};d._updateRendersOccluded=function(){const a=w.someMap(this._renderers,b=>b.rendersOccluded);a!==this._rendersOccluded&&(this._rendersOccluded=a,this.events.emit("renders-occluded",
a))};d._drawDebugTexture=function(a,b){this._ensureDebugPatternResources(a,b);a=this._rctx;a.bindTechnique(this._debugTextureTechnique,this._passParameters,null);a.bindVAO(this._quadVAO);a.drawArrays(z.PrimitiveType.TRIANGLE_STRIP,0,ra.vertexCount(this._quadVAO,"geometry"))};d._ensureDebugPatternResources=function(a,b){U.set(this._passParameters.color,b[0],b[1],b[2]);if(!this._passParameters.texture){b=new Uint8Array(a*a*4);var c=0;for(let e=0;e<a;e++)for(let f=0;f<a;f++){const k=Math.floor(f/10),
h=Math.floor(e/10);2>k||2>h||10*k>a-20||10*h>a-20?(b[c++]=255,b[c++]=255,b[c++]=255,b[c++]=255):(b[c++]=255,b[c++]=255,b[c++]=255,k&1&&h&1?b[c++]=f&1^e&1?0:255:b[c++]=k&1^h&1?0:128)}a=new qa.TextureDescriptor(a);a.samplingMode=z.TextureSamplingMode.NEAREST;this._passParameters.texture=new pa.Texture(this._rctx,a,b);a=new la.TextureTechniqueConfiguration;a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(ka.TextureTechnique,a);this._quadVAO=J.createQuadVAO(this._rctx)}};
B._createClass(t,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"_rctx",get:function(){return this.view._stage.renderView.renderingContext}},{key:"rctx",get:function(){return this._rctx}},{key:"materialRepository",get:function(){return this._materialRepository}},{key:"screenToWorldRatio",get:function(){return this._screenToWorldRatio}},{key:"localOriginFactory",get:function(){return this._localOriginFactory}},{key:"updating",get:function(){return this._sortedDrapeSourceRenderersDirty||
w.someMap(this._renderers,a=>a.updating)}},{key:"hasOverlays",get:function(){return null!=this._overlays&&null!=this._overlayRenderTarget}},{key:"gpuMemoryUsage",get:function(){return null!=this._overlayRenderTarget?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"overlays",get:function(){return this._overlays??[]}},{key:"running",get:function(){return this.updating}},{key:"isEmpty",get:function(){return I.OVERLAY_DRAW_DEBUG_TEXTURE?!1:!w.someMap(this._renderers,a=>!a.isEmpty)}},{key:"hasHighlights",
get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"test",get:function(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:a=>this._renderers.get(a)}}}]);return t}(O);l.__decorate([n.property()],g.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0);l.__decorate([n.property({autoDestroy:!0})],g.OverlayRenderer.prototype,"_shaderTechniqueRepository",
void 0);l.__decorate([n.property({constructOnly:!0})],g.OverlayRenderer.prototype,"view",void 0);l.__decorate([n.property()],g.OverlayRenderer.prototype,"worldToPCSRatio",void 0);l.__decorate([n.property()],g.OverlayRenderer.prototype,"spatialReference",void 0);l.__decorate([n.property({type:Boolean,readOnly:!0})],g.OverlayRenderer.prototype,"updating",null);l.__decorate([n.property()],g.OverlayRenderer.prototype,"isEmpty",null);g.OverlayRenderer=l.__decorate([T.subclass("esri.views.3d.terrain.OverlayRenderer")],
g.OverlayRenderer);let ua=B._createClass(function(A,t,d){this.drapeSource=A;this.renderer=t;this.index=d});const sa=[[1,.5,.5],[.5,.5,1]],F=ea.RenderOccludedFlag.OccludeAndTransparent;g.DRAPED_Z=-2;g.overlayRenderOccludedFlag=F;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Cyclical ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/ellipsoidUtils ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/ray ../../../chunks/sphere ../../../geometry/support/vector ../../../geometry/support/webMercatorUtils ../state/utils/viewUtils ../support/debugFlags ../support/debugUtils ./interfaces ./Overlay ./OverlayRenderer ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Intersector ../webgl-engine/lib/LocalOriginFactory ../webgl-engine/lib/Material ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/textureUtils ../webgl-engine/parts/requireUtils ../../support/Scheduler".split(" "),
function(m,N,n,T,I,U,V,J,W,C,O,q,qa,ra,X,Y,D,P,K,Q,F,R,l,S,L,Z,aa,ba,M,ca,p,da,ea,v,fa,ha,ia,ja,ka,la,E){const ma=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let A;m.OverlayManager=function(w){function G(a){a=w.call(this,a)||this;a._handles=new U;a._spatialReference=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._drapeSources=new Set;a._drapeTargets=new Set;a._placementDirty=!1;a._contentUpdated=!1;a._drawTexturesDirty=
!1;a._drawTexturesAnimateDirty=!1;a._hasUnusedRenderTargets=!1;a._longitudeCyclical=null;a._latestOriginId=0;a._maxResolution=V("esri-mobile")?2048:4096;a._animationTimeLast=0;a._removeRenderOverlayCallback=()=>{};return a}N._inherits(G,w);var g=G.prototype;g.initialize=function(){const a=this.view;this.renderer=new ea.OverlayRenderer({view:a,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference});const b=()=>this.setDrawTexturesDirty();this._groundIntersector=fa.newIntersector(this.view.state.viewingMode);
this._groundIntersector.options.backfacesTerrain=!0;this._groundIntersector.options.invisibleTerrain=!0;this._groundIntersector.options.hud=!1;this._handles.add([this.renderer.events.on("has-highlights",()=>{b();this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",c=>a._stage?.renderer.setParameters({hasOverlayWater:c})),this.renderer.events.on("renders-occluded",()=>{b();this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",b),C.watch(()=>a.state.camera.pixelRatio,
b),C.watch(()=>a.state.alignPixelEnabled,b),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),C.watch(()=>[a.pointsOfInterest?.renderPointOfView,a.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),C.watch(()=>[a.state?.pixelRatio,a.state?.contentPixelRatio],()=>this.setPlacementDirty(),C.sync),this.surface.on("elevation-change",()=>this.setPlacementDirty()),a.on("resize",()=>this.setPlacementDirty()),a.resourceController.scheduler.registerTask(E.TaskPriority.OVERLAY,
this),a._stage.renderView.events.on("force-camera-for-screenshot",c=>{this._updateOverlays(E.noBudget,c.camera,v.RenderRequestType.BACKGROUND);this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,v.RenderRequestType.BACKGROUND,c)})]);let d=c=>this._renderOverlayCallback(c);this._removeRenderOverlayCallback=()=>{d=()=>{}};a._stage?.renderer.setParameters({renderOverlay:c=>d(c)})};g._renderOverlayCallback=function(a){this._contentUpdated=!1;const b=this.renderer;b.processSyncDrapeSources();
b.hasOverlays&&(this._dispatchAnimationUpdate(a),this._drawOverlayTextures(b.overlays,v.RenderRequestType.UPDATE,this.view.state));this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()};g.destroy=function(){this._handles=W.destroyMaybe(this._handles);this._removeRenderOverlayCallback();this.view?._stage?.renderer.setParameters({renderOverlay:()=>{}});null!=A&&(A.hide(),A=null)};g.setSpatialReference=function(a){this._spatialReference=a;this.renderer.spatialReference=a;this._longitudeCyclical=
null;const b=this.view.renderSpatialReference;null!=a&&null!=b?(this._renderSR=b,this._overlaySREqualsRenderSR=a.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=a.isWebMercator?new I.Cyclical(-2.0037508342787E7,2.0037508342787E7):new I.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()};g.registerDrapeSource=function(a,b,d){this._drapeSources.add(a);this.renderer.ensureOverlays(this._drapeTargets,
this._drapeSources);b=this.renderer.createDrapeSourceRenderer(a,b,d);this._updateDrapeSourceExtent(a);this._setContentDirty();this.notifyChange("running");return b};g.registerGeometryDrapeSource=function(a){return this.registerDrapeSource(a,ja.SortedRenderGeometryRenderer)};g._updateDrapeSourceExtent=function(a){2===this.renderer.overlays.length&&null!=a.setDrapingExtent&&null!=this._spatialReference&&a.setDrapingExtent(this.renderer.overlays,this._spatialReference)};g.unregisterDrapeSource=function(a){this._drapeSources.has(a)&&
(this._drapeSources.delete(a),this.renderer.removeDrapeSourceRenderer(a),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))};g.registerDrapeTarget=function(a){this._drapeTargets.add(a);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)};g.updateOverlayResult=function(){this.view._stage?.renderer.setParameters({overlays:this.renderer.overlays})};g.unregisterDrapeTarget=function(a){this._drapeTargets.delete(a);this.renderer.ensureDrapeTargets(this._drapeTargets)};
g._setContentDirty=function(){this.setPlacementDirty();this.setDrawTexturesDirty()};g.setPlacementDirty=function(){this._placementDirty=!0};g.runTask=function(a){return this._updateOverlays(a,this.view.state.contentCamera,v.RenderRequestType.UPDATE)};g._updateOverlays=function(a,b,d){if(!this._spatialReference)return E.Task.YIELD;var c=this._computeOverlayResolution(b);this._computeOverlayExtents(b,c,x);const e=l.width(x.inner)/l.width(x.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);
b=this._updateOverlay(p.OverlayIndex.INNER,x.inner,c,1*x.pixelRatioAdjustment,x.mapUnitsPerPixel);c=this._updateOverlay(p.OverlayIndex.OUTER,x.outer,c,e*x.pixelRatioAdjustment,x.mapUnitsPerPixel);if(b===u.EXTENT||c===u.EXTENT)this._drapeSources.forEach(f=>this._updateDrapeSourceExtent(f)),this.surface.updateTileOverlayParams(d);b===u.NONE&&c===u.NONE||this.setDrawTexturesDirty();this._placementDirty=!1;a.madeProgress()};g._computeOverlayResolution=function(a){const b=this.view.state.contentPixelRatio;
return Math.min(ka.applyTextureResizeModulo(Math.ceil(1.5*Math.max(a.fullWidth/a.pixelRatio*b,a.fullHeight/a.pixelRatio*b))),this._maxResolution)};g._updateOverlay=function(a,b,d,c,e){if(0===this.renderer.overlays.length)return u.NONE;a=this.renderer.overlays[a];const f=a.mapUnitsPerPixel;a.mapUnitsPerPixel=e;a.pixelRatio=c;c=a.extent;const t=M.TESTS_DISABLE_OPTIMIZATIONS?0:1E-5*Math.max(b[2]-b[0],b[3]-b[1],c[2]-c[0],c[3]-c[1]);if(Math.abs(c[0]-b[0])<=t&&Math.abs(c[1]-b[1])<=t&&Math.abs(c[2]-b[2])<=
t&&Math.abs(c[3]-b[3])<=t&&d===a.resolution)return f===e?u.NONE:u.RERENDER_ONLY;l.copy(a.extent,b);a.resolution=d;b=l.center(a.extent);a.renderLocalOrigin=ha.fromValues(b[0],b[1],0,`OV_${this._latestOriginId++}`);return u.EXTENT};g.setTileParameters=function(a){const b=a.renderData.overlay;if(0<this.renderer.overlays.length){const d=this.renderer.overlays[p.OverlayIndex.INNER],c=this.renderer.overlays[p.OverlayIndex.OUTER];a=a.extent;this._rectInsideRect(d.extent,a)||this._rectanglesOverlap(a,d.extent)||
this._rectanglesOverlap(a,c.extent)?(this._setTileOverlayData(a,p.OverlayIndex.INNER,b),this._setTileOverlayData(a,p.OverlayIndex.OUTER,b)):(this._clearTileOverlayData(p.OverlayIndex.INNER,b),this._clearTileOverlayData(p.OverlayIndex.OUTER,b))}else this._clearTileOverlayData(p.OverlayIndex.INNER,b),this._clearTileOverlayData(p.OverlayIndex.OUTER,b)};g.overlayPixelSizeInMapUnits=function(a){if(0===this.renderer.overlays.length)return 0;const b=this.renderer.overlays[p.OverlayIndex.INNER],d=this.renderer.overlays[p.OverlayIndex.OUTER];
a=this._pointIsInExtent(a,b.extent)?b:d;return(a.extent[2]-a.extent[0])/a.resolution};g._setTileOverlayData=function(a,b,d){if(0!==this.renderer.overlays.length){var c=this.renderer.overlays[b].extent,e=l.width(c),f=l.height(c),t=a[0];if(this._longitudeCyclical){t=this._longitudeCyclical.minimalMonotonic(c[0],t);const r=this._longitudeCyclical.minimalMonotonic(c[0],a[2]);t>r&&(t=r-(a[2]-a[0]))}d.setScale(b,l.width(a)/e,l.height(a)/f);d.setOffset(b,(t-c[0])/e,(a[1]-c[1])/f)}};g._clearTileOverlayData=
function(a,b){b.setScale(a,-1,-1);b.setOffset(a,-1,-1)};g.reloadShaders=async function(){la.removeLoadedShaderModules();await this.renderer.reloadShaders();this.setDrawTexturesDirty();this.runTask(E.noBudget)};g._dispatchAnimationUpdate=function(a){var b=O.Milliseconds(a-this._animationTimeLast);if(b>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty)b=O.Milliseconds(b/this.surface.view._stage.renderer.animationTimeDilation),
b=new ia.UpdateParameters(this.view.state.camera,b,this.view.state.forcedAnimationTime),this.renderer.updateAnimation(b)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=a};g.setDrawTexturesDirty=function(){this.renderer.hasOverlays?(this._drawTexturesDirty=this._contentUpdated=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()};g._intersectGroundFromView=function(a,b,d,c){d=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(a,na,b,d);if(null==d)return!1;
b=d.origin;d=D.add(H,d.origin,d.direction);this._groundIntersector.reset(b,d,a);this._groundIntersector.intersect([]);this.view.basemapTerrain.intersect(this._groundIntersector,null,b,d);return this._groundIntersector.results.min.getIntersectionPoint(c)};g._findHorizonBasedPointOfInterest=function(a,b){var d=.5;d=this.view.renderCoordsHelper.getAltitude(a.eye);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent;var e=J.clamp(c.estimatedSurfaceAltitude,a.aboveGround?-Infinity:d+1E-5,a.aboveGround?
d-1E-5:Infinity);d=a.aboveGround;if("global"===this.view.viewingMode){var f=H;L.closestPointOnSilhouette(L.fromRadius(L.tmpSphere,F.getReferenceEllipsoid(this.view.spatialReference).radius+e),S.wrap(a.eye,a.viewForward),f);D.subtract(f,f,a.eye);e=I.cyclicalPI.normalize(Z.angleAroundAxis(a.viewForward,f,a.viewRight))/a.fovY+.5;f=0>=e||1<=e?.5:.55;d=d?f*e:e+f*(1-e)}else e=Q.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0),e=K.transformMat4(e,e,a.projectionMatrix)[1],e=J.clamp(.5+
.5*e,0,1),d=1===e||0===e?.5:d?.55*e:1-.55*(1-e);return this._intersectGroundFromView(a,.5,d,b)?D.sqrDist(b,a.eye)<c.distance*c.distance:!1};g._computeOverlayExtents=function(a,b,d){var c=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;const e=P.create();this._findHorizonBasedPointOfInterest(a,e)||D.copy(e,c);M.OVERLAY_SHOW_CENTER?(null==A&&(A=new ca.PointGraphics(this.view.graphics,"red")),A.show(e,this._renderSR)):null!=A&&A.hide();var f=Math.max(.1,D.distance(a.eye,e));const t=
ba.viewAngle(this.view.renderCoordsHelper,c,a.eye);this._overlaySREqualsRenderSR||R.projectVectorToVector(e,this._renderSR,e,this._spatialReference);c=this.surface.extent;var r=!this._isSpherical&&null!=this._spatialReference&&this._spatialReference.isGeographic,y=r&&null!=this._spatialReference?1/F.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1;f=a.perScreenPixelRatio/this.view.state.contentPixelRatio*f*y;d.mapUnitsPerPixel=f/this._worldToPCSRatio;f=b*f/2*da.OverlayStretch;var h=
!1;r=r?90:Infinity;this._isSpherical&&null!=c&&null!=this._spatialReference&&(this._spatialReference.isWebMercator?(f/=Math.cos(aa.y2lat(e[1])),r=c[3]):(h=!0,f/=F.getReferenceEllipsoid(this._spatialReference).metersPerDegree,r=90),f>=r&&(f=r,e[1]=0,this._spatialReference.isWebMercator&&(e[0]=0)));y=1;h&&(y=1/Math.max(.2,Math.cos(Math.abs(J.deg2rad(e[1])))),180<f*y&&(y=180/f),d.mapUnitsPerPixel*=y);h=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/h)*h);const B=f*y;h=.5*b/(32*B);var k=.5*b/(32*f);
e[0]=Math.round(e[0]*h)/h;e[1]=Math.round(e[1]*k)/k;h=d.inner;h[0]=e[0]-B;h[1]=e[1]-f;h[2]=e[0]+B;h[3]=e[1]+f;this._isSpherical&&this._shiftExtentToFitBounds(h,Infinity,r);k=d.outer;6*B>l.width(c)?l.copy(k,c):Math.PI/2-Math.abs(t-Math.PI/2)<=.25*Math.PI?(k[0]=h[0]-B,k[1]=h[1]-f,k[2]=h[2]+B,k[3]=h[3]+f):(R.projectVectorToVector(a.eye,this._renderSR,H,this._spatialReference),Y.subtract(z,e,H),a=-Math.atan2(z[1],z[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),K.scale(z,ma[Math.floor(a/(.25*Math.PI))],2*f),z[0]*=
y,z[2]*=y,K.add(k,h,z));this._isSpherical?(k[0]=this._longitudeCyclical.clamp(k[0]),k[2]=this._longitudeCyclical.clamp(k[2]),k[1]=Math.max(k[1],-r),k[3]=Math.min(k[3],r)):(a=l.intersection(h,c,oa),c=l.intersection(k,c,pa),l.contains(a,c)&&(k[2]=k[0],k[3]=k[1]));b=Math.abs(h[2]-h[0])/b;d.mapUnitsPerPixel=Math.max(d.mapUnitsPerPixel,b);d.pixelRatioAdjustment=d.mapUnitsPerPixel/b};g._drawOverlayTextures=function(a,b,d){if(0!==a.length&&(this._drawTexturesDirty||this._drawTexturesAnimateDirty)){var c=
this._drawTexturesDirty;this._drawTexturesAnimateDirty=this._drawTexturesDirty=!1;var e=this._drawOverlay(a[p.OverlayIndex.INNER],d);a=this._drawOverlay(a[p.OverlayIndex.OUTER],d);e!==v.ValidationState.CHANGED&&a!==v.ValidationState.CHANGED||this.surface.updateTileOverlayParams(v.RenderRequestType.UPDATE);this._collectUnusedRenderTargetMemory();this.updateOverlayResult();c?(this.surface.requestRender(b),b===v.RenderRequestType.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(v.RenderRequestType.BACKGROUND)}};
g._drawOverlay=function(a,b){this._longitudeCyclical?a.setupGeometryViewsCyclical(this._longitudeCyclical):a.setupGeometryViewsDirect();return a.draw(this.renderer,b)};g._collectUnusedRenderTargetMemory=function(){this._hasUnusedRenderTargets=!1;this.renderer.hasOverlays&&(this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory())};g._rectanglesOverlap=function(a,b){return null==a?!1:this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||this._longitudeCyclical.contains(b[0],
b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):l.intersects(a,b)};g._rectInsideRect=function(a,b){return null==b?!1:this._longitudeCyclical?this._longitudeCyclical.contains(a[0],a[2],b[0])&&this._longitudeCyclical.contains(a[0],a[2],b[2])&&b[1]>a[1]&&b[3]<a[3]:l.contains(a,b)};g._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];const d=a.x;a=a.y;return d>b[0]&&d<b[2]&&a>b[1]&&
a<b[3]};g._shiftExtentToFitBounds=function(a,b,d){let c=0,e=0;a[0]<-b?c=a[0]+b:a[2]>b&&(c=b-a[2]);a[1]<-d?e=a[1]+d:a[3]>d&&(e=d-a[3]);l.offset(a,c,e)};N._createClass(G,[{key:"running",get:function(){return this._placementDirty&&(0<this._drapeSources.size||0<this.view.graphics.length||M.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return null!=
this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?F.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}},{key:"suspended",get:function(){return this.surface.suspended}},{key:"updating",get:function(){return this.running||this.renderer.updating||this._contentUpdated}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},
{key:"gpuMemoryUsage",get:function(){return this.renderer.gpuMemoryUsage}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this.runTask(E.noBudget)}}}]);return G}(T);n.__decorate([q.property()],m.OverlayManager.prototype,"_spatialReference",void 0);n.__decorate([q.property({readOnly:!0})],m.OverlayManager.prototype,"running",null);n.__decorate([q.property()],m.OverlayManager.prototype,"_placementDirty",void 0);n.__decorate([q.property()],m.OverlayManager.prototype,"_contentUpdated",
void 0);n.__decorate([q.property()],m.OverlayManager.prototype,"_isSpherical",null);n.__decorate([q.property()],m.OverlayManager.prototype,"_worldToPCSRatio",null);n.__decorate([q.property({autoDestroy:!0})],m.OverlayManager.prototype,"renderer",void 0);n.__decorate([q.property({constructOnly:!0})],m.OverlayManager.prototype,"view",void 0);n.__decorate([q.property({constructOnly:!0})],m.OverlayManager.prototype,"surface",void 0);n.__decorate([q.property()],m.OverlayManager.prototype,"suspended",null);
n.__decorate([q.property()],m.OverlayManager.prototype,"updating",null);n.__decorate([q.property({type:Boolean})],m.OverlayManager.prototype,"hasHighlights",null);n.__decorate([q.property({type:Boolean})],m.OverlayManager.prototype,"rendersOccluded",null);m.OverlayManager=n.__decorate([X.subclass("esri.views.3d.terrain.OverlayManager")],m.OverlayManager);const z=Q.create(),H=P.create(),x={inner:l.create(),outer:l.create(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},oa=l.create(),pa=l.create(),na=S.create();
var u;(function(w){w[w.NONE=0]="NONE";w[w.EXTENT=1]="EXTENT";w[w.RERENDER_ONLY=2]="RERENDER_ONLY"})(u||(u={}));Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
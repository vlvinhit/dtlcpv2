// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Logger ../../../core/maybe ../../../chunks/vec2f64 ../../2d/engine/imagery/enums ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./LayerClass ./RasterColorizerTechnique ./support/MultiSizeFramebuffer ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/BindParameters ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(v,J,u,m,K,w,L,x,y,z,A,r,g,B,M,N,O,p,C,P){const Q=u.getLogger("esri.views.3d.terrain");u=function(){function D(a,b){this._rctx=a;this._techniqueRepository=b;this._fbos=[];this._vectorTileHelper=new L.VectorTileRendererHelper3D;this._bindParameters=new M.BindParameters(null,null,null);this._blendLayersTechniqueConfig=new x.BlendLayersTechniqueConfiguration;this._current=0;this._lastUsedIds=[];this._lastCreatedBufferId=0;this._onHoldIds=[];this._vaoQuad=O.createQuadVAO(this._rctx,N.Pos2Tex)}
var e=D.prototype;e.dispose=function(){this._fbos.forEach(m.disposeMaybe);this._fbos=null;this._vtFBO=m.disposeMaybe(this._vtFBO);this._vaoQuad=m.disposeMaybe(this._vaoQuad);this._vectorTileHelper=m.disposeMaybe(this._vectorTileHelper);this._backgroundTechnique=m.releaseMaybe(this._backgroundTechnique);this._applyOpacityTechnique=m.releaseMaybe(this._applyOpacityTechnique);this._blendLayersTechnique=m.releaseMaybe(this._blendLayersTechnique)};e._getBlendLayersTechnique=function(a,b,c,d=g.PremultipliedAlphaSource.Off,
h=B.BackgroundMode.BelowLayer){this._blendLayersTechniqueConfig.output=b;this._blendLayersTechniqueConfig.blendMode=a;this._blendLayersTechniqueConfig.baseOpacityMode=c;this._blendLayersTechniqueConfig.premultipliedSource=d;this._blendLayersTechniqueConfig.background=h;return this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(x.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique)};e.drawBackground=function(a,b){b=this._getBlendLayersTechnique(r.LayerBlendMode.Normal,
b?g.BlendLayersOutput.ColorComposite:g.BlendLayersOutput.GridComposite,g.BaseOpacityMode.NotRequired,g.PremultipliedAlphaSource.Off,B.BackgroundMode.Only);a=this._rctx.bindTechnique(b,a,this._bindParameters);this._render(a)};e._render=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(p.PrimitiveType.TRIANGLE_STRIP,0,P.vertexCount(this._vaoQuad,"geometry"))};e.drawGroup=function(a,b,c,d,h,f=g.PremultipliedAlphaSource.On){b===
g.BlendLayersOutput.Composite&&(a.fboTexture=this._fbos[this.getLastOnHoldId()].get(c).colorTexture);a.texture=this.currentFBO(c).colorTexture;this.closeGroup(c);b=this._getBlendLayersTechnique(d,b,h,f);a=this._rctx.bindTechnique(b,a,this._bindParameters);this._render(a)};e.drawRasterData=function(a,b,c,d,h,f=g.PremultipliedAlphaSource.Off){null!=a.texture&&(a.fboTexture=b===g.BlendLayersOutput.GroupBackgroundComposite||d===r.LayerBlendMode.Normal&&h===g.BaseOpacityMode.NotRequired&&f===g.PremultipliedAlphaSource.Off?
null:this.switch(c).colorTexture,b=this._getBlendLayersTechnique(d,b,h,f),a=this._rctx.bindTechnique(b,a,this._bindParameters),this._render(a))};e.drawImageryTileData=function(a,b,c,d,h,f){var k=f.sourceLayerInfo.data;k.source&&(f.tile.surface.layerViewByIndex(f.layerIndex,y.LayerClass.MAP).ensureSymbolizerParameters(k),k.bind(this._rctx)&&(a.fboTexture=d===r.LayerBlendMode.Normal&&h===g.BaseOpacityMode.NotRequired?null:this.switch(c).colorTexture,b=this._getRasterColorizerTechnique(k,b,d,h),k.opacity=
a.opacity,k=k.getUniforms(),k.scale=f.scale,k.offset=f.offset,k.backgroundColor=a.backgroundColor,k.fboTexture=a.fboTexture,k.baseOpacity=a.baseOpacity,a=this._rctx.bindTechnique(b,k,null),this._render(a)))};e._getRasterColorizerTechnique=function(a,b,c,d){const h=a.symbolizerParameters,f=["stretch","lut","hillshade"].indexOf(h.type);null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new z.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float"));
this._rasterColorizerConfig.output=b;this._rasterColorizerConfig.blendMode=c;this._rasterColorizerConfig.baseOpacityMode=d;this._rasterColorizerConfig.colorizerType=f;this._rasterColorizerConfig.applyColormap=!!h.colormap;this._rasterColorizerConfig.requireBilinearWithNN=a.isBilinearWithStretchColorRamp;this._rasterColorizerConfig.stretchType=a.hasStretchTypeNone()?w.RasterColorizerStretchType.Noop:w.RasterColorizerStretchType.PerBand;return this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(z.RasterColorizerTechnique,
this._rasterColorizerConfig,this._rasterColorizerTechnique)};e.drawVectorData=function(a,b,c,d,h,f,k,E,F){const n=this._rctx,R=f.sourceLayerInfo.data,l=f.tile.surface.layerViewByIndex(f.layerIndex,y.LayerClass.MAP),G=h===g.BaseOpacityMode.Required||1>a.opacity||d!==r.LayerBlendMode.Normal||b!==g.BlendLayersOutput.Composite,H=G?g.PremultipliedAlphaSource.On:g.PremultipliedAlphaSource.Off;this._getBlendLayersTechnique(d,b,h,H).bindPipelineState(n);let t=null,I=null;G?(I=this.currentFBO(c),null==this._vtFBO&&
(this._vtFBO=new A.MultiSizeFramebuffer(this._rctx)),t=this._vtFBO.get(c),n.bindFramebuffer(t),this._clearCurrentFBO()):F&&n.clearSafe(p.ClearBufferBit.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(n,f.sourceLod,R,l.painter,l.layer.styleRepository,l.schemaHelper,Math.round(1/f.scale),f.offset,E,k,l.contentZoom),f.vtlNeighborInfos.forAll(q=>this._vectorTileHelper.renderSymbols(n,q.sourceLod,q.sourceLayerInfo.data,l.painter,l.layer.styleRepository,l.schemaHelper,1,q.offset,E,k,l.contentZoom))}catch(q){Q.warnOnce("A render call containing vector tiles did not resolve correctly.",
q)}return null!=t?(n.bindFramebuffer(I),a.texture=t.colorTexture,a.offset=K.ZEROS,a.scale=1,this.drawRasterData(a,b,c,d,h,H),F):!0};e.copyFBOToTexture=function(a){const b=this._rctx,c=b.bindTexture(a.texture,C.Texture.TEXTURE_UNIT_FOR_UPDATES),d=a.descriptor;b.gl.copyTexImage2D(p.TextureType.TEXTURE_2D,0,d.pixelFormat,0,0,d.width,d.height,0);a.generateMipmap();b.bindTexture(c,C.Texture.TEXTURE_UNIT_FOR_UPDATES)};e._clearCurrentFBO=function(){this._rctx.setClearColor(0,0,0,0);this._rctx.setClearDepth(1);
this._rctx.clearSafe(p.ClearBufferBit.COLOR_BUFFER_BIT|p.ClearBufferBit.DEPTH_BUFFER_BIT)};e._initFBO=function(a,b,c){this._rctx.bindFramebuffer(a);c&&(this._rctx.setViewport(0,0,b,b),this._clearCurrentFBO())};e.ensureBuffer=function(a){this._lastUsedIds.length=0;this._lastUsedIds.push(1);this._lastCreatedBufferId=1;this._onHoldIds.length=0;this.bind(a)};e.bind=function(a,b=0,c=!0){this._current=b;if(b>=this._fbos.length)for(let d=this._fbos.length;d<=b;d++)this._fbos.push(new A.MultiSizeFramebuffer(this._rctx));
this._initFBO(this._fbos[b].get(a),a,c)};e._bindNextFreeBuffer=function(a){0<this._lastUsedIds.length?this.bind(a,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(a,this._lastCreatedBufferId))};e.openGroup=function(a){this._onHoldIds.push(this._current);this._bindNextFreeBuffer(a)};e.switch=function(a){const b=this.currentFBO(a),c=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(c);return b};e.getLastOnHoldId=function(){return this._onHoldIds[this._onHoldIds.length-
1]};e.closeGroup=function(a){const b=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(b);this._lastUsedIds.push(this._onHoldIds.pop())};e.unbind=function(){this._rctx.bindFramebuffer(null)};e.currentFBO=function(a){return this._fbos[this._current].get(a)};return J._createClass(D)}();v.TileCompositor=u;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3f32 ../../../geometry/ellipsoidUtils ../../../chunks/Clouds.glsl ./CloudsData ./CloudsPresets ./CloudsTechnique ./CloudsTechniqueConfiguration ./NoiseTextureAtlas ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject ../../webgl/TextureDescriptor".split(" "),
function(c,y,f,C,D,l,r,z,h,T,U,V,E,F,G,H,u,I,k,J,A,v,d,K,p,L,M,N,w,x,O,P){c.CloudsGenerator=function(B){function t(b){var a=B.call(this,b)||this;a._handles=new D;a._techniques=[];a._techniqueConfiguration=new p.CloudsTechniqueConfiguration;a._bindParameters=new M.BindParameters(null,null,null);a._passParameters=new A.CloudsPassParameters;a._drawParameters=new A.CloudsDrawParameters;a._weatherTile=I.create();a._weatherTileCount=128;a._faceIndex=0;a._tileIndex=0;a.coverage=l.lerp(d.cloudPresets.default.coverage[0],
d.cloudPresets.default.coverage[1],.5);a.density=l.lerp(d.cloudPresets.default.density[0],d.cloudPresets.default.density[1],.5);a.absorption=l.lerp(d.cloudPresets.default.absorption[0],d.cloudPresets.default.absorption[1],.5);a.cloudSize=l.lerp(d.cloudPresets.default.cloudSize[0],d.cloudPresets.default.cloudSize[1],.5);a.detailSize=l.lerp(d.cloudPresets.default.detailSize[0],d.cloudPresets.default.detailSize[1],.5);a.smoothness=l.lerp(d.cloudPresets.default.smoothness[0],d.cloudPresets.default.smoothness[1],
.5);a.cloudHeight=l.lerp(d.cloudPresets.default.cloudHeight[0],d.cloudPresets.default.cloudHeight[1],.5);a.raymarchingSteps=d.cloudPresets.default.raymarchingSteps;a._viewMatrix=H.create();a._dirty=!1;a.running=!1;a._vao=N.createQuadVAO(b.context.renderContext.rctx);return a}y._inherits(t,B);var m=t.prototype;m._getTechnique=function(b){const a=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,e=a===v.CloudsTextureChannels.RG?2*b:2*b+1,g=this._techniques[e];if(g)return g;this._techniqueConfiguration.writeTextureChannels=
a;this._techniqueConfiguration.steps=b;this._techniques[e]=new K.CloudsTechnique({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[e]};m.updateWeatherTile=function(){var b=this.view.camera.position.latitude,a=this.view.camera.position.longitude;null!=b&&null!=a&&(u.set(this._weatherTile,(b+90)/180,(a+180)/360),b=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1)),this._weatherTile[0]=Math.floor(2*
this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-b)*this._weatherTile[1]),a=b=0,null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date&&(a=new Date(this.view.environment.lighting.date),a.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),b=31*a.getUTCMonth()+a.getUTCDate(),a=a.getUTCFullYear()),this._weatherTile[0]=
(this._weatherTile[0]+b)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+a%100)%(4*this._weatherTileCount),u.equals(this._passParameters.weatherTile,this._weatherTile)||this.setDirty())};m.initialize=function(){const b=J.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*b.radius;this.setDirty();this.updateWeatherTile();this._handles.add([this.view.resourceController.scheduler.registerTask(w.TaskPriority.CLOUDS_GENERATOR,this),z.watch(()=>[this.coverage,
this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),z.initial)])};m.destroy=function(){this._handles.destroy();this._techniques.forEach(b=>r.releaseMaybe(b));this._frameBufferCube=r.disposeMaybe(this._frameBufferCube);this._techniques.length=0;this._vao.dispose();this._passParameters.noiseTexture=r.destroyMaybe(this._passParameters.noiseTexture)};m._ensureNoiseTexture=function(){null==this._passParameters.noiseTexture&&
(this._passParameters.noiseTexture=new L.NoiseTextureAtlas({context:this.context}));this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);return null!=this._passParameters.noiseTexture.textureAtlas};m._ensureFrameBufferCube=function(b){null==this._frameBufferCube&&(b=new P.TextureDescriptor(b),b.target=x.TextureType.TEXTURE_CUBE_MAP,b.wrapMode=x.TextureWrapMode.CLAMP_TO_EDGE,this._frameBufferCube=new O.FramebufferObject(this.context.renderContext.rctx,b));return this._frameBufferCube};
m.destroyFrameBufferCube=function(){this._frameBufferCube=r.disposeMaybe(this._frameBufferCube)};m.applyPreset=function(b,a){const e=b.median,g=n=>{const q=l.lerp(n[0],n[1],e);return.5>a?l.lerp(n[0],q,2*a):l.lerp(q,n[1],2*(a-.5))};this.coverage=g(b.coverage);this.density=g(b.density);this.absorption=g(b.absorption);this.cloudSize=g(b.cloudSize);this.detailSize=g(b.detailSize);this.smoothness=g(b.smoothness);this.cloudHeight=g(b.cloudHeight);this.raymarchingSteps=b.raymarchingSteps};m.setDirty=function(){this._dirty=
this.running=!0};m.runTask=function(b){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),u.copy(this._passParameters.weatherTile,this._weatherTile));var a=this._getTechnique(this._passParameters.raymarchingSteps);if(!a.compiled||!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return w.Task.YIELD;0===this._faceIndex&&
0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=v.CloudsRenderingStages.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const e=this.context.renderContext.rctx,
g=e.bindTechnique(a,this._passParameters,this._bindParameters);e.bindVAO(this._vao);g.assertCompatibleVertexAttributeLocations(this._vao);const n=e.getViewport();a=a.configuration.cubeMapSize;const q=a/this._tilesPerFace;e.setViewport(0,this._tileIndex*q,a,q);a=this._ensureFrameBufferCube(a);e.bindFramebuffer(a);G.targetTo(this._viewMatrix,Q,R[this._faceIndex],S[this._faceIndex]);F.fromMat4(this._drawParameters.viewMatrix,this._viewMatrix);a.setColorTextureTarget(x.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+
this._faceIndex);g.bindDraw(this._drawParameters,this._bindParameters,this._passParameters);e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4);e.gl.flush();e.setViewport(n.x,n.y,n.width,n.height);this.requestRender();++this._tileIndex;4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._tileIndex=this._faceIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=v.CloudsRenderingStages.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,
this._tileIndex=0);b.madeProgress();return w.Task.YIELD};y._createClass(t,[{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case p.RayMarchingSteps.SIXTEEN:return 1;case p.RayMarchingSteps.HUNDRED:return 4;case p.RayMarchingSteps.COUNT:case p.RayMarchingSteps.TWOHUNDRED:return 8}}},{key:"cubeMap",get:function(){return this._frameBufferCube}}]);return t}(C);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"context",void 0);f.__decorate([h.property({constructOnly:!0})],
c.CloudsGenerator.prototype,"view",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"coverage",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"density",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"absorption",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"detailSize",
void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"smoothness",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudHeight",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"raymarchingSteps",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"running",void 0);c.CloudsGenerator=f.__decorate([E.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const R=[k.fromValues(1,0,0),k.fromValues(-1,0,0),k.fromValues(0,1,0),k.fromValues(0,
-1,0),k.fromValues(0,0,1)],S=[k.fromValues(0,1,0),k.fromValues(0,1,0),k.fromValues(0,0,-1),k.fromValues(0,0,1),k.fromValues(0,1,0)],Q=k.zeros();Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
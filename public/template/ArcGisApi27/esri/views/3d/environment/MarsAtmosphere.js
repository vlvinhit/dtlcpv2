// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/support/FloatArray ./AtmosphereType ./atmosphereUtils ../../../chunks/SimpleAtmosphere.glsl ./SimpleAtmosphereTechnique ./SimpleAtmosphereTechniqueConfiguration ./resources/MarsAtmosphereTexture ../support/mathUtils ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Util ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor ../../webgl/Util".split(" "),
function(E,v,F,w,G,H,I,h,q,J,K,L,x,M,y,r,N,t,O,P,Q,R,z,S,T,U,n,V,W,A){function B(k,l,a,b,c){const g=h.length(k),d=b*Math.sqrt(g*g-b*b)/g,f=c.v1,e=c.v2;h.scale(c.center,k,Math.sqrt(b*b-d*d)/g);h.cross(f,k,l);1>h.squaredLength(f)&&h.cross(f,k,a);h.scale(f,f,d/h.length(f));h.cross(e,f,k);h.scale(e,e,d/h.length(e));return d}const C=-x.innerAtmosphereDepth,X=t.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5E3,.51171875],[5E4,.4140625]]);t=function(){function k(a,b){this.view=a;this.type=L.AtmosphereType.Mars;
this._passParameters=new M.SimpleAtmospherePassParameters;this._vaoCount=0;this._texV1=1;a=J.getReferenceEllipsoid(a.spatialReference);this._planetRadius=a.radius;this._outerRimWidth=a.outerAtmosphereRimWidth;this._innerRimFactor=(this._planetRadius+C)/this._planetRadius;this._middleRimFactor=(this._planetRadius+0)/this._planetRadius;this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius;this._texV0=0/this._outerRimWidth;this._texVScale=this._texV1-this._texV0;this._techniqueRepository=
b.techniqueRepository;a=b.renderContext.rctx;this._cameraChangeHandle=w.watch(()=>this.view.state?.camera,()=>b.requestRender(),w.syncAndInitial);this._vao=this._createRibbon(a);this._vaoCount=A.vertexCount(this._vao,"geometry");this._fadeVao=R.createQuadVAO(a);this._fadeVaoCount=A.vertexCount(this._fadeVao,"geometry");const c=new W.TextureDescriptor;c.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE;c.flipped=!0;c.width=1;c.height=512;this._passParameters.texture=new V.Texture(a,c,N.marsAtmosphereTextureSimple);
a=new r.SimpleAtmosphereTechniqueConfiguration;a.geometry=r.SimpleAtmosphereGeometry.Cone;this._coneTechnique=this._techniqueRepository.acquire(y.SimpleAtmosphereTechnique,a);a.geometry=r.SimpleAtmosphereGeometry.Underground;this._undergroundTechnique=this._techniqueRepository.acquire(y.SimpleAtmosphereTechnique,a)}var l=k.prototype;l.destroy=function(){this._coneTechnique.release();this._undergroundTechnique.release();this._cameraChangeHandle.remove();this._passParameters.texture=F.disposeMaybe(this._passParameters.texture);
this._fadeVao.dispose();this._vao.dispose()};l.render=function(a){this._update(a.bindParameters.camera);const b=a.rctx;1>this._passParameters.undergroundFadeAlpha&&(b.bindTechnique(this._coneTechnique,this._passParameters,a.bindParameters),b.bindVAO(this._vao),b.drawArrays(n.PrimitiveType.TRIANGLES,0,this._vaoCount));0<this._passParameters.undergroundFadeAlpha&&(b.bindTechnique(this._undergroundTechnique,this._passParameters,a.bindParameters),b.bindVAO(this._fadeVao),b.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,
0,this._fadeVaoCount))};l.renderHaze=function(){};l._update=function(a){var b=q.create();const c=this._planetRadius;var g=h.length(a.eye);const d=g-c;this._passParameters.undergroundFadeAlpha=0>d?Math.min(-d/5E3,1):0;var f=c+C,e=c+Math.max(50,d);this._passParameters.innerScale=e*e/(Math.sqrt(e*e-c*c)*Math.sqrt(e*e-f*f)+c*f)-1;this._passParameters.altitudeFade=x.computeInnerAltitudeFade(d);h.scale(b,a.eye,(c+50)/g);B(b,a.center,a.up,c,this._passParameters.silhouette);b=this._computeScreenRimWidth(a,
b,a.up,this._passParameters.silhouette);g=X(d);f=this._texV0+.001953125*this._texVScale;e=this._texV0+b*g*this._texVScale;50<d&&(B(a.eye,a.center,a.up,c,this._passParameters.silhouette),a=this._computeScreenRimWidth(a,a.eye,a.up,this._passParameters.silhouette),a=v.clamp((a-1.5)/(b-1.5),0,1),f=this._texV0+.001953125*a*this._texVScale,e=this._texV0+v.lerp(this._texV1,b*g,a)*this._texVScale);I.set(this._passParameters.texV,f,e)};l._createRibbon=function(a){const b=K.newFloatArray(1155),c=new Uint32Array(1920);
b[0]=0;b[1]=0;b[2]=-1;for(var g=0;128>g;g++){var d=9*g+3;b[d]=g;b[d+1]=this._innerRimFactor;b[d+2]=-1;b[d+3]=g;b[d+4]=this._middleRimFactor;b[d+5]=0;b[d+6]=g;b[d+7]=this._outerRimFactor;b[d+8]=1;d=3*g+1;var f=127===g?1:d+3,e=15*g;c[e]=d;c[e+1]=d+1;c[e+2]=f+1;c[e+3]=f+1;c[e+4]=f;c[e+5]=d;c[e+6]=d+1;c[e+7]=d+2;c[e+8]=f+2;c[e+9]=f+2;c[e+10]=f+1;c[e+11]=d+1;c[e+12]=d;c[e+13]=f;c[e+14]=0}g=D.createBuffer(c.length);d=g.position;for(f=0;f<c.length;++f)e=3*c[f],d.set(f,0,b[e]),d.set(f,1,b[e+1]),d.set(f,2,
b[e+2]);return new S.VertexArrayObject(a,Q.Default3D,{geometry:O.glLayout(D)},{geometry:U.BufferObject.createVertex(a,n.Usage.STATIC_DRAW,g.buffer)})};l._computeScreenRimWidth=function(a,b,c,g){h.add(m,g.center,g.v2);h.scale(p,m,this._outerRimFactor);G.lookAt(u,b,m,c);z.project(m,u,a.projectionMatrix,a.viewport,m);z.project(p,u,a.projectionMatrix,a.viewport,p);return h.distance(m,p)/a.height};return E._createClass(k)}();const u=H.create(),m=q.create(),p=q.create(),D=P.newLayout().vec3f(T.VertexAttribute.POSITION);
return t});
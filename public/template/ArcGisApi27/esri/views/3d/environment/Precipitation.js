// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/mathUtils ../../../core/maybe ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/support/WatchUpdatingTracking ../../../geometry/ellipsoidUtils ./PrecipitationTechnique ./PrecipitationTechniqueConfiguration ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/AnimationTimer ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Util".split(" "),
function(c,r,h,B,t,k,C,l,J,K,L,D,E,F,d,m,u,v,G,H,w,x,p,y){c.Precipitation=function(z){function n(a){var b=z.call(this,a)||this;b._numParticles=25E4;b._rainSpeed=.1;b._snowSpeed=.01;b._passParameters=new d.PrecipitationPassParameters;b._animation=new G.AnimationTimer;b._updatingTracking=new E.WatchUpdatingTracking;b._passParameters.time=0;b._passParameters.radius=F.getReferenceEllipsoid(a.view.spatialReference).radius;b._techniqueRepository=a.context.techniqueRepository;return b}r._inherits(n,z);var e=
n.prototype;e.destroy=function(){this._updatingTracking.destroy();this._numParticles=0;this._snowTechniqueCached=k.releaseMaybe(this._snowTechniqueCached);this._rainTechniqueCached=k.releaseMaybe(this._rainTechniqueCached);this._vao=k.disposeMaybe(this._vao);this._instanceIdBuffer=k.disposeMaybe(this._instanceIdBuffer)};e.update=function(a){return this._animation.advance(a)};e.render=function(a,b,f){const q="rainy"===f?this._rainTechnique:this._snowTechnique;if(q.compiled){var g=a.rctx;this._ensureResources(g);
null!=q&&null!=this._vao&&null!=this._instanceIdBuffer&&(null!=a.bindParameters.cloudsFade.data&&(this._passParameters.opacity=1-a.bindParameters.cloudsFade.fadeInOutHeight.factor),0>=this._passParameters.opacity||(b=.5>b?t.lerp(0,.35,2*b):t.lerp(.35,1,2*(b-.5)),this._passParameters.time=("rainy"===f?this._rainSpeed:this._snowSpeed)*C.secondsFromMilliseconds(this._animation.time)%1E5,a=g.bindTechnique(q,this._passParameters,a.bindParameters),g.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),
y.bindVertexBufferLayout(g,d.attributeLocations,this._instanceIdBuffer,A,0),g.capabilities.instancing?.drawArraysInstanced(p.PrimitiveType.TRIANGLES,0,3,this._numParticles*b),y.unbindVertexBufferLayout(g,d.attributeLocations,this._instanceIdBuffer,A)))}else this.context.requestRender()};e._ensureResources=function(a){null==this._vao&&(this._vao=this._createVertexArrayObject(a));null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(a))};e._createInstanceIndices=function(a){const b=
[];for(let f=0;f<this._numParticles;f++)b.push(f);return x.BufferObject.createVertex(a,p.Usage.STATIC_DRAW,new Float32Array(b))};e._createVertexArrayObject=function(a){const b=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new H.VertexArrayObject(a,d.attributeLocations,{geometry:u.glLayout(I)},{geometry:x.BufferObject.createVertex(a,p.Usage.STATIC_DRAW,b)})};r._createClass(n,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if(null==this._rainTechniqueCached){const a=
new m.PrecipitationTechniqueConfiguration;a.type=m.PrecipitationType.Rain;this._rainTechniqueCached=this._techniqueRepository.acquire(d.PrecipitationTechnique,a)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if(null==this._snowTechniqueCached){const a=new m.PrecipitationTechniqueConfiguration;a.type=m.PrecipitationType.Snow;this._snowTechniqueCached=this._techniqueRepository.acquire(d.PrecipitationTechnique,a)}return this._snowTechniqueCached}}]);return n}(B);h.__decorate([l.property({constructOnly:!0})],
c.Precipitation.prototype,"context",void 0);h.__decorate([l.property({constructOnly:!0})],c.Precipitation.prototype,"view",void 0);h.__decorate([l.property({readOnly:!0})],c.Precipitation.prototype,"updating",null);h.__decorate([l.property()],c.Precipitation.prototype,"_updatingTracking",void 0);c.Precipitation=h.__decorate([D.subclass("esri.views.3d.environment.Precipitation")],c.Precipitation);const I=v.newLayout().vec3f(w.VertexAttribute.POSITION),A=u.glLayout(v.newLayout().f32(w.VertexAttribute.INSTANCEFEATUREATTRIBUTE),
1);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
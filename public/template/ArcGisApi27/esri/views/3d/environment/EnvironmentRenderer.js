// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/support/spatialReferenceUtils ../../ViewingMode ./AtmosphereType ./ChapmanAtmosphere ./CloudsComposition ./CloudsCompositionParameters ./CloudsData ./CloudsGenerator ./CloudsPresets ./Fog ./LocalAtmosphere ./MarsAtmosphere ./Precipitation ./Stars ./weather ./weatherUtils ../webgl-engine/core/shaderLibrary/ShaderOutput ../webgl-engine/lib/RenderFeature ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/Update".split(" "),
function(d,x,e,J,Y,p,f,k,h,Z,aa,K,q,z,A,y,L,l,B,M,C,D,N,O,E,P,Q,R,S,T,F,U,G,u,V){var r;const W=[u.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE,u.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];d.EnvironmentRenderer=r=function(t){function n(a){a=t.call(this,a)||this;a._context=null;a._atmosphere=null;a._oldWeatherParameters=new v;a._newWeatherParameters=new v;a._fadedWeatherParameters=new v;a._weatherParameters=a._newWeatherParameters;return a}x._inherits(n,t);var c=n.prototype;c.initialize=function(){this.view._stage.addRenderPlugin(W,
this)};c.destroy=function(){this.removeHandles();this.uninitializeRenderContext();null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this);this._set("view",null)};c.updateAnimation=function(a){return null!=this._precipitation?this._precipitation.update(a):!1};c.initializeRenderContext=function(a=null){this._context=a;a=()=>this._setNeedsRender();this.addHandles([k.watch(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),b=>this._updateAtmosphere(b),
k.syncAndInitial),k.watch(()=>this._stars,a),k.watch(()=>this._precipitation,a),k.watch(()=>this._clouds,()=>this._updateWeather(),k.initial),k.watch(()=>this._fog,()=>this._updateFogHaze(),k.initial),k.watch(()=>this.view.state.mode,()=>{this._setNeedsRender()},k.sync),k.watch(()=>this._weatherUpdateParameters,()=>{this._updateWeather();this._updateFogHaze()},k.syncAndInitial)])};c.uninitializeRenderContext=function(){this._context=null;this._atmosphere=f.destroyMaybe(this._atmosphere);this._set("_stars",
f.destroyMaybe(this._stars));this._set("_precipitation",f.destroyMaybe(this._precipitation));this._set("_clouds",f.destroyMaybe(this._clouds));this._set("_cloudsComposition",f.destroyMaybe(this._cloudsComposition));this._set("_fog",f.destroyMaybe(this._fog))};c.prepareRender=function(a){a.bindParameters.cloudsFade.data=D.isReadyCloudsData(this._clouds)?this._clouds:null;"local"!==this.view.viewingMode&&null!=a.bindParameters.cloudsFade.data?.cubeMap&&(F.updateWeatherFading(a.bindParameters.cloudsFade,
a.bindParameters.camera,this.view.state.mode,a.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(a.bindParameters),a.bindParameters.cloudsFade.renderingStage===D.CloudsRenderingStages.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),a.bindParameters.cloudsFade.data=null))};c.render=function(a){if(a.output===U.ShaderOutput.Color)switch(a.bindParameters.slot){case u.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE:null!=
this._stars&&this._stars.render(a);null!=this.atmosphere&&(this.atmosphere.render(a,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(G.RenderFeature.HighResolutionAtmosphere)),null!=this._cloudsComposition&&null!=a.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(a)),F.weatherFadingNeedsRender(a.bindParameters.cloudsFade)&&null!=this._context&&null!=a.bindParameters.cloudsFade.data?.cubeMap&&
this._context.requestRender());break;case u.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(a,this._weatherParameters.hazeAmount,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(G.RenderFeature.HighResolutionAtmosphere)),0<this._weatherParameters.fog.amount&&null!=this._fog&&this._fog.render(a,this._weatherParameters.fog),null!=this._precipitation)){const b=this.view.environment.weather;"rainy"!==
b.type&&"snowy"!==b.type||this._precipitation.render(a,b.precipitation,b.type)}}};c.updateLightSources=function(a,b,g,w){if(null!=this._context){const m=this._context.renderContext;m.bindParameters.oldLighting.copyFrom(m.bindParameters.lighting);m.bindParameters.newLighting.noonFactor=b;m.bindParameters.newLighting.globalFactor=g;m.bindParameters.newLighting.set(a);w===V.Update.Faded||m.bindParameters.weatherFading?m.bindParameters.fadeLighting(0):m.bindParameters.fadeLighting(1);this._context.requestRender()}};
c._updateWeatherFading=function(a){if(a.weatherFading){var b=a.cloudsFade;b.fadeIn.stage===C.FadeInStages.FADE_IN?(a.fadeLighting(b.fadeIn.factor),this._fadeWeather(b.fadeIn.factor)):b.fadeInOut.stage===C.FadeInOutStages.FADE_IN?(a.fadeLighting(b.fadeInOut.factor),this._fadeWeather(b.fadeInOut.factor)):b.crossFade.enabled?(a.fadeLighting(b.crossFade.factor),this._fadeWeather(b.crossFade.factor)):(a.fadeLighting(0),this._fadeWeather(0))}};c._fadeWeather=function(a){const {_newWeatherParameters:b,_oldWeatherParameters:g}=
this;1<=a?this._weatherParameters=b:(this._fadedWeatherParameters.lerp(g,b,a),this._weatherParameters=this._fadedWeatherParameters)};c._updateWeather=function(){const a=this._weatherUpdateParameters;null!=a&&null!=this._clouds&&(this._clouds.applyPreset(O.cloudPresets[a.type],a.weatherAdjustment),this._setNeedsRender())};c._setNeedsRender=function(){null!=this._context&&this._context.requestRender()};c._updateFogHaze=function(){const a=this._weatherUpdateParameters;if(null!=this._fog&&null!=a&&null!=
this._context){var b=this._context.renderContext.bindParameters;this._oldWeatherParameters.copyFrom(this._weatherParameters);switch(a.type){case "foggy":this._newWeatherParameters.fog.strength=p.lerp(3E-5,.005,a.weatherAdjustment**3);q.copy(this._newWeatherParameters.fog.color,H);this._newWeatherParameters.fog.amount=1;this._newWeatherParameters.hazeAmount=1;this._setNeedsRender();break;case "rainy":this._newWeatherParameters.fog.strength=p.lerp(4E-6,2E-4,(a.effect??0)**3);q.copy(this._newWeatherParameters.fog.color,
X);this._newWeatherParameters.fog.amount=1;this._newWeatherParameters.hazeAmount=0;this._setNeedsRender();break;case "snowy":this._newWeatherParameters.fog.strength=p.lerp(4E-6,2E-4,(a.effect??0)**3);q.copy(this._newWeatherParameters.fog.color,H);this._newWeatherParameters.fog.amount=1;this._newWeatherParameters.hazeAmount=1;this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}b.weatherFading?
this._fadeWeather(0):this._fadeWeather(1)}};c._updateAtmosphere=function(a){a=this._selectAtmosphereType(a);if(a===l.AtmosphereType.None||!this._context)this._atmosphere=f.destroyMaybe(this._atmosphere);else if(!this._atmosphere||this._atmosphere.type!==a)if(this._atmosphere=f.destroyMaybe(this._atmosphere),a=this._getAtmosphereClass(a))this._atmosphere=new a(this.view,this._context);this._setNeedsRender()};c._getAtmosphereClass=function(a){switch(a){case l.AtmosphereType.Realistic:return B.ChapmanAtmosphere;
case l.AtmosphereType.Local:return P.LocalAtmosphere;case l.AtmosphereType.Mars:return Q;default:case l.AtmosphereType.None:return null}};c._selectAtmosphereType=function(a){const {enabled:b,viewingMode:g}=a;return!b||y.isMoon(this.view.spatialReference)?l.AtmosphereType.None:g===L.ViewingMode.Local?l.AtmosphereType.Local:null!=this._context&&B.ChapmanAtmosphere.isSupported(this._context)&&y.isEarth(this.view.spatialReference)?l.AtmosphereType.Realistic:y.isMars(this.view.spatialReference)?l.AtmosphereType.Mars:
l.AtmosphereType.None};x._createClass(n,[{key:"atmosphere",get:function(){return this._atmosphere}},{key:"_atmosphereType",get:function(){return null!=this.atmosphere?this.atmosphere.type:l.AtmosphereType.None}},{key:"canRender",get:function(){return!(null===this._atmosphere&&null===this._stars)}},{key:"needsLinearDepth",get:function(){return this._atmosphereType===l.AtmosphereType.Realistic}},{key:"updating",get:function(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}},
{key:"weatherVisible",get:function(){return q.length(this.view.state.camera.eye)-A.getReferenceEllipsoid(this.view.spatialReference).radius<=T.weatherHeightLimit}},{key:"_stars",get:function(){const a=this.view,b=a.environment?.starsEnabled??!1,g=this._get("_stars");return b&&null!=this._context?null!=g?g:new S.Stars({view:a,requestRender:()=>this._setNeedsRender()}):(f.destroyMaybe(g),null)}},{key:"_precipitation",get:function(){const a=this._get("_precipitation");if(!this._precipitationEnabled||
null==this._context)return f.destroyMaybe(a),null;const b=this.view,g=this._context;if(null!=a&&a.context===g)return a;f.destroyMaybe(a);return new R.Precipitation({context:g,view:b})}},{key:"_clouds",get:function(){const a=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return f.destroyMaybe(a),null;if(null!=a)return a;const b=this.view,g=this._context;f.destroyMaybe(a);return new N.CloudsGenerator({context:g,view:b,requestRender:()=>this._setNeedsRender()})}},{key:"_cloudsComposition",
get:function(){const a=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return f.destroyMaybe(a),null;const b=this.view.state.viewingMode,g=this._context.renderContext.rctx,w=A.getReferenceEllipsoid(this.view.spatialReference).radius;if(null!=a&&a.viewingMode===b&&a.planetRadius===w)return a;f.destroyMaybe(a);return new M.CloudsComposition({rctx:g,viewingMode:b,planetRadius:w,requestRender:()=>this._setNeedsRender()})}},{key:"_fog",get:function(){const a=this._get("_fog");
return this.weatherEnabled&&null!=this._context?null!=a?a:new E.Fog({context:this._context,view:this.view,rctx:this._context.renderContext.rctx,viewingMode:this.view.state.viewingMode}):(f.destroyMaybe(a),null)}},{key:"weatherEnabled",get:function(){return!!this.view?.environmentManager?.weatherEnabled}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"_weatherUpdateParameters",
get:function(){const a=this.weatherEnabled?this.view.environment.weather:null;return null==a?null:"rainy"===a.type||"snowy"===a.type?{type:a.type,weatherAdjustment:a.cloudCover,effect:a.precipitation}:{type:a.type,weatherAdjustment:"foggy"===a.type?a.fogStrength:a.cloudCover}}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),
stubGetAtmosphereClass:a=>{I=r.prototype._getAtmosphereClass;r.prototype._getAtmosphereClass=a},restoreGetAtmosphereClass:()=>{r.prototype._getAtmosphereClass=I}}}}]);return n}(J);e.__decorate([h.property({constructOnly:!0})],d.EnvironmentRenderer.prototype,"view",void 0);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"atmosphere",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_atmosphereType",null);e.__decorate([h.property({type:Boolean,
readOnly:!0})],d.EnvironmentRenderer.prototype,"updating",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"weatherVisible",null);e.__decorate([h.property()],d.EnvironmentRenderer.prototype,"_context",void 0);e.__decorate([h.property()],d.EnvironmentRenderer.prototype,"_atmosphere",void 0);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_stars",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_precipitation",null);
e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_clouds",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_cloudsComposition",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_fog",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"weatherEnabled",null);e.__decorate([h.property({readOnly:!0})],d.EnvironmentRenderer.prototype,"_precipitationEnabled",null);e.__decorate([h.property({readOnly:!0})],
d.EnvironmentRenderer.prototype,"_weatherUpdateParameters",null);d.EnvironmentRenderer=r=e.__decorate([K.subclass("esri.views.3d.environment.EnvironmentRenderer")],d.EnvironmentRenderer);let v=function(){function t(){this.fog=new E.FogParameters;this.hazeAmount=1}var n=t.prototype;n.copyFrom=function(c){this.fog.amount=c.fog.amount;this.hazeAmount=c.hazeAmount;this.fog.strength=c.fog.strength;q.copy(this.fog.color,c.fog.color)};n.lerp=function(c,a,b){this.fog.amount=p.lerp(c.fog.amount,a.fog.amount,
b);this.hazeAmount=p.lerp(c.hazeAmount,a.hazeAmount,b);this.fog.strength=p.lerp(c.fog.strength,a.fog.strength,b);q.lerp(this.fog.color,c.fog.color,a.fog.color,b)};return x._createClass(t)}();const X=z.fromValues(.5,.5,.5),H=z.fromValues(1.5,1.5,1.5);let I;d.WeatherParameters=v;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
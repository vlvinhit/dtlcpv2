// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/mathUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/ellipsoidUtils ../../camera/constraintUtils ../../camera/constraintUtils/ConstraintTypes ../../camera/constraintUtils/InteractionType ../../camera/constraintUtils/TiltMode ../Constraints ./InteractiveController ../utils/navigationUtils".split(" "),
function(c,x,y,z,E,F,M,N,O,G,A,H,I,B,d,k,J,K,r,u,v,C,L,g){c.PivotPoint=void 0;(function(m){m[m.CENTER=0]="CENTER";m[m.EYE=1]="EYE"})(c.PivotPoint||(c.PivotPoint={}));c.RotateController=function(m){function t(a){a=m.call(this,a)||this;a.pivot=c.PivotPoint.CENTER;a._rotScale=0;a._lastPoint=B.create();a._tmpWorldUp=k.create();a._tmpViewDir=k.create();a._tmpRotCurPoint=B.create();a._tmpTransf=H.create();a._tmpAxis=k.create();a._tmpPivotPoint=k.create();a._pivotPos=k.create();a._constraintOptions={selection:r.ConstraintTypes.ALL,
interactionType:u.InteractionType.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:v.TiltMode.TUMBLE};return a}x._inherits(t,m);var n=t.prototype;n.initialize=function(){this._rotScale=this.pivot===c.PivotPoint.CENTER?3:1.5};n.begin=function(a){if(this.active){switch(this.pivot){case c.PivotPoint.EYE:d.copy(this._pivotPos,this.startCamera.eye);this._constraintOptions.interactionType=u.InteractionType.LOOK_AROUND;this._constraintOptions.tiltMode=v.TiltMode.LOOK_AROUND;
this._constraintOptions.selection=r.ConstraintTypes.NONE;break;case c.PivotPoint.CENTER:const e=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?g.contentIntersectorOptions:{});e||d.copy(this._pivotPos,this.startCamera.center);this._constrainPivotPoint(a,e);this.startCamera.center=this._pivotPos;this._constraintOptions.interactionType=u.InteractionType.TUMBLE;this._constraintOptions.tiltMode=v.TiltMode.TUMBLE;this._constraintOptions.selection=
r.ConstraintTypes.ALL&~r.ConstraintTypes.DISTANCE}this._constraintOptions.interactionStartCamera=this.startCamera;g.normalizeCoordinate(this.startCamera,a,this._lastPoint)}};n._constrainPivotPoint=function(a,e){const b=this.startCamera,h=k.create();d.subtract(h,this._pivotPos,b.eye);const p=d.length(h);var f=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(b.eye,D);f=Math.max(Math.min(g.ROTATE_PIVOT_DISTANCE_MODIFIER,1/Math.abs(d.dot(D,b.viewForward)))*f,g.ROTATE_PIVOT_MIN_DISTANCE_MODIFIER);
e&&(f=Math.min(p,f));var q=J.getReferenceEllipsoid(this.view.spatialReference),l=E.createScreenPointArray(b.width/b.pixelRatio*.5,b.height/b.pixelRatio*.5);q=g.decideNavigationMode(this.startCamera,l,q);l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,b.fullWidth/b.pixelRatio*.5,b.fullHeight/b.pixelRatio*.5,b,2.5*g.ROTATE_SCREEN_PIXEL_AREA,g.ROTATE_SCREEN_PIXEL_AREA);a=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,a[0],a[1],b,g.ROTATE_SCREEN_PIXEL_AREA);
if(null!=l||null!=a)l=l??a??0,a=null==a||q===g.NavigationMode.Horizontal?l:a,f=l>a?a:l,f=e?Math.min(f,p):f;d.normalize(h,h);d.copy(this._pivotPos,d.add(this._tmpPivotPoint,b.eye,d.scale(this._tmpPivotPoint,h,f)))};n.update=function(a){if(this.active){switch(this.pivot){case c.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,a,this.currentCamera.center,this._pivotPos);break;case c.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,
a,this.currentCamera.eye,this._pivotPos)}K.applyAll(this.view,this.currentCamera,this._constraintOptions);this.commitCamera()}};n.end=function(){this.active&&this.finishController()};n._applyRotation=function(a,e,b,h){this.view.renderCoordsHelper.worldUpAtPosition(h,this._tmpWorldUp);g.normalizeCoordinate(a,e,this._tmpRotCurPoint);e=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale;let p=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;d.subtract(this._tmpViewDir,b,h);b=d.length(this._tmpViewDir);
b=z.acosClamped(d.dot(this._tmpViewDir,this._tmpWorldUp)/b);if(this.pivot===c.PivotPoint.EYE){const f=.5*Math.PI-b,q=.495*Math.PI;e=f-Math.max(-q,Math.min(q,f+-.5*e))}e=z.clamp(e+b,C.TiltDefault.min,C.TiltDefault.max)-b;d.cross(this._tmpAxis,a.up,this._tmpViewDir);this.pivot===c.PivotPoint.CENTER&&(p=-p);A.fromRotation(this._tmpTransf,p,this._tmpWorldUp);A.rotate(this._tmpTransf,this._tmpTransf,e,this._tmpAxis);d.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf);a.up=d.transformMat4(w,
a.up,this._tmpTransf);d.add(w,h,this._tmpViewDir);I.copy(this._lastPoint,this._tmpRotCurPoint);return w};x._createClass(t,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]);return t}(L.InteractiveController);y.__decorate([F.property()],c.RotateController.prototype,"pivot",void 0);c.RotateController=y.__decorate([G.subclass("esri.views.3d.state.controllers.RotateController")],c.RotateController);const w=k.create(),D=k.create();Object.defineProperty(c,Symbol.toStringTag,
{value:"Module"})});
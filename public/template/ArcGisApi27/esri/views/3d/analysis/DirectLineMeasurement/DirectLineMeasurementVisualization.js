// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../intl ../../../../core/Accessor ../../../../core/analysisThemeUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/quantityFormatUtils ../../../../core/quantityUtils ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../interfaces ./interfaces ../support/viewUtils ../../interactive/visualElements/LabelVisualElement ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/MeasurementArrowVisualElement ../../interactive/visualElements/RightAngleQuadVisualElement ../../interactive/visualElements/support/Segment ../../webgl-engine/lib/Material ../../webgl-engine/materials/lineStippleUtils ../../../../intl/locale ../../../../intl/messages".split(" "),
function(k,L,l,G,fa,S,z,T,M,v,r,H,w,A,N,m,ha,ia,ja,U,O,P,B,V,g,I,C,D,W,X,x,E,J,Y,Z){k.DirectLineMeasurementVisualization=function(Q){function F(a){a=Q.call(this,a)||this;a._params={triangleColor:G.toUnitRGBA(z.getAccentColor(.75)),triangleLineWidth:3,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:G.toUnitRGBA(z.getAccentColor(.75)),guideLineWidth:2,guideStippleLengthPixels:6,directLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12};a._handles=new T;a._segmentVisualElement=
null;a._triangleVisualElement=null;a._rightAngleQuad=null;a._projectedGeodesicLine=null;a._geodesicStartHint=null;a._geodesicEndHint=null;a._segmentLabel=null;a._verticalLabel=null;a._horizontalLabel=null;a._startPosition=B.create();a._endPosition=B.create();a._cornerPosition=B.create();a._startPositionAtSeaLevel=B.create();a._endPositionAtSeaLevel=B.create();a._triangleOrientationOverride=null;a.messages=null;a.loadingMessages=!0;a.visualElementOrientation=g.VisualElementOrientation.Auto;a.triangleCollapseRatioThreshold=
.03;return a}L._inherits(F,Q);var t=F.prototype;t.initialize=function(){const a=this._params;var b={attached:!0,view:this.view};this._segmentVisualElement=new W.MeasurementArrowVisualElement({...b,geometry:null,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});this._triangleVisualElement=new D.LineVisualElement({...b,width:a.triangleLineWidth,color:a.triangleColor,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});this._rightAngleQuad=new X.RightAngleQuadVisualElement({...b,color:G.toUnitRGBA(z.getAccentColor(.75)),
renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});const c={...b,polygonOffset:!0,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent};this._projectedGeodesicLine=new D.LineVisualElement({...c,width:a.geodesicProjectionLineWidth,color:a.geodesicProjectionLineColor,stipplePattern:J.createStipplePatternSimple(a.guideStippleLengthPixels)});this._geodesicStartHint=new D.LineVisualElement({...c,width:a.guideLineWidth,color:a.geodesicProjectionLineColor,stipplePattern:J.createStipplePatternSimple(a.guideStippleLengthPixels)});
this._geodesicEndHint=new D.LineVisualElement({...c,width:a.guideLineWidth,color:a.geodesicProjectionLineColor,stipplePattern:J.createStipplePatternSimple(a.guideStippleLengthPixels)});b={...b,backgroundColor:z.getTextHaloColor(.6),calloutColor:z.getTextHaloColor(.5),textColor:z.getTextColor()};this._segmentLabel=new C.LabelVisualElement({...b,fontSize:a.directLabelFontSize});this._verticalLabel=new C.LabelVisualElement({...b,fontSize:a.verticalLabelFontSize});this._horizontalLabel=new C.LabelVisualElement({...b,
fontSize:a.horizontalLabelFontSize});this._handles.add([w.watch(()=>{const {elevationAlignedStartPoint:e,elevationAlignedEndPoint:d}=this.analysisView,f=this.view;return{view:f,camera:f.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:d,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}},e=>this._updateGeometryAndViewMode(e),w.syncAndInitial),w.watch(()=>
({visible:this.visible,viewMode:this.viewMode}),e=>this._updateVisualElementVisibility(e),w.syncAndInitial),w.watch(()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement}),e=>this._updateLabelText(e),w.syncAndInitial),w.watch(()=>({visible:this.visible,viewMode:this.viewMode}),e=>this._updateLabelVisibility(e),w.syncAndInitial),w.watch(()=>this._measurementArrowStripeLength,e=>this._updateSegmentStripeLength(e),w.syncAndInitial),Y.onLocaleChange(async()=>this._updateMessageBundle())]);
this._updateMessageBundle()};t.destroy=function(){this._handles=v.destroyMaybe(this._handles);this._segmentVisualElement=v.destroyMaybe(this._segmentVisualElement);this._triangleVisualElement=v.destroyMaybe(this._triangleVisualElement);this._rightAngleQuad=v.destroyMaybe(this._rightAngleQuad);this._projectedGeodesicLine=v.destroyMaybe(this._projectedGeodesicLine);this._geodesicStartHint=v.destroyMaybe(this._geodesicStartHint);this._geodesicEndHint=v.destroyMaybe(this._geodesicEndHint);this._segmentLabel=
v.destroyMaybe(this._segmentLabel);this._verticalLabel=v.destroyMaybe(this._verticalLabel);this._horizontalLabel=v.destroyMaybe(this._horizontalLabel);this.set("view",null)};t._updateVisualElementVisibility=function({visible:a,viewMode:b}){this._segmentVisualElement.visible=!1;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=!1;this._geodesicEndHint.visible=!1;if(a)switch(b){case g.ViewMode.Direct:this._segmentVisualElement.visible=
!0;break;case g.ViewMode.Triangle:this._segmentVisualElement.visible=!0;this._triangleVisualElement.visible=!0;this._rightAngleQuad.visible=!0;break;case g.ViewMode.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}};t._updateGeometryAndViewMode=function({view:a,camera:b,viewMode:c,elevationAlignedStartPoint:e,elevationAlignedEndPoint:d,orientation:f,visualizedMeasurement:q,stripeLength:u}){const h=
a.renderCoordsHelper;if(null!=h&&null!=e&&null!=d&&!e.equals(d)){var n=this._startPosition,p=this._endPosition;h.toRenderCoords(e,n);h.toRenderCoords(d,p);e=f===g.VisualElementOrientation.AboveSegment?1:-1;d=h.getAltitude(p);var y=h.getAltitude(n);d=e*(d-y);0>d&&(n=this._endPosition,p=this._startPosition);q="geodesic"===q?new x.GeodesicSegment(this._startPosition,this._endPosition,h.spatialReference):new x.EuclideanSegment(this._startPosition,this._endPosition);this._segmentVisualElement.geometry=
q;this._updateSegmentStripeLength(u);switch(c){case g.ViewMode.Direct:this._updateSegment(q,f);break;case g.ViewMode.Triangle:this._updateSegmentAndTriangle({view:a,camera:b,segment:q,orientation:f,startPosition:n,endPosition:p,deltaSign:e,altitudeDelta:d});break;case g.ViewMode.ProjectedGeodesic:this._updateSegmentAndProjection({view:a,orientation:f,startPosition:n,endPosition:p})}}};t._updateSegment=function(a,b){this._segmentLabel.anchor=b===g.VisualElementOrientation.AboveSegment?"top":"bottom";
this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"}};t._updateSegmentAndTriangle=function({view:{renderCoordsHelper:a},camera:b,segment:c,orientation:e,startPosition:d,endPosition:f,deltaSign:q,altitudeDelta:u}){const h=this._cornerPosition;a.worldUpAtPosition(d,h);P.scale(h,h,q*Math.abs(u));P.add(h,h,d);this._triangleVisualElement.geometry=[[[d[0],d[1],d[2]],[h[0],h[1],h[2]],[f[0],f[1],f[2]]]];this._rightAngleQuad.geometry={previous:d,center:h,next:f};a=new x.EuclideanSegment(d,
h);q=new x.EuclideanSegment(h,f);var n=aa,p=ba;b.projectToRenderScreen(h,n);b.projectToRenderScreen(f,p);u="bottom";var y="top";n=n[0]<p[0]?"left":"right";const K=ca;p=da;I.screenSpaceTangent(d,h,K,b);I.screenSpaceTangent(d,f,p,b);O.dot(K,p)>=R?u=Math.sign(K[1])===Math.sign(p[1])?C.mirrorPosition(n):n:(d=ea,I.screenSpaceTangent(h,f,d,b),O.dot(d,p)>=R&&(u=Math.sign(d[0])===Math.sign(p[0])?C.mirrorPosition(y):y));e===g.VisualElementOrientation.BelowSegment&&(u="top"===u?"bottom":"top",y="top"===y?"bottom":
"top",n="top"===n?"bottom":"top");this._segmentLabel.anchor=u;this._segmentLabel.geometry={type:"segment",segment:c,sampleLocation:"center"};this._verticalLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._verticalLabel.anchor=n;this._horizontalLabel.geometry={type:"segment",segment:q,sampleLocation:"center"};this._horizontalLabel.anchor=y};t._updateSegmentAndProjection=function({view:{renderCoordsHelper:a},orientation:b,startPosition:c,endPosition:e}){a.setAltitude(this._startPositionAtSeaLevel,
0,c);a.setAltitude(this._endPositionAtSeaLevel,0,e);a=new x.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,a.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a);this._geodesicStartHint.setGeometryFromSegment(new x.EuclideanSegment(this._startPositionAtSeaLevel,c));this._geodesicEndHint.setGeometryFromSegment(new x.EuclideanSegment(this._endPositionAtSeaLevel,e));this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._segmentLabel.anchor=
b===g.VisualElementOrientation.AboveSegment?"top":"bottom"};t._updateLabelText=function({text:a,visualizedMeasurement:b}){null!=a?(this._segmentLabel.text="euclidean"===b?a.euclideanDistance:a.geodesicDistance,this._horizontalLabel.text=a.horizontalDistance,this._verticalLabel.text=a.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null);this.notifyChange("labels")};t._updateLabelVisibility=function({visible:a,viewMode:b}){const c=this._segmentLabel,
e=this._horizontalLabel,d=this._verticalLabel;c.visible=!1;e.visible=!1;d.visible=!1;if(a)switch(b){case g.ViewMode.Direct:c.visible=!0;break;case g.ViewMode.Triangle:c.visible=!0;e.visible=!0;d.visible=!0;break;case g.ViewMode.ProjectedGeodesic:c.visible=!0}};t._updateSegmentStripeLength=function(a){const b=this._segmentVisualElement;null!=a?(b.stripeLength=a,b.stripesEnabled=!0):b.stripesEnabled=!1};t._requiresGeodesicGuideAt=function(a){var b=this.view;if(!b?.state)return!1;const c=b.renderCoordsHelper;
if(!c)return!1;b=b.state.camera.computeScreenPixelSizeAt(a);return 10<=c.getAltitude(a)/b};t._updateMessageBundle=function(){this.loadingMessages=!0;Z.fetchMessageBundle("esri/core/t9n/Units").then(a=>{this.messages=a}).finally(()=>{this.loadingMessages=!1})};L._createClass(F,[{key:"visible",get:function(){return this.analysisView.visible}},{key:"viewMode",get:function(){const {elevationAlignedStartPoint:a,elevationAlignedEndPoint:b}=this.analysisView;if(null==a||null==b||a.equals(b))return g.ViewMode.None;
var c=this.analysisView.result;if(null==c)return g.ViewMode.Direct;if("geodesic"===c.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?g.ViewMode.ProjectedGeodesic:g.ViewMode.Direct;const {verticalDistance:e,horizontalDistance:d}=c;c=e.value;const f=d.value;return Math.min(c/f,f/c)<this.triangleCollapseRatioThreshold?g.ViewMode.Direct:g.ViewMode.Triangle}},{key:"actualVisualizedMeasurement",get:function(){if(null==this.analysisView.result)switch(this.analysisView.measurementMode){default:return"euclidean";
case V.MeasurementMode.Geodesic:return"geodesic"}return this.analysisView.result.mode}},{key:"allowVisualElementsOrientationChange",get:function(){return null==this._triangleOrientationOverride},set:function(a){null==this._triangleOrientationOverride!==a&&(this._triangleOrientationOverride=null==this._triangleOrientationOverride?this._actualVisualElementsOrientation:null)}},{key:"labels",get:function(){return{direct:this._segmentLabel,horizontal:"geodesic"===this.actualVisualizedMeasurement?this._segmentLabel:
this._horizontalLabel,vertical:this._verticalLabel}}},{key:"_labelsText",get:function(){if(this.destroyed)return null;const a=this.messages;var b=this.analysisView.result;if(null==b||null==a)return null;const {directDistance:c,horizontalDistance:e,verticalDistance:d,geodesicDistance:f}=b;b=this.analysisView.unit;const q=u=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...u});switch(b){case "metric":return q({euclideanDistance:c&&r.formatMetricLength(a,c),geodesicDistance:f&&
r.formatMetricLength(a,f),horizontalDistance:e&&r.formatMetricLength(a,e),verticalDistance:d&&r.formatMetricVerticalLength(a,d)});case "imperial":return q({euclideanDistance:c&&r.formatImperialLength(a,c),geodesicDistance:f&&r.formatImperialLength(a,f),horizontalDistance:e&&r.formatImperialLength(a,e),verticalDistance:d&&r.formatImperialVerticalLength(a,d)});default:return q({euclideanDistance:c&&r.formatDecimal(a,c,b),geodesicDistance:f&&r.formatDecimal(a,f,b),horizontalDistance:e&&r.formatDecimal(a,
e,b),verticalDistance:d&&r.formatDecimal(a,d,b)})}}},{key:"_actualVisualElementsOrientation",get:function(){if(null!=this._triangleOrientationOverride)return this._triangleOrientationOverride;const a=this.visualElementOrientation;return a===g.VisualElementOrientation.Auto?this.view.state.camera.aboveGround?g.VisualElementOrientation.AboveSegment:g.VisualElementOrientation.BelowSegment:a}},{key:"_measurementArrowStripeLength",get:function(){const {result:a,unit:b}=this.analysisView;if(null==a)return null;
var c=null;c=a.directDistance;switch(b){case "metric":c=c&&H.toUnit(c,"meters");break;case "imperial":c=c&&H.toUnit(c,N.preferredImperialLengthUnit(c.value,c.unit));break;default:c=c&&H.toUnit(c,b)}return null==c?null:M.nextHighestPowerOfTen(c.value/30)*N.convertUnit(1,c.unit,"meters")}},{key:"testData",get:function(){return{labels:this.labels,stripeLength:this._segmentVisualElement?.stripeLength}}}]);return F}(S);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",
void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"messages",void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"view",void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"analysis",void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"analysisView",void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"loadingMessages",void 0);l.__decorate([m.property()],
k.DirectLineMeasurementVisualization.prototype,"visible",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"viewMode",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"triangleCollapseRatioThreshold",void 0);l.__decorate([m.property()],
k.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"labels",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"_labelsText",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null);l.__decorate([m.property()],k.DirectLineMeasurementVisualization.prototype,"_measurementArrowStripeLength",null);
k.DirectLineMeasurementVisualization=l.__decorate([U.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],k.DirectLineMeasurementVisualization);const R=Math.cos(M.deg2rad(12)),aa=A.createRenderScreenPointArray3(),ba=A.createRenderScreenPointArray3(),ca=A.createRenderScreenPointArray(),da=A.createRenderScreenPointArray(),ea=A.createRenderScreenPointArray();Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../core/Cyclical ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/plane ../../../../geometry/support/vectorStacks ../../../../layers/graphics/hydratedFeatures ./lengthDimensionUtils ./settings ../../interactive/Manipulator3D ../../interactive/manipulatorUtils ../../interactive/RenderObject ../../interactive/editingTools/dragEventPipeline3D ../../interactive/visualElements/support/Segment ../../support/engineContent/marker ../../webgl-engine/lib/GeometryUtil ../../../interactive/dragEventPipeline ../../../interactive/interfaces ../../../../geometry/Point".split(" "),
function(l,aa,O,P,E,I,ba,J,K,ca,m,p,w,z,da,k,u,Q,x,F,C,ea,fa,L,y,D,ha){function R(c,{lineSizePt:a,material:b}){const {calloutOffsetPx:d,calloutWidth:e,discScale:f,focusMultiplier:h,color:g}=u.settings.orientationManipulator;return{calloutLength:.25*fa.MARKER_SIZE_PER_LINE_WIDTH*u.settings.markers.lineSizeFraction*J.pt2px(a)+d,calloutColor:O.toUnitRGBA(g),calloutWidth:e,customStateMask:A,discScale:f,focusMultiplier:h,material:b,metadata:c}}function S(c){const {cancel:a,computation:b,settingHeading:d,
steps:e,view:f}=c;if(k.isValidComputation(b)){({renderCoordsHelper:c}=f);var {dimension:h,geometry:g}=b,n=p.create(),t=T(p.create(),g,g.directSegment,c);c=U(z.sv3d.get(),{forHeading:d,geometry:g,renderCoordsHelper:c});var r=w.fromPositionAndNormal(t,c,w.create()),v=d?h.orientation??k.headingFromGeometry(g,f.renderCoordsHelper):h.orientation??0;e.next(C.screenToRenderPlane(f,r)).next(q=>{"start"===q.action&&m.copy(n,q.renderStart);const B=w.normal(r);q=x.calculateInputRotationTransform(n,q.renderEnd,
t,B);q=v-ba.rad2deg(q);d||(q=V(q));h.orientation=q});a.next(y.resetProperties(h,["orientation"]))}}function V(c){const a=I.cyclicalDegrees.normalize(c)%90;return a<u.settings.orientationSnapThresholdDegrees?c-a:90-a<u.settings.orientationSnapThresholdDegrees?c+(90-a):c}function W(c,a,b,d){var e=m.subtract(z.sv3d.get(),b.endRenderSpace,b.startRenderSpace);m.cross(e,e,d);e=w.fromPositionAndNormal(b.startRenderSpace,e,w.create());const f=w.fromPositionAndNormal(b.startRenderSpace,d,w.create()),h=a.offset;
let g=0,n;const t=new y.EventPipeline;t.next(C.screenToRenderPlane(c,e)).next(r=>{"start"===r.action&&(g=w.signedDistance(f,r.renderStart));const v=(w.signedDistance(f,r.renderEnd)-g)*c.renderCoordsHelper.unitInMeters;a.offset=h+v;n=r});return r=>{t.execute(r);return n}}function X(c,a){var {directSegment:b}=c;const {renderCoordsHelper:d}=a;var e=k.directUp(z.sv3d.get(),c,d);c=k.directStartToEnd(z.sv3d.get(),c);e=m.cross(z.sv3d.get(),c,e);({viewForward:a}=a.state.camera);0<m.dot(e,a)&&m.scale(e,e,
-1);b=b.eval(.5,z.sv3d.get());return d.headingAtPosition(b,e)}function Y(c,a,b,{forHeading:d}){const {dimension:e,geometry:f}=a;({primaryOffsetAxis:a}=f);a=m.scale(ia,a,0<=e.offset?1:-1);d=U(ja,{forHeading:d,geometry:f,renderCoordsHelper:b});m.cross(d,d,a);d=x.calculateTranslateRotateFromBases(a,d,p.ZEROS,H);c.modelTransform=d;c.renderLocation=T(G,f,f.dimensionSegment,b)}function T(c,a,b,d){const {startRenderSpace:e,endRenderSpace:f}=b;b=k.directStartToEnd(ka,a);a=k.directUp(la,a,d);a=0<m.dot(b,a);
return m.copy(c,a?e:f)}function U(c,{forHeading:a,geometry:b,renderCoordsHelper:d}){return a?k.directUp(c,b,d):k.dimensionStartToEnd(c,b,{invert:!0})}function M(c){return J.pt2px(c)+u.settings.offsetManipulator.focusedLinePaddingPx}P=function(){function c(b){this.start=b.start;this.end=b.end;this.offset=b.offset;this.heading=b.heading;this.rotation=b.rotation;this.direct=b.direct;this.horizontal=b.horizontal;this.vertical=b.vertical}var a=c.prototype;a.manipulatorName=function(b){return Object.keys(this).find(d=>
this.hasOwnProperty(d)&&b===this[d])};a.values=function(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]};a.forEachMeasureTypeManipulator=function(b){for(const d of E.lengthDimensionMeasureType)b(this.manipulatorForMeasureType(d),d)};a.manipulatorForMeasureType=function(b){switch(b){case E.LengthDimensionMeasureType.Direct:return this.direct;case E.LengthDimensionMeasureType.Horizontal:return this.horizontal;case E.LengthDimensionMeasureType.Vertical:return this.vertical}};
return aa._createClass(c)}();const ia=p.create(),ja=p.create(),ka=p.create(),la=p.create(),A=D.ManipulatorStateCustomFlags.Custom1,G=p.create(),N=p.create(),H=ca.create(),Z=new ea.EuclideanSegment;l.DidPointerMoveRecentlyFlag=A;l.LengthDimensionManipulators=P;l.automaticHeadingFromCamera=X;l.createMeasureTypeManipulator=function(c,a){const b=[p.fromValues(-.5,0,0),p.fromValues(.5,0,0)],{lengthFraction:d}=u.settings.offsetManipulator,e=L.createPolylineGeometry(a.thinOffsetManipulatorMaterial,b),f=
L.createPolylineGeometry(a.unfocusedMaterial,b.map(g=>m.scale(p.create(),g,d))),h=f.instantiate({material:a.focusedMaterial});return new Q.Manipulator3D({view:c,renderObjects:[new F.RenderObject(f,D.ManipulatorStateFlags.Unfocused|A),new F.RenderObject(h,D.ManipulatorStateFlags.Focused|A),new F.RenderObject(e,A)],collisionType:{type:"line",paths:[b]},radius:M(a.lineSizePt)/2,available:!1,metadata:a.metadata,...x.worldScaledManipulatorSettings})};l.createOffsetManipulator=function(c,a){const b=[p.fromValues(-.5,
0,0),p.fromValues(.5,0,0)],{lengthFraction:d}=u.settings.offsetManipulator,e=L.createPolylineGeometry(a.unfocusedMaterial,b.map(h=>m.scale(p.create(),h,d))),f=e.instantiate({material:a.focusedMaterial});return new Q.Manipulator3D({view:c,renderObjects:[new F.RenderObject(e,D.ManipulatorStateFlags.Unfocused|D.ManipulatorStateFlags.Selected|A),new F.RenderObject(f,D.ManipulatorStateFlags.Focused|A)],collisionType:{type:"line",paths:[b]},radius:M(a.lineSizePt)/2,metadata:a.metadata,available:!1,...x.worldScaledManipulatorSettings})};
l.createOrientationManipulator=function(c,a){return x.createRotateManipulator(c,R(a.metadata,a))};l.createPointManipulator=function(c,a){c=x.createSphereManipulator(c,O.toUnitRGBA(u.settings.pointManipulators.color),A);c.available=!1;c.grabCursor="crosshair";c.radius=u.settings.pointManipulators.radius;c.metadata=a.metadata;c.collisionPriority=1;return c};l.focusedOffsetWidth=M;l.headingManipulatorHandles=function(c,{computation:a,view:b}){return[y.createManipulatorDragEventPipeline(c,(d,e,f)=>{S({cancel:f,
computation:a,settingHeading:!0,steps:e,view:b})})]};l.measureTypeManipulatorHandles=function(c,{computation:a,manipulatorMeasureType:b,view:d}){let e=E.LengthDimensionMeasureType.Direct,f=0,h=0;return[c.events.on("grab-changed",g=>{if("start"===g.action&&k.isValidComputation(a)){var {dimension:n,geometry:t}=a;e=n.measureType;f=n.offset;h=n.orientation;g=m.copy(z.sv3d.get(),c.renderLocation);n.measureType=b;n.offset=k.computeOffsetForPoint(g,b,t,d.renderCoordsHelper);n.orientation=0}}),y.createManipulatorDragEventPipeline(c,
(g,n,t)=>{if(k.isValidComputation(a)){var {geometry:r,dimension:v}=a,{renderCoordsHelper:q}=d,B=k.computeSegmentForMeasureType(Z,b,a,q);q=k.computeOffsetAxis(z.sv3d.get(),{measureType:b,directSegment:r.directSegment,renderCoordsHelper:q});g=C.hideManipulatorWhileDragging(g);n.next(g).next(W(d,v,B,q));t.next(g).next(ma=>{v.measureType=e;v.offset=f;v.orientation=h;return ma})}})]};l.offsetManipulatorHandles=function(c,{computation:a,view:b}){return[y.createManipulatorDragEventPipeline(c,(d,e,f)=>{if(k.isValidComputation(a)&&
d.selected){var {geometry:h,dimension:g}=a;d=C.hideManipulatorWhileDragging(d);e.next(d).next(W(b,g,h.dimensionSegment,h.primaryOffsetAxis));f.next(d).next(y.resetProperties(g,["offset"]))}})]};l.pointManipulatorHandles=function(c,{isStart:a,createSnappingPipelineStep:b,dimension:d,onUpdate:e,view:f}){const h=a?"startPoint":"endPoint";return[y.createManipulatorDragEventPipeline(c,(g,n,t,r)=>{g=C.hideManipulatorWhileDragging(g);const {snappingStep:v,cancelSnapping:q}=b(r);t=t.next(g).next(y.resetProperties(d,
[h,"measureType","orientation"])).next(q);n.next(g).next(C.screenToMap3D(f)).next(...v).next(B=>{B=da.clonePoint(B.mapEnd,new ha);e("startPoint"===h?{startPoint:B}:{endPoint:B})})})]};l.rotationManipulatorHandles=function(c,{computation:a,view:b}){return[y.createManipulatorDragEventPipeline(c,(d,e,f)=>{S({cancel:f,computation:a,settingHeading:!1,steps:e,view:b})}),c.events.on("immediate-click",d=>{{const {dimension:g,geometry:n}=a;if(90===g.orientation||270===g.orientation)g.orientation=0,d.stopPropagation();
else if(null!=n){var {renderCoordsHelper:e}=b,f=k.computeGeometryFromDimension({...k.computationToGeometryDependencies(a),orientation:90},e),h=k.computeGeometryFromDimension({...k.computationToGeometryDependencies(a),orientation:270},e);null!=f&&null!=h&&(f=k.headingFromGeometry(f,e),e=k.headingFromGeometry(h,e),h=X(n,b),f=I.cyclicalDegrees.shortestSignedDiff(h,f),e=I.cyclicalDegrees.shortestSignedDiff(h,e),g.orientation=Math.abs(f)<Math.abs(e)?90:270,d.stopPropagation())}}})]};l.snapOrientationToNearestRightAngle=
V;l.unfocusedOffsetWidth=function(c){return J.pt2px(c)+u.settings.offsetManipulator.linePaddingPx};l.updateHeadingManipulatorTransform=function(c,a,b){Y(c,a,b,{forHeading:!0})};l.updateMeasureTypeManipulatorTransform=function(c,a,b,d){const {geometry:e}=a;a=k.computeSegmentForMeasureType(Z,b,a,d);d=k.computeOffsetAxis(G,{measureType:b,directSegment:e.directSegment,renderCoordsHelper:d});b=m.sub(N,a.endRenderSpace,a.startRenderSpace);d=x.calculateTranslateRotateFromBases(b,d,p.ZEROS,H);b=m.length(b);
K.scale(d,d,m.set(N,b,b,b));c.modelTransform=d;c.renderLocation=a.eval(.5,N)};l.updateOffsetManipulatorTransform=function(c,a,b){const {dimensionSegment:d,primaryOffsetAxis:e}=a,f=k.dimensionStartToEnd(G,a);a=m.exactEquals(f,p.ZEROS)?K.identity(H):x.calculateTranslateRotateFromBases(f,e,p.ZEROS,H);b=Math.max(m.length(f),u.settings.offsetManipulator.minLengthMeters/b.unitInMeters);K.scale(a,a,m.set(G,b,b,b));c.modelTransform=a;c.renderLocation=d.eval(.5,G)};l.updateOrientationManipulator=function(c,
a){x.updateRotateManipulator(c,R(c.metadata,a))};l.updateRotationManipulatorTransform=function(c,a,b){Y(c,a,b,{forHeading:!1})};Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
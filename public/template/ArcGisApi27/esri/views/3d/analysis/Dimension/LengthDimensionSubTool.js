// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../analysis/LengthDimension ../../../../core/HandleOwner ../../../../core/Handles ../../../../core/lang ../../../../core/maybe ../../../../core/memoize ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3f64 ../../../../layers/graphics/hydratedFeatures ./lengthDimensionConstraintUtils ./lengthDimensionManipulatorUtils ./lengthDimensionUtils ./settings ../Slice/images/Factory ../../interactive/SnappingVisualizer3D ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/VerticesVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/ImageMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/coordinateHelper ../../../interactive/editGeometry/EditGeometry ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/snapping/SceneSnappingManagerPool ../../../interactive/snapping/SnappingContext ../../../interactive/snapping/SnappingDragPipelineStep ../../../interactive/snapping/SnappingOperation ../../../interactive/snapping/snappingUtils ../../../../geometry/Point".split(" "),
function(k,K,m,F,na,t,S,T,U,L,M,V,N,l,n,oa,W,O,G,u,g,A,x,X,Y,Z,aa,y,ba,P,ca,da,ea,fa,ha,ia,ja,ka,la,H){function I(){const {color:B}=x.settings.offsetManipulator;return new ca.RibbonLineMaterial({color:F.toUnitRGBA(B),width:1,renderOccluded:y.RenderOccludedFlag.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}k.LengthDimensionSubTool=function(B){function C(a){var b=B.call(this,a)||this;b._stagedDimension=null;b._computationManipulators=new Map;b._computationHandles=new U;b._getSnappingContext=
V.memoize(e=>new ia.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new fa.EditGeometryOperations(new ea.EditGeometry("point",da.createCoordinateHelper(!0,!1,b.view.spatialReference))),visualizer:new Y.SnappingVisualizer3D}));const {view:c}=a;b._snappingManagerResult=ha.acquire(c);b.addHandles(b._snappingManagerResult);b._unfocusedOffsetManipulatorMaterial=I();b._focusedOffsetManipulatorMaterial=I();b._thinOffsetManipulatorMaterial=I();b._thinOffsetManipulatorMaterial.setParameters({stipplePattern:P.createStipplePatternSimple(2)});
b._constraintSnappingIndicator=new Z.LineVisualElement({view:c,attached:!0,width:1,color:F.toUnitRGBA(x.settings.constraint.color),renderOccluded:y.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:P.createStipplePatternSimple(5)});const d=F.toUnitRGBA(x.settings.disabledPointIndicator.color);b._stagedStartIndicator=new aa.VerticesVisualElement({view:c,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:a.view.renderCoordsHelper.spatialReference,color:d,size:2*x.settings.disabledPointIndicator.radius,
outlineSize:0,renderOccluded:y.RenderOccludedFlag.OccludeAndTransparent});return b}K._inherits(C,B);var f=C.prototype;f.initialize=function(){this._snappingOperation=new ka.SnappingOperation({view:this.view});const {color:a,contrastColor:b}=x.settings.orientationManipulator;this._orientationManipulatorTexture=X.getRotateHeadingTexture(this.view.toolViewManager.textures,{accentColor:a,contrastColor:b,preMultiplyAlpha:!this.view._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result});
this._orientationManipulatorMaterial=new ba.ImageMaterial({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:y.RenderOccludedFlag.Opaque});const {computations:c}=this.analysisViewData;for(const d of c)this._addComputation(d);this.addHandles([c.on("after-add",d=>this._addComputation(d.item)),c.on("after-remove",d=>this._removeComputation(d.item))]);this.addHandles([l.watch(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),
({stagedPoint:d,stagedComputation:e})=>{null!=e&&null!=d&&(d=G.clonePoint(d,new H),this._applyPointUpdate(e,{endPoint:d}))},l.sync),l.watch(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(d,e)=>{const {stagedDimension:h,selectedComputation:v,firstGrabbedManipulator:w}=d;if(h!==e?.stagedDimension||w!==e?.firstGrabbedManipulator)for(const [p,z]of this._computationManipulators)this._updateManipulators(p,
z,d);else for(const p of[v,e?.selectedComputation])null!=p&&(e=this._computationManipulators.get(p),this._updateManipulators(p,e,d))},l.syncAndInitial),l.watch(()=>this.analysis.style.lineSize,d=>{this._updateManipulatorStyle(d)},l.initial),l.watch(()=>this.view.state.camera,()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)}),l.watch(()=>M.applySome(this._stagedComputation,d=>{d=d.elevationAlignedStartPoint;const e=O.create();return null!=d&&this.view.renderCoordsHelper.toRenderCoords(d,
e)?e:null}),d=>{null!=d?(this._stagedStartIndicator.vertices=[d],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]);this.addHandles(this._constraintHandles);this.addHandles(this._snappingIndicatorHandles);la.setupSnappingToggleHandles(this,()=>{const d=this._activeComputation;var e=this._stagedComputation;if(null==d||null!=e)e=this._getSnappingContext(this.view.inputManager.latestPointerType??"mouse"),this.updatingHandles.addPromise(N.ignoreAbortErrors(this._snappingOperation.resnap(this._snappingManager,
e)));if(null!=d){const {start:h,end:v}=this._computationManipulators.get(d);if(h.grabbing||v.grabbing){e=h.grabbing?"start":"end";const w=this._computeConstraint(d);u.reapplyConstraint(d,e,{constraint:w,view:this.view})}}})};f.destroy=function(){this._snappingOperation=M.destroyMaybe(this._snappingOperation);this._computationHandles.destroy();this._constraintSnappingIndicator.destroy();this._stagedStartIndicator.destroy();this._orientationManipulatorMaterial.dispose();this._orientationManipulatorTexture.release()};
f.removeStaged=function(){return null!=this._stagedDimension?(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0):!1};f.onDeactivate=function(){this.removeStaged();this._resetSnappingState()};f.onClick=function(a){const {_stagedDimension:b}=this;if(null==b)return a=this._onUnstagedClick(a),this.analysis.dimensions.add(a),null;this._onStagedClick(a);return b};f.onPointerMove=function({mapPoint:a,pointerType:b}){"touch"!==b&&(b=this._getSnappingContext(b),this.updatingHandles.addPromise(N.ignoreAbortErrors(this._snappingOperation.snap({point:a},
this._snappingManager,b))))};f.onManipulatorSelectionChanged=function(){null==this.analysisViewData.selectedComputation||this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null)};f._onUnstagedClick=function({mapPoint:a,pointerType:b}){let c=a;"mouse"===b&&(b=this._getSnappingContext(b),c=this._snappingManager.update({point:a,context:b}));this._stagedDimension=a=new S({startPoint:G.clonePoint(c,new H),endPoint:null,
measureType:t.LengthDimensionMeasureType.Horizontal});this._resetSnappingState();return a};f._onStagedClick=function({mapPoint:a,pointerType:b}){const c=this._stagedComputation;if(null!=c){var d=a;"mouse"===b&&(b=this._getSnappingContext(b),d=this._snappingManager.update({point:a,context:b}));a=G.clonePoint(d,new H);this._applyPointUpdate(c,{endPoint:a});this._stagedDimension=null;this._resetSnappingState()}};f._resetSnappingState=function(){this._snappingManager.doneSnapping();this._snappingOperation.abort();
this._snappingOperation.stagedPoint=null};f._addComputation=function(a){if(!this._computationManipulators.has(a)){var b=this._setupPointManipulator(a,{isStart:!0}),c=this._setupPointManipulator(a,{isStart:!1}),d=this._setupOffsetManipulator(a),e=this._setupHeadingManipulator(a),h=this._setupRotationManipulator(a),v=this._setupMeasureTypeManipulator(a,t.LengthDimensionMeasureType.Direct),w=this._setupMeasureTypeManipulator(a,t.LengthDimensionMeasureType.Horizontal),p=this._setupMeasureTypeManipulator(a,
t.LengthDimensionMeasureType.Vertical);b=new g.LengthDimensionManipulators({start:b,end:c,offset:d,heading:e,rotation:h,direct:v,horizontal:w,vertical:p});this._setupComputationToManipulatorsSync(a,b);this._computationManipulators.set(a,b);this.manipulators.addMany(b.values())}};f._removeComputation=function(a){const b=this._computationManipulators.get(a);if(null!=b){this._computationHandles.remove(a);this._computationManipulators.delete(a);for(const c of b.values())this.manipulators.remove(c)}};
f._setupComputationToManipulatorsSync=function(a,b){this._computationHandles.add([l.watch(()=>a.geometry,()=>this._updateManipulators(a,b),{...l.syncAndInitial,equals:L.equals})],a)};f._setupPointManipulator=function(a,b){const {view:c}=this,{dimension:d}=a,e=g.createPointManipulator(c,{metadata:d});b=g.pointManipulatorHandles(e,{isStart:b.isStart,createSnappingPipelineStep:h=>ja.createSnapDragEventPipelineStep({snappingContext:this._getSnappingContext(h),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),
dimension:d,onUpdate:h=>this._applyPointUpdate(a,h),view:c});this._computationHandles.add(b,a);return e};f._setupOffsetManipulator=function(a){var {view:b}=this;const c=g.createOffsetManipulator(b,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:a.dimension});b=g.offsetManipulatorHandles(c,{computation:a,view:b});this._computationHandles.add(b,a);return c};f._setupHeadingManipulator=
function(a){var {view:b}=this;const c=g.createOrientationManipulator(b,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=g.headingManipulatorHandles(c,{computation:a,view:b});this._computationHandles.add(b,a);return c};f._setupRotationManipulator=function(a){var {view:b}=this;const c=g.createOrientationManipulator(b,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=g.rotationManipulatorHandles(c,
{computation:a,view:b});this._computationHandles.add(b,a);return c};f._setupMeasureTypeManipulator=function(a,b){const {view:c}=this,d=g.createMeasureTypeManipulator(c,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:a.dimension});b=g.measureTypeManipulatorHandles(d,{computation:a,manipulatorMeasureType:b,view:c});this._computationHandles.add(b,
a);return d};f._updateManipulators=function(a,b,c={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const {stagedDimension:d,selectedComputation:e,firstGrabbedManipulator:h}=c,{start:v,end:w,offset:p,heading:z,rotation:D}=b;c=e===a;const Q=A.isValidComputation(a),{dimension:J}=a;for(var q of b.values()){const r=Q&&null==d&&(null==h||q===h);q===p?(q.available=r,q.selected=c):q.available=r&&c}if(Q){null!=
this._computeConstraint(a)?b.forEachMeasureTypeManipulator(r=>r.available=!1):b.manipulatorForMeasureType(J.measureType).available=!1;for(const r of[z,D])if(J.measureType!==t.LengthDimensionMeasureType.Direct||0===J.offset)r.available=!1;A.arePointsVerticallyAligned(a)?D.available=!1:z.available=!1;({geometry:q}=a);v.renderLocation=q.directSegment.startRenderSpace;w.renderLocation=q.directSegment.endRenderSpace;var {renderCoordsHelper:E}=this.view;g.updateOffsetManipulatorTransform(p,q,E);z.available&&
g.updateHeadingManipulatorTransform(z,a,E);D.available&&g.updateRotationManipulatorTransform(D,a,E);b.forEachMeasureTypeManipulator((r,ma)=>{r.available&&g.updateMeasureTypeManipulatorTransform(r,a,ma,E)})}};f._updateManipulatorStyle=function(a){const b=g.unfocusedOffsetWidth(a),c=g.focusedOffsetWidth(a);a={lineSizePt:a,material:this._orientationManipulatorMaterial};for(const {offset:d,heading:e,rotation:h}of this._computationManipulators.values())d.radius=c/2,g.updateOrientationManipulator(e,a),
g.updateOrientationManipulator(h,a);this._unfocusedOffsetManipulatorMaterial.setParameters({width:b});this._focusedOffsetManipulatorMaterial.setParameters({width:c})};f._applyPointUpdate=function(a,b){const {view:c}=this,d=A.computationToGeometryDependencies(a);"startPoint"in b&&(d.elevationAlignedStartPoint=b.startPoint);"endPoint"in b&&(d.elevationAlignedEndPoint=b.endPoint);const e=A.computeGeometryFromDimension(d,c.renderCoordsHelper);if(null!=e){var h=this._computeConstraint({...d,geometry:e});
u.applyConstraint(a,b,{...d,constraint:h,unconstrainedGeometry:e,view:c});a===this._stagedComputation&&this._updateStagedDimensionOffset(a)}};f._updateStagedDimensionOffset=function(a){if(null!=a.geometry){a.geometry.directSegment.eval(.5,R);var b=this.view.state.camera.computeRenderPixelSizeAt(R);a.dimension.offset=x.settings.initialOffsetPx*b}};f._computeConstraint=function(a){return u.computeConstraint(u.constraintDependencies(a,this._snappingManager.options),this.view)};K._createClass(C,[{key:"updating",
get:function(){return this.updatingHandles.updating||this._snappingManager.updating}},{key:"firstGrabbedManipulator",get:function(){return this.parentTool.firstGrabbedManipulator}},{key:"hasGrabbedManipulators",get:function(){return this.parentTool.hasGrabbedManipulators}},{key:"snappingOptions",get:function(){return this._snappingManager.options}},{key:"_snappingManager",get:function(){return this._snappingManagerResult.snappingManager}},{key:"_activeComputation",get:function(){if(null!=this._stagedComputation)return this._stagedComputation;
const {selectedComputation:a}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=a?a:null}},{key:"_stagedComputation",get:function(){const a=this._stagedDimension,b=this.analysisViewData.computations.at(-1);return null==a||null==b||b.dimension!==a?null:b}},{key:"_constraintHandles",get:function(){return[l.when(()=>this.analysisViewData.selectedComputation,a=>{a.previousConstraint=this._computeConstraint(a)},{...l.syncAndInitial,equals:L.equals}),l.watch(()=>{const a=this._activeComputation;
if(null==a)return null;const {measureType:b,orientation:c}=a.dimension;return{measureType:b,orientation:c,computation:a}},(a,b)=>{if(null!=a&&null==b){const {measureType:c,orientation:d,computation:e}=a;switch(e.previousConstraint){case u.LengthDimensionConstraint.Horizontal:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Horizontal,orientation:0};break;case u.LengthDimensionConstraint.Vertical:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Vertical,orientation:0};
break;case u.LengthDimensionConstraint.Direct:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Direct,orientation:d};break;default:e.preConstraintProperties={measureType:c,orientation:d}}}null==a&&null!=b&&(b.computation.preConstraintProperties=null)},l.sync)]}},{key:"_snappingIndicatorHandles",get:function(){return[l.watch(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:a,activeComputation:b})=>{const c=this._constraintSnappingIndicator;
this.removeHandles("snapping-indicator-event-handles");if(null==b)c.attached=!1;else if(b===a)c.attached=!0;else{const {start:d,end:e}=this._computationManipulators.get(b);a=()=>{c.attached=d.grabbing||e.grabbing};a();this.addHandles([d.events.on("grab-changed",a),e.events.on("grab-changed",a)],"snapping-indicator-event-handles")}}),l.watch(()=>{const a=this._activeComputation;return null!=a?{geometry:a.geometry,constraint:a.previousConstraint}:{}},({geometry:a,constraint:b})=>{const c=this._constraintSnappingIndicator;
null!=a&&null!=b&&b!==u.LengthDimensionConstraint.Direct?(c.visible=!0,c.setGeometryFromSegment(a.directSegment)):c.visible=!1})]}},{key:"testInfo",get:function(){const a=b=>this.analysisViewData.computations.find(c=>c.dimension===b);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=y.RenderOccludedFlag.Occlude;this.manipulators.forEach(({manipulator:b})=>{for(const {geometry:c}of b.renderObjects)c.material.setParameters({renderOccluded:y.RenderOccludedFlag.Occlude})})},
getManipulatorsForDimension:b=>this._computationManipulators.get(a(b)),getComputationForDimension:b=>a(b),getConstraintForDimension:b=>{b=a(b);return null!=b?this._computeConstraint(b):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}}]);return C}(T.HandleOwner);m.__decorate([n.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"analysis",void 0);
m.__decorate([n.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"analysisViewData",void 0);m.__decorate([n.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"manipulators",void 0);m.__decorate([n.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"parentTool",void 0);m.__decorate([n.property({constructOnly:!0,nonNullable:!0})],k.LengthDimensionSubTool.prototype,"view",void 0);m.__decorate([n.property({readOnly:!0})],k.LengthDimensionSubTool.prototype,
"updating",null);m.__decorate([n.property()],k.LengthDimensionSubTool.prototype,"firstGrabbedManipulator",null);m.__decorate([n.property()],k.LengthDimensionSubTool.prototype,"hasGrabbedManipulators",null);m.__decorate([n.property()],k.LengthDimensionSubTool.prototype,"snappingOptions",null);m.__decorate([n.property()],k.LengthDimensionSubTool.prototype,"_stagedDimension",void 0);m.__decorate([n.property()],k.LengthDimensionSubTool.prototype,"_activeComputation",null);m.__decorate([n.property()],
k.LengthDimensionSubTool.prototype,"_stagedComputation",null);k.LengthDimensionSubTool=m.__decorate([W.subclass("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],k.LengthDimensionSubTool);const R=O.create();Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
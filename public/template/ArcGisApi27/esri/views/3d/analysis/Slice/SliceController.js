// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../analysis/SlicePlane ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/boundedPlane ../../../../layers/Layer ../../../../layers/buildingSublayers/BuildingComponentSublayer ./sliceToolUtils ../support/projectionUtils ../../terrain/isTerrainSurfaceLayer".split(" "),
function(e,t,l,w,x,y,z,m,n,G,H,I,A,B,u,C,p,D,E){function F(h,k){f.has(h)||f.set(h,{all:[],activeController:null});f.get(h)?.all.push(k)}const q=z.getLogger("esri.views.3d.analysis.Slice.SliceController");e.SliceController=function(h){function k(a){a=h.call(this,a)||this;a._handles=new y;a._internalChange=!1;a._currentSlicePlane=null;return a}t._inherits(k,h);var g=k.prototype;g.initialize=function(){this._handles.add(this.analysis.excludedLayers.on("before-add",a=>{const b=a.item;null!=b&&(b instanceof
u||b instanceof C)?b instanceof u&&E.isTerrainSurfaceLayer(b)?(q.error("excludedLayers",`Layer '${b.title}, id:${b.id}' of type '${b.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),a.preventDefault()):this.analysis.excludedLayers.includes(b)&&a.preventDefault():(q.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),a.preventDefault())}));F(this.view,this);this._handles.add([m.watch(()=>this.analysisViewData.plane,
()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane();this._updateLayerViews()},{sync:!0}),m.watch(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),m.watch(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController();this._updateViewSlicePlane()},{sync:!0}),m.watch(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]);this._handles.add([m.watch(()=>
this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis");this._updateActiveController();this._updateBoundedPlaneFromSlicePlane();this._updateViewSlicePlane()};g.destroy=function(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null);var a=this.view;if(!f.has(a))throw Error("view expected in global slice register");const b=f.get(a),d=b?.all.lastIndexOf(this)??-1;if(!b||-1===d)throw Error("controller expected in global slice register");
b.all.splice(d,1);0===b.all.length&&f.delete(a);this._handles.destroy();this.set("view",null)};g._updateBoundedPlaneFromSlicePlane=function(){const a=this.analysis.shape;var b=this._currentSlicePlane;if(!(null==b&&null==a||null!=b&&null!=a&&a.equals(b))){var d=null;b=null;if(null!=a&&null!=a.position){d=a.position.spatialReference;const c=p.projectAndElevationAlignShape(a,this.view);null==c&&D.logFailedGeometryProjectionError(this.analysis,d,q);d=p.projectedShapeToPlane(c,this.view,{tiltEnabled:this.analysis.tiltEnabled},
B.create());null!=d&&(b={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height})}this._currentSlicePlane=b;this._internalChange=!0;this.analysisViewData.plane=d;this._internalChange=!1}};g._updateSlicePlaneFromBoundedPlane=function(){const a=p.planeToShape(this.analysisViewData.plane,this.view,this.view.spatialReference,new w);let b=null;null!=a&&(b={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height});this._currentSlicePlane=b;this._internalChange=
!0;this.analysis.shape=a;this._internalChange=!1;this._updateViewSlicePlane()};g._updateActiveController=function(){if(!r){var a=f.get(this.view);a&&(this.analysisViewData.active?(null!=a.activeController&&a.activeController!==this&&(r=!0,r=a.activeController.analysisViewData.active=!1),this._updateLayerViews(),a.activeController=this):null!=a.activeController&&a.activeController!==this||null==a.activeController||a.activeController!==this||(a.activeController=null,this._updateLayerViews()))}};g._updateViewSlicePlane=
function(){var a=this.view;const b=f.get(a)?.activeController;a.slicePlane=null!=b&&null!=b.analysisViewData.plane&&b.analysisViewData.visible?b.analysisViewData.plane:null};g._updateLayerViews=function(){const a=null!=this.analysisViewData.plane&&this.analysisViewData.visible&&this.analysisViewData.active,b=[],d=c=>{"layers"in c?c.layers.forEach(d):b.push(c)};this.analysis.excludedLayers.forEach(d);this.view.allLayerViews.forEach(c=>{c.destroyed||("slicePlaneEnabled"in c&&(c.slicePlaneEnabled=a&&
!b.includes(c.layer)),"sublayerViews"in c&&c.sublayerViews.forEach(v=>{v.slicePlaneEnabled=a&&!b.includes(v.sublayer)}))});null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=a&&!this.analysis.excludeGroundSurface)};t._createClass(k,[{key:"_allLayerAndSubLayerViews",get:function(){const a=this.view.allLayerViews.items;return a.concat(a.filter(p.isIBuildingSceneLayerView3D).flatMap(({sublayerViews:b})=>b.items))}}]);return k}(x);l.__decorate([n.property()],e.SliceController.prototype,
"view",void 0);l.__decorate([n.property()],e.SliceController.prototype,"analysis",void 0);l.__decorate([n.property()],e.SliceController.prototype,"analysisViewData",void 0);l.__decorate([n.property()],e.SliceController.prototype,"_allLayerAndSubLayerViews",null);e.SliceController=l.__decorate([A.subclass("esri.views.3d.analysis.Slice.SliceController")],e.SliceController);const f=new Map;let r=!1;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../geometry ../../../../analysis/SlicePlane ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/quat ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/Axis ../../../../chunks/boundedPlane ../../../../geometry/support/plane ../../../../geometry/support/ray ../../../../geometry/support/vector ../../../../geometry/support/vectorStacks ./settings ./sliceToolConfig ../support/projectionUtils ../../interactive/Manipulator3D ../../interactive/manipulatorUtils ../../interactive/RenderObject ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/SlicePlaneVisualElement ../../support/RenderCoordsHelper ../../support/geometryUtils/ray ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Material ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/interfaces ../../../../geometry/Extent".split(" "),
function(l,A,Ea,sa,Fa,ta,U,V,v,W,ca,d,y,ua,da,C,N,va,X,m,O,r,wa,ea,Y,E,xa,ya,fa,za,P,H,F,Q,ha,Aa,B,Ba){function ia(a,b,e,c,f,k){const g=d.dot(a,b),h=m.sv3d.get(),q=m.sv3d.get();switch(c===l.SliceOrientation.HORIZONTAL_OR_VERTICAL?Math.abs(g)>r.VERTICAL_DOT_THRESHOLD?l.SliceOrientation.HORIZONTAL:l.SliceOrientation.VERTICAL:c){case l.SliceOrientation.VERTICAL:d.cross(h,Math.abs(g)<=r.SMALL_ANGLE_DOT_THRESHOLD?a:e.viewUp,b);d.copy(q,b);break;case l.SliceOrientation.HORIZONTAL:d.cross(h,e.viewUp,b);
d.cross(q,b,h);break;case l.SliceOrientation.TILTED:d.cross(h,Math.abs(g)<=r.SMALL_ANGLE_DOT_THRESHOLD?b:e.viewUp,a),d.cross(q,a,h)}a=d.cross(m.sv3d.get(),h,q);0<d.dot(a,e.viewForward)&&d.scale(q,q,-1);d.normalize(f,h);d.normalize(k,q)}function ja(a,b,e){var c=b.worldUpAtPosition(a.origin,m.sv3d.get());b=a.basis1;c=X.angleAroundAxis(c,a.basis2,a.basis1)+I;return C.rotate(a,Math.round(c/I)*I-c,b,e)}function Z(a,b){switch(b){case G.POSITIVE_X:return{basis:a.basis1,direction:1,position:d.add(m.sv3d.get(),
a.origin,a.basis1),edge:b};case G.POSITIVE_Y:return{basis:a.basis2,direction:1,position:d.add(m.sv3d.get(),a.origin,a.basis2),edge:b};case G.NEGATIVE_X:return{basis:a.basis1,direction:-1,position:d.subtract(m.sv3d.get(),a.origin,a.basis1),edge:b};case G.NEGATIVE_Y:return{basis:a.basis2,direction:-1,position:d.subtract(m.sv3d.get(),a.origin,a.basis2),edge:b}}}function aa(a,b,e){const c=e.projectToRenderScreen(d.add(m.sv3d.get(),a,b),V.castRenderScreenPointArray3(m.sv3d.get()));a=e.projectToRenderScreen(d.subtract(m.sv3d.get(),
a,b),V.castRenderScreenPointArray3(m.sv3d.get()));return d.squaredLength(d.subtract(c,c,a))}function K(a){const b=d.length(a.basis1);a=d.length(a.basis2);return r.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(b,a)}function R(a){return 0!==a.direction[0]&&0!==a.direction[1]}function ka(a,b,e,c){const f=A.blendColors(c.color,c.outlineColor,.4),k=A.blendColors(c.color,c.outlineColor,.14),g=new Q.ColorMaterial({color:A.toUnitRGBA(c.color),cullFace:P.CullFaceOptions.Back,renderOccluded:F.RenderOccludedFlag.Opaque}),
h=new Q.ColorMaterial({color:A.toUnitRGBA(f),cullFace:P.CullFaceOptions.Back,renderOccluded:F.RenderOccludedFlag.Opaque}),q=new Q.ColorMaterial({color:A.toUnitRGBA(k),cullFace:P.CullFaceOptions.Back,renderOccluded:F.RenderOccludedFlag.Opaque}),t=new Q.ColorMaterial({color:A.toUnitRGBA(c.outlineColor),transparent:!0,writeDepth:!1,cullFace:P.CullFaceOptions.Front,renderOccluded:F.RenderOccludedFlag.Transparent});c=p=>{const n=a.slice(0);var w=d.subtract(m.sv3d.get(),n[0],n[1]);d.normalize(w,w);var x=
d.subtract(m.sv3d.get(),n[n.length-1],n[n.length-2]);d.normalize(x,x);if(0<b){var u=d.scale(y.create(),x,-b);n[n.length-1]=d.add(u,u,n[n.length-1]);u=d.scale(y.create(),w,-b);n[0]=d.add(u,u,n[0])}u=p?r.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER:1;var J=r.SHIFT_RESTART_TIP_LENGTH*u;const la=r.SHIFT_RESTART_TIP_RADIUS*u;u=v.identity(m.sm4d.get());if(0<b){var z=J/4,L=d.set(m.sv3d.get(),0,z,0);z=1+b/z;v.translate(u,u,L);v.scale(u,u,d.set(m.sv3d.get(),z,z,z));v.translate(u,u,d.scale(L,L,-1/z))}z=v.identity(W.create());
L=y.fromValues(0,1,0);x=v.fromQuat(W.create(),ca.rotationTo(m.sq4d.get(),L,x));x[12]=n[n.length-1][0];x[13]=n[n.length-1][1];x[14]=n[n.length-1][2];v.multiply(x,x,u);p=r.SHIFT_RESTART_TUBE_RADIUS*(p?r.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER:1)+b;var Ca=e?t:q;const ma=[];for(let ba=0;12>ba;ba++){const na=ba/12*2*Math.PI;ma.push([Math.cos(na)*p,Math.sin(na)*p])}p=H.createPathExtrusionGeometry(Ca,ma,n,[],[],!1);p.transformation=z;p=[p];z=H.createConeGeometry(e?t:g,J,la,24,!1,!1,!0);z.transformation=x;p.push(z);
J=H.createConeGeometry(e?t:h,J,la,24,!1,!0,!1);J.transformation=x;p.push(J);w=v.fromQuat(W.create(),ca.rotationTo(m.sq4d.get(),L,w));w[12]=n[0][0];w[13]=n[0][1];w[14]=n[0][2];v.multiply(w,w,u);p.push(z.instantiate({transformation:w}));p.push(J.instantiate({transformation:w}));return p};return{normal:c(!1),focused:c(!0)}}function oa(a,b){const e=d.subtract(y.create(),a[a.length-1],a[a.length-2]);d.normalize(e,e);d.scale(e,e,r.SHIFT_RESTART_TIP_LENGTH);d.add(e,e,a[a.length-1]);return b?(b=d.subtract(y.create(),
a[0],a[1]),d.normalize(b,b),d.scale(b,b,r.SHIFT_RESTART_TIP_LENGTH),d.add(b,b,a[0]),[b,...a,e]):[...a,e]}function Da(a,b,e,c,f,k,g=C.create()){if(!k.toRenderCoords(a,g.origin))return ta.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${a.spatialReference.wkid} is not supported`),null;k.worldBasisAtPosition(g.origin,da.Axis.X,g.basis1);k.worldBasisAtPosition(g.origin,da.Axis.Y,g.basis2);N.fromVectorsAndPoint(g.basis2,g.basis1,
g.origin,g.plane);C.rotate(g,-U.deg2rad(b),C.normal(g),g);C.rotate(g,U.deg2rad(e),g.basis1,g);d.scale(g.basis1,g.basis1,c/2);d.scale(g.basis2,g.basis2,f/2);C.updateUnboundedPlane(g);return g}function pa(a,b){if(null==a||null==a.position)return null;const e=wa.applyProjectionAndElevationAlignment(a.position,b.spatialReference,b.elevationProvider);if(null==e)return null;b=fa.RenderCoordsHelper.renderUnitScaleFactor(a.position.spatialReference,b.spatialReference);return{position:e,heading:a.heading,
tilt:a.tilt,renderWidth:a.width*b,renderHeight:a.height*b}}function qa(a,b,e,c=C.create()){if(null==a)return null;a=Da(a.position,a.heading,a.tilt,a.renderWidth,a.renderHeight,b.renderCoordsHelper,c);e.tiltEnabled||null==a||ja(a,b.renderCoordsHelper,a);return a}var G;(function(a){a[a.POSITIVE_X=0]="POSITIVE_X";a[a.POSITIVE_Y=1]="POSITIVE_Y";a[a.NEGATIVE_X=2]="NEGATIVE_X";a[a.NEGATIVE_Y=3]="NEGATIVE_Y"})(G||(G={}));const D=B.ManipulatorStateCustomFlags.Custom1;l.RotationAxis=void 0;(function(a){a[a.HEADING=
1]="HEADING";a[a.TILT=2]="TILT"})(l.RotationAxis||(l.RotationAxis={}));l.SliceOrientation=void 0;(function(a){a[a.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL";a[a.HORIZONTAL=1]="HORIZONTAL";a[a.VERTICAL=2]="VERTICAL";a[a.TILTED=3]="TILTED"})(l.SliceOrientation||(l.SliceOrientation={}));const M=B.ManipulatorStateCustomFlags.Custom2,S=va.create(),I=Math.PI/2,T=B.ManipulatorStateCustomFlags.Custom1,ra=B.ManipulatorStateCustomFlags.Custom2;l.OffsetMode=void 0;(function(a){a[a.CENTER_ON_CALLOUT=
0]="CENTER_ON_CALLOUT";a[a.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(l.OffsetMode||(l.OffsetMode={}));l.DidPointerMoveRecentlyFlag=D;l.IsShiftEdgeOnScreenFlag=M;l.addArrowTips=oa;l.calculateBoundedPlaneTranslateRotate=function(a,b){return Y.calculateTranslateRotateFromBases(a.basis1,a.basis2,a.origin,b)};l.calculateDiagonalResizeHandleScale=function(a){return K(a)};l.calculatePlaneHalfSize=function(a,b){return r.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(b.width,b.height)*b.computeRenderPixelSizeAt(a)};
l.calculateResizeHandlePadding=K;l.calculateScreenSpaceBasisLength2=aa;l.createGridVisualElement=function(a){return new ya.SlicePlaneVisualElement({view:a,attached:!1,backgroundColor:A.toUnitRGBA(O.settings.plane.color),gridColor:A.toUnitRGBA(O.settings.plane.gridColor),gridWidth:4,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent})};l.createOutlineVisualElement=function(a){return new xa.LineVisualElement({view:a,attached:!1,color:A.toUnitRGBA(O.settings.plane.outlineColor),width:r.PLANE_OUTLINE_WIDTH,
renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})};l.createPlane=function(a,b,e,c,f,k,g,h){g=g.worldUpAtPosition(a,m.sv3d.get());ia(b,g,f,k,h.basis1,h.basis2);d.scale(h.basis1,h.basis1,e);d.scale(h.basis2,h.basis2,c);d.copy(h.origin,a);N.fromVectorsAndPoint(h.basis2,h.basis1,h.origin,h.plane);return h};l.createResizeManipulator=function(a,b,e){const c=(b=R(b))?[y.fromValues(1,0,0),y.fromValues(0,0,0),y.fromValues(0,1,0)]:[y.fromValues(1,
0,0),y.fromValues(-1,0,0)],f=A.toUnitRGBA(e.color);e=t=>new Aa.RibbonLineMaterial({color:f,width:t,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent});const k=()=>new ha.NativeLineMaterial({color:f,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent}),g=b?r.RESIZE_HANDLE_CORNER_WIDTH:r.RESIZE_HANDLE_EDGE_WIDTH,h=g*r.DISPLAY_FOCUS_MULTIPLIER,q=r.RESIZE_HANDLE_EDGE_WIDTH;e=[new E.RenderObject(H.createPolylineGeometry(1<g?e(g):k(),c),B.ManipulatorStateFlags.Unfocused|T),new E.RenderObject(H.createPolylineGeometry(1<
h?e(h):k(),c),B.ManipulatorStateFlags.Focused|T),new E.RenderObject(H.createPolylineGeometry(1<q?e(q):k(),c),ra)];a=new ea.Manipulator3D({view:a,renderObjects:e,collisionType:{type:"line",paths:[c]},radius:b?r.RESIZE_HANDLE_CORNER_INPUT_RADIUS:r.RESIZE_HANDLE_EDGE_INPUT_RADIUS,...Y.worldScaledManipulatorSettings});a.state=T;return a};l.createRotateManipulator=function(a,b){a=Y.createRotateManipulator(a,{calloutColor:A.toUnitRGBA(O.settings.callouts.color),customStateMask:D,texture:b});a.state=D;return a};
l.createRotatePlane=function(a,b,e,c){b=b.worldUpAtPosition(a.origin,m.sv3d.get());const f=m.sv3d.get();switch(e){case l.RotationAxis.HEADING:d.copy(f,b);break;case l.RotationAxis.TILT:d.copy(f,a.basis1)}return N.fromPositionAndNormal(a.origin,f,c)};l.createShiftManipulator=function(a,b){var e=b.offsetMode===l.OffsetMode.CENTER_ON_CALLOUT?r.SHIFT_RESTART_OFFSET_DISTANCE:0,c=[y.fromValues(e,0,-r.SHIFT_RESTART_ARROW_LENGTH/2),y.fromValues(e,0,r.SHIFT_RESTART_ARROW_LENGTH/2)];const f=oa(c,!0),k=ka(c,
0,!1,b);c=ka(c,r.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0,b);const g=new ha.NativeLineMaterial({color:A.toUnitRGBA(b.calloutColor),renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent});b=H.createPolylineGeometry(g,[[e,0,0],[e-r.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]);e=H.createPolylineGeometry(g,[[e,0,0],[e-r.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]);return new ea.Manipulator3D({view:a,renderObjects:[...k.normal.map(h=>new E.RenderObject(h,B.ManipulatorStateFlags.Unfocused|D)),...c.normal.map(h=>new E.RenderObject(h,
B.ManipulatorStateFlags.Unfocused|D)),new E.RenderObject(b,B.ManipulatorStateFlags.Unfocused|D|M),...k.focused.map(h=>new E.RenderObject(h,B.ManipulatorStateFlags.Focused|D)),...c.focused.map(h=>new E.RenderObject(h,B.ManipulatorStateFlags.Focused|D)),new E.RenderObject(e,B.ManipulatorStateFlags.Focused|D|M)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[f]},collisionPriority:1,radius:r.SHIFT_RESTART_TIP_RADIUS,state:D})};l.createShiftPlane=function(a,b,e,c){e=d.cross(m.sv3d.get(),b,
e);d.cross(e,e,b);return N.fromPositionAndNormal(a,e,c)};l.forceHorizontalOrVertical=ja;l.isDiagonalResizeHandle=R;l.isIBuildingSceneLayerView3D=function(a){return null!=("building-scene-3d"===a.type?a:null)};l.normalToBases=ia;l.planeToExtent=function(a,b,e){if(null==a)return null;const c=a.origin,f=m.sv3d.get(),k=m.sv3d.get(),g=m.sv3d.get(),h=m.sv3d.get();d.add(f,c,a.basis1);d.add(f,f,a.basis2);d.add(k,c,a.basis1);d.sub(k,k,a.basis2);d.sub(g,c,a.basis1);d.sub(g,g,a.basis2);d.sub(h,c,a.basis1);d.add(h,
h,a.basis2);let q,t,p,n,w,x;for(const u of[f,k,g,h]){a=b.fromRenderCoords(u,u,e);if(null==a)return null;q=null==q?a[0]:Math.min(q,a[0]);t=null==t?a[0]:Math.max(t,a[0]);p=null==p?a[1]:Math.min(p,a[1]);n=null==n?a[1]:Math.max(n,a[1]);w=null==w?a[2]:Math.min(w,a[2]);x=null==x?a[2]:Math.max(x,a[2])}return new Ba({xmin:q,xmax:t,ymin:p,ymax:n,zmin:w,zmax:x,spatialReference:e})};l.planeToShape=function(a,b,e,c=new sa){if(null==a)return null;const {renderCoordsHelper:f}=b;var k=f.fromRenderCoords(a.origin,
b.spatialReference);if(null==k)return null;k=ua.tryProjectWithZConversion(k,e);if(null==k)return null;c.position=k;k=2*d.length(a.basis1);const g=2*d.length(a.basis2);b=fa.RenderCoordsHelper.renderUnitScaleFactor(b.spatialReference,e);c.width=k*b;c.height=g*b;b=f.worldUpAtPosition(a.origin,m.sv3d.get());c.tilt=U.rad2deg(X.angleAroundAxis(b,a.basis2,a.basis1)+I);c.heading=f.headingAtPosition(a.origin,a.basis1)-90;return c};l.projectAndElevationAlignShape=pa;l.projectedShapeToPlane=qa;l.resizeNormal=
T;l.resizeOutlineOnly=ra;l.resizePlane=function(a,b,e,c,f,k){const g=d.copy(m.sv3d.get(),f.origin);d.add(g,g,d.scale(m.sv3d.get(),f.basis1,0>a.direction[0]?1:-1));d.add(g,g,d.scale(m.sv3d.get(),f.basis2,0>a.direction[1]?1:-1));var h=d.length(f.basis1);const q=d.length(f.basis2);e=d.subtract(m.sv3d.get(),e,g);var t=d.subtract(m.sv3d.get(),b,g);let p=0;b=0;if(R(a)){var n=K(f);const w=K(k);p=h-.5*a.direction[0]*d.dot(f.basis1,t)/h;b=q-.5*a.direction[1]*d.dot(f.basis2,t)/q;t=w/n;p*=t;b*=t}t=.5*a.direction[0]*
d.dot(f.basis1,e)/h;n=.5*a.direction[1]*d.dot(f.basis2,e)/q;e=p+t;b+=n;h=d.scale(m.sv3d.get(),f.basis1,e/h);f=d.scale(m.sv3d.get(),f.basis2,b/q);(0>=e||aa(k.origin,h,c)<=r.PLANE_MIN_BASIS_SCREEN_LEN2)&&d.copy(h,k.basis1);(0>=b||aa(k.origin,f,c)<=r.PLANE_MIN_BASIS_SCREEN_LEN2)&&d.copy(f,k.basis2);c=d.copy(m.sv3d.get(),g);d.add(c,c,d.scale(m.sv3d.get(),h,0>a.direction[0]?-1:1));d.add(c,c,d.scale(m.sv3d.get(),f,0>a.direction[1]?-1:1));return C.fromValues(c,h,f,k)};l.shapeToPlane=function(a,b,e,c=C.create()){a=
pa(a,b);return null==a?null:qa(a,b,e,c)};l.updateResizeHandle=function(a,b,e,c){var f=d.length(c.basis1);const k=d.length(c.basis2),g=K(c),h=K(c),q=d.set(m.sv3d.get(),0,0,0);d.add(q,d.scale(m.sv3d.get(),c.basis1,b.direction[0]),d.scale(m.sv3d.get(),c.basis2,b.direction[1]));d.add(q,c.origin,q);c=0;let t=1;R(b)?(1===b.direction[0]&&-1===b.direction[1]?c=I:1===b.direction[0]&&1===b.direction[1]?c=Math.PI:-1===b.direction[0]&&1===b.direction[1]&&(c=3*Math.PI/2),t=h):(b=0!==b.direction[0]?1:2,c=1===b?
I:0,t=(1===b?k:f)-g);f=v.fromZRotation(m.sm4d.get(),c);v.scale(f,f,d.set(m.sv3d.get(),t,t,t));v.multiply(f,e,f);f[12]=0;f[13]=0;f[14]=0;a.modelTransform=f;a.renderLocation=q};l.updateRotateHeadingHandle=function(a,b,e,c){c=c.worldUpAtPosition(e.origin,m.sv3d.get());const f=Z(e,G.POSITIVE_X),k=v.fromZRotation(m.sm4d.get(),f.edge*Math.PI/2);v.rotateX(k,k,-(X.angleAroundAxis(c,e.basis2,e.basis1)+I));v.multiply(k,b,k);k[12]=0;k[13]=0;k[14]=0;a.modelTransform=k;a.renderLocation=f.position};l.updateRotateTiltHandle=
function(a,b,e){e=Z(e,G.POSITIVE_Y);const c=v.fromZRotation(m.sm4d.get(),e.edge*Math.PI/2);v.rotateX(c,c,I);v.multiply(c,b,c);c[12]=0;c[13]=0;c[14]=0;a.modelTransform=c;a.renderLocation=e.position};l.updateShiftRestartHandle=function(a,b,e,c){var f=Z(e,G.NEGATIVE_X);const k=m.sm4d.get();v.rotateZ(k,b,f.edge*Math.PI/2);b=d.normalize(m.sv3d.get(),f.basis);b=d.scale(m.sv3d.get(),b,f.direction*c.computeScreenPixelSizeAt(f.position)*r.SHIFT_RESTART_OFFSET_DISTANCE);d.add(b,b,f.position);f=c.projectToRenderScreen(b,
V.castRenderScreenPointArray3(m.sv3d.get()));const [g,h,q,t]=c.viewport;var p=Math.min(q,t)/16;let n=!0;f[0]<g+p?(f[0]=g+p,n=!1):f[0]>g+q-p&&(f[0]=g+q-p,n=!1);f[1]<h+p?(f[1]=h+p,n=!1):f[1]>h+t-p&&(f[1]=h+t-p,n=!1);p=n;za.fromRender(c,f,S);d.normalize(S.direction,S.direction);c=m.sv3d.get();!p&&C.intersectRay(e,S,c)&&(b=c);k[12]=0;k[13]=0;k[14]=0;a.modelTransform=k;a.renderLocation=y.clone(b);a.state=p?a.state|M:a.state&~M};Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
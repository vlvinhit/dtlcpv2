// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/basicInterfaces ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Material ../lib/ObjectAndLayerIdRenderHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/markerTextureRepository ../materials/stippleTextureRepository ../materials/internal/WaterTextureRepository ./contextCache ./requireUtils ./ScreenshotManager ./testUtils ../../../support/RenderState ../../../webgl/contextUtils".split(" "),
function(e,u,f,D,E,v,w,x,q,F,y,g,Z,aa,G,H,I,n,J,K,L,M,N,O,P,z,Q,R,S,T,U,V,A,W,X,Y){e.RenderView=function(B){function r(b){var a=B.call(this,{})||this;a.events=new E;a.waterTextureRepository=new T.WaterTextureRepository;a._magnifierHelper=new M.MagnifierHelper;a.objectAndLayerIdRenderHelper=v("enable-feature:objectAndLayerId-rendering")?new O.ObjectAndLayerIdRenderHelper:null;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._lastAnimationUpdate=0;a._container=
b.container;a._viewingMode=b.viewingMode;a._initializeContext(b);a.addHandles([q.watch(()=>a.waterTextureRepository?.updating,()=>a.requestRender(),q.initial),q.watch(()=>b.view.qualityProfile,c=>a.renderer?.updateRenderFeature(c),q.syncAndInitial),a._magnifierHelper.events.on("request-render",()=>a.requestRender())]);const {memoryController:k}=b.view.resourceController;a.stippleTextureRepository=S.createStippleTextureRepository(a._rctx,k);a.markerTextureRepository=R.createMarkerTextureRepository(a._rctx,
k);a._shaderTechniqueRepository=new I.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a.stippleTextureRepository,waterTextureRepository:a.waterTextureRepository,markerTextureRepository:a.markerTextureRepository});a._textureRepository=new Q.TextureRepository(b,a._shaderTechniqueRepository,a._rctx);a.addHandles(a._textureRepository.events.on("changed",c=>a.requestRender(c)));a._materialRepository=new L.GLMaterialRepository(a._textureRepository,a._shaderTechniqueRepository,
()=>a.requestRender(),()=>a.requestRender());a._compositingHelper=new J(a._rctx,a._shaderTechniqueRepository);a.renderer=new P.Renderer(b,a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,c=>a.requestRender(c));a._screenshotManager=new A.ScreenshotManager(a._rctx,{renderScene:(c,d,h,l,p)=>a.renderer.render(c,d,h,l,p),requestRenderScene:c=>a.requestRender(c),prepareOverlay:()=>b.options.screenshot.prepareOverlay(),renderOverlay:(c,
d)=>b.options.screenshot.renderOverlay(c,d)},c=>a.events.emit("force-camera-for-screenshot",c),()=>a.renderer.disposeOffscreenBuffers());a._registerFrameTask(b);return a}u._inherits(r,B);var m=r.prototype;m.normalizeCtorArgs=function(){return{}};m.destroy=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=x.removeMaybe(this._frameTask);this._shaderTechniqueRepository=x.destroyMaybe(this._shaderTechniqueRepository)};m.requestRender=function(b=
n.RenderRequestType.UPDATE){this._needsRender=!0;b===n.RenderRequestType.UPDATE&&(this._needsUpdate=!0)};m.setIdleSuspend=function(b){this._idleSuspend!==b&&(this._idleSuspend=b,this.requestRender())};m.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b).then(a=>a[0])};m.takeScreenshotWithOID=function(b){b.objectAndLayerIdColor=!0;return this._screenshotManager.takeScreenshot(b)};m.getAlpha=function(){return!!this._rctx.contextAttributes.alpha};m.getMinimalDepthForArea=function(b,
a,k,c,d,h=d){h=c.constrainWindowSize(a,k,d*c.pixelRatio,h*c.pixelRatio);const l=this._ensureDepthBuffer(h);this.renderer.readDepthPixels(c,h,l);d=Number.MAX_VALUE;for(let p=0;p<h[2]*h[3];p++){const t=K.textureToDepth(4*p,l,c.nearFar);d>t&&t!==c.nearFar[0]&&t!==c.nearFar[1]&&(d=t)}null!=b&&(b=b.pickDepth(a*c.pixelRatio,k*c.pixelRatio,c),null!=b&&d>b&&b!==c.nearFar[0]&&b!==c.nearFar[1]&&(d=b));return d===Number.MAX_VALUE?void 0:d};m._ensureDepthBuffer=function(b){b=4*b[2]*b[3];if(null==this._tmpDepthBuffer||
this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};m.reloadShaders=async function(){V.removeLoadedShaderModules();await this._shaderTechniqueRepository.reloadAll();this.requestRender()};m._registerFrameTask=function(b){const a=b.view.state;let k=!1,c=n.RenderRequestType.BACKGROUND,d=!1;this._frameTask=F.addFrameTask({preRender:({time:h})=>{k=this.updating;c=this._needsUpdate?n.RenderRequestType.UPDATE:n.RenderRequestType.BACKGROUND;b.commitSyncLayers();
var l=y.Milliseconds(h-this._lastAnimationUpdate);if(l>this.renderer.animationTimestep||null!=a.forcedAnimationTime||k||this._needsRender)l=y.Milliseconds(l/this.renderer.animationTimeDilation),l=new N.UpdateParameters(a.camera,l,a.forcedAnimationTime),this.renderer.updateAnimation(l)&&this.requestRender(n.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=h},render:({time:h})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&
0<a.camera.fullHeight){const l=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this.renderer.render(null,null,a,n.Decorations.ON,h);d=!0;l&&this.renderer.hasReflections&&(this.requestRender(n.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:h})=>{const l=new A.ScreenshotContext(a,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update();this._screenshotManager.update(l,
h)},finish:()=>{d&&(this.renderer.finish(a.mode===X.RenderState.IDLE?c:n.RenderRequestType.UPDATE),d=!1)}})};m._initializeContext=function(b){const a=b.options;this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const k=Y.createContextForView("3d",this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:a.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:a.preserveDrawingBuffer??
!1});null==k?w.getLogger(this).error("A WebGL2 context could not be created."):(this._rctx=this._newRenderingContext(k,b),this._loadShaderOnlyExtensions(),!a.alpha&&this._rctx.contextAttributes.alpha&&w.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=v("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};m._newRenderingContext=function(b,a){const k={disabledExtensions:a.options.deactivatedWebGLExtensions||
{},debugWebGLExtensions:a.options.debugWebGLExtensions||{},maxAnisotropy:8},c=(d,h)=>a.view.resourceController.memoryController.newCache(d,h);if(W.contextCache.enabled){let d=C.get(b);if(d)return d.configure(k),d.newCache=c,d.ref(),d;d=new z.RenderingContext(b,k,c);C.set(b,d);d.ref();return d}return new z.RenderingContext(b,k,c)};m._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("textureFloat")};m.getObjectAndLayerIdColor=function(b){return null!=this.objectAndLayerIdRenderHelper?
this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(b):null};u._createClass(r,[{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=
b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"componentObjectCollection",get:function(){null==this._componentObjectCollection&&(this._componentObjectCollection=new H.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode));return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return r}(D);f.__decorate([g.property({type:Boolean,
readOnly:!0})],e.RenderView.prototype,"updating",null);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_rctx",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_container",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_canvas",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"stippleTextureRepository",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"markerTextureRepository",
void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"waterTextureRepository",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_magnifierHelper",void 0);f.__decorate([g.property({readOnly:!0})],e.RenderView.prototype,"objectAndLayerIdRenderHelper",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_textureRepository",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_compositingHelper",void 0);f.__decorate([g.property({autoDestroy:!0,
readOnly:!0})],e.RenderView.prototype,"renderer",void 0);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_screenshotManager",void 0);f.__decorate([g.property()],e.RenderView.prototype,"componentObjectCollection",null);f.__decorate([g.property({autoDestroy:!0})],e.RenderView.prototype,"_componentObjectCollection",void 0);f.__decorate([g.property()],e.RenderView.prototype,"_needsUpdate",void 0);f.__decorate([g.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);
e.RenderView=f.__decorate([G.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const C=U.getContextCache();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
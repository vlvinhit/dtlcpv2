// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../lib/basicInterfaces ../../../support/RenderState ../../../support/screenshotUtils ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/RenderbufferDescriptor ../../../webgl/TextureDescriptor ../../../../core/imageUtils".split(" "),function(q,w,x,A,B,r,C,D,n,t,y,z,u){let E=w._createClass(function(p,h){this.parameters=p;this.frameHasDecorations=
h}),F=function(){function p(c,a,f,d){this._rctx=c;this._renderFunctions=a;this._forceCameraHook=f;this._disposeOffscreenBuffers=d;this.supersample=!0;this._screenshotQueue=[]}var h=p.prototype;h.destroy=function(){this._rctx=null};h.takeScreenshot=async function(c){await this._renderFunctions.prepareOverlay();this._renderFunctions.requestRenderScene(r.RenderRequestType.BACKGROUND);const a=A.createResolver();this._screenshotQueue.push({settings:c,resolver:a});return a.promise};h.update=function(c,
a){for(const f of this._screenshotQueue){if(null==this._rctx){f.resolver.reject();continue}const d=this._renderScreenshot(c,{...f.settings,pixelRatio:f.settings.pixelRatio*c.parameters.camera.pixelRatio},a);f.resolver(d)}this._screenshotQueue.length=0};h._renderScreenshotOverlay=function(c,a,f){c.width=a.width;c.height=a.height;const d=c.getContext("2d"),e=f.pixelRatio;d.save();d.translate(0,a.height);d.scale(1,-1);f.region&&d.translate(-f.region.x,-f.region.y);d.scale(e,e);a=this._renderFunctions.renderOverlay(c,
a);d.restore();return a};h._readbackScreenshot=function(c,a){return c.resample?this._readbackScreenshotResampled({...c,resample:c.resample},a):this._readbackScreenshotImmediate(c,a)};h._readbackScreenshotResampled=function(c,a){const {framebufferWidth:f,framebufferHeight:d,region:e,resample:b}=c,g=this._ensureScreenshotEncodeCanvas();let k=u.createEmptyImageData(f,d,g);this._rctx.gl.readPixels(0,0,f,d,n.PixelFormat.RGBA,n.DataType.UNSIGNED_BYTE,new Uint8Array(k.data.buffer));a();k=this._renderScreenshotOverlay(g,
k,{...c,region:void 0});c=u.createEmptyImageData(e.width,e.height,g);return D.resampleHermite(k,c,!0,b.region.x,d-(b.region.y+b.region.height),b.region.width,b.region.height)};h._readbackScreenshotImmediate=function(c,a){const {framebufferHeight:f,region:d}=c,e=this._ensureScreenshotEncodeCanvas(),b=u.createEmptyImageData(d.width,d.height,e);this._rctx.gl.readPixels(d.x,f-(d.y+d.height),d.width,d.height,n.PixelFormat.RGBA,n.DataType.UNSIGNED_BYTE,new Uint8Array(b.data.buffer));a();return this._renderScreenshotOverlay(e,
b,c)};h._renderScreenshot=function(c,a,f){let d=null;var e=c.parameters.camera,b={width:a.framebufferWidth,height:a.framebufferHeight};t.ensureAttachmentMaxSize(b,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));var g=!1,k=a.disableDecorations&&c.frameHasDecorations,l=a.ignorePadding&&e.pixelRatio!==a.pixelRatio;k=b.width!==e.fullWidth||b.height!==e.fullHeight||k||l||a.objectAndLayerIdColor;const v=a.objectAndLayerIdColor?new t.FramebufferObject(this._rctx,
new z.TextureDescriptor(b.width,b.height),new y.RenderbufferDescriptor(n.RenderbufferFormat.DEPTH_STENCIL,b.width,b.height)):null;if(k){g=e.clone();if(a.ignorePadding){l=B.clone(g.padding);for(var m=0;4>m;m++)l[m]=Math.round(l[m]/g.pixelRatio*a.pixelRatio);g.padding=l}g.fullWidth=b.width;g.fullHeight=b.height;g.pixelRatio=a.pixelRatio;l=e.fovX-g.fovX;m=e.fovY-g.fovY;0>l&&l<m?g.fovX=e.fovX:0>m&&m<l&&(g.fovY=e.fovY);e={camera:g,contentCamera:g,mode:C.RenderState.IDLE,alignPixelEnabled:!0,contentPixelRatio:g.pixelRatio};
this._forceCameraHook(e);g=!0;d=new t.FramebufferObject(this._rctx,new z.TextureDescriptor(b.width,b.height),new y.RenderbufferDescriptor(n.RenderbufferFormat.DEPTH_STENCIL,b.width,b.height));this._renderFunctions.renderScene(d,v,e,a.disableDecorations?r.Decorations.OFF:r.Decorations.ON,f);this._disposeOffscreenBuffers()}b=()=>{this._rctx.bindFramebuffer(null);x.disposeMaybe(d)};f=this._readbackScreenshot(a,b);b();b=null;a.objectAndLayerIdColor&&(e=()=>{this._rctx.bindFramebuffer(null);x.disposeMaybe(v)},
this._rctx.bindFramebuffer(v),b=this._readbackScreenshot(a,e),this._rctx.bindFramebuffer(null),e());if(k&&!this._rctx.contextAttributes.alpha)for(a=3;a<f.data.length;a+=4)f.data[a]=255;if(b&&!this._rctx.contextAttributes.alpha)for(a=3;a<b.data.length;a+=4)b.data[a]=255;g&&this._forceCameraHook(c.parameters);return[f,b]};h._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return w._createClass(p)}();
q.ScreenshotContext=E;q.ScreenshotManager=F;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});
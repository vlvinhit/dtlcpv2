// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../core/typedArrayUtil ../../../../../chunks/mat3 ../../../../../chunks/mat3f32 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/Indices ../../../../../chunks/vec32 ../../../../../chunks/vec33 ../../../../ViewingMode ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./ComponentData ./ComponentObject ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./UniformComponentParameters ./Material/ComponentMaterial ./Material/ComponentTechnique ./Material/shader/ComponentData.glsl ../../lib/ComponentUtils ../../lib/Util ../../lib/VertexAttribute ../../lib/verticalOffsetUtils ../../lib/edgeRendering/bufferLayouts ../../lib/edgeRendering/edgeProcessing ../../lib/TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/VertexArrayObject".split(" "),
function(K,T,U,D,V,L,W,M,X,v,E,Y,Z,aa,ba,N,y,O,ca,da,z,ea,fa,ha,ia,ja,ka,q,la,ma,P,na,oa,pa,qa,ra,sa,F,A,ta){function G(t,h){return t===h?q.ComponentParameterSummary.All:0===t?q.ComponentParameterSummary.None:q.ComponentParameterSummary.Some}const Q=D.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");D=function(){function t(a,b){this._renderManager=a;this._viewingMode=b;this._objects=[new L,new L];this._renderSubmit=new ia.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);
this._hasObjectAndLayerId=U("enable-feature:objectAndLayerId-rendering");this._componentBufferManager=new sa.BufferManager(a.rctx,2+(this._hasObjectAndLayerId?1:0))}var h=t.prototype;h.destroy=function(){na.assert(0===this._objects[z.State.Hidden].length&&0===this._objects[z.State.Visible].length,"ObjectCollection should be empty upon disposal");this._componentBufferManager.destroy();const a=this._objects.flatMap(b=>b.toArray());for(const b of a)b?.destroy()};h.createObject=function(a){const b=new z.ComponentObject;
b.toMapSpace=a.toMapSpace;b.transform=a.transform;b.obb=y.clone(a.obb);b.components=new da(this._componentBufferManager,Y.compactIndices(a.geometry.componentOffsets));b.renderable=this._createRenderable(a,b.components);b.intersectionGeometry=new ea(a.geometry.positionData,b.components);this._objects[b.visible].push(b);return b};h.destroyObject=function(a){this._objects[a.visible].removeUnordered(a);a.destroy();this._notifyDirty()};h.setObjectVisibility=function(a,b){b!==a.visible&&(this._objects[a.visible].removeUnordered(a),
this._objects[b].push(a),a.visible=b,this._notifyDirty())};h.preSubmit=function(a){const b=a.camera.eye;this.visibleObjects.forAll(c=>c.renderable.meta.cameraDepthSquared=v.squaredDistance(b,c.obb.center))};h.getMaterial=function(a){return a.renderable.material};h.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};h.setAllComponentVisibilities=function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};h.forEachVisibleComponent=
function(a,b){return a.components.visibility.forEachComponent(b)};h.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};h.setComponentData=function(a,b){const c=a.renderable.material,d=a.components;var f=d.materialDataBuffer;const k=d.materialDataIndices,e=new ka.UniformComponentParameters;f=f.textureBuffer;const g=new Uint8Array(4),l=new Uint32Array(g.buffer);let p=0,n=0,w=0,r=d.verticalOffsets,H=Infinity,I=-Infinity,J=
!1,u=!1,R=0;for(let m=0;m<d.count;m++){b(m,e);p+=+(1>e.externalColor[3]);n+=+(e.externalColorMixMode===N.ColorMixModeEnum.Replace&&1===e.externalColor[3]);w+=+e.castShadows;N.encodeSymbolColor(e.externalColor,e.externalColorMixMode,g);g[2]=g[2]&254|+e.castShadows;f.setData(k[m],0,g[0],g[1],g[2],g[3]);J||(J=0<m&&R!==l[0]);R=l[0];u||(u=0!==e.elevationOffset);u&&null==r&&(r=Array(m).fill(0));null!=r&&(r[m]=e.elevationOffset);H=Math.min(H,e.elevationOffset);I=Math.max(I,e.elevationOffset);ma.encodeElevationOffset(e.elevationOffset,
g);f.setData(k[m],1,g[0],g[1],g[2],g[3]);const x=e.objectAndLayerIdColor;null!=x&&f.setData(k[m],2,x[0],x[1],x[2],x[3]);e.pickable!==P.getVisibility(d.pickability,m)&&(d.pickability=P.updateVisibilityWithCount(d.pickability,d.count,m,e.pickable))}d.verticalOffsets=u?r:null;a.offsetObb=u?y.computeOffsetObb(a.obb,H,I,this._viewingMode,null!=a.offsetObb?a.offsetObb:y.clone(a.obb)):null;J||u||this._hasObjectAndLayerId?(c.componentParameters=new q.ComponentParametersVarying,c.componentParameters.castShadows=
G(w,d.count),c.componentParameters.transparent=G(p,d.count),c.componentParameters.opaqueOverride=G(n,d.count),c.componentParameters.texture=f,f.updateTexture()):(c.componentParameters=new q.ComponentParametersUniform,c.componentParameters.castShadows=e.castShadows?q.ComponentParameterSummary.All:q.ComponentParameterSummary.None,c.componentParameters.externalColor=e.externalColor,c.componentParameters.externalColorMixMode=e.externalColorMixMode);this._notifyDirty()};h.getComponentAabb=function(a,b,
c,d=!1){a.intersectionGeometry.getComponentAabb(b,c);const f=a.components.verticalOffsets;if(d||null==f)return c;b=f[b];if(this._viewingMode===ba.ViewingMode.Local||0===b)return c[2]+=b,c[5]+=b,c;b=pa.getVerticalOffsetI3S(b);b.localOrigin=a.transform.position;return b.applyToAabb(c)};h.getComponentObb=function(a){return a.obb};h.getObjectTransform=function(a){return a.transform};h.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};h.intersect=function(a,
b,c,d,f,k){null!=f&&(f.localOrigin=a.transform.position);const e=M.invert(S,a.transform.rotationScale);v.sub(B,b,a.transform.position);v.sub(C,c,a.transform.position);v.transformMat3(B,B,e);v.transformMat3(C,C,e);b=M.transpose(S,e);return a.intersectionGeometry.intersect(B,C,d,b,f,a.components.verticalOffsets,k)};h.addEdges=function(a,b,c,d){const {indices:f,positions:k}=a.intersectionGeometry,e=a.components.offsets;return b.addComponentObject(a,a.transform,{center:a.obb.center,radius:y.radius(a.obb)},
k,f,e,c,d)};h.extractEdgeInformation=async function(a,b,c){var d=a.components.visibility;if(d.allInvisible())return{buffer:ra.extractComponentsEdgeLocationsLayout.createBuffer(0),origin:[0,0,0]};const {indices:f,positions:k}=a.intersectionGeometry,e=a.components.offsets,g=qa.EdgeInputBufferLayout.createBuffer(k.length/3);aa.copy(g.position.typedBuffer,k,g.position.typedBufferStride,3);Z.transformMat3View(g.position,g.position,a.transform.rotationScale);this._setComponentIndices(g.componentIndex,f,
e);d=this._computeVisibilityIndices(f,d,e,g.count);a=E.clone(a.transform.position);b=await b.extractComponentsEdgeLocations({indices:d,indicesLength:d.length,skipDeduplicate:!0,data:g,writerSettings:{reducedPrecision:!1,variants:0}},c);return{origin:a,buffer:b}};h._setComponentIndices=function(a,b,c){let d=0;for(let k=0;k<c.length-1;k++){var f=c[k];const e=c[k+1];for(;f<e;f++)a.set(b?b[f]:f,d);d++}};h._computeVisibilityIndices=function(a,b,c,d){if(a&&b.allVisible())return a;let f=0;b.forEachComponentRange((g,
l)=>{f+=c[l]-c[g];return!0});const k=W.isArray(a)?Array(f):2===a?.BYTES_PER_ELEMENT||65536>=d?new Uint16Array(f):new Uint32Array(f);let e=0;b.forEachComponentRange((g,l)=>{g=c[g];for(l=c[l];g<l;g++)k[e++]=a?a[g]:g;return!0});return k};h.addComponentHighlight=function(a,b){a=a.components;null==a.highlightCounts&&(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};h.removeComponentHighlight=function(a,b){a=
a.components;if(null==a.highlightCounts)Q.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],d=a.highlightCounts[a.count];0===c?Q.warn("Removing non-existing highlight."):1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=d-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===d?a.highlightCounts=null:a.highlightCounts[a.count]=d-1)}};h.clearHighlights=function(a){a=a.components;null!=a.highlightCounts&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};
h.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};h._createRenderable=function(a,b){const c=this._renderManager.rctx,d=a.geometry;var f=d.vertices.layoutParameters;const k=F.BufferObject.createVertex(c,A.Usage.STATIC_DRAW,d.vertices.data),e=V.applySome(d.indices,n=>F.BufferObject.createIndex(c,A.Usage.STATIC_DRAW,n));var g=O.glLayout(ja.createVertexBufferLayout(f));const l=new Uint16Array(d.vertices.count);for(let n=0;n<b.count;n++){var p=b.offsets[n];const w=b.offsets[n+
1],r=b.materialDataIndices[n];if(null!=d.indices)for(;p<w;p++)l[d.indices[p]]=r;else for(;p<w;p++)l[p]=r}b=F.BufferObject.createVertex(c,A.Usage.STATIC_DRAW,l.buffer);a=new q.ComponentMaterial(a.transform,a.toMapSpace);g=new ta.VertexArrayObject(c,la.attributeLocations,{data:g,componentIndices:ua},{data:k,componentIndices:b},e);f=new ha.RenderGeometry(g,A.PrimitiveType.TRIANGLES,f,null!=e);return new fa.Renderable(a,f,{cameraDepthSquared:.5,gpuMemoryEstimate:k.byteLength+b.byteLength+(null!=e?e.byteLength:
0)})};h._notifyDirty=function(){this._renderManager.notifyDirty()};T._createClass(t,[{key:"visibleObjects",get:function(){return this._objects[z.State.Visible]}}]);return t}();const ua=O.glLayout(ca.newLayout().u16(oa.VertexAttribute.COMPONENTINDEX)),S=X.create(),B=E.create(),C=E.create();K.ComponentObjectCollection=D;Object.defineProperty(K,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Evented ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../support/requestImageUtils ./DefaultVertexBufferLayouts ./glUtil3D ./Program ./VertexAttribute ../shaders/Magnifier.glsl ../../../magnifier/resources ../../../webgl/enums ../../../webgl/renderState ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),
function(h,w,n,B,C,D,E,x,F,G,q,H,r,P,Q,R,I,y,J,K,L,M,z,N,k,t,u,O){h.MagnifierHelper=function(A){function p(){var a=A.apply(this,arguments)||this;a._handles=new E;a._magnifier=null;a._imageSources=null;a._imageLoadTask=null;a._resources=null;a._passParameters=new z.MagnifierPassParameters;a.events=new D;a.attributeLocations=new Map([[M.VertexAttribute.POSITION,0]]);a._tmpScreenPoint=q.createScreenPointArray();a._tmpRenderPoint=q.createRenderScreenPointArray();return a}w._inherits(p,A);var g=p.prototype;
g.destroy=function(){this._magnifier=null;this._handles.destroy();null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeResources()};g.render=function(a,b){const c=this._validMagnifier;if(null!=c){var d=Math.ceil(b.camera.pixelRatio*c.size);this._updateResources(a,d);if(null!=this._resources){var f=this._passParameters.textures;d=Math.ceil(1/this._factor*d);f.input.resize(d,d);q.screenPointObjectToArray(c.position,this._tmpScreenPoint);var e=b.camera.screenToRender(this._tmpScreenPoint,
this._tmpRenderPoint),l=b.camera.fullHeight,v=.5*d,m=.5*d;e[0]=x.clamp(e[0],v,b.camera.fullWidth-v-1);e[1]=x.clamp(e[1],m,l-m-1);l=Math.floor(e[0]-v);e=Math.floor(e[1]-m);m=this._resources.program;m.bindTexture("textureInput",f.input);a.gl.copyTexImage2D(f.input.descriptor.target,0,f.input.descriptor.pixelFormat,l,e,d,d,0);this._passParameters.magnifier=c;a.useProgram(m);m.bindPass(this._passParameters,b);a.bindVAO(this._resources.vao);a.setPipelineState(this._resources.pipelineState);a.drawArrays(k.PrimitiveType.TRIANGLE_STRIP,
0,4)}}};g._updateResourceLoading=function(){const a=this._validMagnifier;if(null!=a){var b=a.maskUrl,c=a.overlayUrl;null==this._imageLoadTask||this._imageLoadTask.maskUrl===b&&this._imageLoadTask.overlayUrl===c||(this._imageLoadTask.task.abort(),this._imageSources=this._imageLoadTask=null);null==this._imageSources&&null==this._imageLoadTask&&(this._imageLoadTask={maskUrl:b,overlayUrl:c,task:C.createTask(async d=>{const f=null==b||null==c?N.loadMagnifierResources(d):null,e=null!=b?y.requestImage(b,
{signal:d}):f.then(l=>l.mask);d=null!=c?y.requestImage(c,{signal:d}):f.then(l=>l.overlay);this._imageSources={mask:await e,overlay:await d};this._disposeResources();this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}};g._updateResources=function(a,b){this.enabled?null!=this._resources?this._passParameters.textures.size!==b&&(a=this._createTextureResources(a,b),null==a?this._disposeResources():(this._disposeTextureResources(this._passParameters.textures),
this._passParameters.textures=a)):(b=this._createTextureResources(a,b),null!=b&&(this._resources={program:this._createProgram(a),vao:K.createQuadVAO(a,J.Pos2,this.attributeLocations,0,1),pipelineState:t.makePipelineState({blending:t.simpleBlendingParams(k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:t.defaultColorWriteParams})},this._passParameters.textures=b)):this._disposeResources()};g._disposeResources=function(){null!=this._resources&&(this._disposeTextureResources(this._passParameters.textures),
this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)};g._disposeTextureResources=function(a){a.mask.dispose();a.overlay.dispose();a.input.dispose()};g._createTextureResources=function(a,b){if(null==this._imageSources)return null;this._imageSources.overlay.width=b;this._imageSources.overlay.height=b;this._imageSources.mask.width=b;this._imageSources.mask.height=b;const c=new O.TextureDescriptor;c.internalFormat=k.PixelFormat.RGBA;c.wrapMode=k.TextureWrapMode.CLAMP_TO_EDGE;
c.flipped=!0;c.preMultiplyAlpha=!H.isSVG(this._imageSources.overlay.src)||!a.driverTest.svgPremultipliesAlpha.result;const d=new u.Texture(a,c,this._imageSources.overlay);c.pixelFormat=c.internalFormat=k.PixelFormat.ALPHA;c.preMultiplyAlpha=!1;const f=new u.Texture(a,c,this._imageSources.mask);c.pixelFormat=c.internalFormat=k.PixelFormat.RGBA;c.flipped=!1;return{input:new u.Texture(a,c),mask:f,overlay:d,size:b}};g._createProgram=function(a){return new L.Program(a,z.build(),this.attributeLocations)};
w._createClass(p,[{key:"updating",get:function(){return null==this._imageSources&&null!=this._imageLoadTask&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){a!==this._magnifier&&(this._handles.removeAll(),this._magnifier=a,a=()=>{this._updateResourceLoading();this.events.emit("request-render")},null!=this._magnifier&&this._handles.add(G.watch(()=>F.applySome(this._magnifier,b=>b.version),a)),a())}},{key:"enabled",get:function(){return null!=
this._validMagnifier}},{key:"_validMagnifier",get:function(){return null!=this._magnifier&&this._magnifier.visible&&null!=this._magnifier.position&&0<this._magnifier.size?this._magnifier:null}},{key:"_factor",get:function(){return null!=this._magnifier?this._magnifier.factor||1:1}}]);return p}(B);n.__decorate([r.property()],h.MagnifierHelper.prototype,"_imageSources",void 0);n.__decorate([r.property()],h.MagnifierHelper.prototype,"_imageLoadTask",void 0);n.__decorate([r.property({readOnly:!0})],h.MagnifierHelper.prototype,
"updating",null);h.MagnifierHelper=n.__decorate([I.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],h.MagnifierHelper);Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
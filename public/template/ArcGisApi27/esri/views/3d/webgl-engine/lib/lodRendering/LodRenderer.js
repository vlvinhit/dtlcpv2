// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../support/debugFlags ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ../../core/shaderLibrary/ShaderOutput ../Camera ../DefaultVertexAttributeLocations ../IntersectorInterfaces ../Octree ../RenderSlot ../Util ../VertexAttribute ./InstanceData ./InstanceOctree ./LevelSelector ./LodLevel ./RenderInstanceData ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../shaders/DefaultMaterialTechnique ../../../../support/Scheduler ../../../../webgl/Util".split(" "),
function(v,F,w,U,V,W,X,H,y,pa,qa,Y,Z,z,E,B,I,aa,ba,C,ca,J,da,K,G,D,A,q,ea,fa,ha,L,ia,ja,ka,M,N){function O(h,m,l){const a=h.allocateHead();h=h.view;ja.encodeDoubleVec3(m.modelOrigin,l,h.modelOriginHi,h.modelOriginLo,a);h.model.copyFrom(a,m.model,l);h.modelNormal.copyFrom(a,m.modelNormal,l);m.color&&h.color&&h.color.copyFrom(a,m.color,l);m.objectAndLayerIdColor&&h.objectAndLayerIdColor&&h.objectAndLayerIdColor.copyFrom(a,m.objectAndLayerIdColor,l);m.featureAttribute&&h.featureAttribute&&h.featureAttribute.copyFrom(a,
m.featureAttribute,l)}function la(h){let m=ba.newLayout().vec3f(A.VertexAttribute.MODELORIGINHI).vec3f(A.VertexAttribute.MODELORIGINLO).mat3f(A.VertexAttribute.MODEL).mat3f(A.VertexAttribute.MODELNORMAL);null!=h&&h.includes("featureAttribute")&&(m=m.vec4f(A.VertexAttribute.INSTANCEFEATUREATTRIBUTE));null!=h&&h.includes("color")&&(m=m.vec4u8(A.VertexAttribute.INSTANCECOLOR));null!=h&&h.includes("objectAndLayerIdColor")&&(m=m.vec4u8(A.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR));return m}const ma=
h=>{const m=h.baseBoundingSphere.radius;h=h.levels.map(l=>l.minScreenSpaceRadius);return new fa.LevelSelector(m,h)};v.LodRenderer=function(h){function m(a,c){var b=h.call(this,a)||this;b.type=da.IntersectorType.LOD;b.isGround=!1;b._handles=new W;b._levels=[];b._defaultRenderInstanceData=[[]];b._highlightRenderInstanceData=[[]];b._allRenderInstanceData=[b._defaultRenderInstanceData[0],b._highlightRenderInstanceData[0]];b._instanceIndex=0;b._cycleStartIndex=0;b._slicePlane=!1;b._camera=new ca.Camera;
b._updateCyclesWithStaticCamera=-1;b._needFullCycle=!1;b.slots=[G.RenderSlot.OPAQUE_MATERIAL,G.RenderSlot.TRANSPARENT_MATERIAL];b.canRender=!0;b._instanceData=new q.InstanceData({shaderTransformation:a.shaderTransformation},a.optionalFields);b._handles.add(c.registerTask(M.TaskPriority.LOD_RENDERER,F._assertThisInitialized(b)));return b}F._inherits(m,h);var l=m.prototype;l.initialize=function(){this._instanceBufferLayout=la(this.optionalFields);this._glInstanceBufferLayout=aa.glLayout(this._instanceBufferLayout,
1);this._handles.add([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:a})=>{this._requestUpdateCycle();this.metadata.notifyGraphicGeometryChanged(a)}),this._instanceData.events.on("instance-visibility-changed",({index:a})=>{this._requestUpdateCycle(!0);this.metadata.notifyGraphicVisibilityChanged(a)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])};l.destroy=
function(){this._handles.destroy()};l.initializeRenderContext=async function(a,c){this._context=a;const b=a.renderContext.rctx,d=await Promise.allSettled(this.symbol.levels.map(f=>{this._defaultRenderInstanceData[0].push(new L.RenderInstanceData(b,this._instanceBufferLayout));this._highlightRenderInstanceData[0].push(new L.RenderInstanceData(b,this._instanceBufferLayout));return ha.LodLevel.create(a,f,c)})),e=d.map(f=>"fulfilled"===f.status?f.value:null).filter(V.isSome);if(H.isAborted(c)||e.length!==
d.length){e.forEach(f=>f.destroy());H.throwIfAborted(c);for(const f of d)if("rejected"===f.status)throw f.reason;}this._levels=e;this._levelSelector=ma(this)};l.uninitializeRenderContext=function(){this._invalidateOctree();this._levels.forEach(a=>a.destroy());this._defaultRenderInstanceData[0].forEach(a=>a.destroy());this._highlightRenderInstanceData[0].forEach(a=>a.destroy())};l.prepareRender=function(a){if(!I.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const c=a.bindParameters.contentCamera.equals(this._camera);
this._camera.copyFrom(a.bindParameters.contentCamera);c||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(M.noBudget),this._needFullCycle=!1)}};l.prepareTechniques=function(a){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(a.output))return null;const c=this._getInstanceDatas(a.output);if(!c)return null;const b=[];c.forEach(d=>this.levels.forEach((e,f)=>{e.components.forEach(p=>b.push(this._beginComponent(a,d[f],p)))}));return b};l.render=function(a,c){const b=
this._getInstanceDatas(a.output);if(b){var d=0;a.rctx.bindVAO();b.forEach(e=>this.levels.forEach((f,p)=>{f.components.forEach(n=>this._renderComponent(a,c[d++],e[p],n,p))}))}};l._getInstanceDatas=function(a){const c=a!==C.ShaderOutput.Highlight&&a!==C.ShaderOutput.ShadowHighlight;a=a!==C.ShaderOutput.ShadowExcludeHighlight;return c&&a?this._allRenderInstanceData:c?this._defaultRenderInstanceData:a?this._highlightRenderInstanceData:null};l.intersect=function(a,c,b,d){if(this.baseMaterial.isVisible()&&
null!=this._octree){var e=E.create();z.subtract(e,d,b);var f=p=>{this._instanceData.getCombinedModelTransform(p,P);a.transform.set(P);z.transformMat4(Q,b,a.transform.inverse);z.transformMat4(R,d,a.transform.inverse);const n=this._instanceData.getState(p),k=this._instanceData.getLodLevel(p),g=this._levels.length;D.assert(0!==(n&q.StateFlags.ACTIVE),"invalid instance state");D.assert(0<=k&&k<g,"invaid lod level");this._levels[k].intersect(a,c,Q,R,p,this.metadata,g)};this.baseMaterial.parameters.verticalOffset?
this._octree.forEach(f):this._octree.forEachAlongRay(b,e,f)}};l.queryDepthRange=function(a){return this._queryDepthRangeOctree(a)};l.notifyShaderTransformationChanged=function(){this._invalidateOctree();this._requestUpdateCycle()};l._invalidateOctree=function(){this._octreeCached=X.destroyMaybe(this._octreeCached)};l._queryDepthRangeOctree=function(a){if(null==this._octree)return{near:Infinity,far:-Infinity};var c=a.viewForward,b=this._octree.findClosest(c,K.DepthOrder.FRONT_TO_BACK,a.frustum);const d=
this._octree.findClosest(c,K.DepthOrder.BACK_TO_FRONT,a.frustum);if(null==b||null==d)return{near:Infinity,far:-Infinity};const e=a.eye,f=this._instanceData.view;f.boundingSphere.getVec(b,x);z.subtract(x,x,e);b=z.dot(x,c)-x[3];f.boundingSphere.getVec(d,x);z.subtract(x,x,e);c=z.dot(x,c)+x[3];return{near:Math.max(a.near,b),far:Math.min(a.far,c)}};l._requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=-1;this._cycleStartIndex=this._instanceIndex;a&&(this._needFullCycle=!0,this._context.requestRender())};
l._startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._allRenderInstanceData.forEach(a=>a.forEach(c=>c.startUpdateCycle()))};l.runTask=function(a){const {_enableLevelSelection:c,_camera:b,_levelSelector:d}=this;this._allRenderInstanceData.forEach(r=>r.forEach(t=>t.beginUpdate()));const e=this._instanceData,f=e.view;let p=e.size;const n=e.capacity;let k=this._instanceIndex;for(let r=0;r<p&&!a.done;++r){k===this._cycleStartIndex&&this._startUpdateCycle();const t=f.state.get(k);var g=
0;if(t&q.StateFlags.ALLOCATED){var u=f.lodLevel.get(k);t&q.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][u].freeTail();t&q.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][u].freeTail();t&q.StateFlags.REMOVE?e.freeInstance(k):t&q.StateFlags.VISIBLE?(u=0,c&&(f.modelOrigin.getVec(k,S),u=d.selectLevel(S,e.getCombinedMedianScaleFactor(k),b)),g=t&~(q.StateFlags.ACTIVE|q.StateFlags.TRANSFORM_CHANGED),0<=u&&(t&q.StateFlags.HIGHLIGHT?(O(this._highlightRenderInstanceData[0][u],
f,k),g|=q.StateFlags.HIGHLIGHT_ACTIVE):(O(this._defaultRenderInstanceData[0][u],f,k),g|=q.StateFlags.DEFAULT_ACTIVE)),f.state.set(k,g),f.lodLevel.set(k,u)):(g=t&~(q.StateFlags.ACTIVE|q.StateFlags.TRANSFORM_CHANGED),f.state.set(k,g));null!=this._octreeCached&&(u=!!(t&q.StateFlags.ACTIVE),g=!!(g&q.StateFlags.ACTIVE),!u&&g?this._octreeCached.addInstance(k):u&&!g?this._octreeCached.removeInstance(k):u&&g&&t&q.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(k),this._octreeCached.addInstance(k)));
k=k+1===n?0:k+1;a.madeProgress()}else k=k+1===n?0:k+1,p++}this._instanceIndex=k;this._allRenderInstanceData.forEach(r=>r.forEach(t=>t.endUpdate()));this._context.requestRender()};l._beginComponent=function(a,c,b){const {bindParameters:d,rctx:e,output:f}=a;if(0===c.size||!b.material.requiresSlot(d.slot,a.output))return null;a=b.glMaterials.load(e,d.slot,f);return null!=a?a.beginSlot(d):null};l._renderComponent=function(a,c,b,d,e){if(c){var {bindParameters:f,rctx:p}=a;p.appleAmdDriverHelper?.resetIndicesType();
var n=p.bindTechnique(c,d.material.parameters,f);p.bindVAO(d.vao);c.ensureAttributeLocations(d.vao);n.bindDraw(na,f,d.material.parameters);I.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&a.output===C.ShaderOutput.Color&&(n.setUniform4fv("externalColor",T[Math.min(e,T.length-1)]),n.setUniform1i("colorMixMode",ia.colorMixModes.replace));var k=p.capabilities.instancing;a=b.capacity;e=b.headIndex;n=b.tailIndex;var g=b.firstIndex,u=this._glInstanceBufferLayout,r=(t,oa)=>{N.bindVertexBufferLayout(p,J.Default3D,
b.buffer,u,t);k.drawArraysInstanced(c.primitiveType,0,d.vertexCount,oa-t);N.unbindVertexBufferLayout(p,J.Default3D,b.buffer,u)};d.material.parameters.transparent&&null!=g?e>n?(D.assert(g>=n&&g<=e,"invalid firstIndex"),r(g,e),r(n,g)):e<n&&(g<=e?(D.assert(0<=g&&g<=e,"invalid firstIndex"),r(g,e),r(n,a),r(0,g)):(D.assert(g>=n&&g<=a,"invalid firstIndex"),r(g,a),r(0,e),r(n,g))):e>n?r(n,e):e<n&&(r(0,e),r(n,a));p.bindVAO(null)}};F._createClass(m,[{key:"_enableLevelSelection",get:function(){return 1<this.symbol.levels.length}},
{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-1].components[0].material}},{key:"slicePlaneEnabled",get:function(){return this._slicePlane},set:function(a){this._slicePlane=a}},{key:"layerUid",get:function(){return this.metadata.layerUid}},
{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};this._allRenderInstanceData.forEach(c=>c.forEach(b=>{a.cpu+=b.memoryUsage.cpu;a.gpu+=b.memoryUsage.gpu}));return a}},{key:"renderStats",get:function(){const a=this._instanceData.size,c=[];this._levels.forEach((b,d)=>{d=this._allRenderInstanceData[0][d].size+this._allRenderInstanceData[1][d].size;b=b.triangleCount;c.push({renderedInstances:d,renderedTriangles:d*b,trianglesPerInstance:b})});
return{totalInstances:a,renderedInstances:c.reduce((b,d)=>b+d.renderedInstances,0),renderedTriangles:c.reduce((b,d)=>b+d.renderedTriangles,0),levels:c}}},{key:"needsTransparentPass",get:function(){return this._levels.some(a=>a.components.some(c=>c.material.requiresSlot(G.RenderSlot.TRANSPARENT_MATERIAL,C.ShaderOutput.Color)))}},{key:"needsHighlight",get:function(){return this._highlightRenderInstanceData[0].some(a=>0<a.size)}},{key:"_octree",get:function(){if(null==this._octreeCached){const a=this._instanceData,
c=a.view?.state;if(!c)return null;this._octreeCached=new ea.InstanceOctree(a,this.baseBoundingSphere);for(let b=0;b<a.capacity;++b)c.get(b)&q.StateFlags.ACTIVE&&this._octreeCached.addInstance(b)}return this._octreeCached}},{key:"running",get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera}}]);return m}(U);w.__decorate([y.property({constructOnly:!0})],v.LodRenderer.prototype,"symbol",void 0);w.__decorate([y.property({constructOnly:!0})],v.LodRenderer.prototype,"optionalFields",
void 0);w.__decorate([y.property({constructOnly:!0})],v.LodRenderer.prototype,"metadata",void 0);w.__decorate([y.property({constructOnly:!0})],v.LodRenderer.prototype,"shaderTransformation",void 0);w.__decorate([y.property()],v.LodRenderer.prototype,"_instanceData",void 0);w.__decorate([y.property()],v.LodRenderer.prototype,"_cycleStartIndex",void 0);w.__decorate([y.property({readOnly:!0})],v.LodRenderer.prototype,"_enableLevelSelection",null);w.__decorate([y.property()],v.LodRenderer.prototype,"_updateCyclesWithStaticCamera",
void 0);w.__decorate([y.property({readOnly:!0})],v.LodRenderer.prototype,"running",null);v.LodRenderer=w.__decorate([Y.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],v.LodRenderer);const S=E.create(),x=B.create(),P=Z.create(),Q=E.create(),R=E.create(),T=[B.fromValues(1,0,1,1),B.fromValues(0,0,1,1),B.fromValues(0,1,0,1),B.fromValues(1,1,0,1),B.fromValues(1,0,0,1)],na=new ka.DefaultMaterialDrawParameters;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
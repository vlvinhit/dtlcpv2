// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/floatRGBA ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../chunks/sphere ../../support/mathUtils ./depthRange ./Octree ./Util".split(" "),function(x,B,M,N,y,z,C,O,r,A,P,D,t,u,Q){function H(h,g){if(g.visible){var a=t.empty(),b=g.getSpatialQueryAccelerator();null!=b?R(a,
h,b):S(a,h,g.objects);return a}}function R(h,g,a){var b=g.eye;const d=g.viewForward,c=g.frustum,f=k=>k.visible;var e=a.objectCount;500>e?(t.set(q,g.near,Math.min(h.near,g.far)),a.forEachInDepthRange(b,d,u.DepthOrder.FRONT_TO_BACK,q,(k,l)=>{E(h,g,k);q.far=h.near;l.setRange(q)},c,f),t.set(q,Math.max(h.far,g.near),g.far),a.forEachInDepthRange(b,d,u.DepthOrder.BACK_TO_FRONT,q,(k,l)=>{E(h,g,k);q.near=h.far;l.setRange(q)},c,f)):(e=Math.max(Math.min(e,500),Math.ceil(.1*e)),b=a.findClosest(d,u.DepthOrder.FRONT_TO_BACK,
c,f,e),a=a.findClosest(d,u.DepthOrder.BACK_TO_FRONT,c,f,e),b&&a&&(I(h,g,b.boundingVolumeWorldSpace.bounds),I(h,g,a.boundingVolumeWorldSpace.bounds)))}function S(h,g,a){w.clear();a.forAll(b=>{b.visible&&0!==b.geometries.length&&w.add(b)});w.empty||(w.sort(g),t.set(q,g.near,Math.min(h.near,g.far)),w.forEachInDepthRange(q,u.DepthOrder.FRONT_TO_BACK,(b,d)=>{d<h.near&&E(h,g,b)}),t.set(q,Math.max(h.far,g.near),g.far),w.forEachInDepthRange(q,u.DepthOrder.BACK_TO_FRONT,(b,d,c)=>{h.far=Math.max(h.far,c)}))}
function E(h,g,a){if(a.visible&&A.intersectsSphere(g.frustum,a.boundingVolumeWorldSpace.bounds)){var b=a.transformation,d=T;a.geometries.forEach(c=>{y.multiply(d,b,c.shaderTransformation);const f=D.maxScale(d);J(h,g,c.boundingInfo,d,f)})}}function J(h,g,a,b,d){if(null!=a){C.transformMat4(n,a.center,b);var {eye:c,viewForward:f}=g,e=f[0]*(n[0]-c[0])+f[1]*(n[1]-c[1])+f[2]*(n[2]-c[2]);n[3]=a.radius*d;if(!(e-n[3]>h.near&&e+n[3]<h.far)&&A.intersectsSphere(g.frustum,n))if(100<a.radius&&a.getChildren())for(const k of a.getChildren())J(h,
g,k,b,d);else F.unionDepthRangeWithAABB(h,g.viewProjectionMatrix,b,a.bbMin,a.bbMax)}}function I(h,g,a){var b=g.eye;g=g.viewForward;b=(a[0]-b[0])*g[0]+(a[1]-b[1])*g[1]+(a[2]-b[2])*g[2];h.near=Math.min(h.near,b-a[3]);h.far=Math.max(h.far,b+a[3])}let U=function(){function h(){this._items=new N({allocator:a=>a||{obj:null,distance:0,near:0,far:0},deallocator:a=>{a.obj=null;a.distance=0;a.near=0;a.far=0;return a}})}var g=h.prototype;g.clear=function(){this._items.clear()};g.add=function(a){this._items.pushNew().obj=
a};g.sort=function(a){const b=a.eye,d=a.viewForward;this._items.forAll(c=>{const f=c.obj.boundingVolumeWorldSpace.bounds,e=(f[0]-b[0])*d[0]+(f[1]-b[1])*d[1]+(f[2]-b[2])*d[2];c.distance=e;c.near=e-f[3];c.far=e+f[3]});this._items.sort((c,f)=>c.distance-f.distance)};g.forEachInDepthRange=function(a,b,d){if(b===u.DepthOrder.FRONT_TO_BACK)for(b=0;b<this._items.length;++b){var c=this._items.data[b];c.far<a.near||c.near>a.far||d(c.obj,c.near,c.far)}else for(b=this._items.length-1;0<=b;--b)c=this._items.data[b],
c.far<a.near||c.near>a.far||d(c.obj,c.near,c.far)};B._createClass(h,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]);return h}(),L=function(){function h(){this._view=z.create();this._viewProj=z.create();this._frustum=A.create();this._geometries=[];this._near=[];this._far=[];this._nearCandidates=[];this._farCandidates=[];this._looseRange={near:0,far:0}}var g=h.prototype;g.compute=function(a,b){this._reset();y.copy(this._view,a.viewMatrix);
y.multiply(this._viewProj,a.projectionMatrix,this._view);A.copy(this._frustum,a.frustum);a=this._view;const d=a[2],c=a[6],f=a[10],e=a[14];b.forAll(m=>m.forEachGeometry(p=>{if(p.visible&&p.castShadow){var v=p.boundingSphere,K=d*v[0]+c*v[1]+f*v[2]+e,V=K-v[3];v=K+v[3];this._geometries.push(p);this._near.push(-v);this._far.push(-V)}}));b=new t.DepthRange;if(0===this._geometries.length)return b;for(a=0;a<this._geometries.length;++a)this._near[a]>b.far&&(b.far=this._near[a]),2<this._near[a]&&this._far[a]<
b.near&&(b.near=this._far[a]);a=this._looseRange;a.near=Math.max(.5*b.near,2);a.far=2*b.far;var k=0;let l=0;for(let m=0;m<this._geometries.length;++m)this._near[m]<b.near&&(this._near[m]>=a.near?b.near=this._near[m]:this._nearCandidates[k++]=m),this._far[m]>b.far&&(this._far[m]<=a.far?b.far=this._far[m]:this._farCandidates[l++]=m);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return b;this._nearCandidates.sort((m,p)=>this._near[m]<this._near[p]?-1:this._near[m]>this._near[p]?
1:0);this._farCandidates.sort((m,p)=>this._far[m]<this._far[p]?1:this._far[m]>this._far[p]?-1:0);for(a=0;a<this._nearCandidates.length;++a)k=this._nearCandidates[a],this._near[k]<b.near&&(k=this._geometries[k],this._includeNearBoundingInfoRec(k.boundingInfo,k.shaderTransformation,b));for(a=0;a<this._farCandidates.length;++a)k=this._farCandidates[a],this._far[k]>b.far&&(k=this._geometries[k],this._includeFarBoundingInfoRec(k.boundingInfo,k.shaderTransformation,b));this._reset();return b};g._reset=
function(){this._geometries.length=0;this._near.length=0;this._far.length=0;this._nearCandidates.length=0;this._farCandidates.length=0};g._includeNearBoundingInfoRec=function(a,b,d){if(null!=a){C.transformMat4(n,a.center,b);var c=D.maxScale(b),f=n[0],e=n[1],k=n[2];c*=a.radius;var l=this._frustum;if(!(l[0][0]*f+l[0][1]*e+l[0][2]*k+l[0][3]>c||l[1][0]*f+l[1][1]*e+l[1][2]*k+l[1][3]>c||l[2][0]*f+l[2][1]*e+l[2][2]*k+l[2][3]>c||l[3][0]*f+l[3][1]*e+l[3][2]*k+l[3][3]>c||(f=this._view[2]*f+this._view[6]*e+
this._view[10]*k+this._view[14],e=f+c,2>-(f-c)||-e>=d.near)))if(-e>this._looseRange.near)d.near=-e;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(const m of c)this._includeNearBoundingInfoRec(m,b,d);return}F.unionDepthRangeWithAABB(d,this._viewProj,b,a.bbMin,a.bbMax)}}};g._includeFarBoundingInfoRec=function(a,b,d){if(null!=a){var c=a.radius;C.transformMat4(n,a.center,b);var f=D.maxScale(b),e=n[0],k=n[1],l=n[2];c*=f;f=this._frustum;if(!(f[0][0]*e+f[0][1]*k+f[0][2]*l+f[0][3]>c||f[1][0]*e+f[1][1]*
k+f[1][2]*l+f[1][3]>c||f[2][0]*e+f[2][1]*k+f[2][2]*l+f[2][3]>c||f[3][0]*e+f[3][1]*k+f[3][2]*l+f[3][3]>c||(e=this._view[2]*e+this._view[6]*k+this._view[10]*l+this._view[14]-c,-e<=d.far)))if(-e<this._looseRange.far)d.far=-e;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(const m of c)this._includeFarBoundingInfoRec(m,b,d);return}F.unionDepthRangeWithAABB(d,this._viewProj,b,a.bbMin,a.bbMax)}}};return B._createClass(h)}(),W=function(){function h(){this._modelViewProj=z.create();this._clipPosition=
[r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create()]}var g=h.prototype;g.unionDepthRangeWithAABB=function(a,b,d,c,f){var e=this._modelViewProj;y.multiply(e,b,d);b=!1;for(d=0;8>d;++d){const k=this._clipPosition[d],l=0===d||3===d||4===d||7===d?c[0]:f[0],m=0===d||1===d||4===d||5===d?c[1]:f[1],p=4>d?c[2]:f[2];k[0]=e[0]*l+e[4]*m+e[8]*p+e[12];k[1]=e[1]*l+e[5]*m+e[9]*p+e[13];k[2]=e[2]*l+e[6]*m+e[10]*p+e[14];k[3]=e[3]*l+e[7]*m+e[11]*p+e[15]}for(c=0;12>c;++c){f=this._clipTriangle(this._clipPosition[G[c][0]],
this._clipPosition[G[c][1]],this._clipPosition[G[c][2]]);e=!0;for(d=0;d<f.length;++d)if(2<=f[d][3]){e=!1;break}if(!e)for(b=!0,e=0;e<f.length;++e)d=f[e][3],Number.isFinite(d)&&(a.near=Math.min(d,a.near),a.far=Math.max(d,a.far))}return b};g._inside=function(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];Q.assert(!1)};g._intersect=function(a,b,d){let c=0;0===d?c=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===d?c=(-a[3]-a[1])/(b[1]-a[1]+b[3]-
a[3]):2===d?c=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===d&&(c=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return O.lerp(r.create(),a,b,c)};g._clipTriangle=function(a,b,d){a=[a,b,d];for(b=0;4>b;++b){d=a;a=[];for(let c=0;c<d.length;++c){const f=d[c],e=d[(c+1)%d.length];this._inside(e,b)?(this._inside(f,b)||a.push(this._intersect(f,e,b)),a.push(e)):this._inside(f,b)&&a.push(this._intersect(f,e,b))}}return a};return B._createClass(h)}();const G=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,
7],[6,7,2],[4,5,0],[1,0,5]],n=P.create(),T=z.create(),q=t.empty(),w=new U,X=new L,F=new W;x.DepthRangeFromRenderGeometries=L;x.depthRangeFromLayer=H;x.depthRangeFromScene=function(h,g,a){let b=0;if(!g.some(c=>{b+=c.numGeometries;return 1E4<=b}))return X.compute(h,g);const d=t.empty();a.forAll(c=>{c.visible&&t.union(d,H(h,c))});return d};x.textureToDepth=function(h,g,a){return M.unpackFloatRGBA(g,h)*(a[1]-a[0])+a[0]};Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ./BindParameters ./depthRange ./glUtil3D ./ShadowCastRenderer ./ShadowMap ../../../../chunks/ShadowCastAccumulate.glsl ../shaders/ShadowCastAccumulateTechnique ../../../support/Scheduler ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/TextureDescriptor ../../../webgl/Util".split(" "),
function(c,m,f,A,B,C,D,l,n,g,P,Q,E,t,F,G,u,H,p,I,v,J,K,q,L,M,N){c.ShadowAccumulator=function(w){function r(a,d,k,h,O,x){var b=w.call(this,{})||this;b._rctx=a;b._stage=k;b._prepareForShadowMapPass=h;b._renderToShadowMap=O;b._requestRender=x;b._progress=0;b._sampleCount=0;b._passParameters=new v.ShadowCastAccumulatePassParameters;b._cachedLightDirections=[];b._depthRange=u.ZERO;b._previewing=!1;b._handles=new C;b._cameraForcedForScreenshot=!1;b._bindParameters=new G.BindParameters(new I.ShadowMap(a,
k.viewingMode),null,null);b._bindParameters.shadowMap.enabled=!0;b._vao=H.createQuadVAO(a);b._accumulationRenderer=new p.ShadowCastRenderer(d,a,m._assertThisInitialized(b),x);b._handles.add([b._stage.view.resourceController.scheduler.registerTask(K.TaskPriority.SHADOW_ACCUMULATOR,m._assertThisInitialized(b)),n.watch(()=>k.renderView,y=>{b._handles.remove("renderView");null!=y&&b._handles.add(y.events.on("force-camera-for-screenshot",()=>b._cameraForcedForScreenshot=!0),"renderView")},n.syncAndInitial),
n.watch(()=>b._previewing,()=>b._requestRenderIfEnabled(),n.sync)]);return b}m._inherits(r,w);var e=r.prototype;e.normalizeCtorArgs=function(){return{}};e.dispose=function(){this._disable();this._handles.destroy();this._accumulationRenderer=l.disposeMaybe(this._accumulationRenderer);this._bindParameters.shadowMap.dispose();this._fbo=l.disposeMaybe(this._fbo);this._vao=l.disposeMaybe(this._vao);this._accumulationTechniqueCached=l.releaseMaybe(this._accumulationTechniqueCached);this._sampleCount=this._cachedLightDirections.length=
0};e.runTask=function(a){for(this._prepareForShadowMapPass(this._bindParameters);!a.done&&!this._isDoneAccumulating;)this._accumulateShadow(),a.madeProgress();this._requestRender()};e.renderAccumulation=function(a,d,k,h){this._depthRange=d;this._updateCamera(k);this._bindParameters.contentCamera=h;this._passParameters.linearDepthTexture=a;this._passParameters.origin=this._bindParameters.camera.center;this.notifyChange("canAccumulate");if(this.isAccumulating&&this.canAccumulate){(this._previewing||
0===this._progress||this._cameraForcedForScreenshot)&&this._clear();a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(6,this._sampleCount-this._progress);for(d=0;d<a;++d)this._accumulateShadow();this._cameraForcedForScreenshot=!1;this._requestRender()}};e.render=function(a){this._accumulationRenderer.render(a)};e.setOptions=function(a){void 0!==a.enabled&&a.enabled!==(null!=this._fbo)&&(a.enabled?this._enable():this._disable());void 0!==a.previewing&&(this._previewing=a.previewing);void 0!==
a.lightDirections&&(this._lightDirections=a.lightDirections);this._accumulationRenderer.setOptions(a)};e.readAccumulatedShadow=function(a,d){if(!this._isActive||!this._fbo||1>this._progress||0>a||a>=this._fbo.width||0>d||d>=this._fbo.height)return 0;this._fbo.readPixels(a,d,1,1,q.PixelFormat.RGBA,q.PixelType.UNSIGNED_BYTE,z);return z[0]/this._progress};e._enable=function(){this._progress=0;const a=new M.TextureDescriptor;a.wrapMode=q.TextureWrapMode.CLAMP_TO_EDGE;this._fbo=new L.FramebufferObject(this._rctx,
a)};e._disable=function(){this._fbo=l.disposeMaybe(this._fbo)};e._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};e._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(q.ClearBufferBit.COLOR_BUFFER_BIT);this._progress=0};e._accumulateShadow=function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const a=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo);this._rctx.bindTechnique(a,
this._passParameters,this._bindParameters);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(a.primitiveType,0,N.vertexCount(this._vao,"geometry"))};e._sampleLightDirection=function(){this._progress++;return this._lightDirections[104729*this._progress%this._lightDirections.length]};e._updateCamera=function(a){!a.equals(this._bindParameters.camera)&&this._fbo&&(this._bindParameters.camera.copyFrom(a),this._fbo.resize(a.fullWidth,a.fullHeight),this._opacityFromElevation=1-D.smoothstep(p.shadowCastDisableElevationMin,
p.shadowCastDisableElevationMax,a.relativeElevation))};e._requestRenderIfEnabled=function(){this._fbo&&this._requestRender()};m._createClass(r,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo?.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){null==this._accumulationTechniqueCached&&(this._accumulationTechniqueCached=new J.ShadowCastAccumulateTechnique({rctx:this._rctx,
viewingMode:this._stage.viewingMode}));return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return null!=this._fbo&&0<this._sampleCount}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==u.ZERO&&this._opacityFromElevation>p.shadowCastDisabledElevationThreshold}},
{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(a){const d=this._cachedLightDirections;if(!B.equals(d,a,t.equals)){var k=Math.min(v.ShadowCastMaxSamples,a.length);this._sampleCount=d.length=k;for(let h=0;h<k;++h)d[h]=t.copy(d[h]??F.create(),a[h]);this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(a){this._accumulationRenderer.opacityFromElevation=
a}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&0<this._progress}},{key:"test",get:function(){const a=this;return{lightDirections:this._lightDirections,get isDone(){return a._isDoneAccumulating},get isActive(){return a._isActive}}}}]);return r}(A);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_progress",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_sampleCount",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_fbo",
void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_depthRange",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_previewing",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_accumulationRenderer",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isRefining",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isActive",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"canAccumulate",null);f.__decorate([g.property()],
c.ShadowAccumulator.prototype,"_isDoneAccumulating",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_opacityFromElevation",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"running",null);c.ShadowAccumulator=f.__decorate([E.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],c.ShadowAccumulator);const z=new Uint8Array(4);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
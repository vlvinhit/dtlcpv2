// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ./RenderTargetHelper ./TransparencyPassType ../shaders/CompositingTechniqueConfiguration ../../../webgl/enums ../../../webgl/FramebufferObject".split(" "),function(n,q,p,r,k,l,d,t){p=function(){function m(a,b){this._rctx=a;this._compositingHelper=b;this._mainColorTarget=0;this.height=this.width=4;this._background={type:"color",color:[0,0,0,1]};a=this._renderTargetHelper=new r.RenderTargetHelper(a);this._mainColorTargets=
[a.registerColorTarget({name:"mainColorTarget0"}),a.registerColorTarget({name:"mainColorTarget1"})];this.frontFaceTarget=a.registerColorTarget({name:"frontFaceTarget"});this.colorFloatTarget=a.registerColorTarget({name:"colorFloatTarget",dataType:d.PixelType.HALF_FLOAT,internalFormat:d.SizedPixelFormat.RGBA16F,samplingMode:d.TextureSamplingMode.NEAREST});this.alphaFloatTarget=a.registerColorTarget({name:"alphaFloatTarget",dataType:d.PixelType.HALF_FLOAT,internalFormat:d.SizedPixelFormat.R16F,samplingMode:d.TextureSamplingMode.NEAREST});
this.mainDepth=a.registerDepthTarget({name:"mainDepth"});this.linearDepth=a.registerColorTarget({name:"linearDepth",samplingMode:d.TextureSamplingMode.NEAREST});this.terrainLinearDepth=a.registerColorTarget({name:"terrainLinearDepth"});this.geometryLinearDepth=a.registerColorTarget({name:"geometryLinearDepth"});this.normal=a.registerColorTarget({name:"normal"});this.highlight=a.registerColorTarget({name:"highlight",internalFormat:d.SizedPixelFormat.RGBA4,dataType:d.PixelType.UNSIGNED_SHORT_4_4_4_4});
this.hudVisibility=a.registerColorTarget({name:"hudVisibility",internalFormat:d.SizedPixelFormat.RGBA4,dataType:d.PixelType.UNSIGNED_SHORT_4_4_4_4});this.tmpColor=a.registerColorTarget({name:"tmpColor"});this.tmpDepth=a.registerDepthTarget({name:"tmpDepth"});this.hudColor=a.registerColorTarget({name:"hudColor"})}var c=m.prototype;c.dispose=function(){this._renderTargetHelper.dispose()};c.getFramebuffer=function(a,b){return this._renderTargetHelper.getFramebuffer(this.width,this.height,a,b)};c.setupRenderTarget=
function(a){a?this._mainColorTarget=this._mainColorTarget?0:1:(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1]))};c.initializeFrame=function(a){const b=this._rctx;this.width=a.fullWidth;this.height=a.fullHeight;t.ensureAttachmentMaxSize(this,b.parameters.maxTextureSize);this.bindTarget(this.currentColorTarget,this.mainDepth);b.setClearStencil(0);a=this._background.color;b.setClearColor(a[0]*a[3],a[1]*a[3],a[2]*a[3],a[3]);b.clearSafe(d.ClearBufferBit.COLOR_BUFFER_BIT|d.ClearBufferBit.DEPTH_BUFFER_BIT|
d.ClearBufferBit.STENCIL_BUFFER_BIT)};c.composite=function(a){null!=this.colorTexture&&this._compositingHelper.composite(a,this.colorTexture,l.AlphaMode.None)};c.renderTmpAndCompositeToMain=function(a,b,g,e=!1){this.renderToTargets(a,this.tmpColor,e?this.tmpDepth:this.mainDepth,u);this._compositingHelper.composite(b,this._getColorTexture(this.tmpColor),g)};c.compositeAtmosphereToMain=function(a,b,g,e){this.bindTarget(this.currentColorTarget);this._compositingHelper.compositeAtmosphere(a,this._renderTargetHelper.getColorTexture(this.tmpColor,
this.width,this.height),g,e,b);this.bindTarget(this.currentColorTarget,this.mainDepth)};c.renderHUDVisibility=function(a,b=!1){this.renderToTargets(a,this.hudVisibility,b?this.tmpDepth:this.mainDepth,v)};c.compositeTransparentTerrainOntoHUDVisibility=function(a){this.renderToTargets(()=>this._compositingHelper.compositeHUD(a,this._getColorTexture(this.tmpColor)),this.hudVisibility,this.tmpDepth)};c.renderOITPass=function(a,b,g){let e,f;switch(b){case k.TransparencyPassType.Color:e=this.colorFloatTarget;
f=[0,0,0,0];break;case k.TransparencyPassType.Alpha:e=this.alphaFloatTarget;f=[1,1,1,1];break;case k.TransparencyPassType.FrontFace:e=this.frontFaceTarget;f=[0,0,0,0];break;case k.TransparencyPassType.NONE:case k.TransparencyPassType.COUNT:return}g?this.renderToTargets(a,e,this.tmpDepth,f,!0,!0):this.renderToTargets(a,e,this.mainDepth,f,!1)};c.compositeTransparentTerrainOntoMain=function(a){this.bindFramebuffer();this._compositingHelper.composite(a,this._getColorTexture(this.tmpColor),l.AlphaMode.PremultipliedAlpha)};
c.compositeOccludedOntoMain=function(a,b){this.bindFramebuffer();this._compositingHelper.composite(a,this._getColorTexture(this.tmpColor),l.AlphaMode.PremultipliedAlpha,b)};c.compositeTransparentOntoOpaque=function(a,b){b?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1E-13),this._rctx.clearSafe(d.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFramebuffer();this._compositingHelper.compositeOIT(a,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),
this._getColorTexture(this.frontFaceTarget))};c.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)};c.renderDepthDetached=function(a){this.bindTarget(this.currentColorTarget);a();this.bindTarget(this.currentColorTarget,this.mainDepth)};c.disposeTarget=function(a){this._renderTargetHelper.disposeTargetResource(a)};c.renderToFBO=function(a,b,g=!1,e=!1){const f=this._rctx;let h=0;b&&(f.setClearColor(b[0],b[1],b[2],Math.max(1E-13,b[3])),h|=d.ClearBufferBit.COLOR_BUFFER_BIT);g&&(h|=
d.ClearBufferBit.DEPTH_BUFFER_BIT);!1===e?e=0:(!0===e&&(e=255),h|=d.ClearBufferBit.STENCIL_BUFFER_BIT);h&&f.clearSafe(h,e);a();f.gl.flush();this.bindTarget(this.currentColorTarget,this.mainDepth)};c.renderToTargets=function(a,b,g,e,f=!1,h=!1){b=this.bindTarget(b,g);this.renderToFBO(a,e,f,h);return b};c.bindTarget=function(a,b){a=this._renderTargetHelper.getFramebuffer(this.width,this.height,a,b);this._rctx.bindFramebuffer(a);return a};c._getColorTexture=function(a){return this._renderTargetHelper.getColorTexture(a,
this.width,this.height)};q._createClass(m,[{key:"background",get:function(){return this._background},set:function(a){this._background=a}},{key:"currentColorTarget",get:function(){return this._mainColorTargets[this._mainColorTarget]}},{key:"previousColorTarget",get:function(){return this._mainColorTargets[1-this._mainColorTarget]}},{key:"framebuffer",get:function(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}},{key:"colorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}},
{key:"depthTexture",get:function(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}},{key:"linearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}},{key:"terrainLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}},{key:"geometryLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}},{key:"lastFrameColorTexture",
get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}},{key:"normalTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}},{key:"highlightTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}},{key:"hudVisibilityTexture",get:function(){return this._getColorTexture(this.hudVisibility)}},{key:"tmpColorTexture",get:function(){return this._getColorTexture(this.tmpColor)}},{key:"hudColorTexture",
get:function(){return this._getColorTexture(this.hudColor)}},{key:"mainColorTexture",get:function(){return this._getColorTexture(this.currentColorTarget)}},{key:"gpuMemoryUsage",get:function(){let a=0;this._renderTargetHelper&&(a+=this._renderTargetHelper.gpuMemoryUsage);return a}}]);return m}();const u=[0,0,0,0],v=[0,1,0,1];n.OffscreenRendering=p;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
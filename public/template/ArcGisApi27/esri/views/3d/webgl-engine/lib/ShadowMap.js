// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../ViewingMode ./CascadeCamera ./textureUtils ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/RenderbufferDescriptor ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),
function(O,V,pa,W,da,qa,I,J,e,p,P,ea,X,Y,ra,sa,ta,r,E,ua,va,Z,fa){function w(x,m){e.set(ha,x[m],x[m+3]);return ha}O.SnapshotSlot=void 0;(function(x){x[x.Highlight=0]="Highlight";x[x.Default=1]="Default"})(O.SnapshotSlot||(O.SnapshotSlot={}));let T=V._createClass(function(){this.camera=new sa.CascadeCamera;this.lightMat=J.create()}),wa=V._createClass(function(){this.maxNumCascadesLowQuality=this.maxNumCascadesHighQuality=4;this.textureSizeModHighQuality=1.3;this.textureSizeModLowQuality=.9;this.splitSchemeLambda=
0}),za=function(){function x(b,c){this._rctx=b;this._viewingMode=c;this._enabled=!1;this._snapshots=[];this._textureSize=0;this._numCascades=1;this.settings=new wa;this._projectionView=J.create();this._projectionViewInverse=J.create();this._modelViewLight=J.create();this._cascadeDistances=[0,0,0,0,0];this._usedCascadeDistances=Y.create();this._cascades=[new T,new T,new T,new T];this._lastOrigin=null;this._maxTextureSize=Math.min(pa("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}var m=
x.prototype;m.dispose=function(){this.enabled=!1;this.disposeOffscreenBuffers()};m.disposeOffscreenBuffers=function(){this._fbo=da.disposeMaybe(this._fbo);this._discardAllSnapshots()};m.getSnapshot=function(b){return this.enabled?this._snapshots[b]:null};m.start=function(b,c,d,g,u){r.assert(this.enabled);this._textureSize=this._computeTextureSize(b,u,g);this._ensureDepthTexture();const {near:h,far:l}=this._clampNearFar(d);this._computeCascadeDistances(l,h,g);this._setupMatrices(b,c);const {viewMatrix:f,
projectionMatrix:t}=b;for(b=0;b<this._numCascades;++b)this._constructCascade(b,t,f,c);this._lastOrigin=null;this.clear()};m.finish=function(b){r.assert(this.enabled);this._rctx.bindFramebuffer(b)};m.getShadowMapMatrices=function(b){if(!this._lastOrigin||!P.exactEquals(b,this._lastOrigin)){this._lastOrigin=this._lastOrigin||ea.create();P.copy(this._lastOrigin,b);for(let c=0;c<this._numCascades;++c){I.translate(ia,this._cascades[c].lightMat,b);for(let d=0;16>d;++d)ja[16*c+d]=ia[d]}}return ja};m.takeCascadeSnapshotTo=
function(b,c){r.assert(this.enabled);var d=this._ensureSnapshot(c);this._bindFbo();c=this._rctx;d=c.bindTexture(d,Z.Texture.TEXTURE_UNIT_FOR_UPDATES);c.gl.copyTexSubImage2D(E.TextureType.TEXTURE_2D,0,b.camera.viewport[0],b.camera.viewport[1],b.camera.viewport[0],b.camera.viewport[1],b.camera.viewport[2],b.camera.viewport[3]);c.bindTexture(d,Z.Texture.TEXTURE_UNIT_FOR_UPDATES)};m.clear=function(){const b=this._rctx;this._bindFbo();b.setClearColor(1,1,1,1);b.clearSafe(E.ClearBufferBit.COLOR_BUFFER_BIT|
E.ClearBufferBit.DEPTH_BUFFER_BIT)};m._computeTextureSize=function(b,c,d){return Math.floor(Math.min(this._maxTextureSize,ta.applyTextureResizeModulo(Math.min(window.devicePixelRatio,c)/b.pixelRatio*(1===this.numCascades?1:2)*Math.max(b.fullWidth,b.fullHeight)*(d?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality))))};m._ensureDepthTexture=function(){if(this._fbo?.width!==this._textureSize){var b=new fa.TextureDescriptor(this._textureSize);b.wrapMode=E.TextureWrapMode.CLAMP_TO_EDGE;
b.samplingMode=E.TextureSamplingMode.NEAREST;this._fbo?.dispose();this._fbo=new ua.FramebufferObject(this._rctx,b,new va.RenderbufferDescriptor(E.RenderbufferFormat.DEPTH_COMPONENT16,this._textureSize))}};m._ensureSnapshot=function(b){var c=this._snapshots[b];if(null!=c&&c.descriptor.width===this._textureSize)return c;this._discardSnapshot(b);c=new fa.TextureDescriptor;c.wrapMode=E.TextureWrapMode.CLAMP_TO_EDGE;c.samplingMode=E.TextureSamplingMode.NEAREST;c.width=this._textureSize;c.height=this._textureSize;
c=new Z.Texture(this._rctx,c);return this._snapshots[b]=c};m._discardSnapshot=function(b){this._snapshots[b]=da.disposeMaybe(this._snapshots[b])};m._discardAllSnapshots=function(){for(let b=0;b<this._snapshots.length;++b)this._discardSnapshot(b);this._snapshots.length=0};m._bindFbo=function(){const b=this._rctx;b.unbindTexture(this.depthTexture);b.bindFramebuffer(this._fbo)};m._constructCascade=function(b,c,d,g){const u=this._cascades[b];var h=-this._cascadeDistances[b],l=-this._cascadeDistances[b+
1];h=(c[10]*h+c[14])/Math.abs(c[11]*h+c[15]);c=(c[10]*l+c[14])/Math.abs(c[11]*l+c[15]);r.assert(h<c);for(l=0;8>l;++l){X.set(ka,0===l%4||3===l%4?-1:1,0===l%4||1===l%4?-1:1,4>l?h:c,1);var f=C[l];X.transformMat4(f,ka,this._projectionViewInverse);f[0]/=f[3];f[1]/=f[3];f[2]/=f[3]}P.negate(aa,C[0]);u.camera.viewMatrix=I.translate(xa,this._modelViewLight,aa);for(h=0;8>h;++h)P.transformMat4(C[h],C[h],u.camera.viewMatrix);h=C[0][2];c=C[0][2];for(l=1;8>l;++l)h=Math.min(h,C[l][2]),c=Math.max(c,C[l][2]);h-=200;
c+=200;u.camera.near=-c;u.camera.far=-h;l=u.camera;f=1/C[0][3];var t=1/C[4][3];r.assert(f<t);f+=Math.sqrt(f*t);var G=Math.sin(W.acosClamped(d[2]*g[0]+d[6]*g[1]+d[10]*g[2]));d=C;var y=f/G;g=la;var z=ma,k=ya;t=na;f=oa;e.set(A,0,0);for(var q=0;4>q;++q)e.add(A,A,d[q]);e.scale(A,A,.25);e.set(K,0,0);for(q=4;8>q;++q)e.add(K,K,d[q]);e.scale(K,K,.25);e.lerp(H[0],d[4],d[5],.5);e.lerp(H[1],d[5],d[6],.5);e.lerp(H[2],d[6],d[7],.5);e.lerp(H[3],d[7],d[4],.5);q=0;var D=e.squaredDistance(H[0],A);for(var B=1;4>B;++B){var L=
e.squaredDistance(H[B],A);L<D&&(D=L,q=B)}e.subtract(n,H[q],d[q+4]);q=n[0];n[0]=-n[1];n[1]=q;e.subtract(ba,K,A);0>e.dot(ba,n)&&e.negate(n,n);e.lerp(n,n,ba,G);e.normalize(n,n);G=q=e.dot(e.subtract(F,d[0],A),n);for(D=1;8>D;++D)B=e.dot(e.subtract(F,d[D],A),n),B<G?G=B:B>q&&(q=B);e.copy(g,A);e.scale(F,n,G-y);e.add(g,g,F);B=-1;L=1;y=D=0;for(let Q=0;8>Q;++Q){e.subtract(R,d[Q],g);e.normalize(R,R);const S=n[0]*R[1]-n[1]*R[0];0<S?S>B&&(B=S,D=Q):S<L&&(L=S,y=Q)}r.verify(0<B,"leftArea");r.verify(0>L,"rightArea");
e.scale(M,n,G);e.add(M,M,A);e.scale(N,n,q);e.add(N,N,A);U[0]=-n[1];U[1]=n[0];z=r.rayRay2D(g,d[y],N,e.add(F,N,U),1,z);k=r.rayRay2D(g,d[D],N,F,1,k);t=r.rayRay2D(g,d[D],M,e.add(F,M,U),1,t);d=r.rayRay2D(g,d[y],M,F,1,f);r.verify(z,"rayRay");r.verify(k,"rayRay");r.verify(t,"rayRay");r.verify(d,"rayRay");k=la;d=ma;g=na;t=oa;f=l.projectionMatrix;e.subtract(v,g,t);e.scale(v,v,.5);a[0]=v[0];a[1]=v[1];a[2]=0;a[3]=v[1];a[4]=-v[0];a[5]=0;a[6]=v[0]*v[0]+v[1]*v[1];a[7]=v[0]*v[1]-v[1]*v[0];a[8]=1;a[6]=-e.dot(w(a,
0),k);a[7]=-e.dot(w(a,1),k);k=e.dot(w(a,0),g)+a[6];z=e.dot(w(a,1),g)+a[7];y=e.dot(w(a,0),t)+a[6];t=e.dot(w(a,1),t)+a[7];k=-(k+y)/(z+t);a[0]+=a[1]*k;a[3]+=a[4]*k;a[6]+=a[7]*k;k=1/(e.dot(w(a,0),g)+a[6]);z=1/(e.dot(w(a,1),g)+a[7]);a[0]*=k;a[3]*=k;a[6]*=k;a[1]*=z;a[4]*=z;a[7]*=z;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;k=e.dot(w(a,1),d)+a[7];z=e.dot(w(a,2),d)+a[8];y=e.dot(w(a,1),g)+a[7];t=e.dot(w(a,2),g)+a[8];k=-.5*(k/z+y/t);a[1]+=a[2]*k;a[4]+=a[5]*k;a[7]+=a[8]*k;k=e.dot(w(a,1),d)+a[7];z=e.dot(w(a,2),d)+
a[8];y=-z/k;a[1]*=y;a[4]*=y;a[7]*=y;f[0]=a[0];f[1]=a[1];f[2]=0;f[3]=a[2];f[4]=a[3];f[5]=a[4];f[6]=0;f[7]=a[5];f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=a[6];f[13]=a[7];f[14]=0;f[15]=a[8];l.projectionMatrix[10]=2/(h-c);l.projectionMatrix[14]=-(h+c)/(h-c);I.multiply(u.lightMat,u.camera.projectionMatrix,u.camera.viewMatrix);h=this._textureSize/(1===this.numCascades?1:2);u.camera.viewport=[0===b%2?0:h,0===Math.floor(b/2)?0:h,h,h]};m._setupMatrices=function(b,c){I.multiply(this._projectionView,b.projectionMatrix,
b.viewMatrix);I.invert(this._projectionViewInverse,this._projectionView);b=this._viewingMode===ra.ViewingMode.Global?b.eye:P.set(aa,0,0,1);I.lookAt(this._modelViewLight,[0,0,0],[-c[0],-c[1],-c[2]],b)};m._clampNearFar=function(b){let {near:c,far:d}=b;2>c&&(c=2);2>d&&(d=2);c>=d&&(c=2,d=4);return{near:c,far:d}};m._computeCascadeDistances=function(b,c,d){d=d?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(r.logWithBase(b/c,4)),d);
d=(b-c)/this._numCascades;b=(b/c)**(1/this._numCascades);let g=c;for(let u=0;u<this._numCascades+1;++u)this._cascadeDistances[u]=W.lerp(g,c,this.settings.splitSchemeLambda),g*=b,c+=d};V._createClass(x,[{key:"depthTexture",get:function(){return this._fbo?.colorTexture}},{key:"textureSize",get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return X.set(this._usedCascadeDistances,this._cascadeDistances[0],1<this._numCascades?
this._cascadeDistances[1]:Infinity,2<this._numCascades?this._cascadeDistances[2]:Infinity,3<this._numCascades?this._cascadeDistances[3]:Infinity)}},{key:"maxCascades",get:function(){return this.settings.maxNumCascadesHighQuality},set:function(b){this.settings.maxNumCascadesHighQuality=W.clamp(Math.floor(b),1,4)}},{key:"enabled",get:function(){return this._enabled},set:function(b){(this._enabled=b)||this.disposeOffscreenBuffers()}},{key:"ready",get:function(){return this._enabled&&null!=this.depthTexture}},
{key:"cascades",get:function(){for(let b=0;b<this._numCascades;++b)ca[b]=this._cascades[b];ca.length=this._numCascades;return ca}},{key:"gpuMemoryUsage",get:function(){return this._snapshots.reduce((b,c)=>b+(c?.gpuMemoryUsage??0),this._fbo?.gpuMemoryUsage??0)}},{key:"test",get:function(){return{cascades:this._cascades,textureSize:this._textureSize}}}]);return x}();const xa=J.create(),ka=Y.create(),C=[];for(let x=0;8>x;++x)C.push(Y.create());const la=p.create(),ma=p.create(),ya=p.create(),na=p.create(),
oa=p.create(),aa=ea.create(),ca=[],ia=J.create(),ja=Array(64),A=p.create(),K=p.create(),H=[p.create(),p.create(),p.create(),p.create()],n=p.create(),ba=p.create(),F=p.create(),R=p.create(),M=p.create(),N=p.create(),U=p.create(),ha=p.create(),v=p.create(),a=qa.create();O.ShadowMap=za;Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/mathUtils","../../support/debugFlags"],function(p,r,A,u){function t(g,h,a){g.canvas||(g.canvas=document.createElement("canvas"));g.canvas.width=h;g.canvas.height=a;return g.canvas}let E=function(){function g(a,b,c,d=2048){this.text=a;this._alignment=b;this._parameters=c;this._maxSize=d;this._textWidths=[];this._lineWidths=[];this._metricsCached=this._renderPixelRatio=null;this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${a}`;
this._lines=a.split(/\r?\n/)}var h=g.prototype;h._getLineXOffset=function(a){switch(this._alignment){case p.TextRenderAlignment.Left:return this._backgroundHorizontalPadding;case p.TextRenderAlignment.Center:return(this.displayWidth-this._lineWidths[a])/2;case p.TextRenderAlignment.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[a]}};h.render=function(a,b=0,c=0){a.save();b/=this.renderPixelRatio;c/=this.renderPixelRatio;const d=b,e=c;var f=this._haloSize,k=this._firstLineYOffset;
b+=f;c+=k+this._baselinePosition;const l=0<this._haloSize;l&&this._renderHalo(a,d,e,f,k);this._setFontProperties(a,this._renderedFontSize);for(f=0;f<this._lines.length;++f){const m=this._lines[f],n=this._getLineXOffset(f);l&&(a.globalCompositeOperation="destination-out",a.fillStyle="rgb(0, 0, 0)",this._fillText(a,m,b+n,c),this._renderLineDecoration(a,b+n,c,this._textWidths[f]));a.globalCompositeOperation="source-over";a.fillStyle=this._parameters.textStyle;this._fillText(a,m,b+this._getLineXOffset(f),
c);this._renderLineDecoration(a,b+n,c,this._textWidths[f]);c+=this._lineSpacing}if(u.TEXT_SHOW_BASELINE)for(a.strokeStyle="rgb(255, 0, 255, 0.5)",a.setLineDash([2,2]),a.lineWidth=1,b=e+k,c=0;c<this._lines.length;++c)k=b+this._baselinePosition,this._drawLine(a,[d,k],[d+this.displayWidth,k]),b+=this._lineSpacing;u.TEXT_SHOW_BORDER&&(a.strokeStyle="rgb(255, 0, 255, 0.5)",a.setLineDash([]),a.lineWidth=1,this._drawBox(a,[d,e],[this.displayWidth,this.displayHeight]));this._hasBackground&&(this._roundedRect(a,
d,e,this._parameters.definition.background.borderRadius*this.renderPixelRatio),a.globalCompositeOperation="destination-over",a.fillStyle=this._parameters.backgroundStyle,a.fill());a.restore()};h._renderLineDecoration=function(a,b,c,d,e=!1){if("none"!==this._parameters.definition.font.decoration&&0!==d){var f=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case "underline":c+=2*f;break;case "line-through":c-=.33*this._baselinePosition}var k=e?this._haloSize:
0;a.strokeStyle=e?this._parameters.haloStyle:this._parameters.textStyle;a.lineWidth=this._toRenderUnit(f+2*k);a.beginPath();a.moveTo(this._toRenderUnit(b-k),this._toRenderUnit(c));a.lineTo(this._toRenderUnit(b+d+k),this._toRenderUnit(c));a.stroke()}};h._roundedRect=function(a,b,c,d){b=this._toRenderUnit(b);c=this._toRenderUnit(c);const e=this.renderedWidth,f=this.renderedHeight;0===d?a.rect(b,c,e,f):(d=A.clamp(d,0,Math.floor(f/2)),a.beginPath(),a.moveTo(b,c+d),a.arcTo(b,c,b+d,c,d),a.lineTo(b+e-d,
c),a.arcTo(b+e,c,b+e,c+d,d),a.lineTo(b+e,c+f-d),a.arcTo(b+e,c+f,b+e-d,c+f,d),a.lineTo(b+d,c+f),a.arcTo(b,c+f,b,c+f-d,d),a.closePath())};h._renderHalo=function(a,b,c,d,e){const f=this.renderedWidth,k=this.renderedHeight,l=t(v,Math.max(f,512),Math.max(k,512)),m=l.getContext("2d");m.clearRect(0,0,f,k);this._setFontProperties(m,this._renderedFontSize);m.fillStyle=this._parameters.haloStyle;m.strokeStyle=this._parameters.haloStyle;var n=3>this._renderedHaloSize;m.lineJoin=n?"miter":"round";n?this._renderHaloEmulated(m,
d,e):this._renderHaloNative(m,d,e);e+=this._baselinePosition;for(n=0;n<this._lines.length;++n){const q=this._getLineXOffset(n);this._renderLineDecoration(m,d+q,e,this._textWidths[n],!0);e+=this._lineSpacing}a.globalAlpha=this._parameters.definition.halo.color[3];a.drawImage(l,0,0,f,k,this._toRenderUnit(b),this._toRenderUnit(c),f,k);a.globalAlpha=1};h._renderHaloEmulated=function(a,b,c){c+=this._baselinePosition;for(let d=0;d<this._lines.length;++d){const e=this._lines[d],f=this._getLineXOffset(d);
for(const [k,l]of w)this._fillText(a,e,b+f+this._haloSize*k,c+this._haloSize*l);c+=this._lineSpacing}};h._renderHaloNative=function(a,b,c){const d=2*this._haloSize;c+=this._baselinePosition;for(let e=0;e<this._lines.length;++e){const f=this._lines[e],k=this._getLineXOffset(e);for(let l=0;5>l;l++)a.lineWidth=this._toRenderUnit((.6+.1*l)*d),this._strokeText(a,f,b+k,c);c+=this._lineSpacing}};h._setFontProperties=function(a,b){a.font=this._parameters.fontString(b);a.textAlign="left";a.textBaseline="alphabetic"};
h._toRenderUnit=function(a){return a*this.renderPixelRatio};h._toRoundedRenderUnit=function(a){return Math.round(a*this.renderPixelRatio)};h._fillText=function(a,b,c,d){a.fillText(b,this._toRenderUnit(c),this._toRenderUnit(d))};h._strokeText=function(a,b,c,d){a.strokeText(b,this._toRenderUnit(c),this._toRenderUnit(d))};h._drawLine=function(a,b,c){a.beginPath();a.moveTo(this._toRoundedRenderUnit(b[0])+.5,this._toRoundedRenderUnit(b[1])+.5);a.lineTo(this._toRoundedRenderUnit(c[0])+.5,this._toRoundedRenderUnit(c[1])+
.5);a.stroke()};h._drawBox=function(a,b,c){var d=this._toRenderUnit(b[0]);b=this._toRenderUnit(b[1]);var e=this._toRenderUnit(c[0]);const f=this._toRenderUnit(c[1]);c=Math.floor(d)+.5;d=Math.ceil(d+e)-.5;e=Math.floor(b)+.5;b=Math.ceil(b+f)-.5;a.beginPath();a.moveTo(c,e);a.lineTo(d,e);a.lineTo(d,b);a.lineTo(c,b);a.lineTo(c,e);a.stroke()};r._createClass(g,[{key:"displayWidth",get:function(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}},{key:"displayHeight",get:function(){return Math.ceil(this._lineSpacing*
(this._lines.length-1)+this._lineHeight+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}},{key:"renderedWidth",get:function(){return Math.ceil(this._toRenderUnit(this.displayWidth))}},{key:"renderedHeight",get:function(){return Math.ceil(this._toRenderUnit(this.displayHeight))}},{key:"firstRenderedBaselinePosition",get:function(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}},{key:"_firstLineYOffset",get:function(){return this._backgroundTopPadding+
this._haloSize}},{key:"_metrics",get:function(){if(null==this._metricsCached){const c=t(v,512,512).getContext("2d");this._setFontProperties(c,this._fontSize);let d=2*this._haloSize;var a=this._parameters.definition.font;if("italic"===a.style||"oblique"===a.style||"bold"===a.weight||"bolder"===a.weight)d+=.3*c.measureText("A").width;this._textWidths.length=0;let e=this._lineWidths.length=0,f,k,l=0,m=0;this._lines.forEach((n,q)=>{n=c.measureText(n);const x=n.width,y=x+d;this._textWidths.push(x);this._lineWidths.push(y);
e=Math.max(e,y);l=Math.max(l,n.actualBoundingBoxAscent);m=Math.max(m,n.actualBoundingBoxDescent);0===q&&(f=n);q===this._lines.length-1&&(k=n)});a=c.font;var b=z.get(a);b||(b=c.measureText(B),b=new C(b.actualBoundingBoxAscent,b.actualBoundingBoxDescent),z.set(a,b));l=Math.max(l,b.actualBoundingBoxAscent);m=Math.max(m,b.actualBoundingBoxDescent);this._metricsCached=new D(l-(this._hasBackground?f.actualBoundingBoxAscent:l),m-(this._hasBackground?k.actualBoundingBoxDescent:m),l+m,e,l)}return this._metricsCached}},
{key:"_lineSpacing",get:function(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}},{key:"_lineHeight",get:function(){return this._metrics.lineHeight}},{key:"_linePadding",get:function(){return.2*this._lineHeight}},{key:"_baselinePosition",get:function(){return this._metrics.baselinePosition}},{key:"_renderedFontSize",get:function(){return this._toRenderUnit(this._fontSize)}},{key:"_fontSize",get:function(){return this._parameters.definition.size}},{key:"_renderedHaloSize",
get:function(){return this._toRenderUnit(this._haloSize)}},{key:"_haloSize",get:function(){return this._parameters.haloSize}},{key:"_backgroundHorizontalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}},{key:"_backgroundVerticalPadding",get:function(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}},{key:"_backgroundTopPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}},
{key:"_backgroundBottomPadding",get:function(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}},{key:"_hasBackground",get:function(){return!!this._parameters.backgroundStyle}},{key:"renderPixelRatio",get:function(){if(null==this._renderPixelRatio){const a=this._parameters.definition.pixelRatio;this._renderPixelRatio=0<this._maxSize?Math.min(a,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):a}return this._renderPixelRatio}},{key:"_displayWidth",
get:function(){return this._metrics.displayWidth}}]);return g}();const w=[];for(let g=0;360>g;g+=22.5)w.push([Math.cos(Math.PI*g/180),Math.sin(Math.PI*g/180)]);p.TextRenderAlignment=void 0;(function(g){g[g.Left=0]="Left";g[g.Center=1]="Center";g[g.Right=2]="Right"})(p.TextRenderAlignment||(p.TextRenderAlignment={}));const v={canvas:null},B=(()=>{let g="";for(let h=32;127>h;h++)g+=String.fromCharCode(h);return g})();let D=r._createClass(function(g,h,a,b,c){this.paddingTop=g;this.paddingBottom=h;this.lineHeight=
a;this.displayWidth=b;this.baselinePosition=c}),C=r._createClass(function(g,h){this.actualBoundingBoxAscent=g;this.actualBoundingBoxDescent=h});const z=new Map;p.TextRenderer=E;p.getTextHelperCanvas=t;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
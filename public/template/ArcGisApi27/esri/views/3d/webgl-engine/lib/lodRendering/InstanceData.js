// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Evented ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/buffer/BufferView ../../../support/mathUtils ../../../support/buffer/InterleavedLayout ../Util ../VertexAttribute ./RenderInstanceData".split(" "),
function(g,r,p,B,C,D,t,L,M,E,u,F,G,x,H,I,k,J,K,y,f,z){g.StateFlags=void 0;(function(d){d[d.ALLOCATED=1]="ALLOCATED";d[d.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE";d[d.VISIBLE=4]="VISIBLE";d[d.HIGHLIGHT=8]="HIGHLIGHT";d[d.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE";d[d.REMOVE=32]="REMOVE";d[d.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED";d[d.ACTIVE=18]="ACTIVE"})(g.StateFlags||(g.StateFlags={}));let v=r._createClass(function(d){this.localTransform=d.getField(f.VertexAttribute.LOCALTRANSFORM,k.BufferViewMat4f64);this.globalTransform=
d.getField(f.VertexAttribute.GLOBALTRANSFORM,k.BufferViewMat4f64);this.modelOrigin=d.getField(f.VertexAttribute.MODELORIGIN,k.BufferViewVec3f64);this.model=d.getField(f.VertexAttribute.MODEL,k.BufferViewMat3f);this.modelNormal=d.getField(f.VertexAttribute.MODELNORMAL,k.BufferViewMat3f);this.modelScaleFactors=d.getField(f.VertexAttribute.MODELSCALEFACTORS,k.BufferViewVec2f);this.boundingSphere=d.getField(f.VertexAttribute.BOUNDINGSPHERE,k.BufferViewVec4f64);this.featureAttribute=d.getField(f.VertexAttribute.FEATUREATTRIBUTE,
k.BufferViewVec4f);this.color=d.getField(f.VertexAttribute.COLOR,k.BufferViewVec4u8);this.objectAndLayerIdColor=d.getField(f.VertexAttribute.OBJECTANDLAYERIDCOLOR,k.BufferViewVec4u8);this.state=d.getField(f.VertexAttribute.STATE,k.BufferViewUint8);this.lodLevel=d.getField(f.VertexAttribute.LODLEVEL,k.BufferViewUint8)});g.InstanceData=function(d){function q(a,b){a=d.call(this,a)||this;a.events=new D;a._capacity=0;a._size=0;a._next=0;let c=K.newLayout().mat4f64(f.VertexAttribute.LOCALTRANSFORM).mat4f64(f.VertexAttribute.GLOBALTRANSFORM).vec4f64(f.VertexAttribute.BOUNDINGSPHERE).vec3f64(f.VertexAttribute.MODELORIGIN).mat3f(f.VertexAttribute.MODEL).mat3f(f.VertexAttribute.MODELNORMAL).vec2f(f.VertexAttribute.MODELSCALEFACTORS);
b.includes(f.VertexAttribute.FEATUREATTRIBUTE)&&(c=c.vec4f(f.VertexAttribute.FEATUREATTRIBUTE));b.includes(f.VertexAttribute.COLOR)&&(c=c.vec4u8(f.VertexAttribute.COLOR));b.includes(f.VertexAttribute.OBJECTANDLAYERIDCOLOR)&&(c=c.vec4u8(f.VertexAttribute.OBJECTANDLAYERIDCOLOR));c=c.u8(f.VertexAttribute.STATE).u8(f.VertexAttribute.LODLEVEL);a._layout=c;a._capacity=z.INITIAL_CAPACITY;a._buffer=a._layout.createBuffer(a._capacity);a._view=new v(a._buffer);return a}r._inherits(q,d);var e=q.prototype;e.addInstance=
function(){this._size+1>this._capacity&&this._grow();const a=this._findSlot();this._view.state.set(a,g.StateFlags.ALLOCATED);this._size++;this.events.emit("instances-changed");return a};e.removeInstance=function(a){const b=this._view.state;y.assert(0<=a&&a<this._capacity&&0!==(b.get(a)&g.StateFlags.ALLOCATED),"invalid instance handle");this._getStateFlag(a,g.StateFlags.ACTIVE)?this._setStateFlags(a,g.StateFlags.REMOVE):this.freeInstance(a);this.events.emit("instances-changed")};e.freeInstance=function(a){const b=
this._view.state;y.assert(0<=a&&a<this._capacity&&0!==(b.get(a)&g.StateFlags.ALLOCATED),"invalid instance handle");b.set(a,0);this._size--};e.setLocalTransform=function(a,b,c=!0){this._view.localTransform.setMat(a,b);c&&this.updateModelTransform(a)};e.getLocalTransform=function(a,b){this._view.localTransform.getMat(a,b)};e.setGlobalTransform=function(a,b,c=!0){this._view.globalTransform.setMat(a,b);c&&this.updateModelTransform(a)};e.getGlobalTransform=function(a,b){this._view.globalTransform.getMat(a,
b)};e.updateModelTransform=function(a){const b=this._view;var c=h;const m=l;b.localTransform.getMat(a,A);b.globalTransform.getMat(a,w);const n=G.multiply(w,w,A);H.set(c,n[12],n[13],n[14]);b.modelOrigin.setVec(a,c);u.fromMat4(m,n);b.model.setMat(a,m);c=J.scaleFromMatrix(h,n);c.sort();b.modelScaleFactors.set(a,0,c[1]);b.modelScaleFactors.set(a,1,c[2]);u.invert(m,m);u.transpose(m,m);b.modelNormal.setMat(a,m);this._setStateFlags(a,g.StateFlags.TRANSFORM_CHANGED);this.events.emit("instance-transform-changed",
{index:a})};e.getModelTransform=function(a,b){const c=this._view;c.model.getMat(a,l);c.modelOrigin.getVec(a,h);b[0]=l[0];b[1]=l[1];b[2]=l[2];b[3]=0;b[4]=l[3];b[5]=l[4];b[6]=l[5];b[7]=0;b[8]=l[6];b[9]=l[7];b[10]=l[8];b[11]=0;b[12]=h[0];b[13]=h[1];b[14]=h[2];b[15]=1};e.applyShaderTransformation=function(a,b){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,a,b)};e.getCombinedModelTransform=function(a,b){this.getModelTransform(a,b);null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,
a,b);return b};e.getCombinedLocalTransform=function(a,b){this._view.localTransform.getMat(a,b);null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,a,b)};e.getCombinedMaxScaleFactor=function(a){let b=this._view.modelScaleFactors.get(a,1);null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(h,this,a),b*=Math.max(h[0],h[1],h[2]));return b};e.getCombinedMedianScaleFactor=function(a){let b=this._view.modelScaleFactors.get(a,0);if(null!=this.shaderTransformation){this.shaderTransformation.scaleFactor(h,
this,a);a=h[0];var c=h[1];b*=Math.max(Math.min(a,c),Math.min(Math.max(a,c),h[2]))}return b};e.getModel=function(a,b){this._view.model.getMat(a,b)};e.setFeatureAttribute=function(a,b){this._view.featureAttribute.setVec(a,b)};e.getFeatureAttribute=function(a,b){this._view.featureAttribute.getVec(a,b)};e.setColor=function(a,b){this._view.color.setVec(a,b)};e.setObjectAndLayerIdColor=function(a,b){this._view.objectAndLayerIdColor.setVec(a,b)};e.setVisible=function(a,b){b!==this.getVisible(a)&&(this._setStateFlag(a,
g.StateFlags.VISIBLE,b),this.events.emit("instance-visibility-changed",{index:a}))};e.getVisible=function(a){return this._getStateFlag(a,g.StateFlags.VISIBLE)};e.setHighlight=function(a,b){b!==this.getHighlight(a)&&(this._setStateFlag(a,g.StateFlags.HIGHLIGHT,b),this.events.emit("instance-highlight-changed"))};e.getHighlight=function(a){return this._getStateFlag(a,g.StateFlags.HIGHLIGHT)};e.getState=function(a){return this._view.state.get(a)};e.getLodLevel=function(a){return this._view.lodLevel.get(a)};
e.countFlags=function(a){let b=0;for(let c=0;c<this._capacity;++c)this.getState(c)&a&&++b;return b};e._setStateFlags=function(a,b){const c=this._view.state;b|=c.get(a);c.set(a,b)};e._clearStateFlags=function(a,b){const c=this._view.state;b=c.get(a)&~b;c.set(a,b)};e._setStateFlag=function(a,b,c){c?this._setStateFlags(a,b):this._clearStateFlags(a,b)};e._getStateFlag=function(a,b){return!!(this._view.state.get(a)&b)};e._grow=function(){this._capacity=Math.max(z.INITIAL_CAPACITY,Math.floor(this._capacity*
C.ReallocGrowthFactor));this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer);this._view=new v(this._buffer)};e._findSlot=function(){const a=this._view.state;let b=this._next;for(;a.get(b)&g.StateFlags.ALLOCATED;)b=b+1===this._capacity?0:b+1;this._next=b+1===this._capacity?0:b+1;return b};r._createClass(q,[{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){return this._size}},{key:"view",get:function(){return this._view}}]);return q}(B);p.__decorate([t.property({constructOnly:!0})],
g.InstanceData.prototype,"shaderTransformation",void 0);p.__decorate([t.property()],g.InstanceData.prototype,"_size",void 0);p.__decorate([t.property({readOnly:!0})],g.InstanceData.prototype,"size",null);g.InstanceData=p.__decorate([E.subclass("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],g.InstanceData);const h=I.create(),l=F.create(),A=x.create(),w=x.create();g.InstanceDataView=v;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/arrayUtils ../../../../../geometry/support/buffer/BufferView ../Util ../VertexAttribute ./BackedBufferObject".split(" "),function(k,m,l,g,f,h,q){let n=m._createClass(function(d){this.modelOriginHi=d.getField(h.VertexAttribute.MODELORIGINHI,g.BufferViewVec3f);this.modelOriginLo=d.getField(h.VertexAttribute.MODELORIGINLO,g.BufferViewVec3f);this.model=d.getField(h.VertexAttribute.MODEL,g.BufferViewMat3f);this.modelNormal=
d.getField(h.VertexAttribute.MODELNORMAL,g.BufferViewMat3f);this.featureAttribute=d.getField(h.VertexAttribute.INSTANCEFEATUREATTRIBUTE,g.BufferViewVec4f);this.color=d.getField(h.VertexAttribute.INSTANCECOLOR,g.BufferViewVec4u8);this.objectAndLayerIdColor=d.getField(h.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR,g.BufferViewVec4u8)}),r=function(){function d(a,b){this._tailIndex=this._headIndex=0;this._firstIndex=null;this._captureFirstIndex=!0;this._updating=!1;this._prevHeadIndex=0;this._resized=
!1;this._rctx=a;this._instanceBufferLayout=b;this._elementSize=b.stride;this._capacity=1}var c=d.prototype;c.destroy=function(){this._buffer&&this._buffer.destroy()};c.reset=function(){this._tailIndex=this._headIndex=0;this._firstIndex=null};c.startUpdateCycle=function(){this._captureFirstIndex=!0};c.beginUpdate=function(){f.assert(!this._updating,"already updating");this._updating=!0;this._prevHeadIndex=this._headIndex};c.endUpdate=function(){f.assert(this._updating,"not updating");this.size<l.ReallocShrinkTreshold*
this.capacity&&this._shrink();this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex);this._updating=!1};c.allocateHead=function(){f.assert(this._updating,"not updating");this.isFull&&this._grow();const a=this.headIndex;this._captureFirstIndex&&(this._firstIndex=a,this._captureFirstIndex=!1);this._incrementHead();f.assert(this._headIndex!==this._tailIndex,"invalid pointers");return a};c.freeTail=function(){f.assert(this._updating,"not updating");
f.assert(0<this.size,"invalid size");const a=this._tailIndex===this._firstIndex;this._incrementTail();a&&(this._firstIndex=this._tailIndex)};c._grow=function(){this._resize(Math.max(64,Math.floor(this._capacity*l.ReallocGrowthFactor)))};c._shrink=function(){this._resize(Math.max(64,Math.floor(this._capacity*l.ReallocShrinkFactor)))};c._resize=function(a){f.assert(this._updating,"not updating");if(a!==this._capacity){var b=new q(this._rctx,this._elementSize,a);if(this._buffer){this._firstIndex&&(this._firstIndex=
(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,p=this._compactInstances(b);f.assert(p===e,"invalid compaction");this._buffer.destroy();this._tailIndex=0;this._headIndex=p;this._prevHeadIndex=0}this._resized=!0;this._capacity=a;this._buffer=b;this._view=new n(this._instanceBufferLayout.createView(this._buffer.array))}};c._compactInstances=function(a){const b=this._headIndex,e=this._tailIndex;return e<b?(this._buffer.copyRange(e,b,a),b-e):e>b?(this._buffer.copyRange(e,
this._capacity,a),0<b&&this._buffer.copyRange(0,b,a,this._capacity-e),b+(this._capacity-e)):0};c._incrementHead=function(a=1){this._headIndex=(this._headIndex+a)%this._capacity};c._incrementTail=function(a=1){this._tailIndex=(this._tailIndex+a)%this._capacity};c._transferRange=function(a,b){a<b?this._buffer.transferRange(a,b):a>b&&(0<b&&this._buffer.transferRange(0,b),this._buffer.transferRange(a,this._capacity))};m._createClass(d,[{key:"buffer",get:function(){return this._buffer.buffer}},{key:"view",
get:function(){return this._view}},{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){const a=this._headIndex,b=this._tailIndex;return a>=b?a-b:a+this._capacity-b}},{key:"isEmpty",get:function(){return this._headIndex===this._tailIndex}},{key:"isFull",get:function(){return this._tailIndex===(this._headIndex+1)%this._capacity}},{key:"headIndex",get:function(){return this._headIndex}},{key:"tailIndex",get:function(){return this._tailIndex}},{key:"firstIndex",get:function(){return this._firstIndex}},
{key:"memoryUsage",get:function(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}}]);return d}();k.INITIAL_CAPACITY=64;k.RenderInstanceData=r;k.RenderInstanceDataView=n;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
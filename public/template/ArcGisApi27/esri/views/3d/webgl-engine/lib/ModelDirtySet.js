// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/uid ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ./ModelDirtyTypes ./Util".split(" "),function(u,v,n,y,A,z,E,F,G,B,d,w){let C=u._createClass(function(q,p,e){this.operation=q;this.geometry=p;this.states=
e});n=function(q){function p(a){a=q.call(this,a)||this;a._residentGeomRecords=new Map;a._dirtyGeomRecords=new Map;a.dirty=!1;return a}u._inherits(p,q);var e=p.prototype;e.commitLayer=function(a,b){const c=this._dirtyGeomRecords.get(a);c&&(c.forEach((f,g)=>{const h=this._ensureGeomRecord(a,g);f.forEach(({geometry:k,operation:l,states:m},r)=>{let t=!1;if(l===d.DirtyOperation.UPDATE){const x=h.get(r);if(x){if(m&d.DirtyState.TRANSFORMATION){const D=this.model.getObject(g);this.model.updateRenderGeometryTransformation(D,
k,x)&&(t=!0)}t||b.updates.push({renderGeometry:x,updateType:m})}else w.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l===d.DirtyOperation.REMOVE||t)(m=h.get(r))?(b.removes.push(m),h.delete(r)):l===d.DirtyOperation.REMOVE&&w.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove");if(l===d.DirtyOperation.ADD||t)l=this.model.getObject(g),null!=l&&(k=this.model.getRenderGeometry(l,k),b.adds.push(k),h.set(r,k))});0===h.size&&this._residentGeomRecords.get(a).delete(g)}),
0===this._residentGeomRecords.get(a).size&&this._residentGeomRecords.delete(a),this._dirtyGeomRecords.delete(a),this.dirty=this._hasDirtyGeometryRecords)};e.getResidentRenderGeometries=function(a,b){(a=this._residentGeomRecords.get(a))&&a.forEach(c=>c.forEach(f=>b.push(f)))};e._objectStateChanged=function(a,b){for(const c of b.geometries)this._updateOrCreateDirtyRecord(b,c,null,d.DirtyOperation.UPDATE,a)};e.visibilityChanged=function(a){this._objectStateChanged(d.DirtyState.VISIBILITY,a)};e.highlightChanged=
function(a){this._objectStateChanged(d.DirtyState.HIGHLIGHT,a)};e.occlusionChanged=function(a){this._objectStateChanged(d.DirtyState.OCCLUDEE,a)};e.objectGeometryUpdated=function(a){this._updateOrCreateDirtyRecord(a.object,a.geometry,null,d.DirtyOperation.UPDATE,d.DirtyState.GEOMETRY)};e.layerAdded=function(a){a.objects.forAll(b=>this._layerObjectAdded(a,b))};e.layerRemoved=function(a){a.objects.forAll(b=>this._layerObjectRemoved(a,b))};e.layerObjectAdded=function(a){this._layerObjectAdded(a.layer,
a.object)};e._layerObjectAdded=function(a,b){a=a.id;for(const c of b.geometries)this._objectGeometryAdded(b,c,a)};e.layerObjectRemoved=function(a){this._layerObjectRemoved(a.layer,a.object)};e.layerObjectsAdded=function(a){for(const b of a.objects)this._layerObjectAdded(a.layer,b)};e.layerObjectsRemoved=function(a){for(const b of a.objects)this._layerObjectRemoved(a.layer,b)};e._layerObjectRemoved=function(a,b){a=a.id;for(const c of b.geometries)this._objectGeometryRemoved(b,c,a)};e.shaderTransformationChanged=
function(a){(a=this._residentGeomRecords.get(a.id))&&a.forEach((b,c)=>{(c=this.model.getObject(c))&&c.hasVolativeTransformation()&&b.forEach(f=>f.shaderTransformationChanged())})};e.objectTransformation=function(a){const b=this._getParentLayerId(a);this._ensureGeomRecord(b,a.id).forEach(c=>{this._updateOrCreateDirtyRecord(a,c.geometry,b,d.DirtyOperation.UPDATE,d.DirtyState.TRANSFORMATION)})};e.objectShaderTransformation=function(){};e.objectGeometryAdded=function(a){this._objectGeometryAdded(a.object,
a.geometry)};e._objectGeometryAdded=function(a,b,c=null){this._updateOrCreateDirtyRecord(a,b,c,d.DirtyOperation.ADD)};e.objectGeometryRemoved=function(a){this._objectGeometryRemoved(a.object,a.geometry)};e._objectGeometryRemoved=function(a,b,c=null){this._updateOrCreateDirtyRecord(a,b,c,d.DirtyOperation.REMOVE)};e._updateOrCreateDirtyRecord=function(a,b,c,f,g=d.DirtyState.NONE){c=c??this._getParentLayerId(a);const h=b.id;a=this._ensureDirtyRecord(c,a.id);(c=a.get(h))?(b=c.operation,b===d.DirtyOperation.REMOVE&&
f===d.DirtyOperation.ADD&&c.states!==d.DirtyState.NONE?c.operation=d.DirtyOperation.UPDATE:b===d.DirtyOperation.REMOVE&&f===d.DirtyOperation.ADD||b===d.DirtyOperation.ADD&&f===d.DirtyOperation.REMOVE?a.delete(h):(b!==d.DirtyOperation.UPDATE||f!==d.DirtyOperation.REMOVE&&f!==d.DirtyOperation.UPDATE?w.assert((b===d.DirtyOperation.REMOVE||b===d.DirtyOperation.ADD)&&f===d.DirtyOperation.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"):c.operation=f,c.states|=g)):a.set(h,new C(f,b,g));this.dirty=
this._hasDirtyGeometryRecords};e._ensureGeomRecord=function(a,b){let c=this._residentGeomRecords.get(a);c||(c=new Map,this._residentGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};e._ensureDirtyRecord=function(a,b){let c=this._dirtyGeomRecords.get(a);c||(c=new Map,this._dirtyGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};e._getParentLayerId=function(a){return a.parentLayer?a.parentLayer.id:A.NullUID};e.formatDebugInfo=function(){const a=["ADD","UPD",void 0,
"REM"];let b="";this._dirtyGeomRecords.forEach((c,f)=>{c.forEach((g,h)=>{0<b.length&&(b+="\n");b+=f+"."+h;const k=[];g.forEach(l=>{const m=l.operation;k[m]||(k[m]=[]);k[m].push(l.geometry.id)});for(g=0;g<k.length;g++)if(k[g])for(b+=" "+a[g-1]+": ",h=0;h<k[g].length;h++)b+=k[g][h]+", "})});return b};u._createClass(p,[{key:"_hasDirtyGeometryRecords",get:function(){return y.someMap(this._dirtyGeomRecords,a=>y.someMap(a,b=>b&&0<b.size))}},{key:"test",get:function(){const a=this;return{get residentLayerCount(){return a._residentGeomRecords.size},
get residentObjectCount(){return Array.from(a._residentGeomRecords.values()).reduce((b,c)=>b+c.size,0)},commit:b=>a._dirtyGeomRecords.forEach((c,f)=>a.commitLayer(f,b))}}}]);return p}(n);v.__decorate([z.property({constructOnly:!0})],n.prototype,"model",void 0);v.__decorate([z.property()],n.prototype,"dirty",void 0);return n=v.__decorate([B.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],n)});
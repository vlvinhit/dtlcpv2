// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ./basicInterfaces ./ContentObjectType ./TextureTechnique ./TextureTechniqueConfiguration ./Util ../../../support/Scheduler".split(" "),
function(e,m,k,v,w,q,r,n,F,G,H,x,t,y,z,A,B,C){e.TextureRepository=function(h){function f(b,a,g){var c=h.call(this,{})||this;c._stage=b;c._techniqueRepository=a;c._rctx=g;c._textures=new Map;c._loadingCount=0;c._frameUpdates=new Map;c.events=new w;c._frameTask=b.view.resourceController.scheduler.registerTask(C.TaskPriority.TEXTURE_UNLOAD);return c}m._inherits(f,h);var d=f.prototype;d.normalizeCtorArgs=function(){return{}};d.destroy=function(){this._frameTask.remove();this._stage.forEachOfType(y.ContentObjectType.Texture,
b=>b.unload())};d.acquire=function(b){const a=this._textures.get(b);return a?(a.ref(),a.loadingPromise??a):this._createNewRef(b)};d.update=function(){let b=!1;this._frameUpdates.forEach(a=>{const g=a.texture.frameUpdate(a.previousToken);0<=g&&g!==a.previousToken&&(a.previousToken=g,b=!0)});b&&this.events.emit("changed",t.RenderRequestType.BACKGROUND)};d._createNewRef=function(b){const a=this._stage.getObject(b);if(null==a)return B.assert(void 0!==a),null;const g=a.events.on("unloaded",()=>{g.remove();
this._onTextureUnloaded(b)}),c=new D(b,()=>{this._frameTask.schedule(()=>{c.isUnreferenced&&a.unload()})});this._textures.set(b,c);c.ref();if(null!=a.glTexture)return this._updateGLTexture(c,a.glTexture),a.requiresFrameUpdates&&this._frameUpdates.set(b,{texture:a,previousToken:-1}),c;this._loadingCount++;c.loadingPromise=this._stage.schedule(()=>{const p=a.load(this._rctx),u=l=>{this._loadingCount--;c.loadingPromise=null;this._updateGLTexture(c,l);a.requiresFrameUpdates&&this._frameUpdates.set(b,
{texture:a,previousToken:-1});return c},E=l=>{this._loadingCount--;c.loadingPromise=null;r.isAbortError(l)||q.getLogger(this).error(l);return null};return r.isPromiseLike(p)?p.then(u,E):u(p)});return c.loadingPromise};d._updateGLTexture=function(b,a){b.glTexture=a;this.events.emit("changed",t.RenderRequestType.UPDATE)};d._onTextureUnloaded=function(b){this._textures.delete(b);this._frameUpdates.delete(b)};m._createClass(f,[{key:"updating",get:function(){return 0<this._loadingCount||this._frameTask.updating}},
{key:"textureTechnique",get:function(){null==this._textureTechnique&&(this._textureTechnique=this._techniqueRepository.acquire(z.TextureTechnique,new A.TextureTechniqueConfiguration));return this._textureTechnique}}]);return f}(v);k.__decorate([n.property()],e.TextureRepository.prototype,"_loadingCount",void 0);k.__decorate([n.property()],e.TextureRepository.prototype,"_frameTask",void 0);k.__decorate([n.property()],e.TextureRepository.prototype,"updating",null);e.TextureRepository=k.__decorate([x.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],
e.TextureRepository);let D=function(){function h(d,b){this.id=d;this._release=b;this._refCount=0}var f=h.prototype;f.ref=function(){++this._refCount};f.release=function(){--this._refCount;0<this._refCount||(0===this._refCount?this._release():(q.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0))};m._createClass(h,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]);return h}();
Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
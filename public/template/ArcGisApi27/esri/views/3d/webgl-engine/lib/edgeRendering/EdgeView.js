// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../core/support/WatchUpdatingTracking ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(t,u,v,I,M,ba,N,J,x,xa,ya,ca,K,da,O,A,L,ea,P,fa,ha,ia,ja,ka,la,ma,na,oa,B,C,Q,R,z,pa,qa,S,ra,y,sa,D,T,U){function V(m){null!=m&&(m.vao.vertexBuffers.instances.dispose(),m.vao.disposeVAOOnly(),m.vao=null)}function ta(m){let n=null,k=null;for(let a=0;a<m.geometries.length;a++){const b=m.geometries[a];if(b.material.supportsEdges){if(!n)n=b.transformation;else if(!M.equals(n,b.transformation))return!1;if(!k&&null!=b.localOrigin)k=b;else if(k&&null!=k.localOrigin&&null!=b.localOrigin&&k.localOrigin.id!==
b.localOrigin.id)return!1}}return!0}function F(m,n,k){n*=k;k=M.binaryIndexOf(m,n,!0);return-1===k?n<m[0]?m.length:0:m.length-k}t.EdgeView=function(m){function n(a){var b=m.call(this,a)||this;b._updatingHandles=new ea.WatchUpdatingTracking;b._perObjectData=new Map;b._perObjectDataEvictionCache=new Set;b._renderers=new Map;b._gpuMemoryUsage=0;b._workerAbort=new AbortController;b._tmpModelPosition=L.create();b._localOrigins=new ma.LocalOriginManager(new ka.GridLocalOriginFactory(a.renderSR));return b}
u._inherits(n,m);var k=n.prototype;k.initialize=function(){this._worker=new qa.EdgeWorkerHandle(this.schedule);this._componentColorManager=new sa.BufferManager(this.rctx,3);const a=C.VertexLayout.createBuffer(4);for(let b=0;4>b;b++)a.sideness.set(b,0,0===b||3===b?0:1),a.sideness.set(b,1,0===b||1===b?0:1);this._verticesBufferObject=T.BufferObject.createVertex(this.rctx,U.Usage.STATIC_DRAW,a.buffer)};k.destroy=function(){this.destroyed||(this._perObjectData.forEach(a=>this._discardObjectEntry(a)),this._perObjectData.clear(),
this._strokesTexture=J.disposeMaybe(this._strokesTexture),this._componentColorManager=J.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=J.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",ua))};k.shouldRender=function(){return 0<this._renderers.size};k.addComponentObject=async function(a,b,c,e,g,d,f,l){if(this.hasObject(a))return this.getObjectMemoryUsage(a);let h;
c=new W(new Promise(p=>h=p),c.center,c.radius);this._perObjectData.set(a,c);a=await this._updatingHandles.addPromise(this._addComponentGeometry(b,c,e,g,d,f,l));this.setNeedsRender();h();return a};k.addOrUpdateObject3D=async function(a,b,c,e){if(this.destroyed)ba.getLogger(this).warn("Attempt to add an object to a destroyed instance");else{var g=this._perObjectData.get(a);0<g?.renderables.length&&this._perObjectDataEvictionCache.add(g);var d,f=a.boundingVolumeWorldSpace.bounds;f=new W(new Promise(h=>
d=h),P.getCenter(f),P.getRadius(f));this._perObjectData.set(a,f);var l=[];if(c.mergeGeometries&&1<a.geometries.length&&ta(a))l.push(this._addObjectMergedGeometries(a,f,b,c,e));else for(let h=0;h<a.geometries.length;h++){const p=a.geometries[h];p.material.supportsEdges&&l.push(this._addGeometry(a,f,p,b[0],c,e))}await this._updatingHandles.addPromise(Promise.all(l));this._perObjectDataEvictionCache.delete(f);this._discardObjectEntry(g);this.setNeedsRender();d()}};k._discardObjectEntry=function(a){a&&
(a.renderables.length&&(a.renderables.forEach(b=>this._removeRenderable(b)),this.setNeedsRender()),a.loaded=null)};k.hasObject=function(a){return this._perObjectData.has(a)};k.updateAllComponentOpacities=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));if(null!=a){var c=b instanceof Array?e=>b[e]:()=>b;a.renderables.forEach(e=>{const g=e.components.meta.length;for(let d=0;d<g;d++){const f=c(d),l=e.components.meta[d],h=l.index;l.material.opacity=f;e.components.buffer.textureBuffer.setDataElement(h,
1,3,255*f)}this._updateTransparency(e)});this.setNeedsRender()}};k.getObjectMemoryUsage=async function(a){a=await this._getObjectEntry(a);return null!=a?a.renderables.reduce((b,c)=>b+c.statistics.gpuMemoryUsage,0):0};k.updateAllComponentMaterials=async function(a,b,c,e){const g=a instanceof na.Object3D,d=!!c.hasSlicePlane,f=y.determineRendererType(b),l=z.EdgeRenderer.getKey(f,d,g);a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(h=>{if(l!==h.rendererKey){var p=
this._renderers.get(h.rendererKey);const q=this._acquireRenderer(f,d,g);p.removeRenderable(h);--p.refCount;h.rendererKey=l;q.addRenderable(h)}for(p=0;p<b.length;p++)h.components.meta[p].material=b[p];e&&this._updateComponentBuffer(h.components);this._updateTransparency(h)}),this.setNeedsRender())};k.updateAllVerticalOffsets=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(c=>{const e=c.components.meta;for(let g=0;g<e.length;g++)c.components.meta[g].verticalOffset=
b?.[g]??0;this._updateComponentBuffer(c.components)}),this.setNeedsRender())};k.updateObjectVisibility=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(c=>c.visible=b),this.setNeedsRender())};k.removeObject=function(a){const b=this._perObjectData.get(a);b&&(this._perObjectData.delete(a),this._discardObjectEntry(b))};k._getObjectEntry=async function(a){a=this._perObjectData.get(a);if(!a)throw Error("no object");await a.loaded;return null==
a.loaded?null:a};k.render=function(a,b){if(null!=this._componentColorManager){this._localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,e=L.create(),g=new ja.TwoVectorPosition,d=0,f=0;this._renderers.forEach(h=>{if(0===h.refCount)this._renderers.delete(h.key),h.dispose();else{let p=!0,q=!0;h.forEachRenderable(r=>{r.visible&&(d+=r.statistics.averageEdgeLength,f++,p&&r.regular&&(h.updateTechnique(a,!1),p=!1),q&&r.silhouette&&(h.updateTechnique(a,!0),q=!1))},
b)}});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==f){var l=new pa.EdgePassParameters(40*d/f,b);A.set(e,c[3],c[7],c[11]);g.set(e);A.copy(l.transformWorldFromViewTH,g.high);A.copy(l.transformWorldFromViewTL,g.low);K.fromMat4(l.transformViewFromCameraRelativeRS,a.camera.viewMatrix);K.transpose(X,l.transformViewFromCameraRelativeRS);K.invert(l.transformNormalViewFromGlobal,X);l.transformProjFromView=a.camera.projectionMatrix;this._updateObjectCameraDistances(a);
this._renderers.forEach(h=>{this._renderRegularEdges(h,a,l);this._renderSilhouetteEdges(h,a,l)})}}};k._updateTransparency=function(a){const b=y.determineEdgeTransparency(a.components.meta),c=y.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=c,this._renderers.get(a.rendererKey).setRenderablesDirty()};k._computeModelTransformWithLocalOrigin=function(a,b,c){a.getCombinedShaderTransformation(b,c);a=null!=b.localOrigin?
this._localOrigins.register(b.localOrigin):this._localOrigins.acquire(A.set(this._tmpModelPosition,c[12],c[13],c[14]));b.localOrigin=a.origin;la.applyToModelMatrix(a.origin.vec3,c);return a};k._updateComponentBuffer=function(a){const {meta:b,buffer:c}=a;a=new Uint8Array(4);for(let g=0;g<b.length;g++){var e=b[g].material;const d=b[g].index,f=N.clamp(Math.round(e.size*z.LINE_WIDTH_FRACTION_FACTOR),0,255),l=N.clamp(e.extensionLength,-z.EXTENSION_LENGTH_OFFSET,255-z.EXTENSION_LENGTH_OFFSET)+z.EXTENSION_LENGTH_OFFSET,
h="solid"===e.type?R.EdgeType.SOLID:R.EdgeType.SKETCH,p=255*e.opacity;e=e.color;c.textureBuffer.setData(d,0,255*e[0],255*e[1],255*e[2],255*e[3]);c.textureBuffer.setData(d,1,f,l,h,p);ia.encodeElevationOffset(b[g].verticalOffset,a);c.textureBuffer.setData(d,2,a[0],a[1],a[2],a[3])}};k._createComponentBuffers=function(a){if(null==this._componentColorManager)return null;const b=[],c=this._componentColorManager.getBuffer(a.length);for(let e=0;e<a.length;e++){const g=a[e],d=c.acquireIndex();b.push({index:d,
verticalOffset:0,material:g})}a=new va(c,b);this._updateComponentBuffer(a);return a};k._extractEdges=function(a,b,c,e,g,d=g.length){return this._worker.process({data:b,indices:g,indicesLength:d,writerSettings:a,skipDeduplicate:c},this._workerAbort.signal,e)};k._createRenderable=function(a,b,c,e,g){var d=l=>null!=this._verticesBufferObject?new wa(new oa.VertexArrayObject(this.rctx,C.EdgeShaderAttributeLocations,{vertices:C.glVertexLayout,instances:l===D.EdgeSilhouette.REGULAR?Q.RegularEdgeBufferWriter.glLayout:
Q.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:T.BufferObject.createVertex(this.rctx,U.Usage.STATIC_DRAW,l===D.EdgeSilhouette.REGULAR?a.regular.instancesData.buffer:a.silhouette.instancesData.buffer)}),l===D.EdgeSilhouette.REGULAR?a.regular.lodInfo:a.silhouette.lodInfo):null;const f=0<a.regular.lodInfo.lengths.length?d(D.EdgeSilhouette.REGULAR):null;d=0<a.silhouette.lodInfo.lengths.length?d(D.EdgeSilhouette.SILHOUETTE):null;return new G(f,d,{gpuMemoryUsage:(f?.vao.memoryEstimate??
0)+(d?.vao.memoryEstimate??0),externalMemoryUsage:g,averageEdgeLength:a.averageEdgeLength},c,y.determineEdgeTransparency(b.meta),y.determineObjectTransparency(b.meta),b,e)};k._addGeometry=async function(a,b,c,e,g,d){var f=c.vertexAttributes.get(B.VertexAttribute.POSITION);const l=c.indices.get(B.VertexAttribute.POSITION),h=O.create();a=this._computeModelTransformWithLocalOrigin(a,c,h);f=new Y(f,l,h,a);return this._addPositionData(b,f,c.edgeIndicesLength,e,g,d)};k._addPositionData=async function(a,
b,c,e,g,d=!1){if(null!=a.loaded){var f=this._createComponentBuffers([e]);if(!(null==f||0>=c)){e=this._acquireRenderer(e.type,!!g.hasSlicePlane,!0);var {modelTransform:l,origin:h}=b;g=b.indices;b=b.position;var p=b.data.length/b.size,q=C.EdgeInputBufferLayout.createBuffer(p);for(let r=0;r<p;r++)q.position.set(r,0,b.data[r*b.size]),q.position.set(r,1,b.data[r*b.size+1]),q.position.set(r,2,b.data[r*b.size+2]);y.fillComponenBufferIndices(f.meta,[0,q.componentIndex.count],q.componentIndex);c=await this._updatingHandles.addPromise(this._extractEdges(e.writerSettings,
q,!1,d,g,c));null!=a.loaded&&(f=this._createRenderable(c,f,new Z(l,h),e.key,!1),a.renderables.push(f),e.addRenderable(f),this._gpuMemoryUsage+=f.statistics.gpuMemoryUsage)}}};k._addComponentGeometry=async function(a,b,c,e,g,d,f){if(null==b.loaded)return 0;const l=this._createComponentBuffers(d);if(null==l)return 0;d=y.determineRendererType(d);f=this._acquireRenderer(d,f.hasSlicePlane||!1,!1);d=C.EdgeInputBufferLayout.createBuffer(c.length/3);fa.copy(d.position.typedBuffer,c,d.position.typedBufferStride,
3);y.fillComponenBufferIndices(l.meta,g,d.componentIndex,e);c=await this._updatingHandles.addPromise(this._extractEdges(f.writerSettings,d,!0,!1,e));if(null==b.loaded)return 0;a=this._createRenderable(c,l,a,f.key,!0);b.renderables.push(a);f.addRenderable(a);return a.statistics.gpuMemoryUsage};k._addObjectMergedGeometries=async function(a,b,c,e,g){var d=new Map,f=0,l=null,h=0;for(var p=0;p<a.geometries.length;p++){var q=a.geometries[p];if(q.material.supportsEdges){!l&&q.localOrigin&&(l=q);var r=q.vertexAttributes.get(B.VertexAttribute.POSITION);
h+=r.data.length/r.size;f+=q.edgeIndicesLength}}h=65536<=h?Uint32Array:Uint16Array;f=f?new h(f):null;h=[];p=0;for(q=0;q<a.geometries.length;q++){r=a.geometries[q];if(!r.material.supportsEdges)continue;var w=r.vertexAttributes.get(B.VertexAttribute.POSITION);const aa=r.indices.get(B.VertexAttribute.POSITION);let H=d.get(w.data);if(null==H){H=h.length/3;for(let E=0;E<w.data.length;E+=w.size)h.push(w.data[E]),h.push(w.data[E+1]),h.push(w.data[E+2]);d.set(w.data,H)}if(aa)for(w=0;w<r.edgeIndicesLength;w++)f[p++]=
H+aa[w]}l=l||a.geometries[0];d=O.create();l=this._computeModelTransformWithLocalOrigin(a,l,d);for(p=0;p<a.geometries.length;p++)a.geometries[p].localOrigin=l.origin;a=new Y({data:h,size:3},f,d,l);await this._updatingHandles.addPromise(this._addPositionData(b,a,f.length,c[0],e,g))};k._acquireRenderer=function(a,b,c){const e=z.EdgeRenderer.getKey(a,b,c);let g=this._renderers.get(e);null==this._strokesTexture&&(this._strokesTexture=ra.generateStrokesTexture(this.rctx));g||(g=new z.EdgeRenderer(this.rctx,
this.techniqueRepository,{type:a,hasSlicePlane:b,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===ha.ViewingMode.Global}),this._renderers.set(e,g));++g.refCount;return g};k._removeRenderable=function(a){V(a.regular);V(a.silhouette);const b=this._renderers.get(a.rendererKey);if(b){b.removeRenderable(a);--b.refCount;"origin"in a.transform&&this._localOrigins.release(a.transform.origin);this._gpuMemoryUsage-=a.statistics.externalMemoryUsage?0:a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}};
k._updateObjectCameraDistances=function(a){const b=a.camera.eye,c=a.camera.viewForward,e=L.create();a=g=>{A.sub(e,g.center,b);const d=A.dot(e,c),f=g.radius,l=d<-f?Infinity:d<f?0:d-f;g.renderables.forEach(h=>h.distanceToCamera=l)};this._perObjectData.forEach(a);this._perObjectDataEvictionCache.forEach(a)};k._renderRegularEdges=function(a,b,c){const e=a.bindRegularEdges(c,b),g=b.camera.perScreenPixelRatio;a.forEachRenderable(d=>{if(null!=d.regular&&d.visible){var f=F(d.regular.lod.lengths,d.distanceToCamera,
g);a.renderRegularEdges(e,d,c,b,f)}},c.transparency)};k._renderSilhouetteEdges=function(a,b,c){const e=a.bindSilhouetteEdges(c,b),g=b.camera.perScreenPixelRatio;a.forEachRenderable(d=>{if(null!=d.silhouette&&d.visible){var f=F(d.silhouette.lod.lengths,d.distanceToCamera,g);a.renderSilhouetteEdges(e,d,c,b,f)}},c.transparency)};u._createClass(n,[{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"test",get:function(){return{hasRenderedPrimitives:a=>
{let b=!1;const c=a.perScreenPixelRatio,e=(g,d)=>g.forEachRenderable(f=>{f.visible&&!b&&(null!=f.regular&&(b=0<F(f.regular.lod.lengths,f.distanceToCamera,c)),b||null==f.silhouette||(b=0<F(f.silhouette.lod.lengths,f.distanceToCamera,c)))},d);this._renderers.forEach(g=>{b||(e(g,S.Transparency.OPAQUE),e(g,S.Transparency.TRANSPARENT))});return b}}}}]);return n}(I);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,"rctx",void 0);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,
"renderSR",void 0);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,"viewingMode",void 0);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,"techniqueRepository",void 0);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,"setNeedsRender",void 0);v.__decorate([x.property({constructOnly:!0})],t.EdgeView.prototype,"schedule",void 0);v.__decorate([x.property({readOnly:!0})],t.EdgeView.prototype,"_updatingHandles",void 0);v.__decorate([x.property({readOnly:!0})],
t.EdgeView.prototype,"updating",null);t.EdgeView=v.__decorate([ca.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],t.EdgeView);let W=u._createClass(function(m,n,k){this.center=n;this.radius=k;this.renderables=[];this.loaded=m;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})}),va=u._createClass(function(m,n){this.buffer=m;this.meta=n}),wa=u._createClass(function(m,n){this.vao=m;this.lod=n}),Z=u._createClass(function(m,n){this.modelMatrix=m;this.origin=n}),G=u._createClass(function(m,
n,k,a,b,c,e,g){this.regular=m;this.silhouette=n;this.statistics=k;this.transform=a;this.edgeTransparency=b;this.objectTransparency=c;this.components=e;this.rendererKey=g;this.distanceToCamera=0;this.visible=!0});v=function(m){function n(){return m.apply(this,arguments)||this}u._inherits(n,m);return u._createClass(n)}(G);I=function(m){function n(){return m.apply(this,arguments)||this}u._inherits(n,m);return u._createClass(n)}(G);let Y=u._createClass(function(m,n,k,a){this.position=m;this.indices=n;
this.modelTransform=k;this.origin=a});const X=da.create(),ua=()=>Promise.reject();t.LegacyTransform=Z;t.RegularRenderable=v;t.Renderable=G;t.SilhouetteRenderable=I;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
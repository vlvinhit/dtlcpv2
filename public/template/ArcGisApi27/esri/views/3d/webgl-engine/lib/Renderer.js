// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/has ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/boundedPlane ../../support/debugFlags ../../terrain/TerrainRenderer ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDUniforms ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./glUtil3D ./Highlight ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderFeature ./RenderPluginManager ./RenderSlot ./ShadowAccumulator ./ShadowHighlight ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./TransparencyPassType ./edgeRendering/EdgeView ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(p,S,v,Y,Z,aa,T,L,U,B,x,ya,ba,E,F,ca,da,P,ea,q,y,fa,G,ha,V,ia,ja,ka,w,la,ma,na,D,oa,d,pa,qa,Q,ra,sa,ta,A,ua,M,va,N,m,wa,C){function xa(r){return H=>r.immediate.schedule(H)}p.Renderer=function(r){function H(a,c,f,g,l,h,n,t){var b=r.call(this,{})||this;b._stage=a;b._materialRepository=c;b._techniqueRepository=g;b._rctx=l;b._compositingHelper=h;b._magnifierHelper=n;b._requestRender=t;b._materialRenderers=new U;b._needsTransparentPass=!1;b._hasHUDElements=!1;b._hasHighlights=!1;b._hasWater=!1;
b._hasOverlayWater=!1;b._renderOverlay=k=>{};b._isRendering=!1;b._fallbackDepthStencilTexture=null;b._sliceHelper=new ra;b._state=wa.RenderState.IDLE;b._renderStateFeatures=null;b._antialiasingEnabled=!0;b._highQualityTransparencyEnabled=!0;b._terrainRenderingEnabled=!0;b._terrainTransparency=P.TransparencyMode.Opaque;b._ssrEnabled=!1;b._ssaoEnabled=!1;b._hasAnimations=!1;b._animationTimestep=new fa.AnimationTimeStep;b._handles=new aa;b._renderHiddenTransparentEdges=()=>{};b._oitUsed=!1;b.updateRenderFeature(a.view.qualityProfile);
b._smaaPass=new sa.SmaaRenderPass(b._rctx,g);t();b._offscreen=new la.OffscreenRendering(b._rctx,b._compositingHelper);b.performanceInfo=new m.RendererPerformanceInfo(b._rctx);b._shadowMap=new Q.ShadowMap(b._rctx,a.viewingMode);b._ssaoHelper=new ta.SSAOHelper(a.view,g,b._rctx,t);b._highlight=new ka.Highlight(g,b._rctx);b._shadowHighlight=new qa.ShadowHighlight(b._rctx,a.viewingMode);b._shadowAccumulator=new pa.ShadowAccumulator(b._rctx,g,a,k=>{const I=b.shadowsEnabled;b._shadowMap.enabled=!0;b._prepare(k.camera,
k.contentCamera);b._renderPlugins.prepareRender();b._shadowMap.enabled=I},(k,I,O)=>{k.shadowMap.start(k.camera,I,O,!0,b._stage.view.qualitySettings.maximumPixelRatio);b._renderShadowCascades(q.ShaderOutput.Shadow,k.shadowMap);k.camera.setGLViewport(b._rctx);b._prepare(k.camera,k.contentCamera)},t);b._renderContext=new ma.RenderContext(b._rctx,b._offscreen,b._shadowMap,b._ssaoHelper,b._sliceHelper);b._renderPlugins=new oa.RenderPluginManager({renderContext:b._renderContext,techniqueRepository:g,textureRepository:f,
materialRepository:b._materialRepository,requestRender:t,controller:a});b.renderPassManager=new ea.RenderPassManager(b._rctx,b._techniqueRepository);b._renderPlugins.add(b.renderPassManager.slots(),b.renderPassManager);b._handles.add([B.watch(()=>b._stage.view.state.camera,()=>t(),B.syncAndInitial),B.watch(()=>da.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,k=>{b._renderHiddenTransparentEdges=k?()=>b._renderEdges(M.Transparency.TRANSPARENT):()=>{};t()},B.initial),B.watch(()=>b._ssaoEnabled||b.isFeatureEnabled(D.RenderFeature.SSAO),
k=>b._ssaoHelper.enabled=k,B.syncAndInitial)]);return b}S._inherits(H,r);var e=H.prototype;e.updateRenderFeature=function(a=null,c=!T("disable-feature:high-quality-idle")){this._renderStateFeatures=D.setupFeatureDefaults(c,a);this.notifyChange("_renderStateFeatures");this._requestRender()};e.isFeatureEnabled=function(a,c=this._state){return this._renderStateFeatures?.get(c,a)??!1};e.setFeatureEnabled=function(a,c,f){this._renderStateFeatures?.set(c,a,f);this.notifyChange("_renderStateFeatures");this._requestRender()};
e.normalizeCtorArgs=function(){return{}};e.destroy=function(){this._handles.destroy();this._smaaPass.dispose();this._gpuTimerHandle=L.removeMaybe(this._gpuTimerHandle);this._materialRenderers.forAll(a=>a.dispose());this._materialRenderers.clear();this._offscreen.dispose();this._fallbackDepthStencilTexture=L.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap.dispose();this._ssaoHelper.destroy();this._highlight.dispose();this._shadowHighlight.dispose();this._shadowAccumulator.dispose();
this._edgeView=L.destroyMaybe(this._edgeView);this.renderPassManager.destroy();ha.BoundingInfo.prune()};e.disposeOffscreenBuffers=function(){this._offscreen.dispose();this._shadowMap.disposeOffscreenBuffers();this._smaaPass.disable();this._ssaoHelper.disposeOffscreenBuffers()};e.ensureEdgeView=function(){null==this._edgeView&&(this._edgeView=new ua.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,
setNeedsRender:()=>this._requestRender(),schedule:xa(this._stage.view.resourceController)}),this._handles.add(B.watch(()=>L.applySome(this._edgeView,a=>a.updating),()=>this._requestRender(),B.sync)),this._requestRender());return this._edgeView};e.setParameters=function(a){const {_shadowMap:c,_bindParameters:f}=this;void 0!==a.qualitySettings?.reflections&&this._ssrEnabled!==a.qualitySettings.reflections&&(this._ssrEnabled=a.qualitySettings.reflections,this._requestRender());void 0!==a.qualitySettings?.ambientOcclusion&&
this._ssaoEnabled!==a.qualitySettings.ambientOcclusion&&(this._ssaoEnabled=a.qualitySettings.ambientOcclusion,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&c.maxCascades!==a.shadowMapMaxCascades&&(c.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(null!=a.environment){null!=a.environment.weather&&(this._bindParameters.weather=a.environment.weather,this._bindParameters.weatherVisible=
!!a.weatherVisible);const g="virtual"!==a.environment.lighting.type;f.enableFillLights!==g&&(f.enableFillLights=g,this._requestRender())}a.background&&this._offscreen.background!==a.background&&(this._offscreen.background=a.background,this._requestRender());void 0!==a.antialiasingEnabled&&this._antialiasingEnabled!==a.antialiasingEnabled&&(this._antialiasingEnabled=a.antialiasingEnabled,this._requestRender());void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==a.highQualityTransparency&&
(this._highQualityTransparencyEnabled=a.highQualityTransparency,this._requestRender());void 0!==a.defaultHighlightOptions&&(this._highlight.setDefaultOptions(a.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(a.defaultHighlightOptions),this._requestRender());void 0!==a.overlays&&this._bindParameters.overlays!==a.overlays&&(this._bindParameters.overlays=a.overlays,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,
this._requestRender());void 0!==a.renderOverlay&&this._renderOverlay!==a.renderOverlay&&(this._renderOverlay=a.renderOverlay,this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane,this._requestRender());void 0!==a.terrainRenderingEnabled&&this._terrainRenderingEnabled!==a.terrainRenderingEnabled&&(this._terrainRenderingEnabled=a.terrainRenderingEnabled,this._requestRender());void 0!==a.terrainTransparency&&this._terrainTransparency!==
a.terrainTransparency&&(this._terrainTransparency=a.terrainTransparency,this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)};e.modify=function(a,c){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:f,removes:g,updates:l}=a;if(0!==f.length||0!==g.length||0!==l.length){var h=!1;na.splitRenderGeometryChangeSetByMaterial(a).forEach((n,t)=>{if(!c.done){var b=this._materialRenderers.find(k=>k.material===t);null==
b&&0<n.adds.length&&(b=new va.MergedRenderer(this._rctx,this._materialRepository,t),this._materialRenderers.push(b));b&&(b.modify(n),b.isEmpty&&(h=!0));n.removes.forEach(k=>a.removes.removeUnordered(k));n.adds.forEach(k=>a.adds.removeUnordered(k));n.updates.forEach(k=>a.updates.removeUnordered(k));c.madeProgress()}});h&&this._materialRenderers.filterInPlace(n=>n.isEmpty?(n.dispose(),!1):!0);this._hasHighlights=this._materialRenderers.some(n=>n.hasHighlights);this._bindParameters.hasOccludees=this._materialRenderers.some(n=>
n.hasOccludees);this._hasWater=this._materialRenderers.some(n=>n.hasWater);this._hasHUDElements=this._materialRenderers.some(n=>n.requiresSlot(d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,q.ShaderOutput.Color)||n.requiresSlot(d.RenderSlot.HUD_MATERIAL,q.ShaderOutput.Color)||n.requiresSlot(d.RenderSlot.LABEL_MATERIAL,q.ShaderOutput.Color));this._requestRender()}};e.updateAnimation=function(a){const c=this._hasAnimations;this._hasAnimations=!1;this._materialRenderers.forAll(f=>this._hasAnimations=f.updateAnimation(a)||
this._hasAnimations);this._hasAnimations=this._renderPlugins.updateAnimation(a)||this._hasAnimations;this._hasAnimations!==c&&(this._gpuTimerHandle=c?L.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations};e.resetAnimation=function(){this._animationTimestep.clear()};e.render=function(a,c,f,g,l){this._isRendering=!0;this._oitUsed=!1;this.performanceInfo.startFrame();const {camera:h,contentCamera:n,mode:t,alignPixelEnabled:b}=f;this._state=t;
this._renderOverlay(l);this.performanceInfo.advance(m.PerformanceCategory.OVERLAY);this._renderContext.time=l;this._bindParameters.transparencyPassType=A.TransparencyPassType.NONE;this._bindParameters.alignPixelEnabled=b;const k=this._offscreen;k.setupRenderTarget(this.hasReflections);f=ca.create(this._sliceHelper.plane);g===G.Decorations.OFF&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);h.setGLViewport(this._rctx);this._prepare(h,n);this._renderPlugins.prepareRender();this.performanceInfo.advance(m.PerformanceCategory.PREPARE);
const I=this._computeDepthRange(h);this._renderShadowMap(a,h,this._bindParameters.lighting.mainLight.direction,I);this.performanceInfo.advance(m.PerformanceCategory.SHADOW_MAP);k.initializeFrame(h);this._ensureBindParameters(h,n);const O=this._terrainRenderingEnabled&&(this._terrainTransparency===P.TransparencyMode.Semitransparent||this._terrainTransparency===P.TransparencyMode.TransparentWithDraped),z=this._highQualityTransparency&&O,R=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;
this._prepareShaders(z,R);this._renderLinearDepth();this.performanceInfo.advance(m.PerformanceCategory.LINEAR_DEPTH);this._accumulateShadows(I,h,n);this.performanceInfo.advance(m.PerformanceCategory.ACCUMULATED_SHADOWS);this._renderNormal();this.performanceInfo.advance(m.PerformanceCategory.NORMALS);this._ensureBindParametersSSR(l);this._renderSSAO(l);this.performanceInfo.advance(m.PerformanceCategory.SSAO);this._renderContext.output=q.ShaderOutput.Color;k.bindFramebuffer();this._renderOpaqueGeometry();
this.performanceInfo.advance(m.PerformanceCategory.OPAQUE);this._renderTerrainLinearDepth(z);this._setMultipassTerrain(z);this._renderEdges(M.Transparency.OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES);this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth);this._renderSlot(d.RenderSlot.VOXEL);this.performanceInfo.advance(m.PerformanceCategory.VOXEL);this._renderHiddenTransparentEdges();R&&(this._oitEnabled?this._renderOITPass(J.Geometry):
this._renderTransparentGeometry());this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT);this._renderGeometryLinearDepth(z);l=this._renderHUDVisibility(z);z||this._renderInternalSlot(d.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.PerformanceCategory.HUD_VISIBILITY);this._renderObjectAndLayerIdColor(c);this.performanceInfo.advance(m.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);this._renderEdges(M.Transparency.TRANSPARENT,z);this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES);
this._renderTransparentTerrain();O&&l&&(z?this._renderLineCallouts(y.HUDTransparencyRenderStyle.Occluded):k.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(y.HUDTransparencyRenderStyle.Occluded,k.framebuffer),this.performanceInfo.advance(m.PerformanceCategory.HUD_OCCLUDED));this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_TERRAIN);this._setTerrainCulling(!1);O&&(k.compositeTransparentTerrainOntoMain(this._bindParameters),z&&(this._renderEdges(M.Transparency.OPAQUE),
this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES),R&&(this._oitEnabled?this._renderOITPass(J.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT),this._renderEdges(M.Transparency.TRANSPARENT),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES)));z&&this._renderLineCallouts(y.HUDTransparencyRenderStyle.NotOccluded);this._setMultipassEnabled(!1);this._shadowAccumulator.render(this._bindParameters);k.renderToTargets(()=>
{this._renderInternalSlot(d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._renderSlot(d.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT);this._renderSlot(d.RenderSlot.LASERLINES)},k.currentColorTarget,k.mainDepth);this.performanceInfo.advance(m.PerformanceCategory.ENVIRONMENT);this._renderPlugins.needsLaserlineWithContrastControl&&k.renderTmpAndCompositeToMain(()=>this._renderSlot(d.RenderSlot.LASERLINES_CONTRAST_CONTROL),this._bindParameters,N.AlphaMode.PremultipliedAlpha);this.performanceInfo.advance(m.PerformanceCategory.LASER_LINE);
this._renderOccluded();this.performanceInfo.advance(m.PerformanceCategory.OCCLUDED);g=(c=g===G.Decorations.ON&&this._magnifierHelper.enabled)&&null==a?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):a;this._rctx.bindFramebuffer(g);l=this._offscreen.colorTexture;this._renderAntiAliasing(l)||null==l||this._compositingHelper.composite(this._bindParameters,l,N.AlphaMode.None);this.performanceInfo.advance(m.PerformanceCategory.ANTIALIASING);this._renderHUD(y.HUDTransparencyRenderStyle.NotOccluded,
g);this.performanceInfo.advance(m.PerformanceCategory.HUD);this._renderHighlights(g,this._bindParameters);this.performanceInfo.advance(m.PerformanceCategory.HIGHLIGHTS);c&&this._magnifierHelper.render(this._rctx,this._bindParameters);g!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,N.AlphaMode.None));this._disposeOITBuffers();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=
f;this._isRendering=!1;if(this.onPostRender)this.onPostRender();this.performanceInfo.finishFrame()};e._prepareShaders=function(a,c){this._renderContext.output=q.ShaderOutput.Color;this._prepareOpaqueGeometrySlots();this._setMultipassTerrain(a);this._prepareSlots(d.RenderSlot.TRANSPARENT_TERRAIN);this._setMultipassTerrain(!1);a||this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.LINE_CALLOUTS);c&&this._prepareTransparencySlots();this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);
this._prepareSlots(d.RenderSlot.POSTPROCESSING_ENVIRONMENT_TRANSPARENT,d.RenderSlot.LASERLINES);this._rctx.gl.flush()};e._renderObjectAndLayerIdColor=function(a){if(null!=a&&T("enable-feature:objectAndLayerId-rendering")){const c=this._renderContext.output;this._rctx.bindFramebuffer(a);this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.ObjectAndLayerIdColor),[0,0,0,0],!0,!0);this._rctx.bindFramebuffer(a);this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=
y.HUDTransparencyRenderStyle.NotOccluded;this._renderInternalSlot(d.RenderSlot.HUD_MATERIAL)},void 0,!0,!0);this._renderContext.output=c}};e.finish=function(a){this._hasAnimations||this._animationTimestep.clear();var c=this.performanceInfo.gpuSamplingEnabled;if((a=a===G.RenderRequestType.BACKGROUND)||c){const f=a?this.performanceInfo.elapsedTime:0;c=c?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();this._animationTimestep.frame(Math.max(f,c),a)}};e.readDepthPixels=function(a,
c,f){const g=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);this._needsLinearDepth||(this._ensureBindParameters(a,a),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(C.ClearBufferBit.COLOR_BUFFER_BIT|C.ClearBufferBit.DEPTH_BUFFER_BIT|C.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Depth));g.readPixels(c[0],c[1],c[2],c[3],C.PixelFormat.RGBA,C.PixelType.UNSIGNED_BYTE,
f)};e.readHUDVisibility=function(a,c,f,g,l){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(a,c,f,g,C.PixelFormat.RGBA,C.PixelType.UNSIGNED_BYTE,l)};e.readAccumulatedShadow=function(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])};e._setMultipassTerrain=function(a){this._setMultipassEnabled(a);this._setTerrainCulling(a)};e._setMultipassEnabled=function(a){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=a};e._setTerrainCulling=
function(a){this._bindParameters.multipassTerrain.cullAboveGround=a};e._prepareSlots=function(...a){this._renderPlugins.prepareSlots(a)};e._renderSlot=function(a){this._bindParameters.slot=a;this._renderPlugins.render()};e._renderEdges=function(a,c=!1){const f=this._edgeView;null!=f&&f.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>f.render(this._bindParameters,a),this._bindParameters,N.AlphaMode.Alpha,c)};e._renderShadowMap=function(a,c,f,g){const l=this._shadowMap;l.enabled&&(l.start(c,
f,g,this.isFeatureEnabled(D.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(c,f),this._needsShadowHighlight?(this._renderShadowCascades(q.ShaderOutput.ShadowHighlight,this._shadowMap,h=>l.takeCascadeSnapshotTo(h,Q.SnapshotSlot.Highlight)),l.clear(),this._renderShadowCascades(q.ShaderOutput.ShadowExcludeHighlight,this._shadowMap,h=>{l.takeCascadeSnapshotTo(h,Q.SnapshotSlot.Default);this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.ShadowHighlight)})):
this._renderShadowCascades(q.ShaderOutput.Shadow),l.finish(a),c.setGLViewport(this._rctx))};e._renderShadowCascades=function(a,c=this._shadowMap,f=g=>{}){for(const g of c.cascades)g.camera.setGLViewport(this._rctx),this._prepare(g.camera,g.camera),this._renderGeometryAndTransparentTerrainPass(a),f(g)};e._renderLinearDepth=function(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,
[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth);this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture};e._renderTerrainLinearDepth=function(a){a?(a=this._renderContext.output,this._renderContext.output=q.ShaderOutput.Depth,this._offscreen.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1E10,-1E10,-1E10,1],!0,!0),this._renderContext.output=a):this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);
this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture};e._renderGeometryLinearDepth=function(a){a?(a=this._renderContext.output,this._offscreen.renderToTargets(()=>this._renderGeometryPass(q.ShaderOutput.Depth),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=a):this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture};
e._renderNormal=function(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)};e._computeDepthRange=function(a){if(!this._needsDepthRange)return V.ZERO;const c=ia.depthRangeFromScene(a,this._materialRenderers,this._stage.layers);V.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);
c.far=Math.min(a.far,c.far);return c};e._renderGeometryAndTransparentTerrainPass=function(a){this._renderContext.output=a;this._prepareSlots(d.RenderSlot.TRANSPARENT_TERRAIN);this._renderGeometryPass(a);this._renderTransparentTerrain()};e._renderGeometryPass=function(a){this._renderContext.output=a;this._prepareSlots(d.RenderSlot.TRANSPARENT_MATERIAL);this._renderOpaqueGeometry();this._renderTransparentGeometry()};e._renderSSAO=function(a){this._ssaoHelper.render(this._bindParameters,a,this._offscreen.linearDepthTexture,
this._offscreen.normalTexture)};e._prepareOpaqueGeometrySlots=function(){this._prepareSlots(d.RenderSlot.INTEGRATED_MESH,d.RenderSlot.OPAQUE_TERRAIN,d.RenderSlot.OPAQUE_MATERIAL,d.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE);this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.OPAQUE_MATERIAL)};e._renderOpaqueGeometry=function(){this._renderSlot(d.RenderSlot.INTEGRATED_MESH);this._renderSlot(d.RenderSlot.OPAQUE_TERRAIN);this._renderInternalSlot(d.RenderSlot.OPAQUE_MATERIAL);this._renderSlot(d.RenderSlot.OPAQUE_MATERIAL);
this._renderSlot(d.RenderSlot.POSTPROCESSING_ENVIRONMENT_OPAQUE)};e._renderTransparentGeometry=function(){this._renderInternalSlot(d.RenderSlot.TRANSPARENT_MATERIAL);this._renderSlot(d.RenderSlot.TRANSPARENT_MATERIAL)};e._renderTransparentTerrain=function(){this._renderSlot(d.RenderSlot.TRANSPARENT_TERRAIN)};e._renderHUDVisibility=function(a){let c=!1;this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=
this._renderContext.offscreenRenderingHelper.hudVisibilityTexture;c=this._renderInternalSlot(d.RenderSlot.OCCLUSION_PIXELS)},a);return c};e._renderLineCallouts=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;a===y.HUDTransparencyRenderStyle.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(d.RenderSlot.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(d.RenderSlot.LINE_CALLOUTS)};e._renderHUD=function(a,
c){this._hasHUDElements&&(this._oitEnabled?(this._renderOITPass(J.HUD,a),this._rctx.bindFramebuffer(c),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,N.AlphaMode.PremultipliedAlpha)):a===y.HUDTransparencyRenderStyle.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(y.HUDTransparencyRenderStyle.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(a))};e._renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=
a;this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,d.RenderSlot.HUD_MATERIAL,d.RenderSlot.LABEL_MATERIAL);this._renderInternalSlot(d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._renderInternalSlot(d.RenderSlot.HUD_MATERIAL);this._renderInternalSlot(d.RenderSlot.LABEL_MATERIAL)};e._renderHighlights=function(a,c){if(this._needsHighlight){var f=this._highlight,g=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(q.ShaderOutput.Highlight);
this._rctx.clearSafe(C.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(y.HUDTransparencyRenderStyle.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=g.colorTexture;this._needsShadowHighlight&&this._shadowHighlight.render(c,a);f.render(this._bindParameters,g,a)}else this._offscreen.disposeTarget(this._offscreen.highlight)};e._accumulateShadows=function(a,c,f){this._needsShadowCast&&null!=this._offscreen.linearDepthTexture&&
this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,a,c,f)};e._prepareTransparencySlots=function(){this._renderContext.output=q.ShaderOutput.Alpha;this._bindParameters.transparencyPassType=A.TransparencyPassType.Alpha;this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.TRANSPARENT_MATERIAL);this._prepareSlots(d.RenderSlot.TRANSPARENT_MATERIAL);this._renderContext.output=q.ShaderOutput.Color;this._bindParameters.transparencyPassType=A.TransparencyPassType.Color;
this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.TRANSPARENT_MATERIAL);this._prepareSlots(d.RenderSlot.TRANSPARENT_MATERIAL);this._bindParameters.transparencyPassType=A.TransparencyPassType.FrontFace;this._prepareInternalSlots(this._materialRenderers,d.RenderSlot.TRANSPARENT_MATERIAL);this._prepareSlots(d.RenderSlot.TRANSPARENT_MATERIAL);this._bindParameters.transparencyPassType=A.TransparencyPassType.NONE};e._renderOITPass=function(a,c=y.HUDTransparencyRenderStyle.Both){const f=a===
J.HUD,g=f?()=>this._renderHUDElements(c):()=>this._renderTransparentGeometry();a=h=>{this._bindParameters.transparencyPassType=h;this._offscreen.renderOITPass(g,h,f)};const l=this._renderContext.output;this._renderContext.output=q.ShaderOutput.Alpha;a(A.TransparencyPassType.Alpha);this._renderContext.output=q.ShaderOutput.Color;a(A.TransparencyPassType.Color);a(A.TransparencyPassType.FrontFace);this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,f);this._bindParameters.transparencyPassType=
A.TransparencyPassType.NONE;this._renderContext.output=l;this._oitUsed=!0};e._disposeOITBuffers=function(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget))};e._renderOccluded=function(){let a=0;u.clear();this._materialRenderers.forAll(h=>{h.material&&h.material.isVisible()&&h.material.renderOccluded===w.RenderOccludedFlag.OccludeAndTransparentStencil&&
(a|=h.material.renderOccluded,u.push(h))});const c=this._offscreen,f=(h,n,t,b,k)=>{0!==(a&n)&&(c.renderToTargets(t,c.tmpColor,c.mainDepth,[0,0,0,0],b,k),c.compositeOccludedOntoMain(this._bindParameters,h))};0!==u.length&&(this._prepareInternalSlots(u,d.RenderSlot.OCCLUDER_MATERIAL,d.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(d.RenderSlot.OCCLUDER_MATERIAL,u),f(.5,w.RenderOccludedFlag.OccludeAndTransparentStencil,()=>this._renderInternalSlot(d.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,
u),!1,!1));u.clear();this._materialRenderers.forAll(h=>{h.material&&h.material.isVisible()&&(h.material.renderOccluded===w.RenderOccludedFlag.OccludeAndTransparent||h.material.renderOccluded===w.RenderOccludedFlag.Transparent||h.material.renderOccluded===w.RenderOccludedFlag.Opaque)&&(a|=h.material.renderOccluded,u.push(h))});const g=this._renderPlugins.renderOccludedFlags;if(a|=g){var l=h=>{this._renderContext.renderOccludedMask=h;this._prepareInternalSlots(u,d.RenderSlot.OPAQUE_MATERIAL,d.RenderSlot.TRANSPARENT_MATERIAL,
d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);g>w.RenderOccludedFlag.Occlude&&this._renderSlot(d.RenderSlot.OCCLUDED_TERRAIN);this._renderInternalSlot(d.RenderSlot.OPAQUE_MATERIAL,u);this._renderInternalSlot(d.RenderSlot.TRANSPARENT_MATERIAL,u);this._renderInternalSlot(d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,u);this._renderContext.resetRenderOccludedMask()};this._renderContext.output=q.ShaderOutput.Color;f(.5,w.RenderOccludedFlag.OccludeAndTransparent,()=>l(w.RenderOccludedFlag.OccludeAndTransparent),
!0,G.StencilBits.OutlineVisualElementMask);f(.5,w.RenderOccludedFlag.Transparent,()=>l(w.RenderOccludedFlag.Transparent),!0,G.StencilBits.OutlineVisualElementMask);f(1,w.RenderOccludedFlag.Opaque,()=>l(w.RenderOccludedFlag.Opaque),!0,G.StencilBits.OutlineVisualElementMask);u.clear()}};e._renderAntiAliasing=function(a){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&null!=a)return this._smaaPass.render(a),!0}else this._smaaPass.disable();return!1};e._prepare=function(a,
c){this._needsTransparentPass=this._materialRenderers.some(f=>f.requiresSlot(d.RenderSlot.TRANSPARENT_MATERIAL,q.ShaderOutput.Color));this._bindParameters.camera=a;this._bindParameters.contentCamera=c};e._ensureBindParameters=function(a,c){this._bindParameters.camera=a;this._bindParameters.contentCamera=c;a=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=a.hudVisibilityTexture;this._bindParameters.mainColorTexture=a.mainColorTexture;this._bindParameters.highlightDepthTexture=
a.depthTexture??this._getFallbackDepthTexture()};e._ensureBindParametersSSR=function(a){this._bindParameters.ssr.enabled=this.hasReflections;if(this._bindParameters.ssr.enabled){null==this._ssrEnableTime&&(this._ssrEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=F.IDENTITY:(E.invert(W,this._bindParameters.camera.viewMatrix),E.invert(X,this._bindParameters.camera.projectionMatrix),E.multiply(K,W,X),E.multiply(K,this._renderContext.lastFrameCamera.viewMatrix,
K),E.multiply(K,this._renderContext.lastFrameCamera.projectionMatrix,K),this._reprojectionMatrix=K);this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const c=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<c?Math.min(c,a-this._ssrEnableTime)/c:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._reprojectionMatrix=F.IDENTITY,this._ssrEnableTime=this._bindParameters.ssr.lastFrameColorTexture=null};e._prepareInternalSlots=
function(a,...c){for(const f of c)this._bindParameters.slot=f,a.forAll(g=>{g.material.shouldRender(this._renderContext)&&g.prepareTechnique(this._renderContext)})};e._renderInternalSlot=function(a,c=this._materialRenderers){let f=!1;this._bindParameters.slot=a;c.forAll(g=>{if(g.material.shouldRender(this._renderContext)){const l=g.prepareTechnique(this._renderContext);null!=l&&(g.render(this._renderContext,l),f=!0)}});return f};e._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||
(this._fallbackDepthStencilTexture=ja.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};S._createClass(H,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"_antialiasing",get:function(){return this._antialiasingEnabled||this.isFeatureEnabled(D.RenderFeature.Antialiasing)}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(D.RenderFeature.HighQualityTransparency)}},{key:"hasReflections",
get:function(){return this.hasWater&&(this._ssrEnabled||this.isFeatureEnabled(D.RenderFeature.WaterReflection))}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._renderPlugins.updating||!this.isCameraFinal}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return E.equals(this._bindParameters.ssr.reprojectionMatrix,
F.IDENTITY)}},{key:"_reprojectionMatrix",set:function(a){Z.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){return!!this._shadowMap?.enabled}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&
this._hasOITSupport}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast}},{key:"_needsNormal",get:function(){return this._ssaoHelper.active}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||
this._needsShadowCast}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"gpuMemoryUsage",get:function(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??
0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}},{key:"test",get:function(){const a=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{a._renderStateFeatures=D.setupFeatureDefaults()},getFramebufferTexture:c=>
{switch(c){case p.FramebufferId.Color:return a._offscreen.colorTexture;case p.FramebufferId.LinearDepth:return a._offscreen.linearDepthTexture;case p.FramebufferId.Normals:return a._offscreen.normalTexture;case p.FramebufferId.ShadowMap:return a._shadowMap.depthTexture;case p.FramebufferId.HudVisibility:return a._offscreen.hudVisibilityTexture;case p.FramebufferId.Highlight:return a._offscreen.highlightTexture}}}}}]);return H}(Y);v.__decorate([x.property()],p.Renderer.prototype,"_renderPlugins",void 0);
v.__decorate([x.property()],p.Renderer.prototype,"_shadowAccumulator",void 0);v.__decorate([x.property()],p.Renderer.prototype,"_state",void 0);v.__decorate([x.property()],p.Renderer.prototype,"_renderStateFeatures",void 0);v.__decorate([x.property()],p.Renderer.prototype,"_antialiasingEnabled",void 0);v.__decorate([x.property({readOnly:!0})],p.Renderer.prototype,"_antialiasing",null);v.__decorate([x.property()],p.Renderer.prototype,"_ssaoEnabled",void 0);v.__decorate([x.property()],p.Renderer.prototype,
"_smaaPass",void 0);v.__decorate([x.property({autoDestroy:!0})],p.Renderer.prototype,"_edgeView",void 0);v.__decorate([x.property()],p.Renderer.prototype,"updating",null);v.__decorate([x.property()],p.Renderer.prototype,"isCameraFinal",null);p.Renderer=v.__decorate([ba.subclass("esri.views.3d.webgl-engine.lib.Renderer")],p.Renderer);var J;(function(r){r[r.Geometry=0]="Geometry";r[r.HUD=1]="HUD"})(J||(J={}));p.FramebufferId=void 0;(function(r){r[r.Color=0]="Color";r[r.LinearDepth=1]="LinearDepth";
r[r.Normals=2]="Normals";r[r.ShadowMap=3]="ShadowMap";r[r.HudVisibility=4]="HudVisibility";r[r.Highlight=5]="Highlight"})(p.FramebufferId||(p.FramebufferId={}));const u=new U,X=F.create(),W=F.create(),K=F.create();Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Error ../../../../core/Evented ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/urlUtils ../../../../support/requestImageUtils ../../../../support/requestUtils ./basicInterfaces ./BasisUtil ./ContentObject ./ContentObjectType ./DDSUtil ./Util ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(u,v,w,B,
C,x,m,g,q,D,E,k,n,F,G,H,I,h,r,J){function y(d){return d instanceof HTMLVideoElement?{width:d.videoWidth,height:d.videoHeight}:d}w=function(d){function p(a,b){var c=d.call(this)||this;c._data=a;c.type=G.ContentObjectType.Texture;c._glTexture=null;c._loadingPromise=null;c._loadingController=null;c.events=new C;c.parameters=b||{};c.parameters.mipmap=!1!==c.parameters.mipmap;c.parameters.noUnpackFlip=c.parameters.noUnpackFlip||!1;c.parameters.preMultiplyAlpha=c.parameters.preMultiplyAlpha||!1;c.parameters.wrap=
c.parameters.wrap||{s:h.TextureWrapMode.REPEAT,t:h.TextureWrapMode.REPEAT};c._startPreload(a);return c}v._inherits(p,d);var e=p.prototype;e._startPreload=function(a){null!=a&&(a instanceof HTMLVideoElement?this._startPreloadVideoElement(a):a instanceof HTMLImageElement&&this._startPreloadImageElement(a))};e._startPreloadVideoElement=function(a){if(!(q.isBlobProtocol(a.src)||"auto"===a.preload&&a.crossOrigin)){a.preload="auto";a.crossOrigin="anonymous";const b=!a.paused;a.src=a.src;if(b&&a.autoplay){const c=
()=>{a.removeEventListener("canplay",c);a.play()};a.addEventListener("canplay",c)}}};e._startPreloadImageElement=function(a){q.isDataProtocol(a.src)||q.isBlobProtocol(a.src)||a.crossOrigin||(a.crossOrigin="anonymous",a.src=a.src)};e.dispose=function(){this._data=void 0};e._createDescriptor=function(a){const b=new J.TextureDescriptor;b.wrapMode=this.parameters.wrap??h.TextureWrapMode.REPEAT;b.flipped=!this.parameters.noUnpackFlip;b.samplingMode=this.parameters.mipmap?h.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:
h.TextureSamplingMode.LINEAR;b.hasMipmap=!!this.parameters.mipmap;b.preMultiplyAlpha=!!this.parameters.preMultiplyAlpha;b.maxAnisotropy=this.parameters.maxAnisotropy??(this.parameters.mipmap?a.parameters.maxMaxAnisotropy:1);return b};e.load=function(a){if(null!=this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const b=this._data;return null==b?this._glTexture=new r.Texture(a,this._createDescriptor(a),null):"string"===typeof b?this._loadFromURL(a,b):b instanceof
Image?this._loadFromImageElement(a,b):b instanceof HTMLVideoElement?this._loadFromVideoElement(a,b):b instanceof ImageData||b instanceof HTMLCanvasElement?this._loadFromImage(a,b):(g.isArrayBuffer(b)||g.isUint8Array(b))&&this.parameters.encoding===k.TextureEncodingMimeType.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(a,b)):(g.isArrayBuffer(b)||g.isUint8Array(b))&&this.parameters.encoding===k.TextureEncodingMimeType.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(a,b)):(g.isArrayBuffer(b)||
g.isUint8Array(b))&&this.parameters.encoding===k.TextureEncodingMimeType.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(a,b)):g.isUint8Array(b)?this._loadFromPixelData(a,b):g.isArrayBuffer(b)?this._loadFromPixelData(a,new Uint8Array(b)):null};e.frameUpdate=function(a){if(!(this._data instanceof HTMLVideoElement)||null==this._glTexture||this._data.readyState<l.HAVE_CURRENT_DATA||a===this._data.currentTime)return a;this._glTexture.setData(this._data);this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap();
this.parameters.updateCallback&&this.parameters.updateCallback();return this._data.currentTime};e._loadFromDDSData=function(a,b){return this._glTexture=H.createDDSTexture(a,this._createDescriptor(a),b)};e._loadFromKTX2=function(a,b){return this._loadAsync(()=>n.createTextureKTX2(a,this._createDescriptor(a),b).then(c=>this._glTexture=c))};e._loadFromBasis=function(a,b){return this._loadAsync(()=>n.createTextureBasis(a,this._createDescriptor(a),b).then(c=>this._glTexture=c))};e._loadFromPixelData=function(a,
b){I.assert(0<this.parameters.width&&0<this.parameters.height);const c=this._createDescriptor(a);c.pixelFormat=1===this.parameters.components?h.PixelFormat.LUMINANCE:3===this.parameters.components?h.PixelFormat.RGB:h.PixelFormat.RGBA;c.width=this.parameters.width??0;c.height=this.parameters.height??0;return this._glTexture=new r.Texture(a,c,b)};e._loadFromURL=function(a,b){return this._loadAsync(async c=>{const f=await D.requestImage(b,{signal:c});m.throwIfAborted(c);return this._loadFromImage(a,
f)})};e._loadFromImageElement=function(a,b){return b.complete?this._loadFromImage(a,b):this._loadAsync(async c=>{const f=await E.loadImageAsync(b,b.src,!1,c);m.throwIfAborted(c);return this._loadFromImage(a,f)})};e._loadFromVideoElement=function(a,b){return b.readyState>=l.HAVE_CURRENT_DATA?this._loadFromImage(a,b):this._loadFromVideoElementAsync(a,b)};e._loadFromVideoElementAsync=function(a,b){return this._loadAsync(c=>new Promise((f,K)=>{const A=()=>{b.removeEventListener("loadeddata",z);b.removeEventListener("error",
t);x.removeMaybe(L)},z=()=>{b.readyState>=l.HAVE_CURRENT_DATA&&(A(),f(this._loadFromImage(a,b)))},t=M=>{A();K(M||new B("Failed to load video"))};b.addEventListener("loadeddata",z);b.addEventListener("error",t);const L=m.onAbort(c,()=>t(m.createAbortError()))}))};e._loadFromImage=function(a,b){const c=y(b);this.parameters.width=c.width;this.parameters.height=c.height;const f=this._createDescriptor(a);f.pixelFormat=3===this.parameters.components?h.PixelFormat.RGB:h.PixelFormat.RGBA;f.width=c.width;
f.height=c.height;return this._glTexture=new r.Texture(a,f,b)};e._loadAsync=function(a){const b=new AbortController;this._loadingController=b;const c=a(b.signal);this._loadingPromise=c;a=()=>{this._loadingController===b&&(this._loadingController=null);this._loadingPromise===c&&(this._loadingPromise=null)};c.then(a,a);return c};e.unload=function(){this._glTexture=x.disposeMaybe(this._glTexture);if(null!=this._loadingController){const a=this._loadingController;this._loadingPromise=this._loadingController=
null;a.abort()}this.events.emit("unloaded")};v._createClass(p,[{key:"glTexture",get:function(){return this._glTexture}},{key:"memoryEstimate",get:function(){var a;if(!(a=this._glTexture?.gpuMemoryUsage)){a=this._data;var b=this.parameters;if(null==a)a=0;else if(g.isArrayBuffer(a)||g.isUint8Array(a))a=b.encoding===k.TextureEncodingMimeType.KTX2_ENCODING?n.estimateMemoryKTX2(a,!!b.mipmap):b.encoding===k.TextureEncodingMimeType.BASIS_ENCODING?n.estimateMemoryBasis(a,!!b.mipmap):a.byteLength;else{var {width:c,
height:f}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?y(a):b;a=(b.mipmap?4/3:1)*c*f*(b.components||4)||0}}return a}},{key:"requiresFrameUpdates",get:function(){return this._data instanceof HTMLVideoElement}}]);return p}(F.ContentObject);var l;(function(d){d[d.HAVE_NOTHING=0]="HAVE_NOTHING";d[d.HAVE_METADATA=1]="HAVE_METADATA";d[d.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA";d[d.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA";d[d.HAVE_ENOUGH_DATA=4]=
"HAVE_ENOUGH_DATA"})(l||(l={}));u.Texture=w;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
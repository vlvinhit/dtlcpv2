// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../../../geometry/support/buffer/BufferView ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./DefaultBufferWriter ./DefaultLayouts ./internal/bufferWriterUtils ../shaders/NativeLineTechnique ../shaders/NativeLineTechniqueConfiguration".split(" "),
function(N,B,ca,da,I,ea,h,y,fa,K,E,n,T,L,ha,U,O,ia,w,ja,V,ka,la,ma){var M;(function(p){p[p.START=0]="START";p[p.END=1]="END"})(M||(M={}));let ra=function(p){function q(a){a=p.call(this,a,new W)||this;a._configuration=new ma.NativeLineTechniqueConfiguration;return a}B._inherits(q,p);var c=q.prototype;c.getConfiguration=function(a,b){this._configuration.output=a;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasVertexColors=this.parameters.hasVertexColors;this._configuration.transparent=
1>this.parameters.color[3]||1>this.parameters.width;this._configuration.draped=b.slot===O.RenderSlot.DRAPED_MATERIAL;a=null!=this.parameters.stipplePattern;this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&null!=this.parameters.stippleOffColor;this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous;return this._configuration};c.intersect=function(a,b,f,d,m,u){if(f.options.selectionMode&&
a.visible)if(ia.isTranslationMatrix(b)){m=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=f.camera,k=na;ea.copy(k,f.point);h.set(J[0],k[0]-2,k[1]+2,0);h.set(J[1],k[0]+2,k[1]+2,0);h.set(J[2],k[0]+2,k[1]-2,0);h.set(J[3],k[0]-2,k[1]-2,0);for(a=0;4>a;a++)if(!g.unprojectFromRenderScreen(J[a],C[a]))return;n.fromPoints(g.eye,C[0],C[1],P);n.fromPoints(g.eye,C[1],C[2],Q);n.fromPoints(g.eye,C[2],C[3],R);n.fromPoints(g.eye,C[3],C[0],S);d=Number.MAX_VALUE;a=0;for(let l=0;l<m.length-5;l+=3)if(r[0]=
m[l]+b[12],r[1]=m[l+1]+b[13],r[2]=m[l+2]+b[14],t[0]=m[l+3]+b[12],t[1]=m[l+4]+b[13],t[2]=m[l+5]+b[14],!(0>n.signedDistance(P,r)&&0>n.signedDistance(P,t)||0>n.signedDistance(Q,r)&&0>n.signedDistance(Q,t)||0>n.signedDistance(R,r)&&0>n.signedDistance(R,t)||0>n.signedDistance(S,r)&&0>n.signedDistance(S,t))){g.projectToRenderScreen(r,F);g.projectToRenderScreen(t,G);if(0>F[2]&&0<G[2]){h.subtract(z,r,t);var e=g.frustum;e=-n.signedDistance(e[K.PlaneIndex.NEAR],r)/h.dot(z,n.normal(e[K.PlaneIndex.NEAR]));h.scale(z,
z,e);h.add(r,r,z);g.projectToRenderScreen(r,F)}else if(0<F[2]&&0>G[2])h.subtract(z,t,r),e=g.frustum,e=-n.signedDistance(e[K.PlaneIndex.NEAR],t)/h.dot(z,n.normal(e[K.PlaneIndex.NEAR])),h.scale(z,z,e),h.add(t,t,z),g.projectToRenderScreen(t,G);else if(0>F[2]&&0>G[2])continue;F[2]=0;G[2]=0;e=E.distance2(E.fromPoints(F,G,X),k);e<d&&(d=e,h.copy(Y,r),h.copy(Z,t),a=l/3)}b=f.rayBegin;f=f.rayEnd;4>d&&(d=Number.MAX_VALUE,E.closestLineSegmentPoint(E.fromPoints(Y,Z,X),E.fromPoints(b,f,oa),H)&&(h.subtract(H,H,
b),d=h.length(H),h.scale(H,H,1/d),d/=h.distance(b,f)),u(d,H,a,!1))}else ca.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix")};c.intersectDraped=function(a,b,f,d,m,u){if(f.options.selectionMode){b=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=a.vertexAttributes.get(w.VertexAttribute.SIZE);f=d[0];d=d[1];a=(((g?g.data[0]:0)+1)/2+4)*a.screenToWorldRatio;g=Number.MAX_VALUE;var k=0;for(let v=0;v<b.length-5;v+=3){var e=
b[v],l=b[v+1],A=f-e,x=d-l;e=b[v+3]-e;l=b[v+4]-l;const D=da.clamp((e*A+l*x)/(e*e+l*l),0,1);A=e*D-A;x=l*D-x;x=A*A+x*x;x<g&&(g=x,k=v/3)}g<a*a&&m(u.dist,u.normal,k,!1)}};c.requiresSlot=function(a,b){return(b===L.ShaderOutput.Color||b===L.ShaderOutput.Highlight||b===L.ShaderOutput.ObjectAndLayerIdColor)&&(a===O.RenderSlot.OPAQUE_MATERIAL||a===O.RenderSlot.DRAPED_MATERIAL)};c.createGLMaterial=function(a){return new pa(a)};c.createBufferWriter=function(){const a=this.parameters.hasVertexColors?V.PositionColorLayout:
V.PositionLayout;return null==this.parameters.stipplePattern?new ja.DefaultBufferWriter(a):new qa(a.clone().vec3f(w.VertexAttribute.AUXPOS1).vec2f(w.VertexAttribute.UV0))};return B._createClass(q)}(U.Material),pa=function(p){function q(){var a=p.apply(this,arguments)||this;a._stipplePattern=null;return a}B._inherits(q,p);var c=q.prototype;c.dispose=function(){B._get(B._getPrototypeOf(q.prototype),"dispose",this).call(this);this._stippleTextureRepository.release(this._stipplePattern);this._stipplePattern=
null};c._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};c.beginSlot=function(a){this._output===L.ShaderOutput.Color&&this._updateOccludeeState(a);const b=this._material.parameters.stipplePattern;this._stipplePattern!==b&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(b,this._stipplePattern)}),this._stipplePattern=b);return this.ensureTechnique(la.NativeLineTechnique,
a)};return B._createClass(q)}(ha),qa=function(){function p(c){this.vertexBufferLayout=c}var q=p.prototype;q.elementCount=function(c){return c.indices.get(w.VertexAttribute.POSITION).length};q.write=function(c,a,b,f,d){ka.writeDefaultAttributes(b,this.vertexBufferLayout,c,a,f,d);this._writeAuxpos1(c,b,f,d);this._writeUV0(c,b,f,d)};q._writeAuxpos1=function(c,a,b,f){var d=b.getField(w.VertexAttribute.AUXPOS1,T.BufferViewVec3f);b=a.indices.get(w.VertexAttribute.POSITION);a=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;
const m=d.typedBufferStride;d=d.typedBuffer;f*=m;for(let g=0;g<b.length-1;g+=2)for(const k of[1,0]){var u=3*b[g+k];const e=a[u],l=a[u+1];u=a[u+2];const A=c[1]*e+c[5]*l+c[9]*u+c[13],x=c[2]*e+c[6]*l+c[10]*u+c[14];d[f]=c[0]*e+c[4]*l+c[8]*u+c[12];d[f+1]=A;d[f+2]=x;f+=m}};q._writeUV0=function(c,a,b,f){var d=b.getField(w.VertexAttribute.UV0,T.BufferViewVec2f),m=a.indices.get(w.VertexAttribute.POSITION);b=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;const u=a.vertexAttributes.get(w.VertexAttribute.DISTANCETOSTART)?.data;
a=d.typedBufferStride;d=d.typedBuffer;f*=a;let g=0;d[f]=M.START;d[f+1]=g;f+=a;var k=3*m[0];k=h.set(r,b[k],b[k+1],b[k+2]);c&&h.transformMat4(k,k,c);const e=t,l=m.length-1;let A=1;const x=u?(D,aa,ba)=>g=u[ba]:(D,aa,ba)=>g+=h.distance(D,aa);for(let D=1;D<l;D+=2){var v=3*m[D];h.set(e,b[v],b[v+1],b[v+2]);c&&h.transformMat4(e,e,c);x(k,e,A++);for(v=0;2>v;++v)d[f]=1-v,d[f+1]=g,f+=a;h.copy(k,e)}m=3*m[l];h.set(e,b[m],b[m+1],b[m+2]);c&&h.transformMat4(e,e,c);x(k,e,A);d[f]=M.END;d[f+1]=g};return B._createClass(p)}(),
W=function(p){function q(){var c=p.apply(this,arguments)||this;c.color=fa.ONES;c.hasVertexColors=!1;c.hasSlicePlane=!1;c.width=1;c.stipplePreferContinuous=!0;c.hasOccludees=!1;c.stippleTexture=null;return c}B._inherits(q,p);return B._createClass(q)}(U.MaterialParameters);const r=y.create(),t=y.create(),z=y.create(),H=y.create(),F=I.createRenderScreenPointArray3(),G=I.createRenderScreenPointArray3(),Y=y.create(),Z=y.create(),X=E.create(),oa=E.create(),na=y.create(),J=[I.createRenderScreenPointArray3(),
I.createRenderScreenPointArray3(),I.createRenderScreenPointArray3(),I.createRenderScreenPointArray3()],C=[y.create(),y.create(),y.create(),y.create()],P=n.create(),Q=n.create(),R=n.create(),S=n.create();N.NativeLineMaterial=ra;N.Parameters=W;Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});
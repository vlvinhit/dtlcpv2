// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/arrayUtils ../../../../../core/MapUtils ../../../../../core/NestedMap ../../../../../core/PooledArray ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../core/shaderLibrary/ShaderOutput ../../lib/GLMaterials ../../lib/Material ../../lib/ModelDirtyTypes ../../lib/Util ../DrawParameters ../WaterMaterial ./BufferRange ./Instance ./PerBufferData ./PerOriginData ./VaoCache".split(" "),
function(L,M,G,S,T,U,H,I,V,z,W,X,A,B,Y,Z,J,N,O,aa,ba){function ca(n,r){let a;if(!n.some(d=>{if(d.numElements<r)return!1;a=d;return!0}))return null;const b=a.from;a.from+=r;a.from>=a.to&&n.removeUnordered(a);return b}function C(n){D.length<n&&(D=new Float32Array(n));return D}function P(n){n*=4;return 1024>=n?1024:262144>n?262144:Math.max(Math.min(262144*Math.ceil(1.5*n/262144),16777216),n)}function E(){D=new Float32Array(2)}let ea=function(){function n(a,b,d){this._rctx=a;this._materialRepository=
b;this.material=d;this._dataByOrigin=new Map;this._hasOccludees=this._hasHighlights=!1;this._glMaterials=new W.GLMaterials(this.material,this._materialRepository);this._bufferWriter=d.createBufferWriter();this._vaoCache=new ba.VaoCache(a,d.vertexAttributeLocations,V.glLayout(this._bufferWriter.vertexBufferLayout))}var r=n.prototype;r.dispose=function(){this._glMaterials.destroy();this._dataByOrigin.forEach(a=>a.dispose());this._dataByOrigin.clear();this._vaoCache.dispose()};r.forEachGeometry=function(a){this._dataByOrigin.forEach(b=>
b.buffers.forEach(d=>d.instances.forEach(c=>a(c.geometry))))};r.modify=function(a){this._updateGeometries(a.updates);this._addAndRemoveGeometries(a.adds,a.removes);this._updateDrawCommands()};r._updateGeometries=function(a){const b=this._bufferWriter,d=b.vertexBufferLayout.stride/4;for(const e of a){a=e.renderGeometry;const g=this._dataByOrigin.get(a.localOrigin.id)?.findBuffer(a.id);if(null==g)break;const f=g.instances.get(a.id);if(e.updateType&(A.DirtyState.GEOMETRY|A.DirtyState.TRANSFORMATION)){var c=
b.elementCount(f.geometry.geometry)*d;c=C(c);const h=b.vertexBufferLayout.createView(c.buffer);this._writeGeometry(a,h,0);g.vao.vertexBuffers.geometry.setSubData(c,f.from*d,0,f.numElements*d);E()}e.updateType&(A.DirtyState.HIGHLIGHT|A.DirtyState.OCCLUDEE|A.DirtyState.VISIBILITY)&&(g.drawCommandsDirty=!0)}};r._computeDeltas=function(a,b){const d=new T.NestedMap;for(var c of a){a=c.localOrigin;if(null==a)continue;let e=d.get(a.id,null);null==e&&(e=new Q(a.vec3),d.set(a.id,null,e));e.changes.push(c)}for(const e of b)b=
e.localOrigin,null!=b&&(c=this._dataByOrigin.get(b.id)?.findBuffer(e.id),null!=c&&(a=d.get(b.id,c),null==a&&(a=new Q(b.vec3),d.set(b.id,c,a)),a.changes.push(e)));return d};r._addAndRemoveGeometries=function(a,b){const {_bufferWriter:d,_dataByOrigin:c}=this,e=d.vertexBufferLayout.stride/4,g=this._computeDeltas(a,b);g.forEach((f,h)=>{const k=f.get(null),m=null!=k?k.changes:[];g.delete(h,null);let l=c.get(h);f.forEach((p,q)=>{g.delete(h,q);if(null==q)B.assert(!1,"No VAO for removed geometries");else if(q.instances.size===
p.changes.length)this._vaoCache.deleteVao(q.vao),G.removeUnordered(l.buffers,q),0===l.buffers.length&&0===m.length&&c.delete(h);else{var x=q.numElements,u=q.vao.byteSize/4,t=m.reduce((y,K)=>y+d.elementCount(K.geometry),0),w=p.changes.reduce((y,K)=>y+d.elementCount(K.geometry),0);x=Math.min((x+t-w)*e,4194304);t=x>u;65536<x&&x<u/2?(p.changes.forEach(({id:y})=>q.deleteInstance(y)),q.instances.forEach(({geometry:y})=>m.push(y)),this._vaoCache.deleteVao(q.vao),G.removeUnordered(l.buffers,q)):t?this._applyAndRebuild(q,
m,p):this._applyRemoves(q,p)}});if(0<m.length)for(null==l&&(l=new aa.PerOriginData(k.origin),c.set(h,l)),l.buffers.forEach(p=>this._applyAdds(p,m));0<m.length;)l.buffers.push(this._applyAndRebuild(new O.PerBufferData,m,null))})};r._updateDrawCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.buffers.forEach(b=>{b.drawCommandsDirty&&(b.hasHiddenInstances=!1,b.hasHighlights=!1,b.hasOccludees=!1,S.someMap(b.instances,d=>{b.updateDrawState(d);return b.hasHiddenInstances&&
b.hasHighlights&&b.hasOccludees}),b.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride));this._hasHighlights=this._hasHighlights||b.hasHighlights;this._hasOccludees=this._hasOccludees||b.hasOccludees})})};r._applyAndRebuild=function(a,b,d){if(null!=d)for(var c of d.changes)a.deleteInstance(c.id);const e=this._bufferWriter;d=e.vertexBufferLayout.stride;c=d/4;var g=Math.floor(4194304/c);let f=a.numElements;for(;0<b.length;){const l=b.pop();var h=e.elementCount(l.geometry);if(f+h>g&&0<f){b.push(l);
break}f+=h;h=new N.Instance(l,0,0);B.assert(null==a.instances.get(l.id));a.addInstance(l.id,h)}b=f*c;g=C(b);const k=e.vertexBufferLayout.createView(g.buffer);let m=0;a.hasHiddenInstances=!1;a.hasHighlights=!1;a.hasOccludees=!1;a.instances.forEach((l,p)=>{this._writeGeometry(l.geometry,k,m);const q=m;m+=e.elementCount(l.geometry.geometry);a.updateInstance(p,q,m);a.updateDrawState(l)});this._vaoCache.deleteVao(a.vao);a.vao=this._vaoCache.newVao(P(b));a.vao.vertexBuffers.geometry.setSubData(g,0,0,m*
c);E();a.holes.clear();b=a.holes.pushNew();b.from=m;b.to=Math.floor(a.vao.byteSize/d);a.updateDrawCommands(d);return a};r._applyRemoves=function(a,b){if(0!==b.changes.length){for(var d of b.changes){var c=d.id;if(b=a.instances.get(c)){a.deleteInstance(c);if(c=v.back()){if(c.to===b.from){c.to=b.to;continue}if(c.from===b.to){c.from=b.from;continue}}c=v.pushNew();c.from=b.from;c.to=b.to}}J.mergeAdjacentRanges(v);var e=this._bufferWriter.vertexBufferLayout.stride/4;d=v.reduce((h,k)=>Math.max(h,k.numElements),
0)*e;var g=C(d);g.fill(0,0,d);var f=a.vao.vertexBuffers.geometry;v.forAll(h=>f.setSubData(g,h.from*e,0,h.numElements*e));E();a.holes.pushArray(v.data,v.length);v.forAll((h,k)=>v.data[k]=null);v.clear();a.drawCommandsDirty=!0}};r._applyAdds=function(a,b){if(0!==b.length)if(O.hasVao(a)){var d=this._bufferWriter,c=d.vertexBufferLayout.stride/4,e=a.numElements,g=b.reduce((u,t)=>u+d.elementCount(t.geometry),0);e=Math.min((e+g)*c,4194304);g=4*e;if(a.vao.byteSize<P(4128768)&&g>a.vao.byteSize)this._applyAndRebuild(a,
b,null);else{J.mergeAdjacentRanges(a.holes);var f=[];for(var h of b)g=d.elementCount(h.geometry),g=ca(a.holes,g),f.push(g);var k=a.vao.vertexBuffers.geometry,m=0,l=0,p=0,q=C(e),x=d.vertexBufferLayout.createView(q.buffer);b.forEach((u,t)=>{t=f[t];if(null!=t){if(p!==t){var w=p-l;0<w&&k.setSubData(q,l*c,0,w*c);l=t;m=0}w=d.elementCount(u.geometry);this._writeGeometry(u,x,m);m+=w;p=t+w;t=new N.Instance(u,t,t+w);B.assert(null==a.instances.get(u.id));a.addInstance(u.id,t);a.drawCommandsDirty=!0}});h=p-l;
0<h&&k.setSubData(q,l*c,0,h*c);G.filterInPlace(b,(u,t)=>null==f[t]);E()}}else this._applyAndRebuild(a,b,null)};r._writeGeometry=function(a,b,d){var c=a.localOrigin.vec3;B.setMatrixTranslation3(R,-c[0],-c[1],-c[2]);c=H.multiply(da,R,a.transformation);H.invert(F,c);H.transpose(F,F);this._bufferWriter.write(c,F,a.geometry,b,d)};r.updateAnimation=function(a){return this.material.update(a)};r.requiresSlot=function(a,b){return this.material.requiresSlot(a,b)};r.prepareTechnique=function(a){const {output:b,
bindParameters:d}=a;if(!this.requiresSlot(d.slot,b))return null;const c=b===z.ShaderOutput.Highlight||b===z.ShaderOutput.ShadowHighlight;if(c&&!this._hasHighlights)return null;const e=b===z.ShaderOutput.ShadowExcludeHighlight,g=!(c||e);for(const h of this._dataByOrigin.values())for(const k of h.buffers){if(c&&!k.hasHighlights)continue;var f=(c?k.drawCommandsHighlight:e&&k.needsMultipleCommands()?k.drawCommandsShadowHighlightRest:k.drawCommandsDefault)||null;const m=g&&k.drawCommandsOccludees||null;
if(f?.length||m?.length)if(f=this._glMaterials.load(a.rctx,d.slot,b),f=null!=f?f.beginSlot(d):null,null!=f)return f}return null};r.render=function(a,b){const {output:d,bindParameters:c}=a;a=d===z.ShaderOutput.Highlight||d===z.ShaderOutput.ShadowHighlight;const e=d===z.ShaderOutput.ShadowExcludeHighlight,g=!(a||e),f=this._rctx;f.appleAmdDriverHelper?.resetIndicesType();f.bindTechnique(b,this.material.parameters,c);for(const h of this._dataByOrigin.values())for(const k of h.buffers){if(a&&!k.hasHighlights)continue;
const m=(a?k.drawCommandsHighlight:e&&k.needsMultipleCommands()?k.drawCommandsShadowHighlightRest:k.drawCommandsDefault)||null,l=g&&k.drawCommandsOccludees||null;if(m?.length||l?.length)b.program.bindDraw(new Y.DrawParameters(h.origin),c,this.material.parameters),b.ensureAttributeLocations(k.vao),f.bindVAO(k.vao),m?.length&&(b.bindPipelineState(f,c.slot,!1),m.forAll(p=>f.drawArrays(b.primitiveType,p.first,p.count))),l?.length&&(b.bindPipelineState(f,c.slot,!0),l.forAll(p=>f.drawArrays(b.primitiveType,
p.first,p.count)))}};M._createClass(n,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this.material instanceof Z.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this.material.renderOccluded!==X.RenderOccludedFlag.Occlude}},{key:"numGeometries",get:function(){let a=0;this._dataByOrigin.forEach(b=>
a+=b.buffers.reduce((d,c)=>d+=c.instances.size,0));return a}},{key:"test",get:function(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]);return n}(),Q=M._createClass(function(n){this.origin=n;this.changes=[]});const R=I.create(),da=I.create(),F=I.create(),v=new U({allocator:n=>n||new J.BufferRange,deallocator:null});let D=new Float32Array(65536);L.MergedRenderer=ea;Object.defineProperty(L,Symbol.toStringTag,{value:"Module"})});
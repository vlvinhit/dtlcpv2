// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariablePassParameters ../shaders/LineMarkerTechniqueConfiguration ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechniqueConfiguration".split(" "),
function(ca,J,Z,ta,da,V,ua,g,A,va,aa,P,x,wa,F,xa,ea,M,ya,l,za,Aa,Ba,la,ma){function N(h,q,b,a,c){for(let d=0;d<c;d++)b[a++]=h[q++];return a}function na(h,q,b){q=q.get(l.VertexAttribute.POSITION).data;b=b?b.get(l.VertexAttribute.POSITION):null;return h.isClosed?b?2<b.length:6<q.length:!1}var B;(function(h){h[h.LEFT_JOIN_START=-2]="LEFT_JOIN_START";h[h.LEFT_JOIN_END=-1]="LEFT_JOIN_END";h[h.LEFT_CAP_START=-4]="LEFT_CAP_START";h[h.LEFT_CAP_END=-5]="LEFT_CAP_END";h[h.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";
h[h.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";h[h.RIGHT_CAP_START=4]="RIGHT_CAP_START";h[h.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(B||(B={}));let Ga=function(h){function q(a){a=h.call(this,a,new oa)||this;a._configuration=new ma.RibbonLineTechniqueConfiguration;a._vertexAttributeLocations=la.vertexAttributeLocations;return a}J._inherits(q,h);var b=q.prototype;b.isClosed=function(a,c){return this.parameters.isClosed?c?2<c.length:6<a.length:!1};b.getConfiguration=function(a,c){this._configuration.output=a;this._configuration.draped=
c.slot===M.RenderSlot.DRAPED_MATERIAL;a=null!=this.parameters.stipplePattern&&a!==F.ShaderOutput.Highlight;this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&null!=this.parameters.stippleOffColor;this._configuration.stippleScaleWithLineWidth=a&&this.parameters.stippleScaleWithLineWidth;this._configuration.stipplePreferContinuous=a&&this.parameters.stipplePreferContinuous;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasOccludees=
this.parameters.hasOccludees;this._configuration.roundJoins="round"===this.parameters.join;this._configuration.capType=this.parameters.cap;a=this._configuration;if(null!=this.parameters.markerParameters){var d=this.parameters.markerParameters;d=d.anchor===Aa.LineMarkerAnchor.Tip&&d.hideOnShortSegments&&"begin-end"===d.placement&&d.worldSpace}else d=!1;a.applyMarkerOffset=d;this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset;this._configuration.writeDepth=this.parameters.writeDepth;
this._configuration.vvSize=!!this.parameters.vvSize;this._configuration.vvColor=!!this.parameters.vvColor;this._configuration.vvOpacity=!!this.parameters.vvOpacity;this._configuration.innerColorEnabled=0<this.parameters.innerWidth&&null!=this.parameters.innerColor;this._configuration.falloffEnabled=0<this.parameters.falloff;this._configuration.occluder=this.parameters.renderOccluded===ea.RenderOccludedFlag.OccludeAndTransparentStencil;this._configuration.transparencyPassType=c.transparencyPassType;
this._configuration.hasMultipassTerrain=c.multipassTerrain.enabled;this._configuration.cullAboveGround=c.multipassTerrain.cullAboveGround;this._configuration.wireframe=this.parameters.wireframe;return this._configuration};b.intersectDraped=function(a,c,d,m,e,p){if(d.options.selectionMode){c=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;d=a.vertexAttributes.get(l.VertexAttribute.SIZE);var f=this.parameters.width;this.parameters.vvSize?(d=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],
f*=da.clamp(this.parameters.vvSize.offset[0]+d*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])):d&&(f*=d.data[0]);d=m[0];m=m[1];a=(f/2+4)*a.screenToWorldRatio;f=Number.MAX_VALUE;var u=0;for(let G=0;G<c.length-5;G+=3){var r=c[G],w=c[G+1],D=d-r,k=m-w;r=c[G+3]-r;w=c[G+4]-w;const O=da.clamp((r*D+w*k)/(r*r+w*w),0,1);D=r*O-D;k=w*O-k;k=D*D+k*k;k<f&&(f=k,u=G/3)}f<a*a&&e(p.dist,p.normal,u,!1)}};b.intersect=function(a,c,d,m,e,p){if(d.options.selectionMode&&
a.visible)if(ya.isTranslationMatrix(c)){var f=a.vertexAttributes;e=f.get(l.VertexAttribute.POSITION).data;m=this.parameters.width;if(this.parameters.vvSize){var u=f.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];m*=da.clamp(this.parameters.vvSize.offset[0]+u*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else f.has(l.VertexAttribute.SIZE)&&(m*=f.get(l.VertexAttribute.SIZE).data[0]);var r=d.camera,w=Ca;ua.copy(w,d.point);u=m*r.pixelRatio/
2+4*r.pixelRatio;g.set(X[0],w[0]-u,w[1]+u,0);g.set(X[1],w[0]+u,w[1]+u,0);g.set(X[2],w[0]+u,w[1]-u,0);g.set(X[3],w[0]-u,w[1]-u,0);for(m=0;4>m;m++)if(!r.unprojectFromRenderScreen(X[m],K[m]))return;x.fromPoints(r.eye,K[0],K[1],fa);x.fromPoints(r.eye,K[1],K[2],ha);x.fromPoints(r.eye,K[2],K[3],ia);x.fromPoints(r.eye,K[3],K[0],ja);var D=Number.MAX_VALUE;m=0;a=na(this.parameters,f,a.indices)?e.length-2:e.length-5;for(f=0;f<a;f+=3){y[0]=e[f]+c[12];y[1]=e[f+1]+c[13];y[2]=e[f+2]+c[14];var k=(f+3)%e.length;
z[0]=e[k]+c[12];z[1]=e[k+1]+c[13];z[2]=e[k+2]+c[14];if(!(0>x.signedDistance(fa,y)&&0>x.signedDistance(fa,z)||0>x.signedDistance(ha,y)&&0>x.signedDistance(ha,z)||0>x.signedDistance(ia,y)&&0>x.signedDistance(ia,z)||0>x.signedDistance(ja,y)&&0>x.signedDistance(ja,z))){r.projectToRenderScreen(y,Q);r.projectToRenderScreen(z,R);if(0>Q[2]&&0<R[2])g.subtract(H,y,z),k=r.frustum,k=-x.signedDistance(k[aa.PlaneIndex.NEAR],y)/g.dot(H,x.normal(k[aa.PlaneIndex.NEAR])),g.scale(H,H,k),g.add(y,y,H),r.projectToRenderScreen(y,
Q);else if(0<Q[2]&&0>R[2])g.subtract(H,z,y),k=r.frustum,k=-x.signedDistance(k[aa.PlaneIndex.NEAR],z)/g.dot(H,x.normal(k[aa.PlaneIndex.NEAR])),g.scale(H,H,k),g.add(z,z,H),r.projectToRenderScreen(z,R);else if(0>Q[2]&&0>R[2])continue;Q[2]=0;R[2]=0;k=P.distance2(P.fromPoints(Q,R,pa),w);k<D&&(D=k,g.copy(qa,y),g.copy(ra,z),m=f/3)}}c=d.rayBegin;d=d.rayEnd;D<u*u&&(e=Number.MAX_VALUE,P.closestLineSegmentPoint(P.fromPoints(qa,ra,pa),P.fromPoints(c,d,Da),S)&&(g.subtract(S,S,c),e=g.length(S),g.scale(S,S,1/e),
e/=g.distance(c,d)),p(e,S,m,!1))}else ta.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix")};b.createBufferWriter=function(){return new Ea(this._layout,this.parameters)};b.requiresSlot=function(a,c){return c===F.ShaderOutput.Color||c===F.ShaderOutput.Alpha||c===F.ShaderOutput.Highlight||c===F.ShaderOutput.Depth||c===F.ShaderOutput.ObjectAndLayerIdColor?a===M.RenderSlot.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===ea.RenderOccludedFlag.OccludeAndTransparentStencil?
a===M.RenderSlot.OPAQUE_MATERIAL||a===M.RenderSlot.OCCLUDER_MATERIAL||a===M.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL:c===F.ShaderOutput.Color||c===F.ShaderOutput.Alpha?a===(this.parameters.writeDepth?M.RenderSlot.TRANSPARENT_MATERIAL:M.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a===M.RenderSlot.OPAQUE_MATERIAL:!1};b.createGLMaterial=function(a){return new Fa(a)};b.validateParameters=function(a){"miter"!==a.join&&(a.miterLimit=0);null!=a.markerParameters&&(a.markerScale=a.markerParameters.width/
a.width)};J._createClass(q,[{key:"_layout",get:function(){const a=wa.newLayout().vec3f(l.VertexAttribute.POSITION).f32(l.VertexAttribute.SUBDIVISIONFACTOR).vec2f(l.VertexAttribute.UV0).vec3f(l.VertexAttribute.AUXPOS1).vec3f(l.VertexAttribute.AUXPOS2);this.parameters.vvSize?a.f32(l.VertexAttribute.SIZEFEATUREATTRIBUTE):a.f32(l.VertexAttribute.SIZE);this.parameters.vvColor?a.f32(l.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(l.VertexAttribute.COLOR);this.parameters.vvOpacity&&a.f32(l.VertexAttribute.OPACITYFEATUREATTRIBUTE);
Z("enable-feature:objectAndLayerId-rendering")&&a.vec4u8(l.VertexAttribute.OBJECTANDLAYERIDCOLOR);return a}}]);return q}(ea.Material),Fa=function(h){function q(){var a=h.apply(this,arguments)||this;a._stipplePattern=null;return a}J._inherits(q,h);var b=q.prototype;b.dispose=function(){J._get(J._getPrototypeOf(q.prototype),"dispose",this).call(this);this._stippleTextureRepository.release(this._stipplePattern);this._stipplePattern=null};b._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&
this._material.setParameters({hasOccludees:a.hasOccludees})};b.beginSlot=function(a){this._output!==F.ShaderOutput.Color&&this._output!==F.ShaderOutput.Alpha||this._updateOccludeeState(a);const c=this._material.parameters.stipplePattern;this._stipplePattern!==c&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(c,this._stipplePattern)}),this._stipplePattern=c);return this.ensureTechnique(la.RibbonLineTechnique,a)};return J._createClass(q)}(xa),oa=function(h){function q(){var b=
h.apply(this,arguments)||this;b.width=0;b.color=va.ONES;b.join="miter";b.cap=ma.CapType.BUTT;b.miterLimit=5;b.writeDepth=!0;b.hasPolygonOffset=!1;b.stippleTexture=null;b.stippleScaleWithLineWidth=!1;b.stipplePreferContinuous=!0;b.markerParameters=null;b.markerScale=1;b.hasSlicePlane=!1;b.vvFastUpdate=!1;b.isClosed=!1;b.falloff=0;b.innerWidth=0;b.hasOccludees=!1;b.wireframe=!1;return b}J._inherits(q,h);return J._createClass(q)}(za.VisualVariablePassParameters),Ea=function(){function h(b,a){this._parameters=
a;this.numJoinSubdivisions=0;this.vertexBufferLayout=b;b=a.stipplePattern?1:0;switch(this._parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=b;break;case "round":this.numJoinSubdivisions=Ba.RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS+b}}var q=h.prototype;q._isClosed=function(b){return na(this._parameters,b.vertexAttributes,b.indices)};q.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};q.elementCount=function(b){var a=b.indices.get(l.VertexAttribute.POSITION).length/
2+1;b=this._isClosed(b);a=(b?2:4)+((b?a:a-1)-(b?0:1))*(2*this.numJoinSubdivisions+4);a+=2;this._parameters.wireframe&&(a=2+4*(a-2));return a};q.write=function(b,a,c,d,m){a=Ha;const e=Ia,p=Ja,f=c.vertexAttributes.get(l.VertexAttribute.POSITION).data;var u=c.indices&&c.indices.get(l.VertexAttribute.POSITION);const r=c.vertexAttributes.get(l.VertexAttribute.DISTANCETOSTART)?.data;u&&u.length!==2*(f.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let w=1,D=0;this._parameters.vvSize?
D=c.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:c.vertexAttributes.has(l.VertexAttribute.SIZE)&&(w=c.vertexAttributes.get(l.VertexAttribute.SIZE).data[0]);let k=[1,1,1,1],G=0;this._parameters.vvColor?G=c.vertexAttributes.get(l.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:c.vertexAttributes.has(l.VertexAttribute.COLOR)&&(k=c.vertexAttributes.get(l.VertexAttribute.COLOR).data);const O=Z("enable-feature:objectAndLayerId-rendering")?c.objectAndLayerIdColor:null;let sa=0;this._parameters.vvOpacity&&
(sa=c.vertexAttributes.get(l.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);u=f.length/3;const t=new Float32Array(d.buffer),ba=Z("enable-feature:objectAndLayerId-rendering")?new Uint8Array(d.buffer):null,T=this.vertexBufferLayout.stride/4;let n=m*T;m=n;let C=0;const ka=r?(v,I,L)=>C=r[L]:(v,I,L)=>C+=g.distance(v,I),Ka=Z("enable-feature:objectAndLayerId-rendering"),E=(v,I,L,La,Ma,Na,Oa)=>{t[n++]=I[0];t[n++]=I[1];t[n++]=I[2];t[n++]=La;t[n++]=Oa;t[n++]=Ma;t[n++]=v[0];t[n++]=v[1];t[n++]=v[2];t[n++]=
L[0];t[n++]=L[1];t[n++]=L[2];t[n++]=this._parameters.vvSize?D:w;this._parameters.vvColor?t[n++]=G:(v=Math.min(4*Na,k.length-4),t[n++]=k[v],t[n++]=k[v+1],t[n++]=k[v+2],t[n++]=k[v+3]);this._parameters.vvOpacity&&(t[n++]=sa);Ka&&(null!=O&&(ba[4*n]=O[0],ba[4*n+1]=O[1],ba[4*n+2]=O[2],ba[4*n+3]=O[3]),n++)};n+=T;g.set(e,f[0],f[1],f[2]);b&&g.transformMat4(e,e,b);if(c=this._isClosed(c)){var U=f.length-3;g.set(a,f[U],f[U+1],f[U+2]);b&&g.transformMat4(a,a,b)}else g.set(p,f[3],f[4],f[5]),b&&g.transformMat4(p,
p,b),E(e,e,p,1,B.LEFT_CAP_START,0,0),E(e,e,p,1,B.RIGHT_CAP_START,0,0),g.copy(a,e),g.copy(e,p);U=c?0:1;const Y=c?u:u-1;for(let v=U;v<Y;v++){var W=(v+1)%u*3;g.set(p,f[W],f[W+1],f[W+2]);b&&g.transformMat4(p,p,b);ka(a,e,v);E(a,e,p,0,B.LEFT_JOIN_END,v,C);E(a,e,p,0,B.RIGHT_JOIN_END,v,C);W=this.numJoinSubdivisions;for(let I=0;I<W;++I){const L=(I+1)/(W+1);E(a,e,p,L,B.LEFT_JOIN_END,v,C);E(a,e,p,L,B.RIGHT_JOIN_END,v,C)}E(a,e,p,1,B.LEFT_JOIN_START,v,C);E(a,e,p,1,B.RIGHT_JOIN_START,v,C);g.copy(a,e);g.copy(e,
p)}c?(g.set(p,f[3],f[4],f[5]),b&&g.transformMat4(p,p,b),C=ka(a,e,Y),E(a,e,p,0,B.LEFT_JOIN_END,U,C),E(a,e,p,0,B.RIGHT_JOIN_END,U,C)):(C=ka(a,e,Y),E(a,e,e,0,B.LEFT_CAP_END,Y,C),E(a,e,e,0,B.RIGHT_CAP_END,Y,C));N(t,m+T,t,m,T);n=N(t,n-T,t,n,T);this._parameters.wireframe&&this._addWireframeVertices(d,m,n,T)};q._addWireframeVertices=function(b,a,c,d){const m=new Float32Array(b.buffer,c*Float32Array.BYTES_PER_ELEMENT);b=new Float32Array(b.buffer,a*Float32Array.BYTES_PER_ELEMENT,c-a);a=0;for(c=0;c<b.length-
1;c+=2*d)a=N(b,c,m,a,d),a=N(b,c+2*d,m,a,d),a=N(b,c+1*d,m,a,d),a=N(b,c+2*d,m,a,d),a=N(b,c+1*d,m,a,d),a=N(b,c+3*d,m,a,d)};return J._createClass(h)}();const y=A.create(),z=A.create(),H=A.create(),S=A.create(),Ca=A.create(),Q=V.createRenderScreenPointArray3(),R=V.createRenderScreenPointArray3(),qa=A.create(),ra=A.create(),pa=P.create(),Da=P.create(),Ha=A.create(),Ia=A.create(),Ja=A.create(),X=[V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3(),V.createRenderScreenPointArray3()],
K=[A.create(),A.create(),A.create(),A.create()],fa=x.create(),ha=x.create(),ia=x.create(),ja=x.create();ca.Parameters=oa;ca.RibbonLineMaterial=Ga;Object.defineProperty(ca,Symbol.toStringTag,{value:"Module"})});
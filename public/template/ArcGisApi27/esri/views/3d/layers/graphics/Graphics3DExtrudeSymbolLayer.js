// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Error ../../../../core/lang ../../../../core/unitUtils ../../../../chunks/earcut ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ../../../../geometry/support/Indices ../../../../chunks/vec32 ../../../../layers/graphics/data/SnappingCandidate ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../support/renderInfoUtils/polygon ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/Normals ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ia,N,ja,Ea,W,Fa,Ga,Ha,Ia,ka,X,A,F,Ja,R,S,Y,Ka,Z,La,Ma,aa,Na,Oa,Pa,la,ma,Qa,Ra,Sa,Ta,Ua,Va,ba,ca,Wa,Xa,Ya,Za,$a,H,na){function oa(h,k,f,a,b,c){const d=Y.getZeroIndexArray(k.length);b=[[H.VertexAttribute.POSITION,new ba.Attribute(a.positions,3,!0)],[H.VertexAttribute.NORMALCOMPRESSED,new ba.Attribute(a.normals,2,!0)],[H.VertexAttribute.COLOR,new ba.Attribute(b,4,!0)]];return new Xa.Geometry(h,b,[[H.VertexAttribute.POSITION,k],[H.VertexAttribute.NORMALCOMPRESSED,k],[H.VertexAttribute.COLOR,
d]],a.elevation,Wa.ContentObjectType.Mesh,c,f)}function ab(h,k,f,a,b,c,d,p,g,l,q,m,z){let D=0;var e=2*a.count,n=a.index,G=a.count,I=f.length/3,B=e;A.copy(v,m);const r=0<q?1:-1;e=3*n;let w=0;n=3*w;let u=G;m=3*u;for(let x=0;x<G;++x)z&&(v[0]=h[e],v[1]=h[e+1],v[2]=h[e+2],A.normalize(v,v)),b[n]=h[e],b[n+1]=h[e+1],b[n+2]=h[e+2],c[n]=k[e],c[n+1]=k[e+1],c[n+2]=k[e+2],d[n]=-r*v[0],d[n+1]=-r*v[1],d[n+2]=-r*v[2],p[w]=0,b[m]=h[e]+q*v[0],b[m+1]=h[e+1]+q*v[1],b[m+2]=h[e+2]+q*v[2],c[m]=k[e],c[m+1]=k[e+1],c[m+2]=
k[e+2],d[m]=r*v[0],d[m+1]=r*v[1],d[m+2]=r*v[2],p[u]=q,n+=3,m+=3,e+=3,w+=1,u+=1;n=e=0;m=3*B;h=0>q?pa:qa;k=0>q?qa:pa;for(z=0;z<I;++z)l[n]=f[e+h[0]],l[n+1]=f[e+h[1]],l[n+2]=f[e+h[2]],g[m]=f[e+k[0]]+G,g[m+1]=f[e+k[1]]+G,g[m+2]=f[e+k[2]]+G,n+=3,m+=3,e+=3;f=2*a.count;e=0;ra(b,c,p,d,D,a.pathLengths[0],a.count,f,g,e,q);f+=4*a.pathLengths[0];e+=2*a.pathLengths[0];D+=a.pathLengths[0];for(l=1;l<a.pathLengths.length;++l)ra(b,c,p,d,D,a.pathLengths[l],a.count,f,g,e,q),f+=4*a.pathLengths[l],e+=2*a.pathLengths[l],
D+=a.pathLengths[l]}function T(h,k,f,a,b,c,d){a[c]=a[d];d*=3;c*=3;h[c]=h[d];h[c+1]=h[d+1];h[c+2]=h[d+2];k[c]=k[d];k[c+1]=k[d+1];k[c+2]=k[d+2];f[c]=b[0];f[c+1]=b[1];f[c+2]=b[2]}function ra(h,k,f,a,b,c,d,p,g,l,q){let m=b,z=b+1,D=b+d,e=b+d+1,n=p,G=p+1,I=p+2*c;p=p+2*c+1;0>q&&(m=b+d+1,e=b);l*=3;for(let t=0;t<c;++t){t===c-1&&(0<q?(z=b,e=b+d):(z=b,m=b+d));var B=h,r=m,w=z,u=D,x=O;r*=3;w*=3;u*=3;A.set(da,B[r++],B[r++],B[r++]);A.set(sa,B[w++],B[w++],B[w++]);A.set(ta,B[u++],B[u++],B[u++]);A.subtract(ua,sa,da);
A.subtract(va,ta,da);A.cross(x,va,ua);A.normalize(x,x);T(h,k,a,f,O,n,m);T(h,k,a,f,O,G,z);T(h,k,a,f,O,I,D);T(h,k,a,f,O,p,e);g[l++]=n;g[l++]=I;g[l++]=p;g[l++]=n;g[l++]=p;g[l++]=G;m++;z++;D++;e++;n+=2;G+=2;I+=2;p+=2}}const bb=["polygon","extent"];ja=function(h){function k(a,b,c,d){a=h.call(this,a,b,c,d)||this;a.ensureDrapedStatus(!1);return a}N._inherits(k,h);var f=k.prototype;f.doLoad=async function(){if(!this._drivenProperties.size){var a=la.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new Ea("graphics3dextrudesymbollayer:invalid-size",
a);}var b=this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color);a=F.fromArray(b);b=b[3];const c=1>b||this.needsDrivenTransparentPass;a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:b,transparent:c,cullFace:c?ca.CullFaceOptions.None:ca.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:Va.NormalType.Compressed};this._material=
new na.DefaultMaterial(a);this._bottomMaterial=new na.DefaultMaterial({...a,cullFace:ca.CullFaceOptions.Back});this._context.stage.add(this._material);this._context.stage.add(this._bottomMaterial)};f.destroy=function(){N._get(N._getPrototypeOf(k.prototype),"destroy",this).call(this);this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,bb,this.symbolLayer.type))return null;
const c=this._getVertexOpacityAndColor(a.renderingInfo,255),d=this.setGraphicElevationContext(b,new Na.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,c,d,b.uid)};f.layerOpacityChanged=function(a,b){const c=this._getCombinedOpacity(this.symbolLayer?.material?.color),d=1>c||this.needsDrivenTransparentPass;this._material.setParameters({opacity:c,transparent:d});this._bottomMaterial.setParameters({opacity:c,transparent:d});const p=this._getLayerOpacity();a.forEach(g=>{g=b(g);null!=g&&
g.layerOpacityChanged(p,this._context.isAsync)})};f.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,aa.needsElevationUpdates3D)};f.slicePlaneEnabledChanged=function(a,b){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});a.forEach(c=>{c=b(c);null!=c&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};
f.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};f._getExtrusionSize=function(a){a=a.size&&this._drivenProperties.size?La.getDriverAxisSizeValue(a.size,2)??0:this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};f.applyRendererDiff=function(a,b){return this._drivenPropertiesChanged(b)?
ma.ApplyRendererDiffResult.RecreateSymbol:ma.ApplyRendererDiffResult.RecreateGraphics};f.queryForSnapping=async function(a,b,c,d){b=this._getExtrusionSize(c)*this._context.renderCoordsHelper.unitInMeters/Fa.getMetersPerVerticalUnitForSR(b);const {objectId:p,target:g}=a;c=W.clone(g);c.z=(c.z??0)+b;switch(a.type){case "edge":const {start:l,end:q}=a;a=W.clone(l);d=W.clone(q);a.z=(a.z??0)+b;d.z=(d.z??0)+b;return[Z.makeEdgeCandidate(p,c,Infinity,a,d)];case "vertex":return[Z.makeVertexCandidate(p,c,Infinity),
Z.makeEdgeCandidate(p,g,Infinity,g,c)];default:return[]}};f._getSymbolSize=function(){return this.symbolLayer.size??1};f._createAs3DShape=function(a,b,c,d,p){var g=Qa.geometryAsPolygon(a.geometry);if(null==g)return null;if(0===g.rings.length||!g.rings.some(t=>0<t.length))return this._logGeometryValidationWarnings(g.rings,"rings","ExtrudeSymbol3DLayer"),null;a=Ua.geometryToRenderInfo(g,this._context.elevationProvider,this._context.renderCoordsHelper,d);this._logGeometryCreationWarnings(a,g.rings,"rings",
"ExtrudeSymbol3DLayer");var l=la.computeCentroid(g);if(null==l)return null;var q=[];const m=[],z=R.create(),D=X.create(),e=F.create(),n=this._context.renderCoordsHelper.viewingMode===Ma.ViewingMode.Global;n||this._context.renderCoordsHelper.worldUpAtPosition(null,e);Ja.computeTranslationToOriginAndRotation(g.spatialReference,[l.x,l.y,0],D,this._context.renderCoordsHelper.spatialReference);g=X.create();ka.invert(g,D);l=Ia.create();Ha.normalFromMat4(l,g);const {polygons:G,mapPositions:I,position:B}=
a;for(const t of G){l=t.count;if(this._context.clippingExtent&&(R.empty(z),R.expandWithBuffer(z,t.mapPositions),!R.intersectsClippingArea(z,this._context.clippingExtent)))continue;var r=Ga.earcut(t.mapPositions,t.holeIndices,3);if(0===r.length)continue;var w=r.length,u=6*l;l=Y.newIndexArray(u+w);w=Y.newIndexArray(w);var x=S.newDoubleArray(3*u);const L=S.newDoubleArray(3*u),P=S.newDoubleArray(3*u);u=S.newDoubleArray(u);const ea=this._getExtrusionSize(b);ab(B,I,r,t,x,P,L,u,l,w,ea,e,n);Ka.transformMat4(x,
x,g);r=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:p,layerUid:this._context.layer.uid});x=new cb(x,P,Za.compressNormals(L),u);q.push(oa(this._material,l,l.length-w.length,x,c,r),oa(this._bottomMaterial,w,0,x,c,r));m.push(x.heights)}if(0===q.length)return null;b=new $a.Object3D({geometries:q,layerUid:this._context.layer.uid,graphicUid:p,isElevationSource:!0});b.transformation=D;c=Ra.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});q=new Oa.Graphics3DObject3DGraphicLayer(this,
b,q,null,null,(t,L,P,ea,fa)=>{t=t.stageObject;const Q=t.geometries,wa=Q.length;L="absolute-height"!==L.mode;let xa=0;const ya=t.transformation,db=ka.invertOrIdentity(X.create(),ya);for(let J=0;J<wa;J+=2){const U=Q[J];if(!Ya.isGeometryWithMapPositions(U))continue;const C=U.getMutableAttribute(H.VertexAttribute.POSITION).data,za=m[J/2],K=new Ta.SamplePosition(U.mapPositions),Aa=C.length/3;let y=0,Ba=!1,Ca=0;for(let Da=0;Da<Aa;Da++){M[0]=C[y];M[1]=C[y+1];M[2]=C[y+2];ea(K,V);L&&(Ca+=V.sampledElevation);
Sa.TESTS_DISABLE_OPTIMIZATIONS?(A.set(E,K.array[K.offset],K.array[K.offset+1],V.z+za[y/3]),null!=P&&fa.toRenderCoords(E,P,E)):(A.set(E,C[y],C[y+1],C[y+2]),A.transformMat4(E,E,ya),fa.setAltitude(E,V.z+za[y/3]));A.transformMat4(E,E,db);C[y]=E[0];C[y+1]=E[1];C[y+2]=E[2];const ha=.01/fa.unitInMeters;if(Math.abs(M[0]-C[y])>=ha||Math.abs(M[1]-C[y+1])>=ha||Math.abs(M[2]-C[y+2])>=ha)Ba=!0;K.offset+=3;y+=3}Ba&&(U.invalidateBoundingInfo(),t.geometryVertexAttrsUpdated(Q[J]),Q[J+1].invalidateBoundingInfo(),t.geometryVertexAttrsUpdated(Q[J+
1]));xa+=Ca/Aa}return xa/wa},d,null!=c?{baseMaterial:this._material,edgeMaterials:[c],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null);q.alignedSampledElevation=a.sampledElevation;q.needsElevationUpdates=aa.needsElevationUpdates3D(d.mode);return q};return N._createClass(k)}(Pa.Graphics3DSymbolLayer);const O=F.create(),da=F.create(),sa=F.create(),ta=F.create(),ua=F.create(),va=F.create(),M=F.create(),E=F.create(),v=F.create(),V=new aa.SampleElevationInfo,qa=[0,2,
1],pa=[0,1,2];let cb=N._createClass(function(h,k,f,a){this.positions=h;this.elevation=k;this.normals=f;this.heights=a});ia.Graphics3DExtrudeSymbolLayer=ja;Object.defineProperty(ia,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/Error ../../../../core/screenUtils ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./interfaces ./lineUtils ../support/FastSymbolUpdates ../../support/debugFlags ../../support/engineContent/line ../../support/renderInfoUtils/line ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/LineMarkerMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../../geometry/Extent ../../../../geometry/Polygon".split(" "),
function(G,z,C,K,v,D,m,L,M,p,N,O,P,Q,E,A,t,F,R,H,S,T,U,V,B,W,X){const Y=["polyline","polygon","extent"],I=new t.ConvertOptions({size:!0,color:!0,rotation:!1,opacity:!0});C=function(q){function u(a,b,c,d){return q.call(this,a,b,c,d)||this}z._inherits(u,q);var f=u.prototype;f.doLoad=async function(){this._fastUpdates=t.initFastSymbolUpdatesState(this._context.renderer,I);if(!this._drivenProperties.size&&0>(null!=this.symbolLayer.size?this.symbolLayer.size:v.px2pt(1)))throw new K("graphics3dlinesymbollayer:invalid-size",
"Symbol sizes may not be negative values");};f._getMaterialParameters=function(a,b=!1){const c=this._getCombinedOpacityAndColor(b&&this._markerColor||this._materialColor);this._patternHidesLine&&!b&&(c[3]=0);a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:c,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:A.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:a,stipplePattern:V.getStipplePatternForLinePattern(this.symbolLayer.pattern),
stippleScaleWithLineWidth:!0};return this._fastUpdates?.visualVariables?{...a,...this._fastUpdates.materialParameters}:a};f.destroy=function(){z._get(z._getPrototypeOf(u.prototype),"destroy",this).call(this);this._forEachMaterial(a=>this._context.stage.remove(a));this._markerMaterialCached=this._wireframeRingMaterialCached=this._wireframeLineMaterialCached=this._ringMaterialCached=this._lineMaterialCached=null};f._getDrivenSize=function(a){return this._drivenProperties.size&&a.size?v.pt2px(L.getDriverAxisSizeValueAny(a.size)):
1};f._getDrivenColor=function(a){const b=D.fromValues(1,1,1,1);this._drivenProperties.color&&a.color&&(b[0]=a.color[0],b[1]=a.color[1],b[2]=a.color[2],0<a.color.length&&(b[3]=a.color[3]));this._drivenProperties.opacity&&a.opacity&&(b[3]=a.opacity);return b};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,Y,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(b,new N.ElevationContext);this.ensureDrapedStatus("on-the-ground"===c.mode);
return this.draped?this._createAsOverlay(a,this._context.layer.uid):this._createAs3DShape(a,c,b.uid)};f.applyRendererDiff=function(a,b){for(const c in a.diff)switch(c){case "visualVariables":const d=this._fastUpdates;if(t.updateFastSymbolUpdatesState(d,b,I))this._forEachMaterial(e=>e.setParameters(d.materialParameters));else return E.ApplyRendererDiffResult.RecreateSymbol;break;default:return E.ApplyRendererDiffResult.RecreateSymbol}return E.ApplyRendererDiffResult.FastUpdate};f.prepareSymbolLayerPatch=
function(a){if("partial"===a.diff.type){var b=a.diff.diff,c={};"complete"===b.size?.type&&(c.width=this._computeMaterialWidth(b.size.newValue),delete b.size);"complete"===b.cap?.type&&(c.cap=A.parseCapType(b.cap.newValue??"butt"),delete b.cap);var d=this._prepareMarkerPatch(a,b);this._prepareMaterialPatch(a,b,d);a.symbolLayerStatePatches.push(()=>this._forEachMaterial(e=>e.setParameters(c)))}};f.layerOpacityChanged=function(){this._forEachMaterial((a,b)=>this._updateMaterialLayerOpacity(a,b))};f._forEachMaterial=
function(a){null!=this._lineMaterialCached&&a(this._lineMaterialCached);null!=this._ringMaterialCached&&a(this._ringMaterialCached);null!=this._wireframeLineMaterialCached&&a(this._wireframeLineMaterialCached);null!=this._wireframeRingMaterialCached&&a(this._wireframeRingMaterialCached);null!=this._markerMaterialCached&&a(this._markerMaterialCached,!0)};f._updateMaterialLayerOpacity=function(a,b=!1){var c=a.parameters.color;const d=this.symbolLayer?.material?.color;b=this._patternHidesLine&&!b?0:
this._getCombinedOpacity(d);c=D.fromValues(c[0],c[1],c[2],b);a.setParameters({color:c})};f.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;c=p.elevationModeChangeUpdateType(u.elevationModeChangeTypes,c,d);if(c!==p.SymbolUpdateType.UPDATE)return c;const e=p.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)};f.slicePlaneEnabledChanged=function(){const a={hasSlicePlane:this._context.slicePlaneEnabled};this._forEachMaterial(b=>b.setParameters(a));
return!0};f.physicalBasedRenderingChanged=function(){return!0};f._getGeometryAsPolygonOrPolyline=function(a){switch(a.type){case "extent":if(a instanceof W)return X.fromExtent(a);break;case "polygon":case "polyline":return a}return null};f._createAs3DShape=function(a,b,c){const d=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry);var e="polygon"===d.type?d.rings:d.paths,g=[];const l=m.create(),h=H.geometryToRenderInfo(d,this._context.elevationProvider,this._context.renderCoordsHelper,b);this._logGeometryCreationWarnings(h,
e,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(e=0;e<h.lines.length;e++){var n=h.lines[e],k=n.position;n=n.mapPositions;if(null!=this._context.clippingExtent&&(m.empty(l),m.expandWithBuffer(l,n),!m.intersectsClippingArea(l,this._context.clippingExtent)))continue;k=this._createGeometry("polygon"===d.type?this._ringMaterial:this._lineMaterial,a,k,n,d.type,w.ELEVATED,c);g.push(k);F.LINE_WIREFRAMES&&g.push(k.instantiate({material:"polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial}));
null!=this._markerMaterial&&g.push(k.instantiate({material:this._markerMaterial}))}if(0===g.length)return null;a=new S.Object3D({geometries:g,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:c});g=new P.Graphics3DObject3DGraphicLayer(this,a,g,null,null,M.sharedGeometryElevationAligner,b);g.alignedSampledElevation=h.sampledElevation;g.needsElevationUpdates=p.needsElevationUpdates2D(b.mode);return g};f._createGeometry=function(a,b,c,d,e,g,l){g=g===w.DRAPED?{spatialReference:this._context.overlaySR,
renderCoordsHelper:this._context.renderCoordsHelper}:null;e="polygon"===e;const h=this._fastUpdates?.visualVariables.color,n=this._fastUpdates?.visualVariables.size,k=this._fastUpdates?.visualVariables.opacity;l=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerUid:this._context.layer.uid});b={position:c,size:n?null:this._getDrivenSize(b.renderingInfo),color:h?null:this._getDrivenColor(b.renderingInfo),sizeFeature:n?t.getAttributeValue(n.field,b.graphic):null,colorFeature:h?
t.getAttributeValue(h.field,b.graphic):null,opacityFeature:k?t.getAttributeValue(k.field,b.graphic):null};return R.createGeometry(a,{overlayInfo:g,removeDuplicateStartEnd:e,mapPositions:d,attributeData:b},l)};f._createAsOverlay=function(a,b){const c=a.graphic,d=this._getGeometryAsPolygonOrPolyline(c.geometry);var e="polygon"===d.type?d.rings:d.paths;const g="polygon"===d.type?this._ringMaterial:this._lineMaterial;g.renderPriority=this._renderPriority;const l=F.LINE_WIREFRAMES?"polygon"===d.type?this._wireframeRingMaterial:
this._wireframeLineMaterial:null,h=this._markerMaterial;null!=l&&(l.renderPriority=this._renderPriority-.001);null!=h&&(h.renderPriority=this._renderPriority-.002);const n=[],k=m.create(),J=m.empty();var r=H.geometryToRenderInfoDraped(d,this._context.overlaySR);this._logGeometryCreationWarnings(r,e,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(const x of r.lines)m.empty(k),m.expandWithBuffer(k,x.position),m.intersectsClippingArea(k,this._context.clippingExtent)&&(m.expandWithAABB(J,
k),e=y=>{y=this._createGeometry(y,a,x.position,void 0,d.type,w.DRAPED,c.uid);y=new T.RenderGeometry(y,{layerUid:b,graphicUid:c.uid});n.push(y)},null!=h&&(e(h),r=this.symbolLayer.marker.placement,"begin"!==r&&"begin-end"!==r||m.expandWithBuffer(k,x.position,0,1),"end"!==r&&"begin-end"!==r||m.expandWithBuffer(k,x.position,x.position.length-3,1)),e(g),F.LINE_WIREFRAMES&&e(l));return new O(this,n,J,this._context.drapeSourceRenderer)};f._computeMaterialWidth=function(a){a=a??v.px2pt(1);return this._drivenProperties.size?
this._fastUpdates?.visualVariables.size?v.pt2px(1):1:v.pt2px(a)};f._prepareMaterialPatch=function(a,b,c){var d=b.material;null==d?c.changed&&c.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,a):"collection"!==d.type&&(d=this._getCombinedOpacityAndColor("complete"===d.type?d.newValue?.color:"complete"===d.diff.color?.type?d.diff.color.newValue:null),c.useMaterialColor&&this._patchMaterialColor(D.clone(d),this._markerMaterialCached,
a),this._patternHidesLine&&(d[3]=0),this._patchMaterialColor(d,this._lineMaterialCached,a),delete b.material)};f._prepareMarkerPatch=function(a,b){const c=b.marker,d=this._markerMaterial;if(null==c||"partial"!==c.type||null==c.diff||null!=c.diff.placement||null!=c.diff.style&&"complete"!==c.diff.style.type||null!=c.diff.color&&"complete"!==c.diff.color.type||null==d)return{changed:!1,useMaterialColor:null==this._markerColor};var e=c.diff.color;const g=null!=e;e=g?e.newValue:null;const l=null==e&&
null==this._markerColor;e&&this._patchMaterialColor(this._getCombinedOpacityAndColor(e),d,a);const h=c.diff.style?.newValue;h&&a.symbolLayerStatePatches.push(()=>d.setParameters({markerPrimitive:A.parseLineMarkerStyle(h)}));delete b.marker;return{changed:g,useMaterialColor:l}};f._patchMaterialColor=function(a,b,c){null!=b&&c.symbolLayerStatePatches.push(()=>b.setParameters({color:a}))};z._createClass(u,[{key:"_materialColor",get:function(){return this.symbolLayer.material?.color}},{key:"_markerColor",
get:function(){return this.symbolLayer.marker?.color}},{key:"_lineMaterial",get:function(){null==this._lineMaterialCached&&(this._lineMaterialCached=new B.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached));return this._lineMaterialCached}},{key:"_ringMaterial",get:function(){null==this._ringMaterialCached&&(this._ringMaterialCached=new B.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached));return this._ringMaterialCached}},
{key:"_wireframeLineMaterial",get:function(){null==this._wireframeLineMaterialCached&&(this._wireframeLineMaterialCached=new B.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached));return this._wireframeLineMaterialCached}},{key:"_wireframeRingMaterial",get:function(){null==this._wireframeRingMaterialCached&&(this._wireframeRingMaterialCached=new B.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached));
return this._wireframeRingMaterialCached}},{key:"_markerMaterial",get:function(){null==this._markerMaterialCached&&null!=this.symbolLayer.marker&&(this._markerMaterialCached=new U.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:A.parseLineMarkerStyle(this.symbolLayer.marker.style)}),this._context.stage.add(this._markerMaterialCached));return this._markerMaterialCached}},{key:"_patternHidesLine",get:function(){const a=this.symbolLayer.pattern;
return null!=a&&"style"===a.type&&"none"===a.style}}]);return u}(Q.Graphics3DSymbolLayer);C.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};var w;(function(q){q[q.DRAPED=0]="DRAPED";q[q.ELEVATED=1]="ELEVATED"})(w||(w={}));G.Graphics3DLineSymbolLayer=C;Object.defineProperty(G,Symbol.toStringTag,{value:"Module"})});
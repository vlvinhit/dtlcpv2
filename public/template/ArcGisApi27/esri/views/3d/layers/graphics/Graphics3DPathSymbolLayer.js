// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Error ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DPathSymbolLayerConstants ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ../support/FastSymbolUpdates ../../support/ElevationProvider ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Path ../../webgl-engine/lib/PathBuilder ../../webgl-engine/lib/PathCapBuilder ../../webgl-engine/lib/PathExtruder ../../webgl-engine/lib/PathGeometry ../../webgl-engine/lib/PathGeometryData ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/lib/PathProfile ../../webgl-engine/lib/PathVertex ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(R,G,S,ma,na,T,U,V,W,X,Y,H,L,I,oa,pa,M,qa,Z,N,z,ra,sa,aa,ta,ua,va,v,J,w,ba,wa,ca,xa,ya,za){function da(t,x,l){const {origin:a,positions:b}=t;let c=t.offset;switch(x){default:case w.UpVectorAlignment.World:for(const h of t.vertices)e[0]=b[c++]+a[0],e[1]=b[c++]+a[1],e[2]=b[c++]+a[2],l.worldUpAtPosition(e,e),h.setFrameFromUpVector(e);break;case w.UpVectorAlignment.Path:e[0]=b[c]+a[0],e[1]=b[c+1]+a[1],e[2]=b[c+2]+a[2],l.worldUpAtPosition(e,e),wa.computeMinimumRotationTangentFrame(t,e)}}function ea(t,
x,l){switch(t){case "symbol-value":return l;case "proportional":return x;default:return t}}const Aa=["polyline"];S=function(t){function x(a,b,c,h){a=t.call(this,a,b,c,h)||this;a._intrinsicSize=V.fromValues(1,1);a._upVectorAlignment=w.UpVectorAlignment.Path;a._stencilWidth=.1;a.ensureDrapedStatus(!1);return a}G._inherits(x,t);var l=x.prototype;l.doLoad=async function(){var a=null!=this.symbolLayer.width?this.symbolLayer.width:this.symbolLayer.height;const b=null!=this.symbolLayer.height?this.symbolLayer.height:
a;this._vvConvertOptions=new z.ConvertOptions({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[a,1,b],this._context.renderCoordsHelper.unitInMeters);this._fastUpdates=0<this._context.renderer?.visualVariables?.length?z.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):null;var c=this.symbolLayer.anchor||"center";this._upVectorAlignment="heading"===this.symbolLayer.profileRotation?w.UpVectorAlignment.World:w.UpVectorAlignment.Path;var h=this.symbolLayer.profile||"circle";
switch(h){default:case "circle":this._profile=ca.circleProfiles[c];break;case "quad":this._profile=ca.quadProfiles[c]}switch(this.symbolLayer.join){case "round":this._extruder=new J.MiterExtruder(0,M.PATH_NUM_ROUND_JOIN_SUBDIVISIONS);break;case "bevel":this._extruder=new J.MiterExtruder(0,1);break;case "miter":this._extruder=new J.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new J.SimpleExtruder}c=this.symbolLayer.cap||"butt";switch(c){case "none":this._startCap=new v.NoCapBuilder;this._endCap=
new v.NoCapBuilder;break;default:this._startCap=new v.TriangulationCapBuilder(this._profile,0);this._endCap=new v.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new v.TriangulationCapBuilder(this._profile,-.5);this._endCap=new v.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":h="quad"===h,this._startCap=new v.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:h,subdivisions:M.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new v.RoundCapBuilder({profile:this._profile,
flip:!0,breakNormals:h,subdivisions:M.PATH_NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}var m=this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color);h=X.fromArray(m);m=m[3];const f=1>m||this.needsDrivenTransparentPass;c={diffuse:h,ambient:h,opacity:m,transparent:f,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:f||"none"===c?aa.CullFaceOptions.None:aa.CullFaceOptions.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&
(U.set(this._intrinsicSize,a,b),!Z.isValidSize(this._intrinsicSize[0])||!Z.isValidSize(this._intrinsicSize[1])))throw new ma("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates&&this._fastUpdates.visualVariables.size||U.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates?(a={...c,...this._fastUpdates.materialParameters,size:V.fromArray(this._intrinsicSize)},this._material=new za.PathMaterial(a)):
(c.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,c.normalType=sa.NormalType.Compressed,this._material=new ya.DefaultMaterial(c));this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(this._material)};l.destroy=function(){G._get(G._getPrototypeOf(x.prototype),"destroy",this).call(this);this._context.stage.remove(this._material);this._material=null};l.createGraphics3DGraphic=function(a){const b=a.graphic;
if(!this._validateGeometry(b.geometry,Aa,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(b,new oa.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,c,b.uid)};l.layerOpacityChanged=function(){const a=this._getCombinedOpacity(this.symbolLayer?.material?.color);this._material.setParameters({opacity:a,transparent:1>a||this.needsDrivenTransparentPass})};l.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,I.needsElevationUpdates3D)};
l.slicePlaneEnabledChanged=function(){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};l.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};l.applyRendererDiff=function(a,b){for(const c in a.diff)switch(c){case "visualVariables":if(z.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameters(this._fastUpdates.materialParameters);
else return N.ApplyRendererDiffResult.RecreateSymbol;break;default:return N.ApplyRendererDiffResult.RecreateSymbol}return N.ApplyRendererDiffResult.FastUpdate};l._getVertexData=function(a){let b=0;const c=a.paths,h=[],m=a.spatialReference,f=this._context.elevationProvider.spatialReference,p=this._context.renderCoordsHelper.spatialReference;for(var n of c)b+=n.length;n=L.newDoubleArray(3*b);let y=0;for(const C of c){h.push({offset:y,numVertices:C.length});for(const d of C)n[y++]=d[0],n[y++]=d[1],n[y++]=
a.hasZ?d[2]:0}if(null!=f&&!m.equals(f)&&!Y.projectBuffer(n,m,0,n,f,0,b))return null;null==f||f.equals(p)?a=L.doubleArrayFrom(n):(a=L.newDoubleArray(3*b),Y.projectBuffer(n,f,0,a,p,0,b));return{pathVertexDataInfos:h,vertexDataES:n,vertexDataRS:a}};l._createAs3DShape=function(a,b,c,h){var m=a.geometry;const f=this._getVertexData(m);if(null==f)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===f.pathVertexDataInfos.length)return 0!==
m.paths.length&&m.paths.some(u=>0<u.length)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;var p=[];m=m.spatialReference;const n=H.create(),y=this._context.renderCoordsHelper,C=new ra.SamplePosition(f.vertexDataES);for(const u of f.pathVertexDataInfos){var d=u.numVertices;if(2>d)continue;var q=u.offset;if(null!=this._context.clippingExtent&&(H.empty(n),H.expandWithBuffer(n,f.vertexDataES,q,d),!H.intersectsClippingArea(n,this._context.clippingExtent)))continue;
var k=[];d=q+3*d;for(var g=q;g<d;g+=3){C.offset=g;const O=I.evaluateElevationAlignmentAtPoint(C,this._context.elevationProvider,c,y);W.set(e,f.vertexDataRS[g],f.vertexDataRS[g+1],f.vertexDataRS[g+2]);y.setAltitude(e,O);f.vertexDataRS[g]=e[0];f.vertexDataRS[g+1]=e[1];f.vertexDataRS[g+2]=e[2];k.push(xa.newPathVertex(this._upVectorAlignment))}q=new ua.Path(k,f.vertexDataES,f.vertexDataRS,q);da(q,this._upVectorAlignment,this._context.renderCoordsHelper);q=new va.PathBuilder(q,this._profile,this._extruder,
this._startCap,this._endCap);k=null;this._fastUpdates?(g=this._fastUpdates.visualVariables,k=z.getAttributeValue(g.size?.field,a)??0,d=z.getAttributeValue(g.color?.field,a)??0,g=z.getAttributeValue(g.opacity?.field,a)??0,k=new ba.FastUpdatePathGeometry(q,k,d,g)):(k=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(d=b.size,k[0]*=ea(d[0],"symbol-value"===d[2]?this.symbolLayer.height||0:d[2],this.symbolLayer.width||0),k[1]*=ea(d[2],"symbol-value"===d[0]?this.symbolLayer.width||
0:d[0],this.symbolLayer.height||0)),d=void 0,this._drivenProperties.color&&(d=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(d=d?[d[0],d[1],d[2],b.opacity]:[1,1,1,b.opacity]),g=new ba.StaticPathGeometry(q),g.bake(k),d&&g.bakeVertexColors(d),k=g);const {vertexAttributes:D,indices:E}=k.createGeometryData();d=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid});k=new w.PathGeometry(this._material,D,E,k,m,this._stencilWidth,d);k.transformation=
na.translate(T.create(),T.IDENTITY,q.path.origin);p.push(k)}if(0===p.length)return null;a=new ta.Object3D({geometries:p,layerUid:this._context.layer.uid,graphicUid:h});p=new pa.Graphics3DObject3DGraphicLayer(this,a,p,null,null,(u,D,E,O,fa)=>{D=this._upVectorAlignment;u=u.stageObject;E=u.geometries;var ha=0;for(const F of E){if(!w.isPathGeometry(F))continue;const ia=F.path,ja=ia.builder.path;var K=ja,Ba=O,Ca=fa;let ka=0;const {origin:A,vertices:la,positions:B,positionsES:P}=K,Da=K.offset+3*la.length;
for(let r=K.offset;r<Da;r+=3)W.set(e,P[r],P[r+1],P[r+2]),Ba(e,Q),ka+=Q.sampledElevation,e[0]=B[r]+A[0],e[1]=B[r+1]+A[1],e[2]=B[r+2]+A[2],Ca.setAltitude(e,Q.z),B[r]=e[0]-A[0],B[r+1]=e[1]-A[1],B[r+2]=e[2]-A[2];K.updatePathVertexInformation();ha+=ka/la.length;D!==w.UpVectorAlignment.World&&da(ja,D,fa);ia.onPathChanged(F);F.invalidateBoundingInfo();u.geometryVertexAttrsUpdated(F)}return ha/E.length},c);p.alignedSampledElevation=0;p.needsElevationUpdates=I.needsElevationUpdates3D(c.mode);return p};return G._createClass(x)}(qa.Graphics3DSymbolLayer);
const e=X.create(),Q=new I.SampleElevationInfo;R.Graphics3DPathSymbolLayer=S;Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/mathUtils ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/aaBoundingRect ../../../../chunks/boundedPlane ../../../../geometry/support/ray ../../../../chunks/sphere ./deconflictorDebug ./enums ../../webgl-engine/lib/Camera ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/ScaleInfo".split(" "),
function(l,p,A,N,F,G,H,I,ja,ka,O,P,Q,R,v,t,x,J,S,q,B,T,z,C,u,U,V,K,W,X){function*L(g){if(Map.prototype.entries){g=g.entries();for(let k=g.next();!k.done;k=g.next())yield k.value[1]}else yield*g.values()}function*Y(g,k,h){k.clear();g.forEach((c,b)=>{const d=k.pushNew();d.id=b;d.visible=c.graphics3DGraphic.getVisibilityFlag(h,u.VisibilityFlag.DECONFLICTION);b=c.info&&c.info[h];d.prio=c.graphics3DGraphic.deconflictionPriority;d.distance=b?b.distance:Number.MAX_VALUE});yield;const a=k.iterableSort((c,
b)=>c.prio!==b.prio?b.prio-c.prio:c.distance!==b.distance?c.distance-b.distance:c.visible!==b.visible?c.visible?-1:1:c.id-b.id);for(let c=a.next();!c.done;c=a.next())yield;k.forAll(c=>{const b=g.get(c.id);b&&(g.delete(c.id),g.set(c.id,b))});k.clear()}const n=t.create(),w=J.create(),y=J.create(),D=t.create(),Z=Q.create(),aa=z.create(),E=T.create(),ba=t.create(),ca=q.create();let da=p._createClass(function(){this.aabr=q.create();this.distance=0;this.visible=this.culled=!1});I=p._createClass(function(g,
k){this.graphics3DGraphic=g;this.slicePlaneEnabled=k;this.info={}});l.State=void 0;(function(g){g[g.Idle=0]="Idle";g[g.Process=1]="Process";g[g.Sort=2]="Sort";g[g.Deconflict=3]="Deconflict";g[g.NumStates=4]="NumStates"})(l.State||(l.State={}));let M=function(){function g(){this.camera=new U.Camera;this.slicePlane=B.create();this.slicePlaneEnabled=!1}g.prototype.copyFrom=function(k){this.camera.copyFrom(k.camera);B.copy(k.slicePlane,this.slicePlane);this.slicePlaneEnabled=k.slicePlaneEnabled};return p._createClass(g)}();
l.Deconflictor=function(g){function k(a){a=g.call(this,a)||this;a._dirty=!1;a._runningViewState=new M;a._state=l.State.Idle;a._active=new Map;a._visible=new Map;a._iterators=new ea;a._accBinsNumX=15;a._accBinsNumY=20;a._accBinsSizeX=0;a._accBinsSizeY=0;a._accBins=null;a.accNumTests=0;return a}p._inherits(k,g);var h=k.prototype;h.destroy=function(){this._active.clear();this._visible.clear();this._iterators=null};h.setDirty=function(){!this._dirty&&0<this._active.size&&(this._dirty=!0,this.notifyChange("updating"))};
h.runTask=function(a){switch(this._state){case l.State.Idle:this._startUpdate(),a.madeProgress();case l.State.Process:if(this._state=l.State.Process,!this._processActiveGraphics(a))break;case l.State.Sort:if(this._state=l.State.Sort,!this._sortVisibleGraphics(a))break;case l.State.Deconflict:if(this._state=l.State.Deconflict,!this._deconflictVisibleGraphics(a))break;default:C.drawAccelerationStruct(this,this._visible),this._state=l.State.Idle,this.notifyChange("updating")}};h.modifyGraphics=function(a,
c){c?a.forEach(b=>this.addToActiveGraphics(b)):a.forEach(b=>this.removeFromActiveGraphics(b));this.setDirty()};h.layerSupportsDeconfliction=function(a){if(null==a||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.geometries.length:0)&&a?.geometries[0]?.material instanceof W.HUDMaterial?!0:!1};h._startUpdate=function(){C.prepare(this.view);this._dirty=!1;this._runningViewState.copyFrom(this.viewState);const {fullWidth:a,fullHeight:c}=this._runningViewState.camera;this._initBins(a,c);this._resetIterators()};
h.addToActiveGraphics=function(a){a.info[this.visibilityGroup]=new da;this._active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()};h.removeFromActiveGraphics=function(a){this._visible.delete(a.graphics3DGraphic.graphic.uid);const c=a.graphics3DGraphic;c.destroyed||c.setVisibilityFlag(this.visibilityGroup,u.VisibilityFlag.DECONFLICTION,!0);delete a.info[this.visibilityGroup];this._active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()};h._processActiveGraphics=function(a){const c=this._ensureActiveGraphicsIterator(),
b=P.invertOrIdentity(Z,this._runningViewState.camera.projectionMatrix),d="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&0<this._runningViewState.camera.relativeElevation?aa:null;let f=0;null!=d&&(v.transformMat4(d,t.ZEROS,this._runningViewState.camera.viewMatrix),d[3]=S.getReferenceEllipsoid(this.view.spatialReference).radius,f=z.distanceToSilhouette(d,t.ZEROS));for(;!a.done;){a.madeProgress();var e=c.next();if(!0===e.done)return this._resetActiveGraphicsIterator(),!0;const m=
(e=e.value)&&e.info[this.visibilityGroup];m&&(this._collectGraphics3DGraphics(e,b,d,f),m.culled?this._visible.delete(e.graphics3DGraphic.graphic.uid):this._visible.set(e.graphics3DGraphic.graphic.uid,e))}return!1};h._sortVisibleGraphics=function(a){const c=this._ensureSortGraphicsIterator();for(;!a.done;){const b=c.next();a.madeProgress();if(!0===b.done)return this._resetSortGraphicsIterator(),!0}return!1};h._deconflictVisibleGraphics=function(a){const c=this._ensureVisibleGraphicsIterator(),b=this.visibilityGroup===
u.VisibilityGroup.LABEL;for(;!a.done;){a.madeProgress();var d=c.next();if(!0===d.done)return this._resetVisibleGraphicsIterator(),!0;d=d.value;const e=d.info[this.visibilityGroup];if(e&&!e.culled){var f=d.graphics3DGraphic;f=!b||f.isVisible();e.visible=f&&!this._isConflicted(d);e.visible&&this._addToBins(d);this._setGraphicVisibility(d,e.visible);C.drawPoly(e,e.visible)}}return!1};h._resetIterators=function(){this._iterators.active=null;this._iterators.visible=null;this._iterators.sort=null};h._ensureActiveGraphicsIterator=
function(){this._iterators.active||(this._iterators.active=L(this._active));return this._iterators.active};h._resetActiveGraphicsIterator=function(){this._iterators.active=null};h._ensureVisibleGraphicsIterator=function(){this._iterators.visible||(this._iterators.visible=L(this._visible));return this._iterators.visible};h._resetVisibleGraphicsIterator=function(){this._iterators.visible=null};h._ensureSortGraphicsIterator=function(){this._iterators.sort||(this._iterators.sort=Y(this._visible,this._iterators.sortArray,
this.visibilityGroup));return this._iterators.sort};h._resetSortGraphicsIterator=function(){this._iterators.sort=null};h._collectGraphics3DGraphics=function(a,c,b,d){var f=a.graphics3DGraphic;if(!f.destroyed){var e=a.info[this.visibilityGroup];if(f.isVisible(u.VisibilityGroup.GRAPHIC,u.VisibilityFlag.DECONFLICTION)){var m=this.getGraphicsLayers(f);q.empty(e.aabr);f=null;for(const r of m)if(this.layerSupportsDeconfliction(r)){m=r.stageObject.geometries[0].material;if(null==f&&(f=fa,this._getProjectionInfo(r,
c,f),f.isOutsideScreen||this._isCulledBySlice(a,n)||null!=b&&this._isCulledByHorizon(f,b,d))){e.culled=!0;return}this._expandBoundingRect(e,r,m,f)}null==f?e.culled=!0:(e.distance=f.distance,e.culled=!1)}else e.culled=!0}};h._getProjectionInfo=function(a,c,b){const d=this._runningViewState.camera;a=a.stageObject;var f=a.geometries[0];const e=f.material;var m=z.getCenter(a.boundingVolumeWorldSpace.bounds);v.transformMat4(n,m,d.viewMatrix);m=f.vertexAttributes;f=m.get(K.VertexAttribute.NORMAL).data;
m=m.get(K.VertexAttribute.AUXPOS1).data;e.applyShaderOffsetsView(n,f,a.transformation,m,d,b.scaleInfo,n);x.set(w,n[0],n[1],n[2],1);x.transformMat4(y,w,d.projectionMatrix);v.scale(b.positionNDC,y,1/y[3]);e.applyShaderOffsetsNDC(b.positionNDC,m,d,b.positionNDC,D);b.distanceWithoutPolygonOffset=d.depthNDCToWorld(D[2]);b.distance=D[2]===b.positionNDC[2]?b.distanceWithoutPolygonOffset:d.depthNDCToWorld(b.positionNDC[2]);x.set(y,b.positionNDC[0],b.positionNDC[1],b.positionNDC[2],1);x.transformMat4(w,y,
c);x.scale(w,w,1/w[3]);v.set(b.positionView,n[0],n[1],n[2])};h._isCulledByHorizon=function(a,c,b){v.copy(E.direction,a.positionView);v.set(E.origin,0,0,0);return z.intersectRay(c,E,ba)?a.distanceWithoutPolygonOffset>b:!1};h._isCulledBySlice=function(a,c){return a.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&B.extrusionContainsPoint(this._runningViewState.slicePlane,c)};h._expandBoundingRect=function(a,c,b,{positionNDC:d,scaleInfo:f}){const e=this._runningViewState.camera;c=c.getScreenSize(ha);
V.applyPrecomputedScaleFactor(c,f.factor,c);c[0]*=e.pixelRatio;c[1]*=e.pixelRatio;b=q.offset(b.calculateRelativeScreenBounds(c,f.factorAlignment.scale,ca),F.lerp(0,e.fullWidth,.5+.5*d[0]),F.lerp(0,e.fullHeight,.5+.5*d[1]));d=this.iconMarginFactor;0!==d&&(d*=Math.min(q.width(b),q.height(b)),b[0]-=d,b[1]-=d,b[2]+=d,b[3]+=d);q.expand(a.aabr,b,a.aabr)};h._isConflicted=function(a){const c=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];for(let b=Math.floor(a.aabr[0]/this._accBinsSizeX);b<=
Math.floor(a.aabr[2]/this._accBinsSizeX);b++)if(!(0>b||b>=this._accBinsNumX))for(let d=Math.floor(a.aabr[1]/this._accBinsSizeY);d<=Math.floor(a.aabr[3]/this._accBinsSizeY);d++){if(0>d||d>=this._accBinsNumY)continue;const f=this._accBins[b][d];for(let e=0;e<f.length;e++){const m=f.data[e],r=m.info[this.visibilityGroup];if(r&&r.visible&&m.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,q.intersects(r.aabr,a.aabr)))return!0}}return!1};h._initBins=function(a,c){if(null==this._accBins){this._accBins=
[];for(var b=0;b<this._accBinsNumX;b++){this._accBins.push([]);var d=this._accBins[this._accBins.length-1];for(let f=0;f<this._accBinsNumY;f++)d.push(new G)}}else for(b=0;b<this._accBinsNumX;b++)for(d=0;d<this._accBinsNumY;d++)this._accBins[b][d].clear();this._accBinsSizeX=a/this._accBinsNumX;this._accBinsSizeY=c/this._accBinsNumY;this.accNumTests=0};h._addToBins=function(a){var c=a.info[this.visibilityGroup],b=Math.floor(c.aabr[0]/this._accBinsSizeX);const d=Math.floor(c.aabr[2]/this._accBinsSizeX),
f=Math.floor(c.aabr[1]/this._accBinsSizeY);for(c=Math.floor(c.aabr[3]/this._accBinsSizeY);b<=d;b++)if(!(0>b||b>=this._accBinsNumX))for(let e=f;e<=c;e++)0>e||e>=this._accBinsNumY||this._accBins[b][e].push(a)};h._setGraphicVisibility=function(a,c){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(this.visibilityGroup,u.VisibilityFlag.DECONFLICTION,c),this.visibilityGroup===u.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(a,c))};p._createClass(k,[{key:"dirty",get:function(){return this._dirty}},
{key:"state",get:function(){return this._state}},{key:"updating",get:function(){return this._state!==l.State.Idle||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;const a=this._state/l.State.NumStates;return this._dirty?.5*a:a}},{key:"running",get:function(){return this.view.ready&&null!=this.view.state&&this.updating}}]);return k}(N);A.__decorate([H.property({constructOnly:!0})],l.Deconflictor.prototype,"view",void 0);A.__decorate([H.property({type:Boolean,readOnly:!0})],
l.Deconflictor.prototype,"updating",null);l.Deconflictor=A.__decorate([O.subclass("esri.views.3d.layers.graphics.Deconflictor")],l.Deconflictor);let ia=p._createClass(function(){this.id=0;this.visible=!1;this.distance=this.prio=0}),ea=p._createClass(function(g=null,k=null,h=null){this.active=g;this.visible=k;this.sort=h;this.sortArray=new G({allocator:a=>a||new ia})});const ha=R.create(),fa=new (function(){function g(){this.positionView=t.create();this.positionNDC=t.create();this.distanceWithoutPolygonOffset=
this.distance=0;this.scaleInfo=new X.ScaleInfo}p._createClass(g,[{key:"isOutsideScreen",get:function(){const k=this.positionNDC;return-1>k[0]||-1>k[1]||-1>k[2]||1<=k[0]||1<=k[1]}}]);return g}());l.DeconflictorGraphic=I;l.DeconflictorViewState=M;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2f64 ../../../../symbols/callouts/calloutUtils ./CreateLabelParameters ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DObjectMetadata ./Graphics3DSymbolLayer ./graphicUtils ./placementUtils ./pointUtils ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureFactory ../../webgl-engine/materials/HUDMaterial".split(" "),
function(A,q,F,G,H,u,B,I,J,x,K,L,M,y,N,r,v,O,P,Q,C){function D(m,k,f){m&&m.forEach(a=>{const b=k(a);null!=b&&f(b,a.graphic)})}function R(m,k){if("baseline"===k.verticalPlacement)return u.fromValues(r.horizontalPlacementToAnchorX[k.horizontalPlacement],null!=m?m.baselineAnchorY:0);m=r.anchorFromPlacements(k.horizontalPlacement,k.verticalPlacement);return r.namedAnchorToHUDMaterialAnchorPos[m]}const S=[0,0,1];y=function(m){function k(a,b,d,c){a=m.call(this,a,b,d,c)||this;a._elevationOptions={supportsOffsetAdjustment:!0,
supportsOnTheGround:!1};a.ensureDrapedStatus(!1);return a}q._inherits(k,m);var f=k.prototype;f.doLoad=async function(){if(!this._drivenProperties.size){const a=N.validateSymbolLayerSize(this.symbolLayer.size);if(a)throw new F("graphics3dtextsymbollayer:invalid-size",a);}await this._createTextRenderParameters()};f._createTextRenderParameters=async function(){this._textRenderParameters=await P.TextRenderParameters.fromSymbol(this.symbolLayer,this._context.graphicsCoreOwner.view.state.rasterPixelRatio)};
f.destroy=function(){q._get(q._getPrototypeOf(k.prototype),"destroy",this).call(this)};f.createGraphics3DGraphic=function(a){a=a.graphic;const b=v.placePointOnGeometry(a.geometry);if(null==b)return this.logger.warn(`unsupported geometry type for text symbol: ${a.geometry.type}`),null;const d=this.symbolLayer.text;if(null==d||""===d)return null;var c=B.hasCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=c&&!B.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' "+
`horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;c=new I.CreateLabelParameters(c,this.symbolLayer.horizontalAlignment,r.verticalPlacementFromAlignment(this.symbolLayer.verticalAlignment));return this._createAs3DShape(a,b,d,c)};f.createLabel=function(a,b,d,c){a=a.graphic;const g=v.placePointOnGeometry(a.geometry);if(null==g)return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const h=b.text;return!h||/^\s+$/.test(h)?null:
this._createAs3DShape(a,g,h,b,d,c)};f.setGraphicElevationContext=function(a,b,d=0){a=q._get(q._getPrototypeOf(k.prototype),"setGraphicElevationContext",this).call(this,a,b);a.addOffsetRenderUnits(d);return a};f.layerOpacityChanged=function(){this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");return!1};f.layerElevationInfoChanged=function(a,b){D(a,b,(d,c)=>{this.updateGraphicElevationContext(c,d)});return x.SymbolUpdateType.UPDATE};f.slicePlaneEnabledChanged=
function(a,b){D(a,b,d=>{for(const c of d.stageObject.geometries)c.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0};f.physicalBasedRenderingChanged=function(){return!0};f.updateGraphicElevationContext=function(a,b){const d=b.elevationContext;this.setGraphicElevationContext(a,d,null!=b.metadata?b.metadata.elevationOffset:0);b.needsElevationUpdates=x.needsElevationUpdates2D(d.mode)||"absolute-height"===d.mode};f._defaultElevationInfoNoZ=function(){return T};f._createAs3DShape=
function(a,b,d,c,g,h){const w=this.setGraphicElevationContext(a,new K.ElevationContext,c.elevationOffset);var n="polyline"===a.geometry?.type,t=a.uid;let p=null;a=null;if(null==h){var e=r.textRenderAlignmentFromHorizontalPlacement(c.horizontalPlacement);p=new Q(d,e,this._textRenderParameters);let l=null;if(null!=this._context.sharedResources.textures){a=this._context.sharedResources.textures.fromData(p.key,()=>p.create(),()=>{null!=l&&l.release()});e=this._context.stage.renderView.textureRepository.acquire(a.texture.id);
if(null==e||G.isPromiseLike(e))return a.release(),null;l=e}}e=R(p,c);e={occlusionTest:!0,screenOffset:c.screenOffset,anchorPosition:e,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:c.centerOffsetUnits,drawInSecondSlot:!0};null!=h?e.textureId=h.id:null!=a&&(e.textureId=a.texture.id);if(null!=c.verticalOffset){const {screenLength:l,minWorldLength:z,maxWorldLength:E}=c.verticalOffset;e.verticalOffset={screenLength:H.pt2px(l),minWorldLength:z||0,maxWorldLength:null!=E?E:Infinity}}if(this._context.screenSizePerspectiveEnabled){const {screenSizePerspectiveSettings:l,
screenSizePerspectiveSettingsLabels:z}=this._context.sharedResources;e.screenSizePerspective=z.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]);e.screenSizePerspectiveAlignment=l}n&&(e.shaderPolygonOffset=1E-4);e.hasSlicePlane=this._context.slicePlaneEnabled;null!=g?(n=JSON.stringify(e),h=g.get(n),null==h&&(h=new C.HUDMaterial(e),g.add(n,h))):h=new C.HUDMaterial(e);n=c.translation;e=p?u.fromValues(p.displayWidth,p.displayHeight):u.ZEROS;
n=O.createPointGeometry(h,S,n,null,e,c.centerOffset,[0,0],null);t=v.createStageObject(this._context,b,n,w,t);if(null==t)return null;g=new L.Graphics3DObject3DGraphicLayer(this,t.object,[n],null==g?[h]:null,a,J.perObjectElevationAligner,w);g.alignedSampledElevation=t.sampledElevation;g.needsElevationUpdates=x.needsElevationUpdates2D(w.mode)||"absolute-height"===w.mode;const {displayWidth:U,displayHeight:V}=null!=p?p:c;g.getScreenSize=(l=u.create())=>{l[0]=U;l[1]=V;return l};d=new M.Graphics3DObjectMetadata(c.elevationOffset,
d);g.metadata=d;v.extendPointGraphicElevationContext(g,b,this._context.elevationProvider);return g};q._createClass(k,[{key:"pixelRatioChanged",get:function(){return!1}}]);return k}(y.Graphics3DSymbolLayer);const T={mode:"relative-to-ground",offset:0};A.Graphics3DTextSymbolLayer=y;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
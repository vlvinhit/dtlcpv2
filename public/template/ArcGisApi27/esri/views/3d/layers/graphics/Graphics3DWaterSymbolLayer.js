// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/unitUtils ../../../../chunks/earcut ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec4 ../../../../chunks/common ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/DoubleArray ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./polygonUtils ../../support/renderInfoUtils/polygon ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/WaterMaterial ../../webgl-engine/materials/internal/waterMaterialUtils".split(" "),
function(A,h,F,G,B,H,v,I,J,k,y,w,K,p,L,M,N,u,r,C,O,P,D,Q){const R=["polyline","polygon","extent"];u=function(l){function g(a,b,c,f){return l.call(this,a,b,c,f)||this}h._inherits(g,l);var e=g.prototype;e.doLoad=async function(){};e.destroy=function(){h._get(h._getPrototypeOf(g.prototype),"destroy",this).call(this);this._context.stage.remove(this._material);this._material=null};e.createGraphics3DGraphic=function(a){a=a.graphic;if(!this._validateGeometry(a.geometry,R,this.symbolLayer.type))return null;
const b=this.setGraphicElevationContext(a,new L.ElevationContext);this.ensureDrapedStatus("on-the-ground"===b.mode);this.ensureMaterial();return this.draped?this._createAsOverlay(a):this._createAs3DShape(a,b,a.uid)};e.ensureMaterial=function(){if(null==this._material){var a=new D.WaterMaterialParameters,b=this.symbolLayer.color;null!=b&&(a.color=F.toUnitRGBA(b));b=this._getCombinedOpacity(b,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],b];a.transparent=1>b||this.needsDrivenTransparentPass;
a.waveDirection=null!=this.symbolLayer.waveDirection?g.headingVectorFromAngle(this.symbolLayer.waveDirection):v.fromValues(0,0);b=Q.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=b.waveStrength;a.waveTextureRepeat=b.textureRepeat;a.waveVelocity=b.waveVelocity;a.flowStrength=b.perturbationStrength;a.hasSlicePlane=this._context.slicePlaneEnabled;a.isDraped=this.draped;this._material=new D.WaterMaterial(a);this._context.stage.add(this._material)}};e.layerOpacityChanged=
function(){if(null!=this._material){var a=this._material.parameters.color,b=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._material.setParameters({color:[a[0],a[1],a[2],b],transparent:1>b||this.needsDrivenTransparentPass})}};e.layerElevationInfoChanged=function(a,b,c){const f=this._elevationContext.mode;c=p.elevationModeChangeUpdateType(g.elevationModeChangeTypes,c,f);if(c!==p.SymbolUpdateType.UPDATE)return c;const d=p.needsElevationUpdates2D(f);return this.updateGraphics3DGraphicElevationInfo(a,
b,()=>d)};e.slicePlaneEnabledChanged=function(){null!=this._material&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};e.physicalBasedRenderingChanged=function(){return!0};e._createAs3DShape=function(a,b,c){const f=r.geometryAsPolygon(a.geometry);if(null==f)return null;const d=C.geometryToRenderInfo(f,this._context.elevationProvider,this._context.renderCoordsHelper,b),t=d.position.length/3,m=w.newDoubleArray(2*t);this._createUVCoordsFromVertices(m,d.mapPositions,
t,this._context.elevationProvider.spatialReference);a=new S(d,m,this._context.layer.uid,a.uid);a.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a);this._create3DShapeGeometries(a);this._logGeometryCreationWarnings(a.renderData,f.rings,"rings","WaterSymbol3DLayer");if(0===a.outGeometries.length)return null;c=new O.Object3D({geometries:a.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:c});c=new N.Graphics3DObject3DGraphicLayer(this,c,a.outGeometries,
null,null,K.perVertexElevationAligner,b);c.alignedSampledElevation=a.renderData.sampledElevation;c.needsElevationUpdates=p.needsElevationUpdates2D(b.mode);return c};e._createUVCoordsFromVertices=function(a,b,c,f){f=G.getMetersPerUnitForSR(f);y.empty(n);for(var d=0;d<c;d++)H.set(E,b[3*d],b[3*d+1]),y.expandPointInPlace(n,E);I.scale(n,n,f);d=n[1]%g.unitSizeOfTexture;x[0]=n[0]-n[0]%g.unitSizeOfTexture;x[1]=n[1]-d;for(d=0;d<c;d++)a[2*d]=(b[3*d]*f-x[0])/g.unitSizeOfTexture,a[2*d+1]=(b[3*d+1]*f-x[1])/g.unitSizeOfTexture};
e._create3DShapeGeometries=function(a){var b=a.renderData.polygons;const c=a.uvCoords;for(const {count:f,index:d,position:t,mapPositions:m,holeIndices:z}of b){if(null!=this._context.clippingExtent&&(k.empty(q),k.expandWithBuffer(q,m),!k.intersectsClippingArea(q,this._context.clippingExtent)))continue;b=B.earcut(m,z,3);if(0===b.length)continue;const T=w.doubleSubArray(c,2*d,2*f);b=r.createWaterGeometry({material:this._material,indices:b,mapPositions:m,attributeData:{position:t,uv0:T}},a.objectAndLayerIdColor);
a.outGeometries.push(b)}};e._createAsOverlay=function(a){const b=r.geometryAsPolygon(a.geometry);if(null==b)return null;this._material.renderPriority=this._renderPriority;const c=C.geometryToRenderInfoDraped(b,this._context.overlaySR),f=c.position.length/3,d=w.newDoubleArray(2*f);this._createUVCoordsFromVertices(d,c.position,f,this._context.overlaySR);a=new U(c,d,this._context.layer.uid,a.uid);a.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a);a.outBoundingBox=k.empty();
this._createAsOverlayWater(a);this._logGeometryCreationWarnings(a.renderData,b.rings,"rings","WaterSymbol3DLayer");return 0===a.outGeometries.length?null:new M(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)};e._createAsOverlayWater=function(a){const b=a.uvCoords;var c=a.renderData.polygons;for(const {position:f,holeIndices:d,index:t,count:m}of c){k.empty(q);k.expandWithBuffer(q,f);if(!k.intersectsClippingArea(q,this._context.clippingExtent))continue;k.expandWithAABB(a.outBoundingBox,
q);c=B.earcut(f,d,3);if(0===c.length)continue;const z=w.doubleSubArray(b,2*t,2*m);c=r.createWaterGeometry({material:this._material,indices:c,attributeData:{position:f,uv0:z}},a.objectAndLayerIdColor);a.outGeometries.push(new P.RenderGeometry(c,a))}};g.headingVectorFromAngle=function(a){const b=v.create();a=J.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};e.test=function(){return{...h._get(h._getPrototypeOf(g.prototype),"test",this).call(this),create3DShape:a=>this._createAs3DShape(a.graphic,
a.elevationContext,a.graphicUid),ensureMaterial:()=>this.ensureMaterial()}};return h._createClass(g)}(u.Graphics3DSymbolLayer);u.unitSizeOfTexture=100;u.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};const x=v.create(),n=y.create(),E=v.create(),q=k.create();let S=function(l){function g(e,a,b,c){e=l.call(this,e,b,c)||this;e.uvCoords=a;return e}h._inherits(g,l);return h._createClass(g)}(r.PolygonCreationDataBase),
U=function(l){function g(e,a,b,c){e=l.call(this,e,b,c)||this;e.uvCoords=a;return e}h._inherits(g,l);return h._createClass(g)}(r.PolygonCreationDataBase);A.Graphics3DWaterSymbolLayer=u;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});
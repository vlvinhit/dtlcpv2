// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/devEnvironmentUtils ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../chunks/vec42 ../../../../chunks/vec22 ../../../../chunks/vec33 ../../../../chunks/vec43 ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ProcessedObjectResource ./wosrLoader ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../webgl-engine/materials/pbrUtils".split(" "),
function(L,ba,V,ca,da,ea,A,Q,R,M,D,N,S,fa,ha,ia,ja,ka,la,T,H,ma,W,X,I,E,na,oa,z,U,G,O){function Y(g){const c=g.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return c?{fileType:"gltf",url:c[1],specifiedLodIndex:null!=c[4]?Number(c[4]):null}:g.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:g,specifiedLodIndex:null}:{fileType:"unknown",url:g,specifiedLodIndex:null}}function Z(g,c,k,t){const B=g.model,y=[],f=new Map,u=new Map,a=B.lods.length,h=R.empty();B.lods.forEach((v,l)=>{const m=!0===t.skipHighLods&&
(1<a&&0===l||3<a&&1===l)||!1===t.skipHighLods&&null!=t.singleLodIndex&&l!==t.singleLodIndex;if(!m||0===l){var p=new ma.ProcessedObjectResource(v.name,v.lodThreshold,[0,0,0]);v.parts.forEach(b=>{const e=m?new U.DefaultMaterial({}):pa(B,b,p,c,k,f,u);var C=null!=e?e:new U.DefaultMaterial({});const q=b.attributes.position.count,r=la.convertPrimitiveToTriangles(b.indices||q,b.primitiveType);var n=M.newFloatArray(3*q);const {typedBuffer:w,typedBufferStride:F}=b.attributes.position;N.transformMat4(n,w,b.transform,
3,F);n=[[z.VertexAttribute.POSITION,new I.Attribute(n,3,!0)]];const x=[[z.VertexAttribute.POSITION,r]];if(null!=b.attributes.normal){var d=M.newFloatArray(3*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.normal;V.normalFromMat4(P,b.transform);N.transformMat3(d,J,P,3,K);n.push([z.VertexAttribute.NORMAL,new I.Attribute(d,3,!0)]);x.push([z.VertexAttribute.NORMAL,r])}if(null!=b.attributes.tangent){d=M.newFloatArray(4*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.tangent;V.normalFromMat4(P,
b.transform);S.transformMat3(d,J,P,4,K);n.push([z.VertexAttribute.TANGENT,new I.Attribute(d,4,!0)]);x.push([z.VertexAttribute.TANGENT,r])}if(null!=b.attributes.texCoord0){d=M.newFloatArray(2*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.texCoord0;fa.normalizeIntegerBuffer(d,J,2,K);n.push([z.VertexAttribute.UV0,new I.Attribute(d,2,!0)]);x.push([z.VertexAttribute.UV0,r])}null!=b.attributes.color&&(d=new Uint8Array(4*q),4===b.attributes.color.elementCount?b.attributes.color instanceof D.BufferViewVec4f?
S.scale(d,b.attributes.color,255):b.attributes.color instanceof D.BufferViewVec4u8?ia.copy(d,b.attributes.color):b.attributes.color instanceof D.BufferViewVec4u16&&S.scale(d,b.attributes.color,1/256):(d.fill(255),b.attributes.color instanceof D.BufferViewVec3f?N.scale(d,b.attributes.color,255,4):b.attributes.color instanceof D.BufferViewVec3u8?ha.copy(d,b.attributes.color.typedBuffer,4,b.attributes.color.typedBufferStride):b.attributes.color instanceof D.BufferViewVec3u16&&N.scale(d,b.attributes.color,
1/256,4)),n.push([z.VertexAttribute.COLOR,new I.Attribute(d,4,!0)]),x.push([z.VertexAttribute.COLOR,r]));b={geometry:new na.Geometry(C,n,x),vertexCount:q};const {geometry:aa,vertexCount:qa}=b;b=aa.boundingInfo;null!=b&&0===l&&(R.expandWithVec3(h,b.bbMin),R.expandWithVec3(h,b.bbMax));null!=e&&(p.stageResources.geometries.push(aa),p.numberOfVertices+=qa)});m||y.push(p)}});return{engineResources:y,referenceBoundingBox:h}}function pa(g,c,k,t,B,y,f){const u=c.material+(c.attributes.normal?"_normal":"")+
(c.attributes.color?"_color":"")+(c.attributes.texCoord0?"_texCoord0":"")+(c.attributes.tangent?"_tangent":""),a=g.materials.get(c.material);var h=null!=c.attributes.texCoord0;const v=null!=c.attributes.normal;if(null==a)return null;a:{switch(a.alphaMode){case "BLEND":var l=E.AlphaDiscardMode.Blend;break a;case "MASK":l=E.AlphaDiscardMode.Mask;break a;case "OPAQUE":case null:case void 0:l=E.AlphaDiscardMode.Opaque;break a}l=void 0}if(!y.has(u)){if(h){var m=(w,F=!1)=>{if(null!=w&&!f.has(w)){const x=
g.textures.get(w);if(null!=x){const d=x.data;f.set(w,new oa.Texture(T.isEncodedMeshTexture(d)?d.data:d,{...x.parameters,preMultiplyAlpha:T.isEncodedMeshTexture(d)?!1:F,encoding:T.isEncodedMeshTexture(d)&&null!=d.encoding?d.encoding:void 0}))}}};m(a.textureColor,l!==E.AlphaDiscardMode.Opaque);m(a.textureNormal);m(a.textureOcclusion);m(a.textureEmissive);m(a.textureMetallicRoughness)}m=a.color[0]**(1/G.COLOR_GAMMA);const p=a.color[1]**(1/G.COLOR_GAMMA),b=a.color[2]**(1/G.COLOR_GAMMA),e=a.emissiveFactor[0]**
(1/G.COLOR_GAMMA),C=a.emissiveFactor[1]**(1/G.COLOR_GAMMA),q=a.emissiveFactor[2]**(1/G.COLOR_GAMMA),r=null!=a.textureColor&&h?f.get(a.textureColor):null,n=O.useSchematicPBR({normalTexture:a.textureNormal,metallicRoughnessTexture:a.textureMetallicRoughness,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion});y.set(u,new U.DefaultMaterial({...t,transparent:l===E.AlphaDiscardMode.Blend,
customDepthTest:E.DepthTestFunction.Lequal,textureAlphaMode:l,textureAlphaCutoff:a.alphaCutoff,diffuse:[m,p,b],ambient:[m,p,b],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?E.CullFaceOptions.None:E.CullFaceOptions.Back,hasVertexColors:!!c.attributes.color,hasVertexTangents:!!c.attributes.tangent,normalType:v?X.NormalType.Attribute:X.NormalType.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:null!=r?r.id:void 0,colorMixMode:a.colorMixMode,
normalTextureId:null!=a.textureNormal&&h?f.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:null!=r&&!!r.parameters.preMultiplyAlpha,occlusionTextureId:null!=a.textureOcclusion&&h?f.get(a.textureOcclusion).id:void 0,emissiveTextureId:null!=a.textureEmissive&&h?f.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=a.textureMetallicRoughness&&h?f.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[e,C,q],mrrFactors:n?[...O.defaultSchematicMRRFactors]:[a.metallicFactor,a.roughnessFactor,
t.mrrFactors[2]],isSchematic:n,colorTextureTransformMatrix:H.getTransformMatrix(a.colorTextureTransform),normalTextureTransformMatrix:H.getTransformMatrix(a.normalTextureTransform),occlusionTextureTransformMatrix:H.getTransformMatrix(a.occlusionTextureTransform),emissiveTextureTransformMatrix:H.getTransformMatrix(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:H.getTransformMatrix(a.metallicRoughnessTextureTransform),...B}))}c=y.get(u);k.stageResources.materials.push(c);h&&(h=
p=>{null!=p&&k.stageResources.textures.push(f.get(p))},h(a.textureColor),h(a.textureNormal),h(a.textureOcclusion),h(a.textureEmissive),h(a.textureMetallicRoughness));return c}const P=ca.create();L.fetch=async function(g,c){g=Y(ba.adjustStaticAGOUrl(g));if("wosr"===g.fileType){g=await (c.cache?c.cache.loadWOSR(g.url,c):W.load(g.url,c));const {engineResources:v,referenceBoundingBox:l}=W.processLoadResult(g,c);return{lods:v,referenceBoundingBox:l,isEsriSymbolResource:!1,isWosr:!0}}const k=await (c.cache?
c.cache.loadGLTF(g.url,c,!!c.usePBR):ka.loadGLTF(new ja.DefaultLoadingContext(c.streamDataRequester),g.url,c,c.usePBR)),t=k.model.meta?.ESRI_proxyEllipsoid,B=k.meta.isEsriSymbolResource&&null!=t&&k.meta.uri.includes("/RealisticTrees/");if(B&&!k.customMeta.esriTreeRendering){k.customMeta.esriTreeRendering=!0;a:for(let v=0;v<k.model.lods.length;++v){var y=k.model.lods[v];for(var f of y.parts){y=f.attributes.normal;if(null==y)break a;const l=f.attributes.position,m=l.count,p=Q.create(),b=Q.create(),
e=Q.create(),C=new Uint8Array(4*m),q=new Float64Array(3*m),r=da.invert(ea.create(),f.transform);let n=0,w=0;for(let F=0;F<m;F++){l.getVec(F,b);y.getVec(F,p);A.transformMat4(b,b,f.transform);A.subtract(e,b,t.center);A.divide(e,e,t.radius);const x=e[2];var u=A.length(e);u=Math.min(.45+.55*u*u,1);A.divide(e,e,t.radius);null!==r&&A.transformMat4(e,e,r);A.normalize(e,e);v+1!==k.model.lods.length&&1<k.model.lods.length&&(-1<x?A.lerp(e,e,p,.2):A.lerp(e,e,p,Math.min(-4*x-3.8,1)));q[n]=e[0];q[n+1]=e[1];q[n+
2]=e[2];n+=3;C[w]=255*u;C[w+1]=255*u;C[w+2]=255*u;C[w+3]=255;w+=4}f.attributes.normal=new D.BufferViewVec3f(q);f.attributes.color=new D.BufferViewVec4u8(C)}}}f=!!c.usePBR;f=k.meta.isEsriSymbolResource?{usePBR:f,isSchematic:!1,treeRendering:B,mrrFactors:[...O.defaultEsriSymbologyMRRFactors]}:{usePBR:f,isSchematic:!1,treeRendering:!1,mrrFactors:[...O.defaultAdvancedMRRFactors]};const {engineResources:a,referenceBoundingBox:h}=Z(k,f,{...c.materialParamsMixin,treeRendering:B},c.skipHighLods&&null==g.specifiedLodIndex?
{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:g.specifiedLodIndex});return{lods:a,referenceBoundingBox:h,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1}};L.gltfToEngineResources=Z;L.parseUrl=Y;Object.defineProperty(L,Symbol.toStringTag,{value:"Module"})});
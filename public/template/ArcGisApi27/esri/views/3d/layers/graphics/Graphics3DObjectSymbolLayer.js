// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/has ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/typedArrayUtil ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./Loadable ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./symbolComplexity ./webStyleUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/pbrUtils".split(" "),
function(U,z,R,V,ea,W,X,I,Y,t,l,C,Z,u,fa,J,ha,K,ia,ja,S,F,L,ka,la,ma,M,aa,na,oa,A,N,B,pa,v,qa,ra){let ba=z._createClass(function(O,w,g,a,b,c,d,f,e,k,h,q){this.lodResources=O;this.lodRenderer=w;this.stageResources=g;this.originalMaterialParameters=a;this.resourceSize=b;this.isEsriSymbolResource=c;this.isWosr=d;this.resourceBoundingBox=f;this.symbolSize=e;this.extentPadding=k;this.physicalBasedRenderingEnabled=h;this.pivotOffset=q});S=function(O){function w(a,b,c,d){a=O.call(this,a,b,c,d)||this;a._resources=
null;a._optionalFields=[];a._instanceIndexToGraphicUid=new Map;a._hasLoadedPBRTextures=!1;a._disposeResourceHandles=[];a.skipHighSymbolLodsChanged=!1;a.ensureDrapedStatus(!1);a._hasLoadedPBRTextures=c.physicalBasedRenderingEnabled;return a}z._inherits(w,O);var g=w.prototype;g.getCachedSize=function(){const [a,b,c]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:a,depth:b,height:c}};g.doLoad=async function(a){if(!this._drivenProperties.size&&F.validateSymbolLayerSize(this.symbolLayer))throw Error();
if(this._isPrimitive){var b=this.symbolLayer.resource;b=b&&aa.isValidPrimitive(b.primitive)?b.primitive:fa.defaultPrimitive;this._resources=await this._createResourcesForPrimitive(b,a)}else b=(await oa.getResourceUrlFromSymbolStyle(this.symbol.styleOrigin))?.href??this.symbolLayer.resource.href,this._resources=await this._createResourcesForUrl(b,a);this.layerOpacityChanged();this.slicePlaneEnabledChanged();this.physicalBasedRenderingChanged();this.complexity=this.computeComplexity()};g._setMaterialTransparencyParams=
function(a,b=this.symbolLayer?.material?.color){b=this._getCombinedOpacity(b);const c=1>b||this.needsDrivenTransparentPass;a.transparent=c;a.opacity=b;a.cullFace=c?N.CullFaceOptions.None:N.CullFaceOptions.Back;return a};g._createResourcesForPrimitive=async function(a,b){var c=this.symbolLayer;const d=u.create(J.objectSymbolLayerPrimitiveBoundingBox(a)),f=l.fromArray(u.size(d)),e=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(f,c)),k=t.length(e);var h={usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0,mrrFactors:[...ra.defaultSchematicMRRFactors],ambient:l.ONES,diffuse:l.ONES,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const q=!!h.usePBR;this._setMaterialTransparencyParams(h);const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const {screenLength:m,minWorldLength:x,maxWorldLength:r}=n.verticalOffset;h.verticalOffset={screenLength:W.pt2px(m),minWorldLength:x||
0,maxWorldLength:null!=r?r:Infinity};h.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?h.externalColor=C.ONES:(c=null!=c.material?c.material.color:null,c=null!=c?R.toUnitRGBA(c):C.ONES,h.externalColor=c);this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(d,e,f,null));h.isInstanced=!0;this._fastUpdates?(Object.assign(h,
this._fastUpdates.materialParameters),this._optionalFields.push(B.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(h.hasInstancedColor=!0,this._optionalFields.push(B.VertexAttribute.COLOR));V("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(B.VertexAttribute.OBJECTANDLAYERIDCOLOR);h=new qa.DefaultMaterial(h);h=aa.primitiveLodResources(a,h);if(!h)throw Error(`Unknown object symbol primitive: ${a}`);a=v.materialsFromLodResources(h).map(m=>({opacity:1,transparent:m.parameters.transparent}));
c=await this._createStageResources(h,q,b);b=await this._createLodRenderer(h,b);return new ba(h,b,c,a,f,!1,!1,d,e,k,q,null)};g._createResourcesForUrl=async function(a,b){var c={materialParamsMixin:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};(this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(null,
null,null,null)))?(Object.assign(c.materialParamsMixin,this._fastUpdates.materialParameters),this._optionalFields.push(B.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(c.materialParamsMixin.hasInstancedColor=!0,this._optionalFields.push(B.VertexAttribute.COLOR));V("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(B.VertexAttribute.OBJECTANDLAYERIDCOLOR);var d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const {screenLength:p,minWorldLength:D,maxWorldLength:G}=
d.verticalOffset;c.materialParamsMixin.verticalOffset={screenLength:W.pt2px(p),minWorldLength:D||0,maxWorldLength:null!=G?G:Infinity};c.materialParamsMixin.castShadows=!1}c.signal=b;c.usePBR=this._context.physicalBasedRenderingEnabled;c.skipHighLods=this._context.skipHighSymbolLods;d=c.usePBR;var f=await ma.fetch(a,c);a=f.isEsriSymbolResource;c=f.isWosr;const e=la.makeLodResources(f.lods);e.levels.sort((p,D)=>p.minScreenSpaceRadius-D.minScreenSpaceRadius);const k=this._context,h=this._getExternalColorParameters(this.symbolLayer.material),
q=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:!0}),n=this.needsDrivenTransparentPass;var m=v.materialsFromLodResources(e);const x=v.materialsFromLodResources(e).map(p=>({opacity:p.parameters.opacity||1,transparent:p.parameters.transparent}));m.forEach(p=>{const D=p.parameters;p.setParameters(h);const G=D.opacity*q;p.setParameters({opacity:G,transparent:1>G||n||D.transparent});k.screenSizePerspectiveEnabled&&p.setParameters({screenSizePerspective:k.sharedResources.screenSizePerspectiveSettings})});
f=f.referenceBoundingBox;const r=l.fromArray(u.size(f)),y=l.fromArray(e.levels[0].pivotOffset),H=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(r,this.symbolLayer)),sa=t.length(H),ca=this._fastUpdates;A.updateFastSymbolUpdatesState(ca,this._context.renderer,this._fastVisualVariableConvertOptions(f,H,r,y))&&m.forEach(p=>p.setParameters(ca.materialParameters));m=await this._createStageResources(e,d,b);b=await this._createLodRenderer(e,b);return new ba(e,b,m,x,r,a,c,f,H,sa,d,y)};g._addDisposeResource=
function(a){this._disposeResourceHandles.push(a)};g._createStageResources=async function(a,b,c){const d=this._context.stage,f=v.materialsFromLodResources(a);b!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();d.addMany(f);this._addDisposeResource(()=>d.removeMany(f));const e=v.texturesFromLodResources(a);d.addMany(e);this._addDisposeResource(()=>d.removeMany(e));await d.load(e,c);ea.throwIfAborted(c);const k=v.geometriesFromLodResources(a);d.addMany(k);this._addDisposeResource(()=>
d.removeMany(k));return{materials:f,textures:e,geometries:k}};g._createLodRenderer=async function(a,b){const c=this._context.stage,d=this._fastUpdates,f=new pa.LodRenderer({symbol:a,optionalFields:this._optionalFields,metadata:{layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},
shaderTransformation:d?{applyTransform:(e,k,h)=>{e.getFeatureAttribute(k,P);I.copy(h,A.evaluateModelTransform(d.materialParameters,P,h))},scaleFactor:(e,k,h)=>{k.getFeatureAttribute(h,P);A.evaluateModelTransformScale(e,d.materialParameters,P)}}:null},this._context.scheduler);f.slicePlaneEnabled=this._context.slicePlaneEnabled;this._addDisposeResource(()=>{c.removeRenderPlugin(f);f.destroy()});await c.addRenderPlugin(f.slots,f,b);return f};g._getExternalColorParameters=function(a){const b={};this._drivenProperties.color?
b.externalColor=C.ONES:null!=a&&null!=a.color?b.externalColor=R.toUnitRGBA(a.color):(b.externalColor=C.ONES,b.colorMixMode="ignore");return b};g.destroy=function(){z._get(z._getPrototypeOf(w.prototype),"destroy",this).call(this);this._cleanupResources()};g._cleanupResources=function(){this._disposeResourceHandles.forEach(a=>a());this._disposeResourceHandles.length=0;this._resources=null};g.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry))return null;const c=
M.placePointOnGeometry(b.geometry);if(null==c)return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;const d=this.setGraphicElevationContext(b,new ia.ElevationContext);return this._createAs3DShape(b,c,a.renderingInfo,d,b.uid,a.layer.uid)};g.notifyDestroyGraphicLayer=function(a){this._instanceIndexToGraphicUid.delete(a.instanceIndex)};g.graphicLayerToGraphicId=function(){return 0};g.layerOpacityChanged=function(){if(null!=this._resources){var a=this._drivenProperties.opacity,
b=!this._isPrimitive,c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let e=0;e<c.length;e++){const k=c[e];var f=d[e];const h=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:b})*f.opacity;f=1>h||a||f.transparent;k.setParameters({opacity:h,transparent:f});this._isPrimitive&&k.setParameters({cullFace:f?N.CullFaceOptions.None:N.CullFaceOptions.Back})}}};g.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,
b,K.needsElevationUpdates3D)};g.slicePlaneEnabledChanged=function(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const a of this._resources.stageResources.materials)a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};g.physicalBasedRenderingChanged=function(){if(null==this._resources)return!0;const {stageResources:a,isWosr:b}=this._resources;for(const c of a.materials)this._isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0}):b||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1===this._hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this._hasLoadedPBRTextures=!0,!1):!0};g.applyRendererDiff=function(a,b){if(null==this._resources)return L.ApplyRendererDiffResult.RecreateSymbol;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:f,symbolSize:e,resourceSize:k,pivotOffset:h}=this._resources;for(const q in a.diff)switch(q){case "visualVariables":if(A.updateFastSymbolUpdatesState(this._fastUpdates,
b,this._fastVisualVariableConvertOptions(f,e,k,h))){for(const n of c)n.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return L.ApplyRendererDiffResult.RecreateSymbol;break;default:return L.ApplyRendererDiffResult.RecreateSymbol}return L.ApplyRendererDiffResult.FastUpdate};g.computeComplexity=function(){if(null==this._resources)return z._get(z._getPrototypeOf(w.prototype),"computeComplexity",this).call(this);var a=this._resources.lodResources;const b=
v.geometriesFromLodLevelResources(a.levels[0]).reduce((f,e)=>f+e.indices.get(B.VertexAttribute.POSITION).length,0)/3,c=f=>Array.from(f.vertexAttributes.values()).reduce((e,k)=>e+X.estimateSize(k.data),0)+Array.from(f.indices.values()).reduce((e,k)=>e+X.estimateSize(k),0);var d=v.texturesFromLodResources(a).reduce((f,e)=>f+(e.parameters.encoding&&"image/ktx2"===e.parameters.encoding?e.memoryEstimate:e.memoryEstimate/4),0);a=v.geometriesFromLodResources(a).reduce((f,e)=>f+c(e),0);d+=a;d={...na.defaultSymbolLayerMemoryComplexity(this.symbol,
this.symbolLayer),resourceBytes:d};return{primitivesPerFeature:b,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:d}};g._hasLodRenderer=function(){return null!=this._resources};g._createAs3DShape=function(a,b,c,d,f,e){if(!this._hasLodRenderer()||null==this._resources)return null;a=this.getFastUpdateAttrValues(a);var k=this._context.clippingExtent;Z.projectPointToVector(b,E,this._context.elevationProvider.spatialReference);if(null!=k&&!u.containsPoint(k,E))return null;k=this._requiresTerrainElevation(d);
const h=this._computeGlobalTransform(b,d,T,Q),q=this._computeLocalTransform(this._resources,this.symbolLayer,c,da),n=this._resources.lodRenderer.instanceData,m=n.addInstance();this._instanceIndexToGraphicUid.set(m,f);n.setLocalTransform(m,q,!1);n.setGlobalTransform(m,h);a&&n.setFeatureAttribute(m,a);null==this._fastUpdates&&this._hasPerInstanceColor()&&n.setColor(m,F.mixinColorAndOpacity(c.color,c.opacity,255));null!=this._context.stage.renderView.objectAndLayerIdRenderHelper&&n.setObjectAndLayerIdColor(m,
this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:f,layerUid:e}));c=new ja(this,m,ha.perLodInstanceElevationAligner,d);k&&(c.alignedSampledElevation=Q.sampledElevation);c.needsElevationUpdates=K.needsElevationUpdates3D(d.mode);M.extendPointGraphicElevationContext(c,b,this._context.elevationProvider);return c};g._computeGlobalTransform=function(a,b,c,d){K.evaluateElevationInfoAtPoint(a,this._context.elevationProvider,b,this._context.renderCoordsHelper,
d);E[0]=a.x;E[1]=a.y;E[2]=d.z;Z.computeTranslationToOriginAndRotation(a.spatialReference,E,c,this._context.renderCoordsHelper.spatialReference);return c};g._computeLocalTransform=function(a,b,c,d){I.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(b,!0,d);this._applyObjectScale(a,c,d);this._applyAnchor(a,b,d);return d};g._applyObjectScale=function(a,b,c){this._fastUpdates?.requiresShaderTransformation||(a=F.computeObjectScale(this._drivenProperties.size&&b.size?b.size:a.symbolSize,
a.symbolSize,a.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===a[0]&&1===a[1]&&1===a[2]||I.scale(c,c,a))};g.prepareSymbolLayerPatch=function(a){if("partial"===a.diff.type){var b=a.diff.diff;this._preparePatchTransform(a,b);this._preparePatchColor(a,b)}};g.updateGeometry=function(a,b){if(null==this._resources)return!0;const c=b&&M.placePointOnGeometry(b);if(null==c)return!1;b=this.getGeometryElevationMode(b);if(a.elevationContext.mode!==b)return!1;this._computeGlobalTransform(c,a.elevationContext,
T,Q);this._requiresTerrainElevation(a.elevationContext)&&(a.alignedSampledElevation=Q.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(a.instanceIndex,T,!0);M.extendPointGraphicElevationContext(a,c,this._context.elevationProvider);return!0};g._preparePatchTransform=function(a,b){if((b.heading||b.tilt||b.roll||b.width||b.height||b.depth||b.anchor||b.anchorPosition)&&null!=this._resources){var c=(r,y,H)=>(null!=r&&"complete"===r.type?r.newValue:y)??H,d=c(b.heading,this.symbolLayer.heading,
0),f=c(b.tilt,this.symbolLayer.tilt,0),e=c(b.roll,this.symbolLayer.roll,0),k=c(b.width,this.symbolLayer.width,void 0),h=c(b.height,this.symbolLayer.height,void 0),q=c(b.depth,this.symbolLayer.depth,void 0),n=c(b.anchor,this.symbolLayer.anchor,void 0);c=c(b.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete b.heading;delete b.tilt;delete b.roll;delete b.width;delete b.height;delete b.depth;delete b.anchor;delete b.anchorPosition;var m={heading:d,tilt:f,roll:e,anchor:n,anchorPosition:c},
x=this._resources;this.loadStatus===ka.LoadStatus.LOADED&&a.symbolLayerStatePatches.push(()=>{x.symbolSize=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(x.resourceSize,{width:k,height:h,depth:q,isPrimitive:this.symbolLayer.isPrimitive}))});a.graphics3DGraphicPatches.push((r,y)=>{y=this._computeLocalTransform(x,m,y,da);x.lodRenderer.instanceData.setLocalTransform(r.instanceIndex,y,!0)})}};g._preparePatchColor=function(a,b){if(b.material&&"partial"===b.material.type&&(b=b.material.diff,b.color&&
"complete"===b.color.type&&null!=b.color.newValue&&null!=b.color.oldValue)){var c=b.color.newValue,d=null!=c?R.toUnitRGBA(c):C.ONES;delete b.color;var f=this._resources;null!=f&&a.graphics3DGraphicPatches.push(e=>{this._hasPerInstanceColor()?(f.lodRenderer.instanceData.setColor(e.instanceIndex,d),e=this._setMaterialTransparencyParams({},c)):e=this._setMaterialTransparencyParams({externalColor:d},c);for(const k of f.stageResources.materials)k.setParameters(e)})}};g._requiresTerrainElevation=function(a){return"absolute-height"!==
a.mode};g._applyObjectRotation=function(a,b,c){if(!this._fastUpdates?.requiresShaderTransformation||!b)return F.computeObjectRotation(a.heading,a.tilt,a.roll,c)};g._computeAnchor=function(a,b,c){const d=l.create();switch(c.anchor){case "center":t.copy(d,u.center(a));t.negate(d,d);break;case "top":b=u.center(a);t.set(d,-b[0],-b[1],-a[5]);break;case "bottom":b=u.center(a);t.set(d,-b[0],-b[1],-a[2]);break;case "relative":b=u.center(a);a=u.size(a);c=(c=c.anchorPosition)?l.fromValues(c.x,c.y,c.z):l.ZEROS;
t.multiply(d,a,c);t.add(d,d,b);t.negate(d,d);break;default:null!=b?t.negate(d,b):t.copy(d,l.ZEROS)}return d};g._applyAnchor=function(a,b,c){this._fastUpdates?.requiresShaderTransformation||(a=this._computeAnchor(a.resourceBoundingBox,a.pivotOffset,b))&&I.translate(c,c,a)};g._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};g._fastVisualVariableConvertOptions=function(a,b,c,d){const f=null!=a?l.fromArray(u.size(a)):l.ONES;a=null!=a?this._computeAnchor(a,
d,this.symbolLayer):l.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=F.computeObjectScale(null!=b?b:void 0,b,c,d);const e=l.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new A.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},f,b??l.ONES,d,a,c,e)};z._createClass(w,[{key:"extentPadding",get:function(){return null!=this._resources?this._resources.extentPadding:0}},{key:"_isPrimitive",get:function(){return!this.symbolLayer.resource?.href}},
{key:"lodRenderer",get:function(){return this._resources?.lodRenderer}}]);return w}(S.Graphics3DSymbolLayer);const E=l.create(),da=Y.create(),T=Y.create(),P=C.create(),Q=new K.SampleElevationInfo;U.Graphics3DObjectSymbolLayer=S;Object.defineProperty(U,Symbol.toStringTag,{value:"Module"})});
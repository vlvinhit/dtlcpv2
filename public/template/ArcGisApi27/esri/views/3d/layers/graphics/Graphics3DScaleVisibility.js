// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ./enums ../../../support/layerViewUtils ../../../support/Scheduler".split(" "),function(r,f,
e,B,g,D,E,F,C,t,u,h,v,w){const x=B.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");e=function(y){function p(a){a=y.call(this,a)||this;a._scaleRangeActive=!1;a._layerScaleRangeVisibilityQuery=!1;a._extent=null;a.graphicsCoreOwner=null;a.layer=null;a.queryGraphicUIDsInExtent=null;a.graphicsCore=null;a.basemapTerrain=null;a.layerScaleEnabled=!0;a.suspended=!1;a._dirty=!0;return a}r._inherits(p,y);var d=p.prototype;d.initialize=function(){this.updateScaleRangeActive();this.handles.add(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(w.TaskPriority.SCALE_VISIBILITY,
this));this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())};d.destroy=function(){this.updatingHandles.removeAll();this.handles.removeAll();this._dirty=!1;this.basemapTerrain=this.graphicsCore=this.queryGraphicUIDsInExtent=this.layer=this.graphicsCoreOwner=this._extent=null};d._setDirty=function(){this._dirty=!0};d.setExtent=function(a){const b=this.graphicsCoreOwner.view.spatialReference,c=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;
if(b===c)this._extent=a??null;else{const k=u.create();t.projectBoundingRect(a,b,k,c)?this._extent=k:this._extent=null}this._setDirty()};d.scaleRangeActive=function(){return this._scaleRangeActive};d.updateScaleRangeActive=function(){var a=this.layer,b=a.effectiveScaleRange;b=this.layerScaleEnabled&&null!=b&&(0<b.minScale||0<b.maxScale);a.labelingInfo&&!b&&(b=a.labelingInfo.some(c=>c&&(0<(c.minScale??0)||0<(c.maxScale??0))));a=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.handles.has("terrain-events")&&
this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",c=>this._scaleUpdateHandler(c)),"terrain-events"),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),"terrain-events")):!b&&this.handles.has("terrain-events")&&this.handles.remove("terrain-events");return a};d.runTask=function(a){const b=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&b&&b.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return w.Task.YIELD;
this._layerScaleRangeVisibilityQuery=!0;const {minScale:c,maxScale:k}=this.layer.effectiveScaleRange;b.queryVisibleScaleRange(this._extent,c,k,m=>this._finishUpdate(m))}else this._finishUpdate(!0);a.madeProgress()};d._finishUpdate=function(a){this._layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a);this._dirty=!1};d._visibleAtLayerScale=function(a){const b=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||v.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._visibleAtLabelScale=
function(a,b){return v.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._graphicScale=function(a){let b;null!=a.centroid?b=a.centroid:null!=a.graphic.geometry&&"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(b):1:null};d._graphicVisible=function(a){if(!this.layerScaleEnabled)return!0;a=this._graphicScale(a);return this._visibleAtLayerScale(a)};d.updateVisibility=function(a){if(this._scaleRangeActive){const b=
this._graphicVisible(a);return a.setVisibilityFlag(h.VisibilityGroup.GRAPHIC,h.VisibilityFlag.SCALE_RANGE,b)}return!1};d.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a.labelLayers||0===a.labelLayers.length)return!1;const b=this._graphicScale(a);if(a=this._updateLabelScaleVisibility(a,b))this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty();return a};d._updateLabelScaleVisibility=function(a,b){if(!a.labelLayers||0===a.labelLayers.length)return!1;
const c=a.labelLayers[0]._labelClass;return c&&null!=c.minScale&&null!=c.maxScale&&(b=this._visibleAtLabelScale(b,c),a.setVisibilityFlag(h.VisibilityGroup.LABEL,h.VisibilityFlag.SCALE_RANGE,b))?!0:!1};d._scaleUpdateHandler=function(a){this._setDirty();if(this.graphicsCore.visible){var b=a.extent,c=a.scale,k=this._visibleAtLayerScale(c),m=!1,q=this.graphicsCoreOwner.view.spatialReference;a=a.spatialReference;if(null==a)x.error("scaleUpdate: Internal error, no SpatialReference given for tiles");else{var z=
!a.equals(q);z&&!t.projectBoundingRect(b,a,A,q)?x.error("scaleUpdate: Internal error, cannot project AABR from "+a+" to wkid "+q):(this.queryGraphicUIDsInExtent(z?A:b,q,l=>{l=this.graphicsCore.getGraphics3DGraphicById(l);if(null!=l){var n=l.centroid;null!=n&&(b[0]>n.x||b[1]>n.y||b[2]<n.x||b[3]<n.y)||(l.setVisibilityFlag(h.VisibilityGroup.GRAPHIC,h.VisibilityFlag.SCALE_RANGE,k)&&(m=!0),this._updateLabelScaleVisibility(l,c)&&(m=!0))}}),m&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()))}}};
d.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(h.VisibilityGroup.GRAPHIC,h.VisibilityFlag.SCALE_RANGE,!0)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility();this._setDirty()};r._createClass(p,[{key:"updating",get:function(){return this._dirty||this.updatingHandles.updating}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||
!this.updating)}}]);return p}(e.HandleOwner);f.__decorate([g.property()],e.prototype,"graphicsCoreOwner",void 0);f.__decorate([g.property()],e.prototype,"layer",void 0);f.__decorate([g.property()],e.prototype,"queryGraphicUIDsInExtent",void 0);f.__decorate([g.property()],e.prototype,"graphicsCore",void 0);f.__decorate([g.property()],e.prototype,"basemapTerrain",void 0);f.__decorate([g.property({constructOnly:!0})],e.prototype,"layerScaleEnabled",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,
"suspended",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"updating",null);f.__decorate([g.property()],e.prototype,"_dirty",void 0);e=f.__decorate([C.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e);const A=u.create();return e});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../symbols ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/has ../../../../core/Error ../../../../core/Handles ../../../../core/handleUtils ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../support/basemapUtils ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/UpdatePolicy ../../webgl-engine/lib/WebGLLayer ../../../layers/support/popupUtils ../../../support/Scheduler ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(h,J,k,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,S,Sa,Ta,ba,T,Ua,F,ca,da,ea,U,r,V,B,x,fa,l,Va,ha,O,G,K,C,H,ia,ja,ka,L,P,W,la,ma,na,X,oa,y,M,pa,qa,ra,sa,ta,ua,va,Y,wa,xa,Z,ya,za,Aa,Ba,u,Ca,Da,I,Ea,Fa,aa,Ga,Ha){var Q;const R=K.create(),n=H.create(),t=ea.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");h.Graphics3DCore=Q=function(v){function N(a){var b=v.call(this,a)||this;b._propertiesPool=new Aa.PropertiesPool({computedExtent:Ea},J._assertThisInitialized(b));b.computedExtent=null;b.currentRenderer=
null;b.rendererHasGeometryOperations=!1;b._graphicStateTracking=null;b.graphics3DGraphics=new Map;b.stageLayer=null;b.stage=null;b._graphicsDrapedUids=new Set;b._graphicsBySymbol=new Map;b._symbolConversionCache=new Map;b._symbols=new Map;b._graphicsWithoutSymbol=new Map;b._graphicsWaitingForSymbol=new Map;b._graphicsUpdateId=0;b._handles=new ca;b._frameTask=I.ImmediateTask;b._suspendSymbolCleanup=!1;b._arcadeOnDemand=null;b._rendererChangeAbortController=null;b._elevationInfoChangeAbortController=
null;b._initializeAbortController=null;b._scaleVisibility=null;b._filterVisibility=null;b._spatialIndex=null;b.extentPadding=0;b._updatingPendingLoadedGraphicsChange=null;b._featureStore=null;b._deconflictor=null;b._labeler=null;b._objectStates=null;b._viewElevationProvider=null;b._stageLayerElevationProvider=null;b._sharedSymbolResourcesOwnerHandle=null;b._whenGraphics3DGraphicRequests={};b._pendingUpdates=new Map;b._numberOfGraphics=0;b._numberOfGraphicsProvidingElevation=0;b._pendingAdds=0;b._pendingRemoves=
0;b._applyPendingRemovesFirst=!1;b._loadingSymbols=0;b._pendingUpdatesPool=new V({allocator:c=>c||new Ia,deallocator:c=>{c.clear();return c}});b._symbolWarningLogged=!1;b._geometryWarningLogged=!1;b._objectIdInvisibleSet=new Set;b._whenSymbolRemoved=new V;b.preferredUpdatePolicy=u.UpdatePolicy.SYNC;b._forcedUpdatePolicy=null;b.elevationFeatureExpressionEnabled=!0;b.owner=null;b.layer=null;b.graphicSymbolSupported=!0;b.getRenderingInfoWithoutRenderer=!1;b.setUidToIdOnAdd=!0;b.hasZ=null;b.hasM=null;
b._usedMemory=0;b._visible=!1;b._startCreateGraphics=!1;b.symbolCreationContext=new ra.Graphics3DSymbolCreationContext(a.owner.view.resourceController.scheduler,(c,d)=>b._frameTask.schedule(c,d));return b}J._inherits(N,v);var e=N.prototype;e._getConvertedSymbol=function(a){if("web-style"===a.type)return a.clone();var b=this._symbolConversionCache.get(a.id);if(null!=b)return b;b=X.to3D(a,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(a)});const c=
b.symbol||null;null==c&&b.error&&t.error(b.error.message);this._symbolConversionCache.set(a.id,c);return c};e._getSymbolComplexitiesUsedOrRenderer=function(a){if(null==a)return[];var b=a.getSymbols(),c="backgroundFillSymbol"in a?a.backgroundFillSymbol:null;if(!(c||b&&b.length))return[];a=[];c=this._getSymbolComplexityUsedOrRenderer(c);null!=c&&a.push(c);for(const d of b)b=this._getSymbolComplexityUsedOrRenderer(d),null!=b&&a.push(b);return a};e._getSymbolComplexityUsedOrRenderer=function(a){if(null==
a)return null;const b=this._symbols.get(a.id);if(null!=b)return b.complexity;a=this._getConvertedSymbol(a);return null!=a?Z.defaultSymbolComplexity(a):null};e._getSymbolComplexitiesUsed=function(){const a=[];this._symbols.forEach(b=>{null!=b&&a.push(b.complexity)});return a};e.initialize=function(){this._featureStore=new pa.Graphics3DFeatureStore({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,
getSpatialIndex:()=>this.spatialIndex,forEach:c=>this.graphics3DGraphics.forEach(c)});const a=(c,d,f)=>this.spatialIndex.queryGraphicUIDsInExtent(c,d,f),{componentFactories:b}=this;null!=b.elevationAlignment&&(this._elevationAlignment=b.elevationAlignment(this,a));null!=b.scaleVisibility&&(this._scaleVisibility=b.scaleVisibility(this,a));null!=b.filterVisibility&&(this._filterVisibility=b.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:c=>
this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.FILTER,c(L.getObjectId(d.graphic,this._objectIdField)))),setAllFeaturesVisibility:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.FILTER,c)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(c=>c.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.FILTER,!0))}));null!=b.deconflictor&&(this._deconflictor=
b.deconflictor(this));null!=b.labeler&&null!=this._scaleVisibility&&(this._labeler=b.labeler(this,this._scaleVisibility));null!=b.objectStates&&(this._objectStates=b.objectStates(this));this._initializeAbortController=new AbortController;this._initializePromise=this._initializeAsync()};e._initializeAsync=async function(){const a=this._initializeAbortController?.signal,b=this.owner.view;this._viewElevationProvider=new oa.ViewElevationProvider(this._viewSpatialReference,b);this._initializeStage(b,this.layer.uid);
var c=b.sharedSymbolResources;this.symbolCreationContext.sharedResources=c;this._sharedSymbolResourcesOwnerHandle=c.addGraphicsOwner(this.owner);null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=b.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=
this.owner;this.symbolCreationContext.localOriginFactory=new Ba.GridLocalOriginFactory(b.renderSpatialReference);this.symbolCreationContext.elevationProvider=b.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=d=>this.notifyGraphicGeometryChanged(d);this.symbolCreationContext.notifyGraphicVisibilityChanged=d=>this.notifyGraphicVisibilityChanged(d);c=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=
await M.createContext(c,this._viewSpatialReference,a,t);B.throwIfAborted(a);this.symbolCreationContext.screenSizePerspectiveEnabled=b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled;this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods;
if("drapeSourceType"in this.owner){const {owner:d}=this;this.symbolCreationContext.drapeSourceRenderer=b.basemapTerrain.overlayManager.registerGeometryDrapeSource(d);this._handles.add(da.makeHandle(()=>b.basemapTerrain.overlayManager.unregisterDrapeSource(d)))}this._handles.add([x.watch(()=>this.suspendedOrOutsideOfView,()=>this._frameTask.reschedule(()=>this._updateLayerVisibility())),x.watch(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled],()=>{const d=
b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=d,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),x.watch(()=>this.owner.slicePlaneEnabled,d=>this._slicePlaneEnabledChange(!!d)),x.watch(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),x.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,d=>
this._physicalBasedRenderingChange(d)),x.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,d=>this._skipHighSymbolLoDsChange(d)),x.when(()=>b.basemapTerrain?.tilingScheme,d=>{d.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==b.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=b.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([x.on(()=>this.owner?.loadedGraphics,"change",
f=>{this._graphicsCollectionChanged(f);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),x.watch(()=>this.effectiveUpdatePolicy,d=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=d);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC;d===u.UpdatePolicy.SYNC&&this.runTask(I.noBudget)},x.syncAndInitial)]);this._frameTask=
b.resourceController.scheduler.registerTask(I.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this._handles.add(x.watch(()=>this.layer.featureReduction,()=>this._deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");this.rendererChange(this.owner.renderer).catch(()=>{});this._initializeAbortController=null};e._abortInitialize=function(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=
null)};e.destroy=function(){this._abortInitialize();this._abortRendererChange();this._abortElevationInfoChange();this._frameTask.remove();this._frameTask=I.ImmediateTask;this.owner.view?.deconflictor?.removeGraphicsOwner(this);this.owner.view?.labeler?.removeGraphicsOwner(this);this._elevationAlignment=r.destroyMaybe(this._elevationAlignment);this._scaleVisibility=r.destroyMaybe(this._scaleVisibility);this._filterVisibility=r.destroyMaybe(this._filterVisibility);this._labeler=this._deconflictor=null;
this._objectStates=r.destroyMaybe(this._objectStates);this.clear();this._featureStore=r.destroyMaybe(this._featureStore);this._updatingPendingLoadedGraphicsChange=r.removeMaybe(this._updatingPendingLoadedGraphicsChange);this._graphicStateTracking=r.destroyMaybe(this._graphicStateTracking);this.stage&&(this.stageLayer=r.destroyMaybe(this.stageLayer),this.stage=null);this._handles=r.destroyMaybe(this._handles);this._set("owner",null);for(const a in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[a].reject(new F("graphic:layer-destroyed",
"Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null;this._sharedSymbolResourcesOwnerHandle=r.removeMaybe(this._sharedSymbolResourcesOwnerHandle);this._propertiesPool=r.destroyMaybe(this._propertiesPool);this._pendingUpdatesPool=null;this._symbolConversionCache.clear();this._objectIdInvisibleSet.clear();this._spatialIndex=r.destroyMaybe(this._spatialIndex)};e.clear=function(){this._objectStates?.allGraphicsDeleted();null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted();
this.graphics3DGraphics.forEach(a=>a.destroy());this._spatialIndex?.clear();this.graphics3DGraphics.clear();this._usedMemory=this._numberOfGraphics=0;this._updateLayerVisibility();this._symbols.forEach(r.destroyMaybe);this._symbols.clear();this._graphicsBySymbol.clear();this._graphicsWithoutSymbol.clear();this._graphicsWaitingForSymbol.clear();this._pendingUpdates.clear();this._pendingUpdatesPool.clear();this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1;this.notifyChange("updating");
this.notifyChange("running");this.notifyChange("updatingRemaining");this._featureStore.events.emit("changed")};e._initializeStage=function(a,b){this.stage=a._stage;this.stageLayer=new Ca.WebGLLayer(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},b);a=this.stageLayer.events;a.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.graphicUid));a.on("objectShaderTransformation",c=>this.notifyGraphicGeometryChanged(c.graphicUid));a.on("visibilityChanged",
c=>this.notifyGraphicVisibilityChanged(c.graphicUid));a.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));a.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));a.on("objectGeometryUpdated",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid))};e.notifyGraphicGeometryChanged=function(a){null!=this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicGeometry(a)};e.notifyGraphicVisibilityChanged=
function(a){null!=this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicVisibility(a)};e._updateLayerVisibility=function(){var a=this._numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())};e._updateStageLayerVisibility=
function(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};e.getGraphics3DGraphicById=function(a){return null!=a?this.graphics3DGraphics.get(a):void 0};e.getGraphics3DGraphicByObjectId=function(a){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(a):null};e._getGraphicObjectID=function(a,b=this.owner.layer&&this.owner.layer.objectIdField){return L.getObjectId(a,b)};e.updateLabelingInfo=async function(a){const b=this._deconflictor&&
this._deconflictor.labelingInfoChange(a);a=this._labeler&&this._labeler.labelingInfoChange(a);await B.eachAlways([b,a])};e.updateVisibilityInfo=function(){this._deconflictor&&this._deconflictor.labelingInfoChange();this._labeler&&this._labeler.visibilityInfoChange()};e.runTask=function(a){this._frameTask.processQueue(a);this._applyPendingUpdates(a);this.notifyChange("running");this.running||this.notifyChange("updating");this.notifyChange("updatingRemaining");if(!a.hasProgressed)return I.Task.YIELD};
e.setObjectIdVisibility=function(a,b){b?this._objectIdInvisibleSet.delete(a):this._objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);null!=a&&this._updateUserVisibility(a)};e._findGraphics3DGraphicByObjectId=function(a){return U.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)};e._updateUserVisibility=function(a){if(null==a)return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(null==c||!this._objectIdInvisibleSet.has(c));
return a.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.USER,b)};e._whenGraphics3DGraphic=function(a){var b=this.graphics3DGraphics.get(a.uid);if(b)return Promise.resolve(b);if(b=this._whenGraphics3DGraphicRequests[a.uid])return b.promise;b=B.createResolver();this._whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};e._boundsForGraphics3DGraphic=async function(a,b){const c=this._viewSpatialReference,d=this.owner.view.renderSpatialReference,f=this.owner.view.basemapTerrain.spatialReference;
a=await a.getProjectedBoundingBox((p,m,w)=>C.projectBuffer(p,d,m,p,c,m,w),(p,m,w)=>C.projectBuffer(p,f,m,p,c,m,w),this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=b?!!b.useViewElevation:!1,minDemResolution:null!=b?b.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,b?.signal);if(!a)return null;b=a.boundingBox;if(a.requiresDrapedElevation){var g=this.symbolCreationContext.elevationProvider;g&&(H.center(b,R),g=g.getElevation(R[0],
R[1],0,c,"ground")??0,b[2]=Math.min(b[2],g),b[5]=Math.max(b[5],g))}return{boundingBox:b,screenSpaceObjects:a.screenSpaceObjects}};e.whenGraphicBounds=async function(a,b){await x.whenOnce(()=>this.owner?.loadedGraphics);const c=this.owner.layer&&this.owner.layer.objectIdField;var d=this.owner.loadedGraphics.find(f=>f===a?!0:null!=c&&null!=f.attributes&&a.attributes&&f.attributes[c]===a.attributes[c]);if(!d)throw new F("internal:graphic-not-part-of-view","Graphic is not part of this view");d=await this._whenGraphics3DGraphic(d);
return this._boundsForGraphics3DGraphic(d,b)};e.computeAttachmentOrigin=function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;G.set(A,0,0,0);a=0;if(0<c.render.num){if(!C.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,D,b))return null;G.add(A,A,D);a++}if(0<c.draped.num){const [d,f]=c.draped.origin;c=this._viewElevationProvider.getElevation(d,f,"ground")??
0;G.set(D,d,f,c);if(!C.projectVectorToVector(D,this._viewElevationProvider.spatialReference,D,b))return null;G.add(A,A,D);a++}1<a&&G.scale(A,A,1/a);return new Fa({x:A[0],y:A[1],z:A[2],spatialReference:b})};e.getSymbolLayerSize=function(a,b){var c=this._symbols.get(a.id);if(null==c)throw new F("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);if(-1===a)throw new F("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);
if(null==c)throw new F("internal:missing-size","Symbol layer has no valid size");return c};e._graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};e.graphicUpdateHandler=function(a){const b=a.graphic.uid,c=this.graphics3DGraphics.get(b);if(null!=c||null!=this._graphicsWithoutSymbol.get(b))switch(a.property){case "visible":this._graphicUpdateVisibleHandler(c);break;case "geometry":this._graphicUpdateGeometryHandler(c,a);break;case "symbol":this._graphicUpdateSymbolHandler(c,
a);break;case "origin-transform":this._graphicUpdateTransformHandler(c,a)}};e._graphicUpdateGeometryHandler=function(a,b){this._graphicUpdateGeometryOrTransformHandler(a,b,()=>null!=b.newValue&&null!=a&&a.graphics3DSymbol.updateGeometry(a,b.newValue));const c=b.graphic.geometry;null!=c&&this._expandComputedExtent(c)};e._graphicUpdateTransformHandler=function(a,b){const c=b.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(a,b,()=>null!=b.newValue&&null!=a&&null!=c&&a.graphics3DSymbol.updateTransform(a,
c.spatialReference,b.newValue,b.action))};e._graphicUpdateGeometryOrTransformHandler=function(a,b,c){if(null==b.graphic.geometry)this._recreateGraphic(b.graphic);else if(null==a){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this._symbols.get(a),null!=a&&a.loadStatus===wa.LoadStatus.LOADING)return;this._recreateGraphic(b.graphic)}else c()||this._recreateGraphic(a.graphic)};e._graphicUpdateSymbolHandler=function(a,b){var c=b.graphic;const d=null!=a?a.graphics3DSymbol:null!=b.oldValue?this._symbols.get(b.oldValue.id):
null;if(null==d||null==b.newValue)this._recreateGraphic(c);else{var f=d.symbol;b=this._getConvertedSymbol(b.newValue);if(null!=b&&(b.type!==f.type||"web-style"===b.type)||"web-style"===f.type)this._recreateGraphic(c);else{var g=this._graphicsBySymbol.get(f.id);if(g&&1!==g.size)this._recreateGraphic(c);else if(g=O.diff(f,b),null==g)this._updateSymbolMapping(f.id,b);else if(g={diff:g,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(g),O.isEmpty(g.diff)){var p=this._getRenderingInfo(c);
if(null==p)this._recreateGraphic(c);else{c=d.extentPadding;for(const m of g.symbolStatePatches)m();c!==d.extentPadding&&this._recomputeExtentPadding();if(null!=a)for(const m of g.graphics3DGraphicPatches)m(a,p);this._updateSymbolMapping(f.id,b)}}else this._recreateGraphic(c)}}};e._graphicUpdateVisibleHandler=function(a){this._updateUserVisibility(a)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};e.recreateGraphics=function(a){this._suspendSymbolCleanup=
!0;this.remove(a);this.add(a);this._suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&this._cleanupSymbols()};e._recreateGraphic=function(a){this.recreateGraphics([a])};e._beginGraphicUpdate=function(a){const b=this._graphicsUpdateId;this._graphicsUpdateId++;this._graphicsWaitingForSymbol.set(a.uid,b);1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating");return b};e._endGraphicUpdate=function(a){a&&(this._graphicsWaitingForSymbol.delete(a.uid),0===this._graphicsWaitingForSymbol.size&&
(this._cleanupSymbols(),this.notifyChange("updating")))};e._recomputeExtentPadding=function(){let a=0;this._symbols.forEach(b=>{null!=b&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)};e._expandComputedExtent=function(a){var b=a.spatialReference;L.computeAABB(a,n);a=this._viewSpatialReference;var c=Q.tmpVec;!ja.equals(b,a)&&C.projectXYZToVector(n[0],n[1],0,b,c,a)&&(n[0]=c[0],n[1]=c[1],C.projectXYZToVector(n[3],n[4],0,b,c,a),n[3]=c[0],n[4]=c[1]);if(isFinite(n[0])&&isFinite(n[3])&&isFinite(n[1])&&
isFinite(n[4])){b=this.computedExtent;c=null;var d=isFinite(n[2])&&isFinite(n[5]),f=d&&(!b||null==b.zmin||n[2]<b.zmin);d=d&&(!b||null==b.zmax||n[5]>b.zmax);if(b){if(n[0]<b.xmin||n[1]<b.ymin||n[3]>b.xmax||n[4]>b.ymax||f||d)c=this._propertiesPool.get("computedExtent"),c.xmin=Math.min(n[0],b.xmin),c.ymin=Math.min(n[1],b.ymin),c.xmax=Math.max(n[3],b.xmax),c.ymax=Math.max(n[4],b.ymax),c.spatialReference=a}else c=this._propertiesPool.get("computedExtent"),c.xmin=n[0],c.ymin=n[1],c.xmax=n[3],c.ymax=n[4],
c.spatialReference=a;c&&(f&&(c.zmin=n[2]),d&&(c.zmax=n[5]),this._set("computedExtent",c))}};e._abortElevationInfoChange=function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)};e.elevationInfoChange=async function(){this._abortElevationInfoChange();const a=new AbortController;this._elevationInfoChangeAbortController=a;const b=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);
this.symbolCreationContext.featureExpressionInfoContext=await M.createContext(b,this._viewSpatialReference,a.signal,t);B.throwIfAborted(a.signal);this._elevationInfoChangeAbortController=null;this._labeler?.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,f)=>{c.globalPropertyChanged("elevationInfo",d)?d.forEach(g=>{const p=g.graphic;g=g.labelLayers;for(const m of g)m.graphics3DSymbolLayer.updateGraphicElevationContext(p,m)}):this._recreateSymbol(f)});this.updateStageLayerElevationProvider();
this._elevationAlignment?.elevationInfoChange()};e.updateStageLayerElevationProvider=function(){if(this._stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=r.disposeMaybe(this._stageLayerElevationProvider)}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==
this.layer.elevationInfo.mode)&&0<this._numberOfGraphicsProvidingElevation&&(this._stageLayerElevationProvider=new ya.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))};e._clearSymbolsAndGraphics=function(){this.clear();null!=this._filterVisibility&&this._filterVisibility.clear();this._labeler?.reset();this._deconflictor?.clear();this._elevationAlignment?.clear();this.stageLayer?.invalidateSpatialQueryAccelerator();
this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=r.disposeMaybe(this._stageLayerElevationProvider))};e.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};e.recreateAllGraphics=function(){this._recreateAllGraphics(!1)};e.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)};e._recreateAllGraphics=function(a=!1){if(this._startCreateGraphics){var {loadedGraphics:b,
view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&b&&b.length?b.toArray():null;!a&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(a?this.add(d):this.recreateGraphics(d))}};e._recreateSymbol=function(a){var b=this._graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,
f)=>{const g=d.usedMemory;this._conditionalRemove(d,f);this._spatialIndex?.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(f,g);this._updateLayerVisibility();this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(a,new Map));b=this._symbols.get(a);r.destroyMaybe(b);this._symbols.delete(a);this.add(c)};e._recreateGraphicsForSymbol=function(a){if(a=this._graphicsBySymbol.get(a)){const b=[];a.forEach(c=>b.push(c.graphic));this.recreateGraphics(b)}};e._conditionalRemove=
function(a,b){this._graphicsDrapedUids.delete(b);this._objectStates?.removeGraphic(a);this._labeler?.removeGraphic(a);this._deconflictor?.removeGraphic(a);null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(a)};e.add=function(a){a&&0!==a.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(a)===u.UpdatePolicy.ASYNC?this._addDelayed(a):this._addImmediate(a),this.notifyChange("updating")):t.error("#add()","Cannot add graphics before terrain surface has been initialized"))};
e._updatePolicyForGraphics=function(a){if(this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const b of a)if(null!=b.geometry&&"mesh"===b.geometry.type&&!b.geometry.loaded)return u.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy};e._addImmediate=function(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,t),u.UpdatePolicy.SYNC);this._cleanupSymbols();this._labeler&&
(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};e._addDelayed=function(a){for(const b of a){a=b.uid;let c=this._pendingUpdates.get(a);c?c.add?c.state!==q.NEW&&c.abortController?.abort():this._pendingAdds++:(c=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(a,c));c.add=b}this.notifyChange("running");this.notifyChange("updatingRemaining")};e.remove=function(a){this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?this._removeDelayed(a):
this._removeImmediate(a);this.notifyChange("updating")};e._removeImmediate=function(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};e._removeDelayed=function(a){for(const c of a){a=c.uid;var b=this._pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this._pendingUpdates.delete(a),b.state===q.LOADING&&b.abortController?.abort(),this._pendingAdds--):(b=this._pendingUpdatesPool.pushNew(),b.remove=
c,this._pendingUpdates.set(a,b),this._pendingRemoves++,this._applyPendingRemovesFirst=!0)}0===this._pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining")};e._finishPendingUpdates=function(){this._pendingUpdatesPool.clear();this._cleanupSymbols();(this._pendingAdds||this._pendingRemoves)&&t.warn("pendingAdds/Removes in inconsistent state!");this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1};e._applyPendingUpdates=
function(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;if(0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update(),a.madeProgress();else{if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const [b,c]of this._pendingUpdates){if(a.done){this._applyPendingRemovesFirst=!0;break}if(c.remove&&!c.add&&(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,this._pendingUpdates.delete(b),0===this._pendingRemoves))break}}for(const [b,
c]of this._pendingUpdates){if(a.done)break;c.add&&c.state===q.NEW&&this._processPendingUpdateNew(c);let d=this.effectiveUpdatePolicy;!c.remove||c.add&&c.state!==q.READY||(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,d=u.UpdatePolicy.SYNC);if(c.add)switch(c.state){case q.READY:this._addGraphic(c.add,c.renderingInfo,d);c.add=null;this._pendingAdds--;a.madeProgress();break;case q.REJECTED:c.add=null,this._pendingAdds--}null==c.remove&&null==c.add&&this._pendingUpdates.delete(b)}0===
this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}};e._processPendingUpdateNew=function(a){if(a.add){var b=a.add.geometry;null==b||"mesh"!==b.type||b.loaded?this._processPendingUpdateNewRenderingInfo(a):this._processPendingUpdateNewMesh(a,b)}else a.state=q.READY};e._processPendingUpdateNewMesh=async function(a,b){a.state=q.LOADING;a.abortController=new AbortController;const c=a.abortController.signal;try{await b.load({signal:c})}catch(d){return this._processPendingUpdateNewError(a,
d)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)};e._processPendingUpdateNewError=function(a,b){a.abortController=null;B.isAbortError(b)?a.state=q.NEW:a.state=q.REJECTED};e._processPendingUpdateNewRenderingInfo=async function(a){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,t);else{a.state=q.LOADING;a.abortController=new AbortController;var b=null;try{b=await this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(c){a.abortController=
null;B.isAbortError(c)?a.state=q.NEW:a.state=q.REJECTED;return}null==b||null==b.symbol?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=b}a.state=q.READY};e._addGraphic=function(a,b,c){this._graphicsWithoutSymbol.set(a.uid,a);if(null!=b&&null!=b.symbol&&L.hasGeometry(a)){if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){const z=ma.isBasemapLayer(this.owner.view.map,
this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(a.objectId,a.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!z&&Da.hasPopupTemplate(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}var d=this.getOrCreateGraphics3DSymbol(b.symbol,b.renderer);if(null!=d){this._expandComputedExtent(a.geometry);var f=this._beginGraphicUpdate(a),g=new qa(a,b,this.layer),p=!1,m=z=>{z===d.symbol.id&&(p=!0)};this._whenSymbolRemoved.push(m);var w=()=>
{--this._loadingSymbols;if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(m);if(this._graphicsWaitingForSymbol.get(a.uid)!==f||p||d.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const z=this._createGraphics3DGraphic(d,g);this._spatialIndex&&null!=z&&this._spatialIndex.add(z);--d.referenced;this._endGraphicUpdate(a)}this._featureStore.events.emit("changed");this._labeler&&this.owner.view.labeler.setDirty()}},E=z=>{--this._loadingSymbols;
this.destroyed||(this._whenSymbolRemoved.removeUnordered(m),p||(B.isAbortError(z)?this.add([a]):d.destroyed||this._endGraphicUpdate(a)))};++this._loadingSymbols;c===u.UpdatePolicy.ASYNC?d.load(()=>this._frameTask.schedule(w),z=>this._frameTask.schedule(()=>E(z))):d.load(w,E)}}};e._removeGraphic=function(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){b.graphics3DSymbol.onRemoveGraphic(b);const c=b.usedMemory,d=b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex?.remove(b);
this._graphicsBySymbol.get(b.graphics3DSymbol.symbol.id)?.delete(a);this._graphicsWithoutSymbol.delete(a);this._removeGraphics3DGraphic(a,c,d);b.destroy();this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(a),this._graphicsWaitingForSymbol.delete(a),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};e._hasLabelingContext=function(a){if(a instanceof aa||a instanceof Ga){const b=this.symbolCreationContext.layer;return b.labelingInfo?
b.labelingInfo.some(c=>c.symbol===a):!1}return!1};e._hasValidSymbolCreationContext=function(a){return a instanceof aa&&!this._hasLabelingContext(a)?(t.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};e._getRenderingInfo=function(a,b){const c=a.geometry;if(null==c)return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;
if(!C.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=a.symbol)return b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?
P.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(a,this.currentRenderer,this._arcadeOnDemand):{symbol:a.symbol||na.getDefaultSymbol3D(a.geometry)};return null==a||null==a.symbol?(b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a};e._getRenderingInfoAsync=function(a,b){if(null==a.geometry)return t&&
!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=a.symbol)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?P.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,this.currentRenderer,
this._arcadeOnDemand,b)};e._createGraphics3DSymbol=function(a,b){if(!this._hasValidSymbolCreationContext(a))return null;a=this._getConvertedSymbol(a);if(!a)return null;let c;null!=b&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=X.to3D(b.backgroundFillSymbol,{ignoreDrivers:!0}),null!=b.symbol&&"web-style"!==b.symbol.type&&"cim"!==b.symbol.type&&(c=b.symbol.symbolLayers));const d=sa.make(a,this.symbolCreationContext,c);d.load(()=>{const f=d.extentPadding;f>this.extentPadding&&this._set("extentPadding",
f);this.notifyChange("averageSymbolComplexity")},()=>{});return d};e.getOrCreateGraphics3DSymbol=function(a,b){let c=this._symbols.get(a.id);void 0===c&&(c=a instanceof Ha?new ta(a,d=>this._frameTask.schedule(d),d=>this._createGraphics3DSymbol(d,b)):this._createGraphics3DSymbol(a,b),this._symbols.set(a.id,c));null!=c&&++c.referenced;return c};e.trackGraphicState=function(a){null==this._graphicStateTracking&&(this._graphicStateTracking=new ua.GraphicStateTracking(this));return this._graphicStateTracking.add(a)};
e._addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this._numberOfGraphics++;a.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};e._removeGraphics3DGraphic=function(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this._numberOfGraphics--;c&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};
e._createGraphics3DGraphic=function(a,b){const c=b.graphic;this._graphicsWithoutSymbol.delete(c.uid);if(!this._symbols.has(a.symbol.id))return this.add([c]),null;if(this.graphics3DGraphics.has(c.uid))return null;b=a.createGraphics3DGraphic(b);if(null==b)return null;this._addGraphics3DGraphic(b);a=a.symbol.id;this._graphicsBySymbol.has(a)||this._graphicsBySymbol.set(a,new Map);this._graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&this._graphicsDrapedUids.add(c.uid);b.centroid=null;null!=c.geometry&&
"point"!==c.geometry.type&&(b.centroid=va.computeCentroid(c.geometry,this._viewSpatialReference));this._updateUserVisibility(b);null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(b);null!=this._filterVisibility&&({defaultVisibility:a}=this._filterVisibility,b.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.FILTER,a),a||this._filterVisibility.reapply());this._deconflictor?.addGraphic(b);this._labeler?.addGraphic(b);this._objectStates?.addGraphic(b);this._deconflictor&&
this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stageLayer,this.owner);null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(b);if(a=this._whenGraphics3DGraphicRequests[c.uid])delete this._whenGraphics3DGraphicRequests[c.uid],a.resolve(b);return b};e._abortRendererChange=function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)};e.rendererChange=async function(a){this._abortRendererChange();
if(a!==this.currentRenderer)if(this._validateRenderer(a),null==a&&this._currentRendererChange(null,!1),W.isSupportedRenderer3D(a))if(null!=a&&a.arcadeRequired){var b=new AbortController;this._rendererChangeAbortController=b;const {arcadeUtils:c}=await this._ensureArcade();B.throwIfAborted(b);const d=c.hasGeometryOperations(a);d&&(await c.enableGeometryOperations(),B.throwIfAborted(b));this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?await this._frameTask.schedule(()=>this._currentRendererChange(a,
d),b.signal):this._currentRendererChange(a,d);this._rendererChangeAbortController=null}else this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?(this._rendererChangeAbortController=b=new AbortController,await this._frameTask.schedule(()=>this._currentRendererChange(a,!1),b.signal),this._rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,!1)};e._ensureArcade=async function(){null==this._arcadeOnDemand&&(this._arcadeOnDemand=await la.loadArcade());
return this._arcadeOnDemand};e._currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=this._arcadeOnDemand;b=this.symbolCreationContext.renderer;if(a!==b)if(this._symbolConversionCache.clear(),null==a)this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=O.diff(b,a);this._updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;null!=c&&("complete"===c.type?this.recreateAllGraphicsAndSymbols():
"partial"===c.type&&(this._applyRendererDiff(c,a,b)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}};e._diffHasSymbolChange=function(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "uniqueValueGroups":case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};e._applySymbolSetDiff=function(a,b,c){a=a||[];b=b||[];const d=[];for(const f of b){const g=
this._graphicsBySymbol.get(f.id);g&&g.forEach((p,m)=>{var w=p.graphic,E=this.layer instanceof ka?this.layer:null;const z=this._arcadeOnDemand;if(f!==c.defaultSymbol||c.getSymbol(P.hydrateGraphic(w,E),{arcade:z})!==c.defaultSymbol)E=p.usedMemory,a.length||c.defaultSymbol?d.push(w):this._graphicsWithoutSymbol.set(m,w),w=this.graphics3DGraphics.get(m),this._conditionalRemove(w,m),p.destroy(),g.delete(m),this._removeGraphics3DGraphic(m,E),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(p=>
p(f.id))}if(a.length||d.length)this._graphicsWithoutSymbol.forEach(f=>d.push(f)),this._graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};e._applyUniqueValueRendererDiff=function(a,b,c){const d=a.diff.defaultSymbol,f=a.diff.uniqueValueInfos;if(d||f){const g=f?f.added.map(m=>m.symbol).filter(T.isSome):[],p=f?f.removed.map(m=>m.symbol).filter(T.isSome):[];if(f)for(let m=0;m<f.changed.length;m++)g.push(f.changed[m].newValue.symbol),
p.push(f.changed[m].oldValue.symbol);d?(c.defaultSymbol&&p.push(c.defaultSymbol),b.defaultSymbol&&g.push(b.defaultSymbol)):c.defaultSymbol&&g.length&&p.push(b.defaultSymbol);this._applySymbolSetDiff(g,p,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};e._calculateUnchangedSymbolMapping=function(a,b,c){if("unique-value"!==b?.type||"unique-value"!==c?.type||null!=a&&"partial"!==a.type)return[];const d=g=>null!=g?g.id:null;var f=a&&a.diff;a=f&&f.defaultSymbol;if(f=f&&
f.uniqueValueInfos)f=f.unchanged.map(g=>({oldId:d(g.oldValue.symbol),newId:d(g.newValue.symbol)}));else{f=[];for(const g of c.uniqueValueInfos??[]){const p=d(g.symbol),m=b.uniqueValueInfos?.find(w=>w.value===g.value);m&&p!==d(m.symbol)&&f.push({oldId:p,newId:d(m.symbol)})}}!a&&c.defaultSymbol&&f.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return f};e._updateSymbolMapping=function(a,b){const c=null!=b&&b?"string"===typeof b?b:b.id:null;if(null!=a&&a!==c){var d=this._graphicsBySymbol.get(a);
this._graphicsBySymbol.delete(a);void 0!==d&&this._graphicsBySymbol.set(c,d);d=this._symbols.get(a);void 0!==d&&(this._symbols.delete(a),this._symbols.set(c,d),null!=d&&(a="string"===typeof b?null:b,null!=a?d.symbol=a:d.symbol.id=c))}};e._updateUnchangedSymbolMappings=function(a,b,c){a=this._calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:f}of a)this._updateSymbolMapping(d,f)};e._applyRendererDiff=function(a,b,c){if(this._diffHasSymbolChange(a))return!1;if(b instanceof S&&c instanceof
S&&this._applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this._graphicsBySymbol)if(c=this._symbols.get(d),null!=c)switch(c.applyRendererDiff(a,b)){case Y.ApplyRendererDiffResult.RecreateSymbol:this._recreateSymbol(d);break;case Y.ApplyRendererDiffResult.RecreateGraphics:this._recreateGraphicsForSymbol(d)}return!0};e.opacityChange=function(){this.forEachGraphics3DSymbol((a,b)=>a.globalPropertyChanged("opacity",b));this._updateStageLayerVisibility()};e._slicePlaneEnabledChange=
function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.sliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())};e._physicalBasedRenderingChange=function(a){this.symbolCreationContext.physicalBasedRenderingEnabled=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",
c)||this._recreateSymbol(d)})};e._skipHighSymbolLoDsChange=function(a){this.symbolCreationContext.skipHighSymbolLods=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("skipHighSymbolLods",c)||this._recreateSymbol(d)})};e._pixelRatioChange=function(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})};e._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();
this._updatingPendingLoadedGraphicsChange=fa.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};e.setClippingExtent=function(a,b){const c=this.symbolCreationContext.clippingExtent,d=ia.create();za.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=H.fromRect(H.create(),d):this.symbolCreationContext.clippingExtent=null;return!H.equals(this.symbolCreationContext.clippingExtent,c)};e.modifyGraphics3DGraphicVisibilities=function(a){if(!this.destroyed){var b=!1;this.graphics3DGraphics.forEach(c=>
{a(c)&&(b=!0)});b&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor?.setDirty())}};e.forEachGraphics3DSymbol=function(a){for(const [b,c]of this._symbols){if(null==c)break;const d=this._graphicsBySymbol.get(b);a(c,d||Ja,b)}};e.updateAllGraphicsVisibility=function(){null!=this._filterVisibility&&this._filterVisibility.reapply();this.modifyGraphics3DGraphicVisibilities(a=>{const b=this._updateUserVisibility(a);a=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(a);
return b||a})};e._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(y.VisibilityGroup.GRAPHIC,y.VisibilityFlag.USER,!1))};e._validateRenderer=function(a){(a=W.validateTo3D(a,{geometryType:this.layer?.geometryType}))&&t.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,a.message)};e._volatileGraphicsUpdated=function(){this._labeler?.reset();this.stageLayer.shaderTransformationChanged();
this.notifyChange("updating")};e._cleanupSymbols=function(){if(!(0<this._graphicsWaitingForSymbol.size||this._suspendSymbolCleanup)){var a=!1;this._symbols.forEach((b,c)=>{if(!(null==b||0<b.referenced)){var d=this._graphicsBySymbol.get(c);d&&0!==d.size||(this._graphicsBySymbol.delete(c),this._symbols.delete(c),r.destroyMaybe(b),a=!0)}});a&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};J._createClass(N,[{key:"_viewSpatialReference",get:function(){return this.owner.view.spatialReference}},
{key:"spatialIndex",get:function(){this._spatialIndex||(this._spatialIndex=new xa.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},{key:"effectiveUpdatePolicy",get:function(){return null!=this.currentRenderer&&
"dictionary"===this.currentRenderer.type?u.UpdatePolicy.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},
{key:"updating",get:function(){return!!(0<this._graphicsWaitingForSymbol.size||this.running||this._elevationAlignment?.updating||null!=this._scaleVisibility&&this._scaleVisibility.updating||null!=this._filterVisibility&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||0<this._loadingSymbols)}},{key:"running",get:function(){return 0<this._pendingUpdates.size||!!this._spatialIndex?.updating}},
{key:"suspendedOrOutsideOfView",get:function(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}},{key:"updatingRemaining",get:function(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}},{key:"displayFeatureLimit",get:function(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const b=a?a.graphics3D.minTotalNumberOfFeatures:0,c=a?a.graphics3D.maxTotalNumberOfFeatures:
0;a=a?a.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity,f=Math.max(b,Math.min(c,Math.ceil(a/Math.max(1,null!=d?d.primitivesPerFeature:1)),null!=d&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c)),g=this._get("displayFeatureLimit");return g&&g.minimumTotalNumberOfFeatures===b&&g.maximumTotalNumberOfFeatures===c&&g.maximumTotalNumberOfPrimitives===a&&g.averageSymbolComplexity===d&&g.maximumNumberOfFeatures===f?g:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:c,
maximumTotalNumberOfPrimitives:a,averageSymbolComplexity:d,maximumNumberOfFeatures:f}}},{key:"averageSymbolComplexity",get:function(){const a=Z.averageSymbolComplexities(this._symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||null!=b&&(a.estimated&&(b.primitivesPerFeature>=a.primitivesPerFeature||b.primitivesPerCoordinate>=a.primitivesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.primitivesPerFeature===a.primitivesPerFeature&&b.primitivesPerCoordinate===
a.primitivesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}},{key:"usedMemory",get:function(){const a=null!=this.averageSymbolComplexity&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,b=this._getSymbolComplexitiesUsed().reduce((c,d)=>c+d.memory.resourceBytes,0);return this._usedMemory+a+b}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this._numberOfGraphics?this._usedMemory/this._numberOfGraphics*(this._numberOfGraphics/
(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves))):null!=this.averageSymbolComplexity?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}},{key:"_symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):
this._getSymbolComplexitiesUsed()}},{key:"visible",get:function(){return this._visible}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"graphics3DGraphicsByObjectID",get:function(){const a=this.owner.layer&&this.owner.layer.objectIdField;if(a){var b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);null!=d&&b.set(d,c)}});return b}}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},
{key:"symbolUpdateType",get:function(){if(0<this._pendingUpdates.size)return"unknown";let a=0,b=0;return U.someMap(this._symbols,(c,d)=>{if(null!=c){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this._graphicsBySymbol.has(d)&&(b+=c.fast,a+=c.slow)}return!1})?"unknown":0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map(a=>
({symbolId:a,graphics:[...this._graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:a=>{this._forcedUpdatePolicy=a}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,
pending:this._pendingUpdates.size}}}]);return N}(ba);h.Graphics3DCore.tmpVec=K.create();k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,"computedExtent",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"currentRenderer",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_frameTask",void 0);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,
"_viewSpatialReference",null);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_initializeAbortController",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_elevationAlignment",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_scaleVisibility",void 0);k.__decorate([l.property()],
h.Graphics3DCore.prototype,"_filterVisibility",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_initializePromise",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_spatialIndex",void 0);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,"extentPadding",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_featureStore",void 0);k.__decorate([l.property()],
h.Graphics3DCore.prototype,"_deconflictor",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_labeler",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_objectStates",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_loadingSymbols",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,
"effectiveUpdatePolicy",null);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"owner",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"layer",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,
"getRenderingInfoWithoutRenderer",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"componentFactories",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"featureStore",null);k.__decorate([l.property()],h.Graphics3DCore.prototype,"initializePromise",null);k.__decorate([l.property()],h.Graphics3DCore.prototype,"scaleVisibility",null);k.__decorate([l.property()],
h.Graphics3DCore.prototype,"elevationAlignment",null);k.__decorate([l.property()],h.Graphics3DCore.prototype,"objectStates",null);k.__decorate([l.property()],h.Graphics3DCore.prototype,"filterVisibility",null);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,"updating",null);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,"running",null);k.__decorate([l.property({readOnly:!0})],h.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);k.__decorate([l.property({readOnly:!0,
dependsOn:[]})],h.Graphics3DCore.prototype,"updatingRemaining",null);k.__decorate([l.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],h.Graphics3DCore.prototype,"displayFeatureLimit",null);k.__decorate([l.property({readOnly:!0,dependsOn:[]})],h.Graphics3DCore.prototype,"averageSymbolComplexity",null);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,
"hasZ",void 0);k.__decorate([l.property({constructOnly:!0})],h.Graphics3DCore.prototype,"hasM",void 0);k.__decorate([l.property()],h.Graphics3DCore.prototype,"_objectIdField",null);h.Graphics3DCore=Q=k.__decorate([ha.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],h.Graphics3DCore);var q;(function(v){v[v.NEW=0]="NEW";v[v.LOADING=1]="LOADING";v[v.READY=2]="READY";v[v.REJECTED=3]="REJECTED"})(q||(q={}));let Ia=function(){function v(){this.renderingInfo=this.add=null;this.state=q.NEW;this.remove=
this.abortController=null}v.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=q.NEW;this.remove=this.abortController=null};return J._createClass(v)}();const A=K.create(),D=K.create(),Ja=new Map;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../symbols/callouts/calloutUtils ./CreateLabelParameters ./enums ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DLineCalloutSymbolLayer ./graphicSymbolUtils ./labelPlacement ./placementUtils ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler".split(" "),
function(t,v,w,L,D,M,E,N,x,u,F,A,da,ea,fa,O,P,Q,R,S,r,T,G,U,V,B,H,W,X,Y,Z,I){function y(m){return!0===m.labelsVisible&&!!m.labelingInfo?.some(n=>!!n.symbol)}let J=v._createClass(function(m,n){this.labelingContext=m;this.graphics3DGraphic=n;this.textInitialized=this.rendered=this.visible=this.hasGraphics3DResources=!1;this.textRenderers=[];this.textLabelPlacements=[]}),aa=v._createClass(function(m,n,f,a,b){this.labelClass=m;this.graphics3DSymbol=n;this.graphics3DCalloutSymbolLayer=f;this.textRenderParameters=
a;this.labelFunction=b;this.calloutSymbolLayerIndex=0}),ba=function(){function m(n,f,a,b,c,e,d,l){this.layer=f;this.graphics3DCore=a;this.scaleVisibility=b;this.emptySymbolLabelSupported=c;this.elevationInfoOverride=e;this.disablePlacement=d;this.active=l;this.labelClassAbortController=new AbortController;this.labelClassContexts=[];this.graphics=new Map;this.labelsToInitialize=new Map;this.stageLayer=new Z.WebGLLayer(n,{pickable:!0,disableOctree:!0},f.uid)}m.prototype.destroy=function(){this.stageLayer.destroy()};
return v._createClass(m)}();t.Labeler=function(m){function n(a){a=m.call(this,a)||this;a._dirty=!1;a._labels=new Map;a._labelsToAdd=new Map;a._labelsToRemove=new Map;a._labelingContexts=[];return a}v._inherits(n,m);var f=n.prototype;f.setup=function(){this.dispose();this._handles=new M;this._handles.add([F.watch(()=>this.view.state?.camera,()=>this.setDirty()),F.watch(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(I.TaskPriority.LABELER,
this)]);this._textTextureAtlas=new Y.TextTextureAtlas({view:this.view});this._hudMaterialCollection=new H.MaterialCollection(this.view._stage);this._calloutMaterialCollection=new H.MaterialCollection(this.view._stage)};f.dispose=function(){this._handles=x.destroyMaybe(this._handles);this._textTextureAtlas=x.disposeMaybe(this._textTextureAtlas);this._hudMaterialCollection=x.disposeMaybe(this._hudMaterialCollection);this._calloutMaterialCollection=x.disposeMaybe(this._calloutMaterialCollection);this._labelingContexts.length=
0;this._labels.clear();this._labelsToAdd.clear();this._labelsToRemove.clear()};f.destroy=function(){this.dispose();p.graphic=null;p.renderingInfo=null;p.layer=null};f._activateLabelingContext=function(a){a.graphics.forEach((b,c)=>{const e=new J(a,b);this._labels.set(c,e);a.labelsToInitialize.set(c,e);b.setVisibilityFlag(r.VisibilityGroup.LABEL,r.VisibilityFlag.USER,!0)});a.active=!0};f._deactivateLabelingContext=function(a){a.graphics.forEach((b,c)=>{b.setVisibilityFlag(r.VisibilityGroup.LABEL,r.VisibilityFlag.USER,
!1);this.setLabelGraphicVisibility(b,!1);this._labels.delete(c)});a.active=!1};f._addLabelTextureToAtlas=function(a){for(const b of a.graphics3DGraphic.labelLayers){if(!b._labelClass)continue;const c=a.textRenderers[b._labelIndex];c&&this._textTextureAtlas.addTextTexture(c,b.stageObject)}a.rendered=!0};f._removeLabelTextureFromAtlas=function(a){for(const b of a.graphics3DGraphic.labelLayers){if(!b._labelClass)continue;const c=a.textRenderers[b._labelIndex];null!=c&&this._textTextureAtlas.removeTextTexture(c,
b.stageObject)}a.rendered=!1};f.runTask=function(a){this._updateLabels(a);!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(a);return I.Task.YIELD};f._updateLabels=function(a){if(this._dirty){this._dirty=!1;for(const b of this._labelingContexts)if(b.active){if(!b.labelClassContexts||!b.labelClassContexts.length){if(null===b.labelClassContexts){this._deactivateLabelingContext(b);continue}this._createLabelClassContext(b);if(b.labelClassPromise&&b.labelClassAbortController){this._dirty=
!0;continue}if(!b.labelClassContexts||!b.labelClassContexts.length)continue}N.someMap(b.labelsToInitialize,(c,e)=>{this._ensureGraphics3DResources(c)&&(this._labels.set(e,c),this.deconflictor.setDirty(),a.madeProgress());if(c.visible&&c.textInitialized||!c.visible&&c.hasGraphics3DResources)b.labelsToInitialize.delete(e),a.madeProgress();return a.done})&&(this._dirty=!0)}this._labelsToRemove.forEach(b=>this._removeLabelTextureFromAtlas(b));this._labelsToAdd.forEach(b=>this._addLabelTextureToAtlas(b));
this._labelsToRemove.clear();this._labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};f._createLabelClassContextAsync=async function(a){const b=a.labelClassAbortController?.signal;await a.layer.when?.();u.throwIfAborted(b);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();const c=a.graphics3DCore;var e=c.layer;(e=e.labelingInfo&&e.labelingInfo.filter(d=>!!d.symbol))&&0!==e.length&&(await D.forEach(e,async(d,l)=>{var g=d.symbol;const h=U.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(g));
if(null==h)E.getLogger(this).error("Failed to create Graphics3DSymbol for label");else{await h.load();u.throwIfAborted(b);var k=null;R.hasCalloutSupport(g)&&g.hasVisibleCallout()&&(k=T.make(g,c.symbolCreationContext),await k.load(),u.throwIfAborted(b));g=await D.result(Q.createLabelFunction(d,a.layer.fieldsIndex,this.view.spatialReference));u.throwIfAborted(b);if(!0===g.ok){const q=await this._createTextRenderParameters(h.symbol);u.throwIfAborted(b);a.labelClassContexts[l]=new aa(d,h,k,q,g.value)}else E.getLogger(this).error(`Label expression failed to evaluate: ${g.error}`)}}),
u.throwIfAborted(b))};f._createLabelClassContext=async function(a){null==a.labelClassPromise&&(a.labelClassPromise=this._createLabelClassContextAsync(a).catch(b=>{if(u.isAbortError(b))throw b;a.labelClassContexts.length=0}).then(()=>{a.labelClassAbortController=null;this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating"));return a.labelClassPromise};f._createTextRenderParameters=async function(a){a=a.symbolLayers.at(0);return"text"!==a?.type?null:X.TextRenderParameters.fromSymbol(a,
this.view.state.rasterPixelRatio)};f._destroyLabelClassContext=function(a){for(var b of a.labelClassContexts)--b.graphics3DSymbol.referenced;b=a.labelClassAbortController;a.labelClassAbortController=new AbortController;x.abortMaybe(b);a.labelClassContexts.length=0;a.labelClassPromise=null;this.notifyChange("updating")};f._createTextSymbolGraphic=function(a,b,c,e,d){a=new S.CreateLabelParameters(c.verticalOffset,B.horizontalPlacementFromAnchor(c.anchor),B.verticalPlacementFromAnchor(c.anchor),a.text,
c.translation,c.elevationOffset,c.centerOffset,c.screenOffset,c.centerOffsetUnits,a.displayWidth,a.displayHeight);p.graphic=b;p.renderingInfo=null;p.layer=e;return d.createLabel(p,a,this._hudMaterialCollection,this._textTextureAtlas)};f._createLineCalloutGraphic=function(a,b,c,e,d){p.graphic=a;p.layer=d;p.renderingInfo=new G.LineCalloutSymbolLayerRenderingInfo(null,b,e.translation,e.centerOffset,e.screenOffset,e.centerOffsetUnits,e.elevationOffset,this._calloutMaterialCollection);return c.createGraphics3DGraphic(p)};
f._ensureGraphics3DResources=function(a){if(a.hasGraphics3DResources)return!1;const b=a.graphics3DGraphic;if(b.destroyed)return!1;this._ensureTextTextureResources(a);const c=a.labelingContext,e=c.labelClassContexts;if(!e||0===e.length||!c.emptySymbolLabelSupported&&0===b.layers.length)return!1;var d=!1,l=b.graphic;const g=c.layer;var h=y(c.layer);for(let q=0;q<e.length;q++){const K=a.textRenderers[q],C=a.textLabelPlacements[q];if(null==K||null==C)continue;const z=e[q];var k=z.graphics3DSymbol;const ca=
k.symbol&&"label-3d"===k.symbol.type?k.symbol:null;if(k=k.symbolLayers[0]){k.setElevationInfoOverride(c.elevationInfoOverride);d=this._createTextSymbolGraphic(K,l,C,g,k);if(null==d)return!1;d._labelClass=z.labelClass;d._labelIndex=q;b.addLabelGraphic(d,c.stageLayer);b.deconflictionPriority=z.textRenderParameters?.definition.size??0;b.setVisibilityFlag(r.VisibilityGroup.LABEL,r.VisibilityFlag.USER,h);b.setVisibilityFlag(r.VisibilityGroup.LABEL,r.VisibilityFlag.SCALE_RANGE,!0);b.setVisibilityFlag(r.VisibilityGroup.LABEL,
r.VisibilityFlag.DECONFLICTION,!1);d=!0;(h=z.graphics3DCalloutSymbolLayer)&&C.hasLabelVerticalOffset&&(h.setElevationInfoOverride(c.elevationInfoOverride),l=this._createLineCalloutGraphic(l,ca,h,C,g),null!=l&&(z.calloutSymbolLayerIndex=b.labelLayers.length,b.addLabelGraphic(l,c.stageLayer)));break}}c.scaleVisibility&&d&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0};f._destroyGraphics3DResources=function(a){const b=a.labelingContext.labelClassContexts;for(const c of a.graphics3DGraphic.labelLayers){if(null==
c._labelClass)continue;const e=b[c._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=e)e.onRemoveGraphic(c)}a.graphics3DGraphic.deconflictionPriority=0;a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};f._ensureTextTextureResources=function(a){if(!a.textInitialized){var b=a.labelingContext,c=b.labelClassContexts;if(c&&0!==c.length){var e=a.graphics3DGraphic.graphic;for(let g=0;g<c.length;g++){const h=c[g];a.textRenderers[g]=null;a.textLabelPlacements[g]=null;if(null==h?.textRenderParameters)continue;
var d=h.labelFunction;let k;if("arcade"===d.type)try{const q=d.needsHydrationToEvaluate()?P.hydrateGraphic(e,b.layer):e;k=d.evaluate(q)}catch(q){k=null}else k=d.evaluate(e);if(null!=k&&""!==k&&!/^\s+$/.test(k)&&(d=h.graphics3DSymbol,d.symbolLayers[0]&&(d=V.get({graphics3DGraphic:a.graphics3DGraphic,labelSymbol:"label-3d"===d.symbol?.type?d.symbol:null,labelClass:h.labelClass,disablePlacement:b.disablePlacement}),null!=d))){var l=B.horizontalPlacementFromAnchor(d.anchor);l=B.textRenderAlignmentFromHorizontalPlacement(l);
a.textRenderers[g]=new W.TextRenderer(k,l,h.textRenderParameters);a.textLabelPlacements[g]=d}}a.textInitialized=!0}}};f._destroyTextTextureResources=function(a){a.textInitialized=!1;a.textRenderers.length=0;a.textLabelPlacements.length=0};f._addGraphic=function(a,b){const c=b.graphic.uid;a.graphics.set(c,b);a.active&&(b=new J(a,b),this._labels.set(c,b),a.labelsToInitialize.set(c,b));this.setDirty();this.deconflictor.setDirty()};f._removeGraphic=function(a,b){b=b.graphic.uid;const c=this._labels.get(b);
a.graphics.delete(b);c&&(this._destroyGraphic(c,b),a.labelsToInitialize.delete(b),this.setDirty(),this.deconflictor.setDirty())};f._destroyGraphic=function(a,b){this._labels.has(b)&&(this._labels.delete(b),this._labelsToAdd.delete(b),this._labelsToRemove.delete(b));a.textInitialized&&(this._removeLabelTextureFromAtlas(a),this._destroyTextTextureResources(a));a.hasGraphics3DResources&&this._destroyGraphics3DResources(a)};f._labelingInfoChange=async function(a,b){if(b)for(const c of b){if(b=a.graphics.get(c))this._removeGraphic(a,
b),this._addGraphic(a,b)}else return this._visibilityInfoChange(a),this._resetLabels(a),this._createLabelClassContext(a)};f._globalPropertyChanged=function(a,b){for(const c of b.labelClassContexts){const e=new Map;b.graphics.forEach(d=>e.set(d.graphic.uid,d));c.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(a,e,d=>d.labelLayers[0]);c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,e,d=>d.labelLayers[c.calloutSymbolLayerIndex])}};f._visibilityInfoChange=
function(a){const b=y(a.layer);b&&!a.active&&this._activateLabelingContext(a);!b&&a.active&&this._deactivateLabelingContext(a);this.setDirty()};f._resetAllLabels=function(){for(const a of this._labelingContexts)this._resetLabels(a)};f._resetLabels=function(a){a.graphics.forEach((b,c)=>{if(b=this._labels.get(c))this._destroyGraphic(b,c),b.visible=!1,b.rendered=!1,a.labelsToInitialize.set(c,b)});this._destroyLabelClassContext(a);this.setDirty();this.deconflictor.setDirty()};f._findLabelingContext=function(a){for(const b of this._labelingContexts)if(b.graphics3DCore===
a)return b;return null};f.addGraphicsOwner=function(a,b,c){const e=c&&c.emptySymbolLabelSupported||!1,d=c&&c.elevationInfoOverride||null;c=c&&c.disablePlacement||null;if(!this._findLabelingContext(a)){var l=a.layer,g=new ba(this.view._stage,l,a,b,e,d,c,y(l));this._labelingContexts.push(g);this.setDirty();return{addGraphic:h=>this._addGraphic(g,h),removeGraphic:h=>this._removeGraphic(g,h),featureReductionChange:()=>{},layerLabelsEnabled:()=>y(g.layer),labelingInfoChange:h=>this._labelingInfoChange(g,
h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",g),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",g),visibilityInfoChange:()=>this._visibilityInfoChange(g),reset:()=>this._resetLabels(g),clear:()=>{}}}};f.removeGraphicsOwner=function(a){const b=this._findLabelingContext(a);b&&(a=this._labelingContexts.indexOf(b),this._labelingContexts.splice(a,1),b.graphics.forEach(c=>this._removeGraphic(b,c)),b.destroy(),this.setDirty())};f.setLabelGraphicVisibility=
function(a,b){a=a.graphic.uid;const c=this._labels.get(a);c&&c.visible!==b&&(b&&!c.rendered?(this._labelsToAdd.set(a,c),this._labelsToRemove.delete(a),c.textInitialized||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this._labelsToRemove.set(a,c),this._labelsToAdd.delete(a)),c.visible=b,this.setDirty())};f.setDirty=function(){!this._dirty&&0<this._labelingContexts.length&&(this._dirty=!0,this.notifyChange("updating"))};v._createClass(n,[{key:"running",get:function(){return this.view.ready&&
(this._dirty||this.deconflictor.running)}},{key:"updating",get:function(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(a=>!!a.labelClassPromise&&!!a.labelClassAbortController)}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const a=0<this._labelingContexts.length?this._labelingContexts.reduce((b,c)=>b+(c.labelClassPromise&&c.labelClassAbortController?0:1),0)/this._labelingContexts.length:
1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*a+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]);return n}(L);w.__decorate([A.property({constructOnly:!0})],t.Labeler.prototype,"view",void 0);w.__decorate([A.property({constructOnly:!0})],t.Labeler.prototype,"deconflictor",void 0);w.__decorate([A.property()],t.Labeler.prototype,"_textTextureAtlas",void 0);w.__decorate([A.property({type:Boolean,
readOnly:!0})],t.Labeler.prototype,"updating",null);t.Labeler=w.__decorate([O.subclass("esri.views.3d.layers.graphics.Labeler")],t.Labeler);const p=new G.LineCalloutCreationContext(null,null,null);t.areLabelsVisible=y;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
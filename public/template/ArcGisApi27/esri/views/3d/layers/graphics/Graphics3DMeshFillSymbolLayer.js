// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/has ../../../../core/mathUtils ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/Indices ../../../../geometry/support/MeshComponent ../../../../geometry/support/MeshMaterialMetallicRoughness ../../../../geometry/support/MeshTextureTransform ../../../../chunks/vec32 ../../../../geometry/support/meshUtils/projection ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/sources/interfaces ../../../ViewingMode ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DMeshObject3DGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./MeshFastUpdateProcessor ../support/edgeUtils ../support/symbolColorUtils ../../support/debugFlags ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/pbrUtils ../../../webgl/enums".split(" "),
function(da,E,K,ea,wa,fa,xa,T,B,x,C,ha,F,N,ia,ja,ya,za,Aa,O,P,Ba,U,Ca,V,L,W,Q,Da,Ea,Fa,Ga,ka,Ha,la,ma,D,y,X,Y,Ia,Ja,n,Ka,na,Z,aa){const La=["mesh"];ea=function(z){function G(a,b,c,d){a=z.call(this,a,b,c,d)||this;a._materialInfoCache=new ka.MaterialInfoCache;a._fastUpdateProcessor=new ka.MeshFastUpdateProcessor;a._textures=new Map;a.ensureDrapedStatus(!1);return a}E._inherits(G,z);var g=G.prototype;g.doLoad=async function(){ma.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new na.NativeLineMaterial({color:[1,
0,1,1]}),this._debugFaceNormalMaterial=new na.NativeLineMaterial({color:[0,1,1,1]}))};g.destroy=function(){E._get(E._getPrototypeOf(G.prototype),"destroy",this).call(this);this._context.stage.removeMany(this._materialInfoCache.materials);this._context.stage.removeMany(Array.from(this._textures.values()));this._materialInfoCache.clear();this._textures.clear();this._fastUpdateProcessor.destroy(this._context.stage)};g.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,
La,"fill on mesh-3d"))return null;const c=this.setGraphicElevationContext(b,new Da.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,c,b.uid)};g.onRemoveGraphic=function(a){this._fastUpdateProcessor.onRemoveGraphic(a,this._materialInfoCache,this._context)};g.layerOpacityChanged=function(a,b){const c=this._getLayerOpacity();this._updateMaterialParameters(d=>{d.material.setParameters({layerOpacity:c});const e=d.material.parameters;this._setMaterialTransparentParameter(e,d);d.material.setParameters({transparent:e.transparent})});
a.forEach(d=>{d=b(d);null!=d&&d.layerOpacityChanged(c,this._context.isAsync)})};g.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,Q.needsElevationUpdates3D)};g.slicePlaneEnabledChanged=function(a,b){this._updateMaterialParameters(({material:c})=>{c.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});a.forEach(c=>{c=b(c);null!=c&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};g.physicalBasedRenderingChanged=
function(){const a=this._usePBR();this._updateMaterialParameters(({material:b})=>b.setParameters({usePBR:a}));return!0};g.updateTransform=function(a,b,c,d){const e=this._context.renderCoordsHelper.spatialReference,f=Ma,{origin:h,transform:k}=c;F.computeTranslationToOriginAndRotation(b,x.set(p,h.x,h.y,h.z??0),f,e);switch(d){case U.MeshTransformUpdateAction.EnableFastUpdates:this._fastUpdateProcessor.enable(a,this._materialInfoCache,this._context);break;case U.MeshTransformUpdateAction.DisableFastUpdates:this._fastUpdateProcessor.disable(a,
this._materialInfoCache,this._context);break;case U.MeshTransformUpdateAction.UpdateFastLocalOrigin:a.updateFastLocalOrigin(f,k,this._context.localOriginFactory)}const {elevationContext:t}=a;t.centerPointInElevationSR=this._getCenterPointInElevationSR(f);const {elevationProvider:v,renderCoordsHelper:q}=this._context;a.alignedSampledElevation=W.perObjectElevationAligner(a,t,v.spatialReference,(l,w)=>Q.evaluateElevationInfoAtPoint(l,v,t,q,w),q,f);a.updateTransform(f,k,this._context.isAsync);return!0};
g._requiresSymbolVertexColors=function(){return this._drivenProperties.color||this._drivenProperties.opacity};g._colorOrTextureUid=function(a){return null==a?"-":a instanceof K?a.toHex():a.contentHash};g._materialPropertiesDefault=function(a,b){const c=this._requiresSymbolVertexColors(),d=!!a.vertexAttributes.color;a=!!a.vertexAttributes.tangent;return{hasSymbolVertexColors:c,hasVertexColors:d,hasVertexTangents:a,uid:`vc:${d},vt:${a},vct${b},svc:${c}`}};g._textureTransformUid=function(a){const {offset:b,
scale:c,rotation:d}=a??Na;return`${b[0]},${b[1]},${d},${c[0]},${c[1]}`};g._materialProperties=function(a,b,c){a=this._materialPropertiesDefault(a,c);if(!b.material)return a;const {color:d,colorTexture:e,colorTextureTransform:f,normalTexture:h,normalTextureTransform:k,doubleSided:t,alphaCutoff:v,alphaMode:q}=b.material;c=this._colorOrTextureUid(d);var l=this._colorOrTextureUid(e),w=this._textureTransformUid(f),r=this._colorOrTextureUid(h),m=this._textureTransformUid(k);a.color=d;a.colorTexture=e;a.normalTexture=
h;a.uid=`${a.uid},cmuid:${c},ctmuid:${l},cttuid:${w},ntmuid:${r},nttuid:${m},ds:${t},ac:${v},am:${q}`;if(b.material instanceof za){const {metallic:A,roughness:R,metallicRoughnessTexture:oa,metallicRoughnessTextureTransform:pa,emissiveColor:qa,emissiveTexture:ra,emissiveTextureTransform:sa,occlusionTexture:ta,occlusionTextureTransform:ua}=b.material;b=this._colorOrTextureUid(oa);c=this._textureTransformUid(pa);l=this._colorOrTextureUid(qa);w=this._colorOrTextureUid(ra);r=this._textureTransformUid(sa);
m=this._colorOrTextureUid(ta);const Oa=this._textureTransformUid(ua);a.metallic=A;a.roughness=R;a.metallicRoughnessTexture=oa;a.emissiveColor=qa;a.emissiveTexture=ra;a.occlusionTexture=ta;a.colorTextureTransform=this._convertTextureTransform(f);a.normalTextureTransform=this._convertTextureTransform(k);a.emissiveTextureTransform=this._convertTextureTransform(sa);a.occlusionTextureTransform=this._convertTextureTransform(ua);a.metallicRoughnessTextureTransform=this._convertTextureTransform(pa);a.uid=
`${a.uid},mrm:${A},mrr:${R},mrt:${b},mrtt:${c},emuid:${l},etmuid:${w},ett:${r},otmuid:${m},ott:${Oa}`}return a};g._convertTextureTransform=function(a){if(!a)return null;const {scale:b,offset:c,rotation:d}=a;return{scale:b,offset:c,rotation:wa.deg2rad(d)}};g._setInternalColorValueParameters=function(a,b){b.diffuse=K.toUnitRGB(a);b.opacity=a.a};g._getLoadableTextureResource=function(a){return a.data?a.data:a.url};g._getInternalTextureId=function(a){a=this._getInternalTexture(a,y.AlphaDiscardMode.Opaque);
return null!=a?a.id:null};g._getInternalTexture=function(a,b){const c=this._getLoadableTextureResource(a);if(!c)return null;const d=`${a.contentHash}/${b}`;let e=this._textures.get(d);e||(e=new Ja.Texture(V.isEncodedMeshTexture(c)?c.data:c,{mipmap:!0,wrap:this._castTextureWrap(a.wrap),noUnpackFlip:!0,preMultiplyAlpha:V.isEncodedMeshTexture(c)?!1:b!==y.AlphaDiscardMode.Opaque,encoding:V.isEncodedMeshTexture(c)&&null!=c.encoding?c.encoding:void 0}),this._textures.set(d,e),this._context.stage.add(e),
this._context.stage.loadImmediate(e));return e};g._castTextureWrap=function(a="repeat"){return"string"===typeof a?(a=this._castTextureWrapIndividual(a),{s:a,t:a}):{s:this._castTextureWrapIndividual(a.horizontal),t:this._castTextureWrapIndividual(a.vertical)}};g._castTextureWrapIndividual=function(a){switch(a){case "clamp":return aa.TextureWrapMode.CLAMP_TO_EDGE;case "mirror":return aa.TextureWrapMode.MIRRORED_REPEAT;default:return aa.TextureWrapMode.REPEAT}};g._setInternalMaterialParameters=function(a,
b){null!=a.color&&this._setInternalColorValueParameters(a.color,b);if(null!=a.colorTexture){const c=this._getInternalTexture(a.colorTexture,b.textureAlphaMode);null!=c?(b.textureId=c.id,b.textureAlphaPremultiplied=!!c.parameters.preMultiplyAlpha):b.textureId=void 0}null!=a.normalTexture&&(b.normalTextureId=this._getInternalTextureId(a.normalTexture));null!=a.emissiveColor&&(b.emissiveFactor=K.toUnitRGB(a.emissiveColor));null!=a.emissiveTexture&&(b.emissiveTextureId=this._getInternalTextureId(a.emissiveTexture));
null!=a.occlusionTexture&&(b.occlusionTextureId=this._getInternalTextureId(a.occlusionTexture));null!=a.metallicRoughnessTexture&&(b.metallicRoughnessTextureId=this._getInternalTextureId(a.metallicRoughnessTexture));b.colorTextureTransformMatrix=L.getTransformMatrix(a.colorTextureTransform);b.normalTextureTransformMatrix=L.getTransformMatrix(a.normalTextureTransform);b.occlusionTextureTransformMatrix=L.getTransformMatrix(a.occlusionTextureTransform);b.emissiveTextureTransformMatrix=L.getTransformMatrix(a.emissiveTextureTransform);
b.metallicRoughnessTextureTransformMatrix=L.getTransformMatrix(a.metallicRoughnessTextureTransform)};g._setExternalMaterialParameters=function(a){let b=null!=this.symbolLayer.material?this.symbolLayer.material.colorMixMode:null;if(this._drivenProperties.color)a.externalColor=ha.ONES;else{const c=null!=this.symbolLayer.material?this.symbolLayer.material.color:null;null!=c?a.externalColor=K.toUnitRGBA(c):(b=null,a.externalColor=ha.ONES)}b&&(a.colorMixMode=b);a.castShadows=!!this.symbolLayer.castShadows};
g._hasTransparentVertexColors=function(a){a=a.vertexAttributes.color;if(null==a)return!1;for(let b=3;b<a.length;b+=4)if(255!==a[b])return!0;return!1};g._getOrCreateMaterial=function(a,b){var c=b.material?.color,d=b.material?.colorTexture,e=b.material?.alphaMode;const f="blend"===e;c="opaque"!==e&&(this._hasTransparentVertexColors(a)||null!=c&&1>c.a||null!=d&&d.transparent||f);a=this._materialProperties(a,b,c);if(d=this._materialInfoCache.byUid(a.uid))return d.material;c={uid:a.uid,material:null,isComponentTransparent:c,
alphaMode:b.material?b.material.alphaMode:"opaque"};d=Z.useSchematicPBR({normalTexture:a.normalTexture,metallicRoughnessTexture:a.metallicRoughnessTexture,metallicFactor:a.metallic,roughnessFactor:a.roughness,emissiveTexture:a.emissiveTexture,emissiveFactor:K.toUnitRGB(a.emissiveColor),occlusionTexture:a.occlusionTexture});e={usePBR:this._usePBR(),isSchematic:d,hasVertexColors:a.hasVertexColors,hasSymbolColors:a.hasSymbolVertexColors,hasVertexTangents:a.hasVertexTangents,ambient:C.ZEROS,diffuse:C.ONES,
opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:y.CullFaceOptions.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};e.mrrFactors=d?[...Z.defaultSchematicMRRFactors]:[a.metallic,a.roughness,Z.defaultAdvancedMRRFactors[2]];b.material&&(e.doubleSided=b.material.doubleSided,e.cullFace=b.material.doubleSided?y.CullFaceOptions.None:y.CullFaceOptions.Back,e.textureAlphaCutoff=b.material.alphaCutoff);this._setExternalMaterialParameters(e);
this._setMaterialTransparentParameter(e,c);this._setInternalMaterialParameters(a,e);b=new Ka.DefaultMaterial(e);c.material=b;this._materialInfoCache.set(a.uid,c);this._context.stage.add(b);return b};g._usePBR=function(){return this._context.physicalBasedRenderingEnabled};g._setMaterialTransparentParameter=function(a,b){a.transparent=this.needsDrivenTransparentPass||b.isComponentTransparent||1>a.layerOpacity||1>a.opacity||a.externalColor&&1>a.externalColor[3];a.textureAlphaMode="auto"===b.alphaMode?
a.transparent?y.AlphaDiscardMode.MaskBlend:y.AlphaDiscardMode.Opaque:"opaque"===b.alphaMode?y.AlphaDiscardMode.Opaque:"mask"===b.alphaMode?y.AlphaDiscardMode.Mask:y.AlphaDiscardMode.Blend};g._addDebugNormals=function(a,b){var c=b.length,d=a.spatialReference.isGeographic?20015077/180:1;const e=.1*Math.max(a.extent.width*d,a.extent.height*d,a.extent.zmax-a.extent.zmin);var f=[];const h=[];a=[];d=[];for(let w=0;w<c;w++){var k=b[w],t=k.vertexAttributes.get(n.VertexAttribute.POSITION),v=k.vertexAttributes.get(n.VertexAttribute.NORMAL);
const r=k.indices.get(n.VertexAttribute.POSITION);k=k.indices.get(n.VertexAttribute.NORMAL);t=t.data;v=v.data;for(let m=0;m<r.length;m++){var q=3*r[m];const A=3*k[m];for(var l=0;3>l;l++)f.push(t[q+l]);for(l=0;3>l;l++)f.push(t[q+l]+v[A+l]*e);h.push(h.length);h.push(h.length);if(0===m%3){this._calculateFaceNormal(t,r,m,H);this._getFaceVertices(t,r,m,p,I,J);x.add(p,p,I);x.add(p,p,J);x.scale(p,p,1/3);for(q=0;3>q;q++)a.push(p[q]);for(q=0;3>q;q++)a.push(p[q]+H[q]*e);d.push(d.length);d.push(d.length)}}}c=
b[0].transformation;f=new Y.Geometry(this._debugVertexNormalMaterial,[[n.VertexAttribute.POSITION,new D.Attribute(f,3,!0)]],[[n.VertexAttribute.POSITION,h]],null,X.ContentObjectType.Line);b.push(f);f.transformation=c;a=new Y.Geometry(this._debugFaceNormalMaterial,[[n.VertexAttribute.POSITION,new D.Attribute(a,3,!0)]],[[n.VertexAttribute.POSITION,d]],null,X.ContentObjectType.Line);a.transformation=c;b.push(a)};g._createAs3DShape=function(a,b,c,d){a=a.geometry;if("mesh"!==a.type)return null;b=this._createGeometryInfo(a,
b,d);if(null==b)return null;const {geometries:e,objectTransformation:f}=b;ma.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,e);d=new Ia.Object3D({geometries:e,layerUid:this._context.layer.uid,graphicUid:d});d.transformation=f;b=Ha.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});b=null!=b?new Fa.Object3DEdgeState(e[0].material,[b],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null;b=new Ea.Graphics3DMeshObject3DGraphicLayer(this,d,e,null,null,W.perObjectElevationAligner,
c,b);this._fastUpdateProcessor.onAddGraphic();b.needsElevationUpdates=Q.needsElevationUpdates3D(c.mode);b.useObjectOriginAsAttachmentOrigin=!0;c.centerPointInElevationSR=this._getCenterPointInElevationSR(d.transformation);const {elevationProvider:h,renderCoordsHelper:k}=this._context;b.alignedSampledElevation=W.perObjectElevationAligner(b,c,h.spatialReference,(t,v)=>Q.evaluateElevationInfoAtPoint(t,h,c,k,v),k);return b};g._getCenterPointInElevationSR=function(a){const b=Ba.makeDehydratedPoint(0,0,
0,null!=this._context.elevationProvider.spatialReference?this._context.elevationProvider.spatialReference:null);F.projectVectorToDehydratedPoint([a[12],a[13],a[14]],this._context.renderCoordsHelper.spatialReference,b);return b};g._createComponentNormals=function(a,b,c,d){switch(c.shading||"flat"){default:case "source":return this._createComponentNormalsSource(a,b,c,d);case "flat":return this._createComponentNormalsFlat(a,d);case "smooth":return this._createComponentNormalsSmooth(a,d)}};g._createComponentNormalsSource=
function(a,b,c,d){if(null==b)return this._createComponentNormalsFlat(a,d);let e=!1;if(!c.trustSourceNormals)for(c=0;c<d.length;c+=3){this._calculateFaceNormal(a,d,c,H);for(let f=0;3>f;f++){const h=3*d[c+f];p[0]=b[h];p[1]=b[h+1];p[2]=b[h+2];0>x.dot(H,p)&&(b[h]=-b[h],b[h+1]=-b[h+1],b[h+2]=-b[h+2],e=!0)}}return new ba(b,d,e)};g._createComponentNormalsFlat=function(a,b){const c=ia.newFloatArray(b.length),d=Array(3*b.length);for(let e=0;e<b.length;e+=3){const f=this._calculateFaceNormal(a,b,e,H);for(let h=
0;3>h;h++)c[e+h]=f[h],d[e+h]=e/3}return new ba(c,d,!1)};g._createComponentNormalsSmooth=function(a,b){const c={};for(var d=0;d<b.length;d+=3){var e=this._calculateFaceNormal(a,b,d,H);for(var f=0;3>f;f++){var h=b[d+f];let k=c[h];k||(k={normal:C.create(),count:0},c[h]=k);x.add(k.normal,k.normal,e);k.count++}}a=ia.newFloatArray(3*b.length);d=Array(3*b.length);for(e=0;e<b.length;e++){f=c[b[e]];1!==f.count&&(x.normalize(f.normal,f.normal),f.count=1);for(h=0;3>h;h++)a[3*e+h]=f.normal[h];d[e]=e}return new ba(a,
d,!1)};g._getFaceVertices=function(a,b,c,d,e,f){const h=3*b[c],k=3*b[c+1];b=3*b[c+2];d[0]=a[h];d[1]=a[h+1];d[2]=a[h+2];e[0]=a[k];e[1]=a[k+1];e[2]=a[k+2];f[0]=a[b];f[1]=a[b+1];f[2]=a[b+2]};g._calculateFaceNormal=function(a,b,c,d){this._getFaceVertices(a,b,c,p,I,J);x.subtract(I,I,p);x.subtract(J,J,p);x.cross(p,I,J);x.normalize(d,p);return d};g._getOrCreateComponents=function(a){return a.components??Pa};g._createPositionBuffer=function(a,b){let c=a.vertexAttributes.position;const d=b.reprojection===
u.ECEF?b.transformBeforeProject:null;null!=d&&(c=O.transformMat4(new Float64Array(c.length),c,d));if(b.reprojection===u.NONE)return b.needsBufferCopy?new Float64Array(c):c;b=null!=d?c:new Float64Array(c.length);F.projectBuffer(c,a.spatialReference,0,b,this._context.renderCoordsHelper.spatialReference,0,c.length/3);return b};g._createNormalBuffer=function(a,b,c){let d=a.vertexAttributes.normal;if(null==d)return null;var e=c.reprojection===u.ECEF?c.transformBeforeProject:null;null!=e&&(d=P.transformNormal(d,
new Float32Array(d.length),e));if("local"===this._context.graphicsCoreOwner.view.viewingMode||c.reprojection===u.NONE)return c.needsBufferCopy&&a.vertexAttributes.normal===d?new Float32Array(d):d;c=a.vertexAttributes.position;e=null!=e?d:new Float32Array(d.length);return P.projectNormalToPCPF(d,c,b,a.spatialReference,e)};g._createTangentBuffer=function(a,b,c){let d=a.vertexAttributes.tangent;if(null==d)return null;var e=c.reprojection===u.ECEF?c.transformBeforeProject:null;null!=e&&(d=P.transformTangent(d,
new Float32Array(d.length),e));if("local"===this._context.graphicsCoreOwner.view.viewingMode||c.reprojection===u.NONE)return c.needsBufferCopy&&a.vertexAttributes.normal===d?new Float32Array(d):d;c=a.vertexAttributes.position;e=null!=e?d:new Float32Array(d.length);return P.projectTangentToPCPF(d,c,b,a.spatialReference,e)};g._createColorBuffer=function(a){return a.vertexAttributes.color};g._createSymbolColorBuffer=function(a){if(this._requiresSymbolVertexColors()){a=this._getVertexOpacityAndColor(a);
const b=la.parseColorMixMode(this.symbolLayer?.material?.colorMixMode),c=new Uint8Array(4);la.encodeSymbolColor(a,b,c);return c}return null};g._createBuffers=function(a,b){var c=a.vertexAttributes&&a.vertexAttributes.position;if(!c)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var d=a.vertexAttributes.normal;const e=a.vertexAttributes.uv;var f=a.vertexAttributes.tangent;if(null!=d&&d.length!==c.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),
null;if(null!=f&&f.length/4!==c.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(null!=e&&e.length/2!==c.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;f=this._computeReprojectionInfo(a);c=this._createPositionBuffer(a,f);d=this._createColorBuffer(a);b=this._createSymbolColorBuffer(b);const h=this._createNormalBuffer(a,c,f),k=this._createTangentBuffer(a,
c,f);a=f.reprojection===u.NONE&&null!=f.objectTransformation?f.objectTransformation:this._transformOriginLocal(a,c,h,k);f=f.reprojection===u.NONE&&null!=f.geometryTransformation?f.geometryTransformation:B.create();return{positionBuffer:c,normalBuffer:h,tangentBuffer:k,uvBuffer:e,colorBuffer:d,symbolColorBuffer:b,objectTransformation:a,geometryTransformation:f}};g._computeReprojectionInfo=function(a){var {vertexSpace:b}=a;const c=b.isGeoreferenced?this._context.renderCoordsHelper.viewingMode===Ca.ViewingMode.Local?
u.NONE:u.ECEF:u.NONE;if(b.isRelative){const {origin:d}=b;b=B.create();const e=a.transform?.localMatrix??B.IDENTITY;if(c===u.NONE)return F.computeTranslationToOriginAndRotation(a.spatialReference,d,b,this._context.renderCoordsHelper.spatialReference),a=B.clone(e),{reprojection:c,objectTransformation:b,geometryTransformation:a,needsBufferCopy:!1};a=T.fromTranslation(B.create(),d);T.multiply(a,a,e);return{reprojection:c,transformBeforeProject:a,needsBufferCopy:!0}}return{reprojection:c,needsBufferCopy:!0}};
g._transformOriginLocal=function(a,b,c,d){const e=this._context.renderCoordsHelper.spatialReference;var f=a.anchor;S[0]=f.x;S[1]=f.y;S[2]=f.z??0;f=B.create();F.computeTranslationToOriginAndRotation(a.spatialReference,S,f,e);T.invert(va,f);O.transformMat4(b,b,va);if(null!=c||null!=d)fa.fromMat4(M,f),fa.transpose(M,M),null!=c&&O.transformMat3(c,c,M),null!=d&&O.transformMat3(d,d,M,4);return f};g._validateFaces=function(a,b){a=a.vertexAttributes.position.length/3;if(b=b.faces){let c=-1;for(let d=0;d<
b.length;d++){const e=b[d];e>c&&(c=e)}if(a<=c)return this.logger.warn(`Vertex index ${c} is out of bounds of the mesh position buffer`),!1}else if(0!==a%3)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0};g._getOrCreateFaces=function(a,b){return b.faces??ja.getContinuousIndexArray(a.vertexAttributes.position.length/3)};g._isOutsideClippingArea=function(a){if(!this._context.clippingExtent)return!1;
var b=a.vertexAttributes&&a.vertexAttributes.position;if(!b)return!1;const c=this._context.elevationProvider.spatialReference,d=b.length/3;null==c||a.spatialReference.equals(c)||(b=new Float64Array(b.length),F.projectBuffer(a.vertexAttributes.position,a.spatialReference,0,b,c,0,d));N.empty(ca);N.expandWithBuffer(ca,b,0,d);return!N.intersectsClippingArea(ca,this._context.clippingExtent)};g._createGeometryInfo=function(a,b,c){if(!F.canProjectWithoutEngine(a.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),
null;if(this._isOutsideClippingArea(a))return null;b=this._createBuffers(a,b);if(null==b)return null;const {positionBuffer:d,uvBuffer:e,colorBuffer:f,symbolColorBuffer:h,normalBuffer:k,tangentBuffer:t,objectTransformation:v,geometryTransformation:q}=b;var l=this._getOrCreateComponents(a);b=[];let w=!1;for(const A of l){if(!this._validateFaces(a,A))return null;var r=this._getOrCreateFaces(a,A);if(0===r.length)continue;var m=this._createComponentNormals(d,k,A,r);m.didFlipNormals&&(w=!0);l=[[n.VertexAttribute.POSITION,
new D.Attribute(d,3,!0)],[n.VertexAttribute.NORMAL,new D.Attribute(m.normals,3,!0)]];m=[[n.VertexAttribute.POSITION,r],[n.VertexAttribute.NORMAL,m.indices]];null!=f&&(l.push([n.VertexAttribute.COLOR,new D.Attribute(f,4,!0)]),m.push([n.VertexAttribute.COLOR,r]));null!=h&&(l.push([n.VertexAttribute.SYMBOLCOLOR,new D.Attribute(h,4,!0)]),m.push([n.VertexAttribute.SYMBOLCOLOR,ja.getZeroIndexArray(r.length)]));null!=e&&(l.push([n.VertexAttribute.UV0,new D.Attribute(e,2,!0)]),m.push([n.VertexAttribute.UV0,
r]));null!=t&&(l.push([n.VertexAttribute.TANGENT,new D.Attribute(t,4,!0)]),m.push([n.VertexAttribute.TANGENT,r]));r=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:c,layerUid:this._context.layer.uid});const R=this._getOrCreateMaterial(a,A);l=new Y.Geometry(R,l,m,null,X.ContentObjectType.Mesh,r);l.transformation=q;b.push(l)}w&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.");
return{geometries:b,objectTransformation:v}};g._updateMaterialParameters=function(a){this._materialInfoCache.forEachMaterialInfo(a);this._fastUpdateProcessor.forEachMaterialInfo(a);this._fastUpdateProcessor.forEachClonedMaterial((b,c)=>{c.setParameters(b.parameters)})};g.test=function(){return{...E._get(E._getPrototypeOf(G.prototype),"test",this).call(this),materials:this._materialInfoCache.materials}};return E._createClass(G)}(Ga.Graphics3DSymbolLayer);let ba=E._createClass(function(z,G,g){this.normals=
z;this.indices=G;this.didFlipNormals=g});const S=C.create(),p=C.create(),I=C.create(),J=C.create(),H=C.create(),va=B.create(),M=xa.create(),Ma=B.create(),ca=N.create(),Pa=[new ya],Na=new Aa;var u;(function(z){z[z.NONE=0]="NONE";z[z.ECEF=1]="ECEF"})(u||(u={}));da.Graphics3DMeshFillSymbolLayer=ea;Object.defineProperty(da,Symbol.toStringTag,{value:"Module"})});
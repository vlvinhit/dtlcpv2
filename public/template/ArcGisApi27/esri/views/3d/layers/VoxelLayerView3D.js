// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/Logger ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/spatialReferenceUtils ./LayerView3D ./support/PopupSceneLayerView ../../layers/LayerView ../../../geometry/SpatialReference".split(" "),
function(u,p,m,n,v,h,r,H,I,J,A,t,w,B,x,C,D,E,F,G){var e;(function(k){k[k.API=1]="API";k[k.VerboseAPI=2]="VerboseAPI";k[k.Error=3]="Error"})(e||(e={}));const l=w.create(),y=w.create();m=function(k){function q(){var a=k.apply(this,arguments)||this;a._suspendedHandle=null;a._usedMemory=0;a._futureMemory=0;a.type="voxel-3d";a.slicePlaneEnabled=!1;a._wasmLayerId=-1;a.ignoresMemoryFactor=!0;a._dbgFlags=new Set;return a}u._inherits(q,k);var f=q.prototype;f.initialize=function(){this._dbgFlags.add(e.Error);
if("local"!==this.view.viewingMode)throw new n("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if(!this.view._stage.renderView.renderingContext.capabilities.colorBufferFloat?.textureFloat)throw new n("voxel:missing-color-buffer-float","Voxel layers require the WebGL2 extension EXT_color_buffer_float",{});if(!C.equals(this.layer.spatialReference,this.view.spatialReference))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",
{});var a=this.layer.currentVariableId,b=this.layer.getVolume(a);a=this.layer.getVariable(a);if(null!=b&&null!=a){var c=b.dimensions[0];const g=b.dimensions[1],d=b.zDimension;if(1<d){b=c.size*g.size*b.dimensions[d].size;c=1;switch(a.renderingFormat.type){case "Int16":case "UInt16":c=2;break;case "Int32":case "UInt32":case "Float32":c=4}this._futureMemory=c*b}}a=this.view.addVoxelLayerViewToWasm(this).then(g=>{this._wasmLayerId=g;this._suspendedHandle=h.watch(()=>this.suspended,d=>{const z=this.view.voxelWasm;
null!=z&&z.setEnabled(this,!d)},h.initial);this.handles.add([h.watch(()=>this.layer.renderMode,d=>this._pushRenderModeToWasm(d)),h.watch(()=>this.layer.currentVariableId,d=>this._pushCurrentVariableIdToWasm(d)),h.watch(()=>this.layer.getSections(),d=>this._pushSectionsToWasm(d)),h.watch(()=>this.layer.getVariableStyles(),d=>this._pushVariableStylesToWasm(d)),h.watch(()=>this.layer.getVolumeStyles(),d=>this._pushVolumeStylesToWasm(d)),h.watch(()=>this.layer.enableDynamicSections,d=>this._pushEnableDynamicSectionsToWasm(d)),
h.watch(()=>this.layer.enableIsosurfaces,d=>this._pushEnableIsosurfacesToWasm(d)),h.watch(()=>this.layer.enableSections,d=>this._pushEnableSectionsToWasm(d)),h.watch(()=>this.layer.enableSlices,d=>this._pushEnableSlicesToWasm(d)),h.watch(()=>this.slicePlaneEnabled,d=>this._pushAnalysisSliceToWasm(d,this.view.slicePlane)),h.watch(()=>this.view.slicePlane,d=>this._pushAnalysisSliceToWasm(this.slicePlaneEnabled,d))])}).catch(g=>{this.view.removeVoxelLayerViewFromWasm(this);this._wasmLayerId=-1;if(-1===
g)throw new n("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===g)throw new n("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{});});this.addResolvingPromise(a)};f.destroy=function(){this.view.removeVoxelLayerViewFromWasm(this);this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)};f.isUpdating=function(){const a=this.view.voxelWasm;return 0>this._wasmLayerId||null==a?!1:a.isUpdating(this._wasmLayerId)};
f.updatingFlagChanged=function(){this.notifyChange("updating")};f.whenGraphicBounds=function(a,b){if(b=a.attributes["Voxel.WorldPosition"])if(a=x.empty(),b=JSON.parse(b),B.projectVectorToVector(b,this.view.renderSpatialReference,y,this.view.spatialReference||G.WGS84))return x.expandWithVec3(a,y),Promise.resolve({boundingBox:a,screenSpaceObjects:[]});return Promise.reject()};f.setUsedMemory=function(a){this._usedMemory=a;this._futureMemory=0};f.captureFrustum=function(){const a=this.view.voxelWasm;
null!=a&&a.captureFrustum()};f.toggleFullVolumeExtentDraw=function(){const a=this.view.voxelWasm;null!=a&&a.toggleFullVolumeExtentDraw(this)};f.getLayerTimes=function(){let a=[];const b=this.view.voxelWasm;null!=b&&(a=b.getLayerTimes(this));return a};f.getCurrentLayerTimeIndex=function(){let a=0;const b=this.view.voxelWasm;null!=b&&(a=b.getCurrentLayerTimeIndex(this));return a};f._pushRenderModeToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushRenderModeToWasm() called, ${b?
"have WASM":"don't have WASM!!!"}`);null!=b&&b.setRenderMode(this,a)||this._dbg(e.Error,"VoxelLayerView3D._pushRenderModeToWasm() failed!")};f._pushSectionsToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushSectionsToWasm() called, ${b?"have WASM":"don't have WASM!!!"}`);null!=b&&b.setStaticSections(this,a)||this._dbg(e.Error,"VoxelLayerView3D._pushSectionsToWasm() failed!")};f._pushCurrentVariableIdToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,
`VoxelLayerView3D._pushCurrentVariableIdToWasm() called!, ${null!=b?"have WASM":"don't have WASM!!!"}`);null!=b&&b.setCurrentVariable(this,a)||this._dbg(e.Error,"VoxelLayerView3D._pushCurrentVariableIdToWasm() failed!")};f._pushVariableStylesToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushVariableStylesToWasm() called, ${b?"have WASM":"don't have WASM!!!"}`);let c=!1;null!=b&&((c=b.setVariableStyles(this,a))||this._dbg(e.Error,"VoxelLayerView3D._pushVariableStylesToWasm() failed!"))};
f._accountForEnableSlices=function(a,b){b=null!=b?b:this.layer.enableSlices;for(let c=0;c<a.length;++c){const g=a[c];for(const d of g.slices)d.enabled=d.enabled&&b}};f._pushVolumeStylesToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushVolumeStylesToWasm() called, ${b?"have WASM":"don't have WASM!!!"}`);let c=!1;null!=b&&(this._accountForEnableSlices(a,null),(c=b.setVolumeStyles(this,a))||this._dbg(e.Error,"VoxelLayerView3D._pushVolumeStylesToWasm() failed!"))};
f._pushAnalysisSliceToWasm=function(a,b){const c=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushAnalysisSliceToWasm() called, ${c?"have WASM":"don't have WASM!!!"}`);var g=!1;null!=c&&(null!=b?(g=b.origin,t.cross(l,b.basis1,b.basis2),t.normalize(l,l),g=c.setAnalysisSlice(this,a,g,l)):(t.set(l,0,0,1),g=c.setAnalysisSlice(this,!1,l,l)),g||this._dbg(e.Error,"VoxelLayerView3D._pushAnalysisSliceToWasm() failed!"))};f._pushEnableDynamicSectionsToWasm=function(a){const b=this.view.voxelWasm;
this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushEnableDynamicSectionsToWasm() called, ${null!=b?"have WASM":"don't have WASM!!!"}`);let c=!1;null!=b&&((c=b.setEnableDynamicSections(this,a))||this._dbg(e.Error,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() failed!"))};f._pushEnableSlicesToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushEnableSlicesToWasm() called, ${b?"have WASM":"don't have WASM!!!"}`);var c=!1;null!=b&&(c=this.layer.getVolumeStyles(),
this._accountForEnableSlices(c,a),(c=b.setVolumeStyles(this,c))||this._dbg(e.Error,"VoxelLayerView3D._pushEnableSlicesToWasm() failed!"))};f._pushEnableIsosurfacesToWasm=function(a){const b=this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushEnableIsosurfacesToWasm() called, ${null!=b?"have WASM":"don't have WASM!!!"}`);let c=!1;null!=b&&((c=b.setEnableIsosurfaces(this,a))||this._dbg(e.Error,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() failed!"))};f._pushEnableSectionsToWasm=function(a){const b=
this.view.voxelWasm;this._dbg(e.VerboseAPI,`VoxelLayerView3D._pushEnableSectionsToWasm() called, ${b?"have WASM":"don't have WASM!!!"}`);let c=!1;null!=b&&((c=b.setEnableSections(this,a))||this._dbg(e.Error,"VoxelLayerView3D._pushEnableSectionsToWasm() failed!"))};f.whenGraphicAttributes=async function(a,b){return a};f._dbg=function(a,b){this._dbgFlags.has(a)&&(a===e.Error?v.getLogger(this).error(b):v.getLogger(this).warn(b))};u._createClass(q,[{key:"baseUrl",get:function(){return this.layer.parsedUrl?.path??
""}},{key:"wasmLayerId",get:function(){return this._wasmLayerId}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"unloadedMemory",get:function(){return this._futureMemory}},{key:"performanceInfo",get:function(){return{nodes:0,displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null}}}]);return q}(E.PopupSceneLayerView(D.LayerView3D(F)));p.__decorate([r.property()],m.prototype,"layer",void 0);p.__decorate([r.property()],m.prototype,"baseUrl",null);p.__decorate([r.property({type:Boolean})],
m.prototype,"slicePlaneEnabled",void 0);return m=p.__decorate([A.subclass("esri.views.3d.layers.VoxelLayerView3D")],m)});
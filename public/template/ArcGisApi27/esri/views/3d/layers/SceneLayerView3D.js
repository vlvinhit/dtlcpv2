// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Logger ../../../core/maybe ../../../core/ReactiveSet ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/sql/WhereClause ../../../layers/support/FeatureFilter ../../../layers/support/floorFilterUtils ../../../rest/support/Query ../../../support/featureFlags ./I3SMeshView3D ./II3SMeshView3D ./LayerView3D ./i3s/featureEditing ./i3s/I3SGeometryUtil ./i3s/I3SMeshViewFilter ./i3s/I3SNode ./i3s/I3SOverrides ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ./support/PopupSceneLayerView ./support/SceneLayerViewRequiredFields ../support/updatingProperties ../../layers/SceneLayerView ../../layers/support/popupUtils ../../support/Scheduler".split(" "),
function(l,g,y,z,A,B,u,h,p,W,X,C,D,E,F,q,r,d,G,H,t,I,v,w,J,K,L,M,n,N,O,P,Q,R,S,T,U){p=O.defineFieldProperties();d=function(x){function m(){var a=x.apply(this,arguments)||this;a.type="scene-layer-3d";a._setVisibilityHiddenObjectIds=new B;a.progressiveLoadFactor=1;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!0;a._interactiveEditingSessions=new Map;a._queryEngine=null;return a}l._inherits(m,x);var c=m.prototype;c.tryRecycleWith=function(a,b){return a.url===this.layer.url&&
this.i3sOverrides.isEmpty?a.load(b).then(()=>{n.checkRecyclable(this.layer,a,this.i3sOverrides);this.layer=a;this.i3sOverrides.destroy();this.i3sOverrides=new J.I3SOverrides({view:this.view,layer:a,memoryController:this.view.resourceController?.memoryController});this.resetHighlights()}):null};c.initialize=function(){this._fieldsHelper=new Q.SceneLayerViewRequiredFields({layerView:this});this.updatingHandles.add(()=>this.layer.rangeInfos,b=>this._rangeInfosChanged(b),u.initial);this.updatingHandles.add(()=>
this.layer.renderer,b=>this.updatingHandles.addPromise(this._rendererChange(b)),u.initial);const a=()=>this._filterChange();this.updatingHandles.add(()=>this.parsedDefinitionExpression,a);this.updatingHandles.add(()=>this.filter,a);this.updatingHandles.add(()=>this._floorFilterClause,a);this.updatingHandles.add(()=>this._excludeObjectIdsSorted,a);this.updatingHandles.add(()=>this._setVisibilityHiddenObjectIdsSorted,a);this.updatingHandles.add(()=>null!=this.viewFilter?this.viewFilter.sortedObjectIds:
null,a);this.updatingHandles.add(()=>null!=this.viewFilter?this.viewFilter.parsedWhereClause:null,a);this.updatingHandles.add(()=>[null!=this.viewFilter?this.viewFilter.parsedGeometry:null,null!=this.filter?this.filter.spatialRelationship:null,null!=this.layer.filter?this.layer.filter.spatialRelationship:null],()=>this._geometryFilterChange());r.sceneLayerEditingEnabled()&&this.i3sOverrides.is3DOFL&&this.updatingHandles.add(()=>this.i3sOverrides.sortedGeometryChangedObjectIds,a);this.handles.add(this.layer.on("apply-edits",
b=>this.updatingHandles.addPromise(b.result)));this.handles.add(this.layer.on("edits",b=>this._handleEdits(b)))};c.destroy=function(){this._fieldsHelper=A.destroyMaybe(this._fieldsHelper)};c._rangeInfosChanged=function(a){null!=a&&0<a.length&&z.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};c.createQuery=function(){const a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};
return null!=this.filter?this.filter.createQuery(a):new q(a)};c.queryExtent=function(a,b){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a),b?.signal)};c.queryFeatureCount=function(a,b){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a),b?.signal)};c.queryFeatures=function(a,b){return this._ensureQueryEngine().executeQuery(this._ensureQuery(a),b?.signal).then(e=>{if(!e?.features)return e;const f=this.layer;for(const k of e.features)k.layer=f,k.sourceLayer=
f;return e})};c.queryObjectIds=function(a,b){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a),b?.signal)};c._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c._createQueryEngine=function(){const a=I.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new K.I3SQueryEngine({layerView:this,priority:U.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new M.I3SQueryFeatureStore({featureAdapter:new L.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,
attributeStorageInfo:this.layer.attributeStorageInfo??[],getFeatureExtent:a}),forAllFeatures:(b,e)=>this._forAllFeatures((f,k,V)=>b({id:f,index:k,meta:V}),e,G.ForAllFeaturesMode.QUERYABLE),getFeatureExtent:a,sourceSpatialReference:n.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};c.highlight=function(a){const b=this._highlights;if(a instanceof q){const {set:e,handle:f}=b.acquireSet();this.queryObjectIds(a).then(k=>b.setFeatureIds(e,k));return f}return l._get(l._getPrototypeOf(m.prototype),
"highlight",this).call(this,a)};c.createInteractiveEditSession=function(a){return t.createInteractiveEditSession(this._attributeEditingContext,a)};c._createLayerGraphic=function(a){a=new y(null,null,a);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.getFilters=function(){const a=l._get(l._getPrototypeOf(m.prototype),"getFilters",this).call(this);r.sceneLayerEditingEnabled()&&this.i3sOverrides.is3DOFL&&0<this.i3sOverrides.sortedGeometryChangedObjectIds.length&&a.push((f,k)=>{0<=k.node.index&&
n.objectIdFilter(this.i3sOverrides.sortedGeometryChangedObjectIds,!1,f)});const b=this._setVisibilityHiddenObjectIdsSorted;null!=b&&a.push(f=>n.objectIdFilter(b,!1,f));const e=this._excludeObjectIdsSorted;null!=e&&a.push(f=>n.objectIdFilter(e,!1,f));this._floorFilterClause&&this.addSqlFilter(a,this._floorFilterClause,this.logError);this.addSqlFilter(a,this.parsedDefinitionExpression,this.logError);null!=this.viewFilter&&this.viewFilter.addFilters(a,this.view,this._controller.crsIndex,this._collection);
return a};c.setVisibility=function(a,b){b?this._setVisibilityHiddenObjectIds.delete(a):this._setVisibilityHiddenObjectIds.add(a)};c.isUpdating=function(){return l._get(l._getPrototypeOf(m.prototype),"isUpdating",this).call(this)||this.layerFilterUpdating||null!=this.viewFilter&&this.viewFilter.updating||null!=this.i3sOverrides&&this.i3sOverrides.updating};c._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(null==a?this.createQuery():q.from(a))};c._handleEdits=function(a){r.sceneLayerEditingEnabled()&&
t.processGeometryEdits(this._attributeEditingContext,a);t.processAttributeEdits(this._attributeEditingContext,a)};c.computeNodeFiltering=function(a){const b=this.viewFilter;return null==b||!this.view.spatialReference||b.isMBSGeometryVisible(a,this.view.spatialReference,this._controller.crsIndex)?w.NodeFilterImpact.Unmodified:w.NodeFilterImpact.Culled};l._createClass(m,[{key:"i3slayer",get:function(){return this.layer}},{key:"layerPopupEnabledAndHasTemplate",get:function(){return this.layer.popupEnabled&&
T.hasPopupTemplate(this.layer,this.view.popup?.defaultPopupTemplateEnabled)}},{key:"filter",get:function(){return this._get("filter")},set:function(a){this._set("filter",v.I3SMeshViewFilter.checkSupport(a)?a:null)}},{key:"viewFilter",get:function(){const a=this.filter,b=this.layerFilter;if(null==a&&null==b)return null;const e=this._get("viewFilter");if(null==e)return new v.I3SMeshViewFilter({layerFilter:b,viewFilter:a,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:f=>this._loadAsyncModule(f),
addSqlFilter:(f,k)=>this.addSqlFilter(f,k,this.logError)});e.viewFilter=a;e.layerFilter=b;return e}},{key:"requiredFields",get:function(){return this._fieldsHelper?.requiredFields??[]}},{key:"_floorFilterClause",get:function(){const a=F.getFloorFilterClause(this);return null!=a?D.WhereClause.create(a,this.layer.fieldsIndex):null}},{key:"_excludeObjectIdsSorted",get:function(){const a=this.layer.excludeObjectIds.toArray();return a.length?a.sort((b,e)=>b-e):null}},{key:"_setVisibilityHiddenObjectIdsSorted",
get:function(){return this._setVisibilityHiddenObjectIds.size?Array.from(this._setVisibilityHiddenObjectIds).sort((a,b)=>a-b):null}},{key:"_objectQualitySettings",get:function(){return this.view?.qualitySettings?.sceneService?.object}},{key:"lodFactor",get:function(){return this._objectQualitySettings?.lodFactor??1}},{key:"lodCrossfadeinDuration",get:function(){return this._objectQualitySettings.lodCrossfadeinDuration??0}},{key:"lodCrossfadeoutDuration",get:function(){return this._objectQualitySettings.lodCrossfadeoutDuration??
0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return this._objectQualitySettings.lodCrossfadeUncoveredDuration??0}},{key:"updatingProgressValue",get:function(){return this._controller?.updatingProgress??0}},{key:"_attributeEditingContext",get:function(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),globalIdField:this._getGlobalIdField(),forEachNode:a=>this._forAllNodes(b=>null!=b?a(b.node,b.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo??
[],i3sOverrides:this.i3sOverrides,getAttributeData:a=>this.getAttributeData(a),setAttributeData:(a,b)=>this.setAttributeData(a,b),clearMemCache:()=>this.clearMemCache()}}},{key:"hasGeometryFilter",get:function(){const a=this.viewFilter;return null!=a&&null!=a.parsedGeometry}}]);return m}(d.I3SMeshView3D(N.DefinitionExpressionSceneLayerView(P.PopupSceneLayerView(H.LayerView3D(S)))));g.__decorate([h.property()],d.prototype,"i3slayer",null);g.__decorate([h.property(R.updatingProgress)],d.prototype,"updatingProgress",
void 0);g.__decorate([h.property({type:E})],d.prototype,"filter",null);g.__decorate([h.property({readOnly:!0})],d.prototype,"viewFilter",null);g.__decorate([h.property(p.requiredFields)],d.prototype,"requiredFields",null);g.__decorate([h.property(p.availableFields)],d.prototype,"availableFields",void 0);g.__decorate([h.property()],d.prototype,"_fieldsHelper",void 0);g.__decorate([h.property()],d.prototype,"_floorFilterClause",null);g.__decorate([h.property()],d.prototype,"_excludeObjectIdsSorted",
null);g.__decorate([h.property()],d.prototype,"_setVisibilityHiddenObjectIds",void 0);g.__decorate([h.property()],d.prototype,"_setVisibilityHiddenObjectIdsSorted",null);g.__decorate([h.property()],d.prototype,"_objectQualitySettings",null);g.__decorate([h.property()],d.prototype,"lodFactor",null);g.__decorate([h.property()],d.prototype,"updatingProgressValue",null);return d=g.__decorate([C.subclass("esri.views.3d.layers.SceneLayerView3D")],d)});
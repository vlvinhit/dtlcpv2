// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/asyncUtils ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ../graphics/QueryEngine ../../../support/Scheduler".split(" "),
function(b,m,d,p,q,r,k,t,u,e,B,C,D,v,w,x,y,z){b.FeatureVisibilityFilter=function(n){function l(g){var a=n.call(this,g)||this;a._updateTask=null;a._frameTask=null;a._queryEngine=null;a._updateRequested=!0;a._updateVisibility=async f=>{if(null==a._compositedFeatureFilter&&null==a._sceneFilter||0===a.context.getFeatureCount())return a._frameTask.schedule(()=>a.clear(),f);try{const c=await a._queryEngine.executeQueryForIdSet(a._compositedFeatureFilter,a._sceneFilter,f);return a._frameTask.schedule(()=>
{a.context.updateFeatureVisibilities(A=>c.has(A))},f)}catch(c){return t.throwIfAbortError(c),r.getLogger(m._assertThisInitialized(a)).warn(`FeatureFilter query failed: ${c}`,{error:c}),a._frameTask.schedule(()=>{a.context.setAllFeaturesVisibility(!0)},f)}};return a}m._inherits(l,n);var h=l.prototype;h.initialize=function(){const g=z.TaskPriority.FILTER_VISIBILITY,{layer:a,view:f}=this._layerView,{featureStore:c}=this.context;this._queryEngine=new y.QueryEngine({context:{spatialReference:f.spatialReference,
layer:a,scheduler:f.resourceController.scheduler,featureStore:c,hasM:"hasM"in this._layerView?this._layerView.hasM:!1,hasZ:"hasZ"in this._layerView?this._layerView.hasZ:!1},priority:g});this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(g,this);this.updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),u.initial)};h.destroy=function(){this._updateRequested=!1;this.handles.removeAll();this.updatingHandles.removeAll();this.clear();this._updateTask=
k.abortMaybe(this._updateTask);this._frameTask=k.removeMaybe(this._frameTask);this._queryEngine=k.destroyMaybe(this._queryEngine);this._set("context",null)};h.reapply=function(){this._updateRequested=!0};h.clear=function(){this._queryEngine.clear();this.context.clearFeaturesVisibility()};h.runTask=function(g){this._updateRequested&&(this._updateTask=k.abortMaybe(this._updateTask),this._updateTask=p.createTask(this._updateVisibility),this._updateRequested=!1,g.madeProgress());this._frameTask.processQueue(g)};
m._createClass(l,[{key:"updating",get:function(){return this.running||this.updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in
this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return x.getFloorFilterClause(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){const {_featureFilter:g,_timeExtent:a,_floorFilter:f}=this;if(null==a&&null==f)return g;const c=null!=g?g.clone():new w;null!=a&&(c.timeExtent=null!=c.timeExtent?c.timeExtent.intersection(a):a);null!=f&&(c.where=null==
c.where||""===c.where?f:`(${c.where}) AND (${f})`);return c}},{key:"_layerView",get:function(){return this.context.layerView}}]);return l}(q.HandleOwner);d.__decorate([e.property({constructOnly:!0})],b.FeatureVisibilityFilter.prototype,"context",void 0);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"updating",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"running",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"defaultVisibility",null);
d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_featureFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_sceneFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_floorFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_timeExtent",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,
"_layerView",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_updateTask",void 0);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_updateRequested",void 0);b.FeatureVisibilityFilter=d.__decorate([v.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],b.FeatureVisibilityFilter);Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
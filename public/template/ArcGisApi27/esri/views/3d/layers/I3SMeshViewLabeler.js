// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../symbols ../../../core/Accessor ../../../core/arrayUtils ../../../core/Handles ../../../core/lang ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/uid ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/diffUtils ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/DoubleArray ../../../layers/graphics/dehydratedFeatures ./graphics/Graphics3DCore ./graphics/Graphics3DScaleVisibility ./i3s/I3SGeometryUtil ../support/LimitGraphicsMap ../webgl-engine/lib/UpdatePolicy ../../../symbols/PointSymbol3D".split(" "),
function(x,m,k,E,F,G,H,z,A,I,J,q,V,K,L,M,y,N,O,P,Q,B,R,S,T){let D=x._createClass(function(h,r){this.meta=h;this.index=r}),U=x._createClass(function(h,r){this.graphic=h;this.geometry=r;this.components=[];this.overridesDirty=!1});k=function(h){function r(a){a=h.call(this,a)||this;a.loadedGraphics=new R.LimitGraphicsMap(5E4);a.slicePlaneEnabled=!1;a._renderingInfo={symbol:new T};a._handles=new G;a._featuresMap=new Map;return a}x._inherits(r,h);var f=r.prototype;f.initialize=function(){const a=this.view.basemapTerrain;
this._graphicsCore=new P.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:S.UpdatePolicy.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:b=>this.view.deconflictor.addGraphicsOwner(b),labeler:(b,d)=>this.view.labeler.addGraphicsOwner(b,d,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),
scaleVisibility:(b,d)=>new Q({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:d,graphicsCore:b,basemapTerrain:a,layerScaleEnabled:!1})}});this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{});this._handles.add(I.watch(()=>this.layer.labelingInfo,(b,d)=>{L.diff(b,d)&&this._graphicsCore.updateLabelingInfo()}))};f.destroy=function(){this._handles=A.destroyMaybe(this._handles);this._graphicsCore=A.destroyMaybe(this._graphicsCore);this.loadedGraphics=
A.destroyMaybe(this.loadedGraphics);this.view=null};f.addNodeMeta=function(a,b){let d=0;const c=a.filteredIds,e=this.view.spatialReference,n=[];for(let l=0;l<a.featureIds.length;l++){const t=a.featureIds[l];var u=null==c;c&&d<c.length&&t===c[d]&&(u=!0,d++);if(!this._enabledForFeatureInNode(a,l))continue;var g=this._featuresMap.get(t);if(g){g.components.push(new D(a,l));this._updateLabelPosition(t);continue}const C=b(l,a);g=O.makeDehydratedPoint(0,0,0,e);u={objectId:t,uid:J.generateUID(),attributes:C,
visible:u,geometry:g};g=new U(u,g);g.components.push(new D(a,l));this._featuresMap.set(t,g);this._updateLabelGeometry(t);n.push(u)}this.loadedGraphics.addMany(n)};f.updateLabelPositions=function(a){const b=this.view.renderCoordsHelper;this._forEachGraphic(a,(d,c,e)=>{c=this._graphicsCore.getGraphics3DGraphicById(c.uid);null!=c&&this._updateLabelGeometry(a.featureIds[d])&&c.alignWithAbsoluteElevation(e.z??0,b,!1)})};f.setNodeMetaAttributes=function(a,b){const d=[];this._forEachGraphic(a,(c,e)=>{c=
b(c,a);H.equalsShallow(e.attributes,c)||(e.attributes=c,d.push(e.uid))});this._graphicsCore.updateLabelingInfo(d)};f.applyFilterChange=function(a){this._forEachFeature(a,(b,d,c)=>{if(this._enabledForFeatureInNode(a,b))b=d.graphic,d=b.visible,d!==c&&(b.visible=c,w.graphic=b,w.property="visible",w.oldValue=d,w.newValue=c,this._graphicsCore.graphicUpdateHandler(w));else switch(c=a.featureIds[b],this._removeFeature(d,a,b)){case p.REMOVED:this.loadedGraphics.removeManyByObjectId([c]);break;case p.MODIFIED:this._updateLabelPosition(c)}})};
f.removeNodeMeta=function(a){const b=[];this._forEachGraphic(a,d=>{const c=a.featureIds[d],e=this._featuresMap.get(c);if(e)switch(this._removeFeature(e,a,d)){case p.MODIFIED:this._updateLabelPosition(c);break;case p.REMOVED:b.push(c)}});this.loadedGraphics.removeManyByObjectId(b)};f._removeFeature=function(a,b,d){const c=a.components.length;F.filterInPlace(a.components,e=>!(e.meta===b&&e.index===d));return 0===a.components.length?(this._featuresMap.delete(b.featureIds[d]),p.REMOVED):c!==a.components.length?
p.MODIFIED:p.UNMODIFIED};f.getRenderingInfo=function(){return this._renderingInfo};f.notifyGraphicGeometryChanged=function(){};f.notifyGraphicVisibilityChanged=function(){};f._updateLabelPosition=function(a){const b=this._featuresMap.get(a);b&&this._updateLabelGeometry(a)&&(this.loadedGraphics.removeManyByObjectId([a]),this.loadedGraphics.addMany([b.graphic]))};f._updateLabelGeometry=function(a){a=this._featuresMap.get(a);if(!a)return!1;const b=a.geometry,d=this.view.spatialReference,c=this.view.renderCoordsHelper,
e=b.x,n=b.y,u=b.z??0,g=N.newDoubleArray(a.components.length*B.BOUNDING_BOX_CORNERS_POINTS_STRIDE);let l=0;for(const {meta:t,index:C}of a.components)B.boundingBoxCornerPoints(C,this.collection,t.objectHandle,g,l),l+=B.BOUNDING_BOX_CORNERS_POINTS_STRIDE;M.projectBuffer(g,c.spatialReference,0,g,d,0,g.length/3);y.set(v,y.NEGATIVE_INFINITY);y.expandWithBuffer(v,g);b.x=(v[0]+v[3])/2;b.y=(v[1]+v[4])/2;b.z=v[5];return!z.floatEqualUlp(b.x,e)||!z.floatEqualUlp(b.y,n)||!z.floatEqualUlp(b.z,u)};f._forEachGraphic=
function(a,b){this._forEachFeature(a,(d,{graphic:c,geometry:e},n)=>{this._enabledForFeatureInNode(a,d)&&b(d,c,e,n)})};f._forEachFeature=function(a,b){let d=0;for(let c=0;c<a.featureIds.length;c++){const e=this._featuresMap.get(a.featureIds[c]);let n=null==a.filteredIds;a.filteredIds&&a.filteredIds[d]===a.featureIds[c]&&(n=!0,d++);e&&b(c,e,n)}};f._enabledForFeatureInNode=function(a,b){return 0>a.node.index||!this.overrides?.featureHasGeometryChanges(a.featureIds[b])};x._createClass(r,[{key:"updating",
get:function(){return this._graphicsCore?.updating??!1}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]);return r}(E);m.__decorate([q.property()],k.prototype,"view",void 0);m.__decorate([q.property()],k.prototype,"layer",void 0);
m.__decorate([q.property()],k.prototype,"collection",void 0);m.__decorate([q.property()],k.prototype,"loadedGraphics",void 0);m.__decorate([q.property()],k.prototype,"overrides",void 0);m.__decorate([q.property()],k.prototype,"updating",null);m.__decorate([q.property()],k.prototype,"slicePlaneEnabled",void 0);m.__decorate([q.property()],k.prototype,"_graphicsCore",void 0);k=m.__decorate([K.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],k);const w={graphic:null,property:null,oldValue:null,newValue:null};
var p;(function(h){h[h.UNMODIFIED=0]="UNMODIFIED";h[h.MODIFIED=1]="MODIFIED";h[h.REMOVED=2]="REMOVED"})(p||(p={}));const v=y.create();return k});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./LayerView3D ./TiledLayerView3D ../terrain/RasterTile ../../layers/ImageryTileLayerView ../../layers/LayerView ../../layers/RefreshableLayerView ../../support/drapedUtils ../../webgl/capabilities".split(" "),
function(p,g,r,t,h,f,D,E,u,v,w,x,y,z,A,B,C){f=function(q){function k(){var a=q.apply(this,arguments)||this;a.type="imagery-tile-3d";a.isAlignedMapTile=!0;return a}p._inherits(k,q);var d=k.prototype;d.initialize=function(){this.layer.increaseRasterJobHandlerUsage();null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new r("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const a=t.whenOnce(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>
{const b=this.view.basemapTerrain.tilingScheme,e=this.layer.tileInfo,c=["png","png24","png32","jpg","mixed"].includes(e.format)&&b.compatibleWith(e);this.tileInfo=(this.isAlignedMapTile=c)?e:b.toTileInfo();this.updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(a)};d.destroy=function(){this.layer.decreaseRasterJobHandlerUsage();
this.view=null};d._getfullExtent=function(){return this.projectFullExtent(this.view.basemapTerrain&&null!=this.view.basemapTerrain.spatialReference?this.view.basemapTerrain.spatialReference:this.view.spatialReference)};d.fetchTile=async function(a,b,e,c){const m=this.tileInfo,n=this._canSymbolizeInWebGL();c=await this.layer.fetchTile(a,b,e,{tileInfo:m,requestRawData:n,signal:c.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile});if(c instanceof HTMLImageElement)return c;
let l=c&&c.pixelBlock;if(null==l||!n&&(l=await this.layer.applyRenderer(c),null==l))return this._blankTile;b=new x.RasterTile([a,b,e],l,m.size[0],m.size[1]);n?(b.symbolizerRenderer=this.layer.symbolizer.rendererJSON,b.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a)),b.transformGrid=c.transformGrid):b.isRendereredSource=!0;b.interpolation=this.layer.interpolation;b.bandIds=this.layer.bandIds;return b};d._getSymbolizerOptions=function(a){a=this.tileInfo.lodAt(a).resolution;
return{pixelBlock:null,isGCS:this.view.basemapTerrain&&null!=this.view.basemapTerrain.spatialReference?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:a,y:a},bandIds:this.layer.bandIds}};d.ensureSymbolizerParameters=function(a){this._canSymbolizeInWebGL()&&JSON.stringify(a.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(a.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a.lij[0])))};
d.createFetchPopupFeaturesQueryGeometry=function(a,b){return B.createQueryGeometry(a,b,this.view)};d.refresh=function(){this.emit("data-changed")};d.doRefresh=async function(){this.suspended||this.emit("data-changed")};d._canSymbolizeInWebGL=function(){return C.getWebGLCapabilities("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL};p._createClass(k,[{key:"_blankTile",get:function(){const a=document.createElement("canvas"),b=a.getContext("2d"),[e,c]=this.tileInfo.size;a.width=e;a.height=
c;b.clearRect(0,0,e,c);return b.getImageData(0,0,e,c)}},{key:"imageFormatIsOpaque",get:function(){return"jpg"===this.layer.tileInfo.format}},{key:"hasMixedImageFormats",get:function(){return"mixed"===this.layer.tileInfo.format}},{key:"dataLevelRange",get:function(){const a=this.layer.tileInfo.lods;return this.levelRangeFromScaleRange(this.tileInfo.lods[0].scale,a[a.length-1].scale)}}]);return k}(y(A(w.TiledLayerView3D(v.LayerView3D(z)))));g.__decorate([h.property({readOnly:!0})],f.prototype,"_blankTile",
null);g.__decorate([h.property({readOnly:!0})],f.prototype,"imageFormatIsOpaque",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"hasMixedImageFormats",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"dataLevelRange",null);return f=g.__decorate([u.subclass("esri.views.3d.layers.ImageryTileLayerView3D")],f)});
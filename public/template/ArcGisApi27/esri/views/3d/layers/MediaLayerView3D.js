// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/handleUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/aaBoundingRect ../../../layers/support/MediaElementView ./interfaces ./LayerView3D ../terrain/OverlayRenderer ../webgl-engine/lib/Attribute ../webgl-engine/lib/Geometry ../webgl-engine/lib/ModelDirtyTypes ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lib/VertexAttribute ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../webgl/enums".split(" "),
function(r,p,q,t,u,v,h,L,M,A,B,C,D,E,l,w,F,m,G,H,I,k,J,K,x){h=function(y){function n(){var a=y.apply(this,arguments)||this;a.type="media-3d";a.drapeSourceType=D.DrapeSourceType.RasterImage;a.updatePolicy=I.UpdatePolicy.ASYNC;a._uidToElement=new Map;a._renderedElements=new Map;a._lastDrapingExtent=null;a._update=t.debounce(async(b,c,d)=>{b=await a._collectMediaElements(b,c,d);a._synchronizeRenderElements(b)},0);return a}r._inherits(n,y);var e=n.prototype;e.initialize=function(){this._renderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);
const a=()=>this._updateWithLastDrapingExtent();this.handles.add([q.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)),u.on(()=>this.layer.effectiveSource,"change",a),u.on(()=>this.layer.effectiveSource,"refresh",a)]);this.updatingHandles.add(()=>this.suspended,a)};e.setDrapingExtent=function(a,b){this._lastDrapingExtent={overlays:a,spatialReference:b};this._updateWithLastDrapingExtent()};e.getHit=function(a){return(a=this._uidToElement.get(a))?{type:"media",element:a,
layer:this.layer}:null};e._updateWithLastDrapingExtent=function(){if(null==this._lastDrapingExtent||this.suspended)this._renderer&&this._synchronizeRenderElements(new Set);else{var {overlays:a,spatialReference:b}=this._lastDrapingExtent;this.updatingHandles.addPromise(this._update(a,b).catch(()=>{}))}};e._collectMediaElements=async function(a,b,c){const d=this.layer.effectiveSource;return null==d?new Set:new Set((await Promise.all(a.map(f=>d.queryElements(B.toExtent(f.extent,b),{signal:c})))).flat())};
e._synchronizeRenderElements=function(a){this._synchronizeRenderElementsRemove(a);this._synchronizeRenderElementsAdd(a)};e._synchronizeRenderElementsRemove=function(a){const b=new Set,c=[];this._renderedElements.forEach((d,f)=>{a.has(f)||(b.add(f),null!=d.renderData&&c.push(d.renderData.renderGeometry),this._removeElement(f,d))});this._renderer.removeGeometries(c,m.DirtyOperation.REMOVE)};e._synchronizeRenderElementsAdd=function(a){for(const b of a)this._renderedElements.has(b)||this._createRenderElement(b)};
e._removeElement=function(a,{renderData:b,handle:c}){this._destroyRenderData(b);this._renderedElements.delete(a);this._uidToElement.delete(a.uid);c.remove()};e._createRenderElement=async function(a){const b=new C.MediaElementView({spatialReference:this.view.spatialReference,element:a}),c={renderData:null,handle:q.handlesGroup([this.updatingHandles.add(()=>a.opacity,d=>{null!=c.renderData&&c.renderData.material.setParameters({opacity:d})}),this.updatingHandles.add(()=>b.coords,d=>{null!=c.renderData?
this._updateGeometry(c,c.renderData,d):this._initializeRenderData(b,c)}),this.updatingHandles.add(()=>a.content,()=>this._initializeRenderData(b,c)),q.destroyHandle(b)])};this._renderedElements.set(a,c);this._uidToElement.set(a.uid,a);this.updatingHandles.addPromise(a.load().catch(()=>{}));this._initializeRenderData(b,c)};e._initializeRenderData=function(a,b){const {coords:c,element:d}=a;if(null==c||null==d.content)b.renderData=this._destroyRenderData(b.renderData);else if(null==b.renderData){a=this._createTexture(d.content);
this.view._stage.add(a);var f=this.view._stage.loadImmediate(a);t.isPromiseLike(f)&&this.updatingHandles.addPromise(f);f=new J.ImageMaterial({initTextureTransparent:!0,textureId:a.id,opacity:d.opacity,transparent:!0});var g=this._positionVertexBufferFromCoordinates(c),z=[0,1,2,0,2,3];g=new F.Geometry(f,[[k.VertexAttribute.POSITION,new w.Attribute(g,3,!0)],[k.VertexAttribute.UV0,new w.Attribute([0,0,1,0,1,1,0,1],2,!0)]],[[k.VertexAttribute.POSITION,z],[k.VertexAttribute.UV0,z]]);g=new G.RenderGeometry(g,
{layerUid:this.layer.uid,graphicUid:d.uid});this._renderer.addGeometries([g],m.DirtyOperation.ADD);b.renderData={renderGeometry:g,texture:a,material:f}}};e._updateGeometry=function(a,b,c){null==c?a.renderData=this._destroyRenderData(a.renderData):(a=this._positionVertexBufferFromCoordinates(c),b.renderGeometry.geometry.setAttributeData(k.VertexAttribute.POSITION,a),this._renderer.modifyGeometries([b.renderGeometry],m.DirtyState.GEOMETRY))};e._positionVertexBufferFromCoordinates=function(a){const [b,
c,d,f]=a.rings[0];return[b[0],b[1],l.DRAPED_Z,f[0],f[1],l.DRAPED_Z,d[0],d[1],l.DRAPED_Z,c[0],c[1],l.DRAPED_Z]};e._destroyRenderData=function(a){if(null==a)return null;this.view._stage.remove(a.texture);this._renderer.removeGeometries([a.renderGeometry],m.DirtyOperation.REMOVE);a.material.dispose();return null};e._createTexture=function(a){return new H.Texture(a,{wrap:{s:x.TextureWrapMode.CLAMP_TO_EDGE,t:x.TextureWrapMode.CLAMP_TO_EDGE},preMultiplyAlpha:!0,width:a instanceof HTMLImageElement?a.naturalWidth:
a.width,height:a instanceof HTMLImageElement?a.naturalHeight:a.height,mipmap:!0,updateCallback:()=>this.view.basemapTerrain.overlayManager.setDrawTexturesDirty()})};r._createClass(n,[{key:"test",get:function(){const a=this;return{get numberOfElements(){return a._renderedElements.size}}}}]);return n}(E.LayerView3D(K));p.__decorate([v.property({readOnly:!0})],h.prototype,"type",void 0);p.__decorate([v.property()],h.prototype,"layer",void 0);return h=p.__decorate([A.subclass("esri.views.3d.layers.MediaLayerView3D")],
h)});
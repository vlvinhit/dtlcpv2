// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../request ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/byteSizeEstimations ../../../../core/Collection ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/ReactiveSet ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../intl/number ../../../../layers/support/featureQueryAll ../../../../rest/support/meshFeatureSet ../../../../support/featureFlags ../../../../support/requestUtils ../FeatureLayerView3D".split(" "),
function(m,B,p,L,M,N,C,D,E,F,G,z,H,I,q,T,U,O,P,J,K,u,Q,R){m.I3SOverrides=function(t){function v(a){a=t.call(this,a)||this;a._warnMaximumChangedObjectsExceeded=!1;a._maximumNumberOfEditOVerrides=5E4;a._original3DOFLDefinitionExpression=null;a._interactiveEditingSessions=new E;a.geometryOverrides=new E;a._clientGeometryCache=new Map;a._associatedLayerView=null;a._attributeChangedObjectIds=new H;a._geometryChangedObjectIds=new H;a._pendingFetchChangedObjectIds=null;a._pendingFetchAbortController=new AbortController;
a._pendingAttributeQueriesCache=new Map;return a}B._inherits(v,t);var g=v.prototype;g.initialize=function(){this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`);this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal);this._pendingFetchChangedObjectIds.finally(()=>{this._pendingFetchChangedObjectIds=this._pendingFetchAbortController=null});this.is3DOFL&&null!=this._associatedLayer&&(u.direct3DObjectFeatureLayerDisplayEnabled()?
this._associatedLayer.load().then(a=>{this.destroyed||(this._original3DOFLDefinitionExpression=a.definitionExpression,this.addHandles(I.watch(()=>this._definitionExpression,b=>a.definitionExpression=b,I.initial)),this._associatedLayerView=new R({layer:this._associatedLayer,view:this.view}))}):u.i3sPatchingEnabled())};g.destroy=function(){this.is3DOFL&&null!=this._associatedLayer&&(u.direct3DObjectFeatureLayerDisplayEnabled()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=
this._original3DOFLDefinitionExpression):u.i3sPatchingEnabled());this._set("layer",null);this._memCache=G.destroyMaybe(this._memCache);this._pendingFetchAbortController=G.abortMaybe(this._pendingFetchAbortController);this._pendingFetchChangedObjectIds=null;this._pendingAttributeQueriesCache.clear()};g.featureHasGeometryChanges=function(a){return this._geometryChangedObjectIds.has(a)};g.featureHasAttributeChanges=function(a){return this._attributeChangedObjectIds.has(a)};g.createInteractiveEditSession=
function(a){this._attributeChangedObjectIds.add(a);const b=u.sceneLayerEditingEnabled()&&u.i3sPatchingEnabled()&&null!=this.is3DOFL,c=this._interactiveEditingSessions,d=new S(a,{rollback:()=>{c.remove(d)},commit:(h,f)=>{for(const [e,k]of h)this.updateAttributeValue(a,e,k);b&&null!=f&&this.updateGeometry(a,f)}});c.unshift(d);return d};g.applyAttributeOverrides=async function(a,b,c){if(null!=b){var {loadedAttributes:d,attributeData:h}=b;if(null!=d&&0!==d.length&&null!=h&&(this._pendingFetchChangedObjectIds&&
await z.whenOrAbort(this._pendingFetchChangedObjectIds,c),0!==this._attributeChangedObjectIds.size)){b={loadedAttributes:d,attributeData:h};var f=this._getOverridesFromCache(a,b,this._attributeChangedObjectIds),{objectIds:e,fieldNames:k}=f;0!==e.length&&0!==k.length&&(c=await this._queryAttributeOverridesFromAssociatedLayer(e,k,c),null!=c&&this._processOverridesFromAssociatedLayer(a,c,k,b))}}};g.updateGeometry=function(a,b){this._geometryChangedObjectIds.add(a);const c=this._clientGeometryCache.get(a);
null!=c&&(this.geometryOverrides.remove(c),this._clientGeometryCache.delete(a));null!=b&&(b={oid:a,mesh:b},this.geometryOverrides.add(b),this._clientGeometryCache.set(a,b))};g.updateAttributeValue=function(a,b,c){this._attributeChangedObjectIds.add(a);this._cacheAttributeValue(a,b,c)};g.featureAdded=function(a){this.is3DOFL&&u.i3sPatchingEnabled()&&this._geometryChangedObjectIds.add(a);this._attributeChangedObjectIds.add(a)};g._cacheAttributeValue=function(a,b,c){this._memCache.put(this._getAttributeCacheKey(a,
b),c,this._memCacheAttributeValueSize(c))};g._getOverridesFromCache=function(a,{loadedAttributes:b,attributeData:c},d){const h=new Set,f=[];for(var e of b)f[e.index]=c[e.name];c=new Set;for(e=0;e<a.length;e++){const k=a[e];if(d.has(k))for(const l of b){const n=this._attributeFromCache(k,l.index);void 0!==n?f[l.index][e]=n:(h.add(k),c.add(l.name))}}return{objectIds:Array.from(h),fieldNames:Array.from(c)}};g._attributeFromCache=function(a,b){const c=this._fromInteractiveEditingSession(a,b);if(void 0!==
c)return c;a=this._getAttributeCacheKey(a,b);return this._memCache.get(a)};g._fromInteractiveEditingSession=function(a,b){if(null!=this._interactiveEditingSessions)for(const c of this._interactiveEditingSessions){if(c.objectId!==a)continue;const d=c.getAttribute(b);if(void 0!==d)return d}};g._getAttributeCacheKey=function(a,b){return`${a}-${b}`};g._queryAttributeOverridesFromAssociatedLayer=async function(a,b,c){if(0===a.length)return null;this._logWarningIfMaximumObjectsExceeded();var {associatedLayer:d}=
this.layer;if(null==d)return null;const h=this._pendingAttributeQueriesCache;var f=[];const e=new Map;for(var k of a)(a=h.get(k))?f.push(a):(a=z.createResolver(),z.ignoreAbortErrors(a.promise),e.set(k,a),h.set(k,a.promise));a=Array.from(e.keys());const l=d.createQuery();({objectIdField:k}=d);b=[k,...b];l.where="1\x3d1";l.returnGeometry=!1;l.outFields=b;l.cacheHint=!0;l.objectIds=a;const [n,w]=await Promise.all([this._executeBatchQuery(d,a,l,c),Promise.all(f)]).then(r=>{z.throwIfAborted(c);return r}).catch(r=>
{for(const [x,A]of e)h.delete(x),A.reject(r);throw r;});d=[];for(const r of n)if(r.ok)for(const x of r.value.features)f=x,b=f.attributes[k],e.get(b)?.resolve(f),h.delete(b),e.delete(b),d.push(f);for(const r of w)r&&d.push(r);for(const [r,x]of e)h.delete(r),x.resolve(null);return d};g._queryGeometryOverridesFromAssociatedLayer=async function(a,b){if(0===a.length||!this.is3DOFL||!u.i3sPatchingEnabled())return null;this._logWarningIfMaximumObjectsExceeded();var c=this.layer.associatedLayer;const {objectIdField:d,
globalIdField:h}=c;var f=[d,...(null!=h?[h]:[])],e=c.createQuery();e.where="1\x3d1";e.returnGeometry=!0;e.outFields=f;e.cacheHint=!0;e.objectIds=a;e.returnZ=c.hasZ;e.returnM=c.hasM;f=await this._executeBatchQuery(c,a,e,b);a=c.infoFor3D;({spatialReference:c}=c);b=[];for(const k of f){if(!k.ok)continue;const {assetMaps:l,features:n,globalIdFieldName:w}=k.value;if(null!=l){f=K.assetMapFromAssetMapsJSON(a,l);for(const r of n){e=K.extractMesh(r,w,c,a,f);const x=r;null!=e?(x.geometry=e,b.push(x)):x.geometry=
null}}}return b};g._logWarningIfMaximumObjectsExceeded=function(){if(this._warnMaximumChangedObjectsExceeded){this._warnMaximumChangedObjectsExceeded=!1;var a=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${P.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`,b=this.layer.portalItem;a=b&&b.loaded?a+` (${b.portal.url}/home/item.html?id=${b.id}#settings)`:
a+` (${this.layer.parsedUrl.path})`;F.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,`${a}.`)}};g._executeBatchQuery=async function(a,b,c,d){if(0===b.length)return[];const h=J.getMaximumQuerySize(a);b=[...b].sort((f,e)=>f-e);b=N.splitIntoChunks(b,h).map(f=>{const e=c.clone();e.objectIds=f;return C.resultOrAbort(J.queryAllJSON(a,e,{signal:d}))});return Promise.all(b)};g._processOverridesFromAssociatedLayer=function(a,b,c,{loadedAttributes:d,attributeData:h}){var f=
this._associatedLayer;if(null!=f){f=f.objectIdField;var e=c.map(n=>{n in h||(h[n]=Array(a.length));return h[n]}),k=new Map(d.map(n=>[n.name,n.index]));d=c.map(n=>k.get(n));var l=new Map(Array.from(a,(n,w)=>[n,w]));for(const n of b){b=n.attributes[f];for(let w=0;w<c.length;w++){const r=d[w],x=l.get(b),A=n.attributes[c[w]];e[w][x]=A;this._cacheAttributeValue(b,r,A)}}}};g._memCacheAttributeValueSize=function(a){return"string"===typeof a?D.estimateStringByteSize(a):D.estimateNumberByteSize()};g._fetchChangedObjectIds=
async function(a){var b=this.layer;await b.load({signal:a});this._geometryChangedObjectIds.clear();this._attributeChangedObjectIds.clear();({associatedLayer:b}=b);if(null!=b&&b.capabilities?.operations?.supportsChangeTracking){var c=this._getFetchChangedObjectIdsServerGen();if(null!=c){var d=b.layerId,h=this.is3DOFL;c={f:"json",returnIdsOnly:!0,layers:`[${d}]`,returnUpdates:!0,returnDeletes:h,returnInserts:h,layerServerGens:JSON.stringify([{id:d,serverGen:c}])};h&&(d=b.infoFor3D,c.fieldsToCompare=
JSON.stringify({fields:[...Object.values(d.transformFieldRoles),d.sourceHashField]}));c=await C.result(L(`${b.url}/extractChanges`,{method:"post",query:c,timeout:1E4,signal:a}));!c.ok&&Q.isTimeoutError(c.error)&&(d=this.layer.title,F.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("extractChanges:timeout",d,`${d} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`));
if(c.ok&&1===c.value.data?.edits?.length){d=c.value.data.edits[0];c=d?.objectIds;var f=c?.adds??[];const e=c?.updates??[],k=c?.deletes??[];c=[...f,...e,...k];h=h?[...f,...(d?.fieldUpdates??e),...k]:[];d=Math.min(this._maximumNumberOfEditOVerrides,c.length);d<c.length&&(this._warnMaximumChangedObjectsExceeded=!0);c=c.sort((l,n)=>l-n);for(f=0;f<d;++f)this._attributeChangedObjectIds.add(c[f]);for(const l of h)this._geometryChangedObjectIds.add(l);if(this.is3DOFL&&u.i3sPatchingEnabled()&&0<this._geometryChangedObjectIds.size&&
(a=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),a),null!=a))for(const l of a)null!=l.geometry&&this.updateGeometry(l.attributes[b.objectIdField],l.geometry)}}}};g._getFetchChangedObjectIdsServerGen=function(){var a=this.layer;if(null!=a.serviceUpdateTimeStamp&&null!=a.serviceUpdateTimeStamp.lastUpdate)return a.serviceUpdateTimeStamp.lastUpdate;a=a.associatedLayer;return null!=a&&null!=a.serverGens&&null!=a.serverGens.minServerGen?a.serverGens.minServerGen:
null};B._createClass(v,[{key:"is3DOFL",get:function(){return u.sceneLayerEditingEnabled()&&null!=this._associatedLayer&&null!=this._associatedLayer.infoFor3D}},{key:"sortedGeometryChangedObjectIds",get:function(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort((a,b)=>a-b):[]}},{key:"_associatedLayer",get:function(){return null==this.layer?null:this.layer.associatedLayer}},{key:"hasGeometryChanges",get:function(){return 0<this._geometryChangedObjectIds.size}},{key:"_definitionExpression",
get:function(){const a=this.sortedGeometryChangedObjectIds;return 0===a.length?"1 \x3d 0":`OBJECTID IN (${a.join(",")})`}},{key:"updating",get:function(){if(!this.is3DOFL)return!1;if(u.direct3DObjectFeatureLayerDisplayEnabled())return null==this._associatedLayerView||null!=this._associatedLayerView&&this._associatedLayerView.updating;u.i3sPatchingEnabled();return!1}},{key:"isEmpty",get:function(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}},
{key:"test",get:function(){const a=this;return{changedObjectIds:Array.from(this._attributeChangedObjectIds),pendingFetchChangedObjectIds:this._pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return a._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(b){a._maximumNumberOfEditOVerrides=b}}}}]);return v}(M);p.__decorate([q.property({constructOnly:!0})],m.I3SOverrides.prototype,"view",void 0);p.__decorate([q.property({constructOnly:!0})],m.I3SOverrides.prototype,"layer",
void 0);p.__decorate([q.property({readOnly:!0})],m.I3SOverrides.prototype,"is3DOFL",null);p.__decorate([q.property()],m.I3SOverrides.prototype,"_interactiveEditingSessions",void 0);p.__decorate([q.property({readOnly:!0})],m.I3SOverrides.prototype,"sortedGeometryChangedObjectIds",null);p.__decorate([q.property({readOnly:!0})],m.I3SOverrides.prototype,"geometryOverrides",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"_clientGeometryCache",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,
"_associatedLayer",null);p.__decorate([q.property()],m.I3SOverrides.prototype,"_associatedLayerView",void 0);p.__decorate([q.property({constructOnly:!0})],m.I3SOverrides.prototype,"memoryController",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"_attributeChangedObjectIds",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"_geometryChangedObjectIds",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"hasGeometryChanges",null);p.__decorate([q.property()],m.I3SOverrides.prototype,
"_pendingFetchChangedObjectIds",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"_pendingFetchAbortController",void 0);p.__decorate([q.property()],m.I3SOverrides.prototype,"_definitionExpression",null);p.__decorate([q.property()],m.I3SOverrides.prototype,"updating",null);p.__decorate([q.property()],m.I3SOverrides.prototype,"isEmpty",null);m.I3SOverrides=p.__decorate([O.subclass("esri.views.3d.layers.i3s.I3SOverrides")],m.I3SOverrides);let S=function(){function t(g,a){this.objectId=g;
this._options=a;this._updates=new Map;this._updatedGeometry=void 0;this._state=y.ACTIVE}var v=t.prototype;v.getAttribute=function(g){return this._updates.get(g)};v.setAttribute=function(g,a){this.isActive&&this._updates.set(g,a)};v.getGeometry=function(){return this._updatedGeometry};v.setGeometry=function(g){this.isActive&&(this._updatedGeometry=g)};v.rollback=function(){this.isActive&&(this._state=y.ROLLED_BACK,this._options.rollback(),this._updatedGeometry=void 0)};v.commit=function(){this.isActive&&
(this._state=y.COMMITTED,this._options.commit(this._updates,this._updatedGeometry),this._updates.clear(),this._updatedGeometry=void 0)};B._createClass(t,[{key:"isActive",get:function(){return this._state===y.ACTIVE}}]);return t}();var y;(function(t){t[t.ACTIVE=0]="ACTIVE";t[t.COMMITTED=1]="COMMITTED";t[t.ROLLED_BACK=2]="ROLLED_BACK"})(y||(y={}));Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../chunks/vec3 ../../../../geometry/projection ../../../../chunks/sphere ../../../../support/featureFlags ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(I,E,D,O,S,J,B,T,t,u,P){function Q(p){null!=p.node&&(u.invalidateMbs(p.node.renderMbs),u.invalidateObb(p.node.serviceObbInRenderSR));null!=p.ref&&(u.invalidateMbs(p.ref.renderMbs),u.invalidateObb(p.ref.serviceObbInRenderSR))}
function F(p,f){return 0>p?-1:0===f?0:p/f|0}function G(p=[],f=[],a=[]){return{nodes:p,children:f,parents:a}}function y(p,f){return 0>p?-p-1:0===f?p:p%f}function H(p,f,a){return-1===f?-(p+1):0===a?p:f*a+p}function R(p){if(p)for(let f=0;f<p.length;f++)for(const a of U)if(a[0]===p[f].metricType)return{lodMetric:a[1],maxError:p[f].maxError};return{lodMetric:t.LodMetric.None,maxError:0}}function V(p){return Math.sqrt(4/Math.PI*p)}let K=E._createClass(function(p,f,a,b,c){this.childOffset=p;this.childCount=
f;this.visibilityCache=a;this.ref=b;this.node=c;this.useAsHole=0;this.filterImpact=t.NodeFilterImpact.NotChecked}),ba=function(){function p(a,b,c,e,d,g,m,k,q,h,l,x,n,r,v){this._layer=a;this._streamDataController=c;this._clientNodeLoader=e;this._viewportQueries=d;this._logger=g;this.holeFilling=m;this._isLoaded=k;this._isReloading=q;this._isSelected=h;this._enable=l;this._needsUpdate=x;this._canRequest=n;this._computeVisibilityObb=r;this._computeNodeFiltering=v;this._dirty=!0;this._nodePages=[];this._clientNodePage=
null;this._rootIndex=this._nodesPerPage=this._nodeCount=0;this._lodMetric=t.LodMetric.None;this._lodConversion=z=>z;this._isEditable=!1;this._urlPrefix="";this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState=new Map;this._version=u.addWraparound(0,2);this._visibilityCacheVersion=u.addWraparound(0,2);this._maxLevel=1;this._featureEstimate=
{estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=0;this._missing=new D({deallocator:null});this._prefetch=new D({deallocator:null});this._updates=new W(this._missing);this._imModificationUncategorized=new D({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=!1;this._isEditable=T.i3sPatchingEnabled()&&null!=a.associatedLayer&&null!=a.associatedLayer.infoFor3D;a.serviceUpdateTimeStamp&&
a.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${a.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(b)}var f=p.prototype;f._init=function(a){if("page"===a.type){var b=a.rootPage;this._urlPrefix=a.urlPrefix;this._nodesPerPage=a.pageSize;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=t.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=t.LodMetric.MaxScreenThreshold,this._lodConversion=
V}if(this._isEditable){this._rootIndex=-1;var c=y(a.rootIndex,a.pageSize);c=b.nodes[c];c={nodes:[{index:this._rootIndex,children:[a.rootIndex],mesh:void 0,obb:c.obb,lodThreshold:c.lodThreshold}]};this._addPage(F(this._rootIndex,this._nodesPerPage),c);this.getNode(-1).serviceObb=void 0}else this._rootIndex=a.rootIndex;this._addPage(F(a.rootIndex,this._nodesPerPage),b);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,this._nodePages.push(G()),this._isEditable?(this._clientNodePage=
G(),b={id:"-1",version:null,mbs:a.rootNode.mbs,obb:a.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:a.rootNode.mbs,obb:a.rootNode.obb}]},this._rootIndex=this._makeClientRefNode(new t.NodeBase(b.id,null),-1),(b=this._validateNode(b.id,b))&&this._addNode(b,this._rootIndex)):this._rootIndex=this._makeRefNode(new t.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,a.rootNode))&&this._addNode(a,0))};f.addClientNodeToIndex=
function(a,b){a=new t.NodeBase(a,b);a=this._makeClientRefNode(a,-1);this._linkChildToParentNode(-1,a);this.requestUpdate();return a};f.removeClientNodeFromIndex=function(a,b,c){this._destroyClientRefNode(a,b,c);this.requestUpdate()};f._loadPage=function(a){this._loading.add(a);this._streamDataController.request(this._urlPrefix+a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loading.delete(a);O.isAbortError(b)||(this._failedPages.add(a),this._logger.error("#loadPage()",
this._layer,`Error when loading page ${a}`,b))})};f._addQueuedPages=function(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);this._loading.delete(b);a.madeProgress()}this._updateParentsAndLevel()};f._addPage=function(a,b){const c=[],e=[];b=b.nodes.map((d,g)=>{const m=c.length,k=d.children?d.children.length:0;e.push(this._rootIndex);for(var q=0;q<k;q++)c.push(d.children[q]);const h=`${d.index}`;q=P.clone(d.obb);const l=B.fromValues(q.center[0],
q.center[1],q.center[2],S.length(q.halfSize));var x=d.mesh&&d.mesh.attribute;const n=d.mesh&&d.mesh.geometry,r=d.mesh&&d.mesh.material;x={hasSharedResource:!1,isEmpty:null==n,attributes:x&&null!=x.resource?`${x.resource}`:void 0,geometry:n&&null!=n.resource?`${n.resource}`:void 0,texture:r&&null!=r.resource?`${r.resource}`:void 0,geometryDefinition:n?n.definition:-1,materialDefinition:r?r.definition:-1};d=new t.Node(h,H(g,a,this._nodesPerPage),l,k,0,x,this._lastUpdate,this._lodMetric,this._lodConversion(d.lodThreshold),
n?n.featureCount:null);d.serviceObb=q;d.visibilityObb=this._computeVisibilityObb(d);d.vertexCount=n?n.vertexCount:0;return new K(m,k,u.addWraparound(this._visibilityCacheVersion,-2),null,d)});if(-1===a)this._clientNodePage=G(b,c,e);else{for(let d=this._nodePages.length;d<a;d++)this._nodePages[d]=null;this._nodePages[a]=G(b,c,e)}this._nodeCount+=b.length};f._updateParentsAndLevel=function(){const a=[],b=(c,e,d)=>{const g=this._getPage(c);if(null!=g){const m=y(c,this._nodesPerPage);g.parents[m]=null!=
e?e:-1;e=g.nodes[m].node;null!=e&&(e.level=d,a.push(c))}};for(b(this._rootIndex,null,0);a.length;){const c=a.pop(),e=this.getNode(c);if(null!=e)for(let d=0;d<e.childCount;d++){const g=this.getChildIndex(e.index,d);b(g,c,e.level+1);this._maxLevel=Math.max(this._maxLevel,e.level+1)}}};f._getPage=function(a){a=F(a,this._nodesPerPage);return 0>a?this._clientNodePage:this._nodePages[a]};f._getNodeInternal=function(a){const b=this._getPage(a);return null==b?null:b.nodes[y(a,this._nodesPerPage)]};f._addNode=
function(a,b){null!=a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);c=null!=c?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,a.children?c+1:c);const {lodMetric:e,maxError:d}=R(a.lodSelection),g=this._getNodeInternal(b);g.node=new t.Node(a.id,b,a.mbs,g.childCount,c,a.resources,a.version,e,d,a.numFeatures);a.obb&&(g.node.serviceObb=P.clone(a.obb));g.node.visibilityObb=this._computeVisibilityObb(g.node);null!=g.ref&&(null==g.ref.mbs&&(g.ref.mbs=a.mbs),g.node.renderMbs=g.ref.renderMbs,
g.node.serviceObbInRenderSR=g.ref.serviceObbInRenderSR,g.ref.visibilityObb=g.node.visibilityObb);return g.node};f._makeRefNode=function(a,b){const c=this._nodePages[0];if(-1>b)return this._makeClientRefNode(a,b);if(null==c)return-1;const e=c.nodes.length;c.nodes.push(new K(0,0,u.addWraparound(this._visibilityCacheVersion,-2),a,null));this._nodeCount++;c.parents.push(b);u.invalidateMbs(a.renderMbs);u.invalidateObb(a.serviceObbInRenderSR);return e};f._makeClientRefNode=function(a,b){const c=this._clientNodePage;
if(null==c)return-1;if(0<=b)throw Error("I3SIndex::client side nodes can not be made children of service side nodes.");const e=-(c.nodes.length+1);c.nodes.push(new K(0,0,u.addWraparound(this._visibilityCacheVersion,-2),a,null));this._nodeCount++;c.parents.push(b);u.invalidateMbs(a.renderMbs);u.invalidateObb(a.serviceObbInRenderSR);return e};f._linkChildToParentNode=function(a,b){const c=this._clientNodePage;if(!(null==c||0<=a)){var e=y(a,this._nodesPerPage),d=y(b,this._nodesPerPage);e=c.nodes[e];
var g=e.childOffset;c.children.splice(e.childOffset+e.childCount,0,b);e.childCount+=1;null!=e.node&&(e.node.childCount+=1);for(const m of c.nodes)m.childOffset>g&&(m.childOffset+=1);c.parents[d]=a;this._updateParentBoundingInformation(a)}};f._destroyClientRefNode=function(a,b,c){const e=this._clientNodePage;if(null!=e){var d=this.getParentIndex(a);if(null!=d){var g=new Set,m=new Map,k=L=>{var C=y(L,this._nodesPerPage);C=e.nodes[C];if(0<C.childCount)for(let M=C.childOffset;M<C.childOffset+C.childCount;++M)k(e.children[M]);
b(C.node?.id,L);g.add(C);this._nodeTraversalState.delete(L)};k(a);a=e.nodes;var q=e.children,h=e.nodes.map(()=>-1),l=[],x=[];for(var n=0;n<a.length;++n){var r=a[n];if(!g.has(r)){var v=l.length,z=H(n,-1,this._nodesPerPage);v=H(v,-1,this._nodesPerPage);r.node&&(r.node.index=v);h[n]=v;l.push(r);z!==v&&(c(r.node?.id,z,v),m.set(z,v))}}this._nodeCount-=a.length-l.length;c=l.map(()=>-1);for(m=0;m<l.length;++m){n=H(m,-1,this._nodesPerPage);r=l[m];z=x.length;for(v=r.childOffset;v<r.childOffset+r.childCount;++v){var A=
q[v];0<=A?x.push(A):(A=y(A,this._nodesPerPage),g.has(a[A])||(A=h[A],x.push(A),A=y(A,this._nodesPerPage),c[A]=n))}r.childOffset=z;r.childCount=x.length-z;r.node&&(r.node.childCount=r.childCount)}e.nodes=l;e.children=x;e.parents=c;this._updateParentBoundingInformation(h[y(d,this._nodesPerPage)])}}};f._updateParentBoundingInformation=function(a){do{let e=null;var b=this._clientNodeLoader.indexSR;const d=this._clientNodeLoader.renderSR,g=this._getNodeInternal(a);if(null==g)break;for(let m=0;m<g.childCount;m++){var c=
this.getChildIndex(a,m);c=this._getNodeInternal(c);c=null!=c?c.ref||c.node:null;if(null!=c&&0<c.mbs[3])if(null==e)e=B.copy(c.mbs,X);else{const k=Y,q=Z,h=aa;J.projectBoundingSphere(c.mbs,b,k,d);J.projectBoundingSphere(e,b,q,d);B.union(k,q,h);J.projectBoundingSphere(h,d,e,b)}}b=g.ref||g.node;null!=b&&(null!=e?b.mbs=B.copy(e,null!=b.mbs?b.mbs:B.create()):u.invalidateMbs(b.mbs),u.invalidateMbs(b.renderMbs),u.invalidateObb(b.serviceObbInRenderSR),b.geometryObb=null);this.invalidateNodeVisibilityCacheInternal(g);
a=this.getParentIndex(a)}while(null!=a)};f.populateChildren=function(a,b){var c=this._getNodeInternal(a);const e=this._getPage(a);c.childOffset=e.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const d=this._makeRefNode(b[c],a);e.children.push(d)}};f.getNode=function(a){a=this._getNodeInternal(a);return null!=a?a.node:null};f.getIndexById=function(a){let b;this._forAllNodes((c,e)=>{null!=c.node&&c.node.id===a?b=e:null!=c.ref&&c.ref.id===a&&(b=e)});return b};f.getNodeById=function(a){a=
this.getIndexById(a);return null!=a&&0<=a?this.getNode(a):null};f.getChildIndex=function(a,b){const c=this._getPage(a);if(null==c)return-1;a=c.nodes[y(a,this._nodesPerPage)];return c.children[a.childOffset+b]};f.getParentIndex=function(a){const b=this._getPage(a);return null!=b&&a!==this._rootIndex?b.parents[y(a,this._nodesPerPage)]:null};f.getParent=function(a){a=this.getParentIndex(a);return null!=a?this.getNode(a):null};f.isLeaf=function(a){a=this._getNodeInternal(a);return null!=a&&0===a.childCount};
f.removeAllGeometryObbs=function(){this._forAllNodes(a=>{null!=a.node&&(a.node.geometryObb=null)})};f.invalidateVisibilityCache=function(){this._visibilityCacheVersion=u.addWraparound(this._visibilityCacheVersion,2)};f.invalidateNodeVisibilityCache=function(a){a=this._getNodeInternal(a);null!=a&&this.invalidateNodeVisibilityCacheInternal(a)};f.invalidateNodeVisibilityCacheInternal=function(a){a.visibilityCache=u.addWraparound(this._visibilityCacheVersion,-2)};f.invalidateBoundingVolumeCache=function(a){a=
this._getNodeInternal(a);null!=a&&(Q(a),this.invalidateNodeVisibilityCacheInternal(a))};f.updateElevationChanged=function(a){const b=this._getNodeInternal(a);null!=b&&(this.needNodeElevationRange?(a=null!=b.node?b.node:b.ref,null!=a&&(a=a.elevationRange,null!=a&&(a.valid=!1))):this.invalidateBoundingVolumeCache(a))};f.invalidateGeometryVisibility=function(a){a=this._getNodeInternal(a);null!=a&&null!=a.node&&(a.node.geometryObb=null,u.invalidateMbs(a.node.renderMbs),u.invalidateObb(a.node.serviceObbInRenderSR))};
f.invalidateVisibilityObbs=function(){null!=this.rootNode&&this.traverse(this.rootNode,a=>{a.visibilityObb=this._computeVisibilityObb(a);a.geometryObb=null;return!0})};f._updateElevationRange=function(a){const b=this._getNodeInternal(a);if(null==b)return null;var c=null!=b.node?b.node:b.ref;if(null==c)return null;const e=c.elevationRange;if(null!=e&&e.valid)return e;const d=new t.ElevationRange;let g=!1;for(let m=0;m<b.childCount;m++){const k=this._updateElevationRange(this.getChildIndex(a,m));null==
k?g=!0:(d.min=Math.min(d.min,k.min),d.max=Math.max(d.max,k.max))}if(0===b.childCount||g&&null!=b.node&&b.node.resources.geometry)c=this._viewportQueries.getElevationRange(c),null!=c&&(d.min=Math.min(d.min,c.min),d.max=Math.max(d.max,c.max));if(null!=e&&e.min===d.min&&e.max===d.max)return e.valid=!0,e;d.valid=!0;null!=b.node&&(b.node.elevationRange=d);null!=b.ref&&(b.ref.elevationRange=d);this.invalidateBoundingVolumeCache(a);return d};f.isNodeVisible=function(a){const b=this._getNodeInternal(a);if(null==
b||null!=b.ref&&!b.ref.mbs)return!0;this.needNodeElevationRange&&this._updateElevationRange(a);if((b.visibilityCache&-2)!==this._visibilityCacheVersion){a=b.node;const e=!a||b.ref&&!a.visibilityObb?b.ref??null:a;if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=a||null!=b.ref)&&b.filterImpact===t.NodeFilterImpact.NotChecked){var c=null!=a?a.mbs:null!=b.ref?b.ref.mbs:null;b.filterImpact=null!=c?this._computeNodeFiltering(c):t.NodeFilterImpact.Unmodified}c=null!=a&&b.filterImpact===t.NodeFilterImpact.Culled;
a=!(null!=a&&a.imModificationImpact===t.NodeIMModificationImpact.Culled)&&(!e||this._viewportQueries.isNodeVisible(e))&&!c;b.visibilityCache=this._visibilityCacheVersion+(a?1:0);return a}return 1===(b.visibilityCache&1)};f.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);return null==a||null==a.node||null==a.node.geometryObb||this.layerHasModifications&&a.node.imModificationImpact===t.NodeIMModificationImpact.NotChecked?!0:this._viewportQueries.isGeometryVisible(a.node)};
f._traverseCoverage=function(a,b,c,e,d){a=this._getPage(a);if(null!=a&&0!==b.childCount){var g=b.childOffset+b.childCount,m=[];for(b=b.childOffset;b<g;++b){const k=a.children[b],q=this._getNodeInternal(k);null!=q&&null!=q.node&&this.isGeometryVisible(k)&&m.push(q)}e/=m.length;for(const k of m)a=k.node.index,this._isLoaded(a)||this._isReloading(a)?(d.delta=Math.max(d.delta,c),d.coverage+=e):this._traverseCoverage(a,k,c+1,e,d)}};f.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;const b=
this._getNodeInternal(a);if(null==b)return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+(a?1:0);return a};f.destroy=function(){this._updates.add.prune();this._updates.update.prune()};f.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;this._version=u.addWraparound(this._version,2)};f.imModificationsChanged=function(a){this.layerHasModifications=
a;this._forAllNodes(({node:b})=>{null!=b&&(b.imModificationImpact=t.NodeIMModificationImpact.NotChecked,b.visibilityObb=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()};f.layerFilterChanged=function(a){this._layerHasFilter=a;this._forAllNodes(b=>{null!=b&&(b.filterImpact=t.NodeFilterImpact.NotChecked,b=b.node,null!=b&&this.invalidateNodeVisibilityCache(b.index))});this.invalidateVisibilityCache()};f.update=function(a,
b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a);w.clear();var e=!0,d=new N,g=new N,m=this._imModificationUncategorized;m.clear();var k=new Set;this.traverseVisible((h,l,x)=>{if(null==l)l=this._entryPriority(h),Infinity===l&&(l=this._entryPriority(x)),h=F(h,this._nodesPerPage),w.set(h,Math.max(l,w.get(h)||0)),this._loading.has(h)||this._failedPages.has(h)||
this._missing.push(h),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{var n=l.node;this._updateNodeFeatureEstimate(n,g);if(null==n)l=this._entryPriority(h),this._loading.has(h)||this._failedNodes.has(h)||(this._missing.push(h),w.set(h,l)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{x=this._getPage(h);if(0===this._missing.length&&0===this._nodesPerPage)for(let r=0;r<l.childCount;r++){const v=x.children[l.childOffset+r],z=this._getNodeInternal(v);null==z||z.node||
this._loading.has(v)||this._failedNodes.has(v)||(w.set(v,this._entryPriority(v)),this._prefetch.push(v))}n.failed||n.resources.isEmpty?e&&0<l.childCount&&this._isSelected(n)&&(e=!1):(k.add(n.id),this._isLoaded(h)?(d.known+=n.memory,++d.knownNodes,this._isSelected(n)?0<l.childCount&&(e=!1):(d.unremoved+=n.memory,e=!1),this._needsUpdate(n)&&(l=this._entryPriority(h),w.set(h,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.update.push(h))):(n.memory&&(d.known+=n.memory,++d.knownNodes),
this._isSelected(n)?(0<l.childCount&&(e=!1),n.memory?(d.missing+=n.memory,d.known+=n.memory,++d.knownNodes):++d.missingNodes,a.includes(n.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(h)),this._updates.cancel=this._updates.cancel.filter(r=>r!==n.index)):!b.done&&this._enable(n)?b.madeProgress():(l=this._entryPriority(h),w.set(h,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.add.push(h),this.layerHasModifications&&c&&null!=n&&n.imModificationImpact===
t.NodeIMModificationImpact.NotChecked&&m.push(h))):this._isReloading(h)&&this._updates.remove.push(h)))}}});var q=this._updates.add;0<q.length&&this.layerHasModifications&&(0<m.length&&c?.(m),q.filterInPlace(h=>{var l=this._getNodeInternal(h);(l=null==l||null==l.node||l.node.imModificationImpact!==t.NodeIMModificationImpact.Culled)||this.invalidateNodeVisibilityCache(h);return l}));this._unloadedMemoryEstimate=d.missing-d.unremoved;3<d.knownNodes&&0<d.missingNodes&&(this._unloadedMemoryEstimate+=
d.known/d.knownNodes*d.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(g);this._featureEstimate.leavesReached=e;this._missing.sort((h,l)=>h-l);this._missing.filterInPlace((h,l)=>1>l||this._missing.data[l-1]!==h);this._missing.sort((h,l)=>w.get(h)-w.get(l));0<this._missing.length&&(this._maxUnloadedPrio=w.get(this._missing.back()),this._prefetch.clear());this._updates.add.filterInPlace(h=>w.get(h)>=this._maxUnloadedPrio).sort((h,
l)=>w.get(h)-w.get(l));this._updates.update.sort((h,l)=>w.get(h)-w.get(l));this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;w.clear()}};f.checkFeatureTarget=function(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let e=b,d=b,g=c,m=10;for(;m--;){const k=new N;this._updateFeatureEstimate(e,k);if(this._computeFeatureEstimate(k)<=a){if(e>=b||0<k.missingNodes||0===m)break;g=e;e=.5*(e+d)}else d=e,e=.5*(e+g)}this._version=u.addWraparound(this._version,
2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,e)};f._updateFeatureEstimate=function(a,b){this._version=u.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,e)=>this._updateNodeFeatureEstimate(null!=e?e.node:void 0,b))};f._updateNodeFeatureEstimate=function(a,b){null==a||a.failed||null==a.numFeatures||(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&
(null!=a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};f._computeFeatureEstimate=function(a){let b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};f.load=function(){return this._load(this._missing)};f.prefetch=function(){this._prefetch.sort((a,b)=>w.get(a)-w.get(b));return this._load(this._prefetch)};f._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&
this._canRequest();)if(0===this._nodesPerPage)this._loadNode(a.pop());else{const b=a.pop();0<=b?this._loadPage(b):this._loadNode(b)}return!0};f.nodeTraversalState=function(a){if(null==a)return null;let b=this._nodeTraversalState.get(a.index);if(b&&(b.version&-2)===this._version)return b;const c=this._viewportQueries.getLodLevel(a),e=this._viewportQueries.hasLOD(a);var d=!0;e?(d=this.getParentIndex(a.index),null!=d?(d=this._nodeTraversalState.get(d),d=!!d&&c>d.lodLevel):d=0<c):d=0===a.childCount;if(b)return b.lodLevel=
c,b.isChosen=d,b.version=this._version+1,b;b=new t.NodeTraversalState(e,d,c,this._version+1);this._nodeTraversalState.set(a.index,b);return b};f._loadNode=async function(a){this._loading.add(a);var b=this._getNodeInternal(a).ref;if(null==b)this._failedNodes.add(a);else{b=b.id;var c=this._urlPrefix+b,e=()=>{this._loading.delete(a);0===this._missing.length&&0===this._loading.size&&this.requestUpdate()},d=null;try{d=0<=a?await this._streamDataController.request(c,"json"):await this._clientNodeLoader.loadNodeJSON(b)}catch(g){e();
O.isAbortError(g)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+c),this._failedNodes.add(a));return}e();b=this._validateNode(b,d);null!=b&&(b.obb&&this.invalidateNodeVisibilityCache(a),b=this._addNode(b,a),this.nodeTraversalState(b))}};f._validateNode=function(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",
this._layer,`Invalid bounding volume on node ${a}.`),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${a}"`);var c=b.geometryData;null==c||Array.isArray(c)&&0===c.length||Array.isArray(c)&&1===c.length&&"./geometries/0"===c[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${a}"`);c=b.attributeData;const e=this._layer.attributeStorageInfo;
null==c||Array.isArray(c)&&!c.some((k,q)=>k.href!==`./attributes/${e?.[q]?.key??`f_${q}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",this._layer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:null;const d=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-
b.featureData[0].featureRange[0]+1:void 0;var g=k=>{if(null==k)return null;var q=h=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${a}: ${h}`);if("number"===typeof k.id)q(`id ${k.id} is a number instead of a string.`);else if("string"!==typeof k.id||!Array.isArray(k.mbs))return q("Missing or invalid id."),null;if(!Array.isArray(k.mbs))return q(`Invalid bounding volume on reference ${k.id}.`),null;k.href&&k.href!=="../"+k.id&&this._logger.error("#validateNode()",
this._layer,`Invalid node href on node "${a}"`);q=k.hasOwnProperty("obb")&&!this.ignoreServiceObb?k.obb:null;k=new t.NodeBase(`${k.id}`,k.mbs);k.serviceObb=q;k.visibilityObb=this._computeVisibilityObb(k);return k};g=Array.isArray(b.children)?b.children.map(g).filter(k=>null!=k):null;const m=b.isEmpty&&!0===b.isEmpty;return{id:a,mbs:b.mbs,obb:c,children:g,resources:{isEmpty:!(b.featureData&&1<b.featureData.length)&&m,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:void 0,texture:b.textureData&&
0<b.textureData.length?a:void 0,geometry:null!=b.geometryData?a:void 0},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:d}};f.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>{null!=a.node&&(a.node.failed=!1)})};f._entryPriority=function(a){var b=this._getNodeInternal(a),c=this.getParentIndex(a);if(null==b||null==c&&null==b.node)return null==c?Infinity:this._entryPriority(c);
let e=0;b.node&&null!=c&&(c=this._nodeTraversalState.get(c),null!=c&&(e=c.lodLevel));for(c=this.progressiveLoadPenalty;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=null!=b.ref?this._viewportQueries.distToPOI(b.ref):null!=b.node?this._viewportQueries.distToPOI(b.node):0;return-b-e*(b+this.progressiveLoadPenalty)+c};f.traverseVisible=function(a){const b=this._getNodeInternal(this._rootIndex);null==b?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,null,b,a)};
f._traverseVisible=function(a,b,c,e){if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&e(a,c,b);else if(this.isNodeVisible(a)&&(e(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b?.nodeHasLOD||b.lodLevel!==this._maxLodLevel))){b=this._getPage(a);for(let d=0;d<c.childCount;d++){const g=b.children[c.childOffset+d],m=this._getNodeInternal(g);null!=m?this._traverseVisible(g,a,m,e):e(g,null,a)}}};f.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};f.traverseChildren=function(a,b){a=
a.index;const c=this._getNodeInternal(a);null!=c&&this._traverseChildren(a,c,b)};f._traverseChildren=function(a,b,c){a=this._getPage(a);if(null!=a){var e=b.childOffset+b.childCount;for(b=b.childOffset;b<e;++b){const d=a.children[b],g=this._getNodeInternal(d);null!=g&&null!=g.node&&c(g.node)&&this._traverseChildren(d,g,c)}}};f.updateChildrenLoaded=function(a,b){for(a=this.getNode(a);null!=a;)a.childrenLoaded+=b,a=this.getParent(a.index)};f.checkChildrenLoadedInvariant=function(){if(null==this.rootNode)return!0;
const a=[],b=c=>{let e=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseChildren(c,d=>{e+=b(d);return!1});c.childrenLoaded!==e&&a.push(c.index);return e};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+a.join(","));return 0<a.length};f.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;
a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){const b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};f.updateElevationInfo=function(a,b){this.needNodeElevationRange=b&&!!a&&("relative-to-ground"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);this.invalidateAllElevationRanges()};f.invalidateAllElevationRanges=function(){this._forAllNodes(a=>{Q(a);null!=a.node&&(a.node.elevationRange=null);null!=a.ref&&
(a.ref.elevationRange=null)})};f._forAllNodes=function(a){if(null!=this._clientNodePage){var b=this._clientNodePage;for(var c=0;c<b.nodes.length;c++)a(b.nodes[c],-(c+1))}for(b=0;b<this._nodePages.length;b++)if(c=this._nodePages[b]){const e=b*this._nodesPerPage;for(let d=0;d<c.nodes.length;d++)a(c.nodes[d],e+d)}};E._createClass(p,[{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"isEditable",get:function(){return this._isEditable}},
{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"isLoading",get:function(){return 0<this._indexMissing}},{key:"isPrefetching",get:function(){return 0<this._prefetch.length}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",
get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"test",get:function(){return{addNode:(a,b)=>this._addNode(a,b)}}}]);return p}();const w=new Map;let W=function(){function p(f){this.missing=f;this.update=new D({deallocator:null});this.add=new D({deallocator:null});this.remove=new D({deallocator:null});this.cancel=[]}p.prototype.reset=function(f){this.add.clear();this.update.clear();this.cancel=f};return E._createClass(p)}();
const U=[["maxScreenThreshold",t.LodMetric.MaxScreenThreshold],["screenSpaceRelative",t.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",t.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",t.LodMetric.DistanceRangeFromDefaultCamera]];let N=E._createClass(function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0});const X=B.create(),Y=B.create(),Z=B.create(),aa=B.create();I.I3SIndex=ba;I.selectErrorMetric=R;Object.defineProperty(I,Symbol.toStringTag,
{value:"Module"})});
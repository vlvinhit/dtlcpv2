// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ./enums ../../webgl-engine/core/material/RenderTexture ../../webgl-engine/core/shaderLibrary/util/AlphaCutoff ../../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Texture ../../webgl-engine/materials/pbrUtils ../../../webgl/enums".split(" "),function(p,D,x,d,t,y,E,g,F,q,w){function z(a){return a.sort((b,c)=>b.encoding-c.encoding)}function u(a,b,c){if(null==a||c===d.TextureUsage.None)return null;
for(let e=0;e<a.length;e++){const f=a[e];if(null!=f&&0!==(f.usage&c))return a=b[e],null!=a?a.id:null}return null}function G(a){switch(a){case d.TextureEncoding.KTX2:return g.TextureEncodingMimeType.KTX2_ENCODING;case d.TextureEncoding.Basis:return g.TextureEncodingMimeType.BASIS_ENCODING;case d.TextureEncoding.DDS_S3TC:return g.TextureEncodingMimeType.DDS_ENCODING;case d.TextureEncoding.PNG:return"image/png";case d.TextureEncoding.JPG:return"image/jpeg";case d.TextureEncoding.KTX_ETC2:return"image/ktx";
default:return""}}const H={ktx2:d.TextureEncoding.KTX2,basis:d.TextureEncoding.Basis,dds:d.TextureEncoding.DDS_S3TC,png:d.TextureEncoding.PNG,jpg:d.TextureEncoding.JPG,"ktx-etc2":d.TextureEncoding.KTX_ETC2},A={[g.TextureEncodingMimeType.KTX2_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.BASIS_ENCODING]:d.TextureEncoding.Basis,[g.TextureEncodingMimeType.DDS_ENCODING]:d.TextureEncoding.DDS_S3TC,"image/png":d.TextureEncoding.PNG,"image/jpg":d.TextureEncoding.JPG,"image/jpeg":d.TextureEncoding.JPG,
"image/ktx":d.TextureEncoding.KTX_ETC2},B=()=>({alphaMode:"opaque",alphaCutoff:y.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:g.CullFaceOptions.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}),I={s:w.TextureWrapMode.CLAMP_TO_EDGE,t:w.TextureWrapMode.CLAMP_TO_EDGE},J={s:w.TextureWrapMode.REPEAT,
t:w.TextureWrapMode.REPEAT};p.configureMaterial=function(a,b,c,e,f,k){const h=k.rendererTextureUsage;var l=b.metallicRoughness.baseColorFactor,m=x.clamp(b.metallicRoughness.baseColorFactor[3],0,1);a.baseColor=[l[0],l[1],l[2],m];a.hasParametersFromSource=!!b.hasParametersFromSource;a.usePBR=k.usePBR;a.mrrFactors=[b.metallicRoughness.metallicFactor,b.metallicRoughness.roughnessFactor,b.hasParametersFromSource?q.defaultSchematicMRRFactors[2]:q.defaultAdvancedMRRFactors[2]];a.emissiveFactor=b.emissiveFactor;
a.isIntegratedMesh=k.isIntegratedMesh;a.textureAlphaCutoff="mask"===b.alphaMode?b.alphaCutoff:y.defaultMaskAlphaCutoff;a.alphaDiscardMode="opaque"===b.alphaMode?g.AlphaDiscardMode.Opaque:"mask"===b.alphaMode?g.AlphaDiscardMode.Mask:g.AlphaDiscardMode.MaskBlend;l=[];m=u(e,c,(d.TextureUsage.Color|d.TextureUsage.AlphaMask)&h);null!=m&&(a.baseColorTexture=new t.RenderTexture(f,m),l.push(a.baseColorTexture.loadPromise));m=u(e,c,d.TextureUsage.MetallicRoughness&h);null!=m&&(a.metallicRoughnessTexture=new t.RenderTexture(f,
m),l.push(a.metallicRoughnessTexture.loadPromise));m=u(e,c,d.TextureUsage.Emissive&h);null!=m&&(a.emissionTexture=new t.RenderTexture(f,m),l.push(a.emissionTexture.loadPromise));m=u(e,c,d.TextureUsage.Occlusion&h);null!=m&&(a.occlusionTexture=new t.RenderTexture(f,m),l.push(a.occlusionTexture.loadPromise));c=u(e,c,d.TextureUsage.Normal&h);null!=c&&(a.normalTexture=new t.RenderTexture(f,c),l.push(a.normalTexture.loadPromise));a.commonMaterialParameters.hasSlicePlane=k.slicePlaneEnabled;a.commonMaterialParameters.doubleSided=
b.doubleSided;a.commonMaterialParameters.cullFace=b.cullFace;a.ellipsoidMode=E.getEllipsoidMode(k.viewSpatialReference);return Promise.all(l)};p.createTexture=function(a,b,c,e){if(null==a||null==a.data)return null;const f=a.data;e=e.renderingContext.parameters.maxMaxAnisotropy;const k=!a.downsampled&&1<e;c=c||!b.wrapTextures?I:J;const h=G(a.encoding);return new F.Texture(f,{mipmap:k,maxAnisotropy:e,encoding:h,wrap:c,components:a.usage&d.TextureUsage.Color?"opaque"===b.alphaMode?3:4:3,noUnpackFlip:!0})};
p.defaultMaterial=B;p.getMaterialAndTextures=function(a,b){const c=new Map,e=(v,r)=>{if(null==v)return-1;var n=c.get(v.id);if(n)return n.usage|=r,n.id;n=c.size;c.set(v.id,{id:n,usage:r});return n};var f=b.pbrMetallicRoughness;const k=f?.baseColorFactor,h=b.emissiveFactor,l=q.useSchematicPBR({normalTexture:b.normalTexture,emissiveTexture:b.emissiveTexture,emissiveFactor:b.emissiveFactor,occlusionTexture:b.occlusionTexture,metallicRoughnessTexture:f?.metallicRoughnessTexture,metallicFactor:f?.metallicFactor,
roughnessFactor:f?.roughnessFactor}),m=l?q.defaultSchematicMRRFactors[0]:f?.metallicFactor??q.defaultAdvancedMRRFactors[0],K=l?q.defaultSchematicMRRFactors[1]:f?.roughnessFactor??q.defaultAdvancedMRRFactors[1];f={baseColorFactor:k?[k[0],k[1],k[2],k[3]]:[1,1,1,1],baseColorTextureId:e(f&&f.baseColorTexture,"mask"===b.alphaMode?d.TextureUsage.Color|d.TextureUsage.AlphaMask:d.TextureUsage.Color),metallicRoughnessTextureId:e(f&&f.metallicRoughnessTexture,d.TextureUsage.MetallicRoughness),metallicFactor:m,
roughnessFactor:K};b={alphaMode:b.alphaMode,alphaCutoff:b.alphaCutoff,doubleSided:b.doubleSided,cullFace:"none"===b.cullFace?g.CullFaceOptions.None:"back"===b.cullFace?g.CullFaceOptions.Back:"front"===b.cullFace?g.CullFaceOptions.Front:g.CullFaceOptions.None,normalTextureId:e(b.normalTexture,d.TextureUsage.Normal),emissiveTextureId:e(b.emissiveTexture,d.TextureUsage.Emissive),occlusionTextureId:e(b.occlusionTexture,d.TextureUsage.Occlusion),emissiveFactor:h?[h[0],h[1],h[2]]:[0,0,0],metallicRoughness:f,
wrapTextures:!1,hasParametersFromSource:l};const C=[];c.forEach(({usage:v},r)=>{var n=null!=a&&a[r]&&a[r].formats;n=n?z(n.map(({name:L,format:M})=>({name:L,encoding:H[M]}))):[];C.push({id:r,usage:v,encodings:n})});return{material:b,textures:C}};p.getMaterialAndTexturesFromShared=function(a){var b=a&&a.materialDefinitions?Object.keys(a.materialDefinitions)[0]:null,c=a&&a.textureDefinitions?Object.keys(a.textureDefinitions)[0]:null;b=b?a.materialDefinitions?.[b]:null;c=c?a.textureDefinitions?.[c]:null;
a=B();if(null!=b){b=b.params;b.diffuse&&(a.metallicRoughness.baseColorFactor=[b.diffuse[0],b.diffuse[1],b.diffuse[2],1]);null!=b.doubleSided&&(a.doubleSided=b.doubleSided,a.cullFace=b.doubleSided?g.CullFaceOptions.None:g.CullFaceOptions.Back);if("none"===b.cullFace||"front"===b.cullFace||"back"===b.cullFace)a.cullFace="none"===b.cullFace?g.CullFaceOptions.None:"back"===b.cullFace?g.CullFaceOptions.Back:g.CullFaceOptions.Front;b.transparency&&(a.metallicRoughness.baseColorFactor[3]=x.clamp(1-b.transparency,
0,1));if(b.useVertexColorAlpha||1>a.metallicRoughness.baseColorFactor[3])a.alphaMode="blend"}b=[];if(null!=c){!c.wrap||"repeat"!==c.wrap[0]&&"repeat"!==c.wrap[1]||(a.wrapTextures=!0);let e=d.TextureUsage.Color;"rgba"===c.channels&&(a.alphaMode="blend",e|=d.TextureUsage.AlphaMask);const f=c.images[c.images.length-1],k=h=>h&&h.split("/").pop();c=Array.isArray(c.encoding)?z(c.encoding.map((h,l)=>({name:k(f.href[l]),encoding:A[h]||0}))):[{name:k(f.href),encoding:A[c.encoding]||0}];b.push({id:0,usage:e,
encodings:c});a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:b}};p.getSupportedEncodings=function(a){const b=!!a.compressedTextureS3TC;a=!!a.compressedTextureETC;const c=D("disable-feature:i3s-basis")?0:d.TextureEncoding.Basis|d.TextureEncoding.KTX2,e=c|d.TextureEncoding.DDS_S3TC;return d.TextureEncoding.JPG|d.TextureEncoding.PNG|(b?e:0)|(a?c:0)};p.selectEncoding=function(a,b){if(null!=b)return a.find(c=>0!==(c.encoding&b))};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
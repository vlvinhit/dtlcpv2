// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybeUpdating ../../../../core/reactiveUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../core/sql/WhereClause ../../../../geometry/ellipsoidUtils ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/DoubleArray ../../../../geometry/support/Ellipsoid ../../../../geometry/support/spatialReferenceUtils ../../../../chunks/sphere ../../../../geometry/support/webMercatorUtils ../../../../layers/support/FeatureFilter ./I3SUtil ../../../../geometry/SpatialReference".split(" "),
function(Z,r,M,t,ta,aa,N,ba,ca,w,da,ea,u,ua,va,fa,v,ha,ia,x,ja,F,ka,la,O,ma,P,na,Q,R){function E(f,c,e){if(null==c)return null;if("disjoint"===e&&"polygon"===c.type){e=c.rings.length;const a=c.spatialReference,b=Array(e);for(let d=0;d<e;++d){const g=F.fromValues(Infinity,Infinity,-Infinity,-Infinity);F.expandWithNestedArray(g,c.rings[d]);b[d]={type:"polygon",rings:[c.rings[d]],spatialReference:a,cache:{},aabr:g}}b.sort((d,g)=>d.aabr[0]-g.aabr[0]);const n=new Set,h=new N.PositionHint;for(c=0;c<b.length;++c){const d=
b[c],g=d.aabr[0];n.forEach(k=>{g>=k.aabr[2]?n.delete(k):d.aabr[1]>k.aabr[3]||d.aabr[3]<k.aabr[1]||!f.intersects(d,k)||(d.rings=d.rings.concat(k.rings),F.expand(d.aabr,k.aabr,d.aabr),d.cache={},n.delete(k),k=N.indexOf(b,k,b.length,h),b.splice(k,1))});n.add(d)}for(const d of b)d.aabr=void 0;return b}return[c]}function S(f,c,e,a,b){if(c[3]>=.5*(c[2]+ia.getReferenceEllipsoid(a).radius))return!0;const n=T(f,c,a);return e.every(h=>U(f,h,n,b)!==p.DISCARD)}function V(f,c,e,a,b,n,h,d){const g=h[0].spatialReference||
b.spatialReference;if(x.projectBoundingSphere(e.node.mbs,n,C,g)){n=T(f,C,g);var k=oa(d,b,g,a,e.objectHandle);for(const l of h){if(0===c.length)break;switch(U(f,l,n,d)){case p.DISCARD:c.length=0;return;case p.KEEP:continue}Q.filterInPlace(c,e.featureIds,m=>pa(f,l,m,k))}}else B.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}function oa(f,c,e,a,b){c=c.renderSpatialReference;const n=new Map,h={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,
0,0]]],spatialReference:e};h.rings[0][3]=h.rings[0][0];let d,g;switch(f){case "intersects":d=(k,l,m)=>k.intersects(l,m)?p.KEEP:p.TEST;g=G;break;case "contains":d=(k,l,m)=>k.contains(l,m)?p.TEST:p.DISCARD;g=G;break;default:d=(k,l,m)=>k.disjoint(l,m)?p.TEST:p.DISCARD,g=W}return{collection:a,object:b,type:f,maskSR:e,renderSR:c,aabbCache:n,triangle:h,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:d,geometryTest:g}}function T(f,c,e){const a={type:"point",x:c[0],y:c[1],
hasZ:!1,hasM:!1,spatialReference:e};e=!O.isWGS84(e)&&!O.isWebMercator(e);c=Number.isNaN(c[3])?0:ca.clamp(c[3],0,2*la.earth.radius);f=e?f.buffer(a,c,1):f.geodesicBuffer(a,c,1);f.type="polygon";return f}function U(f,c,e,a){switch(a){case "intersects":case "contains":return G(f,c,e);case "disjoint":return W(f,c,e)}}function G(f,c,e){return f.intersects(c,e)?f.contains(c,e)?p.KEEP:p.TEST:p.DISCARD}function W(f,c,e){return f.intersects(c,e)?f.contains(c,e)?p.DISCARD:p.TEST:p.KEEP}function pa(f,c,e,a){const {collection:b,
object:n,renderSR:h,maskSR:d,geometryTest:g,aabbCache:k}=a;var l=k.get(e);if(!l){l=b.getObjectTransform(n);b.getComponentAabb(n,e,y);var m=[[y[0],y[1],0],[y[0],y[4],0],[y[3],y[4],0],[y[3],y[1],0]];for(var q=0;4>q;++q)v.transformMat3(m[q],m[q],l.rotationScale),v.add(m[q],m[q],l.position),x.projectVectorToVector(m[q],h,m[q],d);l={type:"polygon",rings:[m],spatialReference:d,cache:{}};l.rings[0][4]=l.rings[0][0];k.set(e,l)}switch(g(f,c,l)){case p.DISCARD:return!1;case p.KEEP:return!0}const {triangle:A,
triangleTest:qa,positions:X}=a;l=A.rings[0][0];m=A.rings[0][1];q=A.rings[0][2];const D=b.getObjectTransform(n);b.getComponentPositions(n,e,X);const {indices:H,data:z,stride:I,startIndex:ra,endIndex:sa}=X;for(e=ra;e<sa;e+=3){const J=I*H[e],K=I*H[e+1],L=I*H[e+2];v.set(l,z[J],z[J+1],z[J+2]);v.set(m,z[K],z[K+1],z[K+2]);v.set(q,z[L],z[L+1],z[L+2]);v.transformMat3(l,l,D.rotationScale);v.transformMat3(m,m,D.rotationScale);v.transformMat3(q,q,D.rotationScale);v.add(l,l,D.position);v.add(m,m,D.position);v.add(q,
q,D.position);x.projectVectorToVector(l,h,l,d);x.projectVectorToVector(m,h,m,d);x.projectVectorToVector(q,h,q,d);switch(qa(f,c,A)){case p.DISCARD:return!1;case p.KEEP:return!0}}switch(a.type){case "intersects":return!1;default:return!0}}const B=ba.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");r.I3SMeshViewFilter=function(f){function c(a){a=f.call(this,a)||this;a._projectionEngineLoaded=!1;return a}M._inherits(c,f);var e=c.prototype;e.initialize=function(){da.whenOnce(()=>this.viewFilter?.geometry||
null!=this.layerFilter).then(()=>this.loadAsyncModule((new Promise((a,b)=>Z(["../../../../geometry/geometryEngine"],a,b))).then(a=>{this.destroyed||(this._geometryEngine=a)})))};e.addFilters=function(a,b,n,h){const d=this.sortedObjectIds;null!=d&&a.push(m=>Q.objectIdFilter(d,!0,m));this.addSqlFilter(a,this.parsedWhereClause);const g=w.unwrapUpdating(this._layerMaskGeometries),k=this._geometryEngine;if(null!=g&&null!=this.layerFilter&&null!=k){const m=this.layerFilter.spatialRelationship;a.push((q,
A)=>V(k,q,A,h,b,n,g,m))}const l=w.unwrapUpdating(this._viewMaskGeometries);if(null!=l&&null!=this.viewFilter&&null!=k){const m=this.viewFilter.spatialRelationship;a.push((q,A)=>V(k,q,A,h,b,n,l,m))}};e.isMBSGeometryVisible=function(a,b,n){var h=w.unwrapUpdating(this._layerMaskGeometries);const d=this._geometryEngine;if(null!=h&&null!=this.layerFilter&&null!=d){var g=this.layerFilter.spatialRelationship;b=h[0].spatialReference||b;return x.projectBoundingSphere(a,n,C,b)?S(d,C,h,b,g):(B.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),
!0)}h=w.unwrapUpdating(this._viewMaskGeometries);return null!=h&&null!=this.viewFilter&&null!=d?(g=this.viewFilter.spatialRelationship,b=h[0].spatialReference||b,x.projectBoundingSphere(a,n,C,b)?S(d,C,h,b,g):(B.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)):!0};c.checkSupport=function(a){if(null==a)return!1;if(a.timeExtent)return B.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1;a=a.spatialRelationship;
return null!=a&&Y.includes(a)?!0:(B.warn(`Filters with spatialRelationship other than ${Y.join(", ")} are not supported for mesh scene layers`),!1)};M._createClass(c,[{key:"sortedObjectIds",get:function(){if(null==this.viewFilter||null==this.viewFilter.objectIds)return null;const a=ka.doubleArrayFrom(this.viewFilter.objectIds);a.sort();return a}},{key:"parsedWhereClause",get:function(){const a=null!=this.viewFilter?this.viewFilter.where:null;if(null==a||!a)return null;try{return ha.WhereClause.create(a,
this.layerFieldsIndex)}catch(b){B.error(`Failed to parse filter where clause: ${b}`)}return null}},{key:"parsedGeometry",get:function(){const a=w.unwrapUpdating(this._viewMaskGeometries),b=w.unwrapUpdating(this._layerMaskGeometries);return null==a||null==b?a||b:b.concat(a)}},{key:"_layerMaskGeometries",get:function(){const a=this.layerFilter;return null==a?null:null==this._geometryEngine?w.updating:"disjoint"===a.spatialRelationship?a.geometries.map(b=>({type:"polygon",rings:b.rings,spatialReference:b.spatialReference,
cache:{}})):[a.geometries.reduce((b,n)=>{b.rings=[...b.rings,...n.rings];return b},{type:"polygon",rings:[],spatialReference:a.geometries[0].spatialReference,cache:{}})]}},{key:"_viewMaskGeometries",get:function(){if(null==this.viewFilter)return null;var {geometry:a}=this.viewFilter;if(null==a)return null;if(null==this.viewFilter||null==this._geometryEngine)return w.updating;const {distance:b,units:n}=this.viewFilter,h=this.viewFilter.spatialRelationship;a="mesh"===a.type?a.extent:a;if(null==b||0===
b)return E(this._geometryEngine,a,h);const d=n||ea.getUnitString(a.spatialReference);if(a.spatialReference.isWGS84)return a=this._geometryEngine.geodesicBuffer(a,b,d),E(this._geometryEngine,a,h);var g=P.project(a,R.WGS84);if(null!=g)return a=P.project(this._geometryEngine.geodesicBuffer(g,b,d),a.spatialReference),E(this._geometryEngine,a,h);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(x.load().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;g=null;
try{g=x.project(a,R.WGS84)}catch(k){}if(g)try{g=x.project(this._geometryEngine.geodesicBuffer(g,b,d),a.spatialReference)}catch(k){g=null}g||B.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${a.spatialReference.wkid}) to WGS84.`);return E(this._geometryEngine,g,h)}},{key:"updating",get:function(){return w.isUpdating(this._layerMaskGeometries)||w.isUpdating(this._viewMaskGeometries)}}]);return c}(aa);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,
"layerFilter",void 0);t.__decorate([u.property({type:na})],r.I3SMeshViewFilter.prototype,"viewFilter",void 0);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,"addSqlFilter",void 0);t.__decorate([u.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"sortedObjectIds",null);t.__decorate([u.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,
"parsedWhereClause",null);t.__decorate([u.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"parsedGeometry",null);t.__decorate([u.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null);t.__decorate([u.property({readOnly:!0})],r.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,"updating",null);t.__decorate([u.property()],r.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0);t.__decorate([u.property()],
r.I3SMeshViewFilter.prototype,"_geometryEngine",void 0);r.I3SMeshViewFilter=t.__decorate([fa.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],r.I3SMeshViewFilter);const Y=["contains","intersects","disjoint"];var p;(function(f){f[f.KEEP=0]="KEEP";f[f.DISCARD=1]="DISCARD";f[f.TEST=2]="TEST"})(p||(p={}));const C=ma.fromValues(0,0,0,0),y=ja.create();Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
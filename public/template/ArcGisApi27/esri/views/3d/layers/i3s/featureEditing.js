// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/lang","../support/attributeUtils"],function(z,D,x){function E(a,{edits:c,addedFeatures:b}){const e=new Map;c=c.addAssetFeatures;const {fieldsIndex:g,globalIdField:n}=a;if(!c||0===c.length||null==n)return e;a=B(b);for(const p of c)b=x.attributeLookup(g,p.attributes,n),b=a.get(b),null!=p.geometry&&"mesh"===p.geometry.type&&null!=b&&e.set(b,p);return e}function F(a,c){const b=c.edits.updateFeatures;if(!b||0===b.length)return new C;const e=A(c.updatedFeatures),g=new C;
c=new Map;for(let f=0;f<a.attributeStorageInfo.length;f++)c.set(a.attributeStorageInfo[f].name,f);const n=a.fieldsIndex,p=a.objectIdField,l=b.filter(f=>{f=x.attributeLookup(n,f.attributes,p);return e.has(f)});a.forEachNode((f,q)=>{const m=new Set(q);for(const r of l){const t=x.attributeLookup(n,r.attributes,p);if(!m.has(t))continue;const v=q.indexOf(t);for(const y in r.attributes){var h=a.fieldsIndex.normalizeFieldName(y);var d=g;var k=f.index,u=d.get(k);u?d=u:(u=new G,d.set(k,u),d=u);(k=null!=h&&
d.get(h))?h=k:(k=[],d.set(h,k),h=k);h.push({featureIndex:v,featureId:t,value:r.attributes[y]})}}});return g}function B(a){const c=new Map;if(!a)return c;for(const b of a)null!=b.globalId&&null!=b.objectId&&null==b.error&&c.set(b.globalId,b.objectId);return c}function A(a,c=null){const b=new Set;if(!a)return b;for(const e of a)null==e.error&&(null!=e.objectId&&-1!==e.objectId?b.add(e.objectId):null!=e.globalId&&null!=c&&(a=c.get(e.globalId),null!=a&&b.add(a)));return b}const H={setAttribute(){},setGeometry(a){},
rollback(){},commit(){}};var w;(function(a){a[a.EDITING=0]="EDITING";a[a.ROLLED_BACK=1]="ROLLED_BACK";a[a.COMMITTED=2]="COMMITTED"})(w||(w={}));const G=Map,C=Map;z.createInteractiveEditSession=function(a,c){const b=c.attributes[a.objectIdField];var e=a.sessions.get(b);if(e)return e;const g=D.clone(c.attributes),n=new Set;if(null==b)return H;const p=a.i3sOverrides.createInteractiveEditSession(b),l=new Map;let f=w.EDITING;e={setAttribute(q,m){if(f===w.EDITING){var h=a.fieldsIndex.get(q);if(h){var d=
a.attributeStorageInfo.findIndex(r=>r.name===h.name);if(!(0>d)){p.setAttribute(d,m);var k=a.attributeStorageInfo[d],u=!1;n.add(q);a.forEachNode((r,t)=>{var v=l.get(r);null==v?(t=t.indexOf(b),l.set(r,t)):t=v;if(-1!==t&&(v=a.getAttributeData(r.index))){const y=v[k.name];y&&(y[t]=m,a.setAttributeData(r.index,v,c),u=!0)}});u&&a.clearMemCache()}}}},setGeometry(q){f===w.EDITING&&p.setGeometry(q)},rollback(){if(f===w.EDITING){for(const q of n)this.setAttribute(q,g[q]);p.rollback();f=w.ROLLED_BACK;a.sessions.delete(b)}},
commit(){f===w.EDITING&&(p.commit(),f=w.COMMITTED,a.sessions.delete(b))}};a.sessions.set(b,e);return e};z.processAttributeEdits=function(a,c){var b=F(a,c);c=E(a,c);if(0!==b.size||0!==c.size){var e=new Map;for(var g=0;g<a.attributeStorageInfo.length;g++)e.set(a.attributeStorageInfo[g].name,g);var n=!1;b.forEach((m,h)=>{const d=a.getAttributeData(h);let k=!1;m.forEach((u,r)=>{const t=null!=d?d[r]:null;r=e.get(r);for(const {featureIndex:v,value:y,featureId:I}of u)t&&(t[v]=y,n=k=!0),a.i3sOverrides.updateAttributeValue(I,
r,y)});k&&a.setAttributeData(h,d,null)});n&&a.clearMemCache();var {fieldsIndex:p,i3sOverrides:l,objectIdField:f,globalIdField:q}=a;b=l.layer.associatedLayer?.infoFor3D;b=new Set(b?[...Object.values(b.assetMapFieldRoles),...Object.values(b.transformFieldRoles)]:[]);for(const [m,h]of c){l.featureAdded(m);({attributes:c}=h);for(const d in c)d!==f&&d!==q&&b.has(d)||(g=p.normalizeFieldName(d),g=null!=g?e.get(g):null,null!=g&&l.updateAttributeValue(m,g,c[d]))}}};z.processGeometryEdits=function(a,c){const b=
a.fieldsIndex,e=a.objectIdField;var g=a.globalIdField;if(null!=g){var n=new Map,p=B(c.addedFeatures),l=c.edits.addFeatures,f=A(c.updatedFeatures),q=c.edits.updateFeatures;var m=c.edits?.deleteFeatures;var h=new Map;if(m)for(const d of m){let k=m=null;"attributes"in d?(m=x.attributeLookup(b,d.attributes,e),k=x.attributeLookup(b,d.attributes,g)):(m=d.objectId,k=d.globalId);null!=k&&null!=m&&h.set(k,m)}h=A(c.deletedFeatures,h);c=c.edits.deleteFeatures;if(null!=l&&0<l.length)for(const d of l)l=x.attributeLookup(b,
d.attributes,g),l=p.get(l),null!=d.geometry&&"mesh"===d.geometry.type&&null!=l&&n.set(l,d.geometry);if(null!=q&&0<q.length)for(const d of q)g=x.attributeLookup(b,d.attributes,e),null!=d.geometry&&"mesh"===d.geometry.type&&f.has(g)&&n.set(g,d.geometry);if(null!=c&&0<c.length)for(const d of c)f=null,f="attributes"in d?x.attributeLookup(b,d.attributes,e):d.objectId,null!=f&&h.has(f)&&n.set(f,null);for(const [d,k]of n)a.i3sOverrides.updateGeometry(d,k)}};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});
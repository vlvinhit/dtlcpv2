// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/ellipsoidUtils ../../../../geometry/projection ../../../../geometry/spatialReferenceEllipsoidUtils ../../../../geometry/support/frustum ../../../../geometry/support/spatialReferenceUtils ../../../../chunks/sphere ../../../../layers/graphics/dehydratedFeatures ../graphics/elevationAlignmentUtils ../graphics/ElevationContext ../graphics/featureExpressionInfoUtils ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),
function(v,e,m,w,x,y,z,p,A,B,C,r,D,t,l,k,n){return function(){function u(a,b,c,d,g,h,E,F,q={}){this._indexSR=a;this._renderCoordsHelper=b;this._clippingArea=g;this._elevationProvider=h;this._viewingMode=E;this._options=q;this._frustum=p.create();this._useFrustumCulling=!1;this._poi=m.create();this._elevationContext=null;this.minDistance=Infinity;this.maxDistance=0;this.maxLodLevel=2;this._tmpObb=n.create();this._tmp1=m.create();this._tmp2=m.create();this._tmp3=m.create();this._tmp0=m.create();this._screenspaceErrorBias=
q.screenspaceErrorBias||1;this._progressiveLoadFactor=q.progressiveLoadFactor||1;this.updateCamera(c,d);this.engineSR=this._renderCoordsHelper.spatialReference;this.updateElevationInfo(F);this._tmpPoint=C.makeDehydratedPoint(0,0,0,a);this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||A.isPlateCarree(this.engineSR));this._indexSREllipsoidRadius=x.getReferenceEllipsoid(this._indexSR).radius}var f=u.prototype;f.updateElevationInfo=function(a){null==a?this._elevationContext=
null:(this._elevationContext=D.ElevationContext.fromElevationInfo(a),this._elevationContext.updateFeatureExpressionInfoContext(t.createContextWithoutExpressionSupport(t.extractExpressionInfo(a,!1))))};f.updateCamera=function(a,b){(this._useFrustumCulling=b)&&p.fromMatrix(a.viewMatrix,a.projectionMatrix,this._frustum);this._screenSizeFactor=1/(a.perScreenPixelRatio/2);this._camPos=a.eye;this.minDistance=Infinity;this.maxDistance=0};f.setPointOfInterest=function(a){this._poi=a};f.updateScreenSpaceErrorBias=
function(a){const b=this._screenspaceErrorBias;this._screenspaceErrorBias=a;return b};f.updateClippingArea=function(a){this._clippingArea=a};f.getElevationRange=function(a){if(null==this._elevationContext)return null;a=a.mbs;if(!a)return null;const b="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(a,this._indexSR);a=this._elevationProvider.getElevation(a[0],a[1],a[2],this._indexSR,
b);return null!=a?{min:a,max:a}:null};f.getRenderMbs=function(a){const b=a.renderMbs;if(k.isValidMbs(b))return b;a.mbs&&w.copy(b,a.mbs);if(this._elevationContext&&a.elevationRange&&Number.isFinite(a.elevationRange.min)){let c=0,d=0;switch(this._elevationContext.mode){case "relative-to-ground":c=this._elevationContext.geometryZWithOffset(b[2],this._renderCoordsHelper)+a.elevationRange.min-b[2];d=a.elevationRange.max-a.elevationRange.min;break;case "on-the-ground":c=a.elevationRange.min-b[2],d=a.elevationRange.max-
a.elevationRange.min}b[2]+=c+.5*d;b[3]+=.5*d}else this._elevationContext&&1E5>b[3]&&(this._tmpPoint.x=b[0],this._tmpPoint.y=b[1],this._tmpPoint.z=b[2],b[2]=r.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));y.projectBoundingSphere(b,this._indexSR,b,this.engineSR);return b};f.getVisibilityObb=function(a){if(null!=a.visibilityObb)return a.visibilityObb;const b=a.serviceObb,c=.01*this._indexSREllipsoidRadius;if(null==b||!a.mbs||
!k.isValidObb(b)||this._isECEFOBBInLocalMode&&b.halfSize.some(d=>d>c))return null;a.serviceObbInRenderSR=this._computeRenderObb(b,a.serviceObbInRenderSR,a.mbs[3],a.elevationRange);return a.serviceObbInRenderSR};f._computeRenderObb=function(a,b,c,d){if(null==b)b=n.create();else if(k.isValidObb(b))return b;let g=0,h=0;if(this._elevationContext&&null!=d&&Number.isFinite(d.min))switch(this._elevationContext.mode){case "relative-to-ground":g=this._elevationContext.geometryZWithOffset(a.center[2],this._renderCoordsHelper)+
d.min-a.center[2];h=d.max-d.min;break;case "on-the-ground":g=d.min-a.center[2],h=d.max-d.min}else this._elevationContext&&1E5>c&&(this._tmpPoint.x=a.center[0],this._tmpPoint.y=a.center[1],this._tmpPoint.z=a.center[2],g=r.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-a.center[2]);0<h?(k.transformObb(a,this._indexSR,this._tmpObb,this.engineSR,g),n.computeOffsetObb(this._tmpObb,0,h,this._viewingMode,b)):k.transformObb(a,this._indexSR,
b,this.engineSR,g);return b};f.isNodeVisible=function(a){const b=this.getRenderMbs(a);if(!this._isMBSinClippingArea(b))return!1;if(!this._useFrustumCulling)return!0;a=this.getVisibilityObb(a);return null!=a?n.isVisible(a,this._frustum):p.intersectsSphere(this._frustum,B.wrap(b))};f.isGeometryVisible=function(a){if(!this._useFrustumCulling)return!0;const b=a.geometryObb;return null!=b?n.isVisible(b,this._frustum):this.isNodeVisible(a)};f._isMBSinClippingArea=function(a){return null==this._clippingArea?
!0:k.intersectBoundingRectWithMbs(this._clippingArea,a)!==k.MbsIntersectResult.OUTSIDE};f._screenSpaceDiameterMbs=function(a,b){var c=this.getRenderMbs(a);a=Math.sqrt(e.squaredDistance(c,this._camPos));c=a-c[3];this._updateMinMaxDistance(a);return 0>c?.5*Number.MAX_VALUE:b/c*this._screenSizeFactor};f.calcCameraDistance=function(a){return this.calcCameraDistanceToCenter(a)-this.getRenderMbs(a)[3]};f.calcCameraDistanceToCenter=function(a){a=this.getRenderMbs(a);a=e.distance(a,this._camPos);this._updateMinMaxDistance(a);
return a};f.calcAngleDependentLoD=function(a){a=this.getRenderMbs(a);const b=a[3];a=(Math.abs(a[0]*(a[0]-this._camPos[0])+a[1]*(a[1]-this._camPos[1])+a[2]*(a[2]-this._camPos[2]))/e.length(a)+b)/e.distance(a,this._camPos);return Math.min(1,a)};f.hasLOD=function(a){return a.lodMetric!==l.LodMetric.None};f._getDistancePlanarMode=function(a,b){var c=a[0]-b[0];const d=a[1]-b[1];a=a[2]-b[2];c=c*c+d*d;b=b[3];if(c<=b*b)return Math.abs(a);b=Math.sqrt(c)-b;return Math.sqrt(a*a+b*b)};f._getDistanceGlobeMode=
function(a,b){var c=e.length(b);const d=e.length(a)-c;e.scale(this._tmp0,a,e.dot(a,b)/e.squaredLength(a));var g=e.squaredDistance(b,this._tmp0),h=b[3];if(g<=h*h)return Math.abs(d);b=e.scale(this._tmp0,b,1/c);c=e.scale(this._tmp1,b,c-h*h/2/c);g=e.subtract(this._tmp2,a,c);g=e.subtract(this._tmp2,g,e.scale(this._tmp3,b,e.dot(b,g)));c=e.add(this._tmp2,c,e.scale(this._tmp2,g,h/e.length(g)));h=e.distance(a,c);2E5<=d&&(a=e.subtract(this._tmp1,a,c),a=e.dot(a,b)/e.length(a),.08>a&&(a=1E-4),h/=a);return h};
f._getDistance=function(a,b){return this.engineSR===z.getSphericalPCPF(this.engineSR)?this._getDistanceGlobeMode(a,b):this._getDistancePlanarMode(a,b)};f._updateMinMaxDistance=function(a){0<a?(this.minDistance=Math.min(this.minDistance,a),this.maxDistance=Math.max(this.maxDistance,a)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-a))};f.getLodLevel=function(a){if(a.lodMetric===l.LodMetric.None)return 0;if(0===a.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&1>this._progressiveLoadFactor){const b=
this._screenspaceErrorBias;return this.evaluateLODmetric(a,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(a,b)?2:1:0}return this.evaluateLODmetric(a,this._screenspaceErrorBias)?this.maxLodLevel:0};f.evaluateLODmetric=function(a,b){switch(a.lodMetric){case l.LodMetric.ScreenSpaceRelative:const c=this.getRenderMbs(a),d=this._getDistance(this._camPos,c),g=2*d/this._screenSizeFactor;this._updateMinMaxDistance(d+c[3]);return a.maxError*b<=g;case l.LodMetric.MaxScreenThreshold:return b=
this._screenSpaceDiameterMbs(a,a.mbs[3]*b),this._options.angleDependentLoD&&(b*=this.calcAngleDependentLoD(a)),b<a.maxError;case l.LodMetric.RemovedFeatureDiameter:return 10>this._screenSpaceDiameterMbs(a,a.maxError)*b;case l.LodMetric.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(a)>a.maxError*b}return!1};f.distToPOI=function(a){a=this.getRenderMbs(a);return e.distance(a,this._poi)-a[3]};f.distCameraToPOI=function(){return e.distance(this._camPos,this._poi)};return v._createClass(u)}()});
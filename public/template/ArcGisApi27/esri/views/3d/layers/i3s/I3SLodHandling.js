// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],function(x,y,v,w){let z=function(){function r(a){this._layerView=a;this._lodGlobalDirty=!1}var e=r.prototype;e.startNodeLoading=function(a,b,c,d){this._maxLodLevel=d.maxLodLevel;this._index=c;this._isNodeInScaleBounds=a;this._removeNodes=b};e.shouldLoadNode=function(a){if(null==a)return!1;const b=this._index.nodeTraversalState(a);return this._isChosenMaxLOD(b)?!0:b.isChosen?
this._childrenRequireLoading(a):!1};e.setLodGlobalDirty=function(){this._lodGlobalDirty=!0};e.lodGlobalHandling=function(a){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var b=Math.max(0,Math.floor(10*(this._layerView.view.resourceController.memoryController.usedMemory-1)));f.clear();this._lodGlobalHandling(this._index.rootNode,b,!1,!!this._layerView.nodeCrossfadingEnabled);b=f.length;this._removeNodes(f,a);a=f.length<b;0!==f.length&&(this._lodGlobalDirty=!0);f.clear();return a};
e._lodGlobalHandling=function(a,b,c,d){if(null==a)return!1;const g=a.index,p=this._index,l=this._layerView;var h=p.nodeTraversalState(a);h=this._isChosenMaxLOD(h);var k=a.resources.isEmpty;if(h&&k)return 0<a.childrenLoaded&&this._removeChildrenRecursive(a),!0;k=l.isNodeLoaded(g);if(d&&k&&h){var m=!c&&this.hasNoVisibleChildren(a);l.fadeNode(g,w.FadeDirection.FadeIn,!m)}m=k&&(!l.isNodeFullyFadedIn||l.isNodeFullyFadedIn(g));if(k&&(l.updateNodeState(g,h?v.NodeState.Leaf:v.NodeState.Hole),h))return m&&
this._removeChildrenRecursive(a),m;var n=0<a.childCount;let q=n;if(n)for(n=0;n<a.childCount;n++){const t=p.getChildIndex(g,n),u=p.getNode(t);null!=u?p.isGeometryVisible(t)&&!this._lodGlobalHandling(u,b,c||m,d)&&this._isNodeInScaleBounds(u)&&(q=!1):p.isNodeVisible(t)&&(q=!1)}(b=k&&!h&&(q||f.length<b))&&f.push(g);!d||b||!k||c||q||l.fadeNode(g,w.FadeDirection.FadeIn,!1);a=a.resources.isEmpty;return q||m&&!b||a};e._removeChildrenRecursive=function(a){this._index.traverseChildren(a,b=>{(this._layerView.isNodeLoaded(b.index)||
this._layerView.isNodeReloading(b.index))&&f.push(b.index);return 0<b.childrenLoaded})};e.hasNoVisibleChildren=function(a){let b=!0;this._index.traverseChildren(a,c=>b&&this._index.isNodeVisible(c.index)?this._layerView.isNodeLoaded(c.index)?b=!1:0<c.childrenLoaded:!1);return b};e._childrenRequireLoading=function(a){let b=!1,c=!0;this._index.traverseChildren(a,d=>{if(!c||!this._index.isNodeVisible(d.index))return!1;const g=this._index.nodeTraversalState(d);this._isChosenMaxLOD(g)&&this._index.isGeometryVisible(d.index)&&
(b=!0);return this._layerView.isNodeLoaded(d.index)?c=!1:0<d.childrenLoaded});return c&&b};e._isChosenMaxLOD=function(a){return a.isChosen&&(!a.nodeHasLOD||a.lodLevel===this._maxLodLevel)};x._createClass(r,[{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}}]);return r}();const f=new y({deallocator:null});return z});
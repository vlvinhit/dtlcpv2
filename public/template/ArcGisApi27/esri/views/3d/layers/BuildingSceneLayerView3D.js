// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/handleUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../layers/buildingSublayers/BuildingGroupSublayer ./BuildingComponentSublayerView3D ./BuildingSublayerView3D ./LayerView3D ./i3s/BuildingFilterUtil ./i3s/I3SUtil ../support/updatingProperties ../../layers/BuildingSceneLayerView".split(" "),
function(q,k,r,h,w,t,x,y,z,p,m,l,K,L,A,M,B,C,D,E,F,G,H){const I=C.BuildingSublayerView3DMixin(h);h=function(u){function n(a){a=u.call(this,a)||this;a.type="building-scene-3d";a.sublayerViews=new t;a._abortController=new AbortController;a._loadingComponents=0;a._pendingWhenSublayerViews=new Map;a.ignoresMemoryFactor=!1;return a}q._inherits(n,u);var f=n.prototype;f.isUpdating=function(){return 0<this._loadingComponents||this.sublayerViews&&this.sublayerViews.some(a=>a.updating)};f.initialize=function(){F.checkSpatialReference(this.layer.spatialReference,
this.view.spatialReference,this.view.viewingMode);this._initializeSubLayerViews(this.layer.sublayers,this)};f.destroy=function(){this.sublayerViews&&(this.sublayerViews.forEach(a=>a.destroy()),this.sublayerViews=null);this._abortController=z.abortMaybe(this._abortController)};f._initializeSubLayerViews=function(a,b){const c=this,e=this.view;a.forEach(d=>{if(!d.isEmpty)if("building-group"===d.type){const g=new I({sublayer:d,view:e,parent:b});this._initializeSubLayerViews(d.sublayers,g)}else"mesh"===
d.geometryType&&(this._loadingComponents++,d.load({signal:this._abortController.signal}).then(()=>{const g=new B({sublayer:d,layerView:c,view:e,parent:b});this.sublayerViews.push(g);const v=this._pendingWhenSublayerViews.get(d);if(v){for(const J of v)J.resolve(g);this._pendingWhenSublayerViews.delete(d)}this.handles.add([m.watch(()=>g.updating,()=>this.notifyChange("updating"),m.syncAndInitial),m.watch(()=>g.updatingProgress,()=>this.notifyChange("updatingProgressValue"),m.syncAndInitial)])}).catch(g=>
{p.isAbortError(g)||y.getLogger(this).error(`Error while creating view for sublayer ${d.id}\nLayer: ${this.layer.url}\n`,g)}).then(()=>{this._loadingComponents--;this.notifyChange("updating");this.notifyChange("updatingProgressValue")}))})};f.getGraphicFromIntersectorTarget=function(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===a.sublayerUid)return b.getGraphicFromIntersectorTarget(a);return null};f.fetchPopupFeatures=async function(a,b){if(null==b||!b.clientGraphics||0===b.clientGraphics.length)return[];
var c=w.groupToMap(b.clientGraphics,d=>d.sourceLayer);const e=[];for(const [d,g]of c)c=this._findComponent(d),null!=c&&e.push(c.fetchPopupFeatures(a,{...b,clientGraphics:g}));return p.eachAlwaysValues(e).then(d=>d.flat())};f.whenGraphicBounds=function(a){const b=this._findComponent(a.sourceLayer);return null==b?Promise.reject():b.whenGraphicBounds(a)};f.getAABBFromIntersectorTarget=function(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===a.sublayerUid)return b.getAABBFromIntersectorTarget(a);
return null};f.whenSublayerView=async function(a){var b=this._findComponent(a);if(null!=b)return b;b=this._pendingWhenSublayerViews.get(a);const c=p.createResolver();b?b.push(c):this._pendingWhenSublayerViews.set(a,[c]);return c.promise};f._findComponent=function(a){return this.sublayerViews.find(b=>a===b.sublayer)};f.highlight=function(a){a instanceof r?a=[a]:a instanceof t&&(a=a.toArray());const b=[];if(Array.isArray(a)&&0<a.length&&a[0]instanceof r){const c=new Map;for(const e of a)a=c.get(e.sourceLayer),
null==a&&(a=[],c.set(e.sourceLayer,a)),a.push(e);this.sublayerViews.forEach(e=>{const d=c.get(e.sublayer);d&&b.push(e.highlight(d))})}return x.handlesGroup(b)};q._createClass(n,[{key:"filterExpression",get:function(){const a=this.layer.activeFilterId;var b=null!=a?this.layer.filters.find(c=>c.id===a):null;return(b=null!=b?b.filterBlocks?.find(c=>"solid"===c.filterMode.type):null)?b.filterExpression:null}},{key:"filterExpressions",get:function(){const a=this.layer.activeFilterId,b=null!=a?this.layer.filters.find(c=>
c.id===a):null;return b&&b.filterBlocks?b.filterBlocks.toArray().map(c=>[c.filterExpression??"",E.parseFilterMode(c)]):[]}},{key:"updatingProgressValue",get:function(){const a=this.sublayerViews,b=this._loadingComponents+(a?a.length:0);return a.reduce((c,e)=>c+e.updatingProgress,0)/b}},{key:"usedMemory",get:function(){return this.sublayerViews.reduce((a,b)=>a+b.usedMemory,0)}},{key:"unloadedMemory",get:function(){return this.sublayerViews.reduce((a,b)=>a+b.unloadedMemory,0)}}]);return n}(D.LayerView3D(H));
k.__decorate([l.property()],h.prototype,"sublayerViews",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"filterExpression",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"filterExpressions",null);k.__decorate([l.property(G.updatingProgress)],h.prototype,"updatingProgress",void 0);k.__decorate([l.property({readOnly:!0,dependsOn:[]})],h.prototype,"updatingProgressValue",null);return h=k.__decorate([A.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],h)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/FeatureEffect ../../layers/support/FeatureFilter ../../layers/support/fieldUtils ../../layers/support/floorFilterUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(t,n,x,D,z,u,p,J,K,L,E,F,G,H,f,A,B,I,v){const y=D.getLogger("esri.views.layers.FeatureLayerView");return l=>{l=function(C){function r(...a){a=C.call(this,...a)||this;a._updatingRequiredFieldsPromise=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}t._inherits(r,C);var h=r.prototype;h.initialize=function(){this.handles.add([u.watch(()=>{const a=this.layer;return[a?.elevationInfo?.featureExpressionInfo,a&&"displayField"in a?a.displayField:null,a&&"timeInfo"in
a&&a.timeInfo,a&&"renderer"in a&&a.renderer,a&&"labelingInfo"in a&&a.labelingInfo,a&&"floorInfo"in a&&a.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),u.syncAndInitial),u.on(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),u.on(()=>{const a=this.layer;return a&&"sublayers"in a?a.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])};h.highlight=function(a){throw Error("missing implementation");};h.createQuery=function(){var a=
{outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=null!=this.filter?this.filter.createQuery(a):new B(a);if("feature"===this.layer.type){const b=A.getFloorFilterClause(this);null!=b&&(a.where=a.where?`(${a.where}) AND (${b})`:b)}null!=this.timeExtent&&(a.timeExtent=null!=a.timeExtent?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};h.createAggregateQuery=function(){return new B({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})};
h.queryFeatures=function(a,b){throw Error("missing implementation");};h.queryObjectIds=function(a,b){throw Error("missing implementation");};h.queryFeatureCount=function(a,b){throw Error("missing implementation");};h.queryExtent=function(a,b){throw Error("missing implementation");};h.fetchPopupFeatures=async function(a,b){if(a=this.validateFetchPopupFeatures(b))throw a;return this.fetchClientPopupFeatures(b)};h._loadArcadeModules=function(a){return a.get("expressionInfos.length")||Array.isArray(a.content)&&
a.content.some(b=>"expression"===b.type)?I.loadArcade():Promise.resolve()};h._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})};h._updateRequiredFields=async function(){if(this.layer&&this.view){var a="3d"===this.view.type,{layer:b,layer:{fieldsIndex:d,objectIdField:e}}=this,g="renderer"in b&&b.renderer,k="orderBy"in b&&b.orderBy,
m="featureReduction"in b?b.featureReduction:null,c=new Set;g=await z.eachAlways([g?g.collectRequiredFields(c,d):null,f.collectLabelingFields(c,b),a?f.collectElevationFields(c,b):null,null!=this.filter?f.collectFilterFields(c,b,this.filter):null,null!=this.featureEffect?f.collectFilterFields(c,b,this.featureEffect.filter):null,m?f.collectFeatureReductionFields(c,b,m):null,k?f.collectOrderByInfos(c,b,k):null]);"timeInfo"in b&&b.timeInfo&&this.timeExtent&&f.collectFields(c,b.fieldsIndex,[b.timeInfo.startField,
b.timeInfo.endField]);"feature"===b.type&&(b.floorInfo&&f.collectFields(c,b.fieldsIndex,[b.floorInfo.floorField]),a&&null!=b.infoFor3D&&(null==b.globalIdField&&y.error("globalIdField missing on 3DObjectFeatureLayer"),f.collectFields(c,b.fieldsIndex,[b.globalIdField])));"subtype-group"===b.type&&(f.collectField(c,d,b.subtypeField),k=b.sublayers.map(q=>Promise.all([q.renderer?.collectRequiredFields(c,d),f.collectLabelingFields(c,q)])),await z.eachAlways(k));for(const q of g)q.error&&y.error(q.error);
f.collectField(c,d,e);a&&"displayField"in b&&b.displayField&&f.collectField(c,d,b.displayField);a=Array.from(c).sort();this._set("requiredFields",a)}};h.validateFetchPopupFeatures=function(a){if(null==a)return null;for(const b of a.clientGraphics??[]){const d=b.layer;if("popupEnabled"in d&&!d.popupEnabled)return new x("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:d});if(b.isAggregate){const e="featureReduction"in d?d.featureReduction:null;if(!(e&&"popupTemplate"in e&&e.popupEnabled&&
e.popupTemplate))return new x("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:d})}else if("popupTemplate"in d&&!v.getFetchPopupTemplate(d,a))return new x("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:d})}};h.fetchClientPopupFeatures=async function(a){const b=null!=a?a.clientGraphics:null;if(!b||0===b.length)return[];const d=Array(b.length),e=new Map,g=await this.createPopupQuery(a);for(let m=0;m<b.length;m++){const c=b[m];if(c.isAggregate){d[m]=
c;continue}var k=c.layer;if(!("popupEnabled"in k))continue;const q=f.unpackFieldNames(this.layer.fieldsIndex,g.outFields);k=v.getFetchPopupTemplate(k,a);if(null==k)continue;const w=await this._loadArcadeModules(k);w&&w.arcadeUtils.hasGeometryOperations(k)||!f.featureHasFields(q,c)?e.set(c.getObjectId(),{graphic:c,index:m}):d[m]=c}if("stream"===this.layer.type||0===e.size)return d.filter(Boolean);g.objectIds=Array.from(e.keys());try{const m=await this.layer.queryFeatures(g);for(const c of m.features){const {graphic:{geometry:q},
index:w}=e.get(c.getObjectId());c.geometry||(c.geometry=q);d[w]=c}}catch{}return d.filter(Boolean)};h.createPopupQuery=async function(a){const b=this.layer.createQuery(),d=new Set;var e=!1,g=null!=a&&a.clientGraphics?a.clientGraphics.map(k=>k.layer):[this.layer];for(const k of g)if("popupEnabled"in k&&(g=v.getFetchPopupTemplate(k,a),null!=g)){e=(e=await this._loadArcadeModules(g))&&e.arcadeUtils.hasGeometryOperations(g);e=!("point"!==this.layer.geometryType&&!e);g=await v.getRequiredFields(this.layer,
g);for(const m of g)d.add(m)}b.returnGeometry=e;b.returnZ=e;b.returnM=e;b.outFields=Array.from(d);b.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(a=A.getFloorFilterClause(this),null!=a&&(b.where=b.where?`(${b.where}) AND (${a})`:a));return b};h.canResume=function(){return!t._get(t._getPrototypeOf(r.prototype),"canResume",this).call(this)||null!=this.timeExtent&&this.timeExtent.isEmpty?!1:!0};t._createClass(r,[{key:"availableFields",get:function(){const {layer:a,layer:{fieldsIndex:b},
requiredFields:d}=this;return"outFields"in a&&a.outFields?f.fixFields(b,[...f.unpackFieldNames(b,a.outFields),...d]):f.fixFields(b,d)}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(a){this._override("featureEffect",a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){y.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",
get:function(){return!1}}]);return r}(l);n.__decorate([p.property()],l.prototype,"_updatingRequiredFieldsPromise",void 0);n.__decorate([p.property({readOnly:!0})],l.prototype,"availableFields",null);n.__decorate([p.property({type:G})],l.prototype,"featureEffect",null);n.__decorate([p.property({type:H})],l.prototype,"filter",void 0);n.__decorate([p.property(F.combinedViewLayerTimeExtentProperty)],l.prototype,"timeExtent",void 0);n.__decorate([p.property()],l.prototype,"layer",void 0);n.__decorate([p.property({type:Number})],
l.prototype,"maximumNumberOfFeatures",null);n.__decorate([p.property({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null);n.__decorate([p.property({readOnly:!0})],l.prototype,"requiredFields",void 0);n.__decorate([p.property()],l.prototype,"suspended",void 0);n.__decorate([p.property()],l.prototype,"view",void 0);return l=n.__decorate([E.subclass("esri.views.layers.FeatureLayerView")],l)}});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/handleUtils ../../../core/has ../../../core/MapUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/scaleUtils ../../../layers/support/fieldUtils ../../../layers/support/floorFilterUtils ../../../renderers/support/clickToleranceUtils ../../../rest/identify ../../../rest/support/IdentifyParameters ../../../support/arcadeOnDemand ../../../symbols/SimpleMarkerSymbol ./popupUtils".split(" "),
function(G,t,y,u,H,I,z,J,A,K,L,M,B,N,O,v,ba,P,Q,R,S,T,C,U,V,W,D,E){function F(q,m,l){const a=[],d=b=>{var k=0===b.minScale||m<=b.minScale;const e=0===b.maxScale||m>=b.maxScale;b.visible&&k&&e&&(b.sublayers?b.sublayers.forEach(d):b.popupEnabled&&(k=E.getFetchPopupTemplate(b,{...l,defaultPopupTemplateEnabled:!1}),null!=k&&a.unshift({sublayer:b,popupTemplate:k})))};(q?.toArray()??[]).reverse().map(d);return a}function X(q){return q.expressionInfos?.length||Array.isArray(q.content)&&q.content.some(m=>
"expression"===m.type)?W.loadArcade():Promise.resolve()}async function Y(q,m){if(q.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(m.map(({sublayer:l})=>l.load().then(()=>l.capabilities.operations.supportsQuery)))}catch{return!1}}async function Z(q,m){const l=q.renderer;l&&"defaultSymbol"in l&&!l.defaultSymbol&&(m=l.valueExpression?await Promise.all(m.map(a=>l.getSymbolAsync(a).then(d=>d?a:null))).then(a=>a.filter(d=>null!=d)):m.filter(a=>null!=l.getSymbol(a)));return m}
let x=null;t.MapServiceLayerViewHelper=function(q){function m(a){var d=q.call(this,a)||this;d._featuresResolutions=new WeakMap;d.highlightGraphics=null;d.highlightGraphicUpdated=null;d.updateHighlightedFeatures=B.debounce(async b=>{d.destroyed||d.updatingHandles.addPromise(d._updateHighlightedFeaturesGeometries(b).catch(()=>{}))});return d}y._inherits(m,q);var l=m.prototype;l.initialize=function(){const a=d=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(d).catch(()=>{}));
this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([N.on(()=>this.highlightGraphics,"change",d=>a(d.added),{onListenerAdd:d=>a(d)})])};l.fetchPopupFeatures=async function(a,d){const {layerView:{layer:b,view:{scale:k}}}=this;if(!a)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:b});const e=F(b.sublayers,k,d);if(!e.length)return[];const n=await Y(b,e);if(!((b.capabilities?.operations?.supportsIdentify??!0)&&10.5<=b.version||n))throw new A("fetchPopupFeatures:not-supported",
"query operation is disabled for this service",{layer:b});return n?this._fetchPopupFeaturesUsingQueries(a,e,d):this._fetchPopupFeaturesUsingIdentify(a,e,d)};l.clearHighlights=function(){this.highlightGraphics?.removeAll()};l.highlight=function(a){const d=this.highlightGraphics;if(!d)return{remove(){}};let b=null;a instanceof H?b=[a]:J.isCollection(a)&&0<a.length?b=a.toArray():Array.isArray(a)&&0<a.length&&(b=a);b=b?.filter(z.isSome);if(!b||!b.length)return K.makeHandle();for(const k of b)a=k.sourceLayer,
null!=a&&"geometryType"in a&&"point"===a.geometryType&&(k.visible=!1);d.addMany(b);return{remove:()=>{d.removeMany(b??[])}}};l._updateHighlightedFeaturesSymbols=async function(a){const {layerView:{view:d},highlightGraphics:b,highlightGraphicUpdated:k}=this;if(b&&k)for(const e of a){const n=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer;e.sourceLayer&&"geometryType"in e.sourceLayer&&"point"===e.sourceLayer.geometryType&&n&&"getSymbolAsync"in n&&n.getSymbolAsync(e).then(async c=>
{c||(c=new D);let g=null;const h="visualVariables"in n?n.visualVariables?.find(f=>"size"===f.type):void 0;h&&(x||(x=(await new Promise((f,r)=>G(["../../../renderers/visualVariables/support/visualVariableUtils"],f,r))).getSize),g=x(h,e,{view:d.type,scale:d.scale,shape:"simple-marker"===c.type?c.style:null}));g||(g="width"in c&&"height"in c&&null!=c.width&&null!=c.height?Math.max(c.width,c.height):"size"in c?c.size:16);b.includes(e)&&(e.symbol=new D({style:"square",size:g,xoffset:"xoffset"in c?c.xoffset:
0,yoffset:"yoffset"in c?c.yoffset:0}),k(e,"symbol"),e.visible=!0)})}};l._updateHighlightedFeaturesGeometries=async function(a){const {layerView:{layer:d,view:b},highlightGraphics:k,highlightGraphicUpdated:e}=this;this._highlightGeometriesResolution=a;if(e&&k?.length&&d.capabilities.operations.supportsQuery){var n=this._getTargetResolution(a);a=new Map;for(var c of k)(!this._featuresResolutions.has(c)||this._featuresResolutions.get(c)>n)&&M.getOrCreateMapValue(a,c.sourceLayer,()=>new Map).set(c.getObjectId(),
c);c=Array.from(a,([g,h])=>{const f=g.createQuery();f.objectIds=[...h.keys()];f.outFields=[g.objectIdField];f.returnGeometry=!0;f.maxAllowableOffset=n;f.outSpatialReference=b.spatialReference;return g.queryFeatures(f)});c=await Promise.all(c);if(!this.destroyed)for(const {features:g}of c)for(const h of g)(c=a.get(h.sourceLayer).get(h.getObjectId()))&&k.includes(c)&&(c.geometry=h.geometry,e(c,"geometry"),this._featuresResolutions.set(c,n))}};l._getTargetResolution=function(a){const d=a*O.getMetersPerUnitForSR(this.layerView.view.spatialReference),
b=d/16;return 10>=b?0:a/d*b};l._fetchPopupFeaturesUsingIdentify=async function(a,d,b){a=await this._createIdentifyParameters(a,d,b);if(null==a)return[];({results:a}=await U.identify(this.layerView.layer.parsedUrl,a));return a.map(k=>k.feature)};l._createIdentifyParameters=async function(a,d,b){const {floors:k,layer:e,timeExtent:n,view:{spatialReference:c,scale:g}}=this.layerView,h=null!=b?b.event:null;if(!d.length)return null;await Promise.all(d.map(({sublayer:p})=>p.load().catch(()=>{})));d=Math.min(L("mapservice-popup-identify-max-tolerance"),
e.allSublayers.reduce((p,w)=>w.renderer?C.calculateTolerance({renderer:w.renderer,event:h}):p,2));var f=this.createFetchPopupFeaturesQueryGeometry(a,d);const r=R.getResolutionForScale(g,c);b=Math.round(f.width/r);f=new Q({xmin:f.center.x-r*b,ymin:f.center.y-r*b,xmax:f.center.x+r*b,ymax:f.center.y+r*b,spatialReference:f.spatialReference});return new V({floors:k,gdbVersion:"gdbVersion"in e?e.gdbVersion:void 0,geometry:a,height:b,layerOption:"popup",mapExtent:f,returnGeometry:!0,spatialReference:c,sublayers:e.sublayers,
timeExtent:n,tolerance:d,width:b})};l._fetchPopupFeaturesUsingQueries=async function(a,d,b){const {layerView:{floors:k,timeExtent:e}}=this,n=null!=b?b.event:null;d=d.map(async({sublayer:c,popupTemplate:g})=>{await c.load().catch(()=>{});if(c.capabilities&&!c.capabilities.operations.supportsQuery)return[];var h=c.createQuery(),f=C.calculateTolerance({renderer:c.renderer,event:n}),r=this.createFetchPopupFeaturesQueryGeometry(a,f),p=new Set;const [w]=await Promise.all([E.getRequiredFields(c,g),c.renderer?.collectRequiredFields(p,
c.fieldsIndex)]);S.collectFields(p,c.fieldsIndex,w);p=Array.from(p).sort();h.geometry=r;h.outFields=p;h.timeExtent=e;k&&(p=k.clone(),p=T.getLayerFloorFilterClause(p,c),null!=p&&(h.where=h.where?`(${h.where}) AND (${p})`:p));f=this._getTargetResolution(r.width/f);r=await X(g);g="point"===c.geometryType||r&&r.arcadeUtils.hasGeometryOperations(g);g||(h.maxAllowableOffset=f);({features:h}=await c.queryFeatures(h));g=g?0:f;h=await Z(c,h);for(const aa of h)this._featuresResolutions.set(aa,g);return h});
return(await B.eachAlways(d)).reverse().reduce((c,g)=>g.value?[...c,...g.value]:c,[]).filter(z.isSome)};return y._createClass(m)}(I);u.__decorate([v.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",void 0);u.__decorate([v.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"layerView",void 0);u.__decorate([v.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0);u.__decorate([v.property({constructOnly:!0})],
t.MapServiceLayerViewHelper.prototype,"highlightGraphicUpdated",void 0);u.__decorate([v.property({constructOnly:!0})],t.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0);t.MapServiceLayerViewHelper=u.__decorate([P.subclass("esri.views.layers.support.MapService")],t.MapServiceLayerViewHelper);t.collectPopupProviders=F;t.isMapServiceLayerView=function(q,m){return"tile"===m.type||"map-image"===m.type};Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
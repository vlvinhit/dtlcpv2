// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/asyncUtils ../core/deprecate ../core/Error ../core/Logger ../core/promiseUtils ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ./input/InputManager".split(" "),function(u,v,w,n,C,x,D,p,y,q,z,G,H,I,E,F){function h(f){return null!=f&&"open"in f&&"declaredClass"in f}function A(f){return null!=
f&&"declaredClass"in f&&"dockOptions"in f}const B=f=>Object.freeze(Object.defineProperty({__proto__:null,default:f},Symbol.toStringTag,{value:"Module"}));v.PopupView=f=>{f=function(k){function m(){var a=k.apply(this,arguments)||this;a._popupSetupTask=null;a.popup={};a.popupEnabled=!0;return a}w._inherits(m,k);var g=m.prototype;g.initialize=function(){this.addHandles([q.watch(()=>[this.ui,this.popup],([a,b],d)=>{if(d){const [e,c]=d;e&&h(c)&&(c.view=null,A(c)&&e.remove(c,"popup"))}a&&h(b)&&(b.view=
this,A(b)&&a.add(b,{key:"popup",position:"manual",internal:!0}))},q.initial),this.on("click",a=>{this.popup&&this.popupEnabled&&("mouse"!==a.pointerType||0===a.button)&&(!h(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(h(this.popup)?this.popup.viewModel.handleViewClick(a):a.async(async()=>{await this.setupPopup();h(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(a)})))},F.ViewEventPriorities.WIDGET)]);q.whenOnce(()=>
this.ready&&this.popupEnabled&&!this.updating).then(()=>{new Promise((a,b)=>u(["../widgets/Popup"],d=>a(B(d)),b))})};g.destroy=function(){this.destroyed||this.closePopup()};g.openPopup=async function(a){h(this.popup)&&this.popup.open(a);try{await this.setupPopup(),this.popup?this.popup.open(a):p.getLogger(this).error(new D("view:null-popup","Popup is null and can't be opened"))}catch{}};g.closePopup=function(){this._popupSetupTask?.abort();h(this.popup)&&this.popup.close()};g.fetchPopupFeatures=async function(a,
b){await this.when();const {location:d,queryArea:e,layerViewsAndGraphics:c,clientOnlyGraphics:l}=await this._prepareFetchPopupFeatures(a,b);a=Promise.resolve(l);b=this._queryLayerPopupFeatures(e,c,b);const t=b.map(r=>r.promise);a=y.eachAlwaysValues([a,...t]).then(r=>Array.from(new Set(r.flat())));return{location:d,clientOnlyGraphics:l,allGraphicsPromise:a,promisesPerLayerView:b}};g.setupPopup=async function(){this._popupSetupTask?.abort();if(this.popup&&!h(this.popup))return this._popupSetupTask=
C.createTask(async a=>{const {default:b}=await new Promise((d,e)=>u(["../widgets/Popup"],c=>d(B(c)),e));y.throwIfAborted(a);this.popup&&!h(this.popup)&&(a=this.popup,delete a.open,delete a.close,this.popup=new b(a))}),this._popupSetupTask.promise};g._queryLayerPopupFeatures=function(a,b,d){return b.map(({layerView:e,graphics:c})=>{c=e.fetchPopupFeatures(a,{clientGraphics:c,event:null!=d?d.event:void 0,signal:null!=d?d.signal:void 0,defaultPopupTemplateEnabled:null!=d?!!d.defaultPopupTemplateEnabled:
!1});return{layerView:e,promise:c}})};g._isValidPopupGraphic=function(a,b){return a&&!!a.getEffectivePopupTemplate(null!=b&&b.defaultPopupTemplateEnabled)};g._prepareFetchPopupFeatures=async function(a,b){const {clientGraphics:d,queryArea:e,location:c}=await this._popupHitTestGraphics(a,b);a=this._getFetchPopupLayerViews();const {layerViewsAndGraphics:l,clientOnlyGraphics:t}=this._graphicsPerFetchPopupLayerView(d,a);return{clientOnlyGraphics:t,layerViewsAndGraphics:l,queryArea:e,location:c}};g._popupHitTestGraphics=
async function(a,b){var d=await this.popupHitTest(a);a=d.mapPoint;d=d.results.filter(c=>"graphic"===c.type&&this._isValidPopupGraphic(c.graphic,b));const e=d.length?d[0].mapPoint:null;return{clientGraphics:d.map(c=>c.graphic),queryArea:a,location:a||e}};g._getFetchPopupLayerViews=function(){const a=[];this.allLayerViews.forEach(b=>{this._isValidPopupLayerView(b)&&a.push(b)});null!=this.graphicsView&&this._isValidPopupLayerView(this.graphicsView)&&a.push(this.graphicsView);return a.reverse()};g._isValidPopupLayerView=
function(a){return null!=a&&(!("layer"in a)||!a.suspended)&&"fetchPopupFeatures"in a};g._graphicsPerFetchPopupLayerView=function(a,b){const d=[],e=new Map;b=b.map(c=>{const l=[];"layer"in c?e.set(c.layer,l):e.set(c.graphics,l);return{layerView:c,graphics:l}});for(const c of a)(a=e.get(c.layer)||e.get(c.sourceLayer)||null)?a.push(c):d.push(c);return{layerViewsAndGraphics:b,clientOnlyGraphics:d}};return w._createClass(m)}(f);n.__decorate([z.property({cast(k){if(!k||h(k))return k;"object"===typeof k&&
(k.open=m=>{x.deprecated(p.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"});return this.openPopup(m)},k.close=()=>{x.deprecated(p.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"});return this.closePopup()});return k}})],
f.prototype,"popup",void 0);n.__decorate([z.property()],f.prototype,"popupEnabled",void 0);return f=n.__decorate([E.subclass("esri.views.PopupView")],f)};Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
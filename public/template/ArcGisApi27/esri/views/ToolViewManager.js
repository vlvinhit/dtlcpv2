// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/clock ../core/Collection ../core/HandleOwner ../core/handleUtils ../core/has ../core/Logger ../core/maybe ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/accessorSupport/decorators/subclass ./3d/support/TextureCollection ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/interfaces ./interactive/ToolViewManagerManipulatorState".split(" "),
function(c,n,f,t,u,p,v,w,E,x,q,l,g,F,G,y,z,A,B,m,C,D){c.ToolViewManager=function(r){function h(a){var b=r.call(this,a)||this;b._clock=u.clock;b._manipulatorState=new D.ToolViewManagerManipulatorState;b.tools=new p;b.cursor=null;b._interacting=!1;b._interactingTimeout=null;b._forEachTool=d=>{for(const k of b.tools.items)if(d(k))break};return b}n._inherits(h,r);var e=h.prototype;e.initialize=function(){this.handles.add([this.view.on(B.eventTypes,a=>{this._handleInputEvent(a)},A.ViewEventPriorities.TOOL),
...m.getToolCollectionHandles(this.tools),this.tools.on("before-add",({item:a})=>{this._updateToolEditableFlag(a)}),this.tools.on("before-remove",({item:a})=>{this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs);this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])};e.destroy=function(){this.detach();this.handles.removeAll()};e._clearInteractingTimeout=function(){this._interactingTimeout=q.removeMaybe(this._interactingTimeout)};e._startInteractingTimeout=
function(){this._clearInteractingTimeout();this._interactingTimeout=this._clock.setTimeout(()=>this._interacting=!1,1E3)};e.attach=function(){"3d"===this.view.type?(this._set("textures",new z.TextureCollection(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([l.watch(()=>{const {state:a}=this.view;return"camera"in a&&a.camera},()=>this._forEachManipulator(a=>a.onViewChange())),this.view.elevationProvider?.on("elevation-change",a=>this._forEachManipulator(b=>b.onElevationChange(a))),
w.makeHandle(()=>this._set("textures",q.destroyMaybe(this.textures)))],"attached")):this.handles.add(l.watch(()=>this.view.extent,()=>this._forEachManipulator(a=>a.onViewChange())))};e.detach=function(){this.activeTool=null;this.tools.removeAll();this.handles.remove("attached");this._clearInteractingTimeout();this._interacting=!1};e._forEachManipulator=function(a){this._forEachTool(b=>{b.manipulators&&b.manipulators.forEach(({manipulator:d})=>a(d,b))})};e._handleInputEvent=function(a){let b=!1;const d=
{...a,stopPropagation:()=>{b=!0;a.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(d):this._forEachTool(k=>{!b&&k.visible&&k.handleInputEvent(d)});!b&&"key-down"===a.type&&"Escape"===a.key&&this.activeTool&&(a.stopPropagation(),this.activeTool=null);this._manipulatorState.handleInputEvent(d,this._manipulatorStateEventArgs);b||null==this.activeTool||this.activeTool.handleInputEventAfter(d);this._manipulatorState.handleHoverEvent(d,this._forEachTool);
this._updateCursor();"pointer-move"===a.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())};e._refreshToolWatchers=function(){this.handles.remove("tools");this._forEachTool(a=>{if(a instanceof t){const b=l.watch(()=>[a.cursor,a.visible,a.editable],()=>{m.areToolManipulatorsEditable(a)||this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs);this._updateCursor()});this.handles.add(b,"tools")}a.manipulators&&
this.handles.add([a.manipulators.on("after-remove",b=>{this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs,!0,b.item.manipulator)}),a.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()})],"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()};e._updateToolEditableFlag=function(a){a.setEditableFlag?.(C.EditableFlag.MANAGER,null==this.activeTool||a===
this.activeTool)};e._updateCursor=function(){let a=this._manipulatorState.cursor;null==a&&this._forEachTool(b=>null!=b.cursor&&b.visible?(a=b.cursor,!0):!1);this._get("cursor")!==a&&this._set("cursor",a)};e._removeIncompleteTools=function(a){this.tools.filter(b=>(null==a||b!==a)&&!b.created&&b.removeIncompleteOnCancel).forEach(b=>{this.tools.remove(b)})};n._createClass(h,[{key:"_manipulatorStateEventArgs",get:function(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:a=>
{this.activeTool=a},view:this.view}}},{key:"activeTool",set:function(a){if(null!=a&&!this.view.ready)x.getLogger(this).error("Cannot set active tool while view is not ready.");else if(a!==this.activeTool){var b=this.activeTool;this._set("activeTool",a);null!=b&&b.deactivate();null!=a&&a.activate();this._removeIncompleteTools(a);for(const d of this.tools)this._updateToolEditableFlag(d),a=m.areToolManipulatorsEditable(d),null!=this.activeTool&&a||this._manipulatorState.clearPointers(d,this._manipulatorStateEventArgs,
!a);this._updateCursor()}}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some(a=>a.updating)||(this.textures?.updating??!1)}},{key:"interacting",get:function(){return this._interacting}},{key:"test",get:function(){return{setClock:a=>this._clock=a}}}]);return h}(v.HandleOwner);f.__decorate([g.property({constructOnly:!0,nonNullable:!0})],c.ToolViewManager.prototype,"view",void 0);f.__decorate([g.property({readOnly:!0,nonNullable:!0})],c.ToolViewManager.prototype,"textures",
void 0);f.__decorate([g.property({value:null})],c.ToolViewManager.prototype,"activeTool",null);f.__decorate([g.property({readOnly:!0,type:p})],c.ToolViewManager.prototype,"tools",void 0);f.__decorate([g.property({readOnly:!0})],c.ToolViewManager.prototype,"cursor",void 0);f.__decorate([g.property({readOnly:!0})],c.ToolViewManager.prototype,"updating",null);f.__decorate([g.property()],c.ToolViewManager.prototype,"_interacting",void 0);f.__decorate([g.property({readOnly:!0})],c.ToolViewManager.prototype,
"interacting",null);c.ToolViewManager=f.__decorate([y.subclass("esri.views.ToolViewManager")],c.ToolViewManager);c.INTERACTING_TIMEOUT=1E3;Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
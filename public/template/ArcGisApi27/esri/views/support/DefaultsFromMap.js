// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/support/heightModelInfoUtils ../ViewingMode ./projectionUtils".split(" "),function(d,n,e,v,w,p,q,f,A,B,C,x,r,t,y){d.DefaultsFromMap=function(u){function m(a){a=
u.call(this,a)||this;a.required={tileInfo:!1,heightModelInfo:!1,extent:!1};a.defaultSpatialReference=null;a.userSpatialReference=null;a.sourcePreloadCount=10;a.priorityCollection=null;a.requiresExtentInSpatialReference=!0;a.suspended=!1;a._projectExtentTask={task:null,input:null,output:null,spatialReference:null};return a}n._inherits(m,u);var l=m.prototype;l.destroy=function(){this._projectExtentTask.task&&(this._projectExtentTask.task=p.abortMaybe(this._projectExtentTask.task));this._set("map",null)};
l._narrowDownSpatialReferenceCandidates=function(a,c){if(null==a)return c;const b=[];for(const h of a)for(const k of c)if(h.spatialReference.equals(k.spatialReference)){a=h.viewingMode;var g=k.viewingMode;a=null!=a?null!=g?a===g?a:!1:a:g;if(!1!==a){b.push({spatialReference:h.spatialReference,viewingMode:a});break}}return 0<b.length?b:null};l._pickSpatialReferenceCandidate=function(a){const c=this.defaultSpatialReference;if(null==a||1>a.length)return null!=c?{spatialReference:c,viewingMode:null}:null;
null!=c&&1<a.length&&a.some(({spatialReference:b})=>b.equals(c))&&(a=a.filter(({spatialReference:b})=>b.equals(c)));1<a.length&&a.some(({viewingMode:b})=>b!==t.ViewingMode.Local)&&(a=a.filter(({viewingMode:b})=>b!==t.ViewingMode.Local));return a[0]};l._getSupportedSpatialReferences=function(a){var c="supportedSpatialReferences"in a&&a.supportedSpatialReferences||(a.spatialReference?[a.spatialReference]:[]);if(0===c.length)return[];const b=[];for(const g of c)if(c=this.getSpatialReferenceSupport({spatialReference:g,
layer:a}),null!=c){c=null!=c.constraints?c.constraints:[{spatialReference:g,viewingMode:null}];for(const {spatialReference:h,viewingMode:k}of c)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!h.equals(this.userSpatialReference)||b.push({spatialReference:h,viewingMode:k})}return b};l._pickExtentCandidate=function(a){const c=this.spatialReference;return a.find(({extent:b})=>c.equals(b.spatialReference))||a[0]};l._collectLayers=function(a){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],
updating:!0};const c=new z;for(const b of a)if(this._collectCollection(b,c),c.preloading===this.sourcePreloadCount)break;return{layers:c.layers,updating:c.updating}};l._collectCollection=function(a,c){if(a.layers){switch(this._loadMaybe(a.parent)){case "loading":c.updating=!0;++c.preloading;return;case "failed":return}for(const b of a.layers){switch(this._loadMaybe(b)){case "failed":continue;case "loading":c.updating=!0;++c.preloading;break;case "loaded":c.updating||c.layers.push(b),"layers"in b&&
this._collectCollection({layers:b.layers},c)}if(c.preloading===this.sourcePreloadCount)break}}};l._loadMaybe=function(a){return a&&"loadStatus"in a&&null!=a.loadStatus?"not-loaded"===a.loadStatus?(a.load().catch(c=>{q.isAbortError(c)||console.log(c)}),"loading"):a.loadStatus:"loaded"};n._createClass(m,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},
{key:"spatialReference",get:function(){return null!=this.userSpatialReference?this.userSpatialReference:this._spatialReferenceTask.spatialReference}},{key:"extent",get:function(){return this._extentTask.extent}},{key:"heightModelInfo",get:function(){return this._heightModelInfoTask.heightModelInfo}},{key:"vcsWkid",get:function(){return this._heightModelInfoTask.vcsWkid}},{key:"latestVcsWkid",get:function(){return this._heightModelInfoTask.latestVcsWkid}},{key:"viewingMode",get:function(){return null==
this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}},{key:"tileInfo",get:function(){return this._tileInfoTask.tileInfo}},{key:"mapCollections",get:function(){const a=this.map?.(),c=[];null!=this.priorityCollection&&c.push(this.priorityCollection);c.push({parent:a?.basemap,layers:a?.basemap?.baseLayers},{layers:a?.layers},{parent:a?.ground,layers:a?.ground?.layers},{parent:a?.basemap,layers:a?.basemap?.referenceLayers});
return c}},{key:"_allLayers",get:function(){return this._collectLayers(this.mapCollections)}},{key:"_spatialReferenceTask",get:function(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const {layers:a,updating:c}=this._allLayers;var b=null;for(const h of a){var g=this._getSupportedSpatialReferences(h);0<g.length&&(g=this._narrowDownSpatialReferenceCandidates(b,g),null!=g&&(b=g));if(null!=b&&1===b.length)break}if(c&&(null==b||1!==b.length))return{updating:!0};b=this._pickSpatialReferenceCandidate(b);
return{spatialReference:null!=b?b.spatialReference:null,viewingMode:null!=b?b.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const {layers:a,updating:c}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(a&&0<a.length&&"tileInfo"in a[0]){const b=a[0].tileInfo;
return{tileInfo:b&&b.spatialReference.equals(this.spatialReference)?b:null,updating:!1}}return{updating:c}}},{key:"_heightModelInfoTask",get:function(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const {layers:a,updating:c}=this._allLayers;for(const b of a)if(r.supportsHeightModelInfo(b)){const g=r.deriveHeightModelInfoFromLayer(b);if(g)return{heightModelInfo:g,vcsWkid:b.spatialReference?.vcsWkid,
latestVcsWkid:b.spatialReference?.latestVcsWkid,updating:!1}}return{updating:c}}},{key:"_extentCandidatesTask",get:function(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};var a=this._allLayers;const c=a.updating,b=[];for(const h of a.layers){a="fullExtents"in h&&h.fullExtents||(null!=h.fullExtent?[h.fullExtent]:[]);var g=this.requiresExtentInSpatialReference?null:a[0];
if(g=a.find(k=>k.spatialReference.equals(this.spatialReference))??g)return{candidates:[{extent:g,layer:h}],updating:!1};if(0<this._getSupportedSpatialReferences(h).length)for(const k of a)b.push({extent:k,layer:h})}return{candidates:b,updating:c}}},{key:"_extentTask",get:function(){const {candidates:a,updating:c}=this._extentCandidatesTask;if(c)return{updating:c};if(null==a||0===a.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const b=this._pickExtentCandidate(a),
g=this.spatialReference;if(b.extent.equals(this._projectExtentTask.input)&&g.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished};null!=this._projectExtentTask.task&&(this._projectExtentTask.task=p.abortMaybe(this._projectExtentTask.task));this._projectExtentTask={input:b.extent.clone(),output:null,spatialReference:g.clone(),task:w.createTask(async h=>{try{const k=await y.projectWithEngineOrService(b.extent,
g,"portalItem"in b.layer?b.layer.portalItem:void 0,h);this._projectExtentTask={...this._projectExtentTask,task:null,output:k}}catch(k){q.isAborted(h)||(this._projectExtentTask={...this._projectExtentTask,task:null})}})};return{updating:!0}}}]);return m}(v);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"required",void 0);e.__decorate([f.property({constructOnly:!0})],d.DefaultsFromMap.prototype,"map",void 0);e.__decorate([f.property({constructOnly:!0})],d.DefaultsFromMap.prototype,"getSpatialReferenceSupport",
void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"defaultSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"userSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"sourcePreloadCount",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"priorityCollection",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"requiresExtentInSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,
"suspended",void 0);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"ready",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"heightModelInfoReady",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"spatialReference",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"extent",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"heightModelInfo",null);e.__decorate([f.property({readOnly:!0})],
d.DefaultsFromMap.prototype,"vcsWkid",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"latestVcsWkid",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"viewingMode",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"tileInfo",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"mapCollections",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_allLayers",null);e.__decorate([f.property({readOnly:!0})],
d.DefaultsFromMap.prototype,"_spatialReferenceTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_tileInfoTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_heightModelInfoTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_extentCandidatesTask",null);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"_extentTask",null);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"_projectExtentTask",void 0);
d.DefaultsFromMap=e.__decorate([x.subclass("esri.views.support.DefaultsFromMap")],d.DefaultsFromMap);let z=n._createClass(function(){this.layers=[];this.preloading=-1;this.updating=!1});Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/Error ../core/Logger ../core/MapUtils ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../core/scheduling ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ../core/support/WatchUpdatingTracking ../support/collectionUtils".split(" "),function(x,m,k,t,A,B,C,l,y,D,p,H,I,J,E,F,z){let G=function(){function u(e,
b,a){this.layer=e;this.view=b;this.layerViewImporter=a;this._controller=new AbortController;this._deferred=l.createResolver();this.done=this._started=!1;this.promise=this._deferred.promise;l.onAbort(this._controller.signal,()=>{const d=new t("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(d)})}var r=u.prototype;r.tryRecycle=function(e){if(!(this.done&&this.layerView&&"tryRecycleWith"in this.layerView))return null;const b=this.layer.type,a=this._controller.signal;
for(let d=0;d<e.length;d++){const c=e[d];if(c.type!==b)continue;const h=this.layerView.tryRecycleWith(c,{signal:a});if(h){e.splice(d,1);this.layer=c;const n=this.layerView,q=n.view;return this.promise=Promise.race([h.then(()=>{l.throwIfAborted(this._controller.signal);c.emit("layerview-destroy",{view:q,layerView:n});q.emit("layerview-destroy",{view:q,layerView:n});c.emit("layerview-create",{view:q,layerView:n});q.emit("layerview-create",{view:q,layerView:n});return n}),new Promise((v,w)=>l.onAbort(this._controller.signal,
()=>w(l.createAbortError())))])}}return null};r.destroy=function(){this._controller.abort();const {layerView:e}=this;if(e){const {layer:b,view:a}=this;b.emit("layerview-destroy",{view:a,layerView:e});a.emit("layerview-destroy",{layer:b,layerView:e})}this.done=!0;this._map=this.layerViewImporter=this.view=this.layerView=this.layer=null};r.start=async function(){if(!this._started){this._started=!0;var {_controller:{signal:e},layer:b,view:a}=this;this._map=a.map;try{await b.load({signal:e});"prefetchResources"in
b&&await b.prefetchResources?.({signal:e});let c;if("createLayerView"in b&&null!=b.createLayerView)c=await b.createLayerView(a,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(b))throw new t("layer:view-not-supported","No layerview implementation was found");var d=await this.layerViewImporter.importLayerView(b);l.throwIfAborted(e);c="default"in d?new d.default({layer:b,view:a}):new d({layer:b,view:a})}let h;d=()=>{h=C.removeMaybe(h);c.destroyed||c.destroy();c.layer=null;c.parent=null;
c.view=null;this.done=!0};h=l.onAbort(e,d);l.throwIfAborted(e);try{await c.when()}catch(n){throw d(),n;}this._map?.allLayers?.includes(b)?(this.layerView=c,b.emit("layerview-create",{view:a,layerView:c}),a.emit("layerview-create",{layer:b,layerView:c}),this.done=!0,this._deferred.resolve(c)):(d(),this._deferred.reject(new t("view:no-layerview-for-layer","The layer has been removed from the map",{layer:b})))}catch(c){b.emit("layerview-create-error",{view:a,error:c}),a.emit("layerview-create-error",
{layer:b,error:c}),this.done=!0,this._deferred.reject(new t("layerview:create-error","layerview creation failed",{layer:b,error:c}))}}};return x._createClass(u)}();k=function(u){function r(b){var a=u.call(this,b)||this;a._layerLayerViewInfoMap=new Map;a._recyclingInfoMap=new Map;a._watchUpdatingTracking=new F.WatchUpdatingTracking;a.supportsGround=!0;a._preloadLayerViewModules=()=>{const d=a.view.map?.allLayers;if(d)for(const c of d)a.layerViewImporter.hasLayerViewModule(c)&&a.layerViewImporter.importLayerView(c)};
a._reschedule=()=>{if(a.destroyed)return Promise.reject();null==a._workPromise&&(a._workPromise=l.createResolver(),a._workPromise.promise.catch(()=>{}));a.removeHandles("reschedule");a.addHandles(D.schedule(a._doWork),"reschedule");return a._workPromise.promise};a._doWork=()=>{if(!a.destroyed){var d=a.view.map;a._map!==d&&(a.clear(),a._map=d);if(null==a._workPromise)a.notifyChange("updating");else{a.removeHandles("reschedule");a.removeHandles("collection-change");var c=new Set,h=[],n=a.view.ready,
q=g=>{if(null!=g)for(const f of g)f&&(c.add(f),(g=a._layerLayerViewInfoMap.get(f))&&n?g.start():g||a._recyclingInfoMap.has(f)||h.push(f),"layers"in f&&f.layers&&q(f.layers))};for(var v of a._rootCollectionNames)q(a.get(v));for(const [g,f]of a._layerLayerViewInfoMap)c.has(g)||(a._layerLayerViewInfoMap.delete(f.layer),(v=f.tryRecycle(h))?(a.notifyChange("updating"),a._recyclingInfoMap.set(f.layer,f),v.then(()=>{a.notifyChange("updating");a._recyclingInfoMap.delete(f.layer);a._layerLayerViewInfoMap.set(f.layer,
f);a._reschedule()}).catch(()=>{a.notifyChange("updating");a._recyclingInfoMap.delete(f.layer);f.destroy();a._reschedule()})):f.destroy());for(const [g,f]of a._recyclingInfoMap)c.has(g)||(a.notifyChange("updating"),a._recyclingInfoMap.delete(f.layer),f.destroy());for(const g of h)a._createLayerView(g);a._refreshCollections();var w=[d?.ground?.layers,d?.basemap?.baseLayers,d?.basemap?.referenceLayers,d?.layers].filter(g=>!!g);c.forEach(g=>"layers"in g&&w.push(g.layers));a.addHandles(w.map(g=>a._watchUpdatingTracking.addOnCollectionChange(()=>
g,a._reschedule)),"collection-change");a._workPromise.resolve();a._workPromise=null}}};return a}x._inherits(r,u);var e=r.prototype;e.initialize=function(){this.own([y.on(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),y.watch(()=>{const b=this.view,a=b?.map;return[a?.basemap,a?.ground,a?.layers,b?.ready]},()=>this._reschedule(),y.syncAndInitial)]);this._preloadLayerViewModules();this._reschedule()};e.destroy=function(){this.clear();
z.destroyMap(this._recyclingInfoMap);z.destroyMap(this._layerLayerViewInfoMap);this._watchUpdatingTracking.destroy();this._map=null;null!=this._workPromise&&(this._workPromise.reject(l.createAbortError()),this._workPromise=null)};e.clear=function(){this.destroyed||(z.destroyMap(this._layerLayerViewInfoMap),this._refreshCollections())};e.whenLayerView=async function(b){await this._reschedule();if(!this._layerLayerViewInfoMap.has(b)){if(this._recyclingInfoMap.has(b))return this._recyclingInfoMap.get(b).promise;
throw new t("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:b});}return this._layerLayerViewInfoMap.get(b).promise};e._refreshCollections=function(){for(const [b,a]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(b),this.get(a),this.view);this.notifyChange("updating");this.notifyChange("updatingRemaining")};e._populateLayerViewsOwners=function(b,a,d){if(b&&a){var c=0;for(const h of b)(b=this._layerLayerViewInfoMap.get(h))&&b.layerView&&(b=b.layerView,
b.layer=h,b.parent=d,a.at(c)!==b&&a.splice(c,0,b),h.layers&&this._populateLayerViewsOwners(h.layers,b.layerViews,b),c+=1);c<a.length&&a.splice(c,a.length)}else a&&a.removeAll()};e._createLayerView=function(b){b.load().catch(()=>{});this.layerViewImporter.hasLayerViewModule(b)&&this.layerViewImporter.importLayerView(b);const a=new G(b,this.view,this.layerViewImporter);a.promise.then(()=>this._refreshCollections(),d=>{d&&(l.isAbortError(d)||"cancelled:layerview-create"===d.name)||A.getLogger(this).error(`Failed to create layerview for layer title:'${b.title??
"no title"}', id:'${b.id??"no id"}' of type '${b.type}'.`,{layer:b,error:d});this._refreshCollections()});this._layerLayerViewInfoMap.set(b,a);this.view.ready&&a.start();this.notifyChange("updating");this.notifyChange("updatingRemaining")};x._createClass(r,[{key:"_layersToLayerViews",get:function(){const b=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];this.supportsGround&&
b.push(["view.map.ground.layers","view.groundView.layerViews"]);return new Map(b)}},{key:"_rootCollectionNames",get:function(){return Array.from(this._layersToLayerViews.keys())}},{key:"updating",get:function(){return null!=this._workPromise||this._watchUpdatingTracking.updating||B.someMap(this._layerLayerViewInfoMap,b=>!b.done)||0<this._recyclingInfoMap.size}},{key:"updatingRemaining",get:function(){let b=0;for(const a of this._layerLayerViewInfoMap.values())a.done||++b;return b}}]);return r}(k);
m.__decorate([p.property()],k.prototype,"_workPromise",void 0);m.__decorate([p.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);m.__decorate([p.property({readOnly:!0})],k.prototype,"_layersToLayerViews",null);m.__decorate([p.property({readOnly:!0})],k.prototype,"_rootCollectionNames",null);m.__decorate([p.property()],k.prototype,"layerViewImporter",void 0);m.__decorate([p.property()],k.prototype,"supportsGround",void 0);m.__decorate([p.property({readOnly:!0})],k.prototype,"updating",
null);m.__decorate([p.property({readOnly:!0})],k.prototype,"updatingRemaining",null);m.__decorate([p.property({constructOnly:!0})],k.prototype,"view",void 0);return k=m.__decorate([E.subclass("esri.views.LayerViewManager")],k)});
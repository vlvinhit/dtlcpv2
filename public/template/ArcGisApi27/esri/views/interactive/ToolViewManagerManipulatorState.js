// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/iteratorUtils ../../core/MapUtils ../../core/mathUtils ../../core/maybe ../../core/screenUtils ./interactiveToolUtils ../support/screenUtils".split(" "),function(t,x,y,z,u,p,A,B,m){let C=function(){function q(){this._pointerLocations=new Map;this._hoveredManipulators=new Map;this._grabbedManipulators=new Map;this._draggedManipulators=new Map;this._revertToNullActiveTool=this._stopDrag=!1;this._cursor=null}var g=q.prototype;g.hasFocusedManipulators=
function(){return 0<this._grabbedManipulators.size||0<this._draggedManipulators.size};g.handleInputEvent=function(a,e){var c=()=>a.stopPropagation();switch(a.type){case "pointer-move":"mouse"===a.pointerType&&this._pointerLocations.set(a.pointerId,{x:a.x,y:a.y,pointerType:a.pointerType});break;case "drag":0<this._grabbedManipulators.size&&(this._stopDrag=!0);this._stopDrag&&(a.stopPropagation(),"end"===a.action&&(this._stopDrag=!1));break;case "pointer-down":if("mouse"===a.pointerType&&0!==a.button)break;
c=m.createScreenPointFromEvent(a);var d=this._intersect(c,a.pointerType,e.forEachTool);if(null==d)break;var b=d.manipulator,f=d.tool;null==b||null==f||!b.interactive||b.grabbable&&b.grabbableForEvent(a)||!b.grabbing||b.dragging||this._ungrabManipulatorBeforeDragging(b,a,e);null!=b&&null!=f&&b.interactive&&b.grabbable&&b.grabbableForEvent(a)&&!b.grabbing&&(this._grabbedManipulators.set(a.pointerId,{manipulator:b,tool:f,start:c,pointerType:a.pointerType}),1===this._grabbedManipulators.size&&null==e.activeTool&&
(this._revertToNullActiveTool=!0,e.setActiveTool(d.tool)),b.grabbing=!0,b.events.emit("grab-changed",{action:"start",pointerType:a.pointerType,screenPoint:c}),a.stopPropagation());break;case "pointer-up":this._draggedManipulators.has(a.pointerId)||this._handlePointerEnd(a,e);break;case "pointer-drag":if("mouse"===a.pointerType&&0!==a.button)break;f=this._grabbedManipulators.get(a.pointerId);c=p.applySome(f,({manipulator:k})=>k);d=p.applySome(f,({tool:k})=>k);if(null==c||null==d)break;b=m.createScreenPointFromEvent(a);
b.x=u.clamp(b.x,0,e.view.width);b.y=u.clamp(b.y,0,e.view.height);f=f.start;const h=this._draggedManipulators.get(a.pointerId);switch(a.action){case "start":case "update":if("update"===a.action||1===this._grabbedManipulators.size)c.dragging=!0,h?c.events.emit("drag",{action:"update",start:f,screenPoint:b}):c.events.emit("drag",{action:"start",start:f,screenPoint:b,pointerType:a.pointerType}),this._draggedManipulators.set(a.pointerId,{tool:d,manipulator:c,start:f});break;case "end":c.dragging=!1,h&&
c.events.emit("drag",{action:"end",start:f,screenPoint:b}),this._draggedManipulators.delete(a.pointerId),this._handlePointerEnd(a,e)}a.stopPropagation();break;case "immediate-click":d=m.createScreenPointFromEvent(a);const l=this._intersect(d,a.pointerType,e.forEachTool);a.native.shiftKey||e.forEachTool(k=>{if((null==l||l.tool!==k||k.automaticManipulatorSelection)&&k.manipulators){let v=!1;k.manipulators.forEach(({manipulator:w})=>{w.selected&&(w.selected=!1,v=!0)});if(v&&k.onManipulatorSelectionChanged)k.onManipulatorSelectionChanged()}});
if(null==l)break;const {manipulator:n,tool:r}=l;if(!n.interactive)break;if(n.selectable&&r.automaticManipulatorSelection&&(n.selected=!n.selected,r.onManipulatorSelectionChanged))r.onManipulatorSelectionChanged();n.events.emit("immediate-click",{screenPoint:d,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c});break;case "click":c=m.createScreenPointFromEvent(a);d=this._intersect(c,a.pointerType,e.forEachTool);d=null!=d?d.manipulator:null;if(null==d||!d.interactive)break;
d.events.emit(a.type,{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey});a.stopPropagation();break;case "double-click":d=m.createScreenPointFromEvent(a);b=this._intersect(d,a.pointerType,e.forEachTool);b=null!=b?b.manipulator:null;if(null==b||!b.interactive)break;b.events.emit("double-click",{screenPoint:d,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c});break;case "immediate-double-click":d=m.createScreenPointFromEvent(a),
b=this._intersect(d,a.pointerType,e.forEachTool),b=null!=b?b.manipulator:null,null!=b&&b.interactive&&b.events.emit("immediate-double-click",{screenPoint:d,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c})}this._onFocusChange(e.forEachTool)};g._ungrabManipulatorBeforeDragging=function(a,e,c){a.grabbing=!1;a.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:m.createScreenPointFromEvent(e)});this._grabbedManipulators.forEach(({manipulator:d},
b)=>{d===a&&this._grabbedManipulators.delete(b)});this._afterManipulatorUngrab(c.setActiveTool)};g._handlePointerEnd=function(a,e){const c=p.applySome(this._grabbedManipulators.get(a.pointerId),({manipulator:d})=>d);null!=c&&c.grabbing&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",pointerType:a.pointerType,screenPoint:m.createScreenPointFromEvent(a)}),this._grabbedManipulators.delete(a.pointerId),this._afterManipulatorUngrab(e.setActiveTool))};g._cursorFromMap=function(a){let e=null;
z.someMap(a,({manipulator:c})=>{if(null!=c&&c.interactive){if(c.grabbing&&c.grabCursor)return e=c.grabCursor,!0;if(c.cursor)return e=c.cursor,!0}return!1});return e};g._onFocusChange=function(a){this._updateCursor();this._updateFocusedManipulatorTools(a)};g._updateCursor=function(){this._cursor=0<this._grabbedManipulators.size?this._cursorFromMap(this._grabbedManipulators)||"grabbing":0<this._hoveredManipulators.size?this._cursorFromMap(this._hoveredManipulators)||"pointer":null};g._updateFocusedManipulatorTools=
function(a){const e=new Set,c=new Set;this._grabbedManipulators.forEach(({tool:d})=>{e.add(d)});this._hoveredManipulators.forEach(({tool:d})=>{c.add(d)});a(d=>{d.hasGrabbedManipulators=e.has(d);d.hasHoveredManipulators=c.has(d);var b=this._grabbedManipulators.values();b=y.find(b,({tool:f})=>f===d);d.firstGrabbedManipulator=null!=b?b.manipulator:null})};g.clearPointers=function(a,{forEachTool:e,setActiveTool:c},d=!0,b){this._grabbedManipulators.forEach(({tool:f,manipulator:h,pointerType:l},n)=>{f!==
a||null!=b&&b!==h||(this._grabbedManipulators.delete(n),h.grabbing=!1,h.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:l}))});this._draggedManipulators.forEach(({tool:f,manipulator:h},l)=>{f!==a||null!=b&&b!==h||(this._draggedManipulators.delete(l),h.dragging=!1,h.events.emit("drag",{action:"cancel"}))});d&&this._hoveredManipulators.forEach(({tool:f,manipulator:h},l)=>{f!==a||null!=b&&b!==h||(this._hoveredManipulators.delete(l),h.hovering=!1)});this._afterManipulatorUngrab(c);
this._onFocusChange(e)};g._intersect=function(a,e,c){let d=null;c(b=>{if(null==b.manipulators||!B.areToolManipulatorsEditable(b))return!1;const f=b.manipulators.intersect(a,e);if(null==f)return!1;d={tool:b,manipulator:f};return!0});return d};g.updateHoveredStateFromKnownPointers=function(a){this._pointerLocations.forEach((e,c)=>{this._updateHoveredStateForPointerAtScreenPosition(A.createScreenPoint(e.x,e.y),c,e.pointerType,a)})};g.handleHoverEvent=function(a,e){"pointer-up"!==a.type&&"immediate-click"!==
a.type&&"pointer-move"!==a.type||"mouse"!==a.pointerType||this._updateHoveredStateForPointerAtScreenPosition(m.createScreenPointFromEvent(a),a.pointerId,a.pointerType,e)};g._updateHoveredStateForPointerAtScreenPosition=function(a,e,c,d){a=this._intersect(a,c,d);c=p.applySome(this._hoveredManipulators.get(e),({manipulator:b})=>b);null==a||a.manipulator.interactive||(a=null);if(null==a||c!==a.manipulator)null!=c&&(c.hovering=!1),null!=a?(a.manipulator.hovering=!0,this._hoveredManipulators.set(e,a)):
this._hoveredManipulators.delete(e),this._onFocusChange(d)};g._afterManipulatorUngrab=function(a){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(a(null),this._revertToNullActiveTool=!1)};x._createClass(q,[{key:"cursor",get:function(){return this._cursor}}]);return q}();t.ToolViewManagerManipulatorState=C;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
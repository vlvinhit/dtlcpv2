// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/HandleOwner ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Polygon ../../../../geometry/projection ../../../../geometry/support/normalizeUtilsSync ../../../../geometry/support/typeUtils ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/data/FeatureStore ../../../../layers/graphics/data/QueryEngine ../../../../support/elevationInfoUtils ../../../../symbols/support/utils ../snappingUtils ./queryEngineUtils ./snappingCandidateElevationAlignment ./snappingCandidateElevationFilter ./symbologySnappingCandidates".split(" "),
function(g,t,h,A,B,C,D,m,n,l,O,P,E,F,q,G,H,I,J,K,L,M,u,v,w,x,N,y){g.GraphicsSnappingSource=function(z){function p(a){a=z.call(this,a)||this;a.availability=1;a._sources={multipoint:null,point:null,polygon:null,polyline:null};a._loadedWkids=new Set;a._loadedWkts=new Set;a._pendingAdds=[];a._extrudedPolygonSymbolsCount=0;return a}t._inherits(p,z);var e=p.prototype;e.destroy=function(){for(const a of this._pendingAdds)a.task.abort();this._pendingAdds.length=0;this._mapSources(a=>this._destroySource(a))};
e.initialize=function(){this.updatingHandles.add(()=>this.getGraphicsLayers(),c=>{this.updatingHandles.removeHandles("graphics-collections");for(const d of c)this._addMany(d.graphics.toArray()),this.handles.add([d.on("graphic-update",f=>this._onGraphicUpdate(f)),this.updatingHandles.addOnCollectionChange(()=>d.graphics,f=>this._onGraphicsChanged(f))],"graphics-collections")},n.initial);const {view:a}=this,{layer:b}=this.layerSource;null!=a&&"3d"===a.type&&"map-notes"!==b.type&&this.addHandles([a.elevationProvider.on("elevation-change",
({context:c})=>{M.elevationContextAffectsAlignment(c,b.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()}),n.watch(()=>b.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),n.initial),n.on(()=>b,["edits","apply-edits","graphic-update"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])};e.fetchCandidates=async function(a,b){const {point:c}=a;var d=await m.eachAlwaysValues(this._mapSources(k=>this._fetchCandidatesForSource(k,a,b)));m.throwIfAborted(b);
const f=this._getGroundElevation;d=d.flat().map(k=>w.convertSnappingCandidate(k,f));v.sortCandidatesInPlace(c,d);return d};e._fetchCandidatesForSource=async function(a,b,c){b=v.makeSnappingQuery(b,this.view?.type??"2d");a=await a.queryEngine.executeQueryForSnapping(b,c);m.throwIfAborted(c);a=await this._snappingElevationAligner.alignCandidates(a.candidates,c);m.throwIfAborted(c);const d=await this._symbologySnappingFetcher.fetch(a,c);m.throwIfAborted(c);c=0===d.length?a:[...a,...d];return this._snappingElevationFilter.filter(b,
c)};e.refresh=function(){};e._onGraphicUpdate=function(a){if(this.getGraphicsLayers().some(b=>b.graphics.includes(a.graphic)))switch(a.property){case "geometry":case "visible":this._remove(a.graphic),this._addMany([a.graphic])}};e._onGraphicsChanged=function(a){for(const b of a.removed)this._remove(b);this._addMany(a.added)};e._addMany=function(a){const b=[],c=new Map;for(const d of a)null!=d.geometry&&(this._needsInitializeProjection(d.geometry.spatialReference)?(b.push(d.geometry.spatialReference),
c.set(d.uid,d)):this._add(d));this._createPendingAdd(b,c)};e._createPendingAdd=function(a,b){if(a.length){var c=C.createTask(async k=>{await q.initializeProjection(a.map(r=>({source:r,dest:this.spatialReference})),{signal:k});this._markLoadedSpatialReferences(a);for(const [,r]of b)this._add(r)});this.updatingHandles.addPromise(c.promise);var d={task:c,graphics:b},f=()=>B.removeUnordered(this._pendingAdds,d);c.promise.then(f,f);this._pendingAdds.push(d)}};e._markLoadedSpatialReferences=function(a){for(const b of a)null!=
b.wkid&&this._loadedWkids.add(b.wkid),null!=b.wkt&&this._loadedWkts.add(b.wkt)};e._add=function(a){if(null!=a.geometry&&a.visible){var b=a.geometry;if("mesh"!==b.type){"extent"===b.type&&(b=F.fromExtent(b));var c=this._ensureSource(b.type);null!=c&&(b=this._createOptimizedFeature(a.uid,b),null!=b&&(c.featureStore.add(b),u.symbolHasExtrudeSymbolLayer(a.symbol)&&this._extrudedPolygonSymbolsCount++))}}};e._needsInitializeProjection=function(a){return null!=a.wkid&&this._loadedWkids.has(a.wkid)||null!=
a.wkt&&this._loadedWkts.has(a.wkt)?!1:!q.canProjectWithoutEngine(a,this.spatialReference)};e._createOptimizedFeature=function(a,b){b=q.project(G.normalizeCentralMeridianForDisplay(b),this.spatialReference);if(!b)return null;b=this._ensureGeometryHasZ(b);b=I.convertFromGeometry(b,this._hasZ,!1);return new J.OptimizedFeature(b,{OBJECTID:a},null,a)};e._ensureGeometryHasZ=function(a){if(!this._hasZ)return a;const b=c=>{for(;3>c.length;)c.push(0)};a=a.clone();a.hasZ=!0;switch(a.type){case "point":a.z=
a.z??0;break;case "multipoint":a.points.forEach(b);break;case "polyline":a.paths.forEach(c=>c.forEach(b));break;case "polygon":a.rings.forEach(c=>c.forEach(b))}return a};e._ensureSource=function(a){var b=this._sources[a];if(null!=b)return b;b=this._createSource(a);return this._sources[a]=b};e._createSource=function(a){var b=H.featureGeometryTypeKebabDictionary.toJSON(a);const c=this._hasZ,d=new K({geometryType:b,hasZ:c,hasM:!1});b=new L.QueryEngine({featureStore:d,fields:[{name:"OBJECTID",type:"esriFieldTypeOID",
alias:"OBJECTID"}],geometryType:b,hasM:!1,hasZ:c,objectIdField:"OBJECTID",spatialReference:this.spatialReference,scheduler:null!=this.view&&"3d"===this.view.type?this.view.resourceController.scheduler:null});return{featureStore:d,queryEngine:b,type:a}};e._remove=function(a){this._mapSources(b=>this._removeFromSource(b,a));for(const b of this._pendingAdds)b.graphics.delete(a.uid),0===b.graphics.size&&b.task.abort()};e._removeFromSource=function(a,b){a.featureStore.has(b.uid)&&(a.featureStore.removeById(b.uid),
u.symbolHasExtrudeSymbolLayer(b.symbol)&&this._extrudedPolygonSymbolsCount--)};e._destroySource=function(a){a.queryEngine.destroy();this._sources[a.type]=null};e._mapSources=function(a){const {point:b,polygon:c,polyline:d,multipoint:f}=this._sources,k=[];null!=b&&k.push(a(b));null!=c&&k.push(a(c));null!=d&&k.push(a(d));null!=f&&k.push(a(f));return k};t._createClass(p,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"_hasZ",get:function(){const a=this.view;return null!=a&&
"3d"===a.type&&"map-notes"!==this.layerSource.layer.type}},{key:"_snappingElevationAligner",get:function(){const {view:a}=this,{layer:b}=this.layerSource,c=null!=a&&"3d"===a.type;return c&&"map-notes"!==b.type?x.getSnappingCandidateElevationAligner(c,{elevationInfo:b.elevationInfo,alignPointsInFeatures:async(d,f)=>(await m.whenOrAbort(a.whenLayerView(b),f)).elevationAlignPointsInFeatures(d,f),spatialReference:a.spatialReference}):x.getSnappingCandidateElevationAligner()}},{key:"_snappingElevationFilter",
get:function(){const {view:a}=this;return N.getSnappingCandidateElevationFilter(null!=a&&"3d"===a.type&&"map-notes"!==this.layerSource.layer.type)}},{key:"_symbologySnappingFetcher",get:function(){const {view:a}=this,{layer:b}=this.layerSource,c=0<this._extrudedPolygonSymbolsCount;return null!=a&&"3d"===a.type&&"map-notes"!==b.type&&c?y.getSymbologySnappingCandidatesFetcher(c,async(d,f)=>{const k=await a.whenLayerView(b);m.throwIfAborted(f);return k.queryForSymbologySnapping({candidates:d,spatialReference:a.spatialReference},
f)}):y.getSymbologySnappingCandidatesFetcher()}},{key:"_getGroundElevation",get:function(){return w.makeGetGroundElevation(this.view)}}]);return p}(D.HandleOwnerMixin(A));h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"getGraphicsLayers",void 0);h.__decorate([l.property({constructOnly:!0})],g.GraphicsSnappingSource.prototype,"layerSource",void 0);h.__decorate([l.property({constructOnly:!0})],g.GraphicsSnappingSource.prototype,"spatialReference",void 0);h.__decorate([l.property({constructOnly:!0})],
g.GraphicsSnappingSource.prototype,"view",void 0);h.__decorate([l.property({readOnly:!0})],g.GraphicsSnappingSource.prototype,"updating",null);h.__decorate([l.property({readOnly:!0})],g.GraphicsSnappingSource.prototype,"availability",void 0);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_hasZ",null);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_snappingElevationAligner",null);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_snappingElevationFilter",
null);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_symbologySnappingFetcher",null);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_extrudedPolygonSymbolsCount",void 0);h.__decorate([l.property()],g.GraphicsSnappingSource.prototype,"_getGroundElevation",null);g.GraphicsSnappingSource=h.__decorate([E.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],g.GraphicsSnappingSource);Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
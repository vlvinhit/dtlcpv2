// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/HandleOwner ../../../core/Handles ../../../core/MapUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/common ../../../support/elevationInfoUtils ./SnappingConstraint ./SnappingDomain ./SnappingPoint ./snappingUtils ./candidates/DrapedEdgeSnappingCandidate ./candidates/EdgeSnappingCandidate ./candidates/FeatureSnappingCandidate ./candidates/RightAngleSnappingCandidate ../support/viewUtils".split(" "),
function(r,n,w,q,I,J,K,z,t,u,V,W,X,L,x,A,B,M,C,N,O,D,E,P,Q,R,F,G){function S({constraint:{start:l,end:f}}){const e=A.squaredDistance(l,f);l=x.squaredDistance(l,f);return e<M.getEpsilon()||1E-4>l/e}function y(l,f,e,a,b,c,{spatialReference:d}){f=A.copy(T,f);f[0]+=e;f[1]+=a;f[2]+=b;return(e=G.vectorToScreenPoint(f,d,C.absoluteHeightElevationInfo,c))?E.screenDistance(e,l):Infinity}n.FeatureSnappingEngine=function(l){function f(a){a=l.call(this,a)||this;a.options=null;a._domain=O.SnappingDomain.FEATURE;
a._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}};return a}w._inherits(f,l);var e=f.prototype;e.initialize=function(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),t.sync);null!=this.view&&this.handles.add([this.view.on("layerview-create",a=>this._updateLayerView(a.layer,a.layerView)),this.view.on("layerview-destroy",
a=>this._updateLayerView(a.layer,null))])};e._updateLayerView=function(a,b){for(const [,c]of this.snappingSources)c.snappingSource.layerSource.layer===a&&(c.layerView=b)};e.destroy=function(){this._set("options",null);for(const [,a]of this.snappingSources)a.destroy()};e.fetchCandidates=async function(a,b,c,d){if(!(b&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];var g=[];b=this._computeScreenSizeDistanceParameters(a,c);const h={distance:b,mode:this.view?.type??"2d",
point:a,coordinateHelper:c.coordinateHelper,...this._types};for(const [,{snappingSource:k,layerView:p}]of this.snappingSources)!k.layerSource.enabled||null!=p&&p.suspended||g.push(k.fetchCandidates(h,d).then(m=>m.filter(v=>!this._candidateIsExcluded(k,v,c.excludeFeature))));g=(await z.eachAlwaysValues(g)).flat();this._addRightAngleCandidates(g,a,b,c);z.throwIfAborted(d);E.sortCandidatesInPlace(a,g);return g};e._addRightAngleCandidates=function(a,b,c,d){var g=null!=d.vertexHandle?d.vertexHandle.rightEdge?.rightVertex?.pos:
null!=d.editGeometryOperations&&"polygon"===d.editGeometryOperations.data.type?d.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,h=null!=d.vertexHandle?d.vertexHandle.leftEdge?.leftVertex?.pos:null!=d.editGeometryOperations?d.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:k}=this;g=D.anyMapPointToSnappingPoint(g,k,d);d=D.anyMapPointToSnappingPoint(h,k,d);h=a.length;for(k=0;k<h;k++)this._addRightAngleCandidate(a[k],d,b,c,a),this._addRightAngleCandidate(a[k],
g,b,c,a)};e._addRightAngleCandidate=function(a,b,c,d,g){var h;(h=null==b)||(h=!((a instanceof Q.EdgeSnappingCandidate||a instanceof P.DrapedEdgeSnappingCandidate)&&!S(a)));if(!h){h=a.constraint.closestTo(b);var k=(h[0]-c[0])/d.x;c=(h[1]-c[1])/d.y;var {start:p,end:m}=a.constraint;1>=k*k+c*c&&(a=new F.RightAngleSnappingCandidate({targetPoint:h,otherVertex:b,otherVertexType:F.OtherVertexType.NEXT,previousVertex:x.squaredDistance(h,p)>x.squaredDistance(h,m)?p:m,constraint:new N.VerticalHalfPlaneConstraint(b,
h),objectId:a.objectId,isDraped:a.isDraped}),g.push(a))}};e._computeScreenSizeDistanceParameters=function(a,b){let c=null!=this.options?this.options.distance*("touch"===b.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:c,y:c,z:c,distance:c}:"2d"===this.view.type?(c*=this.view.resolution,{x:c,y:c,z:c,distance:c}):this._computeScreenSizeDistanceParameters3D(a,c,this.view,b)};e._computeScreenSizeDistanceParameters3D=function(a,b,c,d){var {spatialReference:g}=d;c.renderCoordsHelper.toRenderCoords(a,
g,H);const h=c.state.camera.computeScreenPixelSizeAt(H),k=h*c.renderCoordsHelper.unitInMeters/c.mapCoordsHelper.unitInMeters,p=b*k,m=G.vectorToScreenPoint(a,g,C.absoluteHeightElevationInfo,c);g=m?y(m,a,k,0,0,c,d):0;const v=m?y(m,a,0,k,0,c,d):0;a=m?y(m,a,0,0,k,c,d):0;return{x:0===g?0:p/g,y:0===v?0:p/v,z:0===a?0:p/a,distance:h*b}};e._candidateIsExcluded=function(a,b,c){if(null==c)return!1;b=this._getCandidateObjectId(b);if(null==b)return!1;a=a.layerSource.layer;return"graphics"===a.type?c.uid===b:c.sourceLayer===
a&&c.attributes&&"objectIdField"in a?c.attributes[a.objectIdField]===b:!1};e._getCandidateObjectId=function(a){return a instanceof R.FeatureSnappingCandidate?a.objectId:null};e._createSourceInfo=function(a){const b=this._createFeatureSnappingSourceType(a);if(null==b)return null;if("loading"in b)return this.updatingHandles.addPromise(b.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const c=null!=this.view?this.view.allLayerViews.find(d=>d.layer===a.layer):null;return new U(b.source,
c)};e._createFeatureSnappingSourceType=function(a){switch(a.layer.type){case "feature":case "geojson":case "csv":case "oriented-imagery":case "subtype-group":case "wfs":return this._createFeatureSnappingSourceFeatureLayer(a);case "graphics":return this._createFeatureSnappingSourceGraphicsLayer(a);case "map-notes":return this._createFeatureSnappingSourceMapNotesLayer(a);case "scene":case "building-scene":return this._createFeatureSnappingSourceSceneLayer(a)}return null};e._createFeatureSnappingSourceSceneLayer=
function(a){const {view:b}=this;if(null==b||"3d"!==b.type)return null;const c=this._getSourceModule("scene");return null!=c.module?{source:new c.module.SceneLayerSnappingSource({layerSource:a,view:b})}:{loading:c.loader}};e._createFeatureSnappingSourceFeatureLayer=function(a){switch(a.layer.source?.type){case "feature-layer":case "oriented-imagery":var b=this._getSourceModule("featureService");return null!=b.module?{source:new b.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,
view:this.view,layerSource:a})}:{loading:b.loader};case "memory":case "csv":case "geojson":case "wfs":if("mesh"!==a.layer.geometryType)return b=this._getSourceModule("featureCollection"),null!=b.module?{source:new b.module.FeatureCollectionSnappingSource({layerSource:a,view:this.view})}:{loading:b.loader}}return null};e._createFeatureSnappingSourceGraphicsLayer=function(a){const b=this._getSourceModule("graphics");return null!=b.module?{source:new b.module.GraphicsSnappingSource({getGraphicsLayers:()=>
[a.layer],spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader}};e._createFeatureSnappingSourceMapNotesLayer=function(a){const b=this._getSourceModule("notes");return null!=b.module?{source:new b.module.GraphicsSnappingSource({getGraphicsLayers:()=>null!=a.layer.sublayers?a.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:a})}:{loading:b.loader}};e._getSourceModule=function(a){const b=this._sourceModules[a];return null==
b.loader?(a=this._loadSourceModule(a).then(c=>{b.module=c}),b.loader=a,{module:b.module,loader:a}):{module:b.module,loader:b.loader}};e._loadSourceModule=function(a){const b=this.updatingHandles;switch(a){case "featureService":return b.addPromise(new Promise((c,d)=>r(["./featureSources/FeatureServiceSnappingSource"],c,d)));case "featureCollection":return b.addPromise(new Promise((c,d)=>r(["./featureSources/FeatureCollectionSnappingSource"],c,d)));case "graphics":return b.addPromise(new Promise((c,
d)=>r(["./featureSources/GraphicsSnappingSource"],c,d)));case "notes":return b.addPromise(new Promise((c,d)=>r(["./featureSources/GraphicsSnappingSource"],c,d)));case "scene":return b.addPromise(new Promise((c,d)=>r(["./featureSources/SceneLayerSnappingSource"],c,d)))}};w._createClass(f,[{key:"updating",get:function(){return K.someMap(this.snappingSources,({snappingSource:a})=>a.updating)||this.updatingHandles.updating}},{key:"snappingSources",get:function(){const a=this._get("snappingSources")||
new Map,b=new Map;if(null!=this.options&&null!=this.options.featureSources)for(const d of this.options.featureSources.items){const g=d.layer.uid;var c=a.get(g);c?(a.delete(g),b.set(g,c)):d.layer.loaded?(c=this._createSourceInfo(d),null!=c&&b.set(g,c)):this.updatingHandles.addPromise(d.layer.load())}for(const [,d]of a)d.destroy();return b}},{key:"_types",get:function(){return{returnEdge:!0,returnVertex:!0}}}]);return f}(I.HandleOwner);q.__decorate([u.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,
"spatialReference",void 0);q.__decorate([u.property({constructOnly:!0})],n.FeatureSnappingEngine.prototype,"view",void 0);q.__decorate([u.property()],n.FeatureSnappingEngine.prototype,"options",void 0);q.__decorate([u.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"updating",null);q.__decorate([u.property({readOnly:!0})],n.FeatureSnappingEngine.prototype,"snappingSources",null);n.FeatureSnappingEngine=q.__decorate([L.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],n.FeatureSnappingEngine);
let U=function(){function l(f,e){this.snappingSource=f;this.layerView=e;this.handles=new J;e=this.snappingSource.layerSource.layer;"refresh"in e&&this.handles.add(e.on("refresh",()=>f.refresh()));this.handles.add([t.watch(()=>f.updating,a=>f.layerSource.updating=a,t.syncAndInitial),t.watch(()=>f.availability,a=>f.layerSource.availability=a,t.syncAndInitial)])}l.prototype.destroy=function(){this.snappingSource.destroy();this.handles.destroy()};return w._createClass(l)}();const H=B.create(),T=B.create();
Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
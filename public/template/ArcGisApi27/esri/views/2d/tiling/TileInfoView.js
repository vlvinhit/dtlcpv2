// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(v,w,x,y,z,u){const f=new z("0/0/0/0");let A=function(){function t(a,b,c,e,k,g,h,p){this.x=a;this.ymin=b;this.ymax=c;this.invM=e;this.leftAdjust=k;this.rightAdjust=g;this.leftBound=h;this.rightBound=p}t.create=function(a,b){a[1]>b[1]&&([a,b]=[b,a]);const [c,e]=a,[k,g]=b;a=k-c;b=g-e;b=0!==b?a/b:0;const h=(Math.ceil(e)-e)*b,p=(Math.floor(e)-
e)*b;return new t(c,Math.floor(e),Math.ceil(g),b,0>a?h:p,0>a?p:h,0>a?k:c,0>a?c:k)};var l=t.prototype;l.incrRow=function(){this.x+=this.invM};l.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};l.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return v._createClass(t)}();const q=[[0,0],[0,0],[0,0],[0,0]];return function(){function t(a,b=null,c=a.lods[0].level,e=a.lods[a.lods.length-1].level){this.tileInfo=a;this.fullExtent=b;this.scales=
[];this._infoByScale={};this._infoByLevel={};const k=a.lods.filter(h=>h.level>=c&&h.level<=e);this.minScale=k[0].scale;this.maxScale=k[k.length-1].scale;const g=this._lodInfos=k.map(h=>x.create(a,h,b));k.forEach((h,p)=>{this._infoByLevel[h.level]=g[p];this._infoByScale[h.scale]=g[p];this.scales[p]=h.scale},this);this._wrap=a.isWrappable}var l=t.prototype;l.getLODInfoAt=function(a){return this._infoByLevel["number"===typeof a?a:a.level]};l.getTileBounds=function(a,b,c=!1){f.set(b);return(b=this._infoByLevel[f.level])?
b.getTileBounds(a,f,c):a};l.getTileCoords=function(a,b,c=!1){f.set(b);return(b=this._infoByLevel[f.level])?b.getTileCoords(a,f,c):a};l.getTileCoverage=function(a,b=192,c=!0,e="closest"){if(!c&&(a.scale>this.minScale||a.scale<this.maxScale))return null;c="closest"===e?this.getClosestInfoForScale(a.scale):this.getSmallestInfoForScale(a.scale);e=y.pool.acquire(c);const k=this._wrap;var g=Infinity;let h=-Infinity;const p=e.spans;q[0][0]=q[0][1]=q[1][1]=q[3][0]=-b;q[1][0]=q[2][0]=a.size[0]+b;q[2][1]=q[3][1]=
a.size[1]+b;for(d of q)a.toMap(d,d),d[0]=c.getColumnForX(d[0]),d[1]=c.getRowForY(d[1]);a=[];var d=3;for(b=0;4>b;b++)q[b][1]===q[d][1]?d=b:(d=A.create(q[b],q[d]),g=Math.min(d.ymin,g),h=Math.max(d.ymax,h),void 0===a[d.ymin]&&(a[d.ymin]=[]),a[d.ymin].push(d),d=b);if(null==g||null==h||100<h-g)return null;for(b=[];g<h;){null!=a[g]&&(b=b.concat(a[g]));d=Infinity;var m=-Infinity;for(var n=b.length-1;0<=n;n--){var r=b[n];d=Math.min(d,r.getLeftCol());m=Math.max(m,r.getRightCol())}d=Math.floor(d);m=Math.floor(m);
if(g>=c.first[1]&&g<=c.last[1])if(k)if(c.size[0]<c.worldSize[0])for(n=Math.floor(m/c.worldSize[0]),r=Math.floor(d/c.worldSize[0]);r<=n;r++)p.push(new u(g,Math.max(c.getFirstColumnForWorld(r),d),Math.min(c.getLastColumnForWorld(r),m)));else p.push(new u(g,d,m));else d>c.last[0]||m<c.first[0]||(d=Math.max(d,c.first[0]),m=Math.min(m,c.last[0]),p.push(new u(g,d,m)));g+=1;for(d=b.length-1;0<=d;d--)m=b[d],m.ymax>=g?m.incrRow():b.splice(d,1)}return e};l.getTileParentId=function(a){f.set(a);a=this._lodInfos.indexOf(this._infoByLevel[f.level])-
1;if(0>a)return null;this._getTileIdAtLOD(f,this._lodInfos[a],f);return f.id};l.getTileResolution=function(a){return(a=this._infoByLevel["object"===typeof a?a.level:a])?a.resolution:-1};l.getTileScale=function(a){return(a=this._infoByLevel[a.level])?a.scale:-1};l.intersects=function(a,b){f.set(b);b=this._infoByLevel[f.level];const c=a.lodInfo;if(c.resolution>b.resolution){this._getTileIdAtLOD(f,c,f);var e=c.denormalizeCol(f.col,f.world);for(var k of a.spans)if(k.row===f.row&&k.colFrom<=e&&k.colTo>=
e)return!0}if(c.resolution<b.resolution){const [h,p,d,m]=a.spans.reduce((n,r)=>{n[0]=Math.min(n[0],r.row);n[1]=Math.max(n[1],r.row);n[2]=Math.min(n[2],r.colFrom);n[3]=Math.max(n[3],r.colTo);return n},[Infinity,-Infinity,Infinity,-Infinity]);e=b.denormalizeCol(f.col,f.world);a=c.getColumnForX(b.getXForColumn(e));k=c.getRowForY(b.getYForRow(f.row));e=c.getColumnForX(b.getXForColumn(e+1))-1;b=c.getRowForY(b.getYForRow(f.row+1))-1;return!(a>m||e<d||k>p||b<h)}const g=c.denormalizeCol(f.col,f.world);return a.spans.some(h=>
h.row===f.row&&h.colFrom<=g&&h.colTo>=g)};l.normalizeBounds=function(a,b,c){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];this._wrap&&(b=w.getInfo(this.tileInfo.spatialReference),c=-c*(b.valid[1]-b.valid[0]),a[0]+=c,a[2]+=c);return a};l.getSmallestInfoForScale=function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a];if(a>b[0])return this._infoByScale[b[0]];for(let c=1;c<b.length-1;c++)if(a>b[c]+1E-6)return this._infoByScale[b[c-1]];return this._infoByScale[b[b.length-1]]};l.getClosestInfoForScale=
function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a];a=b.reduce((c,e)=>Math.abs(e-a)<Math.abs(c-a)?e:c,b[0]);return this._infoByScale[a]};l.scaleToLevel=function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a].level;for(let c=b.length-1;0<=c;c--)if(a<b[c])return c===b.length-1?this._infoByScale[b[b.length-1]].level:this._infoByScale[b[c]].level+(b[c]-a)/(b[c]-b[c+1]);return this._infoByScale[b[0]].level};l.scaleToZoom=function(a){return this.tileInfo.scaleToZoom(a)};
l._getTileIdAtLOD=function(a,b,c){const e=this._infoByLevel[c.level];a.set(c);if(b.resolution<e.resolution)return null;if(b.resolution===e.resolution)return a;a.level=b.level;a.col=Math.floor(c.col*e.resolution/b.resolution+.01);a.row=Math.floor(c.row*e.resolution/b.resolution+.01);return a};v._createClass(t,[{key:"spatialReference",get:function(){return this.tileInfo.spatialReference}}]);return t}()});
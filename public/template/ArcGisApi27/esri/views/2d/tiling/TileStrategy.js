// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../chunks/_rollupPluginBabelHelpers","../../../geometry/support/aaBoundingRect","./TileCache","./TileCoverage","./TileKey"],function(B,v,C,D,E){const l=new E(0,0,0,0),e=new Map,m=[],w=[];return function(){function z(a){this._previousScale=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.coveragePolicy="closest";this.resampling=!0;this.tileIndex=new Map;this.tiles=[];this.buffer=192;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;null!=
a.resampling&&(this.resampling=a.resampling);a.cachePolicy&&(this.cachePolicy=a.cachePolicy);a.coveragePolicy&&(this.coveragePolicy=a.coveragePolicy);null!=a.buffer&&(this.buffer=a.buffer);a.cacheSize&&(this._tileCache=new C(a.cacheSize,this.tileInfoView,c=>{this.releaseTile(c)}))}var n=z.prototype;n.destroy=function(){this.tileIndex.clear()};n.update=function(a){const {resampling:c,tileIndex:b}=this,{scale:f,center:t,resolution:F}=a.state,{minScale:G,maxScale:H}=this.tileInfoView,x=!a.stationary&&
f>this._previousScale;this._previousScale=f;if(!c&&(f>G||f<H))this.tiles.length=0,this.clear();else if(a=this.tileInfoView.getTileCoverage(a.state,this.buffer,this.resampling,this.coveragePolicy)){var {spans:A,lodInfo:y}=a,{level:r}=y;this.tiles.length=0;b.forEach(d=>d.visible=!0);var u=0,q=0;if(0<A.length)for(const {row:d,colFrom:p,colTo:I}of A)for(var k=p;k<=I;k++){u++;const g=l.set(r,d,y.normalizeCol(k),y.getWorldForColumn(k)).id;let h=b.get(g);if(h)h.isReady?(e.set(g,h),q++):x||this._addParentTile(g,
e);else{if(this._tileCache?.has(g)){if(h=this._tileCache.pop(g),this.tileIndex.set(g,h),h.isReady){e.set(g,h);q++;continue}}else h=this.acquireTile(l),this.tileIndex.set(g,h);x||this._addParentTile(g,e)}}u=q===u;for(const [d,p]of b)e.has(d)||(l.set(d),q=this.tileInfoView.intersects(a,l),k="purge"===this.cachePolicy?l.level!==r:l.level>r,!q||!x&&u?!k&&q||m.push(p):p.isReady?k&&"purge"===this.cachePolicy&&this._hasReadyAncestor(l,r)?m.push(p):w.push(p):k&&m.push(p));for(const d of w)d.isReady&&e.set(d.key.id,
d);for(const d of m)this._tileCache?this._tileCache.add(d):this.releaseTile(d),b.delete(d.key.id);for(const d of e.values())this.tiles.push(d);for(const d of b.values())e.has(d.key.id)||(d.visible=!1);this._tileCache?.prune(r,t,F);D.pool.release(a);w.length=0;m.length=0;e.clear()}else this.tiles.length=0,this.clear()};n.clear=function(){const {tileIndex:a}=this;for(const c of a.values())this.releaseTile(c);a.clear()};n.refresh=function(a){for(const c of this.tileIndex.values())this.tiles.includes(c)?
a(c):m.push(c);for(const c of m)this.releaseTile(c),this.tileIndex.delete(c.key.id);this._tileCache?.clear()};n.updateCacheSize=function(a){this._tileCache&&(this._tileCache.maxSize=a)};n._addParentTile=function(a,c){let b=null;for(;;){a=this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)){if(b=this.tileIndex.get(a),b?.isReady){c.has(b.key.id)||c.set(b.key.id,b);break}}else if(this._tileCache?.has(a)&&(b=this._tileCache.pop(a),this.tileIndex.set(a,b),b?.isReady)){c.has(b.key.id)||
c.set(b.key.id,b);break}}};n._hasReadyAncestor=function(a,c){const b=v.create();this.tileInfoView.getTileBounds(b,a,!0);for(const f of this.tileIndex.values())if(f.isReady&&f.key.level>=c&&f.key.level<a.level){const t=v.create();this.tileInfoView.getTileBounds(t,f.key,!0);if(v.contains(t,b))return!0}return!1};return B._createClass(z)}()});
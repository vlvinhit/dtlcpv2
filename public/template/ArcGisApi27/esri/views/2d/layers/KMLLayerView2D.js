// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../kernel ../../../core/Collection ../../../core/maybe ../../../core/reactiveUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/projection ../../../geometry/SpatialReference ../../../layers/support/kmlUtils ../../../rest/utils ../../../support/GraphicsCollection ../engine/Bitmap ../engine/BitmapContainer ./LayerView2D ./graphics/GraphicContainer ./graphics/GraphicsView2D ../../layers/LayerView ../../support/imageReprojection".split(" "),
function(t,m,G,H,n,I,u,q,l,Q,R,J,B,v,C,p,K,w,L,M,N,x,y,O,P){let D=t._createClass(function(){this.allSublayers=new Map;this.allPoints=[];this.allPolylines=[];this.allPolygons=[];this.allMapImages=[]});l=function(E){function z(){var a=E.apply(this,arguments)||this;a._bitmapIndex=new Map;a._mapImageContainer=new M.BitmapContainer;a._kmlVisualData=new D;a._fetchController=null;a.allVisiblePoints=new w.GraphicsCollection;a.allVisiblePolylines=new w.GraphicsCollection;a.allVisiblePolygons=new w.GraphicsCollection;
a.allVisibleMapImages=new H;return a}t._inherits(z,E);var f=z.prototype;f.hitTest=async function(a,b){const d=this.layer;return[this._pointsView?.hitTest(a),this._polylinesView?.hitTest(a),this._polygonsView?.hitTest(a)].flat().filter(Boolean).map(g=>{g.layer=d;g.sourceLayer=d;return{type:"graphic",graphic:g,layer:d,mapPoint:a}})};f.update=function(a){this._polygonsView&&this._polygonsView.processUpdate(a);this._polylinesView&&this._polylinesView.processUpdate(a);this._pointsView&&this._pointsView.processUpdate(a)};
f.attach=function(){this._fetchController=new AbortController;this.container.addChild(this._mapImageContainer);this._polygonsView=new y({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)});this.container.addChild(this._polygonsView.container);this._polylinesView=new y({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)});
this.container.addChild(this._polylinesView.container);this._pointsView=new y({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new x(this.view.featuresTilingScheme)});this.container.addChild(this._pointsView.container);this.addAttachHandles([this.allVisibleMapImages.on("change",a=>{a.added.forEach(b=>this._addMapImage(b));a.removed.forEach(b=>this._removeMapImage(b))}),I.watch(()=>this.layer.visibleSublayers,a=>{for(const [,b]of this._kmlVisualData.allSublayers)b.visibility=
0;for(const b of a)if(a=this._kmlVisualData.allSublayers.get(b.id))a.visibility=1;this._refreshCollections()})]);this.updatingHandles.addPromise(this._fetchService(this._fetchController.signal));this._imageReprojector=new P.ImageReprojector};f.detach=function(){this._fetchController=n.abortMaybe(this._fetchController);this._mapImageContainer.removeAllChildren();this.container.removeAllChildren();this._bitmapIndex.clear();this._polygonsView=n.destroyMaybe(this._polygonsView);this._polylinesView=n.destroyMaybe(this._polylinesView);
this._pointsView=n.destroyMaybe(this._pointsView);this._imageReprojector=n.destroyMaybe(this._imageReprojector)};f.moveStart=function(){};f.viewChange=function(){this._polygonsView.viewChange();this._polylinesView.viewChange();this._pointsView.viewChange()};f.moveEnd=function(){};f.isUpdating=function(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating};f._addMapImage=function(a){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&
this._imageReprojector.loadAndReprojectBitmapData(a.href,B.fromJSON(a.extent),this.view.spatialReference).then(b=>{const d=new L.Bitmap(b.bitmapData);d.x=b.extent.xmin;d.y=b.extent.ymax;d.resolution=b.extent.width/b.bitmapData.width;d.rotation=a.rotation;this._mapImageContainer.addChild(d);this._bitmapIndex.set(a,d)})};f._getViewDependentUrl=async function(a,b){const {viewFormat:d,viewBoundScale:g,httpQuery:e}=a;if(null!=d){if(null==b)throw Error("Loading this network link requires a view state.");
await v.load();if(null!=g&&1!==g){var c=new B(b.extent);c.expand(g)}else c=b.extent;c=v.project(c,C.WGS84);var k=v.project(c,C.WebMercator);k=Math.max(k.width,k.height);const r={"[bboxWest]":c.xmin.toString(),"[bboxEast]":c.xmax.toString(),"[bboxSouth]":c.ymin.toString(),"[bboxNorth]":c.ymax.toString(),"[lookatLon]":c.center.x.toString(),"[lookatLat]":c.center.y.toString(),"[lookatRange]":k.toString(),"[lookatTilt]":"0","[lookatHeading]":b.rotation.toString(),"[lookatTerrainLon]":c.center.x.toString(),
"[lookatTerrainLat]":c.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":c.center.x.toString(),"[cameraLat]":c.center.y.toString(),"[cameraAlt]":k.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":(b.size[0]*b.pixelRatio).toString(),"[vertPixels]":(b.size[1]*b.pixelRatio).toString(),"[terrainEnabled]":"0","[clientVersion]":G.version,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"};k=h=>{for(const F in h){let A;for(A in r)h[F]=h[F].replace(A,
r[A])}};b=u.queryToObject(d);k(b);c={};null!=e&&(c=u.queryToObject(e),k(c));a=K.parseUrl(a.href);a.query={...a.query,...b,...c};return`${a.path}?${u.objectToQuery(b)}`}return a.href};f._fetchService=async function(a){const b=new D;await this._loadVisualData(this.layer.url,b,a);this._kmlVisualData=b;this._refreshCollections()};f._refreshCollections=function(){this.allVisiblePoints.removeAll();this.allVisiblePolylines.removeAll();this.allVisiblePolygons.removeAll();this.allVisibleMapImages.removeAll();
this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>
a))};f._isSublayerVisible=function(a){a=this._kmlVisualData.allSublayers.get(a);return a?.visibility?-1===a.parentFolderId?!0:this._isSublayerVisible(a.parentFolderId):!1};f._loadVisualData=function(a,b,d){return this._fetchParsedKML(a,d).then(async g=>{for(const e of g.sublayers){b.allSublayers.set(e.id,e);g=e.points?await p.getGraphics(e.points):[];const c=e.polylines?await p.getGraphics(e.polylines):[],k=e.polygons?await p.getGraphics(e.polygons):[],r=e.mapImages||[];b.allPoints.push(...g.map(h=>
({item:h,sublayerId:e.id})));b.allPolylines.push(...c.map(h=>({item:h,sublayerId:e.id})));b.allPolygons.push(...k.map(h=>({item:h,sublayerId:e.id})));b.allMapImages.push(...r.map(h=>({item:h,sublayerId:e.id})));e.networkLink&&(g=await this._getViewDependentUrl(e.networkLink,this.view.state),await this._loadVisualData(g,b,d))}})};f._fetchParsedKML=function(a,b){return p.fetchService(a,this.layer.spatialReference,this.layer.refreshInterval,b).then(d=>p.parseKML(d.data))};f._removeMapImage=function(a){const b=
this._bitmapIndex.get(a);b&&(this._mapImageContainer.removeChild(b),this._bitmapIndex.delete(a))};return t._createClass(z)}(N.LayerView2DMixin(O));m.__decorate([q.property()],l.prototype,"_pointsView",void 0);m.__decorate([q.property()],l.prototype,"_polylinesView",void 0);m.__decorate([q.property()],l.prototype,"_polygonsView",void 0);m.__decorate([q.property()],l.prototype,"updating",void 0);return l=m.__decorate([J.subclass("esri.views.2d.layers.KMLLayerView2D")],l)});
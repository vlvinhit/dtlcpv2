// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/arrayUtils ../../../core/Collection ../../../core/CollectionFlattener ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../rest/support/DirectionLine ../../../rest/support/DirectionPoint ../../../rest/support/PointBarrier ../../../rest/support/PolygonBarrier ../../../rest/support/PolylineBarrier ../../../rest/support/RouteInfo ../../../rest/support/Stop ./LayerView2D ./graphics/GraphicContainer ./graphics/GraphicsView2D ../../layers/LayerView".split(" "),
function(r,l,m,n,u,p,t,g,L,v,w,x,y,z,A,B,C,D,E,F,G){function q(e){return e instanceof w||e instanceof x||e instanceof y||e instanceof z||e instanceof A||e instanceof B||e instanceof C}function H(e){return n.isCollection(e)&&e.length&&q(e.at(0))}function I(e){return Array.isArray(e)&&0<e.length&&q(e[0])}const J=Object.freeze({remove(){},pause(){},resume(){}}),K="route-info direction-line direction-point polygon-barrier polyline-barrier point-barrier stop".split(" "),h={graphic:null,property:null,oldValue:null,
newValue:null};g=function(e){function k(){var a=e.apply(this,arguments)||this;a._graphics=new n;a._highlightIds=new Map;a._networkFeatureMap=new Map;a._networkGraphicMap=new Map;return a}r._inherits(k,e);var c=k.prototype;c.initialize=function(){this.updatingHandles.addOnCollectionChange(()=>this._routeItems,a=>this._routeItemsChanged(a),p.initial)};c.destroy=function(){this._networkFeatureMap.clear();this._networkGraphicMap.clear();this._graphics.removeAll();this._get("_routeItems")?.destroy()};
c.attach=function(){this._createGraphicsView()};c.detach=function(){this._destroyGraphicsView()};c.fetchPopupFeatures=async function(a){return this._graphicsView.hitTest(a).filter(b=>!!b.popupTemplate)};c.highlight=function(a){const b=(q(a)?[this._getNetworkFeatureUid(a)]:I(a)?a.map(d=>this._getNetworkFeatureUid(d)):H(a)?a.map(d=>this._getNetworkFeatureUid(d)).toArray():[a.uid]).filter(m.isSome);if(!b.length)return J;this._addHighlight(b);return{remove:()=>this._removeHighlight(b)}};c.hitTest=async function(a,
b){if(this.suspended)return null;b=this._graphicsView.hitTest(a).filter(m.isSome).map(f=>this._networkGraphicMap.get(f));if(!b.length)return null;const {layer:d}=this;return b.reverse().map(f=>({type:"route",layer:d,mapPoint:a,networkFeature:f}))};c.isUpdating=function(){return this._graphicsView.updating};c.moveStart=function(){};c.moveEnd=function(){};c.update=function(a){this._graphicsView.processUpdate(a)};c.viewChange=function(){this._graphicsView.viewChange()};c._addHighlight=function(a){for(const b of a)this._highlightIds.has(b)?
(a=this._highlightIds.get(b),this._highlightIds.set(b,a+1)):this._highlightIds.set(b,1);this._updateHighlight()};c._createGraphic=function(a){a=a.toGraphic();a.layer=this.layer;a.sourceLayer=this.layer;return a};c._createGraphicsView=function(){const a=this.view,b=new E(a.featuresTilingScheme);this._graphicsView=new F({container:b,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),view:a});this.container.addChild(b);this._updateHighlight()};c._destroyGraphicsView=function(){this.container.removeChild(this._graphicsView.container);
this._graphicsView.destroy()};c._getDrawOrder=function(a){a=this._networkGraphicMap.get(a);return K.indexOf(a.type)};c._getNetworkFeatureUid=function(a){return this._networkFeatureMap.has(a)?this._networkFeatureMap.get(a).uid:null};c._removeHighlight=function(a){for(const b of a)this._highlightIds.has(b)&&(a=this._highlightIds.get(b)-1,0===a?this._highlightIds.delete(b):this._highlightIds.set(b,a));this._updateHighlight()};c._routeItemsChanged=function(a){if(a.removed.length){this._graphics.removeMany(a.removed.map(b=>
{const d=this._networkFeatureMap.get(b);this._networkFeatureMap.delete(b);this._networkGraphicMap.delete(d);return d}));for(const b of a.removed)this.removeHandles(b)}if(a.added.length){this._graphics.addMany(a.added.map(b=>{const d=this._createGraphic(b);if(null==d.symbol)return null;this._networkFeatureMap.set(b,d);this._networkGraphicMap.set(d,b);return d}).filter(m.isSome));for(const b of a.added)this.addHandles([p.watch(()=>b.geometry,(d,f)=>{this._updateGraphic(b,"geometry",d,f)}),p.watch(()=>
b.symbol,(d,f)=>{this._updateGraphic(b,"symbol",d,f)})],b);this._graphics.sort((b,d)=>this._getDrawOrder(b)-this._getDrawOrder(d))}};c._updateGraphic=function(a,b,d,f){this._networkFeatureMap.has(a)?(a=this._networkFeatureMap.get(a),a[b]=d,h.graphic=a,h.property=b,h.oldValue=f,h.newValue=d,this._graphicsView.graphicUpdateHandler(h)):(b=this._createGraphic(a),this._networkFeatureMap.set(a,b),this._networkGraphicMap.set(b,a),this._graphics.add(b))};c._updateHighlight=function(){const a=Array.from(this._highlightIds.keys());
this._graphicsView.setHighlight(a)};r._createClass(k,[{key:"_routeItems",get:function(){return new u({getCollections:()=>null==this.layer||this.destroyed?[]:[null!=this.layer.routeInfo?new n([this.layer.routeInfo]):null,this.layer.directionLines,this.layer.directionPoints,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.pointBarriers,this.layer.stops]})}}]);return k}(D.LayerView2DMixin(G));l.__decorate([t.property()],g.prototype,"_graphics",void 0);l.__decorate([t.property()],g.prototype,
"_routeItems",null);return g=l.__decorate([v.subclass("esri.views.2d.layers.RouteLayerView2D")],g)});
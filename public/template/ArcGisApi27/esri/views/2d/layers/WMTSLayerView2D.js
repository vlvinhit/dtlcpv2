// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Logger ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/spatialReferenceUtils ./BitmapTileLayerView2D ./LayerView2D ./support/imageUtils ../tiling/TileInfoView ../tiling/TileKey ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(e,k,x,l,y,p,h,J,K,z,q,A,B,r,C,t,D,E,F,G){const H=[102113,102100,3857,3785,900913],I=[0,0];h=function(u){function f(){var a=u.apply(this,arguments)||this;a._tileStrategy=null;a._fetchQueue=null;a._tileRequests=new Map;a.layer=null;return a}e._inherits(f,u);var c=f.prototype;c.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume()};c.attach=function(){const a=this.tileMatrixSet?.tileInfo;a&&(this._tileInfoView=new C(a),
this._fetchQueue=new D({tileInfoView:this._tileInfoView,concurrency:16,process:(b,d)=>this.fetchTile(b,d)}),this._tileStrategy=new E({cachePolicy:"keep",resampling:!0,acquireTile:b=>this.acquireTile(b),releaseTile:b=>this.releaseTile(b),tileInfoView:this._tileInfoView}),this.addAttachHandles(y.watch(()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet],()=>this._refresh())),e._get(e._getPrototypeOf(f.prototype),"attach",this).call(this))};c.detach=function(){e._get(e._getPrototypeOf(f.prototype),
"detach",this).call(this);this._tileStrategy?.destroy();this._fetchQueue?.destroy();this._fetchQueue=this._tileStrategy=this._tileInfoView=null};c.moveStart=function(){this.requestUpdate()};c.viewChange=function(){this.requestUpdate()};c.moveEnd=function(){this.requestUpdate()};c.releaseTile=function(a){this._fetchQueue.abort(a.key.id);this._bitmapView.removeChild(a);a.once("detach",()=>a.destroy());this.requestUpdate()};c.acquireTile=function(a){a=this._bitmapView.createTile(a);const b=a.bitmap;
[b.x,b.y]=this._tileInfoView.getTileCoords(I,a.key);b.resolution=this._tileInfoView.getTileResolution(a.key);[b.width,b.height]=this._tileInfoView.tileInfo.size;this._enqueueTileFetch(a);this._bitmapView.addChild(a);this.requestUpdate();return a};c.doRefresh=async function(){!this.attached||this.updateRequested||this.suspended||this._refresh()};c.isUpdating=function(){return this._fetchQueue?.updating??!1};c.fetchTile=async function(a,b={}){var d="tilemapCache"in this.layer?this.layer.tilemapCache:
null;const {signal:g,resamplingLevel:v=0}=b;if(!d)return this._fetchImage(a,g);const m=new t(0,0,0,0);let w;try{await d.fetchAvailabilityUpsample(a.level,a.row,a.col,m,{signal:g}),w=await this._fetchImage(m,g)}catch(n){if(l.isAbortError(n))throw n;if(3>v&&(d=this._tileInfoView.getTileParentId(a.id)))return d=new t(d),b=await this.fetchTile(d,{...b,resamplingLevel:v+1}),r.resampleImage(this._tileInfoView,b,d,a);throw n;}return r.resampleImage(this._tileInfoView,w,m,a)};c.canResume=function(){const a=
e._get(e._getPrototypeOf(f.prototype),"canResume",this).call(this);return a?null!==this.tileMatrixSet:a};c.supportsSpatialReference=function(a){return this.layer.activeLayer.tileMatrixSets?.some(b=>q.equals(b.tileInfo?.spatialReference,a))??!1};c._enqueueTileFetch=async function(a){if(!this._fetchQueue.has(a.key.id)){try{const b=await this._fetchQueue.push(a.key);a.bitmap.source=b;a.bitmap.width=this._tileInfoView.tileInfo.size[0];a.bitmap.height=this._tileInfoView.tileInfo.size[1];a.once("attach",
()=>this.requestUpdate())}catch(b){l.isAbortError(b)||x.getLogger(this).error(b)}this.requestUpdate()}};c._fetchImage=async function(a,b){return this.layer.fetchImageBitmapTile(a.level,a.row,a.col,{signal:b})};c._refresh=function(){this._fetchQueue.reset();this._tileStrategy.refresh(a=>{if(a.bitmap.source){var b={id:a.key.id,fulfilled:!1,promise:this._fetchQueue.push(a.key).then(d=>{a.bitmap.source=d}).catch(d=>{l.isAbortError(d)||(a.bitmap.source=null)}).finally(()=>{a.requestRender();b.fulfilled=
!0})};this._tileRequests.set(a,b)}})};c._getTileMatrixSetBySpatialReference=function(a){const b=this.view.spatialReference;if(!a.tileMatrixSets)return null;let d=a.tileMatrixSets.find(g=>q.equals(g.tileInfo?.spatialReference,b));!d&&b.isWebMercator&&(d=a.tileMatrixSets.find(g=>H.includes(g.tileInfo?.spatialReference.wkid??-1)));return d};e._createClass(f,[{key:"tileMatrixSet",get:function(){const a=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);if(!a)return null;a.id!==this.layer.activeLayer.tileMatrixSetId&&
(this.layer.activeLayer.tileMatrixSetId=a.id);return a}}]);return f}(G(A.BitmapTileLayerView2D(B.LayerView2DMixin(F))));k.__decorate([p.property()],h.prototype,"_fetchQueue",void 0);k.__decorate([p.property({readOnly:!0})],h.prototype,"tileMatrixSet",null);return h=k.__decorate([z.subclass("esri.views.2d.layers.WMTSLayerView2D")],h)});
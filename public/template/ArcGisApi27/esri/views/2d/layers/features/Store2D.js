// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/accessorSupport/diffUtils ../../../../support/arcadeOnDemand ../../arcade/callExpressionWithCursor".split(" "),function(m,k,n,p,l,q,r){let t=function(){function h(b,a){this._canCacheExpressionValue=!1;this._sourceInfo=b;this._storage=a;this._bitsets={computed:a.getBitset(a.createBitset())}}var f=h.prototype;f.invalidate=function(){this._bitsets.computed.clear()};f.updateSchema=async function(b,
a){var c=l.diff(this._schema,a);if((this._schema=a)&&null!=c&&l.hasDiff(c,"attributes")){p("esri-2d-update-debug")&&console.debug("Applying Update - Store:",c);this._bitsets.computed.clear();b.targets[a.name]=!0;b=a.attributes;a=[];c=[];for(const e in b){const d=b[e];switch(d.type){case "expression":a.push(this._createArcadeComputedField(d));break;case "label-expression":a.push(this._createLabelArcadeComputedField(d));break;case "statistic":c.push(d)}}this._computedFields=await Promise.all(a);this._canCacheExpressionValue=
!this._computedFields.some(e=>"expression"===e.type&&null!=e.expression&&e.expression.referencesScale());this._statisticFields=c}};f.setComputedAttributes=function(b,a,c,e){var d=this._bitsets.computed;if(!this._canCacheExpressionValue||!d.has(c)){d.set(c);for(const g of this._computedFields)switch(d=this._evaluateField(a,g,e),g.resultType){case "numeric":b.setComputedNumericAtIndex(c,g.fieldIndex,d);break;case "string":b.setComputedStringAtIndex(c,g.fieldIndex,d)}}};f._createArcadeComputedField=
async function(b){return{...b,expression:await q.createRendererExpression(b.valueExpression,this._sourceInfo.spatialReference,this._sourceInfo.fieldsIndex)}};f._createLabelArcadeComputedField=async function(b){var a=this._sourceInfo.spatialReference;const c=this._sourceInfo.fieldsIndex,{createLabelFunction:e}=await new Promise((d,g)=>m(["../../../../layers/support/labelFormatUtils"],d,g));a=await e(b.label,c,a);return{...b,builder:a}};f._evaluateField=function(b,a,c){switch(a.type){case "label-expression":return b=
b.readArcadeFeature(),a.builder.evaluate(b)||"";case "expression":return{expression:a}=a,r(a,b,{$view:{scale:c}})}};n._createClass(h,[{key:"storage",get:function(){return this._storage}}]);return h}();k.Store2D=t;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
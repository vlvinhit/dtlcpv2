// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/BidiText ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/diffUtils ../../../../../geometry/SpatialReference ../../../engine/webgl/DisplayId ../../../engine/webgl/enums ../../../engine/webgl/mesh/MeshData ../../../engine/webgl/mesh/factories/WGLMeshFactory ../../../engine/webgl/mesh/templates/WGLTemplateStore ../../../engine/webgl/util/Matcher ../textUtils ./BaseProcessor ../support/ResourceManagerProxy".split(" "),
function(B,G,H,y,T,U,u,t,V,W,I,z,J,K,L,M,N,O,C,P,Q,R){function D(m,q){return(!m.minScale||m.minScale>=q)&&(!m.maxScale||m.maxScale<=q)}function E(m){m=m.message;const q={message:{data:{},tileKey:m.tileKey,tileKeyOrigin:m.tileKeyOrigin,version:m.version},transferList:[]};for(const a in m.data){const c=a;var e=m.data[c];q.message.data[c]=null;if(null!=e){var b=e.stride;const d=e.indices.slice(0),h=e.vertices.slice(0),g=e.records.slice(0);e=u.applySome(e.metrics,f=>f.slice(0));b={stride:b,indices:d,
vertices:h,records:g,metrics:e};q.transferList.push(d,h,g);q.message.data[c]=b}}return q}y=function(m){function q(){var b=m.apply(this,arguments)||this;b.type="symbol";b._matchers={feature:null,aggregate:null};b._bufferData=new Map;b._bufferIds=new Map;return b}B._inherits(q,m);var e=q.prototype;e.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]);this._resourceManagerProxy=new R(this.remoteClient)};e.destroy=function(){this._resourceManagerProxy.destroy()};
e.forEachBufferId=function(b){this._bufferIds.forEach(a=>{a.forEach(b)})};e.update=async function(b,a){a=a.schema.processors[0];if("symbol"===a.type){var c=z.diff(this._schema,a);if(z.hasDiff(c,"mesh")||z.hasDiff(c,"target"))b.mesh=!0,b.why?.mesh.push("Symbology changed"),this._schema=a,this._factory=this._createFactory(a),this._factory.update(a,this.tileStore.tileScheme.tileInfo)}};e.onTileMessage=function(b,a,c,d){t.throwIfAborted(d);return this._onTileData(b,a,c,d)};e.onTileClear=function(b,a){a=
{clear:!0,end:a};this._bufferData.delete(b.key.id);this._bufferIds.delete(b.key.id);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:a})};e.onTileError=function(b,a,c){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a},{signal:c.signal})};e.onTileUpdate=function(b){for(const a of b.removed)this._bufferData.has(a.key.id)&&this._bufferData.delete(a.key.id),this._bufferIds.has(a.key.id)&&this._bufferIds.delete(a.key.id);for(const a of b.added)this._bufferData.forEach(c=>
{for(const d of c)d.message.tileKey===a.id&&this._updateTileMesh("append",a,E(d),[],!1,!1,null)})};e._addBufferData=function(b,a){this._bufferData.has(b)||this._bufferData.set(b,[]);this._bufferData.get(b)?.push(E(a))};e._createFactory=function(b){const {geometryType:a,objectIdField:c,fields:d}=this.service,h=J.fromJSON(this.spatialReference),g={geometryType:a,fields:d,spatialReference:h},f=new O.WGLTemplateStore((k,p)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",k,p),this.tileStore.tileScheme.tileInfo),
{matcher:n,aggregateMatcher:l}=b.mesh;this._store=f;this._matchers.feature=C.createMatcher(n,f,g,this._resourceManagerProxy);this._matchers.aggregate=u.applySome(l,k=>C.createMatcher(k,f,g,this._resourceManagerProxy));return new N.WGLMeshFactory(a,c,f)};e._onTileData=async function(b,a,c,d){t.throwIfAborted(d);const {type:h,addOrUpdate:g,remove:f,clear:n,end:l}=a;var k=!!this._schema.mesh.sortKey;if(!g)return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:{type:h,addOrUpdate:null,
remove:f,clear:n,end:l,sort:k}},d);c=this._processFeatures(b,g,c,d,a.status?.version);try{var p=await c;if(null==p)return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:{type:h,addOrUpdate:null,remove:f,clear:n,end:l,sort:k}},d);k=[];for(const r of p){p=!1;const v=r.message.bufferIds,A=b.key.id,x=r.message.tileKey;if(A!==x&&null!=v){if(!this.tileStore.get(x)){this._addBufferData(A,r);k.push(r);continue}let w=this._bufferIds.get(x);w||(w=new Set,this._bufferIds.set(x,w));const S=
Array.from(v);for(const F of S)if(w.has(F)){p=!0;break}else w.add(F)}p||(this._addBufferData(A,r),k.push(r))}await Promise.all(k.map(r=>{const v=b.key.id===r.message.tileKey;return this._updateTileMesh(h,b,r,v?a.remove:[],v&&a.end,!!a.clear,d.signal)}))}catch(r){this._handleError(b,r,d)}};e._updateTileMesh=async function(b,a,c,d,h,g,f){const n=c.message.tileKey,l=!!this._schema.mesh.sortKey;n!==a.key.id&&(h=!1);a=u.applySome(c,k=>k.message);c=u.applySome(c,k=>k.transferList)||[];b={type:b,addOrUpdate:a,
remove:d,clear:g,end:h,sort:l};f={transferList:c||[],signal:f};t.throwIfAborted(f);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:n,data:b},f)};e._processFeatures=async function(b,a,c,d,h){if(null==a||!a.hasFeatures)return null;const g={transform:b.transform,hasZ:!1,hasM:!1},f=this._factory,n={viewingMode:"",scale:b.scale},l=await this._matchers.feature,k=await this._matchers.aggregate;t.throwIfAborted(d);const p=this._getLabelInfos(b,a);await f.analyze(a.getCursor(),this._resourceManagerProxy,
l,k,g,n);t.throwIfAborted(d);return this._writeFeatureSet(b,a,g,p,f,c,h)};e._writeFeatureSet=function(b,a,c,d,h,g,f){const n=a.getSize(),l=this._schema.mesh.matcher.symbologyType;g=new M.MeshData(b.key.id,{features:n,records:n,metrics:0},l,g,l!==L.WGLSymbologyType.HEATMAP,f);f={viewingMode:"",scale:b.scale};for(a=a.getCursor();a.next();)try{const k=a.getDisplayId(),p=null!=d?d.get(k):null;h.writeCursor(g,a,c,f,b.level,p,this._resourceManagerProxy)}catch(k){}return g.serialize(b.tileInfoView.tileInfo.isWrappable)};
e._handleError=function(b,a,c){return t.isAbortError(a)?Promise.resolve():this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a.message},{signal:c.signal})};e._getLabelingSchemaForScale=function(b){var a=this._schema.mesh.labels;if(null==a)return null;if("subtype"===a.type){const c={type:"subtype",classes:{}};let d=!1;for(const h in a.classes){const g=a.classes[h].filter(f=>D(f,b.scale));d=d||!!g.length;c.classes[h]=g}return d?c:null}a=a.classes.filter(c=>D(c,b.scale));return a.length?
{type:"simple",classes:a}:null};e._getLabels=function(b,a){if("subtype"===a.type){const c=u.unwrapOrThrow(this.service.subtypeField,"Expected to find subtype Field");b=b.readAttribute(c);return null==b?[]:a.classes[b]??[]}return a.classes};e._getLabelInfos=function(b,a){b=this._getLabelingSchemaForScale(b);if(null==b)return null;const c=new Map;for(a=a.getCursor();a.next();){const h=a.getDisplayId(),g=[],f=K.isAggregateId(h),n=f&&1!==a.readAttribute("cluster_count")?"aggregate":"feature";var d=this._getLabels(a,
b);for(const l of d){if(l.target!==n)continue;d=a.getStorage();d=f&&"feature"===n?d.getComputedStringAtIndex(a.readAttribute("referenceId"),l.fieldIndex):d.getComputedStringAtIndex(h,l.fieldIndex);if(!d)continue;d=H.bidiText(d.toString());const k=d[1];this._store.getMosaicItem(l.symbol,P.codepoints(d[0])).then(p=>{g[l.index]={glyphs:p.glyphMosaicItems??[],rtl:k,index:l.index}})}c.set(h,g)}return c};B._createClass(q,[{key:"supportsTileUpdates",get:function(){return!0}}]);return q}(Q);return y=G.__decorate([I.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],
y)});
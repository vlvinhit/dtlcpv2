// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../request ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/promiseUtils ../controllers/support/sourceAdapters ./DataTileSource ../../../../support/QueueProcessor".split(" "),function(p,g,u,v,k,w,l,x,n,q){n=function(r){function h(a){var b=r.call(this,a)||this;b.type="feature";b.mode="on-demand";b._adapter=x.createSourceAdapter(a.serviceInfo);b._queue=new q.QueueProcessor({concurrency:8,
process:async c=>{l.throwIfAborted(c);if(null!=c.tile){var d=c.tile.key.id,{signal:f}=c;d=k("esri-tiles-debug")?{tile:d.replaceAll("/","."),depth:c.depth}:void 0;f=await b._adapter.executeQuery(c.query,{signal:f,query:{...d,...b._schema?.customParameters}});f.level=c.tile.key.level;return f}return b._adapter.executeQuery(c.query,{...c,query:b._schema?.customParameters})}});b._patchQueue=new q.QueueProcessor({concurrency:8,process:async c=>{l.throwIfAborted(c);if(null!=c.tile){var d=c.tile.key.id,
{signal:f}=c;d=k("esri-tiles-debug")?{tile:d.replaceAll("/","."),depth:c.depth}:void 0;f=await b._adapter.executeQuery(c.query,{signal:f,query:{...d,...b._schema?.customParameters}});f.level=c.tile.key.level;return f}return b._adapter.executeQuery(c.query,{...c,query:b._schema?.customParameters})}});return b}g._inherits(h,r);var e=h.prototype;e.destroy=function(){g._get(g._getPrototypeOf(h.prototype),"destroy",this).call(this);this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};
e.enqueueQuery=function(a,b){return this.updatingHandles.addPromise(this._queue.push(a,b))};e.enqueuePatchQuery=function(a,b){return this.updatingHandles.addPromise(this._patchQueue.push(a,b))};e.enableEvent=function(a,b){};e.subscribe=function(a,b){g._get(g._getPrototypeOf(h.prototype),"subscribe",this).call(this,a,b);this._fetchDataTile(a).catch(c=>{l.isAbortError(c)||w.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new v("mapview-query-error","Encountered error when fetching tile",
{tile:a,error:c}))})};e.unsubscribe=function(a){g._get(g._getPrototypeOf(h.prototype),"unsubscribe",this).call(this,a)};e.readers=function(a){return this._subscriptions.get(a).readers()};e.query=async function(a,b={}){return this._adapter.executeQuery(a,{...b,query:{...(b.query??{}),...this._schema?.customParameters}})};e.queryLastEditDate=async function(){const a=this._serviceInfo.source;return(await u(a.path,{query:{...a.query,f:"json"},responseType:"json"})).data.editingInfo.lastEditDate};e.createTileQuery=
function(a,b={}){const c=this._serviceInfo.geometryType,d=this.createQuery(b);d.quantizationParameters=b.quantizationParameters??a.getQuantizationParameters();d.resultType="tile";d.geometry=a.extent;if(this._serviceInfo.capabilities.query.supportsQuantization)"esriGeometryPolyline"===c&&(d.maxAllowableOffset=a.resolution*k("feature-polyline-generalization-factor"));else if("esriGeometryPolyline"===c||"esriGeometryPolygon"===c)d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===c&&(d.maxAllowableOffset*=
k("feature-polyline-generalization-factor"));a=this._serviceInfo.capabilities.query;d.defaultSpatialReferenceEnabled=a.supportsDefaultSpatialReference;d.compactGeometryEnabled=a.supportsCompactGeometry;return d};e._executePatchQuery=async function(a,b,c,d){b=b.clone();b.outFields=[this._serviceInfo.objectIdField,...c];b.returnCentroid=!1;b.returnGeometry=!1;return await this.enqueuePatchQuery({tile:a,query:b,signal:d.signal,depth:null!=b.start?b.start/8E3:0})};e._resend=async function(a,b){const {query:c,
message:d}=a,f=null!=c.outFields?c.outFields:[];a=this._queryInfo.outFields;const t=a.filter(m=>!f.includes(m));if(null==d.addOrUpdate)this._onMessage({...d,type:"append"});else if(t.length)try{const m=this._subscriptions.get(d.id).tile,y=await this._executePatchQuery(m,c,t,b);l.throwIfAborted(b);c.outFields=a;d.addOrUpdate.joinAttributes(y);this._onMessage({...d,end:d.end,type:"append"})}catch(m){}else this._onMessage({...d,type:"append"})};e._resendSubscription=async function(a){k("esri-2d-update-debug")&&
console.debug(a.tile.id,"Resend Subscription");if(a.empty)return this._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const b=a.signal;for(const c of a.requests.done)await this._resend(c,{signal:b});if(null!=a.edits)return this._onMessage(a.edits)};e.resend=async function(){const a=Array.from(this._subscriptions.values());await Promise.all(a.map(b=>this._resendSubscription(b)))};g._createClass(h,[{key:"maxRecordCountFactor",get:function(){const {query:a}=this._serviceInfo.capabilities;
return a.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){const {query:a}=this._serviceInfo.capabilities;return(a.maxRecordCount??8E3)*(this.maxRecordCountFactor??1)}},{key:"pageSize",get:function(){return Math.min(8E3,this.maxPageSize)}}]);return h}(n.DataTileSource);p.BaseFeatureSource=n;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
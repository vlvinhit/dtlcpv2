// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/arrayUtils ../../../../../core/CircularArray ../../../../../core/has ../../../../../core/promiseUtils ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),function(h,m,n,p,k,q,r,e){let v=function(){function f(a,b){this.requests={done:[],stream:new p(10)};this._edits=null;this._abortController=new AbortController;this._version=0;this._resolver=q.createResolver();this.didSend=this._isDone=!1;this.tile=
a;this._version=b}var c=f.prototype;c.resolve=function(){this._isDone=!0;this._resolver.resolve()};c.clear=function(){this.requests.done=[]};c.applyUpdate=function(a){this.requests.done.forEach(b=>b.message.status.unset(a));this._version=a.version;null!=this._edits&&this._edits.status.unset(a)};c.add=function(a){a.message.status=a.message.status??e.UpdateToken.empty();a.message.status.version=this._version;k("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version);
a.message.end&&(this.requests.done.forEach(b=>{null!=b.message&&b.message.end&&(b.message.end=!1)}),this._resolver.resolve(),this._isDone=!0);this.requests.done.push(a)};c.edit=function(a,b){const d=a.getQuantizationTransform(),t=a.fullSchema(),l=Array.from(a.features()).filter(n.isSome),u=l.map(g=>g.objectId);b=[...b,...u];this.removeIds(b);this._invalidate();null==this._edits?this._edits={type:"append",addOrUpdate:r.FeatureSetReaderJSON.fromOptimizedFeatures(l,t,d),id:this.tile.id,status:e.UpdateToken.empty(),
end:!0}:(this.requests.done.forEach(g=>g.message.end=!1),this._edits.addOrUpdate.append(a.features()))};c.readers=function*(){for(const {message:a}of this.requests.done)null!=a.addOrUpdate&&(yield a.addOrUpdate);null!=this._edits&&null!=this._edits.addOrUpdate&&(yield this._edits.addOrUpdate)};c._invalidate=function(){for(const a of this.requests.done)a.message.status=e.UpdateToken.empty();null!=this._edits&&(this._edits.status=e.UpdateToken.empty())};c.removeIds=function(a){this._invalidate();for(const {message:b}of this.requests.done){const d=
b.addOrUpdate;null!=d&&(d.removeIds(a),d.isEmpty&&(k("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),b.addOrUpdate=null))}null!=this._edits&&null!=this._edits.addOrUpdate&&this._edits.addOrUpdate.removeIds(a);this.requests.done=this.requests.done.filter(b=>b.message.addOrUpdate||b.message.end)};c.abort=function(){this._abortController.abort();this._resolver.reject()};m._createClass(f,[{key:"signal",get:function(){return this._abortController.signal}},{key:"options",get:function(){return{signal:this._abortController.signal}}},
{key:"empty",get:function(){return!this.requests.done.length&&null==this.edits}},{key:"edits",get:function(){return this._edits}},{key:"done",get:function(){return this._resolver.promise}},{key:"isDone",get:function(){return this._isDone}}]);return f}();h.DataTileSubscription=v;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/handleUtils ../../../../../core/has ../../../../../chunks/rbush ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ./DataTileSource ./StreamConnectionState ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),function(r,k,w,t,
x,n,u,y,z,A,B,C,D){function E(e,d){const c=e.weakClone();if(null!=e.geometry){const a=n.quantizeX(d,e.geometry.coords[0]);e=n.quantizeY(d,e.geometry.coords[1]);c.geometry=new u([],[a,e])}return c}function F(e){switch(e){case "esriGeometryPoint":return E;default:return(d,c)=>{const a=d.weakClone(),b=new u;d=n.quantizeOptimizedGeometry(b,d.geometry,!1,!1,e,c,!1,!1);a.geometry=d;return a}}}function G(e){switch(e){case "esriGeometryPoint":return d=>null!=d.geometry?{minX:d.geometry.coords[0],minY:d.geometry.coords[1],
maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]}:{minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};default:return d=>{let c=Infinity,a=Infinity,b=-Infinity,f=-Infinity;null!=d.geometry&&d.geometry.forEachVertex((g,h)=>{c=Math.min(c,g);a=Math.min(a,h);b=Math.max(b,g);f=Math.max(f,h)});return{minX:c,minY:a,maxX:b,maxY:f}}}}let H=function(){function e(c,a){this.onUpdate=c;this._geometryType=a;this._objectIdToFeature=new Map;this._index=null}var d=e.prototype;d.add=function(c){this._objectIdToFeature.set(c.objectId,
c);this._index=null};d.get=function(c){return this._objectIdToFeature.has(c)?this._objectIdToFeature.get(c):null};d.forEach=function(c){this._objectIdToFeature.forEach(c)};d.search=function(c){if(!this._index){var a=this._features;const b=x.rbush(9,G(this._geometryType));b.load(a);this._index=b}return this._index.search({minX:c.bounds[0],minY:c.bounds[1],maxX:c.bounds[2],maxY:c.bounds[3]})};d.clear=function(){this._index=null;this._objectIdToFeature.clear()};d.removeById=function(c){const a=this._objectIdToFeature.get(c);
return a?(this._objectIdToFeature.delete(c),this._index=null,a):null};d.update=function(c,a){this.onUpdate(c,a)};k._createClass(e,[{key:"_features",get:function(){const c=[];this._objectIdToFeature.forEach(a=>c.push(a));return c}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return e}();t=function(e){function d(a){var b=e.call(this,a)||this;b.type="stream";b._updateIntervalId=0;b._level=0;b._isPaused=!1;b._updateInfo={websocket:0,client:0};b._inUpdate=!1;var {outSR:f}=a;const {geometryType:g,
objectIdField:h,timeInfo:q,purgeOptions:I,source:J,spatialReference:K,serviceFilter:L,maxReconnectionAttempts:M,maxReconnectionInterval:N,updateInterval:O,customParameters:P,enabledEventTypes:Q}=a.serviceInfo,v=new H(b._onUpdate.bind(k._assertThisInitialized(b)),g),R=new y.StreamFeatureManager(v,h,q,I);f=z.createConnection(J,K,f,g,L,M,N,P??{});b._connectionState=new B.StreamConnectionState({connection:f});b._store=v;b._manager=R;b._connection=f;b._quantize=F(g);b._enabledEventTypes=new Set(Q);b._handlesGroup=
w.handlesGroup([b._connection.on("data-received",l=>b._onFeature(l)),b._connection.on("message-received",l=>b._onWebSocketMessage(l))]);b._initUpdateInterval=()=>{let l=performance.now();b._updateIntervalId=setInterval(()=>{var p=performance.now(),m=p-l;2500<m&&(l=p,p=Math.round(b._updateInfo.client/(m/1E3)),m=Math.round(b._updateInfo.websocket/(m/1E3)),b._updateInfo.client=0,b._updateInfo.websocket=0,b.events.emit("updateRate",{client:p,websocket:m}));a.canAcceptRequest()&&!b._inUpdate&&b._manager.checkForUpdates()},
O)};b._isPaused=a.serviceInfo.isPaused;b._isPaused||b._initUpdateInterval();return b}k._inherits(d,e);var c=d.prototype;c.destroy=function(){k._get(k._getPrototypeOf(d.prototype),"destroy",this).call(this);this._clearUpdateInterval();this._connection.destroy();this._handlesGroup?.remove()};c._fetchDataTile=function(){};c.updateCustomParameters=function(a){this._connection.updateCustomParameters(a)};c.pauseStream=function(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())};c.resumeStream=
function(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())};c.sendMessageToSocket=function(a){this._connection.sendMessageToSocket(a)};c.sendMessageToClient=function(a){this._isPaused&&"type"in a&&"clear"===a.type?(this._store.clear(),this._subscriptions.forEach((b,f)=>{b.didSend&&b.tile.level===this._level&&this._onMessage({type:"append",id:f,addOrUpdate:null,clear:!0,end:!0})})):this._connection.sendMessageToClient(a)};c.enableEvent=function(a,b){b?this._enabledEventTypes.add(a):
this._enabledEventTypes.delete(a)};c.subscribe=function(a,b){k._get(k._getPrototypeOf(d.prototype),"subscribe",this).call(this,a,b);b=this._subscriptions.get(a.id);b.resolve();this._level=a.level;const f=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:f,end:!0});b.didSend=!0};c.unsubscribe=function(a){k._get(k._getPrototypeOf(d.prototype),"unsubscribe",this).call(this,a)};c.readers=function*(a){a=this._subscriptions.get(a);({tile:a}=a);yield this._getTileFeatures(a)};
c.createTileQuery=function(a){throw Error("Service does not support tile  queries");};c.resend=async function(){this._subscriptions.forEach(a=>{({tile:a}=a);a={type:"append",id:a.id,addOrUpdate:this._getTileFeatures(a),end:!0};this._onMessage(a)})};c._getTileFeatures=function(a){const b=this._store.search(a).map(f=>this._quantize(f,a.transform));return C.FeatureSetReaderJSON.fromOptimizedFeatures(b,this._serviceInfo,a.transform)};c._onWebSocketMessage=function(a){this._enabledEventTypes.has("message-received")&&
this.events.emit("message-received",a);if("type"in a)switch(a.type){case "delete":if(a.objectIds)for(const b of a.objectIds)this._manager.removeById(b);if(a.trackIds)for(const b of a.trackIds)this._manager.removeByTrackId(b);break;case "clear":this._store.forEach(b=>this._manager.removeById(b.objectId))}};c._onFeature=function(a){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",a);const b=n.convertFromFeature(a,this._serviceInfo.geometryType,
!1,!1,this._serviceInfo.objectIdField);this._manager.add(b)}catch(b){}};c._clearUpdateInterval=function(){clearInterval(this._updateIntervalId);this._updateIntervalId=0};c._onUpdate=async function(a,b){this._inUpdate=!0;try{null!=a&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((g,h)=>{g.didSend&&g.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,clear:!0,end:!1})});const f=[];this._subscriptions.forEach((g,h)=>{if(g.didSend&&g.tile.level===this._level){var q=
this._getTileFeatures(g.tile);h={type:"append",id:h,addOrUpdate:q,remove:[],end:!1,status:D.UpdateToken.empty()};g.requests.stream.enqueue(h);f.push(this._onMessage(h))}});await Promise.all(f);this._subscriptions.forEach((g,h)=>{g.didSend&&g.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,end:!0})})}catch{}this._inUpdate=!1};k._createClass(d,[{key:"connectionStatus",get:function(){return this._connectionState.connectionStatus}},{key:"errorString",get:function(){return this._connectionState.errorString}}]);
return d}(A.DataTileSource);r.StreamSource=t;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
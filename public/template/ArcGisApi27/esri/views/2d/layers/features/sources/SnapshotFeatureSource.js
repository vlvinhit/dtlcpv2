// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ./BaseFeatureSource ../support/FeatureSetReaderPBFIndirect ../support/UpdateToken".split(" "),function(u,p,z,G,A,y,w,B,C,D,E,v){function F(m,h,k){var a=m.getXHydrated();m=m.getYHydrated();a=h.getColumnForX(a);
a=Math.floor(h.normalizeCol(a));h=Math.floor(h.getRowForY(m));return`${k}/${h}/${a}`}function x(m,h){if(null==m)return null;h=h.transform;const k=m.getQuantizationTransform();if(null==k){const [n,q]=h.scale,[r,t]=h.translate;return m.transform(-r/n,t/q,1/n,1/-q)}const [a,b]=k.scale,[c,d]=k.translate,[e,f]=h.scale,[l,g]=h.translate;return m.transform((c-l)/e,(-d+g)/f,a/e,b/f)}u.SnapshotFeatureSource=function(m){function h(a){var b=m.call(this,a)||this;b.mode="snapshot";b._loading=!0;b._controller=
new AbortController;b._downloadPromise=null;b._didSendEnd=!1;b._queries=[];b._invalidated=!1;b._hasAggregates=!1;b._random=new B(1E3);b._store=a.store;b._markedIdsBufId=b._store.storage.createBitset();return b}p._inherits(h,m);var k=h.prototype;k.destroy=function(){p._get(p._getPrototypeOf(h.prototype),"destroy",this).call(this);this._controller.abort()};k.update=function(a,b){p._get(p._getPrototypeOf(h.prototype),"update",this).call(this,a,b);null==this._featureCount&&(this._featureCount=b.initialFeatureCount);
null!=b.changedFeatureCount&&(this._featureCount=b.changedFeatureCount);this._hasAggregates=!!a.targets?.aggregate};k.resend=async function(a=!1){await this._downloadPromise;this._invalidated||a?(a=y.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach(b=>b.clear()),this._downloadPromise=this._download(a),await this._downloadPromise):(a=this._queries.map(({query:b,reader:c})=>this._sendPatchQuery(b,c)),await Promise.all(a),this._subscriptions.forEach(b=>
{b.requests.done.forEach(c=>this._onMessage(c.message))}))};k.refresh=async function(a,b){b&&(this._featureCount=b.featureCount);await this.resend(!0)};k._sendPatchQuery=async function(a,b){const c=null!=a.outFields?a.outFields:[],d=this._queryInfo.outFields,e=d.filter(g=>!c.includes(g));if(e.length){var f=a.clone(),l=this._signal;f.returnGeometry=!1;f.returnCentroid=!1;f.outFields=e;a.outFields=d;a=await this.enqueueQuery({query:f,depth:0,signal:l});w.throwIfAborted({signal:l});b.joinAttributes(a)}};
k._fetchDataTile=async function(a){if(!this._downloadPromise){var b=y.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined");this._downloadPromise=this._download(b)}var c=this._store.search(a);b=this._subscriptions.get(a.key.id);const d=c.length-1;for(let f=0;f<d;f++){var e=x(c[f],a);e={type:"append",id:a.id,addOrUpdate:e,end:!1,status:v.UpdateToken.empty()};b.add({query:null,message:e});this._hasAggregates||await w.after(1);this._onMessage(e)}c=x(0<=d?c[d]:null,a);a={type:"append",
id:a.id,addOrUpdate:c,end:this._didSendEnd,status:v.UpdateToken.empty()};b.add({query:null,message:a});this._onMessage(a)};k._download=async function(a){try{await this.whenInitialized();const b=this._store.storage.getBitset(this._markedIdsBufId),c=new Set;b.clear();const d=Array.from({length:Math.ceil(a/this.pageSize)},(e,f)=>f).sort((e,f)=>this._random.getInt()-this._random.getInt()).map(e=>this._downloadPage(e,b,c));await Promise.all(d);this._store.sweepFeatures(b,this._store.storage);this._store.sweepFeatureSets(c)}catch(b){A.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source",
"Encountered and error when downloading feature snapshot",b)}this._sendEnd();this._loading=!1};k._downloadPage=async function(a,b,c){var d=this.pageSize;d={start:a*d,num:d,cacheHint:!0};null!=this.maxRecordCountFactor&&(d.maxRecordCountFactor=this.maxRecordCountFactor);d=this.createQuery(d);const e=this._signal;a=await this.enqueueQuery({query:d,depth:a,signal:e});w.throwIfAborted({signal:e});this._queries.push({query:d,reader:a});this._store.insert(a);c.add(a.instance);for(c=a.getCursor();c.next();)b.set(c.getDisplayId());
this._send(a)};k._send=function(a){if(this._subscriptions.size){var b=null,c=new Map,d=new Set,e=new Map;this._subscriptions.forEach(l=>{var g=l.tile;c.set(g.key.id,null);b=g.tileInfoView;d.add(g.level);const {row:n,col:q}=g.key;g=`${g.level}/${n}/${q}`;const r=e.get(g)??[];r.push(l);e.set(g,r)});for(const l of d){const g=b.getLODInfoAt(l),n=a.getCursor();for(;n.next();){var f=F(n,g,l);const q=n.getIndex();if(e.has(f))for(const r of e.get(f)){f=r.tile.id;let t=c.get(f);null==t&&(t=[],c.set(f,t));
t.push(q)}}}c.forEach((l,g)=>{if(null!=l){const n=this._subscriptions.get(g);l=x(E.FeatureSetReaderIndirect.from(a,l),n.tile);g={type:"append",id:g,addOrUpdate:l,end:!1,status:v.UpdateToken.empty()};n.add({query:null,message:g});this._onMessage(g)}})}};k._sendEnd=function(){this._subscriptions.forEach(a=>{const b={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:v.UpdateToken.empty()};a.add({query:null,message:b});this._onMessage(b)});this._didSendEnd=!0};p._createClass(h,[{key:"loading",
get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]);return h}(D.BaseFeatureSource);u.SnapshotFeatureSource=z.__decorate([C.subclass("esri.view.2d.layers.features.sources.SnapshotFeatureSource")],u.SnapshotFeatureSource);Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
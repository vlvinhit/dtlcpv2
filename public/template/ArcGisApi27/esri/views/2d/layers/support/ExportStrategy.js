// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(C,k,h,L,n,l,M,N,F,A,G,H,D,I,J,K){const q=A.create(),p=[0,0],w=new K(0,0,0,0);h=function(E){function x(g){var a=E.call(this,g)||this;a._imagePromise=null;a.bitmaps=[];a.hidpi=!1;a.imageMaxWidth=2048;a.imageMaxHeight=2048;a.imageRotationSupported=!1;a.imageNormalizationSupported=!1;a.update=n.debounce(async(d,e)=>{n.throwIfAborted(e);if(d.stationary&&!a.destroyed){var b=d.state,f=G.getInfo(b.spatialReference);d=a.hidpi?d.pixelRatio:1;var c=a.imageNormalizationSupported&&b.worldScreenWidth&&
b.worldScreenWidth<b.size[0],t=a.imageMaxWidth??0,u=a.imageMaxHeight??0;c?(p[0]=b.worldScreenWidth,p[1]=b.size[1]):a.imageRotationSupported?(p[0]=b.size[0],p[1]=b.size[1]):D.getOuterSize(p,b);f=f&&(b.extent.xmin<f.valid[0]||b.extent.xmax>f.valid[1]);var v=!a.imageNormalizationSupported&&f,y=!(Math.floor(p[0]*d)>t||Math.floor(p[1]*d)>u)&&!v,B=a.imageRotationSupported?b.rotation:0;f=a.container.children.slice();y?(c=c?b.paddedViewState.center:b.center,a._imagePromise&&console.error("Image promise was not defined!"),
a._imagePromise=a._singleExport(b,p,c,b.resolution,B,d,e)):(c=Math.min(t,u),v&&(c=Math.min(b.worldScreenWidth,c)),a._imagePromise=a._tiledExport(b,c,d,e));try{const m=await a._imagePromise??[];n.throwIfAborted(e);e=[];a._imagePromise=null;if(!a.destroyed){a.bitmaps=m;for(const r of f)m.includes(r)||e.push(r.fadeOut().then(()=>{r.remove();r.destroy()}));for(const r of m)e.push(r.fadeIn());await Promise.all(e)}}catch(m){a._imagePromise=null,n.throwIfAbortError(m)}}},5E3);a.updateExports=n.debounce(async d=>
{const e=[];for(const b of a.container.children){if(!b.visible||!b.stage)return;e.push(d(b).then(()=>{b.invalidateTexture();b.requestRender()}))}a._imagePromise=n.eachAlways(e).then(()=>a._imagePromise=null);await a._imagePromise});return a}C._inherits(x,E);var z=x.prototype;z.destroy=function(){this.bitmaps.forEach(g=>g.destroy());this.bitmaps=[]};z._export=async function(g,a,d,e,b,f){d=await this.fetchSource(g,Math.floor(a*b),Math.floor(d*b),{rotation:e,pixelRatio:b,signal:f});n.throwIfAborted(f);
const c=new I.Bitmap(null,!0);c.x=g.xmin;c.y=g.ymax;c.resolution=g.width/a;c.rotation=e;c.pixelRatio=b;c.opacity=0;this.container.addChild(c);await c.setSourceAsync(d,f);n.throwIfAborted(f);return c};z._singleExport=async function(g,a,d,e,b,f,c){D.getBBox(q,d,e,a);g=A.toExtent(q,g.spatialReference);return[await this._export(g,a[0],a[1],b,f,c)]};z._tiledExport=function(g,a,d,e){var b=H.create({size:a,spatialReference:g.spatialReference,scales:[g.scale]});const f=new J(b);b=f.getTileCoverage(g);if(!b)return null;
const c=[];b.forEach((t,u,v,y)=>{w.set(t,u,v,0);f.getTileBounds(q,w);const B=A.toExtent(q,g.spatialReference);c.push(this._export(B,a,a,0,d,e).then(m=>{0!==y&&(w.set(t,u,v,y),f.getTileBounds(q,w),m.x=q[0],m.y=q[3]);return m}))});return Promise.all(c)};C._createClass(x,[{key:"updating",get:function(){return!this.destroyed&&null!==this._imagePromise}}]);return x}(h);k.__decorate([l.property()],h.prototype,"_imagePromise",void 0);k.__decorate([l.property()],h.prototype,"bitmaps",void 0);k.__decorate([l.property()],
h.prototype,"container",void 0);k.__decorate([l.property()],h.prototype,"fetchSource",void 0);k.__decorate([l.property()],h.prototype,"hidpi",void 0);k.__decorate([l.property()],h.prototype,"imageMaxWidth",void 0);k.__decorate([l.property()],h.prototype,"imageMaxHeight",void 0);k.__decorate([l.property()],h.prototype,"imageRotationSupported",void 0);k.__decorate([l.property()],h.prototype,"imageNormalizationSupported",void 0);k.__decorate([l.property()],h.prototype,"requestUpdate",void 0);k.__decorate([l.property()],
h.prototype,"updating",null);return h=k.__decorate([F.subclass("esri.views.2d.layers.support.ExportStrategy")],h)});
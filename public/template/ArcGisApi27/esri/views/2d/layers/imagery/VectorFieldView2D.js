// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Graphic ../../../../request ../../../../core/HandleOwner ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Extent ../../../../layers/support/rasterFunctions/rasterProjectionHelper ../../../../layers/support/rasterFunctions/vectorFieldUtils ../../engine/imagery/RasterVFContainer ./ImageryVFStrategy".split(" "),
function(p,g,v,w,c,q,k,E,F,G,x,y,z,r,A,B){c=function(t){function l(){var a=t.apply(this,arguments)||this;a.attached=!1;a.container=new A.RasterVFContainer;a.type="imageryVF";a._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""};a._fetchpixels=async(d,b,m,e)=>{const n=await a._projectFullExtentPromise,{symbolTileSize:u}=a.layer.renderer,{extent:h,width:C,height:D}=r.snapImageToSymbolTile(d,b,m,u,n);if(null!=n&&!n.intersects(d))return{extent:h,pixelBlock:null};d={bbox:`${h.xmin}, ${h.ymin}, ${h.xmax}, ${h.ymax}`,
exportParametersVersion:a.layer.exportImageServiceParameters.version,symbolTileSize:u,time:JSON.stringify(a.timeExtent||"")};if(a._canReuseVectorFieldData(d)&&(b=a.getPixelData(),null!=b&&`${b.extent.xmin}, ${b.extent.ymin}, ${b.extent.xmax}, ${b.extent.ymax}`===d.bbox))return b;({pixelData:e}=await a.layer.fetchImage(h,C,D,{timeExtent:a.timeExtent,requestAsImageElement:!1,signal:e}));a._dataParameters=d;e=e?.pixelBlock;if(null==e)return{extent:h,pixelBlock:null};e="vector-uv"===a.layer.rasterInfo.dataType?
r.convertVectorFieldData(e,"vector-uv"):e;return{extent:h,pixelBlock:e}};return a}p._inherits(l,t);var f=l.prototype;f.attach=function(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference);this._strategy=new B({container:this.container,fetchPixels:this._fetchpixels});this.handles.add(q.watch(()=>this.layer.renderer,a=>this._updateSymbolizerParams(a),q.syncAndInitial),"attach")};f.detach=function(){this._strategy.destroy();this.container.children.forEach(a=>a.destroy());
this.container.removeAllChildren();this.handles.remove("attach");this._strategy=this.container=this._projectFullExtentPromise=null};f.getPixelData=function(){const a=this.container.children[0]?.rawPixelData;if(this.updating||!a)return null;const {extent:d,pixelBlock:b}=a;return{extent:d,pixelBlock:b}};f.hitTest=function(a){return new v({attributes:{},geometry:a.clone(),layer:this.layer})};f.update=function(a){this._strategy.update(a,this._symbolizerParams)};f.redraw=function(){const {renderer:a}=
this.layer;a&&(this._updateSymbolizerParams(a),this._strategy.redraw(this._symbolizerParams))};f._canReuseVectorFieldData=function(a){const d=this._dataParameters.time===a.time,b=this._dataParameters.symbolTileSize===a.symbolTileSize,m=this._dataParameters.bbox===a.bbox;return this._dataParameters.exportParametersVersion===a.exportParametersVersion&&d&&b&&m};f._getProjectedFullExtent=async function(a){try{return await z.projectExtent(this.layer.fullExtent,a)}catch(d){try{const b=(await w(this.layer.url,
{query:{option:"footprints",outSR:a.wkid||JSON.stringify(a.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return b?y.fromJSON(b):null}catch{return null}}};f._updateSymbolizerParams=function(a){"vector-field"===a.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))};p._createClass(l,[{key:"updating",get:function(){return!this.attached||this._strategy.updating}}]);return l}(c.HandleOwner);g.__decorate([k.property()],c.prototype,
"attached",void 0);g.__decorate([k.property()],c.prototype,"container",void 0);g.__decorate([k.property()],c.prototype,"layer",void 0);g.__decorate([k.property()],c.prototype,"timeExtent",void 0);g.__decorate([k.property()],c.prototype,"type",void 0);g.__decorate([k.property()],c.prototype,"view",void 0);g.__decorate([k.property()],c.prototype,"updating",null);return c=g.__decorate([x.subclass("esri.views.2d.layers.imagery.VectorFieldView2D")],c)});
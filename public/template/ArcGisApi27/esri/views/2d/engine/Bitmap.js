// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f32 ../../../chunks/vec2f32 ./DisplayObject ./ImageryBitmapSource ../../webgl/contextUtils ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor".split(" "),function(n,h,x,p,k,y,q,r,z,A,t,B,C){function v(d){return d&&"render"in d}function w(d){const e=document.createElement("canvas");e.width=d.width;e.height=d.height;d.render(e.getContext("2d"));
return e}function D(d){return v(d)?d instanceof z?x.applySome(d.getRenderedRasterPixels(),e=>e.renderedRasterPixels):w(d):d}r=function(d){function e(b=null,c=!1){var a=d.call(this)||this;a.blendFunction="standard";a._sourceWidth=0;a._sourceHeight=0;a._textureInvalidated=!1;a._texture=null;a.stencilRef=0;a.coordScale=[1,1];a._height=void 0;a.pixelRatio=1;a.resolution=0;a.rotation=0;a._source=null;a._width=void 0;a.x=0;a.y=0;a.immutable=c;a.source=b;a.requestRender=a.requestRender.bind(h._assertThisInitialized(a));
return a}h._inherits(e,d);var f=e.prototype;f.destroy=function(){this._texture&&(this._texture.dispose(),this._texture=null);null!=this._uploadStatus&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)};f.beforeRender=function(b){h._get(h._getPrototypeOf(e.prototype),"beforeRender",this).call(this,b);this.updateTexture(b)};f.setSourceAsync=async function(b,c){null!=this._uploadStatus&&this._uploadStatus.controller.abort();const a=new AbortController,l=p.createResolver();p.onAbortOrThrow(c,
()=>a.abort());p.onAbortOrThrow(a,g=>l.reject(g));this._uploadStatus={controller:a,resolver:l};this.source=b;return l.promise};f.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width))};f.updateTransitionProperties=function(b,c){64<=b&&(this.inFadeTransition=
this.fadeTransitionEnabled=!1);h._get(h._getPrototypeOf(e.prototype),"updateTransitionProperties",this).call(this,b,c)};f.setTransform=function(b){const c=k.identity(this.transforms.dvs),[a,l]=b.toScreenNoRotation([0,0],[this.x,this.y]);var g=this.resolution/this.pixelRatio/b.resolution;const m=g*this.width;g*=this.height;const u=Math.PI*this.rotation/180;k.translate(c,c,q.fromValues(a,l));k.translate(c,c,q.fromValues(m/2,g/2));k.rotate(c,c,-u);k.translate(c,c,q.fromValues(-m/2,-g/2));k.scaleByVec2(c,
c,q.fromValues(m,g));k.multiply(this.transforms.dvs,b.displayViewMat3,c)};f.setSamplingProfile=function(b){this._texture&&(b.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(b.samplingMode))};f.bind=function(b,c){this._texture&&b.bindTexture(this._texture,c)};f.updateTexture=async function({context:b,painter:c}){if(this._textureInvalidated)if(this._textureInvalidated=!1,this._texture||(this._texture=this._createTexture(b)),this.source){this._texture.resize(this._sourceWidth,
this._sourceHeight);b=D(this.source);try{if(null!=this._uploadStatus){const {controller:a,resolver:l}=this._uploadStatus,g={signal:a.signal},{width:m,height:u}=this;await c.textureUploadManager.enqueueTextureUpdate({data:b,texture:this._texture,width:m,height:u},g);l.resolve();this._uploadStatus=null}else this._texture.setData(b);this.ready()}catch(a){p.throwIfNotAbortError(a)}}else this._texture.setData(null)};f.onDetach=function(){this.destroy()};f._createTransforms=function(){return{dvs:y.create()}};
f._createTexture=function(b){const c=this.immutable&&b.type===A.ContextType.WEBGL2,a=new C.TextureDescriptor;a.internalFormat=c?t.SizedPixelFormat.RGBA8:t.PixelFormat.RGBA;a.wrapMode=t.TextureWrapMode.CLAMP_TO_EDGE;a.isImmutable=c;a.width=this._sourceWidth;a.height=this._sourceHeight;return new B.Texture(b,a)};h._createClass(e,[{key:"isSourceScaled",get:function(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}},{key:"height",get:function(){return void 0!==this._height?this._height:
this._sourceHeight},set:function(b){this._height=b}},{key:"source",get:function(){return this._source},set:function(b){if(null!=b||null!=this._source)this._source=b,this.invalidateTexture(),this.requestRender()}},{key:"width",get:function(){return void 0!==this._width?this._width:this._sourceWidth},set:function(b){this._width=b}}]);return e}(r.DisplayObject);n.Bitmap=r;n.isImageSource=v;n.rasterize=w;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
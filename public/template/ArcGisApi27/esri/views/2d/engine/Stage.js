// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/events ../../../core/has ../../../core/maybe ../../../core/scheduling ../../../chunks/mat3f32 ../../../symbols/cim/CIMResourceManager ./Container ./webgl/BufferPool ./webgl/enums ./webgl/Painter ./webgl/Profiler ../support/Timeline ../../support/screenshotUtils ../../webgl/contextUtils ../../webgl/enums ../../webgl/FramebufferObject ../../webgl/RenderbufferDescriptor ../../webgl/RenderingContext ../../webgl/TextureDescriptor ../../webgl/capabilities/isWebGL2Context ../../../core/imageUtils".split(" "),
function(q,l,x,y,t,u,z,A,B,v,C,p,D,E,F,G,H,m,I,J,K,L,M,N){let O=function(w){function n(a,c){var b=w.call(this)||this;b._trash=new Set;b._renderRemainingTime=0;b._lastFrameRenderTime=0;b.renderRequested=!1;b.stage=l._assertThisInitialized(b);b._stationary=!0;const {canvas:d=document.createElement("canvas"),alpha:e=!0,stencil:h=!0,contextOptions:g={}}=c;b._canvas=d;const k=H.createContextForView("2d",d,{alpha:e,antialias:!1,depth:!0,stencil:h});b.context=new K.RenderingContext(k??null,g);b.resourceManager=
new B;b.painter=new D(b.context,l._assertThisInitialized(b),b.resourceManager);t("esri-2d-profiler")&&(b._debugOutput=document.createElement("div"),b._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(b._debugOutput));b._renderParameters={drawPhase:0,state:b.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:b.context,painter:b.painter,timeline:c.timeline||
new F.Timeline,renderingOptions:c.renderingOptions,requestRender:()=>b.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new E.Profiler(b.context,b._debugOutput),dataUploadCounter:0,get highlightGradient(){return b._highlightGradient}};b._taskHandle=z.addFrameTask({render:r=>b.renderFrame(r)});b._taskHandle.pause();b._lostWebGLContextHandle=y.on(d,"webglcontextlost",r=>{b.emit("webgl-error",{error:new x("webgl-context-lost",r.statusMessage)})});b._bufferPool=new C.BufferPool;d.setAttribute("style",
"width: 100%; height:100%; display:block;");a.appendChild(d);return b}l._inherits(n,w);var f=n.prototype;f.destroy=function(){this.removeAllChildren();this._emptyTrash();this._taskHandle=u.removeMaybe(this._taskHandle);this._lostWebGLContextHandle=u.removeMaybe(this._lostWebGLContextHandle);this._canvas.parentNode?.removeChild(this._canvas);this._debugOutput?.parentNode?.removeChild(this._debugOutput);this._bufferPool.destroy();this.resourceManager.destroy();this.painter.dispose();this.context.dispose();
this._canvas=null};f.trashDisplayObject=function(a){this._trash.add(a);this.requestRender()};f.untrashDisplayObject=function(a){return this._trash.delete(a)};f.requestRender=function(){this._renderRemainingTime=2E3;this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())};f.renderFrame=function(a){this._renderRemainingTime-=this._lastFrameRenderTime?a.time-this._lastFrameRenderTime:0;0>=this._renderRemainingTime&&this._taskHandle.pause();this._lastFrameRenderTime=
a.time;this.renderRequested=!1;this._renderParameters.state=this._state;this._renderParameters.stationary=this.stationary;this._renderParameters.pixelRatio=window.devicePixelRatio;this._renderParameters.globalOpacity=1;this._renderParameters.time=a.time;this._renderParameters.deltaTime=a.deltaTime;this._renderParameters.effects=null;this.processRender(this._renderParameters);this._emptyTrash();this.emit("post-render")};f._createTransforms=function(){return{dvs:A.create()}};f.renderChildren=function(a){for(const c of this.children)c.beforeRender(a);
this._renderChildren(this.children,a);for(const c of this.children)c.afterRender(a)};f._renderChildren=function(a,c){const b=this.context;this.painter.textureUploadManager.upload();b.resetInfo();c.profiler.recordStart("drawLayers");c.dataUploadCounter=0;c.drawPhase=p.WGLDrawPhase.MAP;this.painter.beforeRenderLayers(b,this.backgroundColor);for(const d of a)d.processRender(c);this.painter.prepareDisplay(c,this.backgroundColor,this.state.padding);this.painter.renderLayers(b);c.drawPhase=p.WGLDrawPhase.HIGHLIGHT;
this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b);if(this._isLabelDrawPhaseRequired(a)){c.drawPhase=p.WGLDrawPhase.LABEL;this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b)}if(t("esri-tiles-debug")){c.drawPhase=p.WGLDrawPhase.DEBUG;this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b)}c.profiler.recordEnd("drawLayers");b.logInfo()};f.doRender=function(a){const c=
this.context,{state:b,pixelRatio:d}=a;this._resizeCanvas(a);c.setViewport(0,0,d*b.size[0],d*b.size[1]);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);l._get(l._getPrototypeOf(n.prototype),"doRender",this).call(this,a)};f.takeScreenshot=async function(a){var c=Math.round(this.state.size[0]*a.resolutionScale);const b=Math.round(this.state.size[1]*a.resolutionScale);var d=a.resolutionScale,e=this.context,h=this._state.clone();if(null!=a.rotation){var g=h.viewpoint;h.viewpoint.rotation=a.rotation;
h.viewpoint=g}h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:h,pixelRatio:d,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};d=M(e.gl);g=new L.TextureDescriptor(c,b);g.wrapMode=m.TextureWrapMode.CLAMP_TO_EDGE;g.internalFormat=d?m.SizedPixelFormat.RGBA8:m.PixelFormat.RGBA;g.isImmutable=d;d=new I.FramebufferObject(e,g,new J.RenderbufferDescriptor(m.RenderbufferFormat.DEPTH_STENCIL,c,b));g=e.getBoundFramebufferObject();const k=e.getViewport();
e.bindFramebuffer(d);e.setViewport(0,0,c,b);this._renderChildren(a.children,h);c=this._readbackScreenshot(d,{...a.cropArea,y:b-(a.cropArea.y+a.cropArea.height)});e.bindFramebuffer(g);e.setViewport(k.x,k.y,k.width,k.height);this.requestRender();e=await c;1===a.outputScale?a=e:(a=new ImageData(Math.round(e.width*a.outputScale),Math.round(e.height*a.outputScale)),G.resampleHermite(e,a,!0));d.dispose();return a};f._readbackScreenshot=async function(a,c){const b=N.createEmptyImageData(c.width,c.height,
document.createElement("canvas"));await a.readPixelsAsync(c.x,c.y,c.width,c.height,m.PixelFormat.RGBA,m.PixelType.UNSIGNED_BYTE,new Uint8Array(b.data.buffer));return b};f._resizeCanvas=function(a){const c=this._canvas,b=c.style,{state:{size:d},pixelRatio:e}=a;a=d[0];const h=d[1],g=Math.round(a*e),k=Math.round(h*e);if(c.width!==g||c.height!==k)c.width=g,c.height=k;b.width=a+"px";b.height=h+"px"};f._emptyTrash=function(){for(;0<this._trash.size;){const a=Array.from(this._trash);this._trash.clear();
for(const c of a)c.processDetach()}};f._isLabelDrawPhaseRequired=function(a){let c=!1;for(const b of a){if(!(b instanceof v.Container)){c=c||!1;break}if("hasLabels"in b&&b.hasLabels)return!0;c=c||this._isLabelDrawPhaseRequired(b.children)}return c};l._createClass(n,[{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=a;this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},
set:function(a){this._renderingOptions=a;this.requestRender()}},{key:"state",get:function(){return this._state},set:function(a){this._state=a;this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())}}]);return n}(v.Container);q.EXTRA_RENDER_TIME=2E3;q.Stage=O;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});
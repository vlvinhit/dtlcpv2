// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ./decluttering/SymbolFader ./style/StyleDefinition ../webgl/enums ../webgl/RenderableTile ../webgl/TileContainer ../../tiling/TileCoverage ../../tiling/TileKey ../../../webgl/enums".split(" "),function(D,e,H,E,I,p,t,J,A,K,L,k){function F(q,g){if(q){const d=q.getLayoutProperty("visibility");if(!d||d.getValue()!==p.Visibility.NONE&&(void 0===q.minzoom||q.minzoom<g+1E-6)&&
(void 0===q.maxzoom||q.maxzoom>=g-1E-6))return!0}return!1}A=function(q){function g(a){a=q.call(this,a)||this;a._backgroundTiles=[];a._pointToCallbacks=new Map;return a}e._inherits(g,q);var d=g.prototype;d.destroy=function(){this.removeAllChildren();this._spriteMosaic?.dispose();this._spriteMosaic=null;this._glyphMosaic?.dispose();this._glyphMosaic=null;null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null);this._styleRepository=null;this._backgroundTiles=[];this._pointToCallbacks.clear()};
d.setStyleResources=function(a,b,c){this._spriteMosaic=a;this._glyphMosaic=b;this._styleRepository=c;null==this._symbolFader&&(a=new I.SymbolFader(this._styleRepository,this.children),a.on("fade-start",()=>{this.emit("fade-start");this.requestRender()}),a.on("fade-complete",()=>{this.emit("fade-complete");this.requestRender()}),this._symbolFader=a);this._symbolFader.styleRepository=c};d.setSpriteMosaic=function(a){this._spriteMosaic?.dispose();this._spriteMosaic=a};d.deleteStyleLayers=function(a){null!=
this._symbolFader&&this._symbolFader.deleteStyleLayers(a)};d.hitTest=async function(a){const b=H.createResolver();this._pointToCallbacks.set(a,b);this.requestRender();return b.promise};d.enterTileInvalidation=function(){for(const a of this.children)a.invalidating=!0};d.createRenderParams=function(a){return{...e._get(e._getPrototypeOf(g.prototype),"createRenderParams",this).call(this,a),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}};
d.doRender=function(a){!this.visible||a.drawPhase!==t.WGLDrawPhase.MAP&&a.drawPhase!==t.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e._get(e._getPrototypeOf(g.prototype),"doRender",this).call(this,a)};d.addChild=function(a){e._get(e._getPrototypeOf(g.prototype),"addChild",this).call(this,a);null!=this._symbolFader?this._symbolFader.addTile(a):a.decluttered=!0;this.requestRender();return a};d.removeChild=function(a){null!=this._symbolFader&&this._symbolFader.removeTile(a);this.requestRender();
return e._get(e._getPrototypeOf(g.prototype),"removeChild",this).call(this,a)};d.renderChildren=function(a){const {drawPhase:b}=a;if(b===t.WGLDrawPhase.DEBUG)e._get(e._getPrototypeOf(g.prototype),"renderChildren",this).call(this,a);else if(this._doRender(a),0<this._pointToCallbacks.size){a.drawPhase=t.WGLDrawPhase.HITTEST;const c=a.painter.effects.hittestVTL;c.bind(a);this._doRender(a);c.draw(a,this._pointToCallbacks);c.unbind(a);a.drawPhase=b}};d.removeAllChildren=function(){for(let a=0;a<this.children.length;a++){const b=
this.children[a];null!=this._symbolFader&&this._symbolFader.removeTile(b);b.dispose()}e._get(e._getPrototypeOf(g.prototype),"removeAllChildren",this).call(this)};d.getStencilTarget=function(){return this.children.filter(a=>a.neededForCoverage&&a.hasData())};d.restartDeclutter=function(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()};d._doRender=function(a){const {context:b}=a;var c=this._styleRepository;if(c){var r=c.layers,h=!0;a.drawPhase===t.WGLDrawPhase.HITTEST&&(h=!1);0<c.backgroundBucketIds.length&&
(a.renderPass="background",this._renderBackgroundLayers(a,c.backgroundBucketIds));e._get(e._getPrototypeOf(g.prototype),"renderChildren",this).call(this,a);a.drawPhase===t.WGLDrawPhase.MAP&&this._fade(a.displayLevel,a.state);if((c=this.children.filter(l=>l.visible&&l.hasData()))&&0!==c.length){for(var f of c)f.triangleCount=0;b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(k.StencilOperation.KEEP,k.StencilOperation.KEEP,k.StencilOperation.REPLACE);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);
b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);b.setDepthFunction(k.CompareFunction.LEQUAL);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);a.renderPass="opaque";for(f=r.length-1;0<=f;f--)this._renderStyleLayer(r[f],a,c);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(h);b.setBlendFunctionSeparate(k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA,k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA);a.renderPass="translucent";for(h=0;h<r.length;h++)this._renderStyleLayer(r[h],a,c)}b.bindVAO();
b.setStencilTestEnabled(!0);b.setBlendingEnabled(!0)}};d._fade=function(a,b){null!=this._symbolFader&&(this._symbolFader.update(a,b)||this.requestRender())};d._renderStyleLayer=function(a,b,c){const {painter:r,renderPass:h}=b;if(void 0!==a){var f=a.getLayoutProperty("visibility");if(!f||f.getValue()!==p.Visibility.NONE){switch(a.type){case p.StyleLayerType.BACKGROUND:return;case p.StyleLayerType.FILL:if("opaque"!==h&&"translucent"!==b.renderPass)return;var l="vtlFill";break;case p.StyleLayerType.LINE:if("translucent"!==
h)return;l="vtlLine";break;case p.StyleLayerType.CIRCLE:if("translucent"!==h)return;l="vtlCircle";break;case p.StyleLayerType.SYMBOL:if("translucent"!==h)return;l="vtlSymbol"}c=a.type===p.StyleLayerType.SYMBOL?c.filter(n=>n.decluttered):c.filter(n=>n.neededForCoverage);if("vtlSymbol"!==l&&(f=b.displayLevel,0===c.length||void 0!==a.minzoom&&a.minzoom>=f+1E-6||void 0!==a.maxzoom&&a.maxzoom<f-1E-6))return;f=a.uid;b.styleLayerUID=f;b.styleLayer=a;for(const n of c)if(n.layerData.has(f)){r.renderObjects(b,
c,l);break}}}};d._renderBackgroundLayers=function(a,b){const {context:c,displayLevel:r,painter:h,state:f}=a,l=this._styleRepository;var n=!1;for(var x of b)if(l.getLayerById(x).type===p.StyleLayerType.BACKGROUND&&F(l.getLayerById(x),r)){n=!0;break}if(n){n=this._tileInfoView.getTileCoverage(a.state,0,!0,"smallest");var {spans:M,lodInfo:y}=n,{level:u}=y,B=E.create();x=[];if(this._renderPasses){var v=this._renderPasses[0];null!=this._clippingInfos&&(v.brushes[0].prepareState(a),v.brushes[0].drawMany(a,
this._clippingInfos))}v=this._backgroundTiles;var C=0;for(const {row:z,colFrom:N,colTo:O}of M)for(let w=N;w<=O;w++){if(C<v.length){var m=v[C];m.key.set(u,z,y.normalizeCol(w),y.getWorldForColumn(w));this._tileInfoView.getTileBounds(B,m.key,!1);m.x=B[0];m.y=B[3];m.resolution=this._tileInfoView.getTileResolution(u)}else{m=new L(u,z,y.normalizeCol(w),y.getWorldForColumn(w));const G=this._tileInfoView.getTileBounds(E.create(),m),P=this._tileInfoView.getTileResolution(u);m=new J.RenderableTile(m,P,G[0],
G[3],512,512,4096,4096);v.push(m)}m.setTransform(f);x.push(m);C++}c.setStencilWriteMask(0);c.setColorMask(!0,!0,!0,!0);c.setStencilOp(k.StencilOperation.KEEP,k.StencilOperation.KEEP,k.StencilOperation.REPLACE);c.setStencilFunction(k.CompareFunction.EQUAL,0,255);u=!0;a.drawPhase===t.WGLDrawPhase.HITTEST&&(u=!1);c.setStencilTestEnabled(u);for(const z of b)b=l.getLayerById(z),b.type===p.StyleLayerType.BACKGROUND&&F(b,r)&&(a.styleLayerUID=b.uid,a.styleLayer=b,h.renderObjects(a,x,"vtlBackground"));K.pool.release(n)}};
return e._createClass(g)}(A);D.VectorTileContainer=A;Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
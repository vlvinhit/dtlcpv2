// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ./RectangleBinPack ../webgl/Rect ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(B,x,C,y,D,E){return function(){function z(b,h,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=b;this.height=h;this._glyphSource=c;this._binPack=new x(b-4,h-4);this._glyphData.push(new Uint8Array(b*h));this._dirties.push(!0);
this._textures.push(void 0)}var t=z.prototype;t.getGlyphItems=function(b,h){const c=[],f=this._glyphSource,e=new Set,w=1/256;for(const d of h)e.add(Math.floor(d*w));const k=[];e.forEach(d=>{const a=b+d;this._rangePromises.has(a)?k.push(this._rangePromises.get(a)):(d=f.getRange(b,d).then(()=>{this._rangePromises["delete"](a)},()=>{this._rangePromises["delete"](a)}),this._rangePromises.set(a,d),k.push(d))});return Promise.all(k).then(()=>{let d=this._glyphIndex[b];d||(d={},this._glyphIndex[b]=d);for(const m of h){var a=
d[m];if(a){c[m]={sdf:!0,rect:a.rect,metrics:a.metrics,page:a.page,code:m};continue}var g=f.getGlyph(b,m);if(!g||!g.metrics)continue;a=g.metrics;let l;if(0===a.width)l=new C(0,0,0,0);else{const n=a.width+6,r=a.height+6;var p=n%4?4-n%4:4,q=r%4?4-r%4:4;1===p&&(p=5);1===q&&(q=5);l=this._binPack.allocate(n+p,r+q);l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),
this._textures.push(void 0),this._binPack=new x(this.width-4,this.height-4),l=this._binPack.allocate(n+p,r+q));p=this._glyphData[this._currentPage];g=g.bitmap;let A;if(g)for(let u=0;u<r;u++){q=n*u;A=this.width*(l.y+u+1)+l.x;for(let v=0;v<n;v++)p[A+v+1]=g[q+v]}}d[m]={rect:l,metrics:a,tileIDs:null,page:this._currentPage};c[m]={sdf:!0,rect:l,metrics:a,page:this._currentPage,code:m};this._dirties[this._currentPage]=!0}return c})};t.removeGlyphs=function(b){for(const h in this._glyphIndex){const c=this._glyphIndex[h];
if(!c)continue;let f;for(const e in c)if(f=c[e],f.tileIDs["delete"](b),0===f.tileIDs.size){const w=this._glyphData[f.page],k=f.rect;let d,a;for(let g=0;g<k.height;g++)for(d=this.width*(k.y+g)+k.x,a=0;a<k.width;a++)w[d+a]=0;delete c[e];this._dirties[f.page]=!0}}};t.bind=function(b,h,c,f=0){if(!this._textures[c]){var e=new E.TextureDescriptor;e.pixelFormat=y.PixelFormat.ALPHA;e.wrapMode=y.TextureWrapMode.CLAMP_TO_EDGE;e.width=this.width;e.height=this.height;this._textures[c]=new D.Texture(b,e,new Uint8Array(this.width*
this.height))}e=this._textures[c];e.setSamplingMode(h);this._dirties[c]&&e.setData(this._glyphData[c]);b.bindTexture(e,f);this._dirties[c]=!1};t.dispose=function(){this._binPack=null;for(const b of this._textures)b&&b.dispose();this._textures.length=0};return B._createClass(z)}()});
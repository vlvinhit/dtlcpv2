// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/LRUCache","../../tiling/TileCoverage","../../tiling/TileKey"],function(u,w,x,y,r){const z=(m,f)=>m+1/(1<<2*f);let B=function(){function m(a,b){this._tiles=new Map;this._tileCache=new x.LRUCache(40,c=>c.dispose());this._viewSize=[0,0];this._visibleTiles=new Map;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this._container=b}var f=m.prototype;f.destroy=function(){for(const [,
a]of this._tiles)a.dispose();this._tiles=null;this._tileCache.clear();this._tileCache=null};f.update=function(a){this._updateCacheSize(a);const b=this.tileInfoView;a=b.getTileCoverage(a.state,0,!0,"smallest");const {spans:c,lodInfo:e}=a,{level:g}=e,d=this._tiles,l=new Set,n=new Set;for(const {row:h,colFrom:k,colTo:A}of c)for(let p=k;p<=A;p++){const t=r.getId(g,h,e.normalizeCol(p),e.getWorldForColumn(p)),v=this._getOrAcquireTile(t);l.add(t);v.processed()?this._addToContainer(v):n.add(new r(t))}for(const [h,
k]of d)k.isCoverage=l.has(h);for(var q of n)this._findPlaceholdersForMissingTiles(q,l);q=!1;for(const [h,k]of d)k.neededForCoverage=l.has(h),k.neededForCoverage||k.isHoldingForFade&&b.intersects(a,k.key)&&l.add(h),k.isFading&&(q=!0);for(const [h]of this._tiles)l.has(h)||this._releaseTile(h);y.pool.release(a);return!q};f.clear=function(){this._tiles.clear();this._tileCache.clear();this._visibleTiles.clear()};f.clearCache=function(){this._tileCache.clear()};f._findPlaceholdersForMissingTiles=function(a,
b){var c=[];for(const [,e]of this._tiles)this._addPlaceholderChild(c,e,a,b);c=c.reduce(z,0);1E-6>Math.abs(1-c)||this._addPlaceholderParent(a.id,b)};f._addPlaceholderChild=function(a,b,c,e){if(!(b.key.level<=c.level)&&b.hasData()){var g=b.key,d=g.level-c.level;c.row===g.row>>d&&c.col===g.col>>d&&c.world===g.world&&(this._addToContainer(b),e.add(b.id),a.push(b.key.level-c.level))}};f._addPlaceholderParent=function(a,b){const c=this._tiles;for(;;){{const [g,d,l,n]=a.split("/");a=parseInt(g,10);a=0===
a?null:`${a-1}/${parseInt(d,10)>>1}/${parseInt(l,10)>>1}/${parseInt(n,10)}`}if(!a||b.has(a))break;const e=c.get(a);if(e&&e.hasData()){this._addToContainer(e);b.add(e.id);break}}};f._getOrAcquireTile=function(a){let b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))||(b=this.acquireTile(new r(a)));this._tiles.set(a,b);return b};f._releaseTile=function(a){const b=this._tiles.get(a);this.releaseTile(b);this._removeFromContainer(b);this._tiles.delete(a);b.hasData()?this._tileCache.put(a,b,
1):b.dispose()};f._addToContainer=function(a){let b;const c=[],e=this._container;if(!e.contains(a)){var g=this._visibleTiles;for(const [,d]of g)this._canConnectDirectly(a,d)&&c.push(d),null==b&&this._canConnectDirectly(d,a)&&(b=d);if(null!=b){for(const d of c)b.childrenTiles.delete(d),a.childrenTiles.add(d),d.parentTile=a;b.childrenTiles.add(a);a.parentTile=b}else for(const d of c)a.childrenTiles.add(d),d.parentTile=a;g.set(a.id,a);e.addChild(a)}};f._removeFromContainer=function(a){this._visibleTiles.delete(a.id);
this._container.removeChild(a);if(null!=a.parentTile){a.parentTile.childrenTiles.delete(a);for(const b of a.childrenTiles)null!=a.parentTile&&a.parentTile.childrenTiles.add(b)}for(const b of a.childrenTiles)b.parentTile=a.parentTile;a.parentTile=null;a.childrenTiles.clear()};f._canConnectDirectly=function(a,b){a=a.key;let {level:c,row:e,col:g,world:d}=b.key;for(b=this._visibleTiles;0<c;){c--;e>>=1;g>>=1;if(a.level===c&&a.row===e&&a.col===g&&a.world===d)return!0;if(b.has(`${c}/${e}/${g}/${d}`))break}return!1};
f._updateCacheSize=function(a){a=a.state.size;if(a[0]!==this._viewSize[0]||a[1]!==this._viewSize[1]){var b=Math.ceil(a[0]/512)+1,c=Math.ceil(a[1]/512)+1;this._viewSize[0]=a[0];this._viewSize[1]=a[1];this._tileCache.maxSize=5*b*c}};return w._createClass(m)}();u.TileManager=B;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],function(n,w,x,k,y){const p=w.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");return function(q){function m(d){var a=q.call(this)||this;a._ongoingMaterialRequestMap=new Map;a._materialCache=new Map;a._dynamicPropertyMap=new Map;a._cimLayer=d;return a}n._inherits(m,q);m.prototype.analyze=async function(d,
a,e,f,g){if(g&&0===g.length)return null;const r=g&&0<g.length,h=a.readLegacyFeature();a=a.getObjectId();const t=this._materialCache;var b=this._cimLayer.materialHash;if(!b)return p.error("A Dynamic mesh template must have a material hash value or function!"),null;const c="function"===typeof b?b(h,e,f,a):b;b=t.get(c);if(null!=b||(b=this._ongoingMaterialRequestMap.get(c)))return b;b=this._cimLayer;const u=x.analyzeCIMResource(b.cim,this._cimLayer.materialOverrides);u.mosaicHash=c;const {type:v,url:z}=
b;a={cim:u,type:v,mosaicHash:c,url:z,size:null,dashTemplate:null,text:null,fontName:null,objectId:a,animatedSymbolProperties:null};switch(v){case "marker":a.size=k.evaluateValueOrFunction(b.size,h,e,f);a.animatedSymbolProperties=k.evaluateValueOrFunction(b.animatedSymbolProperties,h,e,f);break;case "line":a.dashTemplate=b.dashTemplate;break;case "text":a.text=k.evaluateValueOrFunction(b.text,h,e,f),a.fontName=k.evaluateValueOrFunction(b.fontName,h,e,f)}d=d.getMosaicItem(a,g).then(l=>{r||(this._ongoingMaterialRequestMap.delete(c),
t.set(c,l));return l}).catch(l=>{this._ongoingMaterialRequestMap.delete(c);p.error(".analyze()",l.message);return null});r||this._ongoingMaterialRequestMap.set(c,d);return d};return n._createClass(m)}(y)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../enums ../VertexStream ./WGLGeometryBrushMarker ../effects/Effect ../techniques/utils ../../../../webgl/contextUtils ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/heatmapTextureUtils ../../../../webgl/Renderbuffer ../../../../webgl/RenderbufferDescriptor ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),function(n,w,v,B,C,D,E,x,F,h,
G,H,I,J,K,y){function z(q,k){const {referenceScale:e,radius:a}=q;return a*(0!==e?e/k.scale:1)}const A=w.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");w=function(q){function k(){var a=q.apply(this,arguments)||this;a.brushEffect=new L;return a}n._inherits(k,q);var e=k.prototype;e.supportsSymbology=function(a){return a===B.WGLSymbologyType.HEATMAP};e.dispose=function(){n._get(n._getPrototypeOf(k.prototype),"dispose",this).call(this);this.brushEffect.dispose();this.brushEffect=null};
e.prepareState=function(){};e.drawGeometry=function(a,b,c,f){const {defines:g}=this.brushEffect.loadQualityProfile(a.context);n._get(n._getPrototypeOf(k.prototype),"drawGeometry",this).call(this,a,b,c,f?[...f,...g]:g)};e._drawMarkers=function(a,b,c,f,g,d,m){const {context:p,rendererInfo:r,state:u}=a;({rendererSchema:a}=r);x.assertRendererSchema(a,"heatmap");const {isFieldActive:t}=a;c.setUniform1f("u_radius",z(a,u));m||(c.setUniform1f("u_isFieldActive",t),p.setStencilFunction(h.CompareFunction.GEQUAL,
b.stencilRef,255));p.drawElements(f,g,h.DataType.UNSIGNED_INT,d)};return n._createClass(k)}(D);const M={vsPath:"heatmap/heatmapResolve",fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])};let L=function(q){function k(){var a=q.apply(this,arguments)||this;a.name=a.constructor.name;return a}n._inherits(k,q);var e=k.prototype;e.createOptions=function({passOptions:a}){return a};e.dispose=function(){this._prevFBO=null;null!=this._accumulateFramebuffer&&this._accumulateFramebuffer.detachDepthStencilBuffer();
this._accumulateOutputStencilBuffer=v.disposeMaybe(this._accumulateOutputStencilBuffer);this._accumulateFramebuffer=v.disposeMaybe(this._accumulateFramebuffer);this._resolveGradientTexture=v.disposeMaybe(this._resolveGradientTexture);this._tileQuad=v.disposeMaybe(this._tileQuad)};e.bind=function(a){const {context:b,rendererInfo:c,passOptions:f,state:g}=a,{rendererSchema:d}=c;null!=f&&"hittest"===f.type||"heatmap"!==d.type||(this._prevFBO=b.getBoundFramebufferObject(),this._prevViewport=b.getViewport(),
x.assertRendererSchema(d,"heatmap"),this._loadResources(a),this._updateResources(b,d,g),b.bindFramebuffer(this._accumulateFramebuffer),b.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),b.setStencilTestEnabled(!0),b.setBlendingEnabled(!0),b.setBlendFunction(h.BlendFactor.ONE,h.BlendFactor.ONE),b.setClearColor(0,0,0,0),b.clear(h.ClearBufferBit.COLOR_BUFFER_BIT))};e.unbind=function(){this._prevViewport=this._prevFBO=null};e.draw=function(a){const {context:b,painter:c,
rendererInfo:f,passOptions:g}=a;({rendererSchema:a}=f);if((null==g||"hittest"!==g.type)&&"heatmap"===a.type){var {defines:d}=this.loadQualityProfile(b);d=c.materialManager.getProgram(M,d);b.useProgram(d);b.bindFramebuffer(this._prevFBO);b.setViewport(0,0,this._prevViewport.width,this._prevViewport.height);b.setBlendFunction(h.BlendFactor.ONE,h.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setStencilTestEnabled(!1);var {radius:m,minDensity:p,densityRange:r}=a;b.bindTexture(this._accumulateFramebuffer.colorTexture,
8);b.bindTexture(this._resolveGradientTexture,9);d.setUniform1i("u_texture",8);d.setUniform1i("u_gradient",9);d.setUniform2f("u_densityMinAndInvRange",p,1/r);d.setUniform1f("u_densityNormalization",3/(m*m*Math.PI));this._tileQuad.draw()}};e._loadResources=function({context:a,painter:b}){const {dataType:c,samplingMode:f,pixelFormat:g,internalFormat:d,requiresSharedStencilBuffer:m}=this.loadQualityProfile(a),{width:p,height:r}=this._prevViewport,u=.25*p,t=.25*r;let l=new y.TextureDescriptor(u,t);l.pixelFormat=
g;l.internalFormat=d;l.dataType=c;l.samplingMode=f;l.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;m||(this._accumulateOutputStencilBuffer??(this._accumulateOutputStencilBuffer=new I.Renderbuffer(a,new J.RenderbufferDescriptor(h.RenderbufferFormat.DEPTH_STENCIL,u,t))));this._accumulateFramebuffer??(this._accumulateFramebuffer=new G.FramebufferObject(a,l,m?b.getSharedStencilBuffer():this._accumulateOutputStencilBuffer));l=new y.TextureDescriptor;l.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;this._resolveGradientTexture??
(this._resolveGradientTexture=new K.Texture(a,l));this._tileQuad??(this._tileQuad=new C(a,[0,0,1,0,0,1,1,1]))};e._updateResources=function(a,b,c){const {gradientHash:f,gradient:g}=b;this._prevGradientHash!==f&&(this._resolveGradientTexture.resize(g.length/4,1),this._resolveGradientTexture.setData(g),this._prevGradientHash=f);const {requiresSharedStencilBuffer:d}=this.loadQualityProfile(a);c=d?1:2>z(b,c)?1:.25;const {width:m,height:p}=this._prevViewport;b=m*c;c*=p;const {width:r,height:u}=this._accumulateFramebuffer;
if(r!==b||u!==c){const t=this._accumulateFramebuffer.depthStencilAttachment;if(d&&null!=t){const {width:l,height:N}=t.descriptor;if(l!==b||N!==c)A.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer()}this._accumulateFramebuffer.resize(b,c)}d||a.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,h.ClearBufferBit.STENCIL_BUFFER_BIT,
h.TextureSamplingMode.NEAREST)};e.loadQualityProfile=function(a){if(null==this._qualityProfile){const b=H.loadHeatmapTextureConfiguration(a,A);this._qualityProfile={...b,requiresSharedStencilBuffer:a.type===F.ContextType.WEBGL1,defines:b.dataType!==h.PixelType.FLOAT?["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile};return n._createClass(k)}(E.Effect);return w});
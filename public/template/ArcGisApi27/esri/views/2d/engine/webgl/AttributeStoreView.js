// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ./definitions ./DisplayId ./Utils ./util/debug ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(B,C,D,u,v,l,J,f,E,n,F,p,K,G,H){const w=v.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),x=F.createDebugLogger(F.DEBUG_ATTR_UPDATES,
w);let I=function(){function m(a,b,c){this._lastTexture=this._texture=null;this._fbos={};this.texelSize=4;const {buffer:d,pixelType:g,textureOnly:h}=a;a=n.getPixelArrayCtor(g);this.shared=c;this.pixelType=g;this.size=b;this.textureOnly=h;h||(this.data=new a(d));this._resetRange()}var e=m.prototype;e.destroy=function(){l.applySome(this._texture,a=>a.dispose());for(const a in this._fbos)l.applySome(this._fbos[a],b=>{"0"===a&&b.detachColorTexture();b.dispose()}),this._fbos[a]=null;this._texture=null};
e.setData=function(a,b,c){a=E.getDisplayIdTexel(a);const d=this.data;b=a*this.texelSize+b;!d||b>=d.length||(d[b]=c,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};e.getData=function(a,b){if(null==this.data)return null;a=E.getDisplayIdTexel(a)*this.texelSize+b;return!this.data||a>=this.data.length?null:this.data[a]};e.getTexture=function(a){return this._texture??this._initTexture(a)};e.getFBO=function(a,b=0){if(!this._fbos[b]){const c=0===b?this.getTexture(a):
this._textureDesc;this._fbos[b]=new K.FramebufferObject(a,c)}return this._fbos[b]};e.updateTexture=function(a,b){if(!this.locked){try{const c=this.dirtyStart,d=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const g=this.data.buffer,h=this.getTexture(a),k=(c-c%this.size)/this.size,r=(d-d%this.size)/this.size,q=k*this.size*4,y=4*(this.size+r*this.size)-q,t=n.getPixelArrayCtor(this.pixelType),z=new t(g,q*t.BYTES_PER_ELEMENT,y),A=this.size;a=r-k+1;if(a>this.size){w.error(new D("mapview-webgl",
"Out-of-bounds index when updating AttributeData"));return}h.updateData(0,0,k,A,a,z)}catch(c){}b()}};e.update=function(a){const {data:b,start:c,end:d}=a;if(null!=b&&null!=this.data){const g=this.data,h=c*this.texelSize;for(let k=0;k<b.length;k++)a.layout&1<<k%this.texelSize&&(g[h+k]=b[k])}this.dirtyStart=Math.min(this.dirtyStart,c);this.dirtyEnd=Math.max(this.dirtyEnd,d)};e.resize=function(a,b){const c=this.size;this.size=b;this.textureOnly?c!==this.size&&(this._lastTexture=this._texture,this._texture=
null):(b=n.getPixelArrayCtor(this.pixelType),this.destroy(),this.data=new b(a.buffer))};e._resetRange=function(){this.dirtyStart=2147483647;this.dirtyEnd=0};e._initTexture=function(a){const b=new G.Texture(a,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const g=this._lastTexture.descriptor.width,h=this._lastTexture.descriptor.height,k=this._lastTexture.descriptor.dataType,r=this._lastTexture.descriptor.pixelFormat,q=this.getFBO(a);var c=n.getPixelBytes(k),d=n.getPixelArrayCtor(k);
c=new ArrayBuffer(g*h*c*this.texelSize);d=new d(c);c=a.getBoundFramebufferObject();const {x:y,y:t,width:z,height:A}=a.getViewport();a.bindFramebuffer(q);q.readPixels(0,0,g,h,r,k,d);b.updateData(0,0,0,2*g,h/2,d);a.setViewport(y,t,z,A);a.bindFramebuffer(c)}this.destroy();return this._texture=b};C._createClass(m,[{key:"_textureDesc",get:function(){const a=new H.TextureDescriptor;a.wrapMode=p.TextureWrapMode.CLAMP_TO_EDGE;a.samplingMode=p.TextureSamplingMode.NEAREST;a.dataType=this.pixelType;a.width=
this.size;a.height=this.size;return a}},{key:"locked",get:function(){return this.pixelType===p.PixelType.UNSIGNED_BYTE&&this.shared&&!this.textureOnly&&u("esri-atomics")&&this.data?1===Atomics.load(this.data,0):!1}},{key:"hasDirty",get:function(){return this.dirtyEnd>=this.dirtyStart}}]);return m}();v=function(){function m(a){this._onUpdate=a;this._locked=this._forceNextUpload=this._initialized=!1}var e=m.prototype;e.initialize=function(a){const {blocks:b,shared:c,size:d}=a;this.shared=c;this.size=
d;x("Initializing AttributeStoreView",a);if(null==this._data)this._data=l.mapMany(b,g=>new I(g,d,c));else for(a=0;a<this._data.length;a++){const g=this._data[a],h=b[a];null!=h&&(null==g?this._data[a]=new I(h,d,c):g.resize(h,d))}this._initialized=!0};e.destroy=function(){l.applySome(this._data,a=>l.mapMany(a,b=>b.destroy()));l.applySome(this._defaultTexture,a=>a.dispose())};e.isEmpty=function(){return null==this._data};e.isUpdating=function(){const a=null!=this._pendingAttributeUpdate;u("esri-2d-log-updating")&&
console.log(`Updating AttributeStoreView ${a}\n  -> hasPendingUpdate ${a}`);return a};e.getBlock=function(a){return null==this._data?null:this._data[a]};e.setLabelMinZoom=function(a,b){this.setData(a,0,1,b)};e.getLabelMinZoom=function(a){return this.getData(a,0,1,255)};e.getFilterFlags=function(a){return this.getData(a,0,0,0)};e.getVVSize=function(a){return this.getData(a,f.ATTRIBUTE_DATA_VV,0,0)};e.getData=function(a,b,c,d){if(!this._data)return 0;b=this._data[b];if(null==b)return 0;a=b.getData(a,
c);return null!=a?a:d};e.setData=function(a,b,c,d){this._data[b].setData(a,c,d)};e.lockTextureUpload=function(){this._locked=!0};e.unlockTextureUpload=function(){this._locked=!1};e.forceTextureUpload=function(){this._forceNextUpload=!0};e.requestUpdate=async function(a){if(this._pendingAttributeUpdate)w.error(new D("mapview-webgl","Tried to update attribute data with a pending update"));else{var b=J.createResolver();x("AttributeStoreView Update Requested",a);this._pendingAttributeUpdate={data:a,resolver:b};
this._onUpdate();return b.promise}};e.update=function(){if(this._initialized&&null!=this._pendingAttributeUpdate){u("esri-2d-update-debug")&&console.debug("AttributeStoreView::update");const {data:a,resolver:b}=this._pendingAttributeUpdate,c=this._data;for(let d=0;d<a.blocks.length;d++){const g=a.blocks[d];l.applySome(c[d],h=>l.applySome(g,k=>{x(`Updating block ${d}`,k);h.update(k)}))}this._pendingAttributeUpdate=null;b();this._onUpdate()}};e.bindTextures=function(a,b=!0){const c=this._getDefaultTexture(a);
if(this._initialized){var d=this._data;if(!this._locked||this._forceNextUpload)l.forEachSome(d,g=>g.updateTexture(a,()=>this._onUpdate())),this._forceNextUpload=!1;a.bindTexture(d[f.ATTRIBUTE_DATA_FILTER_FLAGS]?.getTexture(a)??c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_0);b&&(a.bindTexture(d[f.ATTRIBUTE_DATA_GPGPU]?.getTexture(a)??c,f.TEXTURE_BINDING_GPGPU),a.bindTexture(d[f.ATTRIBUTE_DATA_ANIMATION]?.getTexture(a)??c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(d[f.ATTRIBUTE_DATA_VV]?.getTexture(a)??
c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_2),a.bindTexture(d[f.ATTRIBUTE_DATA_DD1]?.getTexture(a)??c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_3),a.bindTexture(d[f.TEXTURE_BINDING_ATTRIBUTE_DATA_4]?.getTexture(a)??c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_4),a.bindTexture(d[f.TEXTURE_BINDING_ATTRIBUTE_DATA_5]?.getTexture(a)??c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_5))}else a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_0),b&&(a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_2),
a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_3),a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_4),a.bindTexture(c,f.TEXTURE_BINDING_ATTRIBUTE_DATA_5),a.bindTexture(c,f.TEXTURE_BINDING_GPGPU))};e._getDefaultTexture=function(a){if(null==this._defaultTexture){const b=new H.TextureDescriptor;b.wrapMode=p.TextureWrapMode.CLAMP_TO_EDGE;b.samplingMode=p.TextureSamplingMode.NEAREST;b.width=1;b.height=1;this._defaultTexture=new G.Texture(a,b,new Uint8Array(4))}return this._defaultTexture};return C._createClass(m)}();
B.AttributeStoreView=v;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
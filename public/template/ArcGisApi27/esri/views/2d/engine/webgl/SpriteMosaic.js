// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/has ./definitions ./GeometryUtils ./Rect ./RectangleBinPack ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(y,z,u,n,v,w,x,A,B,C){function p(m){return m&&"static"===m.type}let D=0;return function(){function m(a,b,c=0){this._mosaicPages=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects=new Map;this._spriteCopyQueue=[];
this.pixelRatio=1;(0>=a||0>=b)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=a;this._pageHeight=b;0<c&&(this._maxItemSize=c);this.pixelRatio=window.devicePixelRatio||1;this._binPack=new x(this._pageWidth,this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight))},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var k=m.prototype;k.getWidth=
function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[0]};k.getHeight=function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[1]};k.getPageTexture=function(a){return a<this._mosaicPages.length?this._mosaicPages[a].texture:null};k.has=function(a){return this._mosaicRects.has(a)};k.getSpriteItem=function(a){return this._mosaicRects.get(a)};k.addSpriteItem=function(a,b,c,d,f,g,e=1){if(this._mosaicRects.has(a))return this._mosaicRects.get(a);let h,l,q;p(c)?[h,
l,q]=this._allocateImage(b[0],b[1]):(h=new w(0,0,b[0],b[1]),l=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:c,size:[b[0]+2*n.SPRITE_PADDING,b[1]+2*n.SPRITE_PADDING],dirty:!0,texture:void 0}));if(0>=h.width||0>=h.height)return null;g={rect:h,width:b[0],height:b[1],sdf:f,simplePattern:g,pixelRatio:e,page:l};this._mosaicRects.set(a,g);p(c)&&(u("esri-mosaic-debug")&&this._showDebugSprite(b,c.data),this._copy({rect:h,spriteSize:b,spriteData:c.data,page:l,pageSize:q,repeat:d,sdf:f}));return g};
k.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length};k.processNextItem=function(){const a=this._spriteCopyQueue.pop();a&&this._copy(a)};k.getSpriteItems=function(a){const b={};for(const c of a)b[c]=this.getSpriteItem(c);return b};k.getMosaicItemPosition=function(a){const b=(a=this.getSpriteItem(a))&&a.rect;if(!b)return null;b.width=a.width;b.height=a.height;const c=n.SPRITE_PADDING,d=this._mosaicPages[a.page].size;return{size:[a.width,a.height],tl:[(b.x+c)/d[0],(b.y+c)/d[1]],br:[(b.x+
c+a.width)/d[0],(b.y+c+a.height)/d[1]],page:a.page}};k.bind=function(a,b,c=0,d=0){const f=this._mosaicPages[c],g=f.mosaicsData;var e=f.texture;if(!e){e=f.size;const h=new C.TextureDescriptor;h.width=e[0];h.height=e[1];h.wrapMode=A.TextureWrapMode.CLAMP_TO_EDGE;e=new B.Texture(a,h,null);f.texture=e}e.setSamplingMode(b);p(g)?(a.bindTexture(e,d),f.dirty&&(e.setData(new Uint8Array(g.data.buffer)),e.generateMipmap(),u("esri-mosaic-debug")&&this._showDebugPage(c))):(g.data.bindFrame(a,e,d),e.generateMipmap());
f.dirty=!1};k.dispose=function(){this._binPack=null;for(const b of this._mosaicPages){var a=b.texture;a&&a.dispose();a=b.mosaicsData;p(a)||a.data.destroy()}this._mosaicPages=null;this._mosaicRects.clear()};m._copyBits=function(a,b,c,d,f,g,e,h,l,q,r){let t=d*b+c;e=h*g+e;if(r)for(e-=g,r=-1;r<=q;r++,t=((r+q)%q+d)*b+c,e+=g)for(h=-1;h<=l;h++)f[e+h]=a[t+(h+l)%l];else for(c=0;c<q;c++){for(d=0;d<l;d++)f[e+d]=a[t+d];t+=b;e+=g}};k._copy=function(a){if(!(a.page>=this._mosaicPages.length)){var b=this._mosaicPages[a.page],
c=b.mosaicsData;if(!p(b.mosaicsData))throw new z("mapview-invalid-resource","unsuitable data type!");var d=a.spriteData;(c=c.data)&&d||console.error("Source or target images are uninitialized!");m._copyBits(d,a.spriteSize[0],0,0,c,a.pageSize[0],a.rect.x+n.SPRITE_PADDING,a.rect.y+n.SPRITE_PADDING,a.spriteSize[0],a.spriteSize[1],a.repeat);b.dirty=!0}};k._allocateImage=function(a,b){a+=2*n.SPRITE_PADDING;b+=2*n.SPRITE_PADDING;var c=Math.max(a,b);if(this._maxItemSize&&this._maxItemSize<c){c=2**Math.ceil(v.log2(a));
const d=2**Math.ceil(v.log2(b));a=new w(0,0,a,b);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(c*d)},size:[c,d],dirty:!0,texture:void 0});return[a,this._mosaicPages.length-1,[c,d]]}c=this._binPack.allocate(a,b);return 0>=c.width?(c=this._mosaicPages[this._currentPage],!c.dirty&&p(c.mosaicsData)&&(c.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,
this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new x(this._pageWidth,this._pageHeight),this._allocateImage(a,b)):[c,this._currentPage,[this._pageWidth,this._pageHeight]]};k._showDebugSprite=function([a,b],c){const d=document.createElement("canvas");d.width=a;d.height=b;d.setAttribute("style",`position: absolute; top: ${4+204*D++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const f=d.getContext("2d");a=new ImageData(a,b);a.data.set(new Uint8Array(c.buffer));
f.putImageData(a,0,0);document.body.appendChild(d)};k._showDebugPage=function(a){const {size:[b,c],mosaicsData:d}=this._mosaicPages[a];if(p(d)){var f=`mosaicDebugPage${a}`,g=document.getElementById(f)??document.createElement("canvas");g.id=f;g.width=b;g.height=c;g.setAttribute("style",`position: absolute; top: ${4+204*a}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);a=g.getContext("2d");f=new ImageData(b,c);f.data.set(new Uint8Array(d.data.buffer));a.putImageData(f,0,0);document.body.appendChild(g)}else console.error("Could not show sprite mosaic debug for non-static resource")};
y._createClass(m,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]);return m}()});
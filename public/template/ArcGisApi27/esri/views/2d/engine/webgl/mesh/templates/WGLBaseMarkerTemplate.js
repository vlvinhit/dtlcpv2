// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/screenUtils ../../../../../../chunks/mat2d ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2 ../../../../../../chunks/vec2f32 ../../../../../../geometry/GeometryCursor ../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../definitions ../../enums ../../number ../../materialKey/MaterialKey".split(" "),function(y,C,q,D,n,z,E,F,r,A,m,G){const t=3.14159265359/180;return H=>function(B){function u(...a){a=
B.call(this,...a)||this;a.angle=0;a.xOffset=0;a.yOffset=0;a.width=0;a.height=0;a.boundsType="square";a._anchorX=0;a._anchorY=0;a._computedWidth=0;a._computedHeight=0;a._allowBorrowing=!0;a._vertexBoundsScaleX=1;a._vertexBoundsScaleY=1;a.geometryType=A.WGLGeometryType.MARKER;return a}y._inherits(u,B);var l=u.prototype;l._write=function(a,b,c,d){const h=b.getDisplayId();a.recordStart(h,this._materialKey,this.geometryType,!0);this._writeGeometry(a,b,h,c,d);a.recordEnd()};l._writeGeometry=function(a,
b,c,d,h){if(null!=this._markerPlacement)return this._writePlacedMarkers(a,b,d,h);this._allowBorrowing=!0;if(!h&&"esriGeometryPoint"===b.geometryType)return d=b.getX(),b=b.getY(),!a.hasAggregates&&a.hasPixelBufferEnabled&&(0>d||513<=d||0>b||513<=b)?void 0:this._writeVertices(a,c,this._getPos(d,b),d,b);b=h?h.asOptimized():"esriGeometryPolygon"===b.geometryType?b.readCentroid():b.readGeometryForDisplay();if(null!=b){if(b.isPoint){const [e,f]=b.coords;return!a.hasAggregates&&a.hasPixelBufferEnabled&&
(0>e||512<=e||0>f||512<=f)?void 0:this._writeVertices(a,c,this._getPos(e,f),e,f)}b.forEachVertex((e,f)=>{const g=2*r.TILE_SIZE;e<-g||e>=g||f<-g||f>=g||this._writeVertices(a,c,this._getPos(e,f),e,f)})}};l._writePlacedMarkers=function(a,b,c,d){if(d=d||E.GeometryCursor.fromFeatureSetReaderCIM(b))if(c=F.CIMMarkerPlacementHelper.getPlacement(d,-1,this._markerPlacement,C.pt2px(1),a.tileKey,c.geometryEngine)){this._allowBorrowing="esriGeometryPolygon"!==b.geometryType;b=b.getDisplayId();d=z.create();for(var h=
D.create(),e=c.next();null!=e;){const f=e.tx,g=-e.ty;-128<=f&&640>=f&&-128<=g&&640>=g&&(this._applyTransformation(h,d,-e.getAngle()/t),this._writeVertices(a,b,this._getPos(f,g),f,g));e=c.next()}}};l._writeVertices=function(a,b,c,d,h){const e=G.MarkerMaterialKey.load(this._materialKey);switch(e.symbologyType){case A.WGLSymbologyType.HEATMAP:return this._writeHeatmapVertices(a,b,c);default:return this._writeMarkerVertices(a,b,e,c,d,h)}};l._writeMarkerVertices=function(a,b,c,d,h,e){var f=c.vvRotation;
c=a.vertexCount();let g=this._computedWidth*this._vertexBoundsScaleX;var k=this._computedHeight*this._vertexBoundsScaleY;this.angle&&(g=k=Math.max(g,k));f&&(f=Math.max(this.xOffset,this.yOffset),g+=f,k+=f);this._allowBorrowing&&a.vertexBounds(h+this.xOffset,e-this.yOffset,g,k);a.vertexWrite(d);a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(this._texUpperLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);
a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetUpperRight);a.vertexWrite(this._texUpperRight);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(this._texBottomLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);
a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetBottomRight);a.vertexWrite(this._texBottomRight);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();this._writeIndices(a,c)};l._writeHeatmapVertices=function(a,b,c){const d=a.vertexCount();
a.vertexWrite(c);a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetUpperRight);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomRight);a.vertexWrite(b);a.vertexEnd();this._writeIndices(a,d)};l._writeIndices=function(a,b){a.indexWrite(b+0);a.indexWrite(b+1);a.indexWrite(b+2);a.indexWrite(b+1);a.indexWrite(b+3);a.indexWrite(b+
2)};l._applyTransformation=function(a,b,c=0){c?q.fromRotation(a,t*c):q.identity(a);q.translate(a,a,z.fromValues(this.xOffset,-this.yOffset));this.angle&&q.rotate(a,a,t*this.angle);c=this._computedWidth;const d=this._computedHeight,h=-(.5+this._anchorX)*c,e=-(.5-this._anchorY)*d;n.set(b,h,e);n.transformMat2d(b,b,a);this._offsetUpperLeft=m.i1616to32(16*b[0],16*b[1]);n.set(b,h+c,e);n.transformMat2d(b,b,a);this._offsetUpperRight=m.i1616to32(16*b[0],16*b[1]);n.set(b,h,e+d);n.transformMat2d(b,b,a);this._offsetBottomLeft=
m.i1616to32(16*b[0],16*b[1]);n.set(b,h+c,e+d);n.transformMat2d(b,b,a);this._offsetBottomRight=m.i1616to32(16*b[0],16*b[1])};l._computeSize=function(a,b,c,d,h,e,f,g){const k=a*c;c*=b;e.sdf&&!f?(d+=2,a=Math.min((g&&a>b?k:a)+d,k),b=Math.min(b+d,c)):(a=k,b=c);g=r.SDF_TEXTURE_SIZE/Math.max(k,c);f=.5*(k-a)*g;var p=.5*(c-b)*g;g=e.rect.x+r.SPRITE_PADDING+f;d=e.rect.y+r.SPRITE_PADDING+p;f=g+e.width-2*f;e=d+e.height-2*p;p=Math.floor(g);const v=Math.floor(d),w=Math.ceil(f),x=Math.ceil(e);a*=(w-p)/(f-g);b*=(x-
v)/(e-d);this._texUpperLeft=m.i1616to32(p,v);this._texUpperRight=m.i1616to32(w,v);this._texBottomLeft=m.i1616to32(p,x);this._texBottomRight=m.i1616to32(w,x);this._anchorX*=k/a;this._anchorY*=c/b;this._computedWidth=a*h;this._computedHeight=b*h};l._getPos=function(a,b){return m.i1616to32(Math.round(8*a),Math.round(8*b))};return y._createClass(u)}(H)});
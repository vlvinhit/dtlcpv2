// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/RandomLCG ../definitions ../enums ./WGLGeometryBrushFill ../techniques/utils ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/Renderbuffer ../../../../webgl/RenderbufferDescriptor ../../../../webgl/Texture ../../../../webgl/TextureDescriptor ../../../../webgl/VertexArrayObject".split(" "),function(n,w,B,p,x,C,t,D,k,E,F,G,H,y,I){return function(z){function q(){var a=
z.apply(this,arguments)||this;a._dotTextureSize=0;a._dotTextures=null;a._dotSamplers=new Int32Array([p.TEXTURE_BINDING_RENDERER_0,p.TEXTURE_BINDING_RENDERER_1]);a._dotVAO=null;a._dotDesc={vsPath:"dot/dot",fsPath:"dot/dot",attributes:new Map([["a_pos",0]])};return a}n._inherits(q,z);var g=q.prototype;g.dispose=function(){n._get(n._getPrototypeOf(q.prototype),"dispose",this).call(this);this._disposeTextures();this._dotFBO=w.disposeMaybe(this._dotFBO);this._dotVAO=w.disposeMaybe(this._dotVAO)};g.getGeometryType=
function(){return x.WGLGeometryType.FILL};g.supportsSymbology=function(a){return a===x.WGLSymbologyType.DOT_DENSITY};g._drawFills=function(a,c,b,d,f,e){const {passOptions:l}=a;null!=l&&"hittest"===l.type?n._get(n._getPrototypeOf(q.prototype),"_drawFills",this).call(this,a,c,b,d,f,e):(b=this._drawDotLocations(a,c,b,f,e),this._drawDotDensity(a,c,b))};g._drawDotDensity=function(a,c,b){const {context:d,painter:f,rendererInfo:e,requestRender:l,allowDelayedRender:u}=a,h=f.materialManager.getProgram(this._dotDesc);
if(u&&null!=l&&!h.compiled)l();else{var {rendererSchema:m}=e;t.assertRendererSchema(m,"dot-density");var r=this._createDotDensityMesh(d,this._dotDesc.attributes,{geometry:[{name:"a_pos",count:2,type:k.DataType.SHORT,divisor:0,normalized:!1,offset:0,stride:4}]});d.setStencilTestEnabled(!0);d.useProgram(h);h.setUniform1f("u_tileZoomFactor",1);h.setUniform1i("u_texture",this._dotSamplers[0]);h.setUniform1f("u_dotSize",Math.max(m.dotSize,1));h.setUniform1f("u_pixelRatio",window.devicePixelRatio);this._setSharedUniforms(h,
a,c);d.bindTexture(b,this._dotSamplers[0]);d.bindVAO(r);d.drawArrays(k.PrimitiveType.POINTS,0,262144)}};g._drawDotLocations=function(a,c,b,d,f){const {context:e,rendererInfo:l,requiredLevel:u}=a,h=e.getViewport();var {rendererSchema:m}=l;t.assertRendererSchema(m,"dot-density");const {dotScale:r,colors:J,activeDots:K,backgroundColor:L,dotValue:M}=m;e.setViewport(0,0,512,512);m=e.getBoundFramebufferObject();const A=this._createFBO(e);e.bindFramebuffer(A);e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT|
e.gl.STENCIL_BUFFER_BIT);e.setStencilTestEnabled(!1);c=1/2**(u-c.key.level);const v=p.TILE_SIZE,N=v*window.devicePixelRatio*v*window.devicePixelRatio,O=1/c*(1/c);a=r?a.state.scale/r:1;b.setUniform1f("u_tileZoomFactor",c);b.setUniform1f("u_tileDotsOverArea",N/(p.TILE_SIZE*window.devicePixelRatio*p.TILE_SIZE*window.devicePixelRatio));b.setUniformMatrix4fv("u_dotColors",J);b.setUniform4fv("u_isActive",K);b.setUniform4fv("u_dotBackgroundColor",L);b.setUniform1f("u_dotValue",Math.max(1,M*a*O));this._bindDotDensityTextures(e,
b,l,v);e.drawElements(k.PrimitiveType.TRIANGLES,d,k.DataType.UNSIGNED_INT,f);e.setViewport(h.x,h.y,h.width,h.height);e.bindFramebuffer(m);return A.colorTexture};g._createFBO=function(a){if(null==this._dotFBO){const c=new y.TextureDescriptor(512,512);c.samplingMode=k.TextureSamplingMode.NEAREST;c.wrapMode=k.TextureWrapMode.CLAMP_TO_EDGE;const b=new F.Renderbuffer(a,new G.RenderbufferDescriptor(k.RenderbufferFormat.DEPTH_STENCIL,512,512));this._dotFBO=new E.FramebufferObject(a,c,b)}return this._dotFBO};
g._disposeTextures=function(){if(this._dotTextures){for(let a=0;a<this._dotTextures.length;a++)this._dotTextures[a].dispose();this._dotTextures=null}};g._bindDotDensityTextures=function(a,c,b,d){({rendererSchema:b}=b);t.assertRendererSchema(b,"dot-density");d=this._createDotDensityTextures(a,d,b.seed);c.setUniform1iv("u_dotTextures",this._dotSamplers);for(c=0;c<d.length;c++)a.bindTexture(d[c],this._dotSamplers[c])};g._createDotDensityMesh=function(a,c,b){if(null==this._dotVAO){var d=new Int16Array(524288);
for(let f=0;512>f;f++)for(let e=0;512>e;e++)d[2*(e+512*f)]=e,d[2*(e+512*f)+1]=f;d=D.BufferObject.createVertex(a,k.Usage.STATIC_DRAW,d);this._dotVAO=new I.VertexArrayObject(a,c,b,{geometry:d},null)}return this._dotVAO};g._createDotDensityTextures=function(a,c,b){if(this._dotTextureSize!==c||this._seed!==b)this._disposeTextures(),this._dotTextureSize=c,this._seed=b;null===this._dotTextures&&(b=new B(b),this._dotTextures=[this._allocDotDensityTexture(a,c,b),this._allocDotDensityTexture(a,c,b)]);return this._dotTextures};
g._allocDotDensityTexture=function(a,c,b){const d=new Float32Array(c*c*4);for(let f=0;f<d.length;f++)d[f]=b.getFloat();b=new y.TextureDescriptor;b.dataType=k.PixelType.FLOAT;b.samplingMode=k.TextureSamplingMode.NEAREST;b.width=c;b.height=c;return new H.Texture(a,b,d)};return n._createClass(q)}(C)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/CircularArray ../../../../core/has ../../../../chunks/mat2df32 ./enums ./Utils ./WGLTile ./collisions/MetricReader ./cpuMapped/Geometry".split(" "),function(m,k,n,f,r,t,p,l,u,v){let w=0;l=function(q){function g(a,b,c,e,h,x){a=q.call(this,a,b,c,e)||this;a.instanceId=w++;a.patchCount=0;a._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1};a._patches=new n(100);a._bufferPatches=new n(100);
a._lastCommitTime=0;a.transforms.labelMat2d=r.create();a._store=h;a._requestLabelUpdate=x;return a}k._inherits(g,q);var d=g.prototype;d.destroy=function(){k._get(k._getPrototypeOf(g.prototype),"destroy",this).call(this);this._renderState.current.geometry.forEach(a=>a.destroy());null!=this._renderState.next&&this._renderState.next.geometry.forEach(a=>a.destroy());this._renderState.current=null;this._renderState.next=null};d.getGeometry=function(a){return this._renderState.current.geometry.get(a)};
d.patch=function(a,b){this.patchCount++;a.clear&&50<=this._patches.size&&this._dropPatches();const c=a.addOrUpdate&&this.key.id!==a.addOrUpdate.tileKeyOrigin;b&&c?this._bufferPatches.enqueue(a):(a.sort=a.sort&&!b,this._patches.enqueue(a));this.requestRender()};d.commit=function(a){if(this._lastCommitTime!==a.time){this._lastCommitTime=a.time;for(a=0;4>a;a++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}};d.lock=function(){this._renderState.locked=
!0};d.unlock=function(){this._renderState.locked=!1;this._flushUpdates();this._swap()};d._swapRenderStates=function(){this._renderState.next&&(this._renderState.locked?(this._renderState.swap=!0,this.requestRender()):(this._renderState.swap=!0,this._swap()))};d._swap=function(){this._renderState.swap&&(this._renderState.swap=!1,null!=this._renderState.next&&(this._renderState.current.geometry.forEach(a=>a.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))};
d._flushUpdates=function(){let a=this._patches.maxSize;for(;this._patches.size&&a--;)this._updateMesh(),this._swap()};d._updateBufferMesh=function(){var a=this._bufferPatches.peek();if(null==a||!a.clear||null===this._renderState.next)for(;this._bufferPatches.size;)a=this._bufferPatches.dequeue(),null!=a&&this._patchBuffer(a)};d._updateMesh=function(){const a=this._patches.dequeue();if(null!=a){if(f("esri-2d-update-debug")){var b=a.addOrUpdate?.tileKeyOrigin;b=this.key.id===b?"SELF":b;let c="";for(let e=
0;5>e;e++)c+=a.addOrUpdate?.data[e]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${a.clear} origin: ${b}, end:${a.end} data:${c}]`)}!0===a.clear&&(null!=this._renderState.next&&(this._renderState.next.geometry.forEach(c=>c.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},f("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState"));this.requestRender();this._patch(a);a.end&&
(f("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}};d._patch=function(a){p.forEachGeometryType(b=>{this._remove(b,a.remove);this._insert(b,a,!1)})};d._patchBuffer=function(a){p.forEachGeometryType(b=>{this._insert(b,a,!0)})};d._insert=function(a,b,c){try{const e=b.addOrUpdate?.data[a],h=(this._renderState.next??this._renderState.current).geometry;null!=e&&(h.has(a)||(f("esri-2d-update-debug")&&console.debug(this.key.id,
`FeatureTile:_insert - Creating geometry buffer ${a}`),h.set(a,new v.Geometry(a,this.stage))),f("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${a}, version=${b.addOrUpdate?.version} stride=${e.stride}`),h.get(a).insert(e,b.sort,c),a===t.WGLGeometryType.LABEL&&this._insertLabelMetrics(b.type,e.metrics,b.clear))}catch(e){}};d._insertLabelMetrics=function(a,b,c){c=this._renderState.next??this._renderState.current;if(null!=b)if(b=u.MetricReader.from(b),null==
c.metrics)c.metrics=b;else{if("update"===a)for(a=b.getCursor();a.next();)c.metrics.delete(a.id);c.metrics.link(b)}};d._remove=function(a,b){a=(this._renderState.next??this._renderState.current).geometry.get(a);b&&b.length&&a&&(a.remove(b),this._removeLabelMetrics(b))};d._removeLabelMetrics=function(a){const {metrics:b}=this._renderState.next??this._renderState.current;if(null!=b&&a.length)for(const c of a)for(;b.delete(c););};d._dropPatches=function(){const a=[];let b=!1;for(;this._patches.size;){const c=
this._patches.dequeue();if(null==c)break;if(c.clear){if(b)break;b=!0}a.push(c)}this._patches.clear();a.forEach(c=>this._patches.enqueue(c))};k._createClass(g,[{key:"labelMetrics",get:function(){return this._renderState.current.metrics}},{key:"hasData",get:function(){return!!this._renderState.current.geometry.size}},{key:"updateStatus",get:function(){return`renderState:${!!this._renderState.current}, ${!!this._renderState.next}, hasData:${this.hasData}, queue:${this._patches.size}`}}]);return g}(l.WGLTile);
m.FeatureTile=l;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/arrayUtils ../../../../../core/Error ../../../../../core/Logger ../../../../../core/LRUCache ../../../../../support/arcadeOnDemand ../../../arcade/callExpressionWithFeature ../../../layers/support/cimSymbolUtils".split(" "),function(A,r,p,F,G,H,I,J,K,q){async function B(h,f,e,a){switch(h.type){case "simple":case "heatmap":return u.fromBasicRenderer(h,f,e,a);case "map":return C.fromUVRenderer(h,f,e,a);case "interval":return D.fromCBRenderer(h,
f,e,a);case "dictionary":return E.fromDictionaryRenderer(h,f,e,a);case "pie-chart":return w.fromPieChartRenderer(h,f,e,a);case "subtype":return w.fromSubtypes(h,f,e,a)}}async function L(h,f){const e=h||1;if("number"===typeof e)return(b,d,c)=>e;const a=await J.createRendererExpression(e,f.spatialReference,f.fields);return(b,d,c)=>K(a,b,{$view:c},f.geometryType,d)||1}async function M(){x||(x=new Promise((h,f)=>A(["../../../layers/features/createSymbolSchema"],h,f)));return x}const y=H.getLogger("esri/views/2d/engine/webgl/util/Matcher");
let u=function(){function h(){this.type="feature";this._defaultResult=null}h.fromBasicRenderer=async function(e,a,b,d){const c=new h;e.symbol&&(e=await q.expandSymbol(e.symbol,b,d),a=a.createTemplateGroup(e,null),c.setDefault(a));return c};h.fromPieChartRenderer=async function(e,a,b,d){const c=new h;if(e.markerSymbol){const g=await q.expandSymbol(e.markerSymbol,b,d);let l;e.fillSymbol&&(l=await q.expandSymbol(e.fillSymbol,b,d));e=a.createTemplateGroup(g,l);c.setDefault(e)}return c};var f=h.prototype;
f.size=function(){return 1};f.getDefault=function(){return this._defaultResult};f.setDefault=function(e){this._defaultResult=e};f.match=function(e,a,b,d,c){return this.getDefault()};f.analyze=async function(e,a,b,d,c,g){return null};return p._createClass(h)}(),w=function(h){function f(e,a){var b=h.call(this)||this;b._subMatchers=e;b._subtypeField=a;return b}p._inherits(f,h);f.fromSubtypes=async function(e,a,b,d){const c=new Map,g=[];for(const l in e.renderers){const k=parseInt(l,10),m=B(e.renderers[l],
a,b,d).then(n=>c.set(k,n));g.push(m)}await Promise.all(g);return new f(c,e.subtypeField)};f.prototype.match=function(e,a,b,d,c){var g=a.readAttribute(this._subtypeField);return(g=this._subMatchers.get(g))?g.match(e,a,b,d,c):null};return p._createClass(f)}(u),D=function(h){function f(a,b,d,c){var g=h.call(this)||this;g.type="interval";g._intervals=[];g._isMaxInclusive=b;g._fieldIndex=c;g._field=a;g._normalizationInfo=d;return g}p._inherits(f,h);f.fromCBRenderer=async function(a,b,d,c){const {isMaxInclusive:g,
normalizationField:l,normalizationTotal:k,normalizationType:m}=a,n=new f(a.field,g,{normalizationField:l,normalizationTotal:k,normalizationType:m},a.fieldIndex),t=await q.expandSymbol(a.backgroundFillSymbol,d,c);await Promise.all(a.intervals.map(async v=>{var z=await q.expandSymbol(v.symbol,d,c);z=await b.createTemplateGroup(z,t);n.add({min:v.min,max:v.max},z)}));if(a=await q.expandSymbol(a.defaultSymbol,d,c))a=await b.createTemplateGroup(a,t),n.setDefault(a);return n};var e=f.prototype;e.add=function(a,
b){this._intervals.push({interval:a,result:b});this._intervals.sort((d,c)=>d.interval.min-c.interval.min)};e.size=function(){return p._get(p._getPrototypeOf(f.prototype),"size",this).call(this)+this._intervals.length};e.match=function(a,b,d,c,g){if(null==this._fieldIndex&&!this._field)return this.getDefault();a=null!=this._fieldIndex?b.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(b);if(null===a||void 0===a||isNaN(a)||Infinity===a||-Infinity===a)return this.getDefault();for(b=
0;b<this._intervals.length;b++){const {interval:l,result:k}=this._intervals[b];d=this._isMaxInclusive?a<=l.max:a<l.max;if(a>=l.min&&d)return k}return this.getDefault()};e._needsNormalization=function(){const a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};e._getValueFromField=function(a){const b=a.readAttribute(this._field);if(!this._needsNormalization()||null==b)return b;const {normalizationField:d,normalizationTotal:c,normalizationType:g}=this._normalizationInfo;
a=a.readAttribute(d)??1;if(g)switch(g){case "esriNormalizeByField":return(a||void 0)&&b/a;case "esriNormalizeByLog":return Math.log(b)*Math.LOG10E;case "esriNormalizeByPercentOfTotal":return b/c*100;default:y.error(`Found unknown normalization type: ${g}`)}else y.error("Normalization is required, but no type was set!")};return p._createClass(f)}(u),C=function(h){function f(a,b,d){var c=h.call(this)||this;c.type="map";c._nullResult=null;c._resultsMap=new Map;c._fields=[];c._fieldsIndex=d;c._fields=
a;c._seperator=b||"";return c}p._inherits(f,h);f.fromUVRenderer=async function(a,b,d,c){const g=a.fieldDelimiter,l=[a.field];a.field2&&l.push(a.field2);a.field3&&l.push(a.field3);const k=await q.expandSymbol(a.backgroundFillSymbol,d,c),m=new f(l,g,a.fieldIndex);await Promise.all(a.map.map(async(n,t)=>{const v=await q.expandSymbol(n.symbol,d,c);t=await b.createTemplateGroup(v,k,t+1);"\x3cNull\x3e"===n.value?m.setNullResult(t):m.add(n.value,t)}));if(a=await q.expandSymbol(a.defaultSymbol,d,c))a=await b.createTemplateGroup(a,
k,Number.MAX_SAFE_INTEGER),m.setDefault(a);return m};var e=f.prototype;e.setNullResult=function(a){this._nullResult=a};e.add=function(a,b){this._resultsMap.set(a.toString(),b)};e.size=function(){return p._get(p._getPrototypeOf(f.prototype),"size",this).call(this)+this._resultsMap.size};e.match=function(a,b,d,c,g){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();a=null!=this._fieldsIndex?b.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(b);if(null!==this._nullResult&&
(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};e._getValueFromFields=function(a){const b=[];for(const d of this._fields){const c=a.readAttribute(d);null==c||""===c?b.push("\x3cNull\x3e"):b.push(c)}return b.join(this._seperator)};return p._createClass(f)}(u),x,E=function(h){function f(a,b,d,c,g,l){var k=h.call(this)||this;k.type="dictionary";k._groupIdCache=new I.LRUCache(100);
k._loader=a;k._fieldMap=a.fieldMap;k._symbolFields=a.getSymbolFields();k._templates=b;k._info=d;k._scaleFn=c;k._schemaUtilsModule=g;k._symbolOptions=l;return k}p._inherits(f,h);f.fromDictionaryRenderer=async function(a,b,d,c){const [{DictionaryLoader:g},l]=await Promise.all([new Promise((m,n)=>A(["../../../../../renderers/support/DictionaryLoader"],m,n)),M()]);c=new g(a.url,a.config,a.fieldMap);await c.fetchResources({spatialReference:d.spatialReference,fields:d.fields});const k=await L(a.scaleExpression,
d);return new f(c,b,d,k,l,a.symbolOptions)};var e=f.prototype;e._analyzeFeature=async function(a,b,d,c,g){a=a.readLegacyFeature();const l=this._scaleFn(a,d,c);d=this._attributeHash(a)+"-"+l;const k=this._groupIdCache.get(d);if(k)return k;c=await this._loader.getSymbolAsync(a,{...c,spatialReference:this._info.spatialReference,abortOptions:g,fields:this._info.fields});c=this._schemaUtilsModule.createSymbolSchema(c,this._symbolOptions);b=q.expandSymbol(c,this._info,b,g).then(m=>{if("expanded-cim"!==
m?.type)return y.error(new G("mapview-bad-type",`Found unexpected type ${m?.type} in dictionary response`)),null;m.hash+="-"+l;for(const n of m.layers)n.scaleFactor=l,n.templateHash+="-"+l;return this._templates.createTemplateGroup(m,null)});this._groupIdCache.put(d,b,1);return b};e.analyze=async function(a,b,d,c,g,l){a=b.getCursor();for(b=[];a.next();)b.push(this._analyzeFeature(a,d,c,g,l));return Promise.all(b).then(k=>k.filter(F.isSome))};e.match=function(a,b,d,c,g){return null};e._attributeHash=
function(a){let b="";for(const d of this._symbolFields){const c=this._fieldMap?.[d];c&&(b+=a.attributes[c]+"-")}return b};return p._createClass(f)}(u);r.DictionaryMatcher=E;r.FeatureMatcher=u;r.IntervalMatcher=D;r.MapMatcher=C;r.SubtypeMatcher=w;r.createMatcher=B;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
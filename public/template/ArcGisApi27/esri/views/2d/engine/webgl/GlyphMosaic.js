// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/promiseUtils ./Rect ./RectangleBinPack ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(r,t,u,n,p,q,v,w){function x(h){const e=new Set;for(const a of h)e.add(Math.floor(a/256));return e}function y(h,e,a){h.has(e)||h.set(e,a().then(()=>{h.delete(e)}).catch(b=>{h.delete(e);u.throwIfNotAbortError(b)}));return h.get(e)}return function(){function h(a,b,c){this.height=
this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphCache={};this._textures=[];this._rangePromises=new Map;this._preloadCache={};this.width=a;this.height=b;this._glyphSource=c;this._binPack=new p(a-4,b-4);this._glyphData.push(new Uint8Array(a*b));this._dirties.push(!0);this._textures.push(null);this._initDecorationGlyphs()}var e=h.prototype;e.dispose=function(){this._binPack=null;for(const a of this._textures)a&&a.dispose();this._textures.length=0;this._glyphData.length=
0};e._initDecorationGlyphs=function(){var a=[117,149,181,207,207,181,149,117];const b=[];var c=[];for(let d=0;d<a.length;d++){const f=a[d];for(let g=0;11>g;g++){const k=3<=d&&5>d&&3<=g&&8>g?255:0;b.push(f);c.push(k)}}a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(b)};c={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(c)};this._recordGlyph(a);this._recordGlyph(c)};e.getGlyphItems=async function(a,b,c){const d=this._getGlyphCache(a);await this._fetchRanges(a,
b,c);return b.map(f=>this._getMosaicItem(d,a,f))};e.bind=function(a,b,c,d){const f=this._getTexture(a,c);f.setSamplingMode(b);this._dirties[c]&&(f.setData(this._glyphData[c]),this._dirties[c]=!1);a.bindTexture(f,d)};e.preloadASCIIGlyphCache=function(a){var b=this._preloadCache[a];if(null!=b)return b;b=this._glyphSource.preloadASCIIRange(a).then(()=>{const c=this._getGlyphCache(a);for(let d=0;256>d;d++)this._getMosaicItem(c,a,d)});return this._preloadCache[a]=b};e._getGlyphCache=function(a){this._glyphCache[a]||
(this._glyphCache[a]={});return this._glyphCache[a]};e._getTexture=function(a,b){if(!this._textures[b]){const c=new w.TextureDescriptor;c.pixelFormat=q.PixelFormat.ALPHA;c.wrapMode=q.TextureWrapMode.CLAMP_TO_EDGE;c.width=this.width;c.height=this.height;this._textures[b]=new v.Texture(a,c,new Uint8Array(this.width*this.height))}return this._textures[b]};e._invalidate=function(){this._dirties[this._currentPage]=!0};e._fetchRanges=async function(a,b,c){const d=[];x(b).forEach(f=>{d.push(this._fetchRange(a,
f,c))});await Promise.all(d)};e._fetchRange=async function(a,b,c){if(!(256<b))return y(this._rangePromises,a+b,()=>this._glyphSource.getRange(a,b,c))};e._getMosaicItem=function(a,b,c){if(!a[c]){b=this._glyphSource.getGlyph(b,c);if(!b||!b.metrics)return{rect:new n(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:c,sdf:!0};const d=this._recordGlyph(b);a[c]={rect:d,page:this._currentPage,metrics:b.metrics,code:c,sdf:!0};this._invalidate()}return a[c]};e._recordGlyph=function(a){var b=
a.metrics;if(0===b.width)b=new n(0,0,0,0);else{const c=b.width+6,d=b.height+6;b=this._binPack.allocate(c,d);b.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new p(this.width-4,this.height-4),b=this._binPack.allocate(c,d));const f=this._glyphData[this._currentPage];a=a.bitmap;
let g,k;if(a)for(let l=0;l<d;l++){g=c*l;k=this.width*(b.y+l)+b.x;for(let m=0;m<c;m++)f[k+m]=a[g+m]}t("esri-glyph-debug")&&this._showDebugPage(f)}return b};e._showDebugPage=function(a){const b=document.createElement("canvas"),c=b.getContext("2d"),d=new ImageData(this.width,this.height),f=d.data;b.width=this.width;b.height=this.height;b.style.border="1px solid black";for(let g=0;g<a.length;++g)f[4*g]=a[g],f[4*g+1]=0,f[4*g+2]=0,f[4*g+3]=255;c.putImageData(d,0,0);document.body.appendChild(b)};return r._createClass(h)}()});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/arrayUtils","../enums","../../../../webgl/enums"],function(v,w,k,x){return function(){function u(a,b){this.brushes=a;this.name=b.name;this.drawPhase=b.drawPhase||k.WGLDrawPhase.MAP;this._targetFn=b.target;this.effects=b.effects||[];this.enableDefaultDraw=b.enableDefaultDraw??(()=>!0);this.forceDrawByDisplayOrder=!!b.forceDrawByDisplayOrder}var r=u.prototype;r.render=function(a){const {context:b,profiler:d}=a,f=this._targetFn();
var h=this.drawPhase&a.drawPhase;d.recordPassStart(this.name);if(h){this.enableDefaultDraw()&&this._doRender(a,f);d.recordPassEnd();for(const e of this.effects){if(!e.enable())continue;h=e.apply;const c=e.args&&e.args(),g=b.getViewport(),m=b.getBoundFramebufferObject(),n=a.passOptions;this._bindEffect(a,h,c);this._doRender(a,f,h.defines);this._drawAndUnbindEffect(a,h,g,m,n,c)}}};r._doRender=function(a,b,d){if(null!=b){var {profiler:f,context:h}=a;if(this.forceDrawByDisplayOrder){for(var e of this.brushes){f.recordBrushStart(e.name);
if(null!=e.brushEffect){var c=h.getViewport(),g=h.getBoundFramebufferObject(),m=a.passOptions;this._bindEffect(a,e.brushEffect);this._drawWithBrush(e,a,b,d);this._drawAndUnbindEffect(a,e.brushEffect,c,g,m)}else this._drawWithBrush(e,a,b,d);f.recordBrushEnd()}a.attributeView.bindTextures(a.context);for(const l of b)if(l.visible)if(l.commit(a),a.context.setStencilFunction(x.CompareFunction.EQUAL,l.stencilRef,255),c=l.getGeometry(k.WGLGeometryType.MARKER),b=l.getGeometry(k.WGLGeometryType.TEXT),null!=
c&&c.records&&null!=b&&b.records){e=new Map;for(g=c.records.getCursor();g.next();)e.set(g.id,[g.getDrawInfo(c,k.WGLGeometryType.MARKER)]);for(c=b.records.getCursor();c.next();)g=e.get(c.id),m=c.getDrawInfo(b,k.WGLGeometryType.TEXT),g?g.push(m):e.set(c.id,[m]);b=Array.from(e.entries()).sort(([p],[t])=>t-p);for(var [,n]of b)for(var q of n)b=a.painter.getBrush(q.geometryType,k.WGLSymbologyType.DEFAULT),b.prepareState(a,d),b.drawGeometry(a,l,q,d)}else if(c){const p=a.painter.getBrush(k.WGLGeometryType.MARKER,
k.WGLSymbologyType.DEFAULT);p.prepareState(a,d);c.forEachCommand(t=>{p.drawGeometry(a,l,t,d)})}else if(b){const p=a.painter.getBrush(k.WGLGeometryType.TEXT,k.WGLSymbologyType.DEFAULT);p.prepareState(a,d);b.forEachCommand(t=>{p.drawGeometry(a,l,t,d)})}}else for(c of this.brushes)f.recordBrushStart(c.name),null!=c.brushEffect?(n=h.getViewport(),q=h.getBoundFramebufferObject(),e=a.passOptions,this._bindEffect(a,c.brushEffect),this._drawWithBrush(c,a,b,d),this._drawAndUnbindEffect(a,c.brushEffect,n,q,
e)):this._drawWithBrush(c,a,b,d),f.recordBrushEnd()}};r._drawWithBrush=function(a,b,d,f){w.isArrayLike(d)?(a.prepareState(b,f),a.drawMany(b,d,f)):d.visible&&(a.prepareState(b,f),a.draw(b,d,f))};r._bindEffect=function(a,b,d){const {profiler:f}=a;f.recordPassStart(this.name+"."+b.name);b.bind(a,d);b=b.createOptions(a,d);a.passOptions=b};r._drawAndUnbindEffect=function(a,b,d,f,h,e){const {profiler:c,context:g}=a;a.passOptions=h;c.recordBrushStart(b.name);b.draw(a,e);b.unbind(a,e);g.bindFramebuffer(f);
const {x:m,y:n,width:q,height:l}=d;g.setViewport(m,n,q,l);c.recordBrushEnd();c.recordPassEnd()};return v._createClass(u)}()});
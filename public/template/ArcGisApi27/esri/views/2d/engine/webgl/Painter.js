// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./TextureUploadManager ./WorldExtentClipRenderer ./effects/AnimationEffect ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/HittestEffectVTL ./effects/post-processing/EffectManager ./painter/RenderPass ../../../webgl/contextUtils ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer ../../../webgl/RenderbufferDescriptor ../../../webgl/TextureDescriptor".split(" "),
function(w,t,l,x,y,h,z,A,B,C,D,E,u,F,G,H,I,J,K,g,r,L,M,v){function N(q,f){switch(q){case h.WGLGeometryType.LINE:return l.brushes.line;case h.WGLGeometryType.TEXT:return l.brushes.text;case h.WGLGeometryType.LABEL:return l.brushes.label;case h.WGLGeometryType.FILL:switch(f){case h.WGLSymbologyType.DOT_DENSITY:return l.brushes.dotDensity;default:return l.brushes.fill}case h.WGLGeometryType.MARKER:switch(f){case h.WGLSymbologyType.HEATMAP:return l.brushes.heatmap;case h.WGLSymbologyType.PIE_CHART:return l.brushes.pieChart;
default:return l.brushes.marker}}}return function(){function q(a,c,b){this.context=a;this._blitRenderer=new y.BitBlitRenderer;this._worldExtentClipRenderer=new C.WorldExtentClipRenderer;this._isClippedToWorldExtent=!1;this._brushCache=new Map;this._prevFBO=this._lastHeight=this._lastWidth=null;this._vtlMaterialManager=new x;this._blendEffect=new E.BlendEffect;this._fbos=this._stencilBuf=null;this._fboPool=[];this._renderTarget=null;this.effects={highlight:new F,hittest:new G.HittestEffect,hittestVTL:new H.HittestEffectVTL,
integrate:new D.AnimationEffect,insideEffect:new u.FeatureEffect("inside"),outsideEffect:new u.FeatureEffect("outside")};this.materialManager=new z(a);this.textureManager=new A(c,b,a.type===K.ContextType.WEBGL2);this.textureUploadManager=new B.TextureUploadManager(a,c);this._effectsManager=new I.EffectManager}var f=q.prototype;f.getRenderTarget=function(){return this._renderTarget};f.setRenderTarget=function(a){this._renderTarget=a};f.getFbos=function(a,c){if(a!==this._lastWidth||c!==this._lastHeight){this._lastWidth=
a;this._lastHeight=c;if(this._fbos){for(var b in this._fbos)this._fbos[b].resize(a,c);return this._fbos}b=new v.TextureDescriptor(a,c);b.samplingMode=g.TextureSamplingMode.NEAREST;b.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE;a=new M.RenderbufferDescriptor(g.RenderbufferFormat.DEPTH_STENCIL,a,c);this._stencilBuf=new L.Renderbuffer(this.context,a);this._fbos={output:new r.FramebufferObject(this.context,b,this._stencilBuf),blend:new r.FramebufferObject(this.context,b,this._stencilBuf),effect0:new r.FramebufferObject(this.context,
b,this._stencilBuf)}}return this._fbos};f.acquireFbo=function(a,c){if(0<this._fboPool.length)var b=this._fboPool.pop();else b=new v.TextureDescriptor(a,c),b.samplingMode=g.TextureSamplingMode.NEAREST,b.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE,b=new r.FramebufferObject(this.context,b,this._stencilBuf);b.width===a&&b.height===c||b.resize(a,c);return b};f.releaseFbo=function(a){this._fboPool.push(a)};f.getSharedStencilBuffer=function(){return this._stencilBuf};f.beforeRenderLayers=function(a,c=null){const {width:b,
height:d}=a.getViewport();this._prevFBO=a.getBoundFramebufferObject();const e=this.getFbos(b,d);a.bindFramebuffer(e?.output);a.setColorMask(!0,!0,!0,!0);if(null!=c){const {r:m,g:n,b:k,a:p}=c;a.setClearColor(p*m/255,p*n/255,p*k/255,p)}else a.setClearColor(0,0,0,0);a.setDepthWriteEnabled(!0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};f.beforeRenderLayer=function(a,c,b){const {context:d,blendMode:e,effects:m,requireFBO:n,drawPhase:k}=a;n||k!==
h.WGLDrawPhase.HIGHLIGHT&&(1!==b||null!=e&&"normal"!==e||null!=m&&0<m.length)?(d.bindFramebuffer(this._fbos?.blend),d.setColorMask(!0,!0,!0,!0),d.setClearColor(0,0,0,0),d.setDepthWriteEnabled(!0),d.setClearDepth(1),d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.DEPTH_BUFFER_BIT),d.setDepthWriteEnabled(!1)):(a=this._getOutputFBO(),d.bindFramebuffer(a));d.setDepthWriteEnabled(!1);d.setDepthTestEnabled(!1);d.setStencilTestEnabled(!0);d.setClearStencil(c);d.setStencilWriteMask(255);d.clear(d.gl.STENCIL_BUFFER_BIT)};
f.compositeLayer=function(a,c){const {context:b,blendMode:d,effects:e,requireFBO:m,drawPhase:n}=a;if(m||n!==h.WGLDrawPhase.HIGHLIGHT&&(1!==c||null!=d&&"normal"!==d||null!=e&&0<e.length)){null!=e&&0<e.length&&n===h.WGLDrawPhase.MAP&&this._applyEffects(a,e);var k=this._getOutputFBO();b.bindFramebuffer(k);b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA,g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA);
b.setColorMask(!0,!0,!0,!0);k=null==d||n===h.WGLDrawPhase.HIGHLIGHT?"normal":d;const p=this._fbos;p?.blend.colorTexture&&this._blendEffect.draw(a,p.blend.colorTexture,g.TextureSamplingMode.NEAREST,k,c)}};f.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);const c=this._getOutputFBO();c&&(a.setDepthTestEnabled(!1),a.setStencilWriteMask(0),this._isClippedToWorldExtent?(a.setStencilTestEnabled(!0),a.setStencilFunction(g.CompareFunction.EQUAL,1,255)):a.setStencilTestEnabled(!1),this.blitTexture(a,
c.colorTexture,g.TextureSamplingMode.NEAREST))};f.prepareDisplay=function(a,c,b){const {context:d}=a;d.bindFramebuffer(this._prevFBO);d.setColorMask(!0,!0,!0,!0);if(null!=c){const {r:e,g:m,b:n,a:k}=c;d.setClearColor(k*e/255,k*m/255,k*n/255,k)}else d.setClearColor(0,0,0,0);d.setStencilWriteMask(255);d.setClearStencil(0);d.clear(d.gl.COLOR_BUFFER_BIT|d.gl.STENCIL_BUFFER_BIT);this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(a,b)};f.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();
this.textureUploadManager.destroy();this._blitRenderer=t.disposeMaybe(this._blitRenderer);this._worldExtentClipRenderer=t.disposeMaybe(this._worldExtentClipRenderer);this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=null);if(this._fbos){let a;for(a in this._fbos)this._fbos[a]&&this._fbos[a].dispose()}for(const a of this._fboPool)a.dispose();this._fboPool.length=0;if(this.effects){let a;for(a in this.effects)this.effects[a]&&this.effects[a].dispose()}this._effectsManager.dispose();
this._vtlMaterialManager=t.disposeMaybe(this._vtlMaterialManager);this._prevFBO=null};f.getBrush=function(a,c){a=N(a,c);c=this._brushCache.get(a);void 0===c&&(c=new a,this._brushCache.set(a,c));return c};f.renderObject=function(a,c,b,d){if(b=l.brushes[b]){var e=this._brushCache.get(b);void 0===e&&(e=new b,this._brushCache.set(b,e));e.prepareState(a,d);e.draw(a,c,d)}};f.renderObjects=function(a,c,b,d){if(b=l.brushes[b]){var e=this._brushCache.get(b);void 0===e&&(e=new b,this._brushCache.set(b,e));
e.drawMany(a,c,d)}};f.registerRenderPass=function(a){const c=a.brushes.map(b=>{this._brushCache.has(b)||this._brushCache.set(b,new b);return this._brushCache.get(b)});return new J(c,a)};f.blitTexture=function(a,c,b,d=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA,g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,c,b,d)};f.getPostProcessingEffects=function(a){return this._effectsManager.getPostProcessingEffects(a)};
f._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos?.output??null};f._applyEffects=function(a,c){const b=this._fbos?.blend;if(b){var {context:d}=a;c=this._effectsManager.getPostProcessingEffects(c);for(const {postProcessingEffect:e,effect:m}of c)d.bindFramebuffer(b),e.draw(a,b,m)}};w._createClass(q,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}}]);return q}()});
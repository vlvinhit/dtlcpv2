// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ./DirtyMap ./DisplayRecordStore ./WGLBuffers ./WGLTile".split(" "),function(w,t,x,y,B,u){u=function(z){function q(){var a=z.apply(this,arguments)||this;a._data=null;a._displayList=null;a._lastCommitTime=0;a._hasData=!1;a._invalidated=!1;a._wglBuffers=null;a._dirtyMap=new x;return a}t._inherits(q,z);var m=q.prototype;m.destroy=function(){t._get(t._getPrototypeOf(q.prototype),"destroy",this).call(this);this.clear()};m.getGeometry=function(a){return this._wglBuffers&&
this._wglBuffers.has(a)?this._wglBuffers.get(a):null};m.getDisplayList=function(){return this._displayList};m.patch=function(a){if(!0===a.clear)this.clear(),this._hasData=!1;else{var k=a.addOrUpdate,b=a.remove;!this._data&&k&&k.tileDisplayData?.displayObjects.length?(k.tileDisplayData.computeDisplayList(),this._dirtyMap=new x,this._dispRecStore=y.fromTileData(k,this._dirtyMap),this._data=k,this._dirtyMap.markAllDirty(),this._hasData=!0,a.end&&this.ready()):this._data?k&&k.tileDisplayData?.displayObjects.length||
b.length?this._doPatchData(a):a.end&&this.ready():a.end&&this.ready();a.end&&!this._data&&this.clear();this.requestRender();this.emit("change")}};m.commit=function(a){if(!a.time||a.time!==this._lastCommitTime)if(this._lastCommitTime=a.time,this.visible&&this._data&&(this._wglBuffers||(this._wglBuffers=new B(a.context)),this._dirtyMap.hasDirty()||this._invalidated))this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),
this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._dirtyMap.markAllClean()};m.clear=function(){this._dispRecStore=this._displayList=this._data=null;this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)};m._doPatchData=function(a){this._invalidated=!0;this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=y.fromTileData(this._data,this._dirtyMap));this.requestRender()};m._patchData=function(a){let k=!0;var b=a.addOrUpdate&&
a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[],d=(a.remove||[]).slice();for(var g of b)null!=g.insertAfter&&d.push(g.id);let v;0<d.length&&(v=new Set(d));g=this._data.tileDisplayData;for(var e of d)if(d=g.displayObjectRegistry.get(e)){g.displayList.removeFromList(d.displayRecords);for(var f of d.displayRecords)this._dispRecStore.delete(f);g.displayObjectRegistry.delete(e)}v?.size&&(g.displayObjects=g.displayObjects.filter(h=>!v.has(h.id)));for(const h of b){b=g.displayObjectRegistry.get(h.id);
let l;if(b){e=b.displayRecords;b.set(h);b.displayRecords=e;e=b.displayRecords.length;for(f=0;f<e;++f){d=b.displayRecords[f];var c=h.displayRecords[f];if(f>=h.displayRecords.length||d.geometryType!==c.geometryType||d.symbolLevel!==c.symbolLevel||d.zOrder!==c.zOrder||d.materialKey!==c.materialKey)this._dispRecStore.delete(b.displayRecords[f]),f<h.displayRecords.length&&(b.displayRecords[f]=void 0)}b.displayRecords.length=h.displayRecords.length}else if(b=h.copy(),b.displayRecords=[],g.displayObjectRegistry.set(h.id,
b),e=g.displayObjects,null!=b.insertAfter?(l={},0<=b.insertAfter?(f=g.displayObjectRegistry.get(b.insertAfter))?(c=e.indexOf(f)+1,c<e.length?e.splice(c,0,b):(e.push(b),c=e.length)):(e.push(b),c=e.length):(e.unshift(b),c=0)):(e.push(b),c=e.length),l)for(f=0<h.displayRecords.length?1:0,d=0,--c;0<=c&&d<f;--c)for(var n=e[c].displayRecords.length-1;0<=n&&d<f;--n){var r=e[c].displayRecords[n],p=g.displayList.getDPInfoType();l[p]||(l[p]=r,++d)}e=h.displayRecords.length;for(f=0;f<e;++f){d=h.displayRecords[f];
(c=b.displayRecords[f])?(c.meshData=d.meshData,c.materialKey=d.materialKey):(c=d.copy(),c.vertexFrom=void 0,c.indexFrom=void 0,b.displayRecords[f]=c);r=d.geometryType;n=g.displayList.getDPInfoType();p=a.addOrUpdate.tileBufferData.geometries[r];r=p.vertexBuffer;p=p.indexBuffer;let A=void 0;l&&(A=l[n]?g.displayList.splitAfter(l[n]):-1);k=this._dispRecStore.setMeshData(c,d,r,p,A)&&k;l&&null!=c.indexFrom&&null!=c.indexFrom&&(l[n]=c)}}return k};t._createClass(q,[{key:"hasData",get:function(){return!!this._hasData}},
{key:"displayObjects",get:function(){return this._displayObjects??[]}}]);return q}(u.WGLTile);w.GraphicTile=u;Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
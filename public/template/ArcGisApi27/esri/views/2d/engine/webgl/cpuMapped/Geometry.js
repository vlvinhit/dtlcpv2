// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../FeatureDisplayList ./Buffer ./DisplayRecordReader ../../../../webgl/VertexArrayObject".split(" "),function(u,x,r,y,v,w,z){let A=function(){function t(a,c){this._vaos=new Map;this._indicesInvalid=!1;this.geometryType=a;this._stage=c}var l=t.prototype;l.destroy=function(){for(const [,a]of this._vaos)a?.disposeVAOOnly();this._indexBuffer=r.destroyMaybe(this._indexBuffer);this._vertexBuffer=r.destroyMaybe(this._vertexBuffer)};
l.insert=function(a,c,e){if(a.records.byteLength)if(e=a.stride,this._vertexBuffer&&this._indexBuffer){var d=a.vertices.byteLength/e;this._indexBuffer.ensure(a.indices.byteLength/4);this._vertexBuffer.ensure(d);const {vertices:f,indices:b}=a;a=w.DisplayRecordReader.from(a.records);const h=this._vertexBuffer.insert(f,0,f.byteLength/e,0),k=this._indexBuffer.insert(b,0,b.byteLength/4,h);a.forEach(g=>{g.indexFrom+=k;g.vertexFrom+=h});r.unwrapOrThrow(this._records,"Expected records to be defined").link(a);
if(c)this._indicesInvalid=!0;else if(this._displayList)for(c=a.getCursor();c.next();)this._displayList.addRecord(c)}else{d=a.indices.byteLength/4;const f=a.vertices.byteLength/e,b=e/Uint32Array.BYTES_PER_ELEMENT,h=this._stage.bufferPool;this._records=w.DisplayRecordReader.from(a.records);this._indexBuffer=new v.Buffer("index",d,1,h);this._vertexBuffer=new v.Buffer("vertex",f,b,h);this._indexBuffer.insert(a.indices,0,a.indices.byteLength/4,0);this._vertexBuffer.insert(a.vertices,0,a.vertices.byteLength/
e,0);c&&(this._indicesInvalid=!0)}};l.remove=function(a){if(null!=this._records)for(const c of a){a=this._records.getCursor();if(!a.lookup(c))continue;const e=a.indexFrom,d=a.vertexFrom;let f=a.indexCount,b=a.vertexCount;for(;a.next()&&a.id===c;)f+=a.indexCount,b+=a.vertexCount;this._indexBuffer.free(e,f);this._vertexBuffer.free(d,b,!0);this._records.delete(c)}};l.getVAO=function(a,c,e,d){if(!this._vertexBuffer||!this._indexBuffer||null==this._records||!this._vertexBuffer.bufferSize)return null;const f=
d?1:0;let b=this._vaos.get(f);if(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||d&&this._indexBuffer.invalidatedComputeBuffer)b?.disposeVAOOnly(),b=null;this._vertexBuffer.upload();this._indexBuffer.upload();d=this._indexBuffer.getGPUBuffer(a,1===f);const h=this._vertexBuffer.getGPUBuffer(a);b||(b=new z.VertexArrayObject(a,e,c,{geometry:h},d),this._vaos.set(f,b));return b};l.forEachCommand=function(a){if(null!=this._records){this._sortIndices(this._records);if(!this._displayList){const c=
this._cursorIndexOrder;this._displayList=y.FeatureDisplayList.from(this,this.geometryType,this._records.getCursor(),c)}this._displayList.forEach(a)}};l._sortIndices=function(a){const c=!!this._indexBuffer.bufferSize;if(this._indicesInvalid){this._indicesInvalid=!1;for(var e=0,d=a.getCursor(),f=[],b=[],h=[];d.next();)b.push(d.index),h.push(d.sortKey),f.push(d.id);b.sort((q,m)=>{const n=h[m],p=h[q];return p===n?f[m]-f[q]:n-p});a=a.getCursor();d=c?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();
for(const q of b){if(!a.seekIndex(q))throw Error("Expected to find index");if(c){const {indexFrom:m,indexCount:n}=a;a.indexFrom=e;for(var k=0;k<n;k++)this._indexBuffer.set(e++,d.array[m+k])}else{const {vertexFrom:m,vertexCount:n}=a;var g=this._vertexBuffer.strideInt;const p=m*g;k=p+n*g;a.vertexFrom=e/g;for(g=p;g<k;g++)this._vertexBuffer.set(e++,d.array[g])}}this._cursorIndexOrder=b;this._displayList=null}};x._createClass(t,[{key:"records",get:function(){return this._records}}]);return t}();u.Geometry=
A;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../definitions","./CollisionGrid"],function(w,z,x,r){function q(t,p){const d=[];t.forEachTile(c=>d.push(c));d.sort((c,e)=>c.instanceId-e.instanceId);d.forEach(c=>{null!=c.labelMetrics&&c.isReady&&p(c,c.labelMetrics.getCursor())})}let B=function(){function t(){}var p=t.prototype;p.run=function(d,c,e){const g=[];for(let a=d.length-1;0<=a;a--){const b=d[a];b.labelingCollisionInfos&&g.push(...b.labelingCollisionInfos)}this._transformMetrics(g);
this._runCollision(g,c,e)};p._runCollision=function(d,c,e){const [g,a]=c.state.size,b=new r.CollisionBitsetGrid(g,a,c.pixelRatio);for(const {tileRenderer:f,deconflictionEnabled:u,visible:m}of d){const l=f.featuresView.attributeView;u?m?(this._prepare(f),this._collideVisible(b,f,e),this._collideInvisible(b,f)):q(f,(k,h)=>{for(;h.nextId();)l.setLabelMinZoom(h.id,255)}):q(f,(k,h)=>{for(;h.nextId();)l.setLabelMinZoom(h.id,0),m&&b.insertMetrics(h)})}};p._isFiltered=function(d,c,e){d=c.getFilterFlags(d);
c=null==e.featureEffect||e.featureEffect.excludedLabelsVisible||!!(d&x.EFFECT_FLAG_0);return!((!e.hasFilter||d&x.FILTER_FLAG_0)&&c)};p._prepare=function(d){const c=d.featuresView.attributeView,e=new Set;q(d,(g,a)=>{for(;a.nextId();)e.has(a.id)||(e.add(a.id),this._isFiltered(a.id,c,d.layerView)?c.setLabelMinZoom(a.id,254):0!==c.getLabelMinZoom(a.id)?c.setLabelMinZoom(a.id,255):c.setLabelMinZoom(a.id,0))})};p._collideVisible=function(d,c,e){const g=c.featuresView.attributeView,a=new Set;q(c,(b,f)=>
{for(;f.nextId();)if(!a.has(f.id))if(b.key.level!==e)g.setLabelMinZoom(f.id,254);else if(0===g.getLabelMinZoom(f.id))switch(d.insertMetrics(f)){case r.HAS_COLLISION:g.setLabelMinZoom(f.id,254);a.add(f.id);break;case r.NONE:g.setLabelMinZoom(f.id,0),a.add(f.id)}})};p._collideInvisible=function(d,c){const e=c.featuresView.attributeView,g=new Set;q(c,(a,b)=>{for(;b.nextId();)if(!g.has(b.id)&&255===e.getLabelMinZoom(b.id))switch(d.insertMetrics(b)){case r.HAS_COLLISION:e.setLabelMinZoom(b.id,255);g.add(b.id);
break;case r.NONE:e.setLabelMinZoom(b.id,0),g.add(b.id)}})};p._transformMetrics=function(d){for(const {tileRenderer:c,geometryType:e,vvEvaluators:g}of d)q(c,(a,b)=>{const f=c.featuresView.attributeView;a=a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const u="polyline"===e;for(;b.next();){const A=b.boundsCount,v=b.anchorX,y=b.anchorY;var m=b.size,l=g[0];if(null!=l){var k=f.getVVSize(b.id);l=l(k);m=isNaN(l)||null==l||Infinity===l?m:l}l=m/2*b.directionX;m=m/2*b.directionY;for(k=
0;k<A;k++){var h=v,n=b.anchorY;u?(h=h+b.boundsX(k)+l,n=n+b.boundsY(k)+m,h=a[0]*h+a[2]*n+a[4],n=a[1]*h+a[3]*n+a[5],b.setBoundsComputedAnchorX(k,Math.floor(h)),b.setBoundsComputedAnchorY(k,Math.floor(n))):(h=a[0]*v+a[2]*y+a[4],n=a[1]*v+a[3]*y+a[5],h=h+b.boundsX(k)+l,n=n+b.boundsY(k)+m,b.setBoundsComputedAnchorX(k,h),b.setBoundsComputedAnchorY(k,n))}}})};return z._createClass(t)}();w.CollisionEngine=B;Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f32 ../../../../chunks/vec2f32 ../DisplayObject ../../../webgl/enums ../../../webgl/rasterUtils".split(" "),function(l,m,t,h,v,n,p,u,q){const w={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};p=function(k){function g(a=
null,c=null,d=null){var b=k.call(this)||this;b._textureInvalidated=!0;b._colormapTextureInvalidated=!0;b._rasterTexture=null;b._rasterTextureBandIds=null;b._transformGridTexture=null;b._colormapTexture=null;b._colormap=null;b._supportsBilinearTexture=!0;b._processedTexture=null;b.functionTextures=[];b.projected=!1;b.stencilRef=0;b.coordScale=[1,1];b._processed=!1;b._symbolizerParameters=null;b.height=null;b.isRendereredSource=!1;b.pixelRatio=1;b.resolution=0;b.rotation=0;b._source=null;b.rawPixelData=
null;b._suspended=!1;b._bandIds=null;b._interpolation=null;b._transformGrid=null;b.width=null;b.x=0;b.y=0;b.source=a;b.transformGrid=c;b.interpolation=d;return b}m._inherits(g,k);var f=g.prototype;f.destroy=function(){this._disposeTextures()};f.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())};f._createTransforms=function(){return{dvs:v.create()}};f.setTransform=function(a){const c=h.identity(this.transforms.dvs),[d,b]=a.toScreenNoRotation([0,
0],[this.x,this.y]);var e=this.resolution/this.pixelRatio/a.resolution;const r=e*this.width;e*=this.height;const x=Math.PI*this.rotation/180;h.translate(c,c,n.fromValues(d,b));h.translate(c,c,n.fromValues(r/2,e/2));h.rotate(c,c,-x);h.translate(c,c,n.fromValues(-r/2,-e/2));h.scaleByVec2(c,c,n.fromValues(r,e));h.multiply(this.transforms.dvs,a.displayViewMat3,c)};f.getTextures=function({forProcessing:a=!1,useProcessedTexture:c=!1}={}){const d=c?this._processedTexture??this._rasterTexture:this._rasterTexture,
b=[],e=[];if(!d)return{names:b,textures:e};if(c)return e.push(d),b.push("u_image"),this._colormapTexture&&(e.push(this._colormapTexture),b.push("u_colormap")),{names:b,textures:e};this._transformGridTexture&&(e.push(this._transformGridTexture),b.push("u_transformGrid"));e.push(d);b.push("u_image");this._colormapTexture&&!a&&(e.push(this._colormapTexture),b.push("u_colormap"));return{names:b,textures:e}};f.onAttach=function(){this.invalidateTexture()};f.onDetach=function(){this.invalidateTexture()};
f.updateTexture=function({context:a}){if(this.stage){var c=this._isValidSource(this.source);c&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(a));this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(a),this._rasterTexture&&(c?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=q.createTransformTexture(a,this.transformGrid)):this._rasterTexture.setData(null)),this.suspended||(this.ready(),
this.requestRender()))}else this._disposeTextures()};f.updateProcessedTexture=function(){const {functionTextures:a}=this;0!==a.length&&(this.processedTexture=a.shift(),a.forEach(c=>c?.dispose()),a.length=0)};f._createOrDestroyRasterTexture=function(a){const c=this.source?.extractBands(this.bandIds);if(this._isValidSource(c)){var d=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(d)return;this._rasterTexture.dispose();this._rasterTexture=this._rasterTextureBandIds=null}this._supportsBilinearTexture=
!!a.capabilities.textureFloat?.textureFloatLinear;d=this._getTextureSamplingMethod(this.interpolation);this._rasterTexture=q.createRasterTexture(a,c,d,this.isRendereredSource||!a.capabilities.textureFloat?.textureFloat);this._processed=this.projected=!1;this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=this._rasterTextureBandIds=null)};f._isBandIdschanged=function(a){const c=this._rasterTextureBandIds;return!(null==
c&&null==a||c&&a&&c.join("")===a.join(""))};f._isValidSource=function(a){return null!=a&&0<a.pixels?.length};f._getTextureSamplingMethod=function(a){const {type:c,colormap:d}=this.symbolizerParameters;return!this._supportsBilinearTexture||"lut"===c||"stretch"===c&&null!=d||"bilinear"!==a&&"cubic"!==a?"nearest":"bilinear"};f._updateColormapTexture=function(a){const c=this._colormap,d=this.symbolizerParameters.colormap;if(!d)this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=
null),this._colormap=null;else if(!c)this._colormapTexture=q.createColormapTexture(a,d),this._colormap=d;else if(d.length!==c.length||d.some((b,e)=>b!==c[e]))this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=q.createColormapTexture(a,d),this._colormap=d};f._disposeTextures=function(a=!1){this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null);!a&&this._colormapTexture&&(this._colormapTexture.dispose(),
this._colormap=this._colormapTexture=null,this._colormapTextureInvalidated=!0);!a&&this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=this._rasterTexture=null);this._processedTexture&&(this._processedTexture.dispose(),this._processedTexture=null)};m._createClass(g,[{key:"processedTexture",get:function(){return this._processedTexture},set:function(a){this._processedTexture!==a&&(this._disposeTextures(!0),this._processedTexture=a)}},{key:"rasterTexture",get:function(){return this._rasterTexture},
set:function(a){this._rasterTexture!==a&&(this._rasterTexture?.dispose(),this._rasterTexture=a)}},{key:"processed",get:function(){return this._processed},set:function(a){this._processed=a;a||(t.disposeMaybe(this.processedTexture),this.invalidateTexture())}},{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||w},set:function(a){this._symbolizerParameters!==a&&(this._symbolizerParameters=a,this._colormapTextureInvalidated=!0,this.commonUniforms=null)}},{key:"source",get:function(){return this._source},
set:function(a){this._source!==a&&(this._source=a,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=this._rasterTexture=null),this.projected=!1,this.invalidateTexture())}},{key:"suspended",get:function(){return this._suspended},set:function(a){this._suspended&&!a&&this.stage&&(this.ready(),this.requestRender());this._suspended=a}},{key:"bandIds",get:function(){return this._bandIds},set:function(a){this._bandIds=a;this._isBandIdschanged(a)&&(this.projected=!1,this.invalidateTexture())}},
{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(a){this._interpolation=a;this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(a||"nearest")?u.TextureSamplingMode.LINEAR:u.TextureSamplingMode.NEAREST)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(a){this._transformGrid=a;this._transformGridTexture=t.disposeMaybe(this._transformGridTexture)}}]);return g}(p.DisplayObject);let y=function(k){function g(){return k.apply(this,
arguments)||this}m._inherits(g,k);m._createClass(g,[{key:"source",get:function(){return this._source}}]);return g}(p);l.RasterBitmap=p;l.RasterBitmapWithSource=y;l.hasSource=function(k){return null!=k.source};Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
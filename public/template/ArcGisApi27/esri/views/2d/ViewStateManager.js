// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../geometry ../../Viewpoint ../../core/Accessor ../../core/Error ../../core/has ../../core/Logger ../../core/reactiveUtils ../../core/screenUtils ../../core/Warning ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/accessorSupport/decorators/subclass ../../chunks/pe ../../geometry/Point ../../geometry/projection ../../geometry/support/spatialReferenceUtils ./PaddedViewState ./viewpointUtils ../../geometry/Extent".split(" "),
function(f,C,h,O,B,F,t,G,u,D,H,E,l,P,Q,I,J,m,K,L,M,p,N){f.ViewStateManager=function(x){function y(a){var b=x.call(this,a)||this;b.constraints=null;b.ready=!1;b.resizeAlign="center";b.addHandles([D.watch(()=>b.constraints?.version,c=>{b.constraints&&c&&b.ready&&(b.state.viewpoint=b.constraints.fit(b.state.paddedViewState.viewpoint))},D.sync)]);return b}C._inherits(y,x);var q=y.prototype;q.getUserStartupOptions=function(a){if(!a[0]&&!a[1])return{center:void 0,rotation:void 0,scale:void 0};const {padding:b,
constraints:c}=this;var e=this._get("center"),k=this._get("extent");const d=this._get("scale");var n=this._get("rotation");const v=this._get("viewpoint");var g=this._get("zoom");g=null!=g&&null!=c?c.zoomToScale(g)||void 0:void 0;let z=void 0,A=void 0,w=void 0;const r=v?.targetGeometry;"extent"===r?.type?z=r:"point"===r?.type&&(A=r,w=v?.scale);k=k??z;e=e??A??k?.center;n=n??v?.rotation;a=(d??g??w??(k&&p.extentToScale(k,[a[0]-b.left-b.right,a[1]-b.top-b.bottom])))||void 0;return{center:e,rotation:n,
scale:a}};q.startup=function(a,b,c,e){const k=a.targetGeometry;try{this._project(a,c)}catch(d){u.getLogger(this).warn(new E("mapview:startup-projection-error","projection of initial viewpoint to the view's spatial reference, defaulting to the initial viewpoint.",{center:k.toJSON(),spatialReference:c,error:d})),a.targetGeometry=e||new m({x:0,y:0,spatialReference:c})}this.constraints?.fit(a);this._set("state",new M({padding:this.padding,size:b,viewpoint:a}));this._set("ready",!0)};q.teardown=function(){this._set("ready",
!1);const {center:[a,b],spatialReference:c,rotation:e,scale:k}=this.state.paddedViewState,d=new m({x:a,y:b,spatialReference:c});this._set("viewpoint",null);this._set("extent",null);this._set("center",d);this._set("zoom",-1);this._set("rotation",e);this._set("scale",k);this._set("state",null)};q.changeSpatialReference=function(a){const b=this.state.paddedViewState.clone();if(null==this._scaleBeforeChangingSpatialReference)this._scaleBeforeChangingSpatialReference=b.scale;else{var c=b.viewpoint.clone();
c.scale=this._scaleBeforeChangingSpatialReference;b.viewpoint=c}c=b.clone();const [e,k]=b.center;var d=null;try{d=this._project(new m({x:e,y:k,spatialReference:b.spatialReference}),a)}catch(n){J.isLoaded()||u.getLogger(this).warn(new E("mapview:spatial-reference-change","could not project the view's center to the new spatial reference",{center:d?.toJSON(),spatialReference:a,error:n}))}d||(d=new m({x:0,y:0,spatialReference:a}));d=p.centerAt(new B({targetGeometry:new m,scale:0,rotation:0}),b.viewpoint,
d);c.viewpoint=d;try{const n=[b.size[0]/2,b.size[1]/2],v=[n[0]+20,n[1]],g=b.toMap([0,0],v),{x:z,y:A}=this._project(new m({x:g[0],y:g[1],spatialReference:b.spatialReference}),a);g[0]=z;g[1]=A;c.toScreen(g,g);const w=p.angleBetween(n,g,v),r=Math.hypot(g[0]-n[0],g[1]-n[1])/20;!Number.isFinite(r)||4<Math.abs(r)?(d.rotation=0,d.targetGeometry=new m({x:0,y:0,spatialReference:a})):(d.scale*=r,d.scale>G("mapview-srswitch-adjust-rotation-scale-threshold")?d.rotation=0:d.rotation+=Number.isFinite(w)?w:0)}catch{}this._get("constraints")?.constrain(d,
void 0);this._get("state").viewpoint=d};q.resize=function(a,b){if(this.ready){var c=this.state,e=this.state.paddedViewState.viewpoint,k=this.state.paddedViewState.size.concat();c.size=[a,b];p.resize(e,e,k,this.state.paddedViewState.size,this.resizeAlign);e=this.constraints?.constrain(e,void 0)??e;this.state.viewpoint=e}};q.toMap=function(a){if(!this.ready)return null;const [b,c]=this.state.toMap([0,0],[a.x,a.y]);return new m({x:b,y:c,spatialReference:this.state.spatialReference})};q.toScreen=function(a){if(!this.ready)return null;
a=this._project(a,this.state.spatialReference);a=[a.x,a.y];this.state.toScreen(a,a);return H.createScreenPoint(a[0],a[1])};q._project=function(a,b){const c=a&&a.targetGeometry||a;if(!b)return a;if(!c)return null;if(b.imageCoordinateSystem||c.spatialReference?.imageCoordinateSystem||L.equals(b,c.spatialReference))return a;const e=K.project(c,b);if(!e)throw new t("mapview:projection-not-possible","projecting input geometry to target spatial reference returned a null value",{geometry:c,spatialReference:b});
return"esri.Viewpoint"===a?.declaredClass?(a.targetGeometry=e,a):e};C._createClass(y,[{key:"center",get:function(){if(!this.ready)return this._get("center");const {center:a,spatialReference:b}=this.state.paddedViewState;this.state.commitProperty("id");return new m({x:a[0],y:a[1],spatialReference:b})},set:function(a){if(null!=a)if(this.ready){try{var b=this._project(a,this.state.spatialReference)}catch(c){u.getLogger(this).error(new t("mapview:invalid-center","could not project the value in the view's spatial reference",
{input:a,error:c}));return}a=this.viewpoint;p.centerAt(a,a,b);this.viewpoint=a}else this._set("center",a)}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");this.state.commitProperty("id");return this.state.paddedViewState.extent.clone()},set:function(a){if(null!=a)if(a.width&&a.height)if(this.ready){try{var b=this._project(a,this.state.spatialReference)}catch(c){u.getLogger(this).error(new t("mapview:invalid-extent","could not project the value in the view's spatial reference",
{error:c}));return}a=this.viewpoint;p.setExtent(a,a,b,this.state.size,{constraints:this.constraints});this.viewpoint=a}else this._set("extent",a),this._set("center",void 0),this._set("viewpoint",void 0),this._set("scale",void 0),this._set("zoom",void 0);else u.getLogger(this).error(new t("mapview:invalid-extent","invalid extent size"))}},{key:"padding",get:function(){return this.ready?this.state.padding:this._get("padding")},set:function(a){this.ready?(this.state.padding=a,this._set("padding",this.state.padding)):
this._set("padding",a)}},{key:"resolution",get:function(){if(!this.ready)return 0;this.state.commitProperty("id");return this.state.resolution}},{key:"rotation",get:function(){if(!this.ready)return this._get("rotation");this.state.commitProperty("id");return this.state.rotation},set:function(a){if(!isNaN(a))if(this.ready){var b=this.viewpoint;p.rotateTo(b,b,a);this.viewpoint=b}else this._set("rotation",a)}},{key:"scale",get:function(){if(!this.ready)return this._get("scale");this.state.commitProperty("id");
return this.state.scale},set:function(a){if(a&&!isNaN(a))if(this.ready){var b=this.viewpoint;p.scaleTo(b,b,a);this.viewpoint=b}else if(this._set("scale",a),this._set("zoom",void 0),a=this._get("extent"))this._set("extent",void 0),this._set("center",a.center)}},{key:"viewpoint",get:function(){return this.ready?this.state.paddedViewState.viewpoint.clone():this._get("viewpoint")},set:function(a){if(null!=a)if(this.ready){var b;try{var c=this._project(a,this.state.spatialReference);!a.scale||isNaN(a.scale)?
b=new t("mapview:invalid-viewpoint",`invalid scale value of ${a.scale}`):null==a.targetGeometry&&(b=new t("mapview:invalid-viewpoint","geometry not defined"))}catch(e){b=new t("mapview:invalid-viewpoint","could not project the value in the view's spatial reference",{error:e})}b?u.getLogger(this).error(b):(this._scaleBeforeChangingSpatialReference=null,a=new B({targetGeometry:new m,scale:0,rotation:0}),p.copy(a,c),this.constraints?.constrain(a,this.state.paddedViewState.viewpoint),this.state.viewpoint=
a,this._set("viewpoint",a))}else this._set("viewpoint",a),this._set("extent",void 0),this._set("center",void 0),this._set("zoom",void 0),this._set("scale",void 0)}},{key:"zoom",get:function(){return this.ready?this.constraints?.scaleToZoom(this.scale)??-1:this._get("zoom")},set:function(a){if(0<=a)if(this.ready)if(a=this.constraints?.zoomToScale(a)??0){var b=this.viewpoint;p.scaleTo(b,b,a);this.viewpoint=b;this._set("zoom",this.constraints?.scaleToZoom(this.scale)??-1)}else this._set("zoom",-1);else if(this._set("zoom",
a),this._set("scale",void 0),a=this._get("extent"))this._set("extent",void 0),this._set("center",a.center)}}]);return y}(F);h.__decorate([l.property({type:m})],f.ViewStateManager.prototype,"center",null);h.__decorate([l.property()],f.ViewStateManager.prototype,"constraints",void 0);h.__decorate([l.property({type:N})],f.ViewStateManager.prototype,"extent",null);h.__decorate([l.property({value:{top:0,right:0,bottom:0,left:0},cast:x=>({top:0,right:0,bottom:0,left:0,...x})})],f.ViewStateManager.prototype,
"padding",null);h.__decorate([l.property()],f.ViewStateManager.prototype,"ready",void 0);h.__decorate([l.property()],f.ViewStateManager.prototype,"resizeAlign",void 0);h.__decorate([l.property({readOnly:!0})],f.ViewStateManager.prototype,"resolution",null);h.__decorate([l.property({type:Number})],f.ViewStateManager.prototype,"rotation",null);h.__decorate([l.property({type:Number})],f.ViewStateManager.prototype,"scale",null);h.__decorate([l.property({readOnly:!0})],f.ViewStateManager.prototype,"state",
void 0);h.__decorate([l.property({type:B})],f.ViewStateManager.prototype,"viewpoint",null);h.__decorate([l.property()],f.ViewStateManager.prototype,"zoom",null);f.ViewStateManager=h.__decorate([I.subclass("esri.views.2d.ViewStateManager")],f.ViewStateManager);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../Graphic ../../../../symbols ../../../../core/analysisThemeUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../chunks/boundedPlane ../../../../geometry/support/spatialReferenceUtils ../../../../layers/GraphicsLayer ../../../ViewingMode ./manipulations/DragManipulation ./manipulations/RotateManipulation ./manipulations/ScaleManipulation ./manipulations/utils ../../../input/keys ../../../interactive/InteractiveToolBase ../../../interactive/editGeometry/EditGeometry ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/editGeometry/interfaces ../../../interactive/editGeometry/operations/UpdateVertices ../../../interactive/editGeometry/support/editPlaneUtils ../../../support/hitTestSelectUtils ../../../support/screenUtils ../../../../symbols/SimpleFillSymbol ../../../../symbols/SimpleMarkerSymbol ../../../../geometry/Polygon ../../../../geometry/Point".split(" "),
function(h,A,n,ca,w,da,t,J,K,B,r,ea,fa,ha,L,C,D,f,p,y,z,M,N,E,O,P,Q,F,R,S,T,U,G,V,W,X,Y,Z,H,aa,q){const k={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",plus:"+",minus:"-",toggleOpacity:"t",shift:"Shift",primaryKey:R.primaryKey},ba=[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]];h.TransformTool=function(I){function x(a){a=I.call(this,a)||this;a._initialControlPoints=null;a._initialGeometry=null;a._graphic=null;a._planeCache=z.create();a._displayPlaneCache=z.create();a._mainAxisCache=
D.create();a._rotationHandleCache=p.create();a._cornerA=p.create();a._cornerB=p.create();a._cornerC=p.create();a._cornerD=p.create();a._avgAB=p.create();a._avgBC=p.create();a._avgCD=p.create();a._avgDA=p.create();a._preserveAspectRatio=new F.PreserveAspectRatio;a._snapRotation=new F.SnapRotation;a._graphicsLayer=new N({internal:!0,listMode:"hide",visible:!1});a._sharedUndoStack=[];a._sharedRedoStack=[];a._isOpacityToggled=!1;a._isModifierActive=!1;a._factor=1;a.preserveAspectRatio=null;a.snapRotation=
null;return a}A._inherits(x,I);var e=x.prototype;e.initialize=function(){this._initialize()};e.destroy=function(){const {map:a}=this.view;this._dragManipulation.destroy();this._rotateManipulation.destroy();this._scaleManipulations.forEach(c=>c.destroy());this._editGeometryOperations.destroy();a.removeMany([this._graphicsLayer]);this._graphicsLayer.removeAll();this._graphicsLayer=J.destroyMaybe(this._graphicsLayer);this._sharedRedoStack=this._sharedUndoStack=this._avgDA=this._avgCD=this._avgBC=this._avgAB=
this._cornerD=this._cornerC=this._cornerB=this._cornerA=this._mainAxisCache=this._rotationHandleCache=this._displayPlaneCache=this._planeCache=this._snapRotation=this._preserveAspectRatio=this._graphic=this._initialGeometry=this._initialControlPoints=null};e.onActivate=function(){this.visible=!0};e.onDeactivate=function(){this.visible=!1};e.onShow=function(){this._graphicsLayer.visible=!0};e.onHide=function(){this._graphicsLayer.visible=!1};e.canUndo=function(){return this._editGeometryOperations.canUndo};
e.canRedo=function(){return this._editGeometryOperations.canRedo};e.undo=function(){this._editGeometryOperations.undo();this.updateGraphics()};e.redo=function(){this._editGeometryOperations.redo();this.updateGraphics()};e.refresh=function(){const {view:a,target:c}=this,d=this._editGeometryOperations,b=d.data.components[0].vertices,g=T.EditGeometry.fromGeometry(y.project("georeference"in c?c.georeference.coords:c.geometry,a.spatialReference),E.ViewingMode.Local).components[0].vertices;b.forEach((l,
m)=>{d.setVertexPosition(l,g[m].pos)});this.updateGraphics()};e.reset=function(){var {target:a}=this;"georeference"in a?(a=a.georeference,"control-points"===a.type&&(a.controlPoints=this._initialControlPoints)):a.geometry=this._initialGeometry;this.refresh();this._sharedUndoStack.length=0;this._sharedRedoStack.length=0};e.updateGraphics=function(){const a=this._editGeometryOperations.data.geometry;"georeference"in this.target&&(this.target.georeference.coords=a);this._graphic.geometry=a;this._backgroundGraphic.geometry=
this._backgroundGraphicGeometry;this._rotateGraphic.geometry=this._rotateGraphicGeometry;this._scaleGraphicGeometries.forEach((c,d)=>{this._scaleGraphics[d].geometry=c})};e.setSharedUndoStack=function(a){this._sharedUndoStack=a};e.setSharedRedoStack=function(a){this._sharedRedoStack=a};e._initialize=async function(){const {view:a,target:c}=this;if("georeference"in c){const b=c.georeference;this._graphic=new w({geometry:b.coords});this._initialControlPoints="control-points"===b.type?b.controlPoints:
null}else this._graphic=c,this._initialGeometry=c.geometry;a.map.addMany([this._graphicsLayer]);a.focus();this.visible=!1;this.finishToolCreation();await this._loadProjectionEngine();this._editGeometryOperations=U.EditGeometryOperations.fromGeometry(y.project(this._graphic.geometry,a.spatialReference),E.ViewingMode.Local);this._backgroundGraphic=new w({symbol:new Z({color:"transparent",outline:{type:"simple-line",color:t.getAccentColor(),width:2}}),geometry:this._backgroundGraphicGeometry});this._rotateGraphic=
new w({symbol:new H({color:t.getContrastColor(),outline:{type:"simple-line",color:t.getAccentColor(),width:1}}),geometry:this._rotateGraphicGeometry});this._scaleGraphics=this._scaleGraphicGeometries.map(b=>new w({symbol:new H({size:6,style:"square",color:t.getContrastColor(),outline:{type:"simple-line",color:t.getAccentColor(),width:1}}),geometry:b}));this._graphicsLayer.graphics.addMany([this._backgroundGraphic,this._rotateGraphic,...this._scaleGraphics]);this._dragManipulation=new O.DragManipulation({tool:this,
view:a,graphic:this._graphic});this._rotateManipulation=new P.RotateManipulation({tool:this,view:a,graphic:this._rotateGraphic,snapRotation:this._snapRotation});this._scaleManipulations=this._scaleGraphics.map((b,g)=>new Q.ScaleManipulation({tool:this,view:a,graphic:b,direction:ba[g],preserveAspectRatio:this._preserveAspectRatio}));this.addHandles([this._dragManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),this._rotateManipulation.createDragPipeline(this._getInfo.bind(this),
this._updateGraphics.bind(this)),...this._scaleManipulations.map(b=>b.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this))),K.watch(()=>this.view.scale,()=>this.active?this.updateGraphics():null),a.on("click",async b=>{if(null==a.activeTool||a.activeTool===this){b=Y.createScreenPointFromEvent(b);var g=[];a.map.allLayers.forEach(m=>{"vector-tile"!==m.type&&"imagery"!==m.type||g.push(m)});b=await this.view.hitTest(b,{exclude:g});var l=b.results;if(0===l.length)a.activeTool=null;
else{b=X.findFirstGraphicHit(b.results);const m="georeference"in c;l=l.map(u=>"media"===u.type?u.element:null).filter(Boolean);const v=[...this._graphicsLayer.graphics,m?null:c].filter(Boolean);(m?l.includes(c)||null!=b&&v.includes(b.graphic):null!=b&&v.includes(b.graphic))?null==a.activeTool&&(a.activeTool=this):a.activeTool=null}}})]);const d=b=>{this.addHandles(b.events.on("grab-changed",g=>{"georeference"in c&&("start"===g.action?c.opacity*=.5:"end"===g.action&&(c.opacity*=2))}))};this._dragManipulation.forEachManipulator(d);
this._rotateManipulation.forEachManipulator(d);this._scaleManipulations.forEach(b=>b.forEachManipulator(d));this.addHandles([a.on("key-down",b=>{a.activeTool===this&&(b.key!==k.shift||b.repeat||(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!0,b.stopPropagation()),b.key!==k.toggleOpacity||b.repeat||("georeference"in c&&(c.opacity*=this._isOpacityToggled?
2:.5,this._isOpacityToggled=!this._isOpacityToggled),b.stopPropagation()),b.key!==k.primaryKey||b.repeat||(this._factor=10,b.stopPropagation()),this._isModifierActive&&(b.key===k.plus&&(this._scale(this._factor),b.stopPropagation()),b.key===k.minus&&(this._scale(-this._factor),b.stopPropagation()),b.key===k.up&&(this._move(0,this._factor),b.stopPropagation()),b.key===k.down&&(this._move(0,-this._factor),b.stopPropagation()),b.key===k.left&&(this._move(-this._factor,0),b.stopPropagation()),b.key===
k.right&&(this._move(this._factor,0),b.stopPropagation())))}),a.on("key-up",b=>{a.activeTool===this&&(b.key===k.shift&&(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!1,b.stopPropagation()),b.key===k.primaryKey&&(this._factor=1,b.stopPropagation()))})])};e._loadProjectionEngine=async function(){return y.initializeProjection(this._graphic.geometry.spatialReference,
this.view.spatialReference)};e._updateDisplayPlaneConrers=function(a){const {basis1:c,basis2:d,origin:b}=a;a=this._cornerA;f.add(a,b,c);f.add(a,a,d);a=this._cornerB;f.add(a,b,c);f.subtract(a,a,d);a=this._cornerC;f.subtract(a,b,c);f.subtract(a,a,d);a=this._cornerD;f.subtract(a,b,c);f.add(a,a,d)};e._getInfo=function(){return{editGeometryOperations:this._editGeometryOperations,plane:this._plane,displayPlane:this._displayPlane}};e._updateGraphics=function(a,c){"start"===a.action&&(this._sharedUndoStack.push({tool:this,
operation:c}),this._sharedRedoStack.length=0);this.updateGraphics()};e._scale=function(a){var c=this._editGeometryOperations;const d=[];for(var b of c.data.components)d.push(...b.vertices);b=c.data.geometry.extent?.width;a=(b+a*this.view.resolution)/b;c=c.scaleVertices(d,this._plane.origin,D.UNIT_X,a,a,G.AccumulationBehaviour.NEW_STEP,V.AccumulationType.REPLACE);this._sharedUndoStack.push({tool:this,operation:c});this._sharedRedoStack.length=0;this.updateGraphics()};e._move=function(a,c){const d=
this._editGeometryOperations,b=[];for(const g of d.data.components)b.push(...g.vertices);a=d.moveVertices(b,a*this.view.resolution,c*this.view.resolution,0,G.AccumulationBehaviour.NEW_STEP);this._sharedUndoStack.push({tool:this,operation:a});this._sharedRedoStack.length=0;this.updateGraphics()};A._createClass(x,[{key:"_plane",get:function(){const a=this._graphic.geometry;if(null==a)return null;const c=this._editGeometryOperations.data;var d=c.components[0].edges[0];d=C.subtract(this._mainAxisCache,
d.leftVertex.pos,d.rightVertex.pos);C.normalize(d,d);let b=80*this.view.resolution;const g=this.view.spatialReference;M.equals(g,a.spatialReference)&&(b*=B.getMetersPerUnitForSR(g)/B.getMetersPerUnitForSR(a.spatialReference));return W.calculateOrientedBounds(d,c,b,this._planeCache)}},{key:"_displayPlane",get:function(){var a=this._plane;if(!a)return null;const c=this._displayPlaneCache;z.copy(a,c);a=10*this.view.resolution;f.scale(c.basis1,c.basis1,1+a/f.length(c.basis1));f.scale(c.basis2,c.basis2,
1+a/f.length(c.basis2));return c}},{key:"_backgroundGraphicGeometry",get:function(){const a=this._displayPlane;if(!a)return null;const c=this.view.spatialReference;this._updateDisplayPlaneConrers(a);return new aa({spatialReference:c,rings:[[this._cornerA,this._cornerB,this._cornerC,this._cornerD,this._cornerA]]})}},{key:"_rotateGraphicGeometry",get:function(){const a=this._plane;if(!a)return null;const c=this._rotationHandleCache;f.normalize(c,a.basis1);f.scale(c,c,30*this.view.resolution);f.add(c,
c,a.origin);f.add(c,c,a.basis1);return new q({x:c[0],y:c[1],spatialReference:this.view.spatialReference})}},{key:"_scaleGraphicGeometries",get:function(){var a=this._displayPlane;if(!a)return[];const c=this.view.spatialReference;this._updateDisplayPlaneConrers(a);const {_cornerA:d,_cornerB:b,_cornerC:g,_cornerD:l}=this;a=f.lerp(this._avgAB,d,b,.5);const m=f.lerp(this._avgBC,b,g,.5),v=f.lerp(this._avgCD,g,l,.5),u=f.lerp(this._avgDA,l,d,.5);return[new q({x:d[0],y:d[1],spatialReference:c}),new q({x:b[0],
y:b[1],spatialReference:c}),new q({x:g[0],y:g[1],spatialReference:c}),new q({x:l[0],y:l[1],spatialReference:c}),new q({x:a[0],y:a[1],spatialReference:c}),new q({x:m[0],y:m[1],spatialReference:c}),new q({x:v[0],y:v[1],spatialReference:c}),new q({x:u[0],y:u[1],spatialReference:c})]}}]);return x}(S.InteractiveToolBase);n.__decorate([r.property()],h.TransformTool.prototype,"_plane",null);n.__decorate([r.property()],h.TransformTool.prototype,"_backgroundGraphicGeometry",null);n.__decorate([r.property()],
h.TransformTool.prototype,"_rotateGraphicGeometry",null);n.__decorate([r.property()],h.TransformTool.prototype,"_scaleGraphicGeometries",null);n.__decorate([r.property()],h.TransformTool.prototype,"preserveAspectRatio",void 0);n.__decorate([r.property()],h.TransformTool.prototype,"snapRotation",void 0);n.__decorate([r.property({constructOnly:!0,nonNullable:!0})],h.TransformTool.prototype,"target",void 0);n.__decorate([r.property({constructOnly:!0})],h.TransformTool.prototype,"view",void 0);h.TransformTool=
n.__decorate([L.subclass("esri.views.2d.interactive.editingTools.TransformTool")],h.TransformTool);h.KEYS=k;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
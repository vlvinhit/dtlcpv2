// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../Graphic ../../../../symbols ../../../../core/analysisThemeUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/spatialReferenceUtils ../../../../layers/GraphicsLayer ../../../../symbols/support/cimSymbolUtils ../../../ViewingMode ./manipulations/DragManipulation ../../../input/keys ../../../interactive/InteractiveToolBase ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/editGeometry/interfaces ../../../../symbols/CIMSymbol".split(" "),
function(h,q,l,x,y,L,r,z,A,m,M,N,O,B,p,C,D,t,E,F,G,H,I,J,K){const g={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",toggleOpacity:"t",shift:"Shift",primaryKey:G.primaryKey},u=new x("#009AF2");h.ControlPointsTransformTool=function(v){function n(a){a=v.call(this,a)||this;a._isOpacityToggled=!1;a._isModifierActive=!1;a._factor=1;a._initialControlPoints=null;a._graphicsLayer=new D({internal:!0,listMode:"hide",visible:!1,effect:"drop-shadow(0px, 0px, 3px)"});a._undoStack=[];a._redoStack=
[];a._sharedUndoStack=[];a._sharedRedoStack=[];a._highlightHandle=null;a.activeHandle=0;return a}q._inherits(n,v);var c=n.prototype;c.initialize=function(){this._initialize()};c.destroy=function(){const {map:a}=this.view;this._controlPointManipulations.forEach(d=>d.destroy());this._controlPointEditGeometryOperations.forEach(d=>d.destroy());a.removeMany([this._graphicsLayer]);this._graphicsLayer.removeAll();this._graphicsLayer=z.destroyMaybe(this._graphicsLayer);this._sharedRedoStack=this._sharedUndoStack=
this._initialControlPoints=this._redoStack=this._undoStack=this._controlPointEditGeometryOperations=this._graphicsLayer=this._controlPointManipulations=this._controlPointGraphics=this._georeference=null};c.onActivate=function(){this.visible=!0};c.onDeactivate=function(){this.visible=!1};c.onShow=function(){this._graphicsLayer.visible=!0};c.onHide=function(){this._graphicsLayer.visible=!1};c.canUndo=function(){const a=this._undoStack[this._undoStack.length-1];return null!=a?this._controlPointEditGeometryOperations[a].canUndo:
!1};c.canRedo=function(){const a=this._redoStack[this._redoStack.length-1];return null!=a?this._controlPointEditGeometryOperations[a].canRedo:!1};c.undo=function(){if(0<this._undoStack.length){const a=this._undoStack.pop();this._controlPointEditGeometryOperations[a].undo();this.updateGraphics();this._redoStack.push(a)}};c.redo=function(){if(0<this._redoStack.length){const a=this._redoStack.pop();this._controlPointEditGeometryOperations[a].redo();this.updateGraphics();this._undoStack.push(a)}};c.refresh=
function(){var {mediaElement:a}=this;null!=a.georeference&&(a=a.georeference,"control-points"===a.type&&null!=a.coords&&(this._georeference=a,this._georeference.controlPoints.forEach(({mapPoint:d},e)=>{e=this._controlPointEditGeometryOperations[e];e.setVertexPosition(e.data.components[0].vertices[0],e.data.coordinateHelper.pointToVector(d))}),this.updateGraphics()))};c.reset=function(){this._georeference.controlPoints=this._initialControlPoints;this.refresh();this._sharedUndoStack.length=0;this._sharedRedoStack.length=
0};c.updateGraphics=function(){const a=this._georeference,d=a.controlPoints,e=d[0].mapPoint.spatialReference,b=this._hasValidSpatialReference;this._georeference.controlPoints=this._controlPointEditGeometryOperations.map((f,k)=>{f=f.data.geometry;this._controlPointGraphics[k].geometry=f;return{mapPoint:p.project(f,e),sourcePoint:b?d[k].sourcePoint:a.toSource(f)}})};c.updateActiveHandle=function(a){if(this.activeHandle!==a){var d=this._controlPointGraphics[this.activeHandle].symbol.clone();t.applyCIMSymbolColor(d,
r.getAccentColor());this._controlPointGraphics[this.activeHandle].symbol=d;d=this._controlPointGraphics[a].symbol.clone();t.applyCIMSymbolColor(d,u);this._controlPointGraphics[a].symbol=d;this.activeHandle=a;this.view.surface===document.activeElement&&this.highlightActiveHandle()}};c.highlightActiveHandle=async function(){this.removeHighlightActiveHandle();this._highlightHandle=(await this.view.whenLayerView(this._graphicsLayer)).highlight(this._controlPointGraphics[this.activeHandle])};c.removeHighlightActiveHandle=
function(){this._highlightHandle&&this._highlightHandle.remove()};c.setSharedUndoStack=function(a){this._sharedUndoStack=a};c.setSharedRedoStack=function(a){this._sharedRedoStack=a};c._initialize=async function(){const {view:a,mediaElement:d}=this;if(null!=d.georeference){var e=d.georeference;"control-points"===e.type&&null!=e.coords&&(this._georeference=e,this._initialControlPoints=this._georeference.controlPoints,a.map.addMany([this._graphicsLayer]),a.focus(),this.visible=!1,this.finishToolCreation(),
await this._loadProjectionEngine(),this._controlPointEditGeometryOperations=this._georeference.controlPoints.map(({mapPoint:b})=>I.EditGeometryOperations.fromGeometry(p.project(b,a.spatialReference),E.ViewingMode.Local)),this._controlPointGraphics=this._controlPointEditGeometryOperations.map((b,f)=>new y({symbol:new K({data:{type:"CIMSymbolReference",symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,colorLocked:!0,anchorPoint:{x:0,y:-15.75},anchorPointUnits:"Absolute",
dominantSizeAxis3D:"Y",size:9,billboardMode3D:"FaceNearPlane",frame:{xmin:0,ymin:0,xmax:84.3,ymax:84.3},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[83.2,32.5],[84.3,40.7],[83.8,48.9],[81.7,56.9],[78.1,64.3],[73,70.9],[66.9,76.4],[59.7,80.5],[51.9,83.2],[43.7,84.3],[35.4,83.8],[27.4,81.7],[20,78],[13.4,73],[7.9,66.8],[3.8,59.7],[1.1,51.9],[0,43.7],[.5,35.4],[2.6,27.4],[6.3,20],[11.3,13.4],[17.5,7.9],[24.7,3.8],[32.5,1.1],[39.8,.1],[47.1,.3],[54.3,1.8],[61.1,4.5],[67.4,8.4],[72.9,13.3],
[77.4,19.1],[80.9,25.5],[83.2,32.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[255,255,255,255]}]}}],scaleSymbolsProportionally:!0,respectFrame:!0,clippingPath:{type:"CIMClippingPath",clippingType:"Intersect",path:{rings:[[[0,0],[84.3,0],[84.3,84.3],[0,84.3],[0,0]]]}},rotation:0},{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:-11.25},anchorPointUnits:"Absolute",dominantSizeAxis3D:"Y",size:22.5,billboardMode3D:"FaceNearPlane",frame:{xmin:0,ymin:0,xmax:197.7,
ymax:294.7},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[98.9,0],[119.4,23.2],[139.4,49.3],[156.8,75.2],[171.2,100.8],[182.4,125.3],[190.6,148.8],[195.7,171.4],[197.7,192.9],[197.7,195.8],[197.7,200.3],[197.6,202.5],[197.5,204.8],[197.3,207.1],[197,209.4],[196.7,211.7],[196.4,214.1],[196,216.4],[195.5,218.7],[195,221.1],[194.4,223.4],[193.7,225.8],[193,228.1],[192.2,230.5],[191.4,232.8],[190.5,235.1],[189.5,237.5],[188.5,239.7],[187.4,242],[186.2,244.3],[185,246.5],[183.7,248.7],[182.4,
250.9],[181,253.1],[179.5,255.2],[178,257.3],[176.4,259.4],[174.7,261.4],[173.1,263.3],[171.3,265.3],[169.5,267.2],[167.7,269],[165.8,270.8],[163.9,272.5],[161.9,274.2],[159.9,275.8],[157.8,277.4],[155.7,278.9],[153.6,280.4],[151.4,281.7],[149.2,283.1],[147,284.4],[144.8,285.6],[142.5,286.7],[140.3,287.8],[138,288.8],[135.7,289.8],[133.4,290.7],[131,291.5],[128.7,292.3],[126.4,293],[124,293.6],[121.7,294.2],[119.4,294.7],[117,295.2],[114.7,295.6],[112.4,296],[110.1,296.3],[107.8,296.5],[105.5,296.7],
[103.3,296.8],[101.1,296.9],[98.8,296.9],[83.1,295.7],[67.8,292],[53.3,285.9],[39.9,277.5],[28.1,267.2],[18,255.1],[10,241.5],[4.2,226.9],[.9,211.5],[0,195.8],[.1,192.9],[2.1,171.4],[7.2,148.8],[15.4,125.3],[26.6,100.8],[41,75.2],[58.4,49.3],[78.4,23.2],[98.9,0]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:f===this.activeHandle?u.toArray():r.getAccentColor().toArray()}]}}],scaleSymbolsProportionally:!0,respectFrame:!0,clippingPath:{type:"CIMClippingPath",clippingType:"Intersect",
path:{rings:[[[0,0],[197.7,0],[197.7,294.7],[0,294.7],[0,0]]]}},rotation:0}],haloSize:1,scaleX:1,angleAlignment:"Display",angle:0}}}),geometry:b.data.geometry})),this._graphicsLayer.graphics.addMany([...this._controlPointGraphics]),this._controlPointManipulations=this._controlPointGraphics.map(b=>new F.DragManipulation({tool:this,view:a,graphic:b})),this.addHandles([...this._controlPointManipulations.map((b,f)=>b.createDragPipeline(this._getInfo.bind(this,f),(k,w)=>{"start"===k.action&&(this._undoStack.push(f),
this._redoStack=[],this._sharedUndoStack.push({tool:this,operation:w}),this._sharedRedoStack.length=0);this.updateGraphics()})),A.watch(()=>this.view.scale,()=>this.active?this.updateGraphics():null)]),this._controlPointManipulations.forEach((b,f)=>{b.forEachManipulator(k=>{this.addHandles([k.events.on(["click","grab-changed"],w=>this.updateActiveHandle(f))])})}),this.addHandles([a.on("key-down",b=>{a.activeTool===this&&(b.key!==g.shift||b.repeat||(this._isModifierActive=!0,b.stopPropagation()),b.key!==
g.toggleOpacity||b.repeat||(d.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled,b.stopPropagation()),b.key!==g.primaryKey||b.repeat||(this._factor=10,b.stopPropagation()),this._isModifierActive&&(b.key===g.up&&(this._move(0,this._factor),b.stopPropagation()),b.key===g.down&&(this._move(0,-this._factor),b.stopPropagation()),b.key===g.left&&(this._move(-this._factor,0),b.stopPropagation()),b.key===g.right&&(this._move(this._factor,0),b.stopPropagation())))}),a.on("key-up",
b=>{a.activeTool===this&&(b.key===g.shift&&(this._isModifierActive=!1,b.stopPropagation()),b.key===g.primaryKey&&(this._factor=1,b.stopPropagation()))})]))}};c._loadProjectionEngine=async function(){return p.initializeProjection(this._georeference.controlPoints[0].mapPoint.spatialReference,this.view.spatialReference)};c._getInfo=function(a){return{editGeometryOperations:this._controlPointEditGeometryOperations[a],constraints:this._hasValidSpatialReference?null:{xmin:0,ymin:0,xmax:this._georeference.width,
ymax:this._georeference.height}}};c._move=function(a,d){const e=this._controlPointEditGeometryOperations[this.activeHandle],b=[];for(const f of e.data.components)b.push(...f.vertices);a=e.moveVertices(b,a*this.view.resolution,d*this.view.resolution,0,J.AccumulationBehaviour.NEW_STEP);this._sharedUndoStack.push({tool:this,operation:a});this._sharedRedoStack.length=0;this.updateGraphics()};q._createClass(n,[{key:"_hasValidSpatialReference",get:function(){return C.isValid(this.view.spatialReference)}}]);
return n}(H.InteractiveToolBase);l.__decorate([m.property()],h.ControlPointsTransformTool.prototype,"_hasValidSpatialReference",null);l.__decorate([m.property()],h.ControlPointsTransformTool.prototype,"activeHandle",void 0);l.__decorate([m.property({constructOnly:!0,nonNullable:!0})],h.ControlPointsTransformTool.prototype,"mediaElement",void 0);l.__decorate([m.property({constructOnly:!0})],h.ControlPointsTransformTool.prototype,"view",void 0);h.ControlPointsTransformTool=l.__decorate([B.subclass("esri.views.2d.interactive.editingTools.ControlPointsTransformTool")],
h.ControlPointsTransformTool);h.KEYS=g;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../request ../../../core/asyncUtils ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/urlUtils ../../../chunks/mat3f32 ../engine/DisplayObject ../engine/webgl/DefaultVertexAttributeLayouts ../engine/webgl/enums ../engine/webgl/shaders/MagnifierPrograms ../../magnifier/resources ../../webgl/BufferObject ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor ../../webgl/VertexArrayObject".split(" "),
function(v,w,B,C,x,k,p,D,E,F,G,H,y,I,J,h,t,K,L){return function(z){function q(){var a=z.call(this)||this;a._handles=new C;a._resourcePixelRatio=1;a.visible=!1;return a}v._inherits(q,z);var l=q.prototype;l.destroy=function(){this._handles=k.destroyMaybe(this._handles);this._disposeRenderResources();this._resourcesTask=k.abortMaybe(this._resourcesTask)};l._createTransforms=function(){return{dvs:E.create()}};l.doRender=function(a){const c=a.context;if(!this._resourcesTask)this._reloadResources();else if(a.drawPhase===
H.WGLDrawPhase.MAP&&this._canRender()){this._updateResources(a);var d=this._magnifier;if(null!=d.position){var b=a.pixelRatio,m=d.size*b,e=Math.ceil(1/d.factor*m);this._readbackTexture.resize(e,e);var {size:f}=a.state;a=b*f[0];f=b*f[1];var g=.5*e,n=.5*e,r=x.clamp(b*d.position.x,g,a-g-1),A=x.clamp(f-b*d.position.y,n,f-n-1);c.setBlendingEnabled(!0);g=r-g;n=A-n;var u=this._readbackTexture;c.bindTexture(u,0);c.gl.copyTexImage2D(u.descriptor.target,0,u.descriptor.pixelFormat,g,n,e,e,0);e=(e=this.backgroundColor)?
[e.a*e.r/255,e.a*e.g/255,e.a*e.b/255,e.a]:[1,1,1,1];r=-1+(r+d.offset.x*b)/a*2;b=-1+(A-d.offset.y*b)/f*2;a=m/a*2;m=m/f*2;f=this._program;c.bindVAO(this._vertexArrayObject);c.bindTexture(this._overlayTexture,6);c.bindTexture(this._maskTexture,7);c.useProgram(f);f.setUniform4fv("u_background",e);f.setUniform1i("u_readbackTexture",0);f.setUniform1i("u_overlayTexture",6);f.setUniform1i("u_maskTexture",7);f.setUniform4f("u_drawPos",r,b,a,m);f.setUniform1i("u_maskEnabled",d.maskEnabled?1:0);f.setUniform1i("u_overlayEnabled",
d.overlayEnabled?1:0);c.setStencilTestEnabled(!1);c.setColorMask(!0,!0,!0,!0);c.drawArrays(h.PrimitiveType.TRIANGLE_STRIP,0,4);c.bindVAO()}}};l._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier};l._reloadResources=function(){this._resourcesTask&&this._resourcesTask.abort();const a=null!=this._magnifier?this._magnifier.maskUrl:null,c=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=B.createTask(async d=>{const b=null==a||null==c?I.loadMagnifierResources(d):
null,m=null!=a?w(a,{responseType:"image",signal:d}).then(g=>g.data):b.then(g=>g.mask);d=null!=c?w(c,{responseType:"image",signal:d}).then(g=>g.data):b.then(g=>g.overlay);const [e,f]=await Promise.all([m,d]);this.mask=e;this.overlay=f;this._disposeRenderResources();this.requestRender()})};l._disposeRenderResources=function(){this._readbackTexture=k.disposeMaybe(this._readbackTexture);this._overlayTexture=k.disposeMaybe(this._overlayTexture);this._maskTexture=k.disposeMaybe(this._maskTexture);this._vertexArrayObject=
k.disposeMaybe(this._vertexArrayObject);this._program=k.disposeMaybe(this._program)};l._updateResources=function(a){a.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources();if(!this._readbackTexture){var c=a.context;this._resourcePixelRatio=a.pixelRatio;var d=Math.ceil(this._magnifier.size*a.pixelRatio);this._program=y.createMagnifierProgram(c);var b=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new L.VertexArrayObject(c,y.magnifierProgramTemplate.attributes,G.Pos2us,{geometry:J.BufferObject.createVertex(c,
h.Usage.STATIC_DRAW,b)});this.overlay.width=d;this.overlay.height=d;b=new K.TextureDescriptor;b.internalFormat=h.PixelFormat.RGBA;b.wrapMode=h.TextureWrapMode.CLAMP_TO_EDGE;b.samplingMode=h.TextureSamplingMode.NEAREST;b.flipped=!0;b.preMultiplyAlpha=!D.isSVG(this.overlay.src)||!a.context.driverTest.svgPremultipliesAlpha.result;this._overlayTexture=new t.Texture(c,b,this.overlay);this.mask.width=d;this.mask.height=d;b.pixelFormat=b.internalFormat=h.PixelFormat.ALPHA;this._maskTexture=new t.Texture(c,
b,this.mask);a=1/this._magnifier.factor;b.pixelFormat=b.internalFormat=h.PixelFormat.RGBA;b.width=b.height=Math.ceil(a*d);b.samplingMode=h.TextureSamplingMode.LINEAR;b.flipped=!1;this._readbackTexture=new t.Texture(c,b)}};v._createClass(q,[{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=a;this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){this._magnifier=a;this._handles.removeAll();this._handles.add([p.watch(()=>
a.version,()=>{this.visible=a.visible&&null!=a.position&&0<a.size;this.requestRender()},p.initial),p.watch(()=>[a.maskUrl,a.overlayUrl],()=>this._reloadResources()),p.watch(()=>a.size,()=>{this._disposeRenderResources();this.requestRender()})])}}]);return q}(F.DisplayObject)});
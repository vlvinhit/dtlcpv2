// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../kernel ../Error ../Logger ../maybe ../promiseUtils ./utils ./workerFactory".split(" "),function(u,v,w,x,r,p,h,y){const {ABORT:t,INVOKE:z,OPEN:A,OPENED:B,RESPONSE:k}=h.MessageType;return function(){function m(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",b=>{b.preventDefault();x.getLogger("esri.core.workers.WorkerOwner").error(b)})}m.create=
async function(a){const c=await y.createWorker();return new m(c,a)};var d=m.prototype;d.terminate=function(){this.worker.terminate()};d.open=async function(a,c={}){const {signal:b}=c,e=h.newJobId();return new Promise((q,g)=>{const n=p.onAbortOrThrow(b,()=>{this._outJobs.delete(e);this._post({type:t,jobId:e})});this._outJobs.set(e,{resolve:q,reject:g,abortHandle:n});this._post({type:A,jobId:e,modulePath:a})})};d._onMessage=function(a){if(a=h.receiveMessage(a))switch(a.type){case B:this._onOpenedMessage(a);
break;case k:this._onResponseMessage(a);break;case t:this._onAbortMessage(a);break;case z:this._onInvokeMessage(a)}};d._onAbortMessage=function(a){const c=this._inJobs;a=a.jobId;const b=c.get(a);b&&(b.controller&&b.controller.abort(),c.delete(a))};d._onInvokeMessage=function(a){const {methodName:c,jobId:b,data:e,abortable:q}=a;a=q?new AbortController:null;const g=this._inJobs,n=v.workerMessages[c];let l;try{if("function"!==typeof n)throw new TypeError(`${c} is not a function`);l=n.call(null,e,{signal:a?
a.signal:null})}catch(f){this._post({type:k,jobId:b,error:h.toInvokeError(f)});return}p.isPromiseLike(l)?(g.set(b,{controller:a,promise:l}),l.then(f=>{g.has(b)&&(g.delete(b),this._post({type:k,jobId:b},f))},f=>{g.has(b)&&(g.delete(b),f||(f={message:"Error encountered at method"+c}),p.isAbortError(f)||this._post({type:k,jobId:b,error:h.toInvokeError(f||{message:`Error encountered at method ${c}`})}))})):this._post({type:k,jobId:b},l)};d._onOpenedMessage=function(a){const {jobId:c,data:b}=a;if(a=this._outJobs.get(c))this._outJobs.delete(c),
r.removeMaybe(a.abortHandle),a.resolve(b)};d._onResponseMessage=function(a){const {jobId:c,error:b,data:e}=a;if(a=this._outJobs.get(c))this._outJobs.delete(c),r.removeMaybe(a.abortHandle),b?a.reject(w.fromJSON(JSON.parse(b))):a.resolve(e)};d._post=function(a,c,b){return h.postMessage(this.worker,a,c,b)};return u._createClass(m)}()});
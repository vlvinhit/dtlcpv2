// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../chunks/_rollupPluginBabelHelpers","./PooledArray"],function(h,m,n){h.RemoveMode=void 0;(function(k){k[k.ALL=0]="ALL";k[k.SOME=1]="SOME"})(h.RemoveMode||(h.RemoveMode={}));let t=function(){function k(a,b,c){this.name=a;this._storage=b;this.id=`${r++}:`;this.maxSize=this.size=0;this._removeFunc=!1;this._miss=this._hit=0;this._storage.register(this);c&&(this._storage.registerRemoveFunc(this.id,c),this._removeFunc=!0)}var e=k.prototype;e.destroy=function(){this._storage.clear(this);
this._removeFunc&&this._storage.deregisterRemoveFunc(this.id);this._storage.deregister(this);this._storage=null};e.resetHitRate=function(){this._hit=this._miss=0};e.put=function(a,b,c,d=0){this._storage.put(this,a,b,c,d)};e.get=function(a){a=this._storage.get(this,a);void 0===a?++this._miss:++this._hit;return a};e.pop=function(a){a=this._storage.pop(this,a);void 0===a?++this._miss:++this._hit;return a};e.updateSize=function(a,b,c){this._storage.updateSize(this,a,b,c)};e.clear=function(){this._storage.clear(this)};
e.clearAll=function(){this._storage.clearAll()};e.resetStats=function(){this._storage.resetStats()};m._createClass(k,[{key:"hitRate",get:function(){return this._hit/(this._hit+this._miss)}},{key:"sizeAll",get:function(){return this._storage.size}},{key:"performanceInfo",get:function(){return this._storage.performanceInfo}}]);return k}(),w=function(){function k(a=10485760){this._maxSize=a;this._db=new Map;this._miss=this._hit=this._size=0;this._removeFuncs=new n;this._users=new n}var e=k.prototype;
e.destroy=function(){this.clearAll();this._removeFuncs.clear();this._users.clear();this._db=null};e.register=function(a){this._users.push(a)};e.deregister=function(a){this._users.removeUnordered(a)};e.registerRemoveFunc=function(a,b){this._removeFuncs.push([a,b])};e.deregisterRemoveFunc=function(a){this._removeFuncs.filterInPlace(b=>b[0]!==a)};e.put=function(a,b,c,d,g){b=a.id+b;const f=this._db.get(b);f&&(this._size-=f.size,a.size-=f.size,this._db.delete(b),f.entry!==c&&this._notifyRemove(b,f.entry,
h.RemoveMode.ALL));d>this._maxSize?this._notifyRemove(b,c,h.RemoveMode.ALL):void 0===c?console.warn("Refusing to cache undefined entry "):!d||0>d?console.warn("Refusing to cache entry with invalid size "+d):(g=1+Math.max(g,-3)- -3,this._db.set(b,{entry:c,size:d,lifetime:g,lives:g}),this._size+=d,a.size+=d,this._checkSizeLimits())};e.updateSize=function(a,b,c,d){b=a.id+b;const g=this._db.get(b);if(g&&g.entry===c){this._size-=g.size;for(a.size-=g.size;d>this._maxSize;)if(d=this._notifyRemove(b,c,h.RemoveMode.SOME),
!(null!=d&&0<d)){this._db.delete(b);return}g.size=d;this._size+=d;a.size+=d;this._checkSizeLimits()}};e.pop=function(a,b){b=a.id+b;const c=this._db.get(b);if(c)return this._size-=c.size,a.size-=c.size,this._db.delete(b),++this._hit,c.entry;++this._miss};e.get=function(a,b){b=a.id+b;a=this._db.get(b);if(void 0===a)++this._miss;else return this._db.delete(b),a.lives=a.lifetime,this._db.set(b,a),++this._hit,a.entry};e.resetStats=function(){this._hit=this._miss=0;this._users.forAll(a=>a.resetHitRate())};
e.clear=function(a){const b=a.id;this._db.forEach((c,d)=>{d.startsWith(b)&&(this._size-=c.size,this._db.delete(d),this._notifyRemove(d,c.entry,h.RemoveMode.ALL))});a.size=0};e.clearAll=function(){this._db.forEach((a,b)=>this._notifyRemove(b,a.entry,h.RemoveMode.ALL));this._users.forEach(a=>a.size=0);this._size=0;this._db.clear()};e._getHitRate=function(){return this._hit/(this._hit+this._miss)};e._notifyRemove=function(a,b,c){let d;this._removeFuncs.some(g=>a.startsWith(g[0])?(g=g[1](b,c),"number"===
typeof g&&(d=g),!0):!1);return d};e._checkSizeLimits=function(){if(this._size>this._maxSize)for(const [a,b]of this._db)if(this._purgeItem(a,b),this._size<=.9*this.maxSize)return;this._users.forEach(a=>{if(0<a.maxSize&&a.size>a.maxSize)for(const [b,c]of this._db)if(b.startsWith(a.id)&&(this._purgeItem(b,c,a),a.size<=.9*a.maxSize))break})};e._purgeItem=function(a,b,c=this._users.find(d=>a.startsWith(d.id))){this._db.delete(a);if(1>=b.lives){this._size-=b.size;c&&(c.size-=b.size);const d=this._notifyRemove(a,
b.entry,h.RemoveMode.SOME);null!=d&&0<d&&(this._size+=d,c&&(c.size+=d),b.lives=b.lifetime,b.size=d,this._db.set(a,b))}else--b.lives,this._db.set(a,b)};m._createClass(k,[{key:"size",get:function(){return this._size}},{key:"maxSize",get:function(){return this._maxSize},set:function(a){this._maxSize=Math.max(a,0);this._checkSizeLimits()}},{key:"performanceInfo",get:function(){const a={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+
"%",Entries:this._db.size.toString()},b={},c=[];this._db.forEach((f,l)=>{const p=f.lifetime;c[p]=(c[p]||0)+f.size;this._users.forAll(u=>{const {id:v,name:q}=u;l.startsWith(v)&&(b[q]=(b[q]||0)+f.size)})});const d={};this._users.forAll(f=>{const l=f.name;"hitRate"in f&&"number"===typeof f.hitRate&&!isNaN(f.hitRate)&&0<f.hitRate?(b[l]=b[l]||0,d[l]=Math.round(100*f.hitRate)+"%"):d[l]="0%"});var g=Object.keys(b);g.sort((f,l)=>b[l]-b[f]);g.forEach(f=>a[f]=Math.round(b[f]/2**20)+"MB / "+d[f]);for(g=c.length-
1;0<=g;--g){const f=c[g];f&&(a["Priority "+(g+-3-1)]=Math.round(f/this._size*100)+"%")}return a}}]);return k}(),r=0;h.MIN_PRIORITY=-3;h.MemCache=t;h.MemCacheStorage=w;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
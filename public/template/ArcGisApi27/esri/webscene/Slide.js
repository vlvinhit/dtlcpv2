// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../Basemap ../Viewpoint ../core/asyncUtils ../core/Collection ../core/collectionUtils ../core/JSONSupport ../core/Logger ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/decorators/cast ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ../core/accessorSupport/ensureType ../chunks/vec3 ../chunks/vec3f64 ../layers/Layer ../layers/mixins/OperationalLayer ../support/basemapUtils ../views/3d/support/mathUtils ../views/3d/support/viewpointUtils ../views/support/Scheduler ../webdoc/support/SlideThumbnail ./SunLighting ./VirtualLighting ./support/Description ./support/SlideEnvironment ./support/SlideGround ./support/SlideVisibleLayer ./support/Title".split(" "),
function(D,h,Q,R,S,E,T,f,U,F,v,V,m,r,ja,ka,W,y,G,z,X,Y,H,Z,aa,ba,q,ca,da,w,I,J,K,t){function L(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers.toArray()}function M(e){if(e=L(e))return e.filter(l=>l.visible).map(l=>l.id)}function ea(e,l){e=l-e;43200<e&&(e-=86400);-43200>e&&(e+=86400);return e}let fa=0;const A=E.ofType(K.SlideVisibleLayer);f=function(e){function l(a){a=e.call(this,a)||this;a.id=Date.now().toString(16)+"-slide-"+fa++;a.title=new t;a.description=new w;a.thumbnail=
new q.SlideThumbnail;a.viewpoint=null;a.basemap=null;a.ground=null;a.environment=new I.SlideEnvironment;a.visibleLayers=new A;return a}D._inherits(l,e);var d=l.prototype;d.destroy=function(){this.visibleLayers.removeAll();this.basemap?.destroy();this.basemap=null;this.thumbnail=F.destroyMaybe(this.thumbnail);this.thumbnail=this.title=this.description=null};d.castTitle=function(a){return"string"===typeof a?new t({text:a}):y.ensureType(t,a)};d.castDescription=function(a){return"string"===typeof a?new w({text:a}):
y.ensureType(w,a)};d.castThumbnail=function(a){return"string"===typeof a?new q.SlideThumbnail({url:a}):y.ensureType(q.SlideThumbnail,a)};d.castBasemap=function(a){return H.ensureType(a)};d.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(b=>{if("string"===typeof b)return{id:b};if(b instanceof X){const c=M(b);return{id:b.id,sublayerIds:c}}if(b.id)return{id:b.id,sublayerIds:"sublayerIds"in b?b.sublayerIds:void 0};U.getLogger(this).warn('Invalid visible layer, expected { id }, Layer or "id"');
return b}):null};d.clone=function(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};d._updateVisibleLayersFrom=function(a){const b=[];return v.eachAlways(this._getLayers(a.map).map(c=>
a.whenLayerView(c).then(k=>{if(k.visible){const g=M(c);b.push(new K.SlideVisibleLayer({id:k.layer.id,sublayerIds:g}))}})).toArray()).then(()=>{this.visibleLayers.removeAll();this.visibleLayers.addMany(b)})};d.updateFrom=function(a,b){const c={format:"png",quality:80,width:120,height:75,disableDecorations:!0,...(b&&b.screenshot)};return a.when(()=>{this.viewpoint=a.viewpoint.clone();this.environment.lighting="virtual"===a.environment.lighting.type?da.prototype.clone.apply(a.environment.lighting):ca.prototype.clone.apply(a.environment.lighting);
this.environment.weather=a.environment.weather.clone();this.basemap=a.map.basemap&&a.map.basemap.clone()||null;this.ground=a.map.ground?J.fromGround(a.map.ground):null;return this._updateVisibleLayersFrom(a)}).then(()=>a.takeScreenshot(c)).then(k=>{this.thumbnail=new q.SlideThumbnail({url:k.dataUrl});return this})};d.applyTo=async function(a,b){null!=this._applyToController&&this._applyToController.abort();let c=new AbortController;this._applyToController=c;const k=v.onAbortOrThrow(b,()=>c?.abort()),
g=a.resourceController.scheduler.registerTask(ba.TaskPriority.SLIDE);let x=!1;const n={animate:!0,...b,signal:this._applyToController.signal};b=await S.result(a.addUpdatingPromise((async()=>{await Promise.all([g.schedule(()=>x=this._setViewpointOfInterest(a,n)),g.schedule(()=>this._applyBasemap(a,n),n.signal)]);await this._loadLayersWithSublayerVisibility(a);await Promise.all([g.schedule(()=>this._applyLayerVisibility(a),n.signal),g.schedule(()=>this._applyGround(a),n.signal),g.schedule(()=>this._applyViewpoint(a,
n),n.signal)]);await g.schedule(()=>a.environment.weather=this.environment.weather.clone())})()));x&&(a.contentCamera=null);g.remove();this._applyToController===c&&(this._applyToController=null);c=null;k?.remove();if(!1===b.ok)throw b.error;return this};d._applyBasemap=async function(a,b){if(this.basemap){try{await this.basemap.load(b)}catch(c){if(v.isAbortError(c))throw c;}a.map.basemap=H.clonePreservingTiledLayers(this.basemap,a.map.basemap)}};d._applyGround=function(a){this.ground&&(a.map.ground=
this.ground.cloneAndApplyTo(a.map.ground))};d._getLayers=function(a){const b=new E;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};d._collectLayers=function(a,b){a.layers.forEach(c=>{Y.isOperationalLayer(c)&&(b.add(c),"layers"in c&&this._collectLayers(c,b))})};d._loadLayersWithSublayerVisibility=async function(a){this.visibleLayers&&await v.eachAlways(this._getLayers(a.map).map(b=>this.visibleLayers.find(c=>c.id===b.id)?.sublayerIds?b.load():null))};d._applyLayerVisibility=function(a){this.visibleLayers&&
this._getLayers(a.map).forEach(b=>{var c=this.visibleLayers.find(g=>g.id===b.id);b.visible=null!=c;const k=c?.sublayerIds;c=L(b);k&&c&&c.forEach(g=>g.visible=k.includes(g.id))})};d._setViewpointOfInterest=function(a,b){if(a.state.fixedContentCamera||!this.viewpoint||b?.ignoreViewpoint||!b?.useDestinationCamera)return!1;b=aa.toCamera(a,this.viewpoint);a.contentCamera=b;return null!=b};d._applyViewpoint=async function(a,b){this._applyCachedCameraTrackingEnabled(a);if(this.viewpoint&&!b.ignoreViewpoint){null!=
this.viewpoint.camera&&(this.viewpoint.camera.fov=a.camera.fov);if(b.animate&&this.get("environment.lighting.date"))return this._animateToLighting(a,b);b.animate&&(a.environment.applyLighting(this.environment.lighting.clone()),await a.goTo(this.viewpoint,b));a.viewpoint=this.viewpoint}a.environment.applyLighting(this.environment.lighting.clone())};d._animateToLighting=async function(a,b){let c=null;"virtual"!==a.environment.lighting.type&&"virtual"!==this.environment.lighting.type&&("global"===a.viewingMode&&
(c=this._animateLightingWithCamera(a,a.environment.lighting,this.environment.lighting)),a.environment.cachedCameraTrackingEnabled=a.environment.lighting.cameraTrackingEnabled,a.environment.lighting.cameraTrackingEnabled=!1);a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;"virtual"===this.environment.lighting.type||"virtual"===a.environment.lighting.type?(a.environment.applyLighting(this.environment.lighting.clone()),"virtual"!==a.environment.lighting.type&&
(a.environment.cachedCameraTrackingEnabled=a.environment.lighting.cameraTrackingEnabled,a.environment.lighting.cameraTrackingEnabled=!1)):null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);return a.goTo(this.viewpoint,b).then(()=>{this._applyCachedCameraTrackingEnabled(a);a.environment.applyLighting(this.environment.lighting.clone())}).catch(k=>{null==a.animation&&this._applyCachedCameraTrackingEnabled(a);throw k;
}).finally(()=>{F.removeMaybe(c)})};d._applyCachedCameraTrackingEnabled=function(a){null!=a.environment.cachedCameraTrackingEnabled&&(a.environment.lighting.cameraTrackingEnabled=a.environment.cachedCameraTrackingEnabled,a.environment.cachedCameraTrackingEnabled=null)};d._getTime=function(a){const b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};d._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);
return a};d._animateLightingWithCamera=function(a,b,c){const [k,g]=this._getTime(new Date(b.date.toString())),[x,n]=this._getTime(c.date),ha=ea(g,n),B=a.renderCoordsHelper,N=z.create();B.toRenderCoords(a.camera.position,N);const O=z.create(),C=z.create();null!=this.viewpoint.camera&&B.toRenderCoords(this.viewpoint.camera.position,O);const ia=new Date;return V.when(()=>a.camera,p=>{B.toRenderCoords(p.position,C);var u=G.squaredDistance(N,C);const P=G.squaredDistance(O,C);p=0;0!==u+P&&(p=u/(u+P));u=
k+(x-k)*p;p=Z.moduloPositive(g+ha*p,86400);b.date=this._setTime(ia,u,p)})};l.createFrom=function(a,b){return(new this).updateFrom(a,b)};D._createClass(l,[{key:"visibleLayers",set:function(a){this._set("visibleLayers",T.referenceSetter(a,this._get("visibleLayers"),A))}}]);return l}(f.JSONSupport);h.__decorate([m.property({type:String,json:{write:{isRequired:!0}}})],f.prototype,"id",void 0);h.__decorate([m.property({type:t,json:{default:()=>new t({text:""}),write:{isRequired:!0}}})],f.prototype,"title",
void 0);h.__decorate([r.cast("title")],f.prototype,"castTitle",null);h.__decorate([m.property({type:w,json:{write:{overridePolicy(e){return{enabled:!(!e||!e.text)}}}}})],f.prototype,"description",void 0);h.__decorate([r.cast("description")],f.prototype,"castDescription",null);h.__decorate([m.property({type:q.SlideThumbnail,json:{default:()=>new q.SlideThumbnail({url:""}),write:{isRequired:!0}}})],f.prototype,"thumbnail",void 0);h.__decorate([r.cast("thumbnail")],f.prototype,"castThumbnail",null);
h.__decorate([m.property({type:R,nonNullable:!0,json:{write:{isRequired:!0}}})],f.prototype,"viewpoint",void 0);h.__decorate([m.property({type:Q,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],f.prototype,"basemap",void 0);h.__decorate([r.cast("basemap")],f.prototype,"castBasemap",null);h.__decorate([m.property({type:J,json:{write:!0}})],f.prototype,"ground",void 0);h.__decorate([m.property({type:A,json:{write:{isRequired:!0}}})],f.prototype,"visibleLayers",null);h.__decorate([r.cast("visibleLayers")],
f.prototype,"castVisibleLayers",null);h.__decorate([m.property({type:I.SlideEnvironment,json:{write:!0}})],f.prototype,"environment",void 0);return f=h.__decorate([W.subclass("esri.webscene.Slide")],f)});
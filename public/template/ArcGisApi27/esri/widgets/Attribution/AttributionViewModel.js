// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Collection ../../core/HandleOwner ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/Extent ../../geometry/SpatialReference ../../geometry/support/contains ../../geometry/support/webMercatorUtils".split(" "),function(x,u,B,y,n,v,w,H,I,J,C,D,
E,F,z){function A(g,h){return g&&"copyright"in g&&(!h||"function"===typeof g.originOf&&"user"===g.originOf("copyright"))}function G(g,h){return g.length!==h.length||g.some((k,c)=>k.text!==h[c].text)}function r(g,h,k){k&&h&&(g.find(c=>c.layerView===h&&c.text===k)||g.push({text:k,layerView:h}))}const l=[];n=function(g){function h(c){var a=g.call(this,c)||this;a._clear=()=>{a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};a._pendingAttributions=
new Set;a._fetchedAttributionData=new Map;a.items=new y;a.view=null;a._allLayerViewsChange=b=>{a.handles.remove("suspension");const e=a.get("view.allLayerViews");e&&a.handles.add(e.map(d=>v.watch(()=>[d.suspended,d.layer?.attributionVisible],()=>a._updateAttributionItems())),"suspension");b&&b.removed&&b.removed.forEach(d=>{a._pendingAttributions.delete(d);a._fetchedAttributionData.delete(d)});a._updateAttributionItems()};a.handles.add([v.on(()=>a.view?.allLayerViews,"change",b=>a._allLayerViewsChange(b),
{onListenerAdd:()=>a._allLayerViewsChange(),onListenerRemove:a._clear}),v.when(()=>!0===a.view?.stationary,()=>a._updateAttributionItems())]);return a}x._inherits(h,g);var k=h.prototype;k.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};k._updateAttributionItems=function(){const c=this.view,a=c?.allLayerViews;l.length=0;c&&a?(a.forEach(b=>{if(!b.suspended&&b.layer?.attributionVisible){var e=b.layer;if(A(e,"user"))r(l,
b,e.copyright);else if(e.hasAttributionData)if(this._fetchedAttributionData.has(b)){var d=this._fetchedAttributionData.get(b);d?r(l,b,this._getDynamicAttribution(d,c,e)):A(e)&&r(l,b,e.copyright)}else this._fetchAttributionData(b);else(d=e.get("portalItem.accessInformation"))?r(l,b,d):r(l,b,e.copyright)}}),G(this.items,l)&&(this.items.removeAll(),this.items.addMany(l)),l.length=0,this.notifyChange("state")):this._clear()};k._fetchAttributionData=async function(c){if(!this._pendingAttributions.has(c)){this._pendingAttributions.add(c);
var a=await B.result(c.layer.fetchAttributionData());this._pendingAttributions.has(c)&&(a=a.ok?this._createContributionIndex(a.value,"bing-maps"===c.layer.type):null,this._pendingAttributions.delete(c),this._fetchedAttributionData.set(c,a));this._updateAttributionItems()}};k._createContributionIndex=function(c,a){c=c.contributors;const b={};if(!c)return b;for(let f=0;f<c.length;f++){const m=c[f];var e=m.coverageAreas;if(!e)return;for(const p of e){var d=p.bbox,q=p.zoomMin-(a&&p.zoomMin?1:0);e=p.zoomMax-
(a&&p.zoomMax?1:0);d=new D({xmin:d[1],ymin:d[0],xmax:d[3],ymax:d[2],spatialReference:E.WGS84});for(d={extent:z.geographicToWebMercator(d),attribution:m.attribution||"",score:null!=p.score?p.score:100,id:f};q<=e;q++){var t;b[t=q]??(b[t]=[]);b[q].push(d)}}}b.maxKey=Math.max.apply(null,Object.keys(b));return b};k._getDynamicAttribution=function(c,a,b){const {extent:e,scale:d}=a;b=b.tileInfo?.scaleToZoom(d)??0;b=Math.min(c.maxKey??0,Math.round(b));if(!e||null==b||-1>=b)return"";c=c[b];const q=z.project(e.center.clone().normalize(),
a.spatialReference),t=new Set;return c?c.filter(f=>{const m=f.id;(f=!t.has(m)&&q&&f.extent&&F.extentContainsPoint(f.extent,q))&&t.add(m);return f}).sort((f,m)=>m.score-f.score||f.objectId-m.objectId).map(f=>f.attribution).join(", "):""};x._createClass(h,[{key:"state",get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"}}]);return h}(n.HandleOwner);u.__decorate([w.property({readOnly:!0,type:y})],n.prototype,"items",void 0);u.__decorate([w.property({readOnly:!0})],
n.prototype,"state",null);u.__decorate([w.property()],n.prototype,"view",void 0);return n=u.__decorate([C.subclass("esri.widgets.Attribution.AttributionViewModel")],n)});
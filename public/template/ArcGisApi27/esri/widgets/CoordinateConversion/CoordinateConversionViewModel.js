// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../assets ../../Graphic ../../intl ../../core/Collection ../../core/Error ../../core/Evented ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/cast ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/Point ../../geometry/projection ../../symbols/PictureMarkerSymbol ./support/Conversion ./support/coordinateConversionUtils ./support/formatUtils ../support/GoTo ../../intl/locale ../../intl/messages".split(" "),
function(l,f,C,D,e,u,m,E,v,q,g,F,O,P,G,z,H,I,w,A,x,J,y,K){async function B(n,p){try{n.position=await n.format?.convert(p)}catch(c){n.position=null}return n}const L=new z([0,0,500]),M="mgrs utm usng dd dms ddm".split(" ");e=function(n){function p(a){a=n.call(this,a)||this;a._conversionPromise=null;a._locationGraphic=null;a._pointerCount=0;a.conversions=new u;a.formats=new u;a.formatterAvailable=!1;a.messages=null;a.filteredFormats=new u;a.locationSymbol=new I({url:C.getAssetUrl("esri/images/search/search-symbol-32.png"),
width:24,height:24});a.storageEnabled=!0;a.storageType="session";a.view=null;a._saveWidgetState=a._saveWidgetState.bind(l._assertThisInitialized(a));a._handleFormatChange=a._handleFormatChange.bind(l._assertThisInitialized(a));a._handleConversionChange=a._handleConversionChange.bind(l._assertThisInitialized(a));a._handleViewChange=a._handleViewChange.bind(l._assertThisInitialized(a));a._onClick=a._onClick.bind(l._assertThisInitialized(a));a._onPointerMove=a._onPointerMove.bind(l._assertThisInitialized(a));
a._onPointerDown=a._onPointerDown.bind(l._assertThisInitialized(a));a._onPointerUp=a._onPointerUp.bind(l._assertThisInitialized(a));return a}l._inherits(p,n);var c=p.prototype;c.initialize=function(){const a=async()=>this.messages=await K.fetchMessageBundle("esri/widgets/CoordinateConversion/t9n/CoordinateConversion");this.formats.addMany(x.generateDefaultFormats());a().then(()=>{if(!this.destroyed&&(x.setDefaultPatterns(this.messages,this.formats),this.storageEnabled&&this._loadWidgetState(),this.formats.forEach(b=>
{b.viewModel=this;this.addHandles(q.watch(()=>b.currentPattern,this._saveWidgetState),b.name??"unnamed-format")}),this.addHandles(this.conversions.on("change",this._handleConversionChange),"conversions"),this.addHandles(this.formats.on("change",this._handleFormatChange),"formats"),this.addHandles(y.onLocaleChange(()=>{a().then(()=>{x.setDefaultPatterns(this.messages,this.formats)})})),H.load().then(()=>{this.formatterAvailable=!0}).catch(b=>{v.getLogger(this).error(new m("coordinate-conversion:projection-load-failed",
"Failed to load the projection module.",{error:b}));this.formatterAvailable=!1;this._filterFormatsAndConversions()}).then(()=>this.addHandles(q.watch(()=>this.view,this._handleViewChange,q.initial),"view-change")),0===this.conversions.length)){const b=this.formats.find(d=>"xy"===d.name)||this.formats.at(0);this.conversions.add(new w({format:b}))}})};c.destroy=function(){this.removeHandles();this._cleanUpView(this.view);this.view=null};c.castConversions=function(a){return this._castToConversions(a)};
c.setLocation=function(a){this._locationGraphic&&this.view?.graphics.remove(this._locationGraphic);a&&(a=a.clone(),a.hasZ&&(a.z=void 0),this._locationGraphic=new D({geometry:a,symbol:this.locationSymbol}),this.view?.graphics.add(this._locationGraphic))};c.convert=async function(a,b){if(!A.isValidPoint(b))throw new m("coordinate-conversion:invalid-point","Invalid point cannot be converted.",{point:b});return Promise.resolve().then(()=>a.convert(b))};c.goToLocation=async function(a){var {view:b}=this;
if(!b)throw new m("coordinate-conversion:go-to-failed","no view");var d="3d"===b.type?b.clippingArea:null;b=b.map?.basemap?.baseLayers;if(d||0<b?.length)if(d=d??b.at(0)?.fullExtent,null!=d&&!d.contains(a))throw new m("coordinate-conversion:go-to-failed","Point outside basemap extent.",{point:a});return this.callGoTo({target:a})};c.pause=function(){this.currentLocation=null;this.removeHandles("view");this.view&&(this.view.cursor="default",this._locationGraphic&&this.view.graphics.remove(this._locationGraphic))};
c.previewConversion=async function(a,b=this.currentLocation||L){return(await B(a,b)).displayCoordinate};c.resume=function(){"capture"===this.mode?this._startCaptureMode():this._startLiveMode()};c.reverseConvert=function(a,b){return b.reverseConvert(a)};c.updateConversions=async function(a,b){if("point"!==b?.type)throw this._clearConversions(this.conversions),new m("coordinate-conversion:invalid-input-point","Point is invalid, conversions cannot be updated.",{point:b});return this._convertMany(a,b)};
c._castToConversions=function(a){const b=new u;a.forEach(d=>{let h=null;if(d instanceof w)h=d;else if("string"===typeof d){const t=this.formats.find(r=>r.name===d);t&&(h=new w({format:t}))}h&&b.add(h)});return b};c._cleanUpView=function(a){a&&(this._locationGraphic&&a.graphics.remove(this._locationGraphic),this.removeHandles("view"),a.cursor="default")};c._clearConversions=function(a){a.forEach(b=>{b.position={location:null,coordinate:null}})};c._convertMany=async function(a,b){return Promise.all(a.map(d=>
B(d,b)))};c._handleConversionChange=function(a){for(const b of a.added)({format:a}=b),a&&(a.viewModel=this,this.currentLocation&&(this._set("waitingForConversions",!0),this.convert(a,this.currentLocation).then(d=>{b.position=d;this._set("waitingForConversions",!1)})));this._saveWidgetState()};c._handleFormatChange=function(a){a.added.forEach(b=>{this.addHandles(q.watch(()=>b.currentPattern,this._saveWidgetState),b.name??"unnamed-format");b.viewModel=this});a.removed.forEach(b=>{b.viewModel=null;const d=
this.conversions.filter(h=>h.format===b);this.conversions.removeMany(d);b.name&&this.removeHandles(b.name)})};c._loadWidgetState=function(){try{const a=JSON.parse(this.storage.getItem("esri__coordinateConversionWidgetState"));a&&this._setWidgetState(a)}catch(a){v.getLogger(this).error(new m("coordinate-conversion:invalid-session-storage-json","Could not read from storage.",{error:a}))}};c._startCaptureMode=function(){this.removeHandles("view");this.view&&(this.view.cursor="crosshair",this.currentLocation&&
this.setLocation(this.currentLocation),this.addHandles(this.view.on("click",this._onClick),"view"))};c._startLiveMode=function(){this._pointerCount=0;this.removeHandles("view");this.view&&(this.view.cursor="default",this._locationGraphic&&this.view.graphics.remove(this._locationGraphic),this.addHandles([this.view.on("pointer-down",this._onPointerDown),this.view.on("pointer-up",this._onPointerUp),this.view.on("pointer-move",this._onPointerMove)],"view"))};c._handleViewChange=function(a,b){b&&b!==a&&
this._cleanUpView(b);a&&("capture"===this.mode?this._startCaptureMode():this._startLiveMode(),b&&this._filterFormatsAndConversions())};c._onClick=function(a){0===a.button&&(a=this.view?.toMap(a)?.normalize(),this.setLocation(a),this.currentLocation=a)};c._onPointerDown=function(a){const {pointerType:b}=a;this._pointerCount++;"touch"!==b&&"pen"!==b||1!==this._pointerCount||(this.currentLocation=this.view?.toMap(a)?.normalize())};c._onPointerMove=function(a){const {pointerType:b}=a;if("mouse"===b||
1===this._pointerCount)this.currentLocation=this.view?.toMap(a)?.normalize()};c._onPointerUp=function(){this._pointerCount--};c._setWidgetState=function(a){try{a.formats.forEach(b=>{const d=this.formats.find(h=>h.name===b.name);d&&a.locale===y.getLocale()&&b.currentPattern&&(d.currentPattern=b.currentPattern);d&&0<=b.index&&this.conversions.add(new w({format:d}))})}catch(b){v.getLogger(this).warn(new m("coordinate-conversion:session-storage-read-error","Could not get widget state from stored JSON.",
{error:b}))}};c._saveWidgetState=function(){if(this.storageEnabled){var a=this._toJSON();try{this.storage.setItem("esri__coordinateConversionWidgetState",JSON.stringify({formats:a,locale:y.getLocale()}))}catch(b){v.getLogger(this).error(new m("coordinate-conversion:local-storage-write-error","Could not write to localStorage.",{error:b}))}}};c._updateConversions=async function(){try{await this.updateConversions(this.conversions.toArray(),this.currentLocation)}catch{}};c._toJSON=function(){return this.formats.filter(a=>
{a=a.name;return"xy"===a||"basemap"===a||A.isSupportedNotation(a)}).map(a=>({name:a.name,currentPattern:a.currentPattern,defaultPattern:a.defaultPattern,index:this.conversions.findIndex(b=>b.format===a)})).sort((a,b)=>a.index-b.index).toArray()};c._filterFormatsAndConversions=function(){const {formatterAvailable:a,conversions:b,formats:d}=this;a||this.addHandles(q.when(()=>this.view?.spatialReference,h=>{const t=h.isWebMercator||h.isWGS84,r=d.filter(k=>{({name:k}=k);return M.includes(k)?!0:"xy"===
k?!t:!1});h=this.filteredFormats.filter(k=>"xy"===k.name&&t&&!this.formats.includes(k));const N=b.filter(k=>r.includes(k.format));d.removeMany(r);b.removeMany(N);this.filteredFormats.addMany(r.filter(k=>!this.filteredFormats.includes(k)));d.addMany(h)},{once:!0,initial:!0}),"view")};l._createClass(p,[{key:"currentLocation",get:function(){return this._get("currentLocation")||null},set:function(a){this._set("currentLocation",a);this._updateConversions()}},{key:"mode",get:function(){return this._get("mode")||
"live"},set:function(a){switch(a){case "capture":this.currentLocation=null;this._startCaptureMode();this._set("mode",a);break;case "live":this._startLiveMode(),this._set("mode",a)}}},{key:"state",get:function(){const {messages:a,view:b}=this;return a?b?.ready?"ready":b?"loading":"disabled":"disabled"}},{key:"storage",get:function(){const {storageType:a}=this;return"session"===a?sessionStorage:localStorage}},{key:"waitingForConversions",get:function(){return null!=this._conversionPromise}}]);return p}(J.GoToMixin(E.EventedAccessor));
f.__decorate([g.property()],e.prototype,"conversions",void 0);f.__decorate([F.cast("conversions")],e.prototype,"castConversions",null);f.__decorate([g.property({type:z})],e.prototype,"currentLocation",null);f.__decorate([g.property()],e.prototype,"formats",void 0);f.__decorate([g.property()],e.prototype,"messages",void 0);f.__decorate([g.property()],e.prototype,"mode",null);f.__decorate([g.property()],e.prototype,"filteredFormats",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"state",
null);f.__decorate([g.property()],e.prototype,"locationSymbol",void 0);f.__decorate([g.property({readOnly:!0,dependsOn:["storageType"]})],e.prototype,"storage",null);f.__decorate([g.property()],e.prototype,"storageEnabled",void 0);f.__decorate([g.property()],e.prototype,"storageType",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"waitingForConversions",null);f.__decorate([g.property()],e.prototype,"view",void 0);return e=f.__decorate([G.subclass("esri.widgets.CoordinateConversion.CoordinateConversionViewModel")],
e)});
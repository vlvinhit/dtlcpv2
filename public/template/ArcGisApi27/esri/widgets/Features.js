// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../intl ../core/Collection ../core/events ../core/Logger ../core/reactiveUtils ../core/throttle ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ./Feature ./Spinner ./Widget ./Feature/resources ./Feature/support/FeatureContentMixin ./Features/FeaturesViewModel ./Features/FeaturesVisibleElements ./Popup/actionUtils ./support/componentsUtils ./support/widgetUtils ./support/decorators/messageBundle ./support/decorators/vmEvent ./support/jsxFactory ../intl/substitute".split(" "),
function(p,u,h,g,A,B,v,n,C,k,M,N,O,D,E,F,G,H,I,w,x,J,K,P,y,L,f,q){g=function(z){function r(a,c){var b=z.call(this,a,c)||this;b._featureMenuIntersectionObserverCallback=([e])=>{e?.isIntersecting&&null!=b.viewModel.featurePage&&b.viewModel.featurePage++};b._featureMenuIntersectionObserver=new IntersectionObserver(b._featureMenuIntersectionObserverCallback,{root:window.document});b._featureMenuIntersectionObserverNode=null;b._focusFeatureMenuFlowItem=!1;b._spinner=null;b._feature=null;b._relatedRecordsFlowItems=
new A;b._focusRootFlowItem=!1;b._rootFlowItemNode=null;b._featureMenuViewportNode=null;b._exitRelatedRecordsActions=new WeakMap;b._featureSelectionActions=new WeakMap;b.icon=null;b.headingLevel=2;b.messages=null;b.messagesCommon=null;b.viewModel=new w;b.visibleElements=new x;b._renderAction=(e,l)=>{const m=b._getActionTitle(e);return f.tsx("calcite-action",{appearance:"solid",bind:u._assertThisInitialized(b),icon:b._getActionIcon(e),onclick:b._triggerAction,"data-action-uid":e.uid,disabled:e.disabled,
indicator:e.indicator,loading:e.active,active:"toggle"===e.type?e.value:!1,key:`action-${l}`,text:m},f.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:m,slot:"tooltip"},m))};b._openFeatureMenu=()=>{b.featureMenuOpen=!0};b._previousFeature=()=>{b.viewModel.selectedFeatureIndex--};b._nextFeature=()=>{b.viewModel.selectedFeatureIndex++};b._handleFeatureMenuBack=()=>{b._focusRootFlowItem=!0;b.featureMenuOpen=!1;b.viewModel.browseClusterEnabled=!1};b._handleOpenRelatedFeature=
e=>{b._openRelatedFeature(e)};b._displaySpinnerThrottled=C.throttle(()=>b._displaySpinner(),0);b._addSelectedFeatureIndexHandle();b.addHandles([b._displaySpinnerThrottled,n.watch(()=>b.viewModel?.active,()=>b._toggleScreenLocationEnabled()),n.watch(()=>b.visibleElements?.spinner,e=>b._spinnerEnabledChange(e)),n.watch(()=>b.viewModel?.view,(e,l)=>b._viewChange(e,l)),n.watch(()=>b.viewModel?.view?.ready,(e,l)=>b._viewReadyChange(e??!1,l??!1)),n.watch(()=>[b.viewModel?.waitingForResult,b.viewModel?.location],
()=>{b._hideSpinner();b._displaySpinnerThrottled()}),n.watch(()=>b.selectedFeatureWidget,()=>b._destroyRelatedRecordsFlowItemWidgets()),n.watch(()=>{const e=b.selectedFeatureWidget?.viewModel;return[e?.title,e?.state]},()=>b._setTitleFromFeatureWidget()),n.watch(()=>{const e=b.selectedFeatureWidget?.viewModel;return[e?.content,e?.state]},()=>b._setContentFromFeatureWidget()),n.watch(()=>b.viewModel?.featureViewModels,()=>b._featureMenuViewportScrollTop())]);return b}u._inherits(r,z);var d=r.prototype;
d.loadDependencies=function(){return K.loadCalciteComponents({action:()=>new Promise((a,c)=>p(["../chunks/calcite-action"],a,c)),"action-bar":()=>new Promise((a,c)=>p(["../chunks/calcite-action-bar"],a,c)),"action-group":()=>new Promise((a,c)=>p(["../chunks/calcite-action-group"],a,c)),button:()=>new Promise((a,c)=>p(["../chunks/calcite-button"],a,c)),flow:()=>new Promise((a,c)=>p(["../chunks/calcite-flow"],a,c)),"flow-item":()=>new Promise((a,c)=>p(["../chunks/calcite-flow-item"],a,c)),list:()=>
new Promise((a,c)=>p(["../chunks/calcite-list"],a,c)),"list-item":()=>new Promise((a,c)=>p(["../chunks/calcite-list-item"],a,c)),tooltip:()=>new Promise((a,c)=>p(["../chunks/calcite-tooltip"],a,c))})};d.destroy=function(){this._destroyRelatedRecordsFlowItemWidgets();this._destroySelectedFeatureWidget();this._destroySpinner();this._unobserveFeatureMenuObserver();this._featureMenuIntersectionObserver?.disconnect()};d.blur=function(){const {active:a}=this.viewModel;a||v.getLogger(this.declaredClass).warn("Features can only be blurred when currently active.");
this._rootFlowItemNode?.blur()};d.clear=function(){return this.viewModel.clear()};d.close=function(){this.viewModel.visible=!1};d.fetchFeatures=function(a,c){return this.viewModel.fetchFeatures(a,c)};d.focus=function(){var {container:a}=this;const {active:c}=this.viewModel;c||v.getLogger(this.declaredClass).warn("Features can only be blurred when currently active.");if(a){a=a.querySelectorAll("calcite-flow-item");var b=a[a?.length-1];this.scheduleRender();requestAnimationFrame(()=>b?.setFocus())}};
d.next=function(){return this.viewModel.next()};d.open=function(a){this.removeHandles("selected-index");this.viewModel.open(a);this._addSelectedFeatureIndexHandle()};d.previous=function(){return this.viewModel.previous()};d.triggerAction=function(a){return this.viewModel.triggerAction(a)};d.render=function(){return f.tsx("div",{class:this.classes("esri-features","esri-widget","esri-widget--panel")},this._renderContentContainer())};d._renderFooter=function(){return this._featureNavigationVisible?f.tsx("div",
{slot:"footer",class:"esri-features__footer",key:"footer-actions"},this._renderPagination(),this._renderFeatureMenuButton()):null};d._renderFeatureMenuButton=function(){const {messages:a,messagesCommon:c}=this,{featureCount:b,selectedFeatureIndex:e,pendingPromisesCount:l}=this.viewModel;return f.tsx("calcite-action-group",{layout:"horizontal"},0<l?f.tsx("calcite-action",{appearance:"solid",key:"feature-menu-loading-action",loading:!0,scale:"s",text:c.loading||"",label:c.loading||""}):f.tsx("calcite-action",
{appearance:"solid",key:"feature-menu-button",bind:this,scale:"s",textEnabled:!0,label:a.selectFeature||"",text:q.substitute(a.pageText||"",{total:b,index:(e+1).toLocaleString(void 0,{minimumIntegerDigits:b.toString().length,useGrouping:!1})}),onclick:this._openFeatureMenu,icon:"list"},f.tsx("calcite-tooltip",{overlayPositioning:"fixed",label:a.selectFeature,placement:"bottom",slot:"tooltip"},a.selectFeature)))};d._renderPagination=function(){const {previous:a,next:c}=this.messagesCommon.pagination;
return f.tsx("calcite-action-group",{layout:"horizontal"},f.tsx("calcite-action",{appearance:"solid",label:a,text:a,iconFlipRtl:!0,icon:"chevron-left",scale:"s",onclick:this._previousFeature},f.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:a,slot:"tooltip"},a)),f.tsx("calcite-action",{appearance:"solid",label:c,text:c,iconFlipRtl:!0,icon:"chevron-right",scale:"s",onclick:this._nextFeature},f.tsx("calcite-tooltip",{placement:"bottom",overlayPositioning:"fixed",label:c,
slot:"tooltip"},c)))};d._renderFeatureMenuItem=function(a,c){const {selectedFeatureViewModel:b}=this.viewModel;return f.tsx("calcite-list-item",{bind:this,key:`feature-menu-item-${a.uid}`,selected:a===b,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onmouseover:this._setActiveFeature,onmouseleave:this._removeActiveFeature,"data-feature-index":c,onCalciteListItemSelect:this._selectFeature,label:a.title||this.messagesCommon.untitled})};d._renderFeatureMenu=function(){const {featureViewModels:a}=
this.viewModel;return 1<a.length?f.tsx("calcite-list",{selectionMode:"single",selectionAppearance:"icon"},a.filter(c=>!!c.graphic).map((c,b)=>this._renderFeatureMenuItem(c,b))):null};d._renderContentFeature=function(){const {headingLevel:a,visibleElements:c}=this,{title:b,active:e}=this.viewModel;return f.tsx("calcite-flow-item",{bind:this,closed:!e,class:"esri-features__content-feature",closable:c.closeButton,heading:c.heading&&b?b:"",headingLevel:a,onCalciteFlowItemClose:this.close,afterCreate:this._focusRootFlowItemNode,
afterUpdate:this._focusRootFlowItemNode,key:"root-flow-item",onkeydown:this._onMainKeydown},this._renderActionBar(),f.tsx("div",{class:"esri-features__container"},this._renderContent()),this._renderFooter())};d._renderFeatureMenuContainer=function(){const {viewModel:a,featureMenuOpen:c,messages:b,messagesCommon:e}=this,{active:l,featureViewModels:m}=a;return c?f.tsx("calcite-flow-item",{bind:this,closable:!1,closed:!l,afterCreate:this._focusFeatureMenuFlowItemNode,afterUpdate:this._focusFeatureMenuFlowItemNode,
loading:a.isLoadingFeature,heading:b.selectFeature,description:q.substitute(b.total,{total:m.length}),key:"feature-menu",onCalciteFlowItemBack:this._handleFeatureMenuBack},f.tsx("div",{class:"esri-features__container"},this._renderFeatureMenu()),f.tsx("div",{class:"esri-features__feature-menu-observer",bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),f.tsx("calcite-button",{onclick:this._handleFeatureMenuBack,slot:"footer-actions",appearance:"transparent",width:"full"},e.back)):
null};d._renderContentContainer=function(){var {_relatedRecordsFlowItems:a}=this;const {content:c}=this.viewModel;a=a.toArray();return f.tsx("calcite-flow",{key:c??"content"},this._renderContentFeature(),this._renderFeatureMenuContainer(),a.map(b=>this._renderRelatedRecordsFlowItem(b)),f.tsx("div",{key:"content-tooltips"},a.map(b=>this._renderRelatedRecordsFlowItemTooltips(b))))};d._renderActionBar=function(){return this.visibleElements.actionBar&&this.viewModel.allActions?.length?f.tsx("calcite-action-bar",
{key:"header-action-bar",expandDisabled:!0,slot:"action-bar"},f.tsx("calcite-action-group",null,this._renderActions())):null};d._renderActions=function(){return this.viewModel.allActions.toArray().map(this._renderAction)};d._renderContent=function(){const a=this.viewModel?.content;return a?"string"===typeof a?f.tsx("div",{class:H.CSS.contentNode,key:a,innerHTML:a}):this.renderNodeContent(a):null};d._renderRelatedRecordsFlowItem=function(a){const {messages:c}=this,{visibleElements:b}=this,{active:e}=
this.viewModel,l="graphic"in a&&!a.isTable;return f.tsx("calcite-flow-item",{bind:this,closed:!e,closable:b.closeButton,heading:a.title??"",description:this._getRelatedRecordsFlowItemDescription(a),onCalciteFlowItemBack:this._handleRelatedRecordsBackClick,onCalciteFlowItemClose:this.close,key:`flow-item-${a.viewModel.uid}`},f.tsx("calcite-action",{appearance:"transparent",class:"esri-features__action--exit",icon:"move-up",label:c.exitRelatedRecords,text:c.exitRelatedRecords,slot:"header-actions-start",
bind:this,afterCreate:m=>this._storeExitRelatedRecordsAction(a,m),onclick:this._destroyRelatedRecordsFlowItemWidgets}),l?f.tsx("calcite-action",{appearance:"transparent",icon:"zoom-to-object",label:c.selectFeature,text:c.selectFeature,slot:"header-actions-end",bind:this,afterCreate:m=>this._storeFeatureSelectionAction(a,m),onclick:()=>this._handleOpenRelatedFeature(a)}):null,f.tsx("div",{class:"esri-features__container"},a.render()))};d._renderRelatedRecordsFlowItemTooltips=function(a){const {messages:c,
_exitRelatedRecordsActions:b,_featureSelectionActions:e}=this,l=e.get(a);return[f.tsx("calcite-tooltip",{key:`exit-related-records-tooltip-${a.viewModel.uid}`,label:c.exitRelatedRecords,overlayPositioning:"fixed",referenceElement:b.get(a),placement:"top"},c.exitRelatedRecords),l?f.tsx("calcite-tooltip",{key:`select-related-record-tooltip-${a.viewModel.uid}`,label:c.selectFeature,overlayPositioning:"fixed",referenceElement:l,placement:"top"},c.selectFeature):null]};d._focusRootFlowItemNode=function(a){this._rootFlowItemNode=
a;this._focusRootFlowItem&&(this._focusRootFlowItem=!1,requestAnimationFrame(()=>a?.setFocus()))};d._focusFeatureMenuFlowItemNode=function(a){this._featureMenuViewportNode=a;this._focusFeatureMenuFlowItem&&(this._focusFeatureMenuFlowItem=!1,requestAnimationFrame(()=>a?.setFocus()))};d._setActiveFeature=function(a){const {viewModel:c}=this;c.activeFeature=c.features[a.currentTarget["data-feature-index"]]||null};d._removeActiveFeature=function(){this.viewModel.activeFeature=null};d._selectFeature=function(a){a=
a.currentTarget["data-feature-index"];isNaN(a)||(this.viewModel.selectedFeatureIndex=a);this.featureMenuOpen=!1;this._focusFeatureMenuFlowItem=!0};d._unobserveFeatureMenuObserver=function(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)};d._featureMenuIntersectionObserverCreated=function(a){this._unobserveFeatureMenuObserver();this._featureMenuIntersectionObserver.observe(a);this._featureMenuIntersectionObserverNode=
a};d._getActionIcon=function(a){return a.icon||"question"};d._getActionTitle=function(a){const {messages:c,selectedFeature:b,messagesCommon:e}=this,{id:l}=a,m=b?.attributes,t=a.title??"";return(a="zoom-to-feature"===l?q.substitute(t,{messages:c}):"remove-selected-feature"===l?q.substitute(t,{messages:e}):"zoom-to-clustered-features"===l?q.substitute(t,{messages:c}):"browse-clustered-features"===l?q.substitute(t,{messages:c}):a.title)&&m?q.substitute(a,m):a??""};d._onMainKeydown=function(a){const c=
B.eventKey(a);"ArrowLeft"===c&&(a.stopPropagation(),this.previous());"ArrowRight"===c&&(a.stopPropagation(),this.next())};d._storeFeatureSelectionAction=function(a,c){this._featureSelectionActions.set(a,c);this.scheduleRender()};d._storeExitRelatedRecordsAction=function(a,c){this._exitRelatedRecordsActions.set(a,c);this.scheduleRender()};d._getRelatedRecordsFlowItemDescription=function(a){return"featureCountDescription"in a?a.featureCountDescription:a.viewModel.description??""};d._handleRelatedRecordsBackClick=
function(){const a=this._relatedRecordsFlowItems.pop();a&&(this._exitRelatedRecordsActions.delete(a),this._featureSelectionActions.delete(a),"showAllEnabled"in a.viewModel&&(a.viewModel.showAllEnabled=!1),a&&(a.viewModel=null,a.destroy()))};d._featureMenuViewportScrollTop=function(){this._featureMenuViewportNode&&this._featureMenuViewportNode.scrollContentTo({top:0})};d._setContentFromFeatureWidget=function(){const {selectedFeatureWidget:a}=this;a&&(this.viewModel.content=a)};d._openRelatedFeature=
async function(a){await a.viewModel.updateGeometry();a=a.graphic;var c=a?.geometry;null!=c&&null!=a&&(this._destroyRelatedRecordsFlowItemWidgets(),await this.viewModel.zoomTo({target:c}),c=J.getPointFromGeometry(c),this.open({features:[a],location:null!=c?c:void 0}))};d._setTitleFromFeatureWidget=function(){const {selectedFeatureWidget:a,messagesCommon:c}=this,b=a?.viewModel;a&&(this.viewModel.title="error"===b?.state?c?.errorMessage:b?.title||"")};d._addSelectedFeatureIndexHandle=function(){const a=
n.watch(()=>this.viewModel?.selectedFeatureIndex,(c,b)=>this._selectedFeatureIndexUpdated(c,b));this.addHandles(a,"selected-index")};d._selectedFeatureIndexUpdated=function(a,c){const {featureCount:b}=this.viewModel;b&&a!==c&&-1!==a&&(this._destroyRelatedRecordsFlowItemWidgets(),this.featureMenuOpen=!1,this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))};d._triggerAction=function(a){a=a.currentTarget;if(!a.disabled){var c=a.dataset.actionUid,{allActions:b}=this.viewModel;a=b.findIndex(e=>
e.uid===c);(b=b.at(a))&&"toggle"===b.type&&(b.value=!b.value);this.viewModel.triggerAction(a)}};d._createSpinner=function(a){a&&(this._spinner=new F({view:a}),a.ui.add(this._spinner,{key:"features-spinner",position:"manual"}))};d._wireUpView=function(a){this._destroySpinner();a&&this.visibleElements?.spinner&&this._createSpinner(a)};d._hideSpinner=function(){const {_spinner:a}=this;a&&(a.location=null,a.hide())};d._viewReadyChange=function(a,c){a?this._wireUpView(this.viewModel?.view):c&&this.viewModel.clear()};
d._viewChange=function(a,c){a&&c&&this.viewModel.clear()};d._destroySelectedFeatureWidget=function(){const {_feature:a}=this;a&&(a.viewModel=null,!a.destroyed&&a.destroy());this._feature=null};d._destroyRelatedRecordsFlowItemWidgets=function(){this._relatedRecordsFlowItems.removeAll().forEach(a=>{"showAllEnabled"in a.viewModel&&(a.viewModel.showAllEnabled=!1);a.viewModel=null;a.destroy()})};d._toggleScreenLocationEnabled=function(){const {viewModel:a}=this;a&&(a.screenLocationEnabled=a.active)};d._displaySpinner=
function(){const {_spinner:a}=this;if(a){var {location:c,waitingForResult:b}=this.viewModel;b&&c?a.show({location:c}):a.hide()}};d._destroySpinner=function(){const {_spinner:a,view:c}=this;a&&(c?.ui?.remove(a,"features-spinner"),a.destroy(),this._spinner=null)};d._spinnerEnabledChange=function(a){this._destroySpinner();a&&this._createSpinner(this.viewModel?.view)};u._createClass(r,[{key:"_featureNavigationVisible",get:function(){return this.viewModel.active&&1<this.viewModel.featureCount&&this.visibleElements.featureNavigation}},
{key:"_activeFlowItemWidget",get:function(){return this._relatedRecordsFlowItems.at(-1)??null}},{key:"content",get:function(){return this.viewModel.content},set:function(a){this.viewModel.content=a}},{key:"featureMenuOpen",get:function(){return this.viewModel.featureMenuOpen},set:function(a){this.viewModel.featureMenuOpen=a}},{key:"features",get:function(){return this.viewModel.features},set:function(a){this.viewModel.features=a}},{key:"location",get:function(){return this.viewModel.location},set:function(a){this.viewModel.location=
a}},{key:"label",get:function(){return this.messages?.widgetLabel??""},set:function(a){this._overrideIfSome("label",a)}},{key:"promises",get:function(){return this.viewModel.promises},set:function(a){this.viewModel.promises=a}},{key:"selectedFeature",get:function(){return this.viewModel.selectedFeature}},{key:"selectedFeatureIndex",get:function(){return this.viewModel.selectedFeatureIndex},set:function(a){this.viewModel.selectedFeatureIndex=a}},{key:"selectedFeatureWidget",get:function(){const {_feature:a,
headingLevel:c,_relatedRecordsFlowItems:b}=this,{selectedFeatureViewModel:e}=this.viewModel,l={title:!1};if(!e)return null;a?(a.viewModel=e,a.visibleElements=l):this._feature=new E({flowItems:b,headingLevel:c+1,viewModel:e,visibleElements:l});return this._feature}},{key:"title",get:function(){return this.viewModel.title},set:function(a){this.viewModel.title=a}},{key:"updateLocationEnabled",get:function(){return this.viewModel.updateLocationEnabled},set:function(a){this.viewModel.updateLocationEnabled=
a}},{key:"view",get:function(){return this.viewModel.view},set:function(a){this.viewModel.view=a}},{key:"visible",get:function(){return this.viewModel.visible},set:function(a){this.viewModel.visible=a}}]);return r}(I.FeatureContentMixin(G));h.__decorate([k.property()],g.prototype,"_focusFeatureMenuFlowItem",void 0);h.__decorate([k.property()],g.prototype,"_relatedRecordsFlowItems",void 0);h.__decorate([k.property()],g.prototype,"_focusRootFlowItem",void 0);h.__decorate([k.property()],g.prototype,
"_featureNavigationVisible",null);h.__decorate([k.property()],g.prototype,"_activeFlowItemWidget",null);h.__decorate([k.property()],g.prototype,"content",null);h.__decorate([k.property()],g.prototype,"icon",void 0);h.__decorate([k.property()],g.prototype,"featureMenuOpen",null);h.__decorate([k.property()],g.prototype,"features",null);h.__decorate([k.property()],g.prototype,"headingLevel",void 0);h.__decorate([k.property()],g.prototype,"location",null);h.__decorate([k.property()],g.prototype,"label",
null);h.__decorate([k.property(),y.messageBundle("esri/widgets/Features/t9n/Features")],g.prototype,"messages",void 0);h.__decorate([k.property(),y.messageBundle("esri/t9n/common")],g.prototype,"messagesCommon",void 0);h.__decorate([k.property()],g.prototype,"promises",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"selectedFeature",null);h.__decorate([k.property()],g.prototype,"selectedFeatureIndex",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"selectedFeatureWidget",null);
h.__decorate([k.property()],g.prototype,"title",null);h.__decorate([k.property()],g.prototype,"updateLocationEnabled",null);h.__decorate([k.property()],g.prototype,"view",null);h.__decorate([k.property({type:w}),L.vmEvent(["triggerAction","trigger-action"])],g.prototype,"viewModel",void 0);h.__decorate([k.property({type:x,nonNullable:!0})],g.prototype,"visibleElements",void 0);h.__decorate([k.property()],g.prototype,"visible",null);return g=h.__decorate([D.subclass("esri.widgets.Features")],g)});
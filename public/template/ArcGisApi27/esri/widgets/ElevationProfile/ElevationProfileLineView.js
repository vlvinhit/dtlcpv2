// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Color ../../core/handleUtils ../../core/maybe ../../core/memoize ../../core/reactiveUtils ../../core/SetUtils ../../core/unitUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../chunks/vec3 ../../chunks/vec4f64 ../../geometry/ellipsoidUtils ../../geometry/support/ray ../../layers/support/ElevationQuery ../../views/3d/webgl-engine/lib/Intersector ../../views/3d/webgl-engine/lib/IntersectorInterfaces ../../views/3d/webgl-engine/lib/intersectorUtilsConversions ./ElevationProfileLine".split(" "),
function(q,d,z,G,A,H,B,I,J,e,c,W,X,K,L,C,M,D,N,O,P,Q,R){function S({view:f,inputGraphicUid:g,maxIntersectionDistance:r},a){for(const b of a)if(!(null!=b.distanceInRenderSpace&&b.distanceInRenderSpace>r)&&(a=Q.toGraphic(b,f),null==a||E(a)!==g))return b;return null}function E(f){if(f.layer&&"objectIdField"in f.layer){const g=f.attributes[f.layer.objectIdField];if(g)return`o-${f.layer.id}-${g}`}return`u-${f.uid}`}c=function(f){function g(a){a=f.call(this,a)||this;a.type="view";a.color=new z("#cf4ccf");
a.viewVisualizationEnabled=!0;a.include=null;a.exclude=null;a.numSamplesForPreview=50;a.numSamplesPerChunk=25;a._getQueryElevationDependencies=H.memoize((b,h,l,m,v,t,k)=>({inputGraphicUid:null!=b?E(b):null,visibleLayers:h,maxIntersectionDistance:l,intersectOptions:m,view:v,stationary:t,spatialReference:k}));a._vecA=C.create();a._vecB=C.create();a._ray=D.create();return a}q._inherits(g,f);var r=g.prototype;r.queryElevation=async function(a,{noDataValue:b,signal:h}){const l=this.queryElevationDependencies;
if(null==l)throw Error("ElevationProfileLineInput: no dependencies");const m=this._intersector;if(null==m)throw Error("ElevationProfileLineInput: no view");const {intersectOptions:v,view:t,spatialReference:k}=l,w=t.renderCoordsHelper,T=t.sceneIntersectionHelper,F=this._vecA,u=this._vecA,n=this._vecB,U=this._ray;if(!k)return{geometry:a,noDataValue:b};h=await N.GeometryDescriptor.fromGeometry(a).project(k,h);if(!h)return{geometry:a,noDataValue:b};a=h.coordinates;const V=a.length;for(let x=0;x<V;++x){const p=
a[x];L.set(n,p.x,p.y,p.z??0);w.toRenderCoords(n,k,n);w.setAltitude(F,2E5,n);var y=D.fromPoints(F,n,U);T.computeIntersection(y,m,v);(y=S(l,m.results.all))?(y.getIntersectionPoint(u),w.fromRenderCoords(u,u,k),p.z=u[2]):p.z=b}return{geometry:h.export(),noDataValue:b}};r.attach=function(a){const b=()=>this._onChange();return G.handlesGroup([q._get(q._getPrototypeOf(g.prototype),"attach",this).call(this,a),B.watch(()=>this.queryElevationDependencies,b),B.on(()=>a.elevationProvider,"elevation-change",b,
{onListenerAdd:b,onListenerRemove:b})])};q._createClass(g,[{key:"minDemResolution",get:function(){const a=this._viewModel?.view;if(null==a||"3d"!==a.type)return null;const b=a.pointsOfInterest?.focus?.renderLocation;return b?a.state.camera.computeRenderPixelSizeAt(b)*J.getMetersPerVerticalUnitForSR(a.spatialReference):null}},{key:"queryElevationDependencies",get:function(){return A.applySome(this._view,a=>this._getQueryElevationDependencies(this._viewModel?.input,this._visibleLayers,this._maxIntersectionDistance,
this._intersectOptions,a,a.stationary,a.spatialReference))}},{key:"_visibleLayers",get:function(){return A.applySome(this._view,a=>a.map?.allLayers?.filter(b=>b.visible).toArray())??[]}},{key:"_intersectOptions",get:function(){var a=this._view;if(null==a)return{};const b=a.externalToInternalIntersectOptions({include:this.include,exclude:this.exclude});a=a.externalToInternalIntersectOptions({exclude:this._pointCloudLayers});b.exclude=I.union(b.exclude,a.exclude);return b}},{key:"_pointCloudLayers",
get:function(){const a=this._view;return null==a?[]:a.allLayerViews.toArray().filter(b=>"point-cloud"===b.layer?.type).map(b=>b.layer)}},{key:"_view",get:function(){const a=this._viewModel?.view;return null!=a&&"3d"===a.type?a:null}},{key:"_maxIntersectionDistance",get:function(){const a=this._view;return null!=a&&a.renderCoordsHelper?M.getReferenceEllipsoid(a.spatialReference).radius/a.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY}},{key:"_intersector",get:function(){var a=this._view;
if(null==a)return null;a=O.newIntersector(a.state.viewingMode);const b=a.options;b.hud=!1;b.invisibleTerrain=!1;b.backfacesTerrain=!1;b.selectionMode=!1;b.store=P.StoreResults.ALL;return a}}]);return g}(R);d.__decorate([e.property({type:z,nonNullable:!0})],c.prototype,"color",void 0);d.__decorate([e.property()],c.prototype,"viewVisualizationEnabled",void 0);d.__decorate([e.property()],c.prototype,"include",void 0);d.__decorate([e.property()],c.prototype,"exclude",void 0);d.__decorate([e.property({readOnly:!0})],
c.prototype,"minDemResolution",null);d.__decorate([e.property()],c.prototype,"queryElevationDependencies",null);d.__decorate([e.property()],c.prototype,"_visibleLayers",null);d.__decorate([e.property()],c.prototype,"_intersectOptions",null);d.__decorate([e.property()],c.prototype,"_pointCloudLayers",null);d.__decorate([e.property()],c.prototype,"_view",null);d.__decorate([e.property()],c.prototype,"_maxIntersectionDistance",null);d.__decorate([e.property()],c.prototype,"_intersector",null);return c=
d.__decorate([K.subclass("esri.widgets.ElevationProfile.ElevationProfileLineView")],c)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/uuid ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./modelUploadUtils ./Workflow ./workflowUtils".split(" "),
function(H,x,I,u,z,N,A,J,y,w,X,O,B,P,Q,R,D,S,p){function T(q,t){let n=null;const a=()=>{null!=n&&(q.snappingOptions.featureSources.remove(n),n=z.destroyMaybe(n))};return u.handlesGroup([A.watch(()=>{const b=t.creationInfo?.layer,c=q.snappingOptions.featureSources.find(k=>k.layer===b);return{hasFeatureLayerSource:!!c,enabled:c?.enabled??!1}},({hasFeatureLayerSource:b,enabled:c})=>{if(b)null==n&&(n=new Q({layer:q.layer}),q.snappingOptions.featureSources.add(n)),n.enabled=c;else return a()},A.syncAndInitial),
u.makeHandle(a)])}function U(q,t,n,a){const b=[];t.forEach((c,k)=>{if(!c.error){const e=q[k];k=a.get(e)||[];e.attributes[n.objectIdField]=c.objectId;k.forEach(({form:g})=>b.push({feature:e,attachment:g}))}});return b}function V(q,t,n){const a=[],b=t.globalIdField;q.forEach((c,k)=>{var e;(e=q[k].attributes)[b]??(e[b]=J.generateBracedUUID());(n?.get(c)||[]).forEach(({file:g})=>a.push({feature:c,attachment:{globalId:J.generateBracedUUID(),data:g}}))});return a.length?{addFeatures:q,addAttachments:a}:
{addFeatures:q}}var C;const E=Symbol(),K=Symbol();w=C=function(q){function t(a){a=q.call(this,a)||this;a.type="create-features";a.createFeatureState="create-new";a._featureFormHandle=null;a._visualVariableAttributes={rotation:null,size:null};a._attachmentFileInfos=new Map;a._highlightHandles=new Map;a._preventDefaultActionOnCancel=!1;a._lastActiveGraphics=[];return a}H._inherits(t,q);var n=t.prototype;n.enter=async function(){const {featureFormViewModel:a}=this.data.viewModel,b=a.relatedRecordCallbacks;
a.relatedRecordCallbacks=null;this.addHandles(u.makeHandle(()=>{a.relatedRecordCallbacks=b}),K)};n.exit=function(){this.removeHandles(K)};n.updatePendingFeature=async function(a,b){this._preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();I.remove(this._lastActiveGraphics,a);return this._startUpdating(a,b)};t.create=function(a){const {addAttachmentsCallback:b,applyEditsCallback:c,creationInfo:k,startAt:e,viewModel:g}=a,f=new C({data:new R.CreateFeaturesWorkflowData({creationInfo:k,
viewModel:g}),onCommit:async h=>{var {creationInfo:l}=h;if(l){l.geometryToPlace&&(h.creationInfo=null);h=h.pendingFeatures.toArray();({layer:l}=l);var d=f._attachmentFileInfos;if(l.capabilities?.editing.supportsGlobalId&&"globalIdField"in l)h=V(h,l,d),await c(l,h,{globalIdUsed:!0});else{var m=await c(l,{addFeatures:h});0<d.size&&await b(l,U(h,m?.addFeatureResults??[],l,d))}}}});f._set("steps",this._createWorkflowSteps(f,e));return f};n._fadeExistingFeatures=function(a){if("effect"in a){const c=a.effect;
a.effect="saturate(0.6) opacity(0.8)";return u.makeHandle(()=>a.effect=c)}const b=a.opacity;a.opacity=.7;return u.makeHandle(()=>a.opacity=b)};n._highlight=function(a){const b=this.data.viewModel.view;"3d"===b?.type&&this._highlightHandles.set(a,b.highlight(a))};n._removeHighlight=function(a){z.removeMaybe(this._highlightHandles.get(a));this._highlightHandles.delete(a)};n._startCreating=async function(a){const {data:b}=this,{creationInfo:c}=b;if(c)return this.createFeatureState="create-new",p.startCreatingNewFeature(b.viewModel.sketchViewModel,
c,a)};n._startUpdating=async function(a,b){var {pendingFeatures:c}=this;c.includes(a)||c.add(a);const {creationInfo:k,viewModel:e}=this.data,{featureFormViewModel:g,layerInfos:f,sketchViewModel:h,view:l}=e;if(l&&k){c=k.layer;var d=p.findLayerInfo(f,c);g.set({arcadeEditType:"INSERT",feature:a,formTemplate:d?.formTemplate,spatialReference:l.spatialReference,map:l.map});this._removeHighlight(a);await p.updateGraphicSymbolWhenRequired(a,b);z.removeMaybe(this._featureFormHandle);this._featureFormHandle=
u.handlesGroup([g.on("value-change",async()=>{a.attributes=g.getValues();await p.updateGraphicSymbolWhenRequired(a,b)}),h.on(["update","undo","redo"],m=>{("undo"===m.type||"redo"===m.type||"update"===m.type&&null!=m.toolEventInfo&&p.isTerminalUpdateEventType(m.toolEventInfo.type))&&g.notifyFeatureGeometryChanged()})]);this.createFeatureState="update-pending";this._visualVariableAttributes=p.getVisualVariableAttributes(a);if(!B.isTable(c))return p.startUpdatingFeature({graphic:a,sketchViewModel:h,
sourceLayer:c,visualVariables:this._visualVariableAttributes,webStyleCache:b})}};t._createWorkflowSteps=function(a,b="awaiting-feature-creation-info"){const {data:c,handles:k}=a;b=p.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],b,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(e){const {creationInfo:g,viewModel:f}=c;var {view:h}=f;h&&(D.isModelUpload(g)?(h=await D.waitForModelUpload({view:h,
data:c,signal:e,next:()=>a.next(),cancel:()=>f.cancelWorkflow()}),N.throwIfAborted(e),k.add(h,this.id)):(c.creationInfo=null,k.add(f.featureTemplatesViewModel.on("select",({item:l})=>{l&&(c.creationInfo=l,f.activeWorkflow?.next())}),this.id)))},async tearDown(){k.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(!k.has(this.id)){var {viewModel:e}=c,{view:g}=e;if(g){var f=new Map,h=[],l=[];a._lastActiveGraphics=[];a._featureFormHandle=z.removeMaybe(a._featureFormHandle);
a._visualVariableAttributes={rotation:null,size:null};p.prepareAttachmentsForCreateWorkflow(e.attachmentsViewModel);h.push(A.watch(()=>e.attachmentsViewModel.mode,m=>{switch(m){case "add":a.go("adding-attachment");break;case "edit":a.go("editing-attachment")}}));g=p.showProgressCursor(g);h.push(g);var d=B.isTable(a.data.creationInfo?.layer);try{if(!d){const v=C._configureSketchViewModel(a,f);h.push(v.beforeCommit);l.push(v.afterCommit)}const m=c.creationInfo?.initialFeature;m?(d||e.sketchViewModel.layer.add(m),
await a._startUpdating(m,f)):await a._startCreating(f)}finally{g.remove()}h.push(a._featureFormHandle);k.add(h,a._handleKeys.beforeCommit);k.add([...h,...l],this.id)}}},async tearDown(e){const {viewModel:g}=c;e.canceled&&({pendingFeatures:e}=a,e.drain(f=>g.sketchViewModel.layer.remove(f)),k.remove([this.id,E]),g.attachmentsViewModel.fileInfos.removeAll(),a._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=
c.viewModel,{graphic:g,fileInfos:f}=e;a._attachmentFileInfos.set(g,f.toArray());e.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=c.viewModel,{graphic:g,fileInfos:f}=e;a._attachmentFileInfos.set(g,f.toArray());e.mode="view"}})});return p.avoidFeatureTemplateSelectionWithOnlyOneItem(c,b)};t._configureSketchViewModel=function(a,b){const {data:c,handles:k}=a;var {viewModel:e}=c;const {view:g}=
e,f=e.sketchViewModel;let h=null;e=[];if(!g)return{beforeCommit:u.makeHandle(),afterCommit:u.makeHandle()};const l=f.updateOnGraphicClick;f.updateOnGraphicClick=!1;"2d"===g.type&&c.creationInfo&&e.push(a._fadeExistingFeatures(c.creationInfo.layer));e.push(f.on("create",async d=>{if("cancel"===d.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(1>a._lastActiveGraphics.length)return a._startCreating(b);d=a._lastActiveGraphics.pop();return a._startUpdating(d,b)}if("complete"===
d.state&&d.graphic)return a._startUpdating(d.graphic,b)}),f.on("update",async d=>{var {viewModel:m}=c;const {attachmentsViewModel:v,featureFormViewModel:F}=m;var r=d.graphics[0];if("complete"===d.state){r!==h&&(a._lastActiveGraphics.push(r),a._highlight(r));h=null;if(a.numPendingFeatures===c.creationInfo?.maxFeatures)return d=a._lastActiveGraphics.pop(),a._startUpdating(d,b);"add"!==v.mode&&"edit"!==v.mode||m.activeWorkflow?.previous();if(d.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=
!1;return}k.add([p.showProgressCursor(g),g.on("click",G=>G.preventDefault())],E);await A.whenOnce(()=>!F.updating);k.remove(E);a._startCreating(b)}"start"===d.state&&(a._removeHighlight(r),"add"!==v.mode&&"edit"!==v.mode||m.activeWorkflow?.previous(),v.fileInfos.removeAll(),v.graphic=r,v.mode="view",(a._attachmentFileInfos.get(r)||[]).forEach(({file:G,form:W})=>v.addFile(G,W)));m=a._visualVariableAttributes;await p.visualVariableInteractiveUpdate(g,r,d,m,b);d=r.attributes;const {rotation:L,size:M}=
m;null!=L&&({field:r}=L,F.setValue(r,d[r]));null!=M&&({field:r}=M,F.setValue(r,d[r]))}),f.on("delete",async d=>{d=d.graphics[0];a.pendingFeatures.remove(d);I.remove(a._lastActiveGraphics,d);h=d}),g.on("immediate-click",async d=>{!D.isModelUpload(c.creationInfo)&&({results:d}=await g.hitTest(d,{include:f.layer}),d=d.find(m=>"graphic"===m.type))&&(d=d.graphic,"transform"!==f.activeTool&&"reshape"!==f.activeTool||f.updateGraphics.at(0)===d||await a.updatePendingFeature(d,b))}),u.makeHandle(()=>f.cancel()),
T(f,c));return{beforeCommit:u.handlesGroup(e),afterCommit:u.makeHandle(()=>{f.updateOnGraphicClick=l})}};H._createClass(t,[{key:"hasPendingEdits",get:function(){if(this.numPendingFeatures)return!0;const {data:a}=this,{upload:b}=a;return b&&!b.error||a.creationInfo?.geometryToPlace?!0:!1}},{key:"helpMessage",get:function(){const {creationInfo:a,viewModel:b}=this.data;if("creating-features"===this.stepId&&a)return P.getDrawHelpMessage(a.layer.geometryType,b.sketchViewModel.createGraphic?.geometry,b.view)}},
{key:"numPendingFeatures",get:function(){return this.pendingFeatures.length}},{key:"pendingFeatures",get:function(){return this.data.pendingFeatures}},{key:"keyboardCancellationEnabled",get:function(){return 0===this.numPendingFeatures}},{key:"reliesOnOwnerAdminPrivileges",get:function(){var {creationInfo:a}=this.data;if(!a)return!1;({layer:a}=a);const b=a.capabilities?.operations.supportsAdd,c=B.getEffectiveLayerCapabilities(a)?.operations.supportsAdd;return B.getEffectiveEditingEnabled(a)&&!a.editingEnabled||
!!c&&!b}},{key:"shouldShowAttachments",get:function(){return this.data&&this.data.creationInfo&&this.data.viewModel?p.shouldShowAttachmentsForCreateWorkflow(this.data):!1}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{addAttachment:(a,b)=>{this._attachmentFileInfos.set(a,b)}}}}]);return t}(S);x.__decorate([y.property()],w.prototype,"hasPendingEdits",null);
x.__decorate([y.property()],w.prototype,"helpMessage",null);x.__decorate([y.property()],w.prototype,"keyboardCancellationEnabled",null);x.__decorate([y.property()],w.prototype,"reliesOnOwnerAdminPrivileges",null);x.__decorate([y.property()],w.prototype,"shouldShowAttachments",null);x.__decorate([y.property()],w.prototype,"shouldAllowAttachmentEditing",null);x.__decorate([y.property()],w.prototype,"updating",null);return w=C=x.__decorate([O.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],w)});
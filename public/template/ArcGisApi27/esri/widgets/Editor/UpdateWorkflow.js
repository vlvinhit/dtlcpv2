// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../core/Error ../../core/handleUtils ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/Queue ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/editableLayers ../../layers/support/layerUtils ../../views/support/layerViewUtils ./CreateFeaturesWorkflow ./UpdateFeatureWorkflow ./UpdateRecordWorkflow ./UpdateWorkflowData ./Workflow ./workflowUtils ../Feature/support/featureUtils".split(" "),
function(v,h,G,r,B,g,H,w,I,t,k,T,U,V,J,K,E,L,M,N,O,P,Q,F,R){var C;const S=g.getLogger("esri.widgets.Editor.UpdateWorkflow");g=C=function(x){function l(a){a=x.call(this,a)||this;a._workflowStack=new I(b=>{let c;for(c of b);return c});a.type="update";return a}v._inherits(l,x);var f=l.prototype;f.back=async function(a=()=>Promise.resolve(!0)){const {featureFormViewModel:b}=this.data.viewModel;if(null!=b.relationshipId)b.relationshipId=null;else if(this.activeWorkflow){if(!this.activeWorkflow.hasPendingEdits||
await a())this.activeWorkflow.hasPreviousStep?await this.activeWorkflow.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0})};f.cancelActiveWorkflow=async function(a){await this.activeWorkflow?.cancel(a);await this._popWorkflow()};f.commit=async function(){await this._drainWorkflowStack(a=>a.commit());await v._get(v._getPrototypeOf(l.prototype),"commit",this).call(this)};l.create=
function(a,b,c){a=new C({data:new P({applyEditsCallback:c,viewModel:a}),onCommit:async()=>{}});a._set("steps",this._createWorkflowSteps(a,b));return a};f.save=async function(){1<this.nestedWorkflowCount?(await this.activeWorkflow?.commit(),await this._popWorkflow()):await this.commit()};f.startCreatingRelatedRecord=async function(a){try{const b=await this._createNestedCreateFeaturesWorkflow(a);await this._pushWorkflow(b)}catch(b){throw new r("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",
{error:b});}};f.startUpdating=async function(a){try{const b=await this._createNestedUpdateWorkflow(a);await this._pushWorkflow(b)}catch(b){throw new r("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:b});}};f.deleteActiveFeature=async function(){const {activeWorkflow:a}=this;if(!a)throw new r("editor:nothing-to-delete","There is no feature to delete");a&&/update-/.test(a.type)?await a.deleteAndCommit():await a.cancel();1===this.nestedWorkflowCount?
await this.reset():await this._popWorkflow()};f.cancelAll=async function(){await this._drainWorkflowStack(a=>a.cancel({force:!0}))};f._createNestedCreateFeaturesWorkflow=async function(a){const {relatedLayer:b}=a,{addAttachmentsCallback:c,applyEditsCallback:e,viewModel:d}=this.data;if(!K.isEditableLayer(b))throw new r("editor:unsupported-layer","Editing is not supported on the provided layer");a=new G({sourceLayer:b,attributes:this._makeRelatedRecordAttributes(a)});return M.create({addAttachmentsCallback:c,
applyEditsCallback:e,creationInfo:{layer:b,initialFeature:a,maxFeatures:1},startAt:"creating-features",viewModel:d})};f._createNestedUpdateWorkflow=async function(a){const b=E.isTable(a.sourceLayer)?O.UpdateRecordWorkflow:N.UpdateFeatureWorkflow,{applyEditsCallback:c,viewModel:e}=this.data,d=await b.create({feature:a,viewModel:e,applyEdits:c});await t.whenOnce(()=>!d.updating);return d};f._drainWorkflowStack=async function(a){const b=this._workflowStack,c=[];for(;0<b.length;){const e=b.pop(),d=a(e).then(()=>
e.destroy());this.updatingHandles.addPromise(d);c.push(d)}await Promise.all(c)};f._highlight=function(a){this._removeHighlight();var b=this.data.viewModel.view;b&&a&&(b=a&&b.allLayerViews.items.find(({layer:c})=>c===a.layer||"subtype-sublayer"===a.layer?.type&&a.layer?.parent===c),L.highlightsSupported(b)&&this.handles.add(b.highlight(a),"candidate-highlight"))};f._makeRelatedRecordAttributes=function(a){const {parentFeature:b,relatedLayer:c,relationshipId:e}=a;if(R.isGraphicForRelatableFeatureSupportedLayer(b))if(a=
c.relationships?.find(m=>m.id===e))if("origin"===a.role)u("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");else{var d=b.sourceLayer;a.relatedTableId!==d.layerId&&u("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");if(d=d.relationships?.find(m=>m.id===e))return(d=b.getAttribute(d.keyField))||u("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),
{[a.keyField]:d};u("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.")}else u("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.")};f._popWorkflow=async function(){this._workflowStack.pop()?.destroy();const a=await this._reconcileWorkflowStack();if(0<a.failureCount)throw new r("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",
a);};f._pushWorkflow=async function(a){const b=this._workflowRequiresSketchViewModel(a);this.activeWorkflow?.exit({removeSketchHandles:b});await a.start();this._workflowStack.push(a);a=await this._reconcileWorkflowStack();if(0<a.failureCount)throw new r("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",a);};f._reconcileWorkflowStack=async function(){const a=this._workflowStack;try{const b=a.peek();await b?.enter();return{activeWorkflow:b,failureCount:0}}catch(b){a.pop().destroy();
const {activeWorkflow:c,failureCount:e}=await this._reconcileWorkflowStack();return{activeWorkflow:c,failureCount:e+1}}};f._removeHighlight=function(){this.handles.remove("candidate-highlight")};f._workflowRequiresSketchViewModel=function(a){const {type:b}=a;return"update-features"===b||"create-features"===b&&!E.isTable(a.data.creationInfo?.layer)};l._createWorkflowSteps=function(a,b="awaiting-feature-to-update"){const {data:c,handles:e}=a;return F.createWorkflowSteps(["awaiting-feature-to-update",
"awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],b,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const {spinnerViewModel:d}=c.viewModel,m=c.viewModel.view;let n=null;e.add(B.makeHandle(()=>{n=H.abortMaybe(n)}),this.id);c.rootFeature=null;c.candidates=[];const q=m.on("immediate-click",async y=>{d.location=y.mapPoint;d.visible=!0;n?.abort();const {editableItems:p}=c.viewModel;n=new AbortController;const D=await new Promise((z,
A)=>{w.onAbort(n?.signal,()=>A(w.createAbortError()));z(F.fetchCandidates(p,m,y,n?.signal))});w.throwIfAborted(n);c.candidates=D.reduce((z,A)=>A.error?z:[...z,...A.value],[]);d.visible=1===c.candidates.length;0!==c.candidates.length&&(1===c.candidates.length?(c.rootFeature=c.candidates[0],a.go("editing-existing-feature").catch(()=>{}).then(()=>d.visible=!1)):a.next())});m.focus();e.add(q,this.id)},async tearDown(){e.remove(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",
async setUp(){c.rootFeature=null;e.add([t.watch(()=>c.rootFeature,d=>a._highlight(d),t.sync),B.makeHandle(()=>a._removeHighlight())],this.id)},async tearDown(){e.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const {rootFeature:d,viewModel:m}=a.data;if(!d)throw new r("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await a.startUpdating(d);m.spinnerViewModel.visible=!1;const n=w.debounce(async()=>
{await t.whenOnce(()=>!a.updating);a.previous()}),{featureFormViewModel:q}=c.viewModel,y=q.relatedRecordCallbacks;q.relatedRecordCallbacks={addRelatedRecord:async p=>{await a.startCreatingRelatedRecord(p);q.relationshipId=null},editRelatedRecord:async({relatedFeature:p})=>{await a.startUpdating(p);q.relationshipId=null},showAllRelatedRecords:p=>q.relationshipId=p.relationshipId};e.add([B.makeHandle(()=>q.relatedRecordCallbacks=y),t.watch(()=>a.nestedWorkflowCount,(p,D)=>{0===p&&0!==D&&n()},t.sync)],
this.id)},async tearDown(){await a.cancelAll();e.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){c.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){c.viewModel.attachmentsViewModel.mode="view"}})})};v._createClass(l,[{key:"activeEditableItem",get:function(){const {activeWorkflow:a}=this;return a&&/update-/.test(a.type)?
a.data.editableItem:void 0}},{key:"activeWorkflow",get:function(){return this._workflowStack.last()}},{key:"nestedWorkflowCount",get:function(){return this._workflowStack.length}},{key:"shouldShowAttachments",get:function(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}},{key:"shouldAllowAttachmentEditing",get:function(){return!!this.activeEditableItem?.supports.includes("update")}},{key:"hasPendingEdits",get:function(){return Array.from(this._workflowStack).some(a=>a.hasPendingEdits)}},
{key:"helpMessage",get:function(){return"awaiting-feature-to-update"===this.stepId?"select":void 0}},{key:"reliesOnOwnerAdminPrivileges",get:function(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}},{key:"hasInvalidFormTemplate",get:function(){return!!this.activeEditableItem?.hasInvalidFormTemplate}},{key:"hasUnsupportedFields",get:function(){return!!this.activeEditableItem?.hasUnsupportedFields}},{key:"updating",get:function(){return this.updatingHandles.updating}}]);return l}(Q);
h.__decorate([k.property()],g.prototype,"activeEditableItem",null);h.__decorate([k.property()],g.prototype,"activeWorkflow",null);h.__decorate([k.property()],g.prototype,"nestedWorkflowCount",null);h.__decorate([k.property()],g.prototype,"shouldShowAttachments",null);h.__decorate([k.property()],g.prototype,"shouldAllowAttachmentEditing",null);h.__decorate([k.property()],g.prototype,"hasPendingEdits",null);h.__decorate([k.property()],g.prototype,"helpMessage",null);h.__decorate([k.property()],g.prototype,
"reliesOnOwnerAdminPrivileges",null);h.__decorate([k.property()],g.prototype,"hasInvalidFormTemplate",null);h.__decorate([k.property()],g.prototype,"hasUnsupportedFields",null);h.__decorate([k.property()],g.prototype,"updating",null);g=C=h.__decorate([J.subclass("esri.widgets.Editor.UpdateWorkflow")],g);const u=(x,l)=>S.warn(`editor:${x}`,l,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature.");return g});
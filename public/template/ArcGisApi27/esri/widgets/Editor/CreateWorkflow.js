// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ./CreateWorkflowData ./Edits ./Workflow ./workflowUtils".split(" "),function(x,n,A,q,h,H,I,B,y,C,D,E,F,d){var u;h=u=function(z){function r(b){b=z.call(this,b)||this;
b.type="create";return b}x._inherits(r,z);r.create=function(b,k,a){b=new u({data:new D({edits:new E.Edits,viewModel:b}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});b._set("steps",this._createWorkflowSteps(b,k));return b};r._createWorkflowSteps=function(b,k="awaiting-feature-creation-info"){const {data:a,handles:e}=b,t=new Map;b=d.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],
k,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){a.creationInfo=null;a.edits.feature=null;a.viewModel.featureTemplatesViewModel.select(null);e.add(a.viewModel.featureTemplatesViewModel.on("select",({item:c})=>{c&&(a.creationInfo=c,a.viewModel.activeWorkflow?.next())}),this.id)},async tearDown(){e.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){e.add(await d.setUpFeatureAdd(a.viewModel.sketchViewModel,a.creationInfo,
c=>{a.edits.feature=c;a.viewModel.activeWorkflow?.next()},t),this.id)},async tearDown(){e.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const c=a.edits.feature,v=c.sourceLayer,l=a.viewModel,p=l.sketchViewModel;var w=d.findLayerInfo(l.layerInfos,v);const {spatialReference:G}=l.view;l.featureFormViewModel.set({arcadeEditType:"INSERT",feature:c,formTemplate:w?.formTemplate,spatialReference:G});p.allowDeleteKey=!1;d.prepareAttachmentsForCreateWorkflow(l.attachmentsViewModel);
const m=d.getVisualVariableAttributes(c);await d.startUpdatingFeature({graphic:c,sketchViewModel:p,sourceLayer:v,visualVariables:m,webStyleCache:t});w=p.on("update",async f=>{var g=f.graphics[0];if("complete"===f.state)return d.startUpdatingFeature({graphic:g,sketchViewModel:p,sourceLayer:v,visualVariables:m,webStyleCache:t});await d.visualVariableInteractiveUpdate(p.view,g,f,m,t);f=g.attributes;null!=m.rotation&&({field:g}=m.rotation,l.featureFormViewModel.setValue(g,f[g]));null!=m.size&&({field:g}=
m.size,l.featureFormViewModel.setValue(g,f[g]))});e.add([a.viewModel.featureFormViewModel.on("value-change",async()=>{a.edits.updateAttributes(a.viewModel.featureFormViewModel.getValues());c.attributes=a.edits.feature.attributes;"3d"===p.view.type&&await d.updateGraphicSymbolWhenRequired(c,t)}),w,A.watch(()=>a.viewModel.attachmentsViewModel.mode,f=>{"add"===f&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===f&&a.viewModel.activeWorkflow.go("editing-attachment")})],this.id)},async tearDown(c){c.canceled&&
a.viewModel.sketchViewModel.layer.removeAll();e.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}})});return d.avoidFeatureTemplateSelectionWithOnlyOneItem(a,b)};x._createClass(r,[{key:"shouldShowAttachments",get:function(){return this.data&&
this.data.creationInfo&&this.data.viewModel?d.shouldShowAttachmentsForCreateWorkflow(this.data):!1}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},{key:"hasPendingEdits",get:function(){return!0}},{key:"helpMessage",get:function(){if("editing-new-feature"===this.stepId){var {creationInfo:b,viewModel:k}=this.data;return C.getDrawHelpMessage(b.layer.geometryType,k.sketchViewModel.createGraphic?.geometry,k.view)}}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const {layer:b}=
this.data.creationInfo,k=b.capabilities?.operations.supportsAdd,a=y.getEffectiveLayerCapabilities(b)?.operations.supportsAdd;return y.getEffectiveEditingEnabled(b)&&!b.editingEnabled||!!a&&!k}}]);return r}(F);n.__decorate([q.property()],h.prototype,"shouldShowAttachments",null);n.__decorate([q.property()],h.prototype,"shouldAllowAttachmentEditing",null);n.__decorate([q.property()],h.prototype,"hasPendingEdits",null);n.__decorate([q.property()],h.prototype,"helpMessage",null);n.__decorate([q.property()],
h.prototype,"reliesOnOwnerAdminPrivileges",null);return h=u=n.__decorate([B.subclass("esri.widgets.Editor.CreateWorkflow")],h)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/handleUtils ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../support/featureFlags ./UpdateRecordWorkflowData ./Workflow ./workflowUtils".split(" "),function(e,p,g,u,v,w,x,k,D,E,F,y,q,r,z,A,
B){var n;const l={exit:Symbol()};e.UpdateRecordWorkflow=n=function(m){function d(a){a=m.call(this,a)||this;a.fullFeature=null;a.type="update-table-record";return a}p._inherits(d,m);var f=d.prototype;f.initialize=async function(){const {data:a}=this;var {edits:b}=a;b=b.feature;const c=new AbortController;this.addHandles(v.abortHandle(c));this.updatingHandles.addPromise(B.fetchFullFeature(b,a.viewModel.view.spatialReference,c.signal).then(h=>{w.isAborted(c)||this._onFullFeatureLoaded(h)},h=>this.cancel({force:!0,
error:new u("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:h}})})))};f.deleteAndCommit=async function(){this.data.edits.stageDelete();return this.commit()};f.enter=async function(){this._configureAttachmentsViewModel();this._configureFeatureFormViewModel()};f.exit=function(a){this.removeHandles(l.exit)};f._configureAttachmentsViewModel=function(){const {data:a,fullFeature:b}=this,{attachmentsCapabilities:c,viewModel:h}=
a,{attachmentsViewModel:t}=h;t.set({capabilities:c,graphic:b,filesEnabled:!1,mode:"view"});this.addHandles(x.watch(()=>t.mode,C=>{switch(C){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}}),l.exit)};f._configureFeatureFormViewModel=function(){const {edits:a,formTemplate:b,viewModel:{featureFormViewModel:c,view:h}}=this.data;c.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:b,map:h?.map,spatialReference:h.spatialReference});this.addHandles(c.on("value-change",
()=>{a.updateAttributes(c.getValues());this.fullFeature.attributes=a.feature.attributes}),l.exit)};f._onFullFeatureLoaded=function(a){this.fullFeature=a;const {edits:b}=this.data;b.updateAttributes(a.attributes);b.trackChanges()};d.create=async function(a){a=new n({data:await z.create(a),onCommit:this._onCommitFactory(a.applyEdits)});a._set("steps",this._createWorkflowSteps(a));return a};d._createWorkflowSteps=function(a){const {attachmentsViewModel:b}=a.data.viewModel;return[{id:"editing-attributes",
async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){b.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){b.mode="view"}}]};p._createClass(d,[{key:"editableItem",get:function(){return this.data.editableItem}},{key:"hasPendingEdits",get:function(){return this.data.edits.modified}},{key:"shouldShowAttachments",get:function(){return this.editableItem.attachmentsOnUpdateEnabled}},{key:"shouldAllowAttachmentEditing",get:function(){return this.editableItem.supports.includes("update")}},
{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const {layer:a}=this.editableItem,b=a.capabilities?.operations.supportsUpdate,c=q.getEffectiveLayerCapabilities(a)?.operations.supportsUpdate;return q.getEffectiveEditingEnabled(a)&&!a.editingEnabled||!!c&&!b}}]);return d}(A);e.UpdateRecordWorkflow._onCommitFactory=m=>async d=>{({edits:d}=d);const {feature:f}=d;if(f){var a=f.sourceLayer,b=f.clone();if(!d.attributesModified||d.stagedForDelete){var c=
a.objectIdField;b.attributes={[c]:f.getAttribute(c)};r.sceneLayerEditingEnabled()&&r.i3sPatchingEnabled()&&"scene"===a.type&&null!=a.infoFor3D&&(c=a.associatedLayer?.globalIdField,null!=c&&b.setAttribute(c,f.getAttribute(c)))}if(!d.geometryModified||d.stagedForDelete)b.geometry=null;await m(a,{[d.stagedForDelete?"deleteFeatures":"updateFeatures"]:[b]})}};g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"editableItem",null);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"fullFeature",
void 0);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"hasPendingEdits",null);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"shouldShowAttachments",null);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"shouldAllowAttachmentEditing",null);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"updating",null);g.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null);e.UpdateRecordWorkflow=n=g.__decorate([y.subclass("esri.widgets.Editor.UpdateRecordWorkflow")],
e.UpdateRecordWorkflow);e.HANDLE_KEYS=l;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
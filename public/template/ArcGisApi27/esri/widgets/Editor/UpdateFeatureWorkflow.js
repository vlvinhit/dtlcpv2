// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../support/featureFlags ../../views/support/layerViewUtils ./UpdateFeatureWorkflowData ./UpdateRecordWorkflow ./workflowUtils".split(" "),function(h,c,v,A,B,J,K,L,C,w,D,E,x,q){var t;const d={...x.HANDLE_KEYS,highlights:Symbol(),interactiveGraphics:Symbol(),
geometryGraphics:Symbol()};h.UpdateFeatureWorkflow=t=function(y){function e(a){a=y.call(this,a)||this;a.type="update-feature";a._layerViewEditSession=null;a._webStyleCache=new Map;return a}c._inherits(e,y);var f=e.prototype;f.initialize=async function(){const {edits:{feature:a},layerView:b}=this.data;q.canCreateInteractiveEditSession(b)&&(this._layerViewEditSession=b.createInteractiveEditSession(a))};f.destroy=function(){this._layerViewEditSession?.rollback()};f.commit=async function(){this.removeHandles(d.interactiveGraphics);
try{const a=this.data.edits.stagedForDelete;await c._get(c._getPrototypeOf(e.prototype),"commit",this).call(this);this.removeHandles(d.geometryGraphics);const b=this._layerViewEditSession;a?b?.rollback():b?.commit()}catch(a){throw this.removeHandles(d.geometryGraphics),await this._configureSketchViewModel(),new A("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:a});}};f.enter=async function(){await c._get(c._getPrototypeOf(e.prototype),"enter",
this).call(this);this.data.editableItem.geometryUpdatesEnabled?this.hasHandles(d.interactiveGraphics)||await this._configureSketchViewModel():this._configureHighlight()};f.exit=function(a={removeSketchHandles:!0}){c._get(c._getPrototypeOf(e.prototype),"exit",this).call(this,a);a.removeSketchHandles&&this.removeHandles([d.geometryGraphics,d.interactiveGraphics])};f._configureFeatureFormViewModel=function(){c._get(c._getPrototypeOf(e.prototype),"_configureFeatureFormViewModel",this).call(this);const {_layerViewEditSession:a}=
this,{viewModel:b}=this.data;this.addHandles(b.featureFormViewModel.on("value-change",k=>{a?.setAttribute(k.fieldName,k.value)}),d.exit)};f._configureHighlight=function(){const {edits:a,layerView:b}=this.data;D.highlightsSupported(b)&&this.addHandles(b.highlight(a.feature),d.highlights)};f._configureSketchViewModel=async function(){const {data:a,_layerViewEditSession:b}=this,{edits:k,viewModel:F}=a,u=k.feature,{featureFormViewModel:r,sketchViewModel:z,view:G}=F;z.allowDeleteKey=!1;const l=q.getVisualVariableAttributes(u),
{interactive:H,visual:I}=await q.setUpGeometryUpdate(u,l,z,G,({geometry:m,attributes:g},n)=>{k.updateAttributes(g);k.updateGeometry(m);r.feature.geometry=m;if(null!=l.rotation){var {field:p}=l.rotation;r.setValue(p,g[p])}null!=l.size&&({field:p}=l.size,r.setValue(p,g[p]));({sourceLayer:g}=u);null!=g&&"scene"===g.type&&null!=g.infoFor3D&&w.sceneLayerEditingEnabled()&&w.i3sPatchingEnabled()&&b&&null!=m&&"mesh"===m.type&&b.setGeometry(m);("undo"===n.type||"redo"===n.type||"update"===n.type&&null!=n.toolEventInfo&&
q.isTerminalUpdateEventType(n.toolEventInfo.type))&&r.notifyFeatureGeometryChanged()},this._webStyleCache);this.addHandles(H,d.interactiveGraphics);this.addHandles(I,d.geometryGraphics)};f._onFullFeatureLoaded=function(a){c._get(c._getPrototypeOf(e.prototype),"_onFullFeatureLoaded",this).call(this,a);const {edits:b}=this.data;b.updateGeometry(a.geometry);b.trackChanges()};e.create=async function(a){a=new t({data:await E.create(a),onCommit:this._onCommitFactory(a.applyEdits)});a._set("steps",this._createWorkflowSteps(a));
return a};return c._createClass(e)}(x.UpdateRecordWorkflow);v.__decorate([B.property()],h.UpdateFeatureWorkflow.prototype,"_layerViewEditSession",void 0);h.UpdateFeatureWorkflow=t=v.__decorate([C.subclass("esri.widgets.Editor.UpdateFeatureWorkflow")],h.UpdateFeatureWorkflow);h.HANDLE_KEYS=d;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
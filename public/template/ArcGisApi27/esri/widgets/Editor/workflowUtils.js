// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../Graphic ../../core/asyncUtils ../../core/has ../../core/handleUtils ../../core/lang ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../support/featureFlags ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils".split(" "),
function(J,n,U,V,qa,q,W,t,v,D,X,Y,Z,aa,K,L,M,ba,E,N,ca,F){function O(a){const b=a.sourceLayer;var c;if(!(c=!b||"feature"!==b.type)){a:switch(b.renderer?.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":case "pie-chart":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let d=c=null;var g=b.renderer.getVisualVariablesForType("rotation").filter(f=>(!f.axis||"heading"===f.axis)&&f.field&&!f.valueExpression&&null!=L.getRotationAngle(f,a));
1===g.length&&(c=da(g[0],b));g=b.renderer.getVisualVariablesForType("size").filter(f=>f.field&&!f.useSymbolValue&&!f.valueExpression&&K.getTransformationType(f)===K.TransformationType.RealWorldSize&&null!=L.getSize(f,a));1===g.length&&(d=ea(g[0],b));return{rotation:c,size:d}}function da(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,d=a.field,g=(b=b.fields&&b.fields.filter(k=>k.name===d))&&1===b.length?b[0].type:"double";var f=0,e=0;return{field:d,fieldType:g,getDefault:()=>
Promise.resolve(0),getValue:k=>{e=f-c*k;return G((e+360)%360,g)},initValue:k=>{f=null!=k?k:e;e=0},isUpdatingInteractively:!1,rotationType:a.rotationType??"geographic"}}function fa(a,b){switch(b){case "width":return a[0];case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}async function ha(a,b,c){if(null==b)return 0;({symbol:b}=ba.to3D(b));if(null==b||"web-style"===b.type||"cim"===b.type)return 0;b=b.symbolLayers.at(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=
await new Promise((g,f)=>J(["../../symbols/support/symbolLayerUtils"],g,f)),b.size||Math.min(r.icon,(await c(b,r.icon))[0])||r.icon;case "text":return b.size||r.text;case "line":return b.size||r.line;case "object":const {computeObjectLayerResourceSize:d}=await new Promise((g,f)=>J(["../../symbols/support/symbolLayerUtils"],g,f));a=await d(b,a.scale/r.viewScaleSizeFactor);return fa(a,c);case "path":return(null!=b.width?b.width:b.height)||a.scale/r.viewScaleSizeFactor;case "extrude":return b.size||
a.scale/r.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}}function ea(a,b){const c=a.field,d=a.axis,g=(b=b.fields&&b.fields.filter(l=>l.name===c))&&1===b.length?b[0].type:"double";var f=0,e=0;const k=aa.meterIn[a.valueUnit]??1;let h;h="area"===a.valueRepresentation?l=>(l*k/2)**2*Math.PI:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?l=>l*k/2:l=>l*k;return{field:c,fieldType:g,getDefault:async(l,m)=>G(h(await ha(m,l,d)),g),getValue:(l,m)=>{f||(f=m.pixelSizeAt(m.center));
e=f*l;return G(e,g)},initValue:l=>{f=null!=l?l:e;e=0},isUpdatingInteractively:!1,displayUnit:P(a.valueUnit),axis:a.axis}}function G(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}async function w(a,b){b=await E.getDisplayedSymbol(a,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:b});null!=X.diff(a.symbol,b)&&(a.symbol=b)}async function H(a,b,c){const d=b.layer,g={...b.template?.prototype.attributes};
await ia(a,d,g,c);a.layer.elevationInfo=d.elevationInfo;c=a.create;var f=d.geometryType;if(!f)throw Error("no geometry type");await c.call(a,"multipatch"===f?"mesh":f,{graphicProperties:{attributes:g,sourceLayer:d},hasZ:d.capabilities.data.supportsZ,geometryToPlace:b.geometryToPlace??void 0})}async function ia(a,b,c,d){b=new U({sourceLayer:b,attributes:c});const {rotation:g,size:f}=O(b);let e=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d}),k=!1;for(const h of[f,g])null!=h&&null==
c[h.field]&&(c[h.field]=await h.getDefault(e,a.view),k=!0);k&&(e=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d}));switch(e?.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=e;break;case "simple-line":case "line-3d":a.polylineSymbol=e;break;case "simple-marker":case "picture-marker":case "point-3d":case "cim":a.pointSymbol=e}Q(a.tooltipOptions,f,g)}function Q(a,b,c){a.visualVariables=null!=b||null!=c?{size:null!=b?{unit:b.displayUnit,axis:b.axis,valueType:b.fieldType}:null,
rotation:null!=c?{valueType:c.fieldType,rotationType:c.rotationType??"geographic"}:null}:null}async function ja(a,b,c,d){if(0===a.length)return[];const {updatable:g,graphicsByLayer:f}=await c.async(async()=>{var {results:e}=await t.whenOrAbort(F.hitTestSelectSimilarDistance(b,c),d);const k=new Map;F.filterGraphicHits(e).forEach(({graphic:h})=>{var l=h.layer;var m=k.get(l);m?l=m:(m=[],k.set(l,m),l=m);return l.push(h)});e=a.filter(({supports:h,layer:l})=>h.includes("update")&&k.has(l));0!==e.length&&
c.stopPropagation();return{updatable:e,graphicsByLayer:k}});return t.whenOrAbort(t.eachAlways(g.map(async({layer:e})=>{var {objectIdField:k}=e,h="displayField"in e?e.displayField:null;const l=[k];null!=h&&e.fieldsIndex.has(h)&&l.push(h);k=f.get(e);return k.some(m=>l.some(u=>!(u in m.attributes)))?(h=e.createQuery(),h.outFields=l,h.returnGeometry=!1,h.objectIds=k.map(m=>m.getObjectId()),e.queryFeatures(h,{signal:d}).then(({features:m})=>m)):k})),d)}async function ka(a,b,c,d){if(0===a.length)return[];
let g=null;const f=await c.async(async()=>{var {results:e}=await t.whenOrAbort(b.hitTest(c),d);if(0===e.length)return[];const k=new Set;g=F.filterGraphicHits(e);g.forEach(({graphic:h})=>h&&k.add(h.layer));e=a.items.filter(({layer:h,supports:l,attachmentsOnUpdateEnabled:m})=>k.has(h)&&(l.includes("update")||l.includes("delete")||m));0<e.length&&c.stopPropagation();return e});return t.whenOrAbort(t.eachAlways(f.map(({layer:e})=>{var k=e.objectIdField,h=Y.getDisplayFieldName({displayField:"displayField"in
e?e.displayField:null,fields:e.fields});k=[k];null!=h&&e.fieldsIndex.has(h)&&k.push(h);h=e.createQuery();h.outFields=k;h.returnGeometry=!1;k="renderer"in e?Z.calculateTolerance({renderer:e.renderer,event:c}):0;h.geometry=ca.createQueryGeometry(c.mapPoint,k,b);h.outSpatialReference=b.spatialReference;return e.queryFeatures(h,{signal:d}).then(({features:l})=>{g?.forEach(({graphic:m})=>{m.layer!==e||l.some(u=>u.getObjectId()===m.getObjectId())||l.push(m)});return l})})),d)}async function I(a){const {graphic:b,
sketchViewModel:c,sourceLayer:d,visualVariables:g,webStyleCache:f}=a;let e=!1;const {rotation:k,size:h}=g;[k,h].forEach(async l=>{if(null!=l){var m=b.getAttribute(l.field);null!=m?l.initValue(m):(m=await l.getDefault(b.symbol,c.view),l.initValue(m),b.setAttribute(l.field,m),e=!0)}});e&&await w(b,f);a={multipleSelectionEnabled:!1};"point"===d.geometryType&&(a.enableRotation=null!=k,a.enableScaling=null!=h);Q(c.tooltipOptions,h,k);c.layer.elevationInfo=d.elevationInfo;return c.update(b,a)}async function R(a,
b,c,d,g){if(null!=b.geometry&&"point"===b.geometry?.type){var f=d.rotation;var e=c.toolEventInfo;e=null==e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e;if(null!=f&&null!=e)if("rotate-stop"===e.type)f.isUpdatingInteractively=!1,f.initValue();else{f.isUpdatingInteractively=!0;const {field:k,getValue:h}=f;b.setAttribute(k,h(e.angle,a))}d=d.size;c=c.toolEventInfo;c=null==c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(null!=d&&null!=c)if("scale-stop"===
c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:k,getValue:h}=d;b.setAttribute(k,h(c.xScale,a))}await w(b,g)}}function la(a,b,c){function d(h){k?.abort();k=V.createTask(async l=>{const m=await z(g,f);t.throwIfAborted(l);m.setVisibility?.(e,h)})}const g=a.view,f=b.sourceLayer,e=b.getAttribute(b.layer.objectIdField);let k=null;d(!1);return q.handlesGroup([ma(g,c,h=>d(!h)),q.makeHandle(async()=>{d(!0);const h=await z(g,f);await v.whenOnce(()=>!h.updating);
a.layer.remove(c)})])}function ma(a,b,c){if("3d"===a.type){const d=new N.GraphicState({graphic:b});return q.handlesGroup([a.trackGraphicState(d),v.watch(()=>d.displaying,c)])}return v.watch(()=>b.visible,c)}async function S(a,b){if("3d"===a.type){const c=new N.GraphicState({graphic:b});a=a.trackGraphicState(c);await v.whenOnce(()=>c.displaying);a.remove()}else await v.whenOnce(()=>b.visible)}function P(a){switch(a){case "unknown":case "decimal-degrees":return null;default:return a}}function A(a){const b=
a.geometry;if("mesh"===b?.type){const c=a.cloneShallow();c.attributes=W.clone(a.attributes);c.geometry=b.cloneShallow();c.geometry.transform=b.transform?.clone()??null;return c}return a.clone()}const r={icon:D.px2pt(24),text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100},z=(a,b)=>a.whenLayerView("subtype-sublayer"===b.type?b.parent:b),T=Symbol();n.UsesSketchViewModelSymbol=T;n.avoidFeatureTemplateSelectionWithOnlyOneItem=function(a,b){a.viewModel.refreshCreationTemplates();if("awaiting-feature-creation-info"===
b[0].id){var c=a.viewModel.featureTemplatesViewModel.items;1!==c.length?c=null:(c=c[0],c="items"in c?1===c.items.length?c.items[0]:null:c);null==c||c.supportsUpload||(a.creationInfo=c,b.shift())}return b};n.canCreateInteractiveEditSession=function(a){return"createInteractiveEditSession"in a};n.cloneGraphicExceptMesh=A;n.createWorkflowSteps=function(a,b,c){let d=!1;return a.filter(g=>d?!0:d=g===b).map(g=>c[g]())};n.fetchCandidates=async function(a,b,c,d){switch(b.type){case "3d":return ja(a,b,c,d);
case "2d":return ka(a,b,c,d)}};n.fetchFullFeature=async function(a,b,c){const {sourceLayer:d}=a,g=d.createQuery();g.objectIds=[a.getAttribute(d.objectIdField)];g.outFields=["*"];g.outSpatialReference=b;g.returnM=d.capabilities.data.supportsM;g.returnZ=d.capabilities.data.supportsZ;M.sceneLayerEditingEnabled()&&M.i3sPatchingEnabled()&&"scene"===d.type&&null!=d.infoFor3D&&(g.returnGeometry=!0,g.formatOf3DObjects="3D_glb");a=await d.queryFeatures(g,{signal:c});t.throwIfAborted(c);return a.features[0]};
n.findLayerInfo=function(a,b){return a?a.find(c=>c.layer===b):void 0};n.getVisualVariableAttributes=O;n.isTerminalUpdateEventType=a=>/-stop/.test(a)||/vertex-/.test(a);n.prepareAttachmentsForCreateWorkflow=function(a){a.filesEnabled=!0;a.mode="view";a.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}};n.setUpFeatureAdd=async function(a,b,c,d){await H(a,b,d);const g=a.on("create",async f=>{if("cancel"===f.state)return H(a,b,d);"complete"===f.state&&(f=f.graphic,f.sourceLayer||(f.sourceLayer=
b.layer),f.attributes||(f.attributes={...b.template?.prototype.attributes}),await w(f,d),c(f))});return q.handlesGroup([g,q.makeHandle(()=>a.cancel())])};n.setUpGeometryUpdate=async function(a,b,c,d,g,f){const e=A(a);await w(e,f);d.map.add(c.layer);c.layer.add(e);const k=a.sourceLayer;var h=z(d,k);await S(d,e);await I({graphic:e,sketchViewModel:c,sourceLayer:k,visualVariables:b,webStyleCache:f});const l=la(c,a,e);let m=null;h.then(p=>m=p).catch(()=>{});const u=b.size,B=b.rotation;h=v.watch(()=>a.attributes,
async p=>{let x=!1;for(const y in p){const C=p[y];C!==e.getAttribute(y)&&(e.setAttribute(y,C),null==u||u.isUpdatingInteractively||u.field!==y||u.initValue(C),null==B||B.isUpdatingInteractively||B.field!==y||B.initValue(C),null==m||m.requiredFields.includes(y))&&(x=!0)}x&&await w(e,f)});const na=c.on("update",async p=>{const x=p.graphics[0];if("complete"===p.state)return I({graphic:x,sketchViewModel:c,sourceLayer:k,visualVariables:b,webStyleCache:f});await R(d,x,p,b,f);g(A(x),p)}),oa=c.on(["undo",
"redo"],async p=>{g(A(p.graphics[0]),p)}),pa=c.updateOnGraphicClick;return{visual:q.handlesGroup([l,q.makeHandle(()=>{c.updateOnGraphicClick=pa})]),interactive:q.handlesGroup([oa,na,q.makeHandle(()=>c.cancel()),h,q.makeHandle(()=>{c.updateOnGraphicClick=!1})])}};n.shouldShowAttachmentsForCreateWorkflow=function(a){const {creationInfo:b,viewModel:c}=a;if(!b)return!1;const {layer:d}=b;if(a=c.editableItems.find(f=>f.layer===d))return a.attachmentsOnCreateEnabled;a=d.capabilities?.data;const g=c.layerInfos?.find(f=>
f.layer===d);return!(!(a&&"supportsAttachment"in a&&a.supportsAttachment)||g&&(!1===g.allowAttachments||!1===g.attachmentsOnUpdateEnabled))};n.showProgressCursor=function(a){const b=a.cursor;a.cursor="progress";return q.makeHandle(()=>a.cursor=b)};n.sizeDefaults=r;n.sizeVariableUnitToLengthUnit=P;n.startCreatingNewFeature=H;n.startUpdatingFeature=I;n.updateGraphicSymbolWhenRequired=w;n.visualVariableInteractiveUpdate=R;n.whenEditorLayerView=z;n.whenGraphicDisplayed=S;n.workflowUsesSketchViewModel=
function(a){return a&&"object"===typeof a&&T in a};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
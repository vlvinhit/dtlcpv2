// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Collection ../../core/deprecate ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/support/editableLayers ../../layers/support/layerUtils ../../portal/support/urlUtils ../Attachments/AttachmentsViewModel ./CreateFeaturesWorkflow ./CreateWorkflow ./deprecationUtils ./UpdateWorkflow ./workflowUtils ../FeatureForm/featureFormUtils ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(x,g,G,B,H,y,f,I,J,C,K,m,k,ba,ca,da,L,M,N,z,O,P,Q,R,A,S,T,D,U,V,W,X){function r(u,t,h){v.error(new y(u,t,h))}function Y(u,t){return u?u.find(h=>h.layer===t):void 0}const v=J.getLogger("esri.widgets.Editor.EditorViewModel"),E=["create","create-features","update"];f=function(u){function t(a){var b=u.call(this,a)||this;b._editableItems=new B;b._sketchGraphicsLayer=new M({listMode:"hide",internal:!0});b._updateEditableItemsTask=null;b.activeWorkflow=null;b._activityQueue=[];b.failures=[];b.attachmentsViewModel=
new P({capabilities:{editing:!0}});b.featureFormViewModel=new U;b.featureTemplatesViewModel=new V;b.sketchViewModel=new W({layer:b._sketchGraphicsLayer});b.spinnerViewModel=new X;b.pageStack=[];b.showDiscardEditsPrompt=()=>Promise.resolve(!0);b._candidateCommitted=!1;b.useDeprecatedCreateWorkflow=!1;b.back=async()=>{b.canGoBack&&(b.activeWorkflow?.hasPreviousStep?await b.activeWorkflow.back(b.showDiscardEditsPrompt):await b._cancelWorkflow({force:!b.hasPendingEdits}))};b.saveWorkflow=async()=>{const {featureFormViewModel:c}=
x._assertThisInitialized(b);c.submit();if(c.submittable){var d=c.getValues();0<c.validateContingencyConstraints(d,{includeIncompleteViolations:!0}).length||await b.activeWorkflow?.save()}};b.selectFeature=(c,d=!1)=>{const e=b.activeWorkflow;b._candidateCommitted||"update"!==e?.type||(e.data.rootFeature=c,d&&(e.next(),b._candidateCommitted=!0))};return b}x._inherits(t,u);var h=t.prototype;h.initialize=function(){this.addHandles([m.watch(()=>{const a=this.view?.map?.editableLayers.filter(({parent:c,
visible:d})=>c&&"visible"in c?d&&c.visible:d),b=this.view?.allLayerViews?.filter(c=>!!a?.includes(c.layer)&&!c.suspended);return[a,b,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditableItems(),m.initial),m.on(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),m.on(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),m.on(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit");this._set("activeWorkflow",null)}),m.when(()=>this.view?.map,a=>a.add(this._sketchGraphicsLayer),
m.initial),m.watch(()=>this._editableItems.toArray(),()=>{const {activeWorkflow:a}=this;this.refreshCreationTemplates();if(a){var {stepId:b}=a;"create"===a.type?"awaiting-feature-creation-info"!==b||this.canCreate||this._cancelWorkflow():"update"===a.type&&("awaiting-feature-to-update"===b&&!this.canUpdate||"awaiting-update-feature-candidate"===b&&!a.data.candidates.some(c=>{const d=this._editableItems.find(e=>e.layer===c.layer);return d&&d.supports.includes("update")}))&&this._cancelWorkflow()}}),
m.watch(()=>this.page,(a,b)=>{const c=this.pageStack.slice();a=c.indexOf(a);-1===a&&b?c.push(b):c.splice(a);this.pageStack=c}),m.when(()=>"awaiting-update-feature-candidate"===this.state,()=>this._candidateCommitted=!1),m.on(()=>this.featureTemplatesViewModel,"select",async({item:a,oldItem:b})=>{const {activeWorkflow:c}=this,d=!!a&&a.id===b?.id,e="create-features"===c?.type&&c.data.upload?.error;if(c)try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return this.featureTemplatesViewModel.select(b,
{emit:!1})}if(a&&(!d||e)){b={layer:a.layer,template:a.template};if(a.supportsUpload)return this.startCreateFeaturesWorkflow(b);this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(b):this.startCreateFeaturesWorkflowAtFeatureCreation(b)}}),m.on(()=>this.view,"key-down",a=>{"Escape"===a.key&&this.activeWorkflow?.keyboardCancellationEnabled&&this.back()})])};h.destroy=function(){this._cancelWorkflow().then(()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer);this.view=
null});this._updateEditableItemsTask=C.abortMaybe(this._updateEditableItemsTask)};h.startCreateWorkflowAtFeatureTypeSelection=async function(){A.workflowDeprecation(v,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection");await m.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var a=this._createCreateWorkflow();await a.start();this._set("activeWorkflow",a)}else r("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};
h.startCreateFeaturesWorkflowAtFeatureTypeSelection=async function(){return this.startCreateFeaturesWorkflow()};h.startCreateWorkflowAtFeatureCreation=async function(a){A.workflowDeprecation(v,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation");await m.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("awaiting-feature-to-create");b.data.creationInfo=a;await b.start();this._set("activeWorkflow",b)}else r("editing:unsupported-workflow",
"Create workflow is unsupported or disabled.")};h.startCreateFeaturesWorkflowAtFeatureCreation=async function(a){return this.startCreateFeaturesWorkflow(a,"creating-features")};h.startCreateFeaturesWorkflow=async function(a,b="awaiting-feature-creation-info"){await m.whenOnce(()=>!this.updating);if(!this.canCreate)throw new y("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();a=this._createCreateFeaturesWorkflow(a,b);await a.start();this._set("activeWorkflow",
a)};h.startCreateWorkflowAtFeatureEdit=async function(a){A.workflowDeprecation(v,"startCreateWorkflowAtFeatureEdit");await m.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("editing-new-feature");b.data.edits.feature=a;await b.start();this._set("activeWorkflow",b)}else r("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};h.startUpdateWorkflowAtFeatureSelection=async function(){await m.whenOnce(()=>!this.updating);
if(this.canUpdate){await this._cancelWorkflow();var a=this._createUpdateWorkflow();await a.start();this._set("activeWorkflow",a)}else r("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};h.startUpdateWorkflowAtMultipleFeatureSelection=async function(a){await m.whenOnce(()=>!this.updating);if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("awaiting-update-feature-candidate");b.data.candidates=a;await b.start();this._set("activeWorkflow",b)}else r("editing:unsupported-workflow",
"Update workflow is unsupported or disabled.")};h.startUpdateWorkflowAtFeatureEdit=async function(a){await m.whenOnce(()=>!this.updating);if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("editing-existing-feature");b.data.rootFeature=a;await b.start();this._set("activeWorkflow",b)}else r("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};h.deleteFeatureFromWorkflow=async function(){const {activeWorkflow:a}=this;a&&"update"===a.type?await a.deleteActiveFeature():
r("editing:unsupported-workflow","Deleting requires an active update workflow.")};h.cancelWorkflow=async function(a){return this._cancelWorkflow({warn:!0,...a})};h.findEditableItemForLayer=function(a){const b="subtype-sublayer"===a.type?a.parent:a;return this._editableItems.find(c=>c.layer===b)};h.itemHasInvalidFormTemplate=function(a){return a?this.findEditableItemForLayer(a.layer)?.hasInvalidFormTemplate??!1:!1};h.itemHasUnsupportedFields=function(a){return a?this.findEditableItemForLayer(a.layer)?.hasUnsupportedFields??
!1:!1};h.refreshCreationTemplates=function(){const a=[];for(const {layer:b,supports:c}of this._editableItems)b.loaded&&c.includes("create")&&a.push(b);this.featureTemplatesViewModel.layers=a};h.toggleUpdateWorkflow=async function(){!this.canUpdate||this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&"awaiting-feature-to-update"===this.state?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection())};h._updateEditableItems=async function(){C.abortMaybe(this._updateEditableItemsTask);
const a=G.createTask(async b=>{const c=this.view?.allLayerViews;var d=this.view?.map,e=d?.editableLayers.toArray()??[];d=d?.allTables.toArray().filter(z.isFeatureLayer)??[];await Promise.all(d.map(l=>l.load()));d=d.filter(l=>N.isEditableLayer(l));var q=[...e.reverse(),...d.reverse()].filter(l=>"mesh"===l.geometryType?"3d"===this.view?.type:!0);if(c&&e){e=[];d=[];for(const l of q){const p=(q=c.find(n=>n.layer===l))?e:d;if("subtype-group"===l.type){await l.loadAll();K.throwIfAborted(b);for(let n=l.sublayers.length-
1;0<=n;--n)p.push(this._makeEditableItemForLayer(l.sublayers.at(n),!!q?.suspended))}else p.push(this._makeEditableItemForLayer(l,!!q?.suspended))}b.aborted||(b=this._editableItems,this._editableItems=new B(e.concat(d)),b.destroy())}});this.updatingHandles.addPromise(a.promise);this._updateEditableItemsTask=a};h._cancelWorkflow=async function(a){const b=this.activeWorkflow;b?a&&!1===a.force?(await b.cancel(a),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",
null),await b.cancel(a)):a&&a.warn&&r("editing:no-active-workflow","There is no active workflow to cancel.")};h._createCreateFeaturesWorkflow=function(a,b){return Q.create({viewModel:this,creationInfo:a,startAt:b,applyEditsCallback:(c,d,e)=>this._applyEdits(c,d,e),addAttachmentsCallback:(c,d)=>this._addAttachments(c,d)})};h._createCreateWorkflow=function(a){return R.create(this,a,(b,c,d)=>this._applyEdits(b,c,d))};h._createUpdateWorkflow=function(a){return S.create(this,a,(b,c)=>this._applyEdits(b,
c))};h._addAttachments=function(a,b){b=b.map(c=>this._addAttachment(a,c.feature,c.attachment))??[];return Promise.all(b)};h._addAttachment=async function(a,b,c){let d=null;if("geojson"===a.type||"scene"===a.type||"oriented-imagery"===a.type)throw new y("editor:attachments-not-supported","Adding attachments is not supported for this layer type");await this._queueOperation(async()=>d=await a.addAttachment?.(b,c).catch(e=>{throw e?.error||e;})??null);return d};h._applyEdits=async function(a,b,c){let d=
null;const e=a.url?await z.getOwningPortalUrl(a.url):null,q={returnServiceEditsOption:e&&O.parseKnownArcGISOnlineDomain(e)||RegExp("/hosted/","i").test(a.url)?void 0:"original-and-current-features",...c};await this._queueOperation(async()=>{const l=await T.whenEditorLayerView(this.view,a).catch(()=>null);d=await a.applyEdits(b,q);l&&await m.whenOnce(()=>!l.updating);return d});return d};h._queueOperation=function(a){this._activityQueue.push(a);this.notifyChange("syncing");const b=(c,d)=>{c=d.indexOf(c);
-1<c&&d.splice(c,1)};return a().then(c=>{if("error"in c&&c.error)throw c.error;if("addFeatureResults"in c){const {addFeatureResults:d,deleteFeatureResults:e,updateFeatureResults:q}=c,l=d.find(p=>!!p.error)||q.find(p=>!!p.error)||e.find(p=>!!p.error);if(l)throw l.error;}return c}).catch(c=>{r("editing:operation-error","An error occurred.",{error:c});const d={error:c,retry:()=>{b(d,this.failures);return this._queueOperation(a)},cancel:()=>{b(d,this.failures)}};this._set("failures",[...this.failures,
d])}).then(()=>{b(a,this._activityQueue);this.notifyChange("syncing")})};h._makeEditableItemForLayer=function(a,b=!0){const c=z.getEffectiveLayerCapabilities(a);var d=c?.operations;const e=Y(this.layerInfos,a),q=D.formTemplateHasInvalidFields(a),l=a.fields.some(({type:Z})=>D.unsupportedDateFieldTypes.has(Z)),p=q||l;var {allowedWorkflows:n}=this;const F=n.includes("create")||n.includes("create-features");var w=n.includes("update");const aa=F&&!!d?.supportsAdd&&(!e||!1!==e.enabled&&!1!==e.addEnabled);
n=w&&!!d?.supportsUpdate&&(!e||!1!==e.enabled&&!1!==e.updateEnabled);w=!p&&w&&!!d?.supportsDelete&&(!e||!1!==e.enabled&&!1!==e.deleteEnabled);d=[];b||(aa&&d.push("create"),n&&d.push("update"),w&&d.push("delete"));b=!!c?.data?.supportsAttachment&&(!e||!1!==e.allowAttachments);return{layer:a,supports:d,attributeUpdatesEnabled:n&&!p&&(!e||!1!==e.attributeUpdatesEnabled),geometryUpdatesEnabled:n&&!p&&!!c?.editing?.supportsGeometryUpdate&&(!e||!1!==e.geometryUpdatesEnabled),hasAttachments:b,attachmentsOnCreateEnabled:b&&
F&&(!e||!1!==e.attachmentsOnCreateEnabled),attachmentsOnUpdateEnabled:!p&&b&&(!e||!1!==e.attachmentsOnUpdateEnabled),hasInvalidFormTemplate:q,hasUnsupportedFields:l}};x._createClass(t,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||(a=[...E]);this._set("allowedWorkflows",a)}},{key:"canCreate",get:function(){return this._editableItems.some(a=>a.supports.includes("create"))}},{key:"canUpdate",get:function(){return this._editableItems.some(({attachmentsOnUpdateEnabled:a,
layer:b,supports:c})=>{a=c.includes("update")||c.includes("delete")||a;c=b.parent;c=!(c&&"visible"in c)||!!c.visible;return b.visible&&c&&a})}},{key:"editableItems",get:function(){return this._editableItems}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},set:function(a){this.sketchViewModel.labelOptions=a}},{key:"layerInfos",set:function(a){a?.some(b=>{"allowAttachments"in b&&H.deprecated(v,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",
version:"4.26"});return!0});this._set("layerInfos",a)}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(a){this.sketchViewModel.snappingOptions=a}},{key:"state",get:function(){if(!this.get("view.ready")||0===this._editableItems.length)return"disabled";var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?a.stepId:"ready"}},{key:"syncing",get:function(){return 0<
this._activityQueue.length}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(a){this.sketchViewModel.tooltipOptions=a}},{key:"view",set:function(a){this.sketchViewModel.view=a;this.spinnerViewModel.view=a;this._set("view",a)}},{key:"page",get:function(){const {activeWorkflow:a,state:b}=this;return"awaiting-feature-to-update"===b||"awaiting-feature-to-create"===b||"create-features"===
a?.type&&0===a.numPendingFeatures?"ready":b??"disabled"}},{key:"selectedTemplateItem",get:function(){var {activeWorkflow:a}=this;if("create-features"===a?.type&&0===a.numPendingFeatures&&(a=a.data.creationInfo?.template))for(const b of this.featureTemplatesViewModel.items)if("findByTemplate"in b){const c=b.findByTemplate(a);if(c)return c}else if(b.template===a)return b}},{key:"featureFormDisabled",get:function(){const {activeWorkflow:a}=this;return"update"===a?.type&&!1===a.activeEditableItem?.attributeUpdatesEnabled}},
{key:"canGoBack",get:function(){return null!=this.activeWorkflow&&!this.syncing}},{key:"shouldShowDeleteButton",get:function(){const {activeWorkflow:a}=this;return!!a&&"update"===a.type&&!!a.activeEditableItem?.supports.includes("delete")}},{key:"hasPendingEdits",get:function(){return this.activeWorkflow?.hasPendingEdits??!1}}]);return t}(I.HandleOwnerMixin(f.EventedAccessor));g.__decorate([k.property()],f.prototype,"_editableItems",void 0);g.__decorate([k.property({readOnly:!0})],f.prototype,"activeWorkflow",
void 0);g.__decorate([k.property({readOnly:!0})],f.prototype,"_activityQueue",void 0);g.__decorate([k.property({value:[...E]})],f.prototype,"allowedWorkflows",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"canCreate",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"canUpdate",null);g.__decorate([k.property()],f.prototype,"editableItems",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"failures",void 0);g.__decorate([k.property()],f.prototype,"attachmentsViewModel",
void 0);g.__decorate([k.property()],f.prototype,"featureFormViewModel",void 0);g.__decorate([k.property()],f.prototype,"featureTemplatesViewModel",void 0);g.__decorate([k.property()],f.prototype,"labelOptions",null);g.__decorate([k.property()],f.prototype,"layerInfos",null);g.__decorate([k.property()],f.prototype,"sketchViewModel",void 0);g.__decorate([k.property()],f.prototype,"snappingOptions",null);g.__decorate([k.property()],f.prototype,"spinnerViewModel",void 0);g.__decorate([k.property()],f.prototype,
"state",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"syncing",null);g.__decorate([k.property()],f.prototype,"updating",null);g.__decorate([k.property()],f.prototype,"tooltipOptions",null);g.__decorate([k.property()],f.prototype,"view",null);g.__decorate([k.property()],f.prototype,"pageStack",void 0);g.__decorate([k.property()],f.prototype,"showDiscardEditsPrompt",void 0);g.__decorate([k.property()],f.prototype,"_candidateCommitted",void 0);g.__decorate([k.property()],f.prototype,"page",
null);g.__decorate([k.property()],f.prototype,"selectedTemplateItem",null);g.__decorate([k.property()],f.prototype,"featureFormDisabled",null);g.__decorate([k.property()],f.prototype,"canGoBack",null);g.__decorate([k.property()],f.prototype,"shouldShowDeleteButton",null);g.__decorate([k.property()],f.prototype,"hasPendingEdits",null);g.__decorate([k.property()],f.prototype,"useDeprecatedCreateWorkflow",void 0);return f=g.__decorate([L.subclass("esri.widgets.Editor.EditorViewModel")],f)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../layers/support/layerUtils ../../../rest/support/AttachmentQuery".split(" "),function(x,k,B,g,q,v,m,C,D,l,J,E,t,F){function w(u,
n,d){G.error(new m(u,n,d))}const G=D.getLogger("esri.widgets.FeatureTable.support.FeatureStore");g=function(u){function n(a){a=u.call(this,a)||this;a._loaded=!1;a._loadError=!1;a._loading=!1;a._editOperationQueue=[];a._queryOperationQueue=[];a._objectIdCache=new v;a._hasStaleCache=!1;a.count=0;a.failures=new v;a.itemCache=new v;a.relatedRecordsEnabled=!1;return a}x._inherits(n,u);var d=n.prototype;d.destroy=function(){this.layer=null;this.itemCache?.destroy();this.failures?.destroy();this._set("itemCache",
null)};d.load=async function(){this._reset();const {layer:a}=this;if(a){this._loading=!0;this.notifyChange("state");try{await a.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(b){throw this._reset(),this._loadError=!0,this.notifyChange("state"),w("store:load-error","An error ocurred.",{error:b}),b;}}};d.refreshLayerInfo=async function(){return this._syncLayerInfo()};d.addItems=async function(a){};d.fetchItems=async function(a){const {page:b,pageSize:c}=
a;a=b*c;const e=a+c,{layer:h,state:f}=this;if(!h||"loaded"!==f)return[];this.notifyChange("querying");a=await this._query({start:a,num:e,page:b,pageSize:c});this.notifyChange("state");return a};d.verifyFeaturesByObjectId=async function(a){const {layer:b,state:c}=this;if(!b||"loaded"!==c)return[];const {features:e}=await this._verifyFeaturesByObjectId(a);return a.map(h=>e.some(f=>f?.getObjectId()===h))};d.query=async function(a){const {layer:b,state:c}=this;if(!b||"loaded"!==c)return[];this.notifyChange("querying");
a=await this._query(a);this.notifyChange("state");return a};d.removeItemAt=async function(a){};d.reset=async function(){this._reset()};d.updateItem=async function(a){return this._update(a).then(()=>{})};d.deleteRowsByObjectId=async function(a){return this._delete({objectIds:a})};d.getLocalItemByKey=function(a){return this.getItemByObjectId(a)};d.getItemByObjectId=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.find(e=>e.feature?.attributes[c]===a)};d.getLocalItemAt=function(a){return this.itemCache.at(a)};
d.at=function(a){return Promise.resolve(this.itemCache.at(a))};d.getObjectIdIndex=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.findIndex(e=>e.feature?.attributes[c]===a)};d._reset=function(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIdCache.removeAll();this.notifyChange("querying");this.notifyChange("syncing");
this.notifyChange("state")};d._getIdsFromFeatures=function(a){return a.map(b=>b.attributes[this.layer.objectIdField])};d._toFeatureData=function(a,b){const {layer:{objectIdField:c}}=this;return a.map(e=>{var {attributes:h}=e;h=h[c];return{objectId:h,feature:e,attachments:b?b[h]:null,relatedRecords:null}})};d._update=async function(a){const {layer:b}=this,{operations:c}=t.getEffectiveLayerCapabilities(b);if(!(c.supportsUpdate&&"applyEdits"in b))throw new m("store:update-error","Update is not supported.");
const {index:e,name:h,value:f}=a;a=await this.at(e);if(!a||!a.feature)throw new m("store:update-error","Feature with provided 'objectId' not found.");const {feature:r}=a,p=C.clone(r.attributes);p[h]=f;a=new B({attributes:p});const I=b.applyEdits({updateFeatures:[a]}).then(y=>{const {updateFeatureResults:z}=y,A=z.find(H=>!!H.error);if(A)throw A.error;z.length&&(r.attributes=p);return y});return this._queueEditOperation(()=>I)};d._delete=async function(a){const {layer:b}=this,{operations:c}=t.getEffectiveLayerCapabilities(b);
if(!(c.supportsDelete&&"applyEdits"in b))throw new m("store:delete-error","Delete is not supported.");({objectIds:a}=a);const e=a.map(h=>this.getItemByObjectId(h)?.feature).filter(q.isSome);return this._queueEditOperation(()=>b.applyEdits({deleteFeatures:e}))};d._query=async function(a){const {refresh:b}=a;if(!0===b)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(a));this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(a)};
d._queryFeatureData=async function(a){return this._queueQueryOperation(async()=>{const {features:b}=await this._queryFeatures(a);var c=this._getIdsFromFeatures(b);c=await this._queryAttachments(c);return this._toFeatureData(b,c)||[]})};d._syncLayerInfo=async function(){await this._updateCount();await this._updateIds()};d._updateCount=async function(){await this._queryCount().then(a=>this._set("count",a))};d._updateIds=async function(){this.layer?.capabilities?.query?.supportsPagination||(this._objectIdCache.removeAll(),
await this._queryForObjectIds().then(a=>this._objectIdCache.addMany(a)))};d._queryCount=function(){const {filterGeometry:a,layer:b}=this,c=b.capabilities?.query?.supportsCacheHint,e=b.createQuery();e.geometry=a;e.returnGeometry=!1;e.where=this._getWhere();e.timeExtent=this._getTimeExtent();e.objectIds=this.objectIds;c&&(e.cacheHint=!0);return b.queryFeatureCount(e)};d._queryForObjectIds=function(){const {filterGeometry:a,layer:b,orderByFields:c}=this;var e=b.capabilities?.query;const h=e?.supportsCacheHint;
e=e?.supportsOrderBy;const f=b.createQuery();f.geometry=a;f.outFields=[b.objectIdField];f.returnGeometry=!1;f.where=this._getWhere();f.timeExtent=this._getTimeExtent();f.objectIds=this.objectIds;e&&(f.orderByFields=c);h&&(f.cacheHint=!0);return b.queryObjectIds(f)};d._queryFeatures=async function(a){const {layer:b}=this;if(!t.getEffectiveLayerCapabilities(b)?.operations.supportsQuery)throw new m("store:query-error","Layer does not support query operation.");const {filterGeometry:c,orderByFields:e,
returnGeometry:h}=this,f=this.layer?.capabilities?.query,{start:r,pageSize:p}=a;a=b.createQuery();a.returnGeometry=h;f?.supportsPagination?(a.start=r,a.num=p,a.where=this._getWhere(),a.timeExtent=this._getTimeExtent(),a.objectIds=this.objectIds):a.objectIds=this.objectIds||this._getObjectIdsForPage(r,p??0);f?.supportsOrderBy&&(a.orderByFields=e);c&&(a.geometry=c);f?.supportsCacheHint&&(a.cacheHint=!0);return b.queryFeatures(a)};d._verifyFeaturesByObjectId=async function(a){const {layer:b}=this;if(!t.getEffectiveLayerCapabilities(b)?.operations.supportsQuery)throw new m("store:query-error",
"Layer does not support query operation.");const {filterGeometry:c,orderByFields:e}=this,h=this.layer?.capabilities?.query,f=b.createQuery();f.where=this._getWhere();f.timeExtent=this._getTimeExtent();f.returnGeometry=!1;f.objectIds=a;f.outFields=[b.objectIdField];h?.supportsOrderBy&&(f.orderByFields=e);c&&(f.geometry=c);h?.supportsCacheHint&&(f.cacheHint=!0);return b.queryFeatures(f)};d._getObjectIdsForPage=function(a,b){const c=this._objectIdCache.toArray();return c.length>=a+b?c.slice(a,a+b):c.slice(a)};
d._queryAttachments=function(a){const {attachmentsEnabled:b,layer:c}=this,{capabilities:e}=c;return b&&e?.data.supportsAttachment&&e?.operations?.supportsQueryAttachments&&"queryAttachments"in c?c.queryAttachments(new F({objectIds:a,where:this._getWhere()})):Promise.resolve(null)};d._syncLocalCache=function(a){a.forEach(b=>{if(b.feature){var c=b.feature.getObjectId();null!=c&&(c=this.getObjectIdIndex(c),-1===c?this.itemCache.add(b):this.itemCache.splice(c,1,b))}})};d._queueQueryOperation=function(a){this._queryOperationQueue.push(a);
this.notifyChange("querying");return a().then(b=>this._queryOperationQueue.includes(a)?(this._syncLocalCache(b),b):[]).catch(b=>{w("store:query-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);return[]}).then(b=>{q.remove(this._queryOperationQueue,a);this.notifyChange("querying");return b})};d._queueEditOperation=function(a){this._editOperationQueue.push(a);this.notifyChange("syncing");
return a().then(b=>{q.remove(this._editOperationQueue,a);this.notifyChange("syncing");return b}).catch(b=>{w("store:edit-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueEditOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);q.remove(this._editOperationQueue,a);this.notifyChange("syncing");throw b;})};d._getWhere=function(){return this.where||this.layer?.definitionExpression||"1\x3d1"};d._getTimeExtent=function(){const a=this.layer;
return this.timeExtent||a&&"timeExtent"in a&&a.timeExtent||null};x._createClass(n,[{key:"attachmentsEnabled",set:function(a){this._reset();this._set("attachmentsEnabled",a);this.notifyChange("state")}},{key:"filterGeometry",set:function(a){this._reset();this._set("filterGeometry",a);this.notifyChange("state")}},{key:"layer",set:function(a){this._reset();this._set("layer",a);this.notifyChange("state")}},{key:"objectIds",set:function(a){this._reset();this._set("objectIds",a||null);this.notifyChange("state")}},
{key:"orderByFields",get:function(){return this._get("orderByFields")||[]},set:function(a){q.equals(a,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}},{key:"querying",get:function(){return 0<this._queryOperationQueue.length}},{key:"returnGeometry",set:function(a){this._reset();this._set("returnGeometry",a);this.notifyChange("state")}},{key:"state",get:function(){const {layer:a,_loaded:b,_loadError:c,_loading:e}=this;return c?"error":!a||this.get("layer.loadError")?
"disabled":e?"loading":"loaded"===this.get("layer.loadStatus")&&b?"loaded":"ready"}},{key:"syncing",get:function(){return 0<this._editOperationQueue.length}},{key:"timeExtent",set:function(a){this._reset();this._set("timeExtent",a);this.notifyChange("state")}},{key:"where",get:function(){return this._get("where")||null},set:function(a){this._reset();this._set("where",a);this.notifyChange("state")}}]);return n}(g);k.__decorate([l.property()],g.prototype,"attachmentsEnabled",null);k.__decorate([l.property({readOnly:!0})],
g.prototype,"count",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"failures",void 0);k.__decorate([l.property()],g.prototype,"filterGeometry",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"itemCache",void 0);k.__decorate([l.property({value:null})],g.prototype,"layer",null);k.__decorate([l.property({value:null})],g.prototype,"objectIds",null);k.__decorate([l.property()],g.prototype,"orderByFields",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"querying",null);
k.__decorate([l.property()],g.prototype,"relatedRecordsEnabled",void 0);k.__decorate([l.property({value:!1})],g.prototype,"returnGeometry",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"state",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"syncing",null);k.__decorate([l.property()],g.prototype,"timeExtent",null);k.__decorate([l.property()],g.prototype,"where",null);return g=k.__decorate([E.subclass("esri.widgets.FeatureTable.support.FeatureStore")],g)});
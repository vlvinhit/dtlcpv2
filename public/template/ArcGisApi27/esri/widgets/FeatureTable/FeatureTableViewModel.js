// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/fieldUtils ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Column ./Grid/Grid ./Grid/GridViewModel ./Grid/GroupColumn ./support/FeatureStore ../support/widgetUtils ../support/decorators/messageBundle ../../intl/locale ../../intl/messages".split(" "),
function(w,e,J,d,v,K,L,F,n,g,X,Y,Z,M,N,O,P,A,Q,R,S,T,G,aa,H,U,B){d=function(I){function x(a){var b=I.call(this,a)||this;b._debounceRefresh=F.debounce(()=>b._refresh());b._highlights=new L;b.activeFilters=new v;b.autoRefreshEnabled=!0;b.cellClassNameGenerator=(c,k)=>c.path||null;b.columns=new v;b.dataProvider=async(c,k)=>{const {store:l}=w._assertThisInitialized(b),{page:p,pageSize:t,sortOrders:r}=c;c=b._sortOrdersToLayerOrderByFields(r);k&&(l?(await l.set({orderByFields:c}),"loaded"!==l.state&&"loading"!==
l.state&&await l.load(),k&&k(await l.fetchItems({page:p,pageSize:t}))):k&&k([]))};b.editingEnabled=!1;b.fieldConfigs=null;b.grid=null;b.highlightEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.messagesURIUtils=null;b.relatedRecordsEnabled=!1;b.returnGeometryEnabled=!1;b.store=null;b.tableTemplate=null;b.view=null;b._onLayerRefresh=b._onLayerRefresh.bind(w._assertThisInitialized(b));b._set("store",new G);b._set("grid",new R({itemIdPath:b.itemIdPath,viewModel:w._assertThisInitialized(b)}));
return b}w._inherits(x,I);var f=x.prototype;f.initialize=function(){const a=async()=>{this.messages=await B.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");this.messagesCommon=await B.fetchMessageBundle("esri/t9n/common");this.messagesURIUtils=await B.fetchMessageBundle("esri/widgets/support/t9n/uriUtils")};a();this.handles.add([U.onLocaleChange(()=>{a();this._generateColumns()}),n.on(()=>this.highlightIds,"change",b=>this._onHighlightIdsChange(b),{onListenerAdd:()=>{this.highlightIds.forEach(b=>
this._highlight(b))},onListenerRemove:()=>{this.highlightIds.forEach(b=>this._unhighlight(b))}}),n.watch(()=>this.layerView,()=>{this._highlights.removeAll();this.layerView&&this.highlightEnabled&&this.highlightIds?.forEach(b=>this._highlight(b))}),n.watch(()=>this.highlightEnabled,()=>{this._highlights.removeAll();this.highlightEnabled&&this.highlightIds?.forEach(b=>this._highlight(b))}),n.watch(()=>this.relatedRecordsEnabled,b=>this.store.relatedRecordsEnabled=b),n.watch(()=>this.returnGeometryEnabled,
b=>this.store.returnGeometry=b),n.watch(()=>this.layer?.loaded,b=>b&&this._onLayerLoad()),n.watch(()=>this.store.state,b=>{"loaded"===b&&this.grid?.scrollToTop()}),n.watch(()=>[this.messages,this.tableTemplate,this.fieldConfigs],()=>this.layer?.loaded&&this._generateColumns()),n.watch(()=>this.editingEnabled,b=>{this.columns.forEach(c=>{"editingEnabled"in c&&(c.editingEnabled=b)});this.grid?.onColumnChange()}),n.watch(()=>this.layer?.definitionExpression,(b,c)=>(b||c)&&"loaded"===this.store.state&&
this.reset()),n.watch(()=>this.layer&&"timeExtent"in this.layer&&this.layer.timeExtent,(b,c)=>(b||c)&&!this.timeExtent&&"loaded"===this.store.state&&this.reset()),n.on(()=>this.layer,"refresh",b=>this._onLayerRefresh(b))])};f.destroy=function(){this._resetColumns();this.handles.removeAll();this._highlights.removeAll();this._highlights.destroy();this.grid?.destroy();this.columns?.destroy();this.view=this.layer=null};f.clearHighlights=function(){this._highlights.removeAll()};f.clearSelection=function(){this.grid?.clearSelection()};
f.deleteSelection=async function(){var a=this.highlightIds.toArray();a?.length&&({deleteFeatureResults:a}=await this.store.deleteRowsByObjectId(a),a=a.filter(b=>!b.error).map(b=>b.objectId),a.length&&(this.deselectRows(a),await this.refresh()))};f.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid?.deselectRows(a)};f.filterBySelection=function(){const a=this.highlightIds.toArray();a.length&&(this.clearSelectionFilter(),this.store.objectIds=a,this.activeFilters.add({type:"selection",
objectIds:a}))};f.getObjectIdIndex=function(a){return this.store?.getObjectIdIndex(a)};f.getValue=function(a,b){return this.store.getItemByObjectId(a)?.feature?.attributes[b]};f.refresh=async function(){return F.ignoreAbortErrors(this._debounceRefresh())};f.reset=function(){this.grid?.reset()};f.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);return this.grid?.selectRows(a)};f.scrollToIndex=function(a){this.grid?.scrollToIndex(a)};f.clearSelectionFilter=function(){this.store.objectIds=
null;const a=this.activeFilters.find(b=>"selection"===b.type);a&&this.activeFilters.remove(a)};f.zoomToSelection=function(){const {layer:a,view:b}=this,c=this.highlightIds.toArray();if(a&&b&&c.length){var k=a.createQuery();k.objectIds=c;k.returnGeometry=!0;a.queryFeatures(k).then(l=>{b.goTo(l.features).catch(p=>{"AbortError"!==p.name&&console.error(p)})})}};f._refresh=async function(){await this.store.refreshLayerInfo();const a=this.highlightIds.toArray();a.length&&(await this.store.verifyFeaturesByObjectId(a)).forEach((b,
c)=>{b||this.deselectRows(a[c])});this.grid?.refreshPageCache()};f._onLayerLoad=function(){const a=this.layer.capabilities?.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};f._onLayerRefresh=function(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()};f._generateColumns=function(){this._resetColumns();const a=[],b=this.tableTemplate?.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):this.fieldConfigs?.length?
this._generateColumnsFromConfigs():this._generateDefaultFieldColumns();a.push(...b);a.length&&this.attachmentsEnabled&&a.push(this._generateDefaultAttachmentColumn());this.columns.addMany([...a])};f._generateColumnsFromTemplates=function(a){const {editingEnabled:b,grid:c,layer:k,messages:l,messagesCommon:p,messagesURIUtils:t,store:r,tableTemplate:C}=this,y=this.layer?.fields??[],m=h=>{const q="fieldName"in h&&h.fieldName?.toLowerCase();return y.find(u=>q===u.name?.toLowerCase())};return a.filter(h=>
null!=m(h)||"group"===h.type&&"columnTemplates"in h).map(h=>{if("fieldName"in h){var q=m(h),u=!1===h.visible||!0!==h.visible&&this._isFieldHidden(q?.name);const {direction:D,formatFunction:z,initialSortPriority:E,menuConfig:V,textAlign:W}=h;return new A({direction:D,editingEnabled:b,expressionInfos:C?.expressionInfos||null,field:q,formatFunction:z,grid:c,hidden:u,initialSortPriority:E,layer:k,messages:l,messagesCommon:p,messagesURIUtils:t,menuConfig:V,store:r,template:h,textAlign:W})}return"group"===
h.type&&"columnTemplates"in h?(q=this._generateColumnsFromTemplates(h.columnTemplates),u=!1===h.visible||!0!==h.visible&&this._isFieldHidden(h.label),{label:h}=h,new T({header:h,columns:q,hidden:u})):new Q({...h})})};f._generateColumnsFromConfigs=function(){const {editingEnabled:a,fieldConfigs:b,grid:c,layer:k,messages:l,messagesCommon:p,messagesURIUtils:t,store:r}=this;if(!b)return[];const C=this.layer?.fields??[],y=m=>{const h=m.name?.toLocaleLowerCase();return C.find(q=>h===q.name?.toLowerCase())};
return b.filter(y).map(m=>{const h=m.direction||null,q=m.formatFunction||null,u=m.textAlign||null,D=null!=m.initialSortPriority?m.initialSortPriority:null,z=y(m),E=!1===m.visible||!0!==m.visible&&this._isFieldHidden(z?.name);return new A({config:m,direction:h,editingEnabled:a,field:z,formatFunction:q,grid:c,hidden:E,layer:k,store:r,messages:l,messagesCommon:p,messagesURIUtils:t,menuConfig:m.menuConfig||null,textAlign:u,initialSortPriority:D})})};f._generateDefaultFieldColumns=function(){const {editingEnabled:a,
grid:b,layer:c,messages:k,messagesCommon:l,messagesURIUtils:p,store:t}=this;return(this.layer?.fields??[]).map(r=>new A({editingEnabled:a,field:r,grid:b,hidden:this._isFieldHidden(r.name),layer:c,store:t,messages:k,messagesCommon:l,messagesURIUtils:p}))};f._generateDefaultAttachmentColumn=function(){return new P({header:this.messages?.attachments})};f._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,k)=>k.map(l=>l.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,
path:c})=>c+" "+b?.toUpperCase()):[]};f._isFieldHidden=function(a){const b=a?.toLowerCase();return(this.hiddenFields??this._defaultHiddenFields).some(c=>c.toLowerCase()===b)};f._highlight=function(a){this.layerView&&O.highlightsSupported(this.layerView)&&this._highlights.add(this.layerView.highlight(a),a)};f._unhighlight=function(a){this._highlights.remove(a)};f._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{let k=c instanceof J?c:null;c=k?k.getObjectId():
c;if("number"===typeof c||"string"===typeof c){if(!k){const l=this.store.getItemByObjectId(c);l&&(k=l.feature)}b.push({objectId:c,feature:k})}});return b};f._onHighlightIdsChange=function(a){const {highlightEnabled:b}=this,{added:c,removed:k}=a;b&&(c.forEach(l=>this._highlight(l)),k.forEach(l=>this._unhighlight(l)))};f._resetColumns=function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};w._createClass(x,[{key:"_defaultHiddenFields",get:function(){return N.getLowerCaseDefaultHiddenFields(this.layer)}},
{key:"activeSortOrders",get:function(){return this.grid?.sortOrders?this.grid.sortOrders.map(({path:a,direction:b})=>({fieldName:a,direction:b})):[]}},{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",a),this._generateColumns(),this.store.attachmentsEnabled=a)}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);this._set("filterGeometry",a);(this.store.filterGeometry=
a)&&this.activeFilters.add({type:"geometry",geometry:a})}}},{key:"hiddenFields",get:function(){return this._get("hiddenFields")??new v},set:function(a){Array.isArray(a)?this._set("hiddenFields",new v(a)):this._set("hiddenFields",a)}},{key:"highlightOnRowSelectEnabled",get:function(){return this.highlightEnabled},set:function(a){this.highlightEnabled=a}},{key:"layer",set:function(a){this._set("layer",a);this.grid?.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():
a.load());this.notifyChange("state")}},{key:"layerView",get:function(){return this.view?.allLayerViews.find(a=>a.layer===this.layer)||null}},{key:"messages",set:function(a){this.grid?.set("messages",a);this._set("messages",a)}},{key:"state",get:function(){const {store:a}=this;return a&&"disabled"!==a.state?"loading"===a.state?"loading":"loaded"===a.state?"loaded":"ready":"disabled"}},{key:"timeExtent",set:function(a){this._set("timeExtent",a);this.store.timeExtent=a}},{key:"highlightIds",get:function(){return this._get("highlightIds")||
new v},set:function(a){Array.isArray(a)?this._set("highlightIds",new v(a)):this._set("highlightIds",a)}}]);return x}(K.HandleOwnerMixin(S));e.__decorate([g.property()],d.prototype,"_defaultHiddenFields",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"activeFilters",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"activeSortOrders",null);e.__decorate([g.property()],d.prototype,"attachmentsEnabled",null);e.__decorate([g.property()],d.prototype,"autoRefreshEnabled",void 0);e.__decorate([g.property()],
d.prototype,"cellClassNameGenerator",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"columns",void 0);e.__decorate([g.property()],d.prototype,"dataProvider",void 0);e.__decorate([g.property()],d.prototype,"editingEnabled",void 0);e.__decorate([g.property()],d.prototype,"fieldConfigs",void 0);e.__decorate([g.property()],d.prototype,"filterGeometry",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"grid",void 0);e.__decorate([g.property()],d.prototype,"hiddenFields",null);e.__decorate([g.property()],
d.prototype,"highlightEnabled",void 0);e.__decorate([g.property()],d.prototype,"highlightOnRowSelectEnabled",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"itemIdPath",void 0);e.__decorate([g.property()],d.prototype,"layer",null);e.__decorate([g.property()],d.prototype,"layerView",null);e.__decorate([g.property()],d.prototype,"messages",null);e.__decorate([g.property(),H.messageBundle("esri/t9n/common")],d.prototype,"messagesCommon",void 0);e.__decorate([g.property(),H.messageBundle("esri/widgets/support/t9n/uriUtils")],
d.prototype,"messagesURIUtils",void 0);e.__decorate([g.property()],d.prototype,"relatedRecordsEnabled",void 0);e.__decorate([g.property()],d.prototype,"returnGeometryEnabled",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"state",null);e.__decorate([g.property({readOnly:!0,type:G})],d.prototype,"store",void 0);e.__decorate([g.property()],d.prototype,"tableTemplate",void 0);e.__decorate([g.property()],d.prototype,"timeExtent",null);e.__decorate([g.property()],d.prototype,"view",void 0);
e.__decorate([g.property()],d.prototype,"highlightIds",null);return d=e.__decorate([M.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],d)});
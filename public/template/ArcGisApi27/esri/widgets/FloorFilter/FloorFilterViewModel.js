// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/promiseUtils ../../core/reactiveUtils ../../core/time ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/FloorFilter ../support/GoTo".split(" "),function(E,k,M,F,N,h,O,y,P,l,U,
V,W,Q,R,S,T){function z(A){return"esri.WebMap"===A.declaredClass}h=function(A){function B(a){a=A.call(this,a)||this;a.filterMenuOpen=!1;a.filterMenuType="site";a.filterMode="base-floors";a.levelsExpanded=!0;a.searchTerm=null;a.view=null;a._updateFloorFilterTask=null;a._viewHeightBreakpoint=null;a._viewWidthBreakpoint=null;return a}E._inherits(B,A);var g=B.prototype;g.initialize=function(){this.addHandles([y.watch(()=>this.view?.map,a=>{null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),
this._updateFloorFilterTask=null);this._updateFloorFilterTask=M.createTask(async c=>{await this._updateFloorFilterFromMap(a);O.throwIfAborted(c);this._setInitialViewState(a)})},y.initial),y.watch(()=>this.view,(a,c)=>{this._unregisterWidget(c);this._registerWidget(a);this._watchSearchResults(a)},y.syncAndInitial),y.watch(()=>this.view?.widthBreakpoint??null,a=>{this._viewWidthBreakpoint=a}),y.watch(()=>this.view?.heightBreakpoint??null,a=>{this._viewHeightBreakpoint=a})])};g.destroy=function(){this._unregisterWidget(this.view);
this.view=null;null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)};g.filterFacilities=function(a){let c=a;this.searchTerm&&(c=a.filter(b=>{({name:b}=b);return b.toLowerCase().includes(this.searchTerm?.toLowerCase())}));this.site&&(c=c.filter(b=>b.siteId===this.site));return c.sort((b,d)=>{b=b.name;d=d.name;return b>d?1:b===d?0:-1})};g.filterSites=function(a){let c=a;this.searchTerm&&(c=a.filter(b=>{({name:b}=b);return b.toLowerCase().includes(this.searchTerm?.toLowerCase())}));
return c.sort((b,d)=>{b=b.name;d=d.name;return b>d?1:b===d?0:-1})};g.getBaseLevel=function(a){const c=this.filterFeatures?.levels?.levelsInfo;let b=null;if(a){const {id:d}=a;if(c&&0<c.length&&(c.forEach(e=>{0===e.verticalOrder&&e.facilityId===d&&(b=e)}),!b)){let e=null;c.forEach(f=>{f.facilityId===d&&(e?0<=(f.verticalOrder??0)?null!=e.verticalOrder&&(0>e.verticalOrder||(f.verticalOrder??0)<e.verticalOrder)&&(e=f):null!=e.verticalOrder&&null!=f.verticalOrder&&0>e.verticalOrder&&f.verticalOrder>e.verticalOrder&&
(e=f):e=f)});e&&(b=e)}}return b};g.getFacility=function(a){return this.filterFeatures?.facilities?.facilitiesInfo?.find(c=>c.id===a)??null};g.getFacilityLevels=function(a){return a&&this.filterFeatures?.levels?.levelsInfo?this.filterFeatures.levels.levelsInfo.filter(c=>c.facilityId===a).sort((c,b)=>{c=c.verticalOrder??0;b=b.verticalOrder??0;return c>b?-1:c===b?0:1}):[]};g.getLevel=function(a){return this.filterFeatures?.levels?.levelsInfo?.find(c=>c.id===a)??null};g.getSite=function(a){return this.filterFeatures?.sites?.sitesInfo?.find(c=>
c.id===a)??null};g.goTo=function(a){const {view:c}=this;c&&a&&({geometry:a}=a,a&&a.extent&&this.callGoTo({target:a.extent,options:{duration:P.Milliseconds(1E3),easing:"in-out-quad"}}))};g.setFloors=function(a){const {view:c}=this;c&&(c?.map?.allLayers?.forEach(b=>{"feature"===b.type&&this._computeViewAllModeFloors(b)}),c.floors=new F(this._computeFloors(a)))};g.updateWebDocument=function(a){if(z(a)){const c=new S({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,
site:this.site??null,facility:this.facility??null,level:this.level??null});a.widgets?a.widgets.floorFilter=c:a.widgets=new R({floorFilter:c})}};g._computeFloors=function(a){if("single-floor"===this.filterMode)this._computeSingleFloor(a);else if("base-floors"===this.filterMode)return"3d"===this.view?.type?this._computeBaseFloors3D(a):this._computeBaseFloors(a);return this._computeEmptyFloors()};g._computeSingleFloor=function(a){if(!a)return this._computeEmptyFloors();const c=[];"all"===a?.id?this.getFacilityLevels(a.facilityId).forEach(b=>
{b.id&&c.push(b.id)}):a&&c.push(a.id);return c};g._computeBaseFloors=function(a){const c=this.filterFeatures?.levels?.levelsInfo;if(!c||!c.length)return this._computeEmptyFloors();const b=[];"all"===a?.id?this.getFacilityLevels(a.facilityId).forEach(e=>{e.id&&b.push(e.id)}):a&&b.push(a.id);const d=a?.facilityId;c.forEach(e=>{const {id:f,facilityId:m,verticalOrder:q}=e;d||0!==q||b.includes(f)?m===d||0!==q||b.includes(f)||b.push(f):b.push(f)});return b};g._computeBaseFloors3D=function(a){const c=this.filterFeatures?.levels?.levelsInfo;
if(!c||!c.length)return this._computeEmptyFloors();const b=[],d=a?.id.split("--")??[];1<d?.length&&"all"===d[0]?this.getFacilityLevels(a?.facilityId).forEach(f=>{f.id&&b.push(f.id)}):a&&b.push(a.id);const e=a?.facilityId;c.forEach(f=>{const {id:m,facilityId:q}=f;e||b.includes(m)?q===e||b.includes(m)||b.push(m):b.push(m)});return b};g._computeEmptyFloors=function(){return[]};g._setFilterLayers=async function(){var {view:a}=this;if(a&&!this._isOverridden("filterLayers"))if(z(a.map)||"esri.WebScene"===
a.map.declaredClass){const b=a.map;var c=b?.allLayers;if(0<c?.items?.length){const d={siteLayer:null,facilityLayer:null,levelLayer:null},e=b.floorInfo?.siteLayer?.layerId,f=b.floorInfo?.facilityLayer?.layerId,m=b.floorInfo?.levelLayer?.layerId,q=b.floorInfo?.siteLayer?.sublayerId||b.floorInfo?.facilityLayer?.sublayerId||b.floorInfo?.levelLayer?.sublayerId;if(f&&m){a=c.items.filter(n=>"feature"===n.type||"scene"===n.type);c=c.items.filter(n=>"map-image"===n.type);if(0<c?.length&&q){await Promise.all(c.map(p=>
p.load()));const n=b.floorInfo?.siteLayer?.sublayerId,t=b.floorInfo?.facilityLayer?.sublayerId,v=b.floorInfo?.levelLayer?.sublayerId;c.forEach(p=>{const r=p.id;p=p?.allSublayers;(r===e||r===f||r===m)&&0<p?.items?.length&&p.items.forEach(u=>{const w=u.id;r===e&&w===n?d.siteLayer=u:w===t?d.facilityLayer=u:w===v&&(d.levelLayer=u)})})}0<a?.length&&a.forEach(n=>{const t=n.id;t===e?d.siteLayer=n:t===f?d.facilityLayer=n:t===m&&(d.levelLayer=n)});this.filterLayers=d}}}else throw new N("Map must be a webmap or webscene");
};g._getFilterFeatures=async function(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;const [a,c,b]=await Promise.all([this._getSites(),this._getFacilities(),this._getLevels()]);return{sites:a,facilities:c,levels:b}};g._getSites=async function(){const a={sitesInfo:[]},{filterLayers:c,view:b}=this;var d=b?.map;const {siteLayer:e}=c;if(!e||!d?.floorInfo?.siteLayer)return a;const f=e.createQuery();f.returnGeometry=!0;f.outFields=["*"];f.returnZ=!0;"type"in e&&"scene"===e.type&&(f.multipatchOption=
"xyFootprint");const {siteIdField:m,nameField:q}=d.floorInfo.siteLayer;d=await e.queryFeatures(f);if(0<d?.features?.length){d=d.features;const n=e?.fieldsIndex.get(m)?.name||m,t=e?.fieldsIndex.get(q)?.name||q;null!=n&&null!=t&&d.forEach(v=>{var p=v.attributes;v=v.geometry;const r=p[n];p=p[t];r&&p&&a.sitesInfo.push({id:r,name:p,geometry:v})})}return a};g._getFacilities=async function(){const {filterLayers:a,view:c}=this;var b=c?.map;const {facilityLayer:d}=a,e={facilitiesInfo:[]};if(!d||!b?.floorInfo?.facilityLayer)return e;
const f=d.createQuery();f.returnGeometry=!0;f.outFields=["*"];f.returnZ=!0;"type"in d&&"scene"===d.type&&(f.multipatchOption="xyFootprint");const {facilityIdField:m,siteIdField:q,nameField:n}=b.floorInfo.facilityLayer;b=await d.queryFeatures(f);if(0<b?.features?.length){b=b.features;const t=d?.fieldsIndex.get(m)?.name||m,v=d?.fieldsIndex.get(q)?.name||q,p=d?.fieldsIndex.get(n)?.name||n;t&&v&&p&&b.forEach(r=>{var u=r.attributes;r=r.geometry;const w=u[t],C=u[v];u=u[p];w&&u&&e.facilitiesInfo.push({id:w,
siteId:C,name:u,geometry:r})})}return e};g._getLevels=async function(){const {filterLayers:a,view:c}=this;var b=c?.map;const {levelLayer:d}=a,e={levelsInfo:[]};if(!d||!b?.floorInfo?.levelLayer)return e;const f=d.createQuery();f.returnGeometry=!0;f.outFields=["*"];f.returnZ=!0;const {levelIdField:m,facilityIdField:q,longNameField:n,shortNameField:t,levelNumberField:v,verticalOrderField:p}=b.floorInfo.levelLayer;b=await d.queryFeatures(f);if(0<b?.features?.length){b=b.features;const r=d?.fieldsIndex.get(m)?.name||
m,u=d?.fieldsIndex.get(q)?.name||q,w=d?.fieldsIndex.get(n)?.name||n,C=d?.fieldsIndex.get(t)?.name||t,G=d?.fieldsIndex.get(v)?.name||v,H=d?.fieldsIndex.get(p)?.name||p;r&&u&&w&&C&&G&&H&&b.forEach(D=>{var x=D.attributes;D=x[r];const I=x[u],J=x[w],K=x[C],L=x[G];x=x[H];D&&I&&J&&K&&"number"===typeof L&&"number"===typeof x&&e.levelsInfo.push({id:D,facilityId:I,longName:J,shortName:K,levelNumber:L,verticalOrder:x})})}return e};g._registerWidget=function(a){a?.persistableViewModels.includes(this)||a?.persistableViewModels.add(this)};
g._unregisterWidget=function(a){a?.persistableViewModels.remove(this)};g._watchSearchResults=function(a){a?.on("select-result-floor",c=>{const b=this.getLevel(c);b&&this.level!==c&&(this.level=c,this.setFloors(b))})};g._setInitialViewState=async function(a){if(this.view)try{await this.view.when();await this._setFilterLayers();const c=await this._getFilterFeatures();if(c)if(this.filterFeatures=c,this.hasFacilities&&this.hasLevels)if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&
this.level){this.filterMenuType="facility";const b=this.getFacility(this.facility),d=this.getLevel(this.level);this.site||(this.site=b?.siteId||void 0);this.setFloors(d)}else if(this.facility&&!this.level){this.filterMenuType="facility";const b=this.getFacility(this.facility),d=this.getBaseLevel(b);this.site||(this.site=b?.siteId||void 0);this.level=d?.id||void 0;this.setFloors(d)}else if(!this.facility&&this.level){this.filterMenuType="facility";const b=this.getLevel(this.level),d=this.getFacility(b?.facilityId);
this.facility=d?.id||void 0;this.site||(this.site=d?.siteId||void 0);this.setFloors(b)}else{if(!this.site||this.facility||this.level){if(!a||!z(a)){this.setFloors(null);return}a=a?.widgets?.floorFilter;if(!a){this.setFloors(null);return}a.site&&!this.site&&(this.site=a.site,this.filterMenuType="facility")}else this.filterMenuType="site";this.setFloors(null)}else console.error("Facilities and Levels are required for the Floor Filter widget")}catch(c){console.error("Couldn't retrieve sites, facilities, and levels",
c)}};g._callOverride=function(a,c){this._override(a,c)};g._updateFloorFilterFromMap=async function(a){a&&z(a)&&(a=a?.widgets?.floorFilter)&&(this._isOverridden("enabled")||(this.enabled=a.enabled),this._isOverridden("longNames")||(this.longNames=a.longNames),this._isOverridden("minimized")||(this.minimized=a.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=a.pinnedLevels),this._isOverridden("site")||(this.site=a.site),this._isOverridden("facility")||(this.facility=a.facility),this._isOverridden("level")||
(this.level=a.level))};g._computeViewAllModeFloors=function(a){const {filterFeatures:c}=this;if(a.floorInfo?.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const {level:b,facility:d}=this,e=[];c.levels.levelsInfo.forEach(f=>{const {id:m,facilityId:q}=f;d&&q===d?b&&m===b&&e.push(m):e.push(m)});a.floorInfo.viewAllLevelIds=new F(e)}};E._createClass(B,[{key:"enabled",set:function(a){this._callOverride("enabled",a)}},{key:"facility",set:function(a){if(a&&this._isOverridden("facility")){const c=
this.getFacility(a);this.hasMultipleSites&&(this.site=c?.siteId||null)}this._callOverride("facility",a)}},{key:"filterFeatures",set:function(a){this._callOverride("filterFeatures",a)}},{key:"filterLayers",set:function(a){this._callOverride("filterLayers",a)}},{key:"hasFacilities",get:function(){return null!=this.filterLayers?.facilityLayer&&0<this.filterFeatures?.facilities?.facilitiesInfo?.length}},{key:"hasLevels",get:function(){return null!=this.filterLayers?.levelLayer&&0<this.filterFeatures?.levels?.levelsInfo?.length}},
{key:"hasMultipleSites",get:function(){return null!=this.filterLayers?.siteLayer&&1<this.filterFeatures?.sites?.sitesInfo?.length}},{key:"isNormalMode",get:function(){let a=!0;const c=this._viewWidthBreakpoint;if("xsmall"===this._viewHeightBreakpoint||"xsmall"===c)a=!1;return a}},{key:"level",set:function(a){if(a){var c=null,b=null;c=a?.split("--");1<c?.length&&"all"===c[0]?(b=c[1],c={id:a,facilityId:b,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(c=this.getLevel(a),b=c?.facilityId??
null);this.level!==a||this.isNormalMode||this.levelsExpanded?(c&&this.hasFacilities&&this.hasLevels?(this.facility=b,this.hasMultipleSites&&(this.site=this.getFacility(b)?.siteId||null),this.setFloors(c)):this._isOverridden("level")&&(this.site=this.facility=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",a)):1<this.getFacilityLevels(b)?.length&&(this.levelsExpanded=!0)}else this._callOverride("level",a),this.site=this.facility=null,this.setFloors(null)}},
{key:"longNames",set:function(a){this._callOverride("longNames",a)}},{key:"minimized",set:function(a){this._callOverride("minimized",a)}},{key:"pinnedLevels",set:function(a){this._callOverride("pinnedLevels",a)}},{key:"site",set:function(a){this._callOverride("site",a)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}}]);return B}(T.GoToMixin(h.HandleOwner));k.__decorate([l.property({value:!1})],
h.prototype,"enabled",null);k.__decorate([l.property({value:void 0})],h.prototype,"facility",null);k.__decorate([l.property({value:null})],h.prototype,"filterFeatures",null);k.__decorate([l.property({value:null})],h.prototype,"filterLayers",null);k.__decorate([l.property()],h.prototype,"filterMenuOpen",void 0);k.__decorate([l.property()],h.prototype,"filterMenuType",void 0);k.__decorate([l.property()],h.prototype,"filterMode",void 0);k.__decorate([l.property()],h.prototype,"hasFacilities",null);k.__decorate([l.property()],
h.prototype,"hasLevels",null);k.__decorate([l.property()],h.prototype,"hasMultipleSites",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"isNormalMode",null);k.__decorate([l.property({value:void 0})],h.prototype,"level",null);k.__decorate([l.property({value:!1})],h.prototype,"longNames",null);k.__decorate([l.property()],h.prototype,"levelsExpanded",void 0);k.__decorate([l.property({value:!1})],h.prototype,"minimized",null);k.__decorate([l.property({value:!1})],h.prototype,"pinnedLevels",
null);k.__decorate([l.property()],h.prototype,"searchTerm",void 0);k.__decorate([l.property({value:void 0})],h.prototype,"site",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"state",null);k.__decorate([l.property()],h.prototype,"view",void 0);k.__decorate([l.property()],h.prototype,"_viewHeightBreakpoint",void 0);k.__decorate([l.property()],h.prototype,"_viewWidthBreakpoint",void 0);k.__decorate([l.property()],h.prototype,"updateWebDocument",null);return h=k.__decorate([Q.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],
h)});
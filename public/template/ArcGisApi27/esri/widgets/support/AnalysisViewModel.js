// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass".split(" "),function(c,q,d,v,t,w,k,r,m,f,y,z,A,x){function u(e){return null!=e&&e.state>=n.RUNNING?(e.abort(),null):e}var n;(function(e){e[e.PENDING=
0]="PENDING";e[e.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY";e[e.RUNNING=2]="RUNNING"})(n||(n={}));c.AnalysisViewModel=function(e){function p(a={}){var b=e.call(this,a)||this;b.view=null;b.analysisView=null;b._reconnectViewTask=null;b._forceInteractiveHandle=null;b._parentChangeFromReconnect=!1;b._startUserOperation=null;b.logger=w.getLogger(q._assertThisInitialized(b));const g=a?.analysis;null!=g?b.analysis=g:(b._set("analysis",b.constructAnalysis()),b._set("isAnalysisOwner",!0));a&&null!=a.visible&&
(b.visible=a.visible);return b}q._inherits(p,e);var h=p.prototype;h.normalizeCtorArgs=function(a){const {analysis:b,...g}=a;return g};h.initialize=function(){this.addHandles([m.watch(()=>({readyAndNotSupported:null!=this.view&&this.view.ready&&!this.supported}),({readyAndNotSupported:a})=>{a&&this.logger.errorOnce(this.unsupportedErrorMessage)},m.syncAndInitial),m.watch(()=>k.applySome(this.analysis,({parent:a})=>a),a=>{this._parentChangeFromReconnect||a===this.view||this._set("isAnalysisOwner",!1);
a=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1;a&&this._scheduleViewReconnect()},m.sync),m.watch(()=>({view:this.view,ready:null!=this.view&&this.view.ready,supported:this.supported}),({view:a},b)=>{b=b?.view;a!==b&&(this._startUserOperation=k.abortMaybe(this._startUserOperation),this._disconnectFromView(b));this._scheduleViewReconnect()},m.syncAndInitial)])};h.destroy=function(){this._reconnectViewTask=k.abortMaybe(this._reconnectViewTask);this._startUserOperation=k.abortMaybe(this._startUserOperation);
null!=this.analysisView&&(this.analysisView.visible=void 0);this._disconnectFromView(this.view);this._set("view",null);null!=this.analysis&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))};h.clear=function(){this._startUserOperation=k.abortMaybe(this._startUserOperation);this._resetInteractiveCreationState();null!=this.tool&&null!=this.view&&this.view.activeTool===this.tool&&(this.view.activeTool=null)};h.start=async function(){this.clear();const a={task:null,abort:null,
state:n.PENDING},b=t.createTask(async g=>{a.state=n.WAIT_FOR_VIEW_READY;await m.whenOnce(()=>this.ready,g);a.state=n.RUNNING;if(null!=this.analysisView&&null!=this.view){var l=this.analysisView.tool;null!=l&&(this.view.activeTool=l,m.when(()=>l.created,()=>{l.active&&null!=this.view&&(this.view.activeTool=null)},{initial:!0,once:!0}))}});a.task=b;a.abort=()=>b.abort();this._startUserOperation=a;return b.promise};h.onConnectToAnalysisView=function(a){};h.onDisconnectFromAnalysisView=function(){};h._scheduleViewReconnect=
function(){this._reconnectViewTask=k.abortMaybe(this._reconnectViewTask);const a=t.createTask(async b=>{try{await this._reconnectView(b)}catch(g){r.throwIfAborted(b);if(r.isAbortError(g))throw g;this.logger.warn("Failed to use analysis in view model",g)}finally{a===this._reconnectViewTask&&(this._reconnectViewTask=null)}});this._reconnectViewTask=a};h._reconnectView=async function(a){const {view:b}=this,g=null!=b&&b.ready&&this.supported,l=this.analysis;this._startUserOperation=u(this._startUserOperation);
this._disconnectFromView(b);if(g&&null!=b&&null!=l){if(this.isAnalysisOwner){if(null!=l.parent){this.logger.errorOnce("expected owned analysis to have null parent when connecting to view");return}this._parentChangeFromReconnect=!0;b.analyses.add(l)}this.analysisView=await b.whenAnalysisView(l);r.isAborted(a)?this._startUserOperation=u(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractiveForViewModel(),this.addHandles(this._forceInteractiveHandle),
this.onConnectToAnalysisView(this.analysisView))}};h._disconnectFromView=function(a){null!=a&&this.isAnalysisOwner&&a.analyses.includes(this.analysis)&&(this._parentChangeFromReconnect=!0,this.analysis.clear(),a.analyses.remove(this.analysis));this.onDisconnectFromAnalysisView();this._forceInteractiveHandle=k.removeMaybe(this._forceInteractiveHandle);this.analysisView=null};h._setExternalAnalysis=function(a){null==this.analysisView||this.isAnalysisOwner||(this.analysisView.visible=void 0,this._forceInteractiveHandle=
k.removeMaybe(this._forceInteractiveHandle));this.analysisView=null;this._set("isAnalysisOwner",!1);this._set("analysis",a);this._parentChangeFromReconnect=!1};h._resetInteractiveCreationState=function(){this.analysis.clear();null!=this.tool&&this.tool.resetCreated()};q._createClass(p,[{key:"supported",get:function(){return null==this.view||this.view.type===this.supportedViewType}},{key:"visible",set:function(a){this._set("visible",a);null!=this.analysisView&&(this.analysisView.visible=a)}},{key:"active",
get:function(){return null!=this.tool&&this.tool.active}},{key:"disabled",get:function(){return null==this.view||!this.view.ready||!this.supported}},{key:"analysis",set:function(a){a!==this._get("analysis")&&(this._startUserOperation=k.abortMaybe(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(a),this._scheduleViewReconnect())}},{key:"ready",get:function(){return null!=this.analysisView&&!this.connectingToView}},{key:"connectingToView",get:function(){return null!=
this._reconnectViewTask}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}},{key:"tool",get:function(){return null!=this.analysisView?this.analysisView.tool:null}},{key:"testInfo",get:function(){return{analysisView:this.analysisView}}}]);return p}(v);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"supported",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"view",void 0);d.__decorate([f.property({type:Boolean,value:!0})],c.AnalysisViewModel.prototype,
"visible",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"active",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"disabled",null);d.__decorate([f.property({nonNullable:!0})],c.AnalysisViewModel.prototype,"analysis",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"analysisView",void 0);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"ready",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"connectingToView",null);d.__decorate([f.property({readOnly:!0})],
c.AnalysisViewModel.prototype,"isAnalysisOwner",null);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"_reconnectViewTask",void 0);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"_forceInteractiveHandle",void 0);d.__decorate([f.property()],c.AnalysisViewModel.prototype,"tool",null);c.AnalysisViewModel=d.__decorate([x.subclass("esri.widgets.support.AnalysisViewModel")],c.AnalysisViewModel);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
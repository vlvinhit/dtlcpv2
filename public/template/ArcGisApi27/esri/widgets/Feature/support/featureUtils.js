// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../popup/support/FieldInfoFormat ../../../support/arcadeOnDemand".split(" "),function(h,O,m,l,v,n,w,P,Q){function x(a){return a?y.test(a):!1}function R(a,b){if(!x(b)||!a)return null;const c=b.replace(y,"").toLowerCase();let d=null;a.some(e=>e.name.toLowerCase()===c?(d=e,!0):!1);return d}function p(a,b){return(b=q(b,a))?b.name:
a}function q(a,b){return a&&"function"===typeof a.getField&&b?a.getField(b)??null:null}function z({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${m.replace(m.replace(b,d=>{const e=c.get(d.toLowerCase());return`{${e&&e.fieldName||d}}`}),a).replaceAll(S,"")}`.trim()}function T(a,b,c=!1){const d=b[a];"string"===typeof d&&(c=(c?encodeURIComponent(d):d).replaceAll(U,"%27"),b[a]=c)}function V(a,b=!1){const c={...a};Object.keys(c).forEach(d=>T(d,c,b));return c}function A(a,b){return a.replaceAll(W,
(c,d,e)=>(c=q(b,e))?`{${c.name}}`:d)}function X(a,b,c){return(a=A(a,c))?a.replaceAll(Y,(d,e,g)=>{e=`${e||g}`.trim();return m.replace(d,V(b,e&&"{"!==e[0]||!1))}):a}function B(a){return null!=a&&"object"===typeof a&&"layer"in a&&!!a.layer}function C(a){return null!=a&&"object"===typeof a&&"fieldsIndex"in a&&"geometryType"in a&&"getField"in a&&"load"in a&&"loaded"in a&&"objectIdField"in a&&"spatialReference"in a&&"type"in a&&"feature"===a.type&&"when"in a}function D(a){return null!=a&&"object"===typeof a&&
"createQuery"in a&&"queryFeatureCount"in a&&"queryObjectIds"in a&&"queryRelatedFeatures"in a&&"queryRelatedFeaturesCount"in a&&"relationships"in a}function r(a){return C(a)&&D(a)}function E(a,b){const {fieldInfos:c,fieldName:d,preventPlacesFormatting:e,layer:g}=b;var f=F(c,d)?.clone();b=q(g,d);if(f&&!n.isRasterPixelValueField(d)){const k=b?.type;if("date"===k||"date-only"===k||"time-only"===k||"timestamp-offset"===k||f.format?.dateFormat){b=f.format??new P;b.dateFormat??(b.dateFormat="date-only"===
k?"short-date":"short-date-short-time");if("number"===typeof a){if(!(f=!B(g)&&w.isFeatureLayer(g)&&g.datesInUnknownTimezone)){if(f=B(g))f=g.layer,f=null!=f&&"object"===typeof f&&"type"in f&&"map-image"===f.type;f=f&&g.layer.datesInUnknownTimezone}return b.formatDate(a,f)}switch(k){case "date-only":return b.formatDateOnly(a);case "time-only":return b.formatTimeOnly(a);case "timestamp-offset":return b.formatTimestamp(a)}}}b=f?.format;if("string"===typeof a&&n.isRasterPixelValueField(d)&&b)return b.formatRasterPixelValue(a);
"string"!==typeof a||!b||null!=b.dateFormat||null==b.places&&null==b.digitSeparator||(f=Number(a),isNaN(f)||(a=f));return"string"===typeof a||null==a||null==b?t(a):e?v.formatNumber(a,{...v.convertNumberFormatToIntlOptions(b),minimumFractionDigits:0,maximumFractionDigits:20}):b.formatNumber(a)}function F(a,b){if(a&&a.length&&b)return a.find(c=>c.fieldName?.toLowerCase()===b.toLowerCase())}function Z({fieldName:a,graphic:b,layer:c}){if(u(a)||!c||"function"!==typeof c.getFeatureType)return null;const {typeIdField:d}=
c;return d&&a===d?(a=c.getFeatureType(b))?a.name:null:null}function aa({fieldName:a,value:b,graphic:c,layer:d}){return u(a)||!d||"function"!==typeof d.getFieldDomain?null:(a=c&&d.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null}function t(a){return"string"===typeof a?a.replaceAll(ba,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function G(a){const {value:b,fieldName:c,fieldInfos:d,fieldInfoMap:e,layer:g,graphic:f}=a;if(null==b)return"";if((a=aa({fieldName:c,value:b,graphic:f,
layer:g}))||(a=Z({fieldName:c,graphic:f,layer:g})))return a;if(e.get(c.toLowerCase()))return E(b,{fieldInfos:d||Array.from(e.values()),fieldName:c,layer:g});switch(g?.fieldsIndex?.get(c)?.type){case "date":return l.formatDate(b);case "date-only":return l.formatDateOnly(b);case "time-only":return l.formatTimeOnly(b);case "timestamp-offset":return l.formatTimestamp(b)}return t(b)}async function H(a,b){const {layer:c,graphic:d,outFields:e,objectIds:g,returnGeometry:f,spatialReference:k}=a;a=g[0];if("number"!==
typeof a&&"string"!==typeof a)return I.warn("Could not query required fields for the specified feature. The feature's ID is invalid.",{layer:c,graphic:d,objectId:a,requiredFields:e}),null;if(!w.getEffectiveLayerCapabilities(c)?.operations?.supportsQuery)return I.warn("The specified layer cannot be queried. The following fields will not be available.",{layer:c,graphic:d,requiredFields:e,returnGeometry:f}),null;a=c.createQuery();a.objectIds=g;a.outFields=e?.length?e:[c.objectIdField];a.returnGeometry=
!!f;a.returnZ=!!f;a.returnM=!!f;a.outSpatialReference=k;return(await c.queryFeatures(a,b)).features[0]}async function ca(a){if(!a.expressionInfos?.length)return!1;var b=await Q.loadArcade();({arcadeUtils:{hasGeometryFunctions:b}}=b);return b(a)}function u(a=""){return a?a.includes("relationships/"):!1}function J({attributes:a,graphic:b,relatedInfo:c,fieldInfos:d,fieldInfoMap:e,layer:g}){a&&b&&c&&Object.keys(b.attributes).forEach(f=>{var k=(k={layerId:c.relation.id.toString(),fieldName:f},`${"relationships/"}${k.layerId}/${k.fieldName}`);
a[k]=G({fieldName:k,fieldInfos:d,fieldInfoMap:e,layer:g,value:b.attributes[f],graphic:b})})}function da({attributes:a,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e}){a&&b&&(b.relatedFeatures&&b.relatedFeatures&&b.relatedFeatures.forEach(g=>J({attributes:a,graphic:g,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e})),b.relatedStatsFeatures&&b.relatedStatsFeatures&&b.relatedStatsFeatures.forEach(g=>J({attributes:a,graphic:g,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e})))}function K(a,b,c){return a.filter(r).find(d=>
d!==b&&d.url===b.url&&d.layerId===c.relatedTableId)}const I=O.getLogger("esri.widgets.Feature.support.featureUtils"),S=/href=(""|'')/gi,W=/(\{([^\{\r\n]+)\})/g,U=/'/g,y=/^\s*expression\//i,ba=/(\n)/gi,ea=/[\u00A0-\u9999<>&]/gim,Y=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,fa=/^(?:mailto:|tel:)/,L=l.convertDateFormatToIntlOptions("short-date-short-time"),M=a=>{if(!a)return!1;a=a.toUpperCase();return a.includes("CURRENT_TIMESTAMP")||a.includes("CURRENT_DATE")||a.includes("CURRENT_TIME")},N=({layer:a,method:b,
query:c,definitionExpression:d})=>{a.capabilities?.query?.supportsCacheHint&&"attachments"!==b&&(a=null!=c.where?c.where:null,b=null!=c.geometry?c.geometry:null,M(d)||M(a)||"extent"===b?.type||"tile"===c.resultType||(c.cacheHint=!0))};h.applyTextFormattingHTML=t;h.createfieldInfoMap=function(a,b){const c=new Map;if(!a)return c;a.forEach(d=>{const e=p(d.fieldName,b);d.fieldName=e;c.set(e.toLowerCase(),d)});return c};h.findRelatedLayer=function(a,b,c){return a&&b&&c?K(a.allLayers,b,c)||K(a.allTables,
b,c):null};h.fixTokens=A;h.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:d,fieldInfoMap:e,relatedInfos:g}){const f={};g?.forEach(k=>da({attributes:f,relatedInfo:k,fieldInfoMap:e,fieldInfos:a,layer:c}));b&&Object.keys(b).forEach(k=>{f[k]=G({fieldName:k,fieldInfos:a,fieldInfoMap:e,layer:c,value:b[k],graphic:d})});return f};h.formatEditInfo=function(a,b){const {creatorField:c,creationDateField:d,editorField:e,editDateField:g}=a;if(b){a=b[g];if("number"===typeof a)return b=b[e],
{type:"edit",date:l.formatDate(a,L),user:b};a=b[d];return"number"===typeof a?(b=b[c],{type:"create",date:l.formatDate(a,L),user:b}):null}};h.formatValueToFieldInfo=E;h.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:d}=a;c&&b.push(...c);if(!d||!Array.isArray(d))return b;d.forEach(e=>{"fields"===e.type&&(e=e&&e.fieldInfos)&&b.push(...e)});return b};h.getFieldInfo=F;h.getFieldInfoLabel=function(a,b){return(b=R(b,a?.fieldName))?b.title||null:a?a.label||a.fieldName:
null};h.getFixedFieldName=p;h.getFixedFieldNames=function(a,b){return a&&a.map(c=>p(c,b))};h.getSourceLayer=function(a){if(null!=a)return a.get("sourceLayer")||a.get("layer")};h.graphicCallback=async function(a,b){return"function"===typeof a?a(b):a};h.htmlEntities=function(a){return a.replaceAll(ea,b=>`&#${b.charCodeAt(0)};`)};h.isExpressionField=x;h.isFeatureSupportedLayer=C;h.isGraphicForRelatableFeatureSupportedLayer=function(a){return!!a&&"object"===typeof a&&"sourceLayer"in a&&r(a.sourceLayer)};
h.isRelatableFeatureSupportedLayer=r;h.isRelatableLayer=D;h.isRelatedField=u;h.preLayerQueryCallback=({query:a,layer:b,method:c})=>{N({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression}`})};h.preRequestCallback=({queryPayload:a,layer:b,method:c})=>{N({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression}`})};h.querySourceLayer=H;h.queryUpdatedFeature=async function({graphic:a,popupTemplate:b,
layer:c,spatialReference:d},e){if(c&&b&&("function"===typeof c.load&&await c.load(e),a.attributes)){var g=a.attributes[c.objectIdField];if(null!=g){g=[g];var f=await b.getRequiredFields(c.fieldsIndex),k=n.featureHasFields(f,a);f=k?[]:f;b=b.returnGeometry||await ca(b);if(!k||b)if(c=await H({layer:c,graphic:a,outFields:f,objectIds:g,returnGeometry:b,spatialReference:d},e))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes={...a.attributes,...c.attributes})}}};h.shouldOpenInNewTab=function(a=
""){if(a)return!fa.test(a.trim().toLowerCase())};h.substituteAttributes=z;h.substituteFieldsInLinksAndAttributes=function({attributes:a,globalAttributes:b,layer:c,text:d,expressionAttributes:e,fieldInfoMap:g}){return d?z({formattedAttributes:b,template:X(d,{...b,...e,...a},c),fieldInfoMap:g}):""};Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
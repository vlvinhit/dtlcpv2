// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Logger ../../../core/promiseUtils ../../../layers/FeatureLayer ./featureUtils".split(" "),function(u,p,v,w,x,m){function y(b){return`<ul class="esri-widget__list">${b.map(a=>`<li>${"string"===typeof a?m.applyTextFormattingHTML(m.htmlEntities(a)):a}</li>`).join("")}</ul>`}function z(b){return`<table class="esri-widget__table">${b.keys().map(a=>{var c=b.field(a);c="string"===typeof c?m.applyTextFormattingHTML(m.htmlEntities(c)):c;return`<tr><th>${a}</th><td>${c}</td></tr>`}).join("")}</table>`}
function A({aggregatedFeatures:b,arcadeUtils:a,featureSetVars:c,context:e,viewInfo:k,map:l,graphic:h,interceptor:g}){c.forEach(d=>{d=d.toLowerCase();var f=k.sr;const n={map:l,spatialReference:f,interceptor:g};"$map"===d&&(e.vars[d]=a.convertMapToFeatureSetCollection(n));"$layer"===d&&(e.vars[d]=a.convertFeatureLayerToFeatureSet({layer:h.sourceLayer,spatialReference:f,interceptor:g}));"$datastore"===d&&(e.vars[d]=a.convertServiceUrlToWorkspace({url:h.sourceLayer.url,spatialReference:f,interceptor:g}));
if("$aggregatedfeatures"===d){f=h.layer;const {fields:B,objectIdField:C,geometryType:D,spatialReference:q,displayField:E}=f;f=new x({fields:B,objectIdField:C,geometryType:D,spatialReference:q,displayField:E,...("feature"===f.type?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null),source:b});e.vars[d]=a.convertFeatureLayerToFeatureSet({layer:f,spatialReference:q,interceptor:g})}})}function r(){return new Promise((b,a)=>u(["../../../support/arcadeUtils"],b,a))}async function F({graphic:b,
view:a}){const {isAggregate:c,layer:e}=b;if(!c||!e||"2d"!==a?.type)return[];a=await a.whenLayerView(e);if(!("createQuery"in a&&"queryFeatures"in a))return[];const k=a.createQuery();b=b.getObjectId();k.aggregateIds=null!=b?[b]:[];({features:b}=await a.queryFeatures(k));return b}async function t({expressionInfo:b,arcadeUtils:a,interceptor:c,spatialReference:e,map:k,graphic:l,view:h}){if(!b||!b.expression)return null;const g=a.createSyntaxTree(b.expression),d=G.filter(n=>a.hasVariable(g,n));[h]=await Promise.all([F({graphic:l,
view:h}),a.loadScriptDependencies(g,!0,d)]);const f=a.getViewInfo({spatialReference:e});e=a.createExecContext(l,f);e.interceptor=c;e.useAsync=!0;A({aggregatedFeatures:h,arcadeUtils:a,featureSetVars:d,context:e,viewInfo:f,map:k,graphic:l,interceptor:c});c=a.createFunction(g,e);return a.executeAsyncFunction(c,e).catch(n=>H.error("arcade-execution-error",{error:n,graphic:l,expressionInfo:b}))}const G=["$datastore","$map","$layer","$aggregatedfeatures"],H=v.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");
p.createCompiledExpression=t;p.createCompiledExpressions=async function({expressionInfos:b,spatialReference:a,graphic:c,interceptor:e,map:k,view:l}){if(!b||!b.length)return{};const h=await r(),g={};for(const d of b)g[`expression/${d.name}`]=t({expressionInfo:d,arcadeUtils:h,interceptor:e,spatialReference:a,map:k,graphic:c,view:l});b=await w.eachAlways(g);a={};for(const d in b)c=b[d].value,c="string"===typeof c?m.applyTextFormattingHTML(m.htmlEntities(c)):Array.isArray(c)?y(c):"esri.arcade.Dictionary"===
c?.declaredClass?z(c):c,a[d]=c;return a};p.loadArcadeUtils=r;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../request ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../core/has ../../../layers/support/source/DataLayerSource ../../../rest/query/executeQueryJSON ../../../config ../../../kernel ../../../core/arrayUtils ../../../core/urlUtils ../../../core/unitUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/graphics/featureConversionUtils ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Multipoint ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../../../geometry/support/normalizeUtils ../../../core/pbf ../../../rest/support/FeatureSet ../../../rest/support/Query ../../../rest/query/support/AttachmentInfo ../../../rest/support/AttachmentQuery ../../../geometry ../../../rest/support/RelationshipQuery ../../../rest/support/TopFeaturesQuery ../../../rest/support/StatisticDefinition ./featureUtils".split(" "),
function(g,x,r,y,k,z,L,M,m,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,n,da,ea,fa,A,ha,B,C){function D(b,a){if(!a.relationships)return null;let d=null;({relationships:a}=a);a.some(e=>e.id===parseInt(b,10)?(d=e,!0):!1);return d}function t({originRelationship:b,relationships:a,layerId:d}){let e=null;a&&a.some(c=>{`${c.relatedTableId}`===d&&c.id===b?.id&&(e=c);return!!e});return e}function E(b,a){a=a.toLowerCase();for(const d in b)if(d.toLowerCase()===a)return b[d];return null}function F(b,a,d,e){const c=new A;
c.outFields=["*"];c.relationshipId="number"===typeof a.id?a.id:parseInt(a.id,10);c.objectIds=[b.attributes[d.objectIdField]];return d.queryRelatedFeatures?.(c,e)??Promise.resolve({})}function G(b,a,d){let e=0;const c=[];for(;e<a.length;)c.push(`${b} IN (${a.slice(e,d+e)})`),e+=d;return c.join(" OR ")}async function H(b,a,d,e){var c=d.layerId.toString();const {layerInfo:f,relation:h,relatedFields:l,outStatistics:u,url:p,sourceSpatialReference:q}=a;if(!f||!h)return null;c=t({originRelationship:h,relationships:f.relationships,
layerId:c});if(c?.relationshipTableId&&c.keyFieldInRelationshipTable){d=(await F(b,c,d,e))[b.attributes[d.objectIdField]];if(!d)return null;const J=d.features.map(I=>I.attributes[f.objectIdField]);if(u?.length&&f.supportsStatistics)return a=new n,a.where=G(f.objectIdField,J,1E3),a.outFields=l,a.outStatistics=u,a.sourceSpatialReference=q,a={features:Promise.resolve(d),statsFeatures:m.executeQueryJSON(p,a)},k.eachAlways(a)}return(c=c?.keyField)?(d=z.isNumericField(K(f.fields,c)),b=E(b.attributes,h.keyField),
c=d?`${c}=${b}`:`${c}='${b}'`,b=m.executeQueryJSON(p,new n({where:c,outFields:a.relatedFields,sourceSpatialReference:q}),e),a=a.outStatistics&&0<a.outStatistics.length&&f.supportsStatistics?m.executeQueryJSON(p,new n({where:c,outFields:a.relatedFields,outStatistics:a.outStatistics,sourceSpatialReference:q}),e):null,e={features:b},a&&(e.statsFeatures=a),k.eachAlways(e)):null}function K(b,a){if(null!=b){a=a.toLowerCase();for(const d of b)if(d&&d.name.toLowerCase()===a)return d}return null}const v=y.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),
w=new Map;g.createRelatedInfo=function(b,a){if(b=D(b,a))return{url:`${a.url}/${b.relatedTableId}`,sourceSpatialReference:a.spatialReference,relation:b,relatedFields:[],outStatistics:[]}};g.getDestinationRelation=t;g.getRelatedFieldInfo=function(b){if(!C.isRelatedField(b))return null;const [a,d]=b.split("/").slice(1);return{layerId:a,fieldName:d}};g.queryLayerInfos=function({relatedInfos:b,layer:a},d){const e={};b.forEach((c,f)=>{({relation:c}=c);if(!c)throw f=new r("relation-required","A relation is required on a layer to retrieve related records."),
v.error(f),f;({relatedTableId:c}=c);if("number"!==typeof c)throw f=new r("A related table ID is required on a layer to retrieve related records."),v.error(f),f;c=`${a.url}/${c}`;const h=w.get(c),l=h??x(c,{query:{f:"json"},signal:void 0});h||w.set(c,l);e[f]=l});return k.whenOrAbort(k.eachAlways(e),d)};g.queryRelatedFeatures=function({graphic:b,relatedInfos:a,layer:d},e){const c={};a.forEach((f,h)=>{f.layerInfo&&(c[h]=H(b,f,d,e))});return k.eachAlways(c)};g.setRelatedFeatures=function(b,a){if(a&&b){var {features:d,
statsFeatures:e}=b;b=d&&d.value;a.relatedFeatures=b?b.features:[];b=e&&e.value;a.relatedStatsFeatures=b?b.features:[]}};g.updateRelatedInfo=function({relatedInfo:b,fieldName:a,fieldInfo:d}){b.relatedFields?.push(a);d.statisticType&&(a=new B({statisticType:d.statisticType,onStatisticField:a,outStatisticFieldName:a}),b.outStatistics?.push(a))};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
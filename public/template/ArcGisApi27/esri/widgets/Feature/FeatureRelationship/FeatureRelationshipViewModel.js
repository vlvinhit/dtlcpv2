// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Clonable ../../../core/Collection ../../../core/HandleOwner ../../../core/Identifiable ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../rest/support/RelationshipQuery ../support/featureUtils ../../FeatureForm/featureFormUtils".split(" "),
function(p,e,F,d,G,H,A,I,J,q,v,f,Q,R,K,B,C,x){d=function(D){function w(c){var a=D.call(this,c)||this;a._loaded=!1;a._queryAbortController=null;a._queryPageAbortController=null;a._queryFeatureCountAbortController=null;a.featuresPerPage=10;a.description=null;a.graphic=null;a.layer=null;a.map=null;a.orderByFields=null;a.featureCount=0;a.relationshipId=null;a.showAllEnabled=!1;a.title=null;a._cancelQuery=()=>{const {_queryAbortController:b}=p._assertThisInitialized(a);b&&b.abort();a._queryAbortController=
null};a._cancelQueryFeatureCount=()=>{const {_queryFeatureCountAbortController:b}=p._assertThisInitialized(a);b&&b.abort();a._queryFeatureCountAbortController=null};a._cancelQueryPage=()=>{const {_queryPageAbortController:b}=p._assertThisInitialized(a);b&&b.abort();a._queryPageAbortController=null};a._queryController=async()=>{a._cancelQuery();const b=new AbortController;a._queryAbortController=b;await q.ignoreAbortErrors(a._query());a._queryAbortController===b&&(a._queryAbortController=null)};a._queryFeatureCountController=
async()=>{a._loaded=!1;a._cancelQueryFeatureCount();const b=new AbortController;a._queryFeatureCountAbortController=b;await q.ignoreAbortErrors(a._queryFeatureCount());a._queryFeatureCountAbortController===b&&(a._queryFeatureCountAbortController=null);a._loaded=!0};a._queryPageController=async()=>{const b=new AbortController;a._queryPageAbortController=b;await q.ignoreAbortErrors(a._queryPage());a._queryPageAbortController===b&&(a._queryPageAbortController=null)};a._queryDebounced=q.debounce(a._queryController,
100);a._queryFeatureCountDebounced=q.debounce(a._queryFeatureCountController,100);a._queryPageDebounced=q.debounce(a._queryPageController,100);a._query=async()=>{const {_queryAbortController:b,relatedFeatures:g}=p._assertThisInitialized(a);a.featureCount&&(a._destroyRelatedFeatureViewModels(),a.featurePage=1,g.removeAll(),a.destroyed||g.addMany(a._sliceFeatures(await a._queryRelatedFeatures({signal:b?.signal}))))};a.handles.add([v.watch(()=>[a.displayCount,a.graphic,a.layer,a.layer?.loaded,a.map,
a.orderByFields,a.relationshipId,a.featuresPerPage,a.showAllEnabled,a.canQuery,a.featureCount],()=>a._queryDebounced(),v.initial),v.watch(()=>[a.featurePage,a.showAllEnabled],()=>a._queryPageDebounced()),v.watch(()=>[a.layer,a.relationshipId,a.objectId,a.canQuery],()=>a._queryFeatureCountDebounced())]);return a}p._inherits(w,D);var m=w.prototype;m.destroy=function(){this._destroyRelatedFeatureViewModels();this.relatedFeatures.removeAll();this._cancelQuery();this._cancelQueryFeatureCount();this._cancelQueryPage()};
m.getRelatedFeatureByObjectId=function(c){return this.relatedFeatures.find(a=>a.getObjectId()===c)};m._destroyRelatedFeatureViewModels=function(){this.relatedFeatureViewModels?.forEach(c=>!c.destroyed&&c.destroy());this.relatedFeatureViewModels.removeAll()};m._queryFeatureCount=async function(){const {layer:c,relatedLayer:a,relationshipId:b,objectId:g,_queryFeatureCountAbortController:k,canQuery:l,supportsCacheHint:r}=this;await c?.load();await a?.load();if(l&&c&&a){var h=a.createQuery();h=new B({cacheHint:r,
relationshipId:b,returnGeometry:!1,objectIds:[g],where:h.where??void 0});h=await c.queryRelatedFeaturesCount(h,{signal:k?.signal});this._set("featureCount",h[g]||0)}else this._set("featureCount",0)};m._sliceFeatures=function(c){const {showAllEnabled:a,displayCount:b}=this;return a?c:b?c.slice(0,b):[]};m._queryPage=async function(){const {relatedFeatures:c,featurePage:a,showAllEnabled:b,_queryPageAbortController:g,featureCount:k}=this;!b||2>a||!k||c.addMany(await this._queryRelatedFeatures({signal:g?.signal}))};
m._queryRelatedFeatures=async function(c){const {orderByFieldsFixedCasing:a,showAllEnabled:b,featuresPerPage:g,displayCount:k,layer:l,relationshipId:r,featurePage:h,featureCount:u,relatedLayer:t,supportsCacheHint:L}=this,{canQuery:M,objectId:E}=this;if(!M||!l||!t)return[];var y=b?((h-1)*g+u)%u:0;const N=b?g:k;var z=t.objectIdField;z=[...a.map(n=>n.field),...x.getFieldsInTitleAndDesc(t),z].filter(G.isSome);const O=a.map(n=>`${n.field} ${n.order}`),P=t.createQuery();y=new B({orderByFields:O,start:y,
num:N,outFields:z,cacheHint:L,relationshipId:r,returnGeometry:!1,objectIds:[E],where:P.where??void 0});c=(await l.queryRelatedFeatures(y,{signal:c?.signal}))[E]?.features||[];c.forEach(n=>{n.sourceLayer=t;n.layer=t});return c};p._createClass(w,[{key:"featurePage",get:function(){return this._get("featurePage")},set:function(c){const {featuresPerPage:a,featureCount:b}=this;this._set("featurePage",Math.min(Math.max(c,1),Math.ceil(b/a)||1))}},{key:"orderByFieldsFixedCasing",get:function(){const {orderByFields:c,
relatedLayer:a}=this;return c&&a?.loaded?c.map(b=>{const g=b.clone();g.field=C.getFixedFieldName(b.field,a);return g}):c??[]}},{key:"supportsCacheHint",get:function(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}},{key:"canLoad",get:function(){return!!this.map&&"number"===typeof this.relationshipId&&"number"===typeof this.objectId}},{key:"canQuery",get:function(){const c=this.layer?.capabilities?.queryRelated;return!!this.relatedLayer&&!!this.relationship&&"number"===typeof this.relationshipId&&
"number"===typeof this.objectId&&!!c?.supportsCount&&!!c?.supportsPagination}},{key:"itemDescriptionFieldName",get:function(){return this.orderByFieldsFixedCasing[0]?.field||null}},{key:"displayCount",get:function(){return this._get("displayCount")},set:function(c){this._set("displayCount",Math.min(Math.max(c,0),10))}},{key:"objectId",get:function(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}},{key:"objectIdField",get:function(){return this.layer?.objectIdField||
null}},{key:"relatedFeatures",get:function(){return this._get("relatedFeatures")||new A}},{key:"relatedFeatureInfos",get:function(){const {itemDescriptionFieldName:c,relatedFeatures:a,relatedLayer:b}=this;if(!a.length||!b)return[];const g=b&&"formTemplate"in b&&b.formTemplate,k=g&&g?.title||void 0;return a.map(l=>{let r=void 0;if(c){var h=l.getAttribute(c);const u=b.fieldsIndex.get(c);u&&(h=x.getComputedAttributes([h],[u])[c],null!=h&&(r=h.toString()))}h=k?x.parseFormTemplateString(k,l.attributes,
b.fieldsIndex):void 0;return{feature:l,description:r,title:h}}).toArray()}},{key:"relatedLayer",get:function(){const {layer:c,map:a,relationship:b}=this;return c?.loaded&&a&&b?C.findRelatedLayer(a,c,b)??null:null}},{key:"relationship",get:function(){const {relationshipId:c,layer:a}=this;return"number"===typeof c?a?.relationships?.find(({id:b})=>b===c)??null:null}},{key:"relatedFeatureViewModels",get:function(){return this._get("relatedFeatureViewModels")||new A}},{key:"state",get:function(){const {_queryAbortController:c,
_queryFeatureCountAbortController:a,_queryPageAbortController:b,canQuery:g,_loaded:k,canLoad:l}=this;return a||l&&!k?"loading":c||b?"querying":g?"ready":"disabled"}}]);return w}(H.ClonableMixin(J.IdentifiableMixin(I.HandleOwnerMixin(d))));e.__decorate([f.property()],d.prototype,"_loaded",void 0);e.__decorate([f.property()],d.prototype,"_queryAbortController",void 0);e.__decorate([f.property()],d.prototype,"_queryPageAbortController",void 0);e.__decorate([f.property()],d.prototype,"_queryFeatureCountAbortController",
void 0);e.__decorate([f.property({value:1})],d.prototype,"featurePage",null);e.__decorate([f.property()],d.prototype,"featuresPerPage",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"orderByFieldsFixedCasing",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"supportsCacheHint",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"canLoad",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"canQuery",null);e.__decorate([f.property()],d.prototype,"description",
void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"itemDescriptionFieldName",null);e.__decorate([f.property({value:3})],d.prototype,"displayCount",null);e.__decorate([f.property({type:F})],d.prototype,"graphic",void 0);e.__decorate([f.property()],d.prototype,"layer",void 0);e.__decorate([f.property()],d.prototype,"map",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"objectId",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"objectIdField",null);e.__decorate([f.property()],
d.prototype,"orderByFields",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedFeatures",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedFeatureInfos",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedLayer",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"relationship",null);e.__decorate([f.property()],d.prototype,"featureCount",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedFeatureViewModels",null);e.__decorate([f.property()],
d.prototype,"relationshipId",void 0);e.__decorate([f.property()],d.prototype,"showAllEnabled",void 0);e.__decorate([f.property()],d.prototype,"state",null);e.__decorate([f.property()],d.prototype,"title",void 0);e.__decorate([f.property()],d.prototype,"getRelatedFeatureByObjectId",null);return d=e.__decorate([K.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],d)});
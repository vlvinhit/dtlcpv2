// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/HandleOwner ../../core/handleUtils ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/scheduling ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../views/SceneView ../../views/3d/environment/SunLighting ../../views/3d/environment/VirtualLighting ../../views/3d/support/earthUtils ./support/daylightUtils ./support/SliderWithDropdownViewModel ../support/DatePickerViewModel ../support/timeWidgetUtils".split(" "),
function(w,e,c,A,B,l,k,C,n,f,I,J,K,D,E,x,F,G,m,y,z,u){function r(q){n.isValidDate(q.date)||(B.getLogger("esri.widgets.Daylight.DaylightViewModel").warn("Invalid date. Reverting to the current date/time."),q.date=new Date);return q.date}c=function(q){function t(a){a=q.call(this,a)||this;a.view=null;a.datePickerViewModel=new z;a.timeSliderViewModel=new y.SliderWithDropdownViewModel({min:0,max:1439,values:[0],labelFormatFunction:u.formatSliderLabel,inputFormatFunction:u.formatSliderLabel});a.lightingUpdateInterval=
200;a._oldLighting=null;a.playSpeedMultiplier=1;a._lastTime=null;a._sunrise=null;a._sunset=null;a._cachedLightingDateUTC=new Date(0);a._cachedDisplayUTCOffset=0;a._firstInteraction=!0;a._lastLightingUpdate=0;a._lightingUpdateHandle=null;return a}w._inherits(t,q);var h=t.prototype;h.initialize=function(){this.handles.add([k.when(()=>this.view,a=>a.when(()=>this._updateLighting()),k.initial),k.watch(()=>{const a=this._lighting;return"sun"===a?.type?r(a):null},a=>this._scheduleLightingUpdate(a)),k.on(()=>
this._lighting,"timezone-will-change",a=>this._timezoneWillChange(a),{onListenerAdd:()=>this._timezoneWillChange(null)}),k.watch(()=>!0===l.applySome(this.view,a=>a.stationary),()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()},k.initial),k.watch(()=>{const a=this.timeSliderViewModel;return{vm:a,state:a.state,sliderPosition:this.timeSliderPosition}},({vm:a,state:b,sliderPosition:d})=>{"ready"===b&&a.setValue(0,d)}),k.watch(()=>this.timeSliderViewModel?.utcOffset,a=>{null!=a&&
(this.utcOffset=a)}),k.watch(()=>({utcOffset:this.utcOffset,sliderViewModel:this.timeSliderViewModel}),({utcOffset:a,sliderViewModel:b})=>{b&&(b.utcOffset=a)},k.syncAndInitial),k.watch(()=>this.timeSliderViewModel.timezonePickerOpen,()=>this.stopPlaying()),k.watch(()=>this.timeSliderViewModel.values,a=>this._setTimeSliderPosition(a?.[0]??0,{forceLightingUpdate:!1})),k.watch(()=>this.datePickerViewModel.value,a=>{this.dayPlaying=!1;this.localDate=a}),k.watch(()=>this.localDate,a=>{this.datePickerViewModel.value.valueOf()!==
a.getTime()&&this.datePickerViewModel.set("value",a)})])};h.destroy=function(){this._cancelLightingUpdate();this.view=null};h._setTimeSliderPosition=function(a,b){Math.abs(a-this.timeSliderPosition)<=1/60||(this.stopPlaying(),this._enableDirectShadowsIfFirstInteraction(),b.forceLightingUpdate&&(this._cancelLightingUpdate(),this._updateLighting()),this._lightingDateDisplay=m.sliderPosToDateTime(this._lightingDateDisplay,a))};h._timezoneFromCamera=function(a,b){if(null==b||!a.cameraTrackingEnabled)return 0;
a=G.positionToTimezoneInfo([b.longitude,b.latitude]);return null==a?0:Math.round(a.hours+a.minutes/60+a.seconds/3600)};h.stopPlaying=function(){this.playingState="none"};h.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying};h.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying};h.toggleSunLightingEnabled=function(){this.stopPlaying();this.sunLightingEnabled=!this.sunLightingEnabled};h.toggleDirectShadowsEnabled=function(){this.stopPlaying();this.directShadowsEnabled=!this.directShadowsEnabled};
h._enableDirectShadowsIfFirstInteraction=function(){this._firstInteraction&&(this._firstInteraction=!1,this.directShadowsEnabled=!0)};h._updateLighting=function(a){this._lastLightingUpdate=Date.now();var {view:b}=this;const d=this._lighting;if(null!=b&&null!=d&&"virtual"!==d.type){a??(a=r(d));var g=d.displayUTCOffset;b=null!==g?g:this._timezoneFromCamera(d,b.camera?.position);this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime()));this._cachedDisplayUTCOffset!==
b&&(this._cachedDisplayUTCOffset=b)}};h._timezoneWillChange=function(a){const b=this._lighting;if(null!=b&&"virtual"!==b.type&&b.cameraTrackingEnabled){if(a)a=a.timezoneOffset;else{if(null!=b.displayUTCOffset)return;a=x.calculateTimezoneOffset(b.positionTimezoneInfo)}b.displayUTCOffset=a;this._scheduleLightingUpdate()}};h._scheduleLightingUpdate=function(a){if(a&&(this._lightingUpdateHandle=l.removeMaybe(this._lightingUpdateHandle),!n.isValidDate(a)))return;if(!this._lightingUpdateHandle){var b=Date.now()-
this._lastLightingUpdate;b=this.lightingUpdateInterval-b;var d=null,g=()=>{this._updateLighting(a);this._lightingUpdateHandle===d&&(this._lightingUpdateHandle=null)};if(0>=b)this._lightingUpdateHandle=d=C.schedule(g);else{const p=setTimeout(g,b);this._lightingUpdateHandle=d=A.makeHandle(()=>clearTimeout(p))}}};h._cancelLightingUpdate=function(){this._lightingUpdateHandle=l.removeMaybe(this._lightingUpdateHandle)};h._play=function(){const a=this._lighting;if(null!=a&&this.sunLightingEnabled&&"virtual"!==
a.type){var b=r(a);if(this.dayPlaying||this.yearPlaying){var d=Date.now()-(this._lastTime??0);if(this.dayPlaying){if(this._lastTime=Date.now(),d*=m.calculatePlaySpeed(this._sunrise,this._sunset,b)*this.playSpeedMultiplier/100,0<d){let p=new Date(b.getTime()+d);var g=a.displayUTCOffset??0;const v=((p.getUTCHours()+g)%24+24)%24;g=((b.getUTCHours()+g)%24+24)%24;v<g&&(p=new Date(b.getTime()+d-864E5));a.date=p}}else 1E3<d&&(this._lastTime=Date.now(),d=(b.getUTCMonth()+1)%12,b=new Date(b.getTime()),b.setUTCMonth(d),
a.date=b);requestAnimationFrame(()=>this._play())}}};h._updateSunriseAndSunset=function(){var a=this._lighting;if(null!=a&&"virtual"!==a.type&&this.sunLightingEnabled){var b=l.applySome(this.view,H=>H.camera?.position);if(null!=b){var {latitude:d,longitude:g}=b,{date:p,displayUTCOffset:v}=a;if(a=u.getSunriseAndSunsetTimes(p,d,g,v))this._sunrise=new Date(a.sunrise),this._sunset=new Date(a.sunset)}}};w._createClass(t,[{key:"isSupported",get:function(){return null==this.view||"3d"===this.view.type}},
{key:"utcOffset",get:function(){return this._cachedDisplayUTCOffset},set:function(a){a!==this.utcOffset&&null!=this._lighting&&"virtual"!==this._lighting.type&&(this._lighting.displayUTCOffset=a,this._updateLighting())}},{key:"localDate",get:function(){return n.truncateLocalTime(this._lightingDateDisplay)},set:function(a){n.isValidDate(a)&&a.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=n.resetUTCDate(this._lightingDateDisplay,a))}},{key:"timeSliderPosition",get:function(){return m.dateTimeToSliderPos(this._lightingDateDisplay)},
set:function(a){this._setTimeSliderPosition(a,{forceLightingUpdate:!0})}},{key:"directShadowsEnabled",get:function(){return l.applySome(this._lighting,a=>a.directShadowsEnabled)??!1},set:function(a){l.applySome(this._lighting,b=>{b.directShadowsEnabled=a})}},{key:"sunLightingEnabled",get:function(){return"sun"===this._lightingType},set:function(a){const b=this._environment;if(a!==this._get("sunLightingEnabled")&&null!=b){var d=b.lighting,g=this._oldLighting;this._oldLighting=d;d={directShadowsEnabled:d.directShadowsEnabled,
cameraTrackingEnabled:d.cameraTrackingEnabled};g=null!=g&&g.type===(a?"sun":"virtual")?g:a?new x:new F;g.set(d);b.lighting=g;a||(this.timeSliderViewModel.timezonePickerOpen=!1)}}},{key:"playingState",set:function(a){this.playingState!==a&&this.sunLightingEnabled&&(this._set("playingState",a),"none"!==a&&(this._updateSunriseAndSunset(),this._lastTime=Date.now(),this._play(),this._enableDirectShadowsIfFirstInteraction()))}},{key:"dayPlaying",get:function(){return"day"===this.playingState},set:function(a){a?
this.playingState="day":this.dayPlaying&&(this.playingState="none")}},{key:"yearPlaying",get:function(){return"year"===this.playingState},set:function(a){a?this.playingState="year":this.yearPlaying&&(this.playingState="none")}},{key:"currentSeason",get:function(){return m.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(a){this.stopPlaying();a=m.getNorthernHemisphereSeason(a,this._currentHemisphere);this.localDate=m.getSeasonDate(this.localDate,a,m.Hemisphere.NORTHERN)}},{key:"_currentHemisphere",
get:function(){const a=l.applySome(this.view,b=>b.camera?.position?.latitude);return null==a||0<=a?m.Hemisphere.NORTHERN:m.Hemisphere.SOUTHERN}},{key:"_environment",get:function(){return l.applySome(this.view,a=>a.environment)}},{key:"_lighting",get:function(){return l.applySome(this._environment,a=>a.lighting)}},{key:"_lightingType",get:function(){return l.applySome(this._lighting,a=>a.type)}},{key:"_lightingDateDisplay",get:function(){return n.offsetDate(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset,
"hours")},set:function(a){const b=this._lighting;if(null!=b&&this.sunLightingEnabled&&"virtual"!==b.type&&n.isValidDate(a)){var d=r(b);a=n.offsetDate(a,-this._cachedDisplayUTCOffset,"hours");a.getTime()!==d.getTime()&&(b.date=a,this._updateLighting())}}}]);return t}(c.HandleOwner);e.__decorate([f.property({type:E})],c.prototype,"view",void 0);e.__decorate([f.property({type:z,nonNullable:!0})],c.prototype,"datePickerViewModel",void 0);e.__decorate([f.property({type:y.SliderWithDropdownViewModel,nonNullable:!0})],
c.prototype,"timeSliderViewModel",void 0);e.__decorate([f.property()],c.prototype,"isSupported",null);e.__decorate([f.property()],c.prototype,"lightingUpdateInterval",void 0);e.__decorate([f.property()],c.prototype,"utcOffset",null);e.__decorate([f.property()],c.prototype,"localDate",null);e.__decorate([f.property()],c.prototype,"timeSliderPosition",null);e.__decorate([f.property()],c.prototype,"directShadowsEnabled",null);e.__decorate([f.property()],c.prototype,"sunLightingEnabled",null);e.__decorate([f.property({type:["none",
"day","year"],value:"none"})],c.prototype,"playingState",null);e.__decorate([f.property()],c.prototype,"dayPlaying",null);e.__decorate([f.property()],c.prototype,"yearPlaying",null);e.__decorate([f.property()],c.prototype,"playSpeedMultiplier",void 0);e.__decorate([f.property()],c.prototype,"currentSeason",null);e.__decorate([f.property()],c.prototype,"_lastTime",void 0);e.__decorate([f.property()],c.prototype,"_sunrise",void 0);e.__decorate([f.property()],c.prototype,"_sunset",void 0);e.__decorate([f.property()],
c.prototype,"_cachedLightingDateUTC",void 0);e.__decorate([f.property()],c.prototype,"_cachedDisplayUTCOffset",void 0);e.__decorate([f.property()],c.prototype,"_firstInteraction",void 0);e.__decorate([f.property()],c.prototype,"_currentHemisphere",null);e.__decorate([f.property()],c.prototype,"_environment",null);e.__decorate([f.property()],c.prototype,"_lighting",null);e.__decorate([f.property()],c.prototype,"_lightingType",null);e.__decorate([f.property()],c.prototype,"_lightingDateDisplay",null);
return c=e.__decorate([D.subclass("esri.widgets.Daylight.DaylightViewModel")],c)});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../analysis/LineOfSightAnalysis ../../analysis/LineOfSightAnalysisObserver ../../analysis/LineOfSightAnalysisTarget ../../core/Collection ../../core/collectionUtils ../../core/Handles ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../support/elevationInfoUtils ./LineOfSightTarget ../support/AnalysisViewModel".split(" "),
function(r,k,t,y,z,e,u,A,B,g,h,l,G,H,I,C,n,v,D){const p=e.ofType(v);e=function(w){function m(a){a=w.call(this,a)||this;a.analysis=null;a.supportedViewType="3d";a.unsupportedErrorMessage="LineOfSightViewModel is only supported in 3D views.";a._handles=new A;a._vmTargetsToConnection=new Map;a._analysisTargetsToConnection=new Map;return a}r._inherits(m,w);var d=m.prototype;d.initialize=function(){this._handles.add([this.targets.on("after-add",a=>this._onViewModelTargetAdded(a.item)),this.targets.on("after-remove",
a=>this._onViewModelTargetRemoved(a.item)),h.watch(()=>this.analysis,a=>this._onAnalysisChange(a),h.syncAndInitial)])};d.destroy=function(){this._analysisTargetsToConnection.forEach(a=>a.remove());this._handles=g.destroyMaybe(this._handles)};d.continue=function(){null!=this.tool&&this.tool.continue()};d.stop=function(){null!=this.tool&&this.tool.stop()};d.constructAnalysis=function(){return new t};d.onConnectToAnalysisView=async function(a){this._handles.add([a.on("result-changed",b=>{const c=this._analysisTargetsToConnection.get(b.target);
c&&(null!=b.result?(c.viewModelTarget.intersectedGraphic=b.result.intersectedGraphic,c.viewModelTarget.intersectedLocation=b.result.intersectedLocation,c.viewModelTarget.visible=b.result.visible):(c.viewModelTarget.intersectedGraphic=null,c.viewModelTarget.intersectedLocation=null,c.viewModelTarget.visible=void 0))})],"view")};d.onDisconnectFromAnalysisView=function(){null!=this._handles&&this._handles.remove("view")};d._onViewModelTargetAdded=function(a){if(!this._vmTargetsToConnection.get(a)){var b=
new z({position:a.location});this._connectViewModelWithAnalysisTarget(a,b);this.analysis.targets.add(b)}};d._onViewModelTargetRemoved=function(a){if(a=this._vmTargetsToConnection.get(a))a.remove(),this.analysis.targets.remove(a.analysisTarget)};d._onAnalysisTargetAdded=function(a){if(!this._analysisTargetsToConnection.get(a)){var b=new v({location:g.applySome(a.position,c=>this._convertAnalysisPointToAbsoluteHeight(c,a.elevationInfo))});this._connectViewModelWithAnalysisTarget(b,a);this.targets.add(b)}};
d._onAnalysisTargetRemoved=function(a){if(a=this._analysisTargetsToConnection.get(a))a.remove(),this.targets.remove(a.viewModelTarget)};d._connectViewModelWithAnalysisTarget=function(a,b){let c=!1;const F=B.handlesGroup([h.watch(()=>({position:b.position,elevationInfo:b.elevationInfo}),({position:q,elevationInfo:f})=>{c||(c=!0,a.location=g.applySome(q,E=>this._convertAnalysisPointToAbsoluteHeight(E,f)),c=!1)},h.sync),h.watch(()=>a.location,q=>{c||(c=!0,b.position=g.applySome(q,f=>{f=f.clone();f.hasZ||
(f.z=0);return f}),b.elevationInfo=null,c=!1)},h.sync)]),x={analysisTarget:b,viewModelTarget:a,remove:()=>{F.remove();this._vmTargetsToConnection.delete(a);this._analysisTargetsToConnection.delete(b)}};this._vmTargetsToConnection.set(a,x);this._analysisTargetsToConnection.set(b,x)};d._onAnalysisChange=function(a){this._handles.remove("analysis");this._handles.add([this.analysis.targets.on("after-add",b=>this._onAnalysisTargetAdded(b.item)),this.analysis.targets.on("after-remove",b=>this._onAnalysisTargetRemoved(b.item))],
"analysis");this.targets.removeAll();a.targets.forEach(b=>{this._onAnalysisTargetAdded(b)})};d._convertAnalysisPointToAbsoluteHeight=function(a,b){const c=a.clone();null!=this.view&&(b=n.getEffectiveElevationInfo(a.hasZ,b),c.z=n.getConvertedElevation(this.view,a,b,n.absoluteHeightElevationInfo));return c};r._createClass(m,[{key:"state",get:function(){return this.disabled||!this.ready?"disabled":null==this.tool?"ready":this.tool.state}},{key:"observer",get:function(){const {observer:a}=this.analysis;
return null==a||null==a.position?null:this._convertAnalysisPointToAbsoluteHeight(a.position,a.elevationInfo)},set:function(a){a=g.applySome(a,b=>{b=b.clone();b.hasZ||(b.z=0);return b});this.analysis.observer=new y({position:a})}},{key:"targets",get:function(){return this._get("targets")||new p},set:function(a){this._set("targets",u.referenceSetter(a,this.targets,p))}},{key:"testInfo",get:function(){return{analysisView:this.analysisView,getAnalysisTargetFromViewModelTarget:a=>g.applySome(this._vmTargetsToConnection.get(a),
b=>b.analysisTarget)}}}]);return m}(D.AnalysisViewModel);k.__decorate([l.property({type:t})],e.prototype,"analysis",void 0);k.__decorate([l.property({readOnly:!0})],e.prototype,"state",null);k.__decorate([l.property()],e.prototype,"observer",null);k.__decorate([l.property({type:p,cast:u.castForReferenceSetter,nonNullable:!0})],e.prototype,"targets",null);return e=k.__decorate([C.subclass("esri.widgets.lineOfSight.LineOfSightViewModel")],e)});
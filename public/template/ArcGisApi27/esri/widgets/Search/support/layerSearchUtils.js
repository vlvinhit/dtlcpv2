// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../intl ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/unitUtils ../../../geometry/Polygon ../../../rest/support/FullTextSearch ./geometryUtils ../../../intl/substitute ../../../intl/date".split(" "),function(C,fa,w,O,P,Q,R,S,H,T,U){function I(a,c){const {filter:b,withinViewEnabled:g}=a;a=c?.extent;return b?.geometry??(g&&a?a:void 0)}async function J(a){a&&await a.load()}function K(a,c){return(a=a?.indexes)&&c?.length?a.filter(b=>"FullText"===b.indexType).some(b=>
{const g=b.fields?.split(",").map(h=>h.trim().toLowerCase())||[];return c.every(h=>g.includes(h.toLowerCase()))}):!1}function F({text:a,searchFields:c}){return a.trim().split(" ").filter(b=>!!b.trim()).map(b=>new S({onFields:c,searchTerm:b,searchType:"prefix"}))}function L(a){return a?.fieldsIndex?.fields?.find(c=>"string"===c.type)?.name??""}function D(a,c){return a&&c?.length?c.every(b=>!!a.getField(b)):!1}function V(a,c,b){let g=null;({codedValues:a}=a);a&&a.some(h=>{var l=h.name;l=b?l:l.toLowerCase();
return(b?c:c.toLowerCase())===l?(g=h.code.toString(),!0):!1});return g}function A(a,c){return(c=c?.where)?`(${a}) AND (${c})`:a}function W({currentTerm:a,field:c,filter:b,exactMatch:g,url:h,type:l}){var d=c?.type;c=c?.name;if("string"===d||"date"===d||"global-id"===d){if(d=h=X.test(h??""))a:{for(d=0;d<a.length;d++)if(255<a.charCodeAt(d)){d=!0;break a}d=!1}d=d?"N":"";if(g&&"search"===l)return A(`${c} = ${d}'${a}'`,b);if(h)return A(`${c} LIKE ${d}${`'${a}%'`}`,b);g=`LOWER(${c})`;a=a.toLowerCase();return A(`${g} LIKE ${d}${`'${a}%'`}`,
b)}return"oid"===d||"small-integer"===d||"integer"===d||"single"===d||"double"===d?(a=Number(a),isNaN(a)?null:A(`${c} = ${a}`,b)):A(`${c} = ${a}`,b)}function M({searchTerm:a,layer:c,searchFields:b,filter:g,exactMatch:h,query:l,type:d}){const {definitionExpression:p,url:t}=c;let k="";!l.fullText&&a&&b&&b.forEach(f=>{var q=c.getField(f);f=((f="function"===typeof c.getFieldDomain&&c.getFieldDomain(f))&&"coded-value"===f.type?V(f,a,h):null)||a||null;null!==f&&(q=W({currentTerm:f,field:q,filter:g,exactMatch:h,
url:t,type:d}))&&(k+=k?` OR (${q})`:`(${q})`)});return p&&k?`(${p}) AND (${k})`:p||k}function Y(a,c){let b=null;({codedValues:a}=a);a&&a.length&&a.some(g=>g.code===c?(b=g.name,!0):!1);return b}function Z(a,c){return a[Object.keys(a).find(b=>b.toLowerCase()===c.toLowerCase())]}function N(a,c,b){const g=a.sourceLayer,{attributes:h}=a;a="function"===typeof g.getFieldDomain&&g.getFieldDomain(b);return c?T.substitute(c,h):b&&h?(c=g.getField(b),b=Z(h,b),null==b?"":a&&"coded-value"===a.type?Y(a,b)??"":"date"===
c?.type?U.formatDate(new Date(b)):"number"===typeof b?b.toString():"string"!==typeof b?"":b.trim()):""}function aa(a,c,b,g){return a.features.map(h=>{var l=h.sourceLayer,{attributes:d}=h;({objectIdField:l}=l);d=l?d[l]:null;return{text:N(h,c.suggestionTemplate,g),key:d,sourceIndex:b}})}function ba(a,c,b,g,h,l,d){return a.features.map(p=>{const t=p.clone();var k=p.sourceLayer?.objectIdField;k=k?p.attributes[k]:null;const f=N(p,b.searchTemplate,h);var q=H.createExtentFromGeometry(t.geometry,c,l);q="number"===
typeof d?H.scaleExtent(O.clone(q),c,d):q;p=p.clone();null!=q&&(p.geometry=R.fromExtent(q));return{extent:q,target:p,feature:t,key:k,name:f,sourceIndex:g}})}const X=/https?:\/\/services.*\.arcgis\.com/i,ca=/(?:\{([^}]+)\})/g,x=P.getLogger("esri.widgets.Search.support.layerSearchUtils");C.createFullTextSearchInfos=F;C.getResults=function(a,c){const {exactMatch:b=!1,location:g,maxResults:h,spatialReference:l,source:d,sourceIndex:p,suggestResult:t,view:k}=a,{layer:f,filter:q,zoomScale:E}=d,y=k?.scale,
v=I(d,k),u=c&&c.signal;return J(f).then(()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null}).then(e=>{const {objectIdField:m,returnZ:G}=f,z=d.displayField||d.layer.displayField||L(d.layer);if(!f.getField(z))throw x.error("invalid-field: displayField is invalid."),new w("getResults():invalid-field","displayField is invalid.");e=e&&e.length?e:[z];var n=d.outFields||e;e=n&&n.includes("*");n.includes(m)||e||n.push(m);f.floorInfo?.floorField&&n.push(f.floorInfo.floorField);if(!e&&
!D(f,n))throw x.error("invalid-field: outField is invalid."),new w("getResults():invalid-field","outField is invalid.");e=f.createQuery();var {orderByFields:r}=d;r&&(e.orderByFields=r);l&&(e.outSpatialReference=l,r=1/Q.getMetersPerUnitForSR(l))&&(e.maxAllowableOffset=r);r="mesh"===f.geometryType||"multipatch"===f.geometryType;e.returnZ=f.capabilities?.data?.supportsZ&&!r&&!1!==G;e.returnGeometry=!0;e.multipatchOption=r?"xyFootprint":null;n&&(e.outFields=n);if(g)e.geometry=g;else if(t.key)e.objectIds=
[t.key];else{n=d.searchFields||[z];if(!D(f,n))throw x.error("invalid-field: search field is invalid."),new w("getResults():invalid-field","search field is invalid.");(f?.capabilities?.query?.supportsPagination??!1)&&(e.num=h);v&&(e.geometry=v);if(!t.text?.trim())return[];r=t.text;const {prefix:B="",suffix:da=""}=d,ea=`${B}${r}${da}`.replaceAll("'","''");(f?.capabilities?.query?.supportsFullTextSearch??!1)&&K(f,n)&&!b&&r&&(e.fullText=F({text:r,searchFields:n}));n=M({searchTerm:ea,layer:f,searchFields:n,
filter:q,exactMatch:b,query:e,type:"search"});e.where=n;if(!e.fullText&&!e.where)return[]}return f.queryFeatures(e,{signal:u}).then(B=>ba(B,k,d,p,z,y,E))})};C.getSuggestions=function(a,c){const {source:b,spatialReference:g,view:h,suggestTerm:l,maxSuggestions:d,sourceIndex:p,exactMatch:t}=a,{layer:k,filter:f}=b,q=c&&c.signal,E=I(b,h);return J(k).then(()=>{if(!(k?.capabilities?.query?.supportsPagination??!1))return[];const y=b.displayField||b.layer.displayField||L(b.layer);var v=b.searchFields||[y];
const u=[];b.suggestionTemplate?b.suggestionTemplate.replaceAll(ca,(r,B)=>{u.push(B);return r}):u.push(y);var e=u&&u.includes("*");u.includes(k.objectIdField)||e||u.push(k.objectIdField);var m=!!k.getField(y);e=e||D(k,u);const G=D(k,v);if(!m)throw x.error("invalid-field: displayField is invalid."),new w("getSuggestions():invalid-field","displayField is invalid.");if(!e)throw x.error("invalid-field: outField is invalid."),new w("getSuggestions():invalid-field","outField is invalid.");if(!G)throw x.error("invalid-field: search field is invalid."),
new w("getSuggestions():invalid-field","search field is invalid.");m=k.createQuery();({orderByFields:e}=b);e&&(m.orderByFields=e);m.outSpatialReference=g;m.returnGeometry=!1;m.num=d;m.outFields=u;E&&(m.geometry=E);if(!l.trim())return[];const {prefix:z="",suffix:n=""}=b;e=`${z}${l}${n}`.replaceAll("'","''");(k?.capabilities?.query?.supportsFullTextSearch??!1)&&K(k,v)&&!t&&l&&(m.fullText=F({text:l,searchFields:v}));v=M({searchTerm:e,layer:k,searchFields:v,filter:f,exactMatch:t,query:m,type:"suggest"});
m.where=v;return m.fullText||m.where?k.queryFeatures(m,{signal:q}).then(r=>aa(r,b,p,y)):[]})};Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});
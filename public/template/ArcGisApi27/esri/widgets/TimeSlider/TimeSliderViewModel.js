// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../TimeExtent ../../TimeInterval ../../core/Collection ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/TimeSlider".split(" "),
function(G,A,h,q,H,B,f,I,J,C,D,t,K,l,E,O,P,L,M,N){function z(e){return null!=e&&void 0!==e.count}function x(e){return null!=e&&void 0!==e.interval}function F(e){return null!=e&&"object"===typeof e&&"declaredClass"in e&&"esri.WebMap"===e.declaredClass}f=function(e){function w(a){a=e.call(this,a)||this;a._animationController=null;a._isViewTimeExtentInitialized=!1;a._timerId=null;a.actions=new B;a.fullTimeExtent=null;a.loop=!1;a.mode="time-window";a.stops={count:10};a.timeExtent=null;a.view=null;return a}
A._inherits(w,e);var k=w.prototype;k.initialize=function(){this.handles.add([t.watch(()=>this.effectiveStops,()=>{null==this.timeExtent&&(this.timeExtent=this._getDefaultTimeExtent())},t.initial),t.watch(()=>this.view,(a,b)=>{this._unregisterWidget(b);this._registerWidget(a)},t.syncAndInitial),t.watch(()=>this.timeExtent,a=>{if(null!=this.view){var b=this.view.timeExtent;if(null!=a&&!a.isAllTime||null!=b&&!b.isAllTime)null!=a&&null!=b&&a.equals(b)||(this.view.timeExtent=a)}},t.initial),t.watch(()=>
C.applySome(this.view,a=>a.timeExtent),a=>{if(!this._isViewTimeExtentInitialized)this._isViewTimeExtentInitialized=!0;else if(null!=a&&!a.isAllTime||null!=this.timeExtent&&!this.timeExtent.isAllTime)null!=a&&null!=this.timeExtent&&a.equals(this.timeExtent)||(this.timeExtent=a)})])};k.destroy=function(){null!=this._timerId&&(clearInterval(this._timerId),this._timerId=null);this._unregisterWidget(this.view);this.view=null;null!=this._animationController&&(this._animationController.abort(),this._animationController=
null)};w.getPropertiesFromWebMap=async function(a,b){if(null==a||!F(a))return null;await a.load({signal:b});var c=a?.widgets?.timeSlider;if(!c)return null;const {getFullTimeExtentFromWebDocument:d,getModeFromTimeSlider:m,getStopsFromTimeSlider:n,getTimeExtentFromTimeSlider:p}=await new Promise((r,y)=>G(["./utils"],r,y));a=await d(a,b);b=c.loop;const u=m(c),g=c.stopDelay??2E3,v=n(c);c=p(c,u);return{fullTimeExtent:a,loop:b,mode:u,playRate:g,stops:v,timeExtent:c}};k.next=function(){this._step({forward:!0,
allowRestart:!1})};k.play=function(){this._startAnimation()};k.previous=function(){this._step({forward:!1,allowRestart:!1})};k.stop=function(){this._stopAnimation()};k.triggerAction=function(a){this.emit("trigger-action",{action:a})};k.updateWebDocument=function(a){if(F(a)){var b=this.timeExtent,c=this.fullTimeExtent,d=this.loop,m=z(this.stops)?this.stops.count:null,n="time-window"===this.mode?2:1,p=this.playRate,u=x(this.stops)?this.stops.interval:null,g=this.stops;b=new N({currentTimeExtent:b,fullTimeExtent:c,
loop:d,numStops:m,numThumbs:n,stopDelay:p,stopInterval:u,stops:null!=g&&void 0!==g.dates?this.stops.dates:null});a.widgets?a.widgets.timeSlider=b:a.widgets=new M({timeSlider:b})}};k.valuesToTimeExtent=function(a){if(null==a)return null;var b=a.sort((c,d)=>c-d).map(c=>new Date(c));a=0<b.length?b[0]:null;b=1<b.length?b[1]:null;switch(this.mode){case "time-window":return new q({start:a,end:b});case "instant":return new q({start:a,end:a});case "cumulative-from-start":return new q({start:null,end:a});
case "cumulative-from-end":return new q({start:a,end:null});default:return q.allTime}};k._animate=async function(){try{const a=this.view,b=C.applySome(this._animationController,c=>c.signal);await Promise.all([D.after(this.playRate,null,b),null!=a&&t.whenOnce(()=>!1===a.updating,b)])}catch(a){D.isAbortError(a)||J.getLogger(this).error(a);this._animationController=null;return}this._step({forward:!0,allowRestart:!1});null!=this._animationController&&this._animate()};k._divideTimeExtentByCount=function(a,
b=10){if(!a||!b)return[];const {start:c,end:d}=a;if(null==c||null==d)return[];if(1E4<b)return this._divideTimeExtentByCount(a);a=[];const m=c.getTime(),n=d.getTime()-m;for(let p=0;p<=b;p++)a.push(new Date(m+p/b*n));return a};k._divideTimeExtentByInterval=function(a,b,c=1E4){if(!a||!b)return[];const {start:d,end:m}=a;if(null==d||null==m)return[];const n=m.getTime()-d.getTime(),p=b.toMilliseconds();if(0>=p||n/p>c)return this._divideTimeExtentByCount(a);a=[];const {value:u,unit:g}=b;for(b=d;b.getTime()<=
m.getTime();)a.push(new Date(b.getTime())),b=K.offsetDate(b,u,g);return a};k._getDefaultTimeExtent=function(){const {effectiveStops:a,mode:b}=this;if(null==a||!b)return null;switch(b){case "time-window":return 1<a.length?new q({start:a[0],end:a[1]}):null;case "cumulative-from-start":return 0<a.length?new q({start:null,end:a[0]}):null;case "cumulative-from-end":return 0<a.length?new q({start:a[0],end:null}):null;case "instant":return 0<a.length?new q({start:a[0],end:a[0]}):null;default:return null}};
k._registerWidget=function(a){null!=a&&(a.persistableViewModels.includes(this)||a.persistableViewModels.add(this))};k._startAnimation=function(){this._stopAnimation();this._animationController=new AbortController;this._step({forward:!0,allowRestart:!0});this._animate()};k._step=function(a){const {forward:b,allowRestart:c}=a;({effectiveStops:a}=this);if(null!=this.timeExtentValues&&null!=a){var d=a.map(g=>g.getTime());a=this.timeExtentValues.map(g=>{var v=d.indexOf(g);if(-1!==v)return v;v=d.reduce((r,
y)=>Math.abs(y-g)<Math.abs(r-g)?y:r);return d.indexOf(v)});var m=a.map(g=>g+=b?1:-1),n=m.some(g=>0>g||g>d.length-1),{loop:p,state:u}=this;if(n)if(p||c){const g=Math.min(...a),v=Math.max(...a);a=(b?a.map(r=>r-g):a.map(r=>r+(d.length-1-v))).map(r=>d[r]);this.timeExtent=this.valuesToTimeExtent(a)}else"playing"===u&&this.stop();else a=m.map(g=>d[g]),this.timeExtent=this.valuesToTimeExtent(a)}};k._stopAnimation=function(){null!=this._animationController&&(this._animationController.abort(),this._animationController=
null)};k._unregisterWidget=function(a){null!=a&&a.persistableViewModels.remove(this)};A._createClass(w,[{key:"effectiveStops",get:function(){const {fullTimeExtent:a,stops:b}=this;if(null!=b&&void 0!==b.dates){var {dates:c}=b;if(null==c||0===c.length)return null;c=c.sort((n,p)=>n.getTime()-p.getTime());if(null==a)return c;const {start:d,end:m}=a;return null==d||null==m?c:c.filter(n=>!(n.getTime()<d.getTime()||n.getTime()>m.getTime()))}return z(b)?this._divideTimeExtentByCount(b.timeExtent??a,b.count):
x(b)?this._divideTimeExtentByInterval(b.timeExtent??a,b.interval):[]}},{key:"playRate",set:function(a){0>=a||36E5<a||("playing"===this.state&&this._startAnimation(),this._set("playRate",a))}},{key:"state",get:function(){return null==this.fullTimeExtent?"disabled":null!=this._animationController?"playing":"ready"}},{key:"timeExtentValues",get:function(){const {mode:a,timeExtent:b}=this;if(null==b||b.isAllTime||b.isEmpty)return null;const {start:c,end:d}=b;switch(a){case "cumulative-from-end":case "instant":return null!=
c?[c.getTime()]:null;case "cumulative-from-start":return null!=d?[d.getTime()]:null;case "time-window":return null!=c&&null!=d?[c.getTime(),d.getTime()]:null}}}]);return w}(I.HandleOwnerMixin(f.EventedAccessor));h.__decorate([l.property()],f.prototype,"_animationController",void 0);h.__decorate([l.property({type:B})],f.prototype,"actions",void 0);h.__decorate([l.property({readOnly:!0})],f.prototype,"effectiveStops",null);h.__decorate([l.property({type:q})],f.prototype,"fullTimeExtent",void 0);h.__decorate([l.property({nonNullable:!0})],
f.prototype,"loop",void 0);h.__decorate([l.property({nonNullable:!0})],f.prototype,"mode",void 0);h.__decorate([l.property({nonNullable:!0,value:1E3})],f.prototype,"playRate",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"state",null);h.__decorate([l.property({cast:e=>{if(null==e)return null;x(e)&&(e.interval=E.ensureType(H,e.interval));if(x(e)||z(e))e.timeExtent=E.ensureType(q,e.timeExtent);return e}})],f.prototype,"stops",void 0);h.__decorate([l.property({type:q})],f.prototype,"timeExtent",
void 0);h.__decorate([l.property({readOnly:!0})],f.prototype,"timeExtentValues",null);h.__decorate([l.property()],f.prototype,"view",void 0);h.__decorate([l.property()],f.prototype,"next",null);h.__decorate([l.property()],f.prototype,"play",null);h.__decorate([l.property()],f.prototype,"previous",null);h.__decorate([l.property()],f.prototype,"stop",null);h.__decorate([l.property()],f.prototype,"updateWebDocument",null);return f=h.__decorate([L.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],
f)});
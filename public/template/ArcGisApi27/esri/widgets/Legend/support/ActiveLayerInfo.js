// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../intl ../../../kernel ../../../request ../../../symbols ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/jsonMap ../../../core/Logger ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/screenUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/PropertyOrigin ../../../layers/effects/EffectView ../../../layers/effects/jsonUtils ../../../layers/support/ExportImageParameters ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../layers/support/rasterFormats/pixelRangeUtils ../../../renderers/support/jsonUtils ../../../renderers/support/rendererConversion ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/previewUtils ../../../symbols/support/renderUtils ../../../symbols/support/symbolUtils ../../../symbols/support/utils ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils ../../smartMapping/support/utils ../../../symbols/SimpleMarkerSymbol ../../../symbols/SimpleFillSymbol ../../../intl/messages ../../../intl/substitute".split(" "),
function(ya,ka,w,la,v,za,ma,gb,Aa,U,Ba,Ca,B,E,y,Da,Ea,x,hb,ib,Fa,N,Ga,Ha,Ia,Ja,Ka,na,La,Ma,Na,Oa,Pa,Qa,C,Ra,Sa,O,Ta,oa,aa,F,Ua,P,pa,Va,Wa){function H(t){return"esri.renderers.SimpleRenderer"===t.declaredClass}function I(t){return"esri.renderers.ClassBreaksRenderer"===t.declaredClass}function V(t){return"esri.renderers.UniqueValueRenderer"===t.declaredClass}function qa(t){return"esri.renderers.HeatmapRenderer"===t.declaredClass}function ba(t){return"esri.renderers.PointCloudClassBreaksRenderer"===
t.declaredClass}function ca(t){return"esri.renderers.PointCloudStretchRenderer"===t.declaredClass}function da(t){return"esri.renderers.PointCloudUniqueValueRenderer"===t.declaredClass}function ra(t){return"esri.renderers.DotDensityRenderer"===t.declaredClass}function sa(t){return"esri.renderers.PieChartRenderer"===t.declaredClass}function ea(t){return"esri.layers.SubtypeGroupLayer"===t.declaredClass}function fa(t){return"esri.layers.MapImageLayer"===t.declaredClass}function Xa(t){t="authoringInfo"in
t?t?.authoringInfo:null;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}async function D(t,G){const k=await Va.fetchMessageBundle("esri/widgets/Legend/t9n/Legend");"previewTemplateAriaLabel"!==t||G||(t="previewAriaLabel");return Wa.substitute(k[t],{label:G})}const W=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Ya=new Ca.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),
X=new P({size:6,outline:{color:[128,128,128,.5],width:.5}}),Za=new pa({style:"solid"}),$a=new P({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let J={};v=function(t){function G(a){a=t.call(this,a)||this;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=new Ba;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=
null;a.hideLayersNotInCurrentView=!1;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}ka._inherits(G,t);var k=G.prototype;k.initialize=function(){const a=()=>this.notifyChange("ready");this.addHandles([y.on(()=>this.children,"change",b=>{const {added:c,removed:d}=b;c.forEach(e=>{const f=`activeLayerInfo-ready-watcher-${e.layer.uid}`;this.addHandles(y.watch(()=>e.ready,a,y.initial),f)});d.forEach(e=>this.removeHandles(e.layer.uid));a()})]);this.keepCacheOnDestroy||
(J={})};k.destroy=function(){this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=null;this.keepCacheOnDestroy||(J=null)};k.buildLegendElementsForFeatureCollections=async function(a){if(this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())this.legendElements=[],this.notifyChange("ready");else{a=Array.from(a,b=>{if(Ka.isFeatureLayer(b))return this._getRendererLegendElements(b.renderer,{title:b.title});if(b.featureSet&&b.featureSet.features.length){var c=
b.layerDefinition,d=c&&c.drawingInfo;d=d&&La.fromJSON(d.renderer);c=Ya.read(c.geometryType);return d?this._getRendererLegendElements(d,{title:b.name,geometryType:c}):(B.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const b=[];await E.eachAlways(a).then(c=>{c.forEach(({value:d})=>d&&b.push(...d))});this.legendElements=b;this.notifyChange("ready")}catch(b){B.getLogger(this).warn("error while building legend for layer!",b)}}};k.buildLegendElementsForRenderer=async function(a){try{this.legendElements=
(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getRendererLegendElements(a):[],this.notifyChange("ready")}catch(b){B.getLogger(this).warn("error while building legend for layer!",b)}};k.buildLegendElementsForFeatureReduction=async function(a){try{this.legendElements=(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getLegendElementsForFeatureReduction(a):[],this.notifyChange("ready")}catch(b){B.getLogger(this).warn("error while building legend for layer!",
b)}};k.buildLegendElementsForTools=async function(){const a=this.layer;if("esri.layers.VoxelLayer"===a.declaredClass)this._constructLegendElementsForVoxellayer();else if("esri.layers.WMTSLayer"===a.declaredClass)this._constructLegendElementsForWMTSlayer();else if("esri.layers.WMSLayer"===a.declaredClass)await this._constructLegendElementsForWMSSublayers();else if("esri.layers.BuildingSceneLayer"===a.declaredClass)await this._constructLegendElementsForBuildingSceneLayer();else if(fa(a)||"esri.layers.TileLayer"===
a.declaredClass||ea(a))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");var b="default";if("esri.layers.ImageryLayer"===a.declaredClass){b=a?.rasterFunction?.functionName||"default";const c=a.bandIds?.length?a.bandIds.join(""):"###";b=b+"_"+c}await this._getLegendLayers(`${a.uid}-${b}`).then(async c=>{this.legendElements=[];this.notifyChange("ready");c=c.map(async d=>{if("esri.layers.ImageryLayer"===a.declaredClass||"esri.layers.ImageryTileLayer"===
a.declaredClass){const e=y.watch(()=>["renderingRule"in a&&a.rasterFunction,a.bandIds],()=>E.debounce(async()=>{J["default"]=null;a.renderer?await this.buildLegendElementsForRenderer(a.renderer):await this.buildLegendElementsForTools()})());this.addHandles(e,"imageryLayers-watcher")}(d=this._generateSymbolTableElementForLegendLayer(d))&&d.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(d.title=a.title),this.legendElements.push(d));this.notifyChange("ready")});await E.eachAlways(c)}).catch(c=>
{B.getLogger(this).warn("Request to server for legend has failed!",c)})}};k._isLayerInCurrentView=async function(){const a=this.layer,b=this.layerView,c=b&&"createQuery"in b&&"queryFeatureCount"in b;if(!(c||b&&"createQuery"in a&&"queryFeatureCount"in a))return!0;await y.whenOnce(()=>!b.updating);const d=c?"createQuery"in b&&b.createQuery():"createQuery"in a&&a.createQuery();if(!d)return!0;d.geometry=this.view.extent;return 0!==(c?"queryFeatureCount"in b&&await b.queryFeatureCount(d):"queryFeatureCount"in
a&&await a.queryFeatureCount(d))};k._getParentLayerOpacity=function(a){let b=1;const c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));return a.opacity*b};k._isGroupActive=function(){const a=this.children;return a.length?a.some(b=>b.ready):!1};k._isRendererScaleDriven=function(a){return"dot-density"===a.type||W.test("valueExpression"in a?a.valueExpression:null)?!0:(a="visualVariables"in a?a.visualVariables:null)?a.some(b=>this._isScaleDrivenSizeVariable(b)):!1};k._isScaleDrivenSizeVariable=
function(a){if(a&&"size"!==a.type)return!1;const b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!a.expression||W.test(a.valueExpression)};k._isLayerScaleDriven=function(a){if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&a.sublayers)return a.sublayers.some(c=>this._isLayerScaleDriven(c));const b=a.parent;if(!1===a.loaded&&b&&fa(b)&&"source"in a&&a.source&&"map-layer"===
a.source.type)for(const c of b.sourceJSON.layers??[])if(c.id===a.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1};k._constructLegendElementsForVoxellayer=async function(){this.legendElements=[];this.removeHandles("voxel-style-watcher");this.removeHandles("voxel-current-variable");const a=this.layer;this.addHandles(y.watch(()=>a.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-current-variable");this.addHandles(y.watch(()=>a.getVariableStyles(),()=>this._constructLegendElementsForVoxellayer()),
"voxel-style-watcher");var b=a.getVariableStyle(null);const c=[];if(b)if(b.uniqueValues?.length){const e=[];b.uniqueValues.forEach(f=>{f.enabled&&e.push({label:f.label||`${f.value}`,value:f.value,symbol:new pa({color:f.color,outline:null})})});e.length&&c.push({type:"symbol-table",title:b.label,infos:e})}else if(b.transferFunction){const {colorStops:e,stretchRange:f}=b.transferFunction,g=e.toArray().reverse(),h=f.map((m,l)=>`${0===l?F.SPECIAL_CHARS_LESS_THAN:F.SPECIAL_CHARS_GREATER_THAN} ${Ua.formatNumberLabel(m)}`).reverse(),
q=g.map(m=>({color:m.color,value:null,label:null}));q[0].label=h[0];q[q.length-1].label=h[1];c.push({type:"color-ramp",title:b.label,infos:q,preview:C.renderColorRampPreviewHTML(g.map(m=>m.color),{ariaLabel:await D("previewColorRampAriaLabel")})})}const d=a.opacity;b=c.reduce((e,f)=>[...e,...this._getAllInfos(f)],[]).filter(e=>!!e?.symbol).map(e=>this._getSymbolPreview(e,d));await E.eachAlways(b);this.legendElements=c;this.notifyChange("ready")};k._constructLegendElementsForWMTSlayer=function(){this.legendElements=
[];this.removeHandles("wmts-activeLayer-watcher");const a=this.layer.activeLayer;this.addHandles(y.watch(()=>{const {layer:b}=this;return b&&"activeLayer"in b&&b.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");if(a.styleId&&a.styles){let b=null;a.styles.some(c=>a.styleId===c.id?(b=c.legendUrl,!0):!1);b&&(this.legendElements=[{type:"symbol-table",title:a.title,infos:[{src:b,opacity:this.opacity}]}])}this.notifyChange("ready")};k._constructLegendElementsForWMSSublayers=
async function(){this.legendElements=[];this.removeHandles("wms-sublayers-watcher");const a=this.layer;let b=null;if(a.customParameters||a.customLayerParameters)b={...a.customParameters,...a.customLayerParameters};this.addHandles(y.watch(()=>{const {layer:c}=this;return c&&"sublayers"in c&&c.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");this.legendElements=await this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};k._generateLegendElementsForWMSSublayers=
async function(a,b){const c=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");a=a.toArray();for(const d of a)a=y.watch(()=>[d.title,d.visible,d.legendEnabled],()=>this._constructLegendElementsForWMSSublayers()),this.addHandles(a,"wms-sublayers-watcher"),(!this.respectLayerVisibility||d.visible&&d.legendEnabled)&&(a=await this._generateSymbolTableElementForWMSSublayer(d,b))&&a.infos.length&&c.unshift(a);return c};k._generateSymbolTableElementForWMSSublayer=
async function(a,b){return!a.legendUrl&&a.sublayers?(b=(await this._generateLegendElementsForWMSSublayers(a.sublayers,b)).filter(c=>c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)};k._generateSymbolTableElementForLegendUrl=async function(a,b){let c=a.legendUrl;if(c){var d={type:"symbol-table",title:a.title||a.name||String(a.id??""),infos:[]};b&&(c=Ea.addQueryParameters(c,b));b=null;a=a.layer?.opacity;try{if(b=(await ma(c,{responseType:"image"})).data)b.style.opacity=
a}catch{}d.infos.push({src:c,preview:b,opacity:a});return d}};k._getLegendLayers=function(a,b){const c=J&&J[a];return c?Promise.resolve(c):this._legendRequest(b).then(d=>{d=d.layers;return J[a]=d})};k._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=b.exportImageServiceParameters.rasterFunction;c&&(a.renderingRule=JSON.stringify(c.functionDefinition?.toJSON()||c.toJSON()));b.bandIds&&(a.bandIds=b.bandIds.join());if(b.raster||
b.viewId||b.customParameters){const {raster:d,viewId:e,customParameters:f}=b;a={raster:d,viewId:e,...a,...f}}}c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=+b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue");return ma(c,{query:a}).then(d=>d.data)};k._constructLegendElementsForBuildingSceneLayer=
async function(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;this.addHandles(y.watch(()=>a.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){B.getLogger(this).warn("Request to server for legend has failed!",b)}};k._generateLegendElementsForBuildingSublayers=async function(a,b){let c=
[];this.addHandles(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");a=a.toArray();for(const e of a)if(a=y.watch(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer()),this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){a=e&&null!=e.opacity?e.opacity:null;var d=null!=a?a*b:b;"building-group"===e.type?(a={type:"symbol-table",title:e.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(e.sublayers,
d),a.infos.push(...d),c=[a,...c]):e.renderer&&(c=[...(await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:d,sublayer:e})),...c])}return c.filter(e=>!!e&&("infos"in e&&e.infos?0<e.infos.length:!0))};k._constructLegendElementsForSublayers=async function(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;if(fa(a)||"esri.layers.TileLayer"===a.declaredClass||ea(a)){this.addHandles(y.watch(()=>a.sublayers,()=>this._constructLegendElementsForSublayers),
"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){B.getLogger(this).warn("Request to server for legend has failed!",b)}}};k._generateLegendElementsForSublayers=async function(a,b,c){const d=this.layer;let e=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");a=a.toArray();!c&&this.sublayerIds&&this.sublayerIds.length&&(a=ea(d)?this.sublayerIds.map(f=>
d.findSublayerForSubtypeCode(f)).filter(U.isSome):this.sublayerIds.map(f=>d.findSublayerById(f)).filter(U.isSome));for(const f of a)if(a=y.watch(()=>[f.renderer,f.opacity,f.title,f.visible,f.legendEnabled],()=>this._constructLegendElementsForSublayers()),this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||f.visible&&f.legendEnabled&&this._isSublayerInScale(f)){a=f&&null!=f.opacity?f.opacity:null;a=null!=a?a*b:b;const g="sublayers"in f?f.originIdOf("renderer")>N.OriginId.SERVICE&&
!f.sublayers:!0;f.renderer&&g?(await f.load(),e=[...(await this._getRendererLegendElements(f.renderer,{title:f.title,opacity:a,sublayer:f})),...e]):"sublayers"in f&&(a=await this._generateSymbolTableElementForSublayer(f,a,c))&&e.unshift(a)}return e.filter(f=>!!f&&("infos"in f&&f.infos?0<f.infos.length:!0))};k._generateSymbolTableElementForSublayer=async function(a,b,c){if(!c){c=new Map;var d=this.layer,e=a.source;let f=null;if(e&&("map-layer"!==e.type||e.mapLayerId!==a.id||e.gdbVersion&&e.gdbVersion!==
("gdbVersion"in d&&d.gdbVersion))||a.originIdOf("renderer")>N.OriginId.SERVICE||a.originIdOf("labelingInfo")>N.OriginId.SERVICE||a.originIdOf("labelsVisible")>N.OriginId.SERVICE)e=new Ia.ExportImageParameters({layer:this.layer}),f=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy();(await this._getLegendLayers(f||`${d.uid}-default`,f)).forEach(g=>c.set(g.layerId,g))}d=c.get(a.id);return(!d||d?.subLayerIds&&d.defaultVisibility)&&a.sublayers?(b=await this._generateLegendElementsForSublayers(a.sublayers,
b,c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,b)};k._generateSymbolTableElementForLegendLayer=function(a,b,c){if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var d=b?.renderer;let e=b?.title||a.layerName;d&&(!b||b?.originIdOf("renderer")>N.OriginId.SERVICE)&&(d=b?.title||this._getRendererTitle(d,b))&&(e&&"string"!==typeof d&&"title"in d&&(d.title=e),e=d);const f={type:"symbol-table",title:e,legendType:a.legendType||
null,infos:[]},g=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;a.legendGroups&&0<a.legendGroups.length?a.legendGroups.forEach(h=>{const q={type:"symbol-table",title:h.heading,legendType:a.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(g.filter(m=>m.groupId===h.id),a.layerId,c)};0<q.infos?.length&&f.infos.push(q)}):f.infos=this._generateSymbolTableElementInfosForLegendLayer(g,a.layerId,c);return 0<f.infos.length?f:null};k._generateSymbolTableElementInfosForLegendLayer=
function(a,b,c){return a.map(d=>{let e=d.url;if(d.imageData&&0<d.imageData.length)e=`data:image/png;base64,${d.imageData}`;else if(0!==e.indexOf("http"))e=za.addTokenParameter(`${this.layer.url}/${b}/images/${e}`);else return null;return{label:d.label,src:e,opacity:null==c?this.opacity:c,width:d.width,height:d.height}}).filter(U.isSome)};k._isSublayerInScale=function(a){const b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0};k._isLegendLayerInScale=function(a,b){b=b||this.layer;
let c=null,d=null,e=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)e=!1;return e};k._sanitizeLegendForSublayer=function(a,b){if("version"in this.layer&&10.1>+this.layer.version||0===a.length)return a;b=b.renderer;let c=0,
d=null;a.some(e=>e.values)&&a.some((e,f)=>{e.values||(c=f,d=e,d.label||(d.label="others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};k._getRendererLegendElements=async function(a,b={}){var c=this.view;c=H(a)||I(a)||V(a)||qa(a)||ra(a)||sa(a)?"2d"===c.type||Ma.isSupportedRenderer3D(a):"raster-stretch"===a.type||"raster-colormap"===a.type||"raster-shaded-relief"===
a.type||ba(a)||ca(a)||da(a)||"vector-field"===a.type||"flow"===a.type;if(!c)return B.getLogger(this).warn(`Renderer of type '${a.type}' not supported!`),[];if(ba(a)||ca(a)||da(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass)return this._constructPointCloudRendererLegendElements(a,b);if(ra(a))return this._constructDotDensityRendererLegendElements(a);a=await this._loadRenderer(a);return sa(a)?this._constructPieChartRendererLegendElements(a):this._constructRendererLegendElements(a,b)};k._getLegendElementsForFeatureReduction=
async function(a){let b=null;"binning"===a.type?b=a.renderer:"cluster"===a.type&&(b=this._getClusterRenderer(a));return b?this._getRendererLegendElements(b):[]};k._getPointCloudRendererTitle=function(a){return(a.legendOptions?.title||a.field)??""};k._constructPointCloudRendererLegendElements=async function(a,b={}){b=b.title;const c=[];let d=null;var e=null;if(ba(a))d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(f=>{d.infos.unshift({label:f.label||
f.minValue+" - "+f.maxValue,value:[f.minValue,f.maxValue],symbol:this._getAppliedCloneSymbol(X,f.color)})});else if(ca(a)){e=a.stops;let f=null;if(e?.length&&(1===e.length&&(f=e[0].color),!f)){const g=e[0].value,h=e[e.length-1].value;null!=g&&null!=h&&(f=O.getColorFromPointCloudStops(g+(h-g)/2,e))}d={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(X,f||X.color)}]};e=O.getRampStopsForPointCloud(a.stops??[])??[];e={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),
infos:e,preview:C.renderColorRampPreviewHTML(e.map(g=>g.color),{ariaLabel:await D("previewColorRampAriaLabel")})}}else da(a)&&(d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos?.forEach(f=>{d.infos.push({label:f.label||f.values.join(", "),value:f.values.join(", "),symbol:this._getAppliedCloneSymbol(X,f.color)})}));d&&d.infos.length&&c.push(d);e&&e.infos.length&&c.push(e);b=c.reduce((f,g)=>[...f,...(g.infos??[])],[]).filter(f=>!!f.symbol).map(f=>
this._getSymbolPreview(f,this.opacity,{symbolConfig:{applyColorModulation:!!a.colorModulation}}));return E.eachAlways(b).then(()=>c)};k._getElementInfoForDotDensity=async function(a,b){const {color:c,label:d,valueExpressionTitle:e}=b,{backgroundColor:f,outline:g,dotSize:h}=a;b=this.effectList?.effects.map(l=>l.toJSON());var q=Ha.effectFunctionsFromJSON(b);b=await D("previewTemplateAriaLabel",d||e);q=h+"-"+c+"-"+f+"-"+(g&&JSON.stringify(g.toJSON()))+"-"+q;const m=this._dotDensityUrlCache;a=m.has(q)?
m.get(q):C.renderDotDensityPreviewHTML(a,c,{ariaLabel:b});m.set(q,a);b=Qa.renderSymbol([[{shape:{type:"image",x:0,y:0,width:a.width,height:a.height,src:a.src},fill:null,stroke:null,offset:[0,0]}]],[a.width,a.height],{effectView:this.effectList,ariaLabel:b});return{opacity:1,src:a.src,preview:b,width:a.width,height:a.height}};k._constructDotDensityRendererLegendElements=async function(a){var b=a.calculateDotValue(this.view.scale);b={type:"symbol-table",title:{value:b&&Math.round(b),unit:a.legendOptions&&
a.legendOptions.unit||""},infos:[]};for(const c of a.attributes){const d=await this._getElementInfoForDotDensity(a,c);d.label=c.label||c.valueExpressionTitle||c.field;b.infos.push(d)}return[b]};k._constructPieChartRendererLegendElements=async function(a){const b=this.layer.opacity,c=[];let d=null;const e=a.outline;a.attributes.forEach(h=>{const q=new P({color:h.color,outline:e});c.push({label:h.label||h.valueExpressionTitle||h.field,symbol:q})});var f=c.length?[...c]:[];if(a.othersCategory?.color&&
0!==a.othersCategory?.threshold){var g=new P({color:a.othersCategory.color,outline:e});d=a.othersCategory.label||"Other";c.push({label:d,symbol:g})}a.defaultColor?.a&&(g=new P({color:a.defaultColor,outline:e}),c.push({label:a.defaultLabel,symbol:g}));g=await this._getVisualVariableLegendElements(a,this.layer)||[];c.length&&(g.unshift({type:"symbol-table",title:null,infos:c}),f=f.filter(h=>h.label!==d).map(h=>h.symbol.color).filter(Boolean),f=C.renderPieChartPreviewHTML(f,{holePercentage:a.holePercentage,
backgroundColor:a.backgroundFillSymbol?.color,effectList:this.effectList,outline:e,ariaLabel:await D("previewPieChartAriaLabel")}),g.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(a,this.layer),infos:c,preview:f}));a=g.reduce((h,q)=>[...h,...this._getAllInfos(q)],[]).filter(h=>!!h?.symbol&&!h?.preview).map(h=>this._getSymbolPreview(h,b,{effectList:this.effectList}));await E.eachAlways(a);return g};k._constructRendererLegendElements=async function(a,b={}){const {title:c,sublayer:d}=b,
e=d||this.layer;this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const f=await this._getVisualVariableLegendElements(a,e)||[],g={type:"symbol-table",title:c||this._getRendererTitle(a,e),infos:[]};let h=null,q=!1;const m=new Set;if("flow"!==a.type||this._hasSizeRamp)if("univariate-color-size"===("authoringInfo"in a?a?.authoringInfo:null)?.type){var l=c,u=Xa(a)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",r=f.findIndex(n=>"color-ramp"===
n.type);r=-1!==r?f.splice(r,1)[0]:null;var p=f.findIndex(n=>"size-ramp"===n.type);p=-1!==p?f.splice(p,1)[0]:null;var z=[];r&&(l=r.title,z.push(r));p&&(l=p.title,z.push(p));0<z.length&&f.push({type:u,title:l,infos:z})}else if(qa(a))l=Ta.getHeatmapRampStops(a),f.push({type:"heatmap-ramp",title:c||this._getRendererTitle(a,e),infos:l,preview:C.renderColorRampPreviewHTML(l.map(n=>n.color),{effectList:this.effectList,ariaLabel:await D("previewColorRampAriaLabel")})});else if(V(a)){if((u=a&&a.authoringInfo)&&
"relationship"===u.type){const {numClasses:n,field1:A,field2:K}=u;u=u.focus;if(n&&A&&K){p=[A,K];r=oa.getRotationAngleForFocus(u)||0;for(l of p){const {field:ha,normalizationField:Q,label:Y}=l;p=Y||{field:this._getFieldAlias(ha,e),normField:Q&&this._getFieldAlias(Q,e)};z=$a.clone();z.angle=r;g.infos.push({label:p,symbol:z});m.add(z);r+=90}l=oa.getRelationshipRampElement({focus:u,numClasses:n,infos:a.uniqueValueInfos??[]});f.unshift(l)}}else if("esri.layers.ImageryLayer"===this.layer.declaredClass||
"esri.layers.ImageryTileLayer"===this.layer.declaredClass)a.uniqueValueInfos?.forEach(n=>{n.symbol&&g.infos.push({label:n.label||n.value,value:n.value,symbol:n.symbol})});else{const {field:n,field2:A,field3:K,fieldDelimiter:ha,valueExpression:Q,defaultSymbol:Y}=a,ab=!(!n&&!Q||!A&&!K),L=[];a.uniqueValueGroups?.forEach(ta=>{const ia={type:"symbol-table",title:ta.heading,infos:[]};ta.classes?.forEach(M=>{const {symbol:ua,values:bb}=M;if(ua){var R=[],S=[];for(const cb of bb??[]){const {value:va,value2:wa,
value3:xa}=cb,T=[],Z=[];if(n||Q)T.push(va),Z.push(this._getDomainName(n,va,e));A&&(T.push(wa),Z.push(this._getDomainName(A,wa,e)));K&&(T.push(xa),Z.push(this._getDomainName(K,xa,e)));R.push(ab?T.join(ha||""):T[0]);S.push(Z.join(" - "))}R=R.join(", ");M=M.label;M||(S=S.filter(Boolean),M=S.length?S.join(", "):R);ia.infos.push({label:M,value:R,symbol:ua})}});ia.infos.length&&L.push(ia)});L.length&&(l=L[0],1===L.length&&"title"in l&&!l.title?g.infos.push(...(l.infos??[])):(Y&&(L.push({type:"symbol-table",
infos:[{label:a.defaultLabel||"others",symbol:Y}]}),q=!0),g.infos.push(...L)),c||a.legendOptions&&a.legendOptions.title||a.valueExpressionTitle||(g.title=null))}a.defaultSymbol&&!q&&(g.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),q=!0)}else if(I(a))h=this._isUnclassedRenderer(a),h&&this._hasSizeRamp||(a.classBreakInfos.forEach(n=>{n.symbol&&g.infos.unshift({label:n.label||(h?null:n.minValue+" - "+n.maxValue),value:[n.minValue,n.maxValue],symbol:n.symbol})}),h&&(g.title=null),
this._updateInfosforClassedSizeRenderer(a,g.infos)),a.defaultSymbol&&!h&&(g.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),q=!0);else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)l=await this._constructTileImageryStretchRendererElements(a),"stretch-ramp"===l.type?f.push(l):g.infos=l;else{l=this.layer;a.statistics?.length&&(r=a.statistics[0],F.isRasterBandStatistics(r)?(u=r.min,r=r.max):
[u,r]=r);p=[];p=l.serviceRasterInfo;if(l.rasterFunction)try{p=await l.generateRasterInfo(l.rasterFunction)}catch{}const n=p.keyProperties.BandProperties;z=na.getPixelValueRange(p.pixelType);1===p.bandCount?(l=l.bandIds?.[0]||0,u=null!=u?u:p.statistics?p.statistics[l].min:z[0],r=null!=r?r:p.statistics?p.statistics[l].max:z[1],u||r?f.push(await this._getStretchLegendElements(a,{min:u,max:r})):this._getServerSideLegend()):l.bandIds&&1===l.bandIds.length?(u=null!=u?u:p.statistics?p.statistics[l.bandIds[0]].min:
z[0],r=null!=r?r:p.statistics?p.statistics[l.bandIds[0]].max:z[1],u||r?f.push(await this._getStretchLegendElements(a,{min:u,max:r})):this._getServerSideLegend()):3<=p.bandCount?n&&n.length>=p.bandCount?l.bandIds&&3===l.bandIds.length?(p=l.bandIds.map(A=>n[A].BandName),g.infos=this._createSymbolTableElementMultiBand(p)):"lerc"===l.format?(p=[0,1,2].map(A=>n[A].BandName),g.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():"lerc"===l.format?(p=["band1","band2","band3"],g.infos=
this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():this._getServerSideLegend()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(n=>{g.infos.push({label:n.label,value:n.value,symbol:this._getAppliedCloneSymbol(Za,n.color)})});else if(H(a)){l=a.symbol;switch(b.geometryType){case "point":l="pointSymbol"in e?e.pointSymbol:null;break;case "polyline":l="lineSymbol"in e?e.lineSymbol:null;break;case "polygon":l="polygonSymbol"in e?e.polygonSymbol:null}u=this._hasClusterSizeVariable&&
this._getClusterSymbol()||!this._hasSizeRamp;a.symbol&&u&&g.infos.push({label:a.label,symbol:l})}else"vector-field"===a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+")"),g.title=a.attributeField,l=a.getClassBreakInfos(),l?.length?l.forEach(n=>{g.infos.push({label:n.minValue+" - "+n.maxValue,symbol:n.symbol})}):g.infos.push({label:a.attributeField,symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&f.push(await this._getStretchLegendElements(a,{min:0,max:255}));else l=await F.getSymbolForFlowRenderer(a),
g.infos.push({label:null,symbol:l});const ja=a.defaultSymbol;!ja||q||H(a)||h&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||f.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:ja}]});g.infos.length&&f.unshift(g);const db=null==b.opacity?this.opacity:b.opacity,eb=this._isTallSymbol("visualVariables"in a?a.visualVariables:null),fb="esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass;b=f.reduce((n,A)=>
[...n,...this._getAllInfos(A)],[]).filter(n=>!!n?.symbol).map(n=>this._getSymbolPreview(n,db,{isDefault:n.symbol===ja,applyScaleDrivenSize:!m.has(n.symbol),symbolConfig:{isTall:eb,isSquareFill:fb},effectList:m.has(n.symbol)?null:this.effectList}));a=null;await E.eachAlways(b);return f};k._getServerSideLegend=function(){setTimeout(()=>this.buildLegendElementsForTools(),0)};k._getAllInfos=function(a){const b=a?.infos;return b?b.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[a]};k._constructTileImageryStretchRendererElements=
async function(a){function b(q){const m=(c?.bandIds?.length?c.bandIds:Array.from(Array(Math.min(d.bandCount,3)).keys())).map(l=>q&&q[l]&&q[l].BandName||"band"+(l+1));3>m.length?m.push(m[1]):3<m.length&&m.splice(3);return m}const c=this.layer,{rasterInfo:d}=c.raster,e=d.bandCount||a.statistics.length;var f,g=[];g=d.keyProperties&&d.keyProperties.BandProperties;if(f=a?.statistics?.length?a.statistics:d?.statistics){var h=f[0];F.isRasterBandStatistics(h)?(f=h.min,h=h.max):[f,h]=h}else h=na.getPixelValueRange(d.pixelType),
f=h[0],h=h[1];c.hasStandardTime()&&(f=c.getStandardTimeValue(f),h=c.getStandardTimeValue(h));if(1===d.bandCount||1===c.bandIds?.length)return this._getStretchLegendElements(a,{min:f,max:h});g=g&&g.length>=e?b(g):b();return this._createSymbolTableElementMultiBand(g)};k._getStretchLegendElements=async function(a,b){a=O.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:C.renderColorRampPreviewHTML(a.map(c=>c.color),{ariaLabel:await D("previewColorRampAriaLabel")})}};
k._getClusterSymbol=function(){var a=this.layer;const b=(a="featureReduction"in a&&a.featureReduction)&&"symbol"in a&&a.renderer;return b&&!0!==b?.authoringInfo?.isAutoGenerated?null:a&&"symbol"in a?a.symbol:null};k._getSizeLegendElement=async function(a,b,c,d){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(b):a,infos:await aa.getRampStops(c,b,await F.getMedianColor(c),this.scale,this.view.type,!!d,this._hasClusterSizeVariable?this._getClusterSymbol():null)}};k._createSymbolTableElementMultiBand=
function(a){const b=[],c=["red","green","blue"];a.forEach((d,e)=>{b.push({label:{colorName:c[e],bandName:d},src:F.RGB_IMG_SOURCE[e],opacity:this.opacity??1})});return b};k._updateInfosforClassedSizeRenderer=function(a,b){const c=a.authoringInfo&&"class-breaks-size"===a.authoringInfo.type,d=a.classBreakInfos.some(e=>Ra.isVolumetricSymbol(e.symbol));if(c&&d){const e=aa.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;const f=(e-aa.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach((g,h)=>{g.size=e-f*h})}};k._isTallSymbol=
function(a){let b=!1,c=!1;if(a)for(let d=0;d<a.length&&(!b||!c);d++){const e=a[d];"size"===e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c};k._getSymbolPreview=async function(a,b,c){var d=!c?.isDefault&&null==a.size&&this._hasSizeRamp?Da.px2pt(Pa.SymbolSizeDefaults.size):a.size;this._scaleDrivenSizeVariable&&c?.applyScaleDrivenSize&&({getSize:d}=await new Promise((e,f)=>ya(["../../../renderers/visualVariables/support/visualVariableUtils"],e,f)),d=d(this._scaleDrivenSizeVariable,
null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}));return C.renderPreviewHTML(a.symbol,{size:d,opacity:b,scale:!1,symbolConfig:c?.symbolConfig,effectView:c?.effectList,ariaLabel:a.label&&"string"!==typeof a.label?null:await D("previewTemplateAriaLabel",a.label)}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})};k._getClusterRenderer=function(a){this._hasClusterSizeVariable=!1;var b="renderer"in this.layer?this.layer.renderer:
null;b=a.renderer?.clone()||b?.clone();const c=Sa.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view);if(c&&null!=b&&"visualVariables"in b&&!b.visualVariables?.some(d=>"size"===d.type&&"outline"!==d.target&&!W.test(d.valueExpression))){if("clusterMinSize"in a&&"clusterMaxSize"in a){const {clusterMinSize:d,clusterMaxSize:e}=a;c.legendOptions=new Na({showLegend:d!==e})}b.visualVariables=(b.visualVariables||[]).concat([c]);this._hasClusterSizeVariable=!0}return b};k._loadRenderer=async function(a){const b=
[],c=a.clone(),d=await F.getMedianColor(c);if(I(c)||V(c))a=(c.classBreakInfos||c.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,d).then(f=>{e.symbol=f}).catch(()=>{e.symbol=null})),Array.prototype.push.apply(b,a);b.push(this._fetchSymbol(c.symbol||c.defaultSymbol,c.defaultSymbol?null:d).then(e=>{this._applySymbolToRenderer(c,e,H(c))}).catch(()=>{this._applySymbolToRenderer(c,null,H(c))}));return E.eachAlways(b).then(()=>c)};k._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=
b};k._fetchSymbol=async function(a,b){if(!a)throw Error();if("web-style"===a.type){const c=this._webStyleSymbolCache;try{const d=await ("2d"===this.view.type?a.fetchCIMSymbol({cache:c}):a.fetchSymbol({cache:c}));return this._getAppliedCloneSymbol(d,b)}catch{throw B.getLogger(this).warn("Fetching web-style failed!"),Error();}}return this._getAppliedCloneSymbol(a,b)};k._getAppliedCloneSymbol=function(a,b){if(!a||!b)return a;a=a.clone();const c=b&&b.toRgba();a.type.includes("3d")?this._applyColorTo3dSymbol(a,
c):"cim"===a.type?Oa.applyCIMSymbolColor(a,b):a.color&&(a.color=new la(c||a.color));return a};k._applyColorTo3dSymbol=function(a,b){b&&a.symbolLayers.forEach(c=>{c&&(c.material||(c.material={}),c.material.color=new la(b))})};k._getVisualVariableLegendElements=async function(a,b){if(!("visualVariables"in a&&a.visualVariables)||"vector-field"===a.type)return null;var c=a.visualVariables,d=[];const e=[],f=[];for(const m of c)"color"===m.type?d.push(m):"size"===m.type?e.push(m):"opacity"===m.type&&f.push(m);
c=[...d,...e,...f];let g;if(0===d.length&&I(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var h=(h=a.classBreakInfos[0])&&h.symbol;0===d.length&&H(a)&&(h=a.symbol);h&&(h.type.includes("3d")?(d=h.symbolLayers.at(0),"water"===d.type?null!=d.color&&(g=d.color):null!=d.material&&null!=d.material.color&&(g=d.material.color)):h.url||(g=h.color));const q=this.effectList;return(await Promise.all(c.map(async m=>{if(!m.legendOptions||!1!==m.legendOptions.showLegend){const u="flow"===a.type?m.field:this._getRampTitle(m,
b);let r=null;var l="getField"in b?b.getField?.(m.field):null;l=l&&Ja.isDateField(l);"color"===m.type?(m=await O.getRampStops(m,null,l)??[],r={type:"color-ramp",title:u,infos:m,preview:C.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:q,ariaLabel:await D("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=0<m.length)):"size"===m.type&&"outline"!==m.target?W.test(m.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=m):(r=await this._getSizeLegendElement(u,
m,a,l),this._hasSizeRamp||(this._hasSizeRamp=!(null==r.infos||!r.infos.length))):"opacity"===m.type&&(m=await O.getRampStops(m,g,l)??[],r={type:"opacity-ramp",title:u,infos:m,preview:C.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:q,ariaLabel:await D("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=0<m.length));return r&&r.infos?r:null}}))).filter(U.isSome)};k._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField&&c.getField(a))&&
"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null,"coded-value"===c?.type?c.getName(b):null):null};k._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(const c of b)if(c.fieldName===a)return"cluster_count"===a?c.label||{showCount:!0}:c.label;return{showCount:!0}};k._getRampTitle=function(a,b){let c=a.field,d=
a.normalizationField,e=!1,f=!1,g=!1;var h=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;h=a.legendOptions&&a.legendOptions.title;if(null==h)if(a.valueExpressionTitle)h=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,h=0;h<a.length;h++){const q=a[h];if("color"===q.type){if("ratio"===q.style){e=!0;break}if("percent"===q.style){f=
!0;break}if("percent-of-total"===q.style){g=!0;break}}}h={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:g}}return h};k._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var c=a.field;let d=null,e=null;I(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?
null:d;if(V(a)){const {field2:f,field3:g,fieldDelimiter:h}=a;c=c&&this._getFieldAlias(c,b);f&&(c=`<${c}>${h}<${this._getFieldAlias(f,b)}>`,g&&(c=`${c}${h}<${this._getFieldAlias(g,b)}>`));return c}a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a};k._getFieldAlias=function(a,b){var c=("popupTemplate"in b?b.popupTemplate:null)?.fieldInfos;let d;c&&c.some(g=>a===g.fieldName?(d=g,!0):!1);c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in
b&&b.fieldsIndex&&(c=b.fieldsIndex.get(a));let e=null;if(b="featureReduction"in b&&b.featureReduction)!d&&"popupTemplate"in b&&b.popupTemplate&&b.popupTemplate.fieldInfos&&b.popupTemplate.fieldInfos.some(g=>a?.toLowerCase()===g.fieldName?.toLowerCase()?(d=g,!0):!1),"fields"in b&&b.fields&&(e=b.fields.find(g=>g.name?.toLowerCase()===a?.toLowerCase()));b=d||c||e;let f=null;b&&(f=d?.label||c?.alias||e?.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName||null);return f};k._isUnclassedRenderer=function(a){const b=
a.visualVariables;let c=!1;I(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(d=>!(!d||a.field!==d.field||(a.normalizationField||d.normalizationField)&&a.normalizationField!==d.normalizationField)):!!b.length);return c};ka._createClass(G,[{key:"effectList",get:function(){const a=this.layer;let b=null;"effect"in a&&a.effect&&(b=new Ga.EffectView,b.effect=a.effect,b.endTransitions(),b.scale=this.scale);return b}},{key:"opacity",get:function(){const a=this.layer.opacity,b=this.parent?.opacity;
var c=this.layer.parent;c=c&&"uid"in c?this._getParentLayerOpacity(c):null;return null!=b?b*a:null!=c?c*a:a}},{key:"ready",get:function(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length}},{key:"scale",get:function(){return this.view?.scale??0}},{key:"isScaleDriven",get:function(){const a=this.layer;if(null===a)return!1;if("effect"in a&&a.effect&&Array.isArray(a.effect))return!0;if("featureReduction"in a&&a.featureReduction){if("cluster"===a.featureReduction.type)return!0;
if("binning"===a.featureReduction.type&&"renderer"in a.featureReduction&&a.featureReduction.renderer)return this._isRendererScaleDriven(a.featureReduction.renderer)}return"renderer"in a&&a.renderer?this._isRendererScaleDriven(a.renderer):this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]);return G}(Aa);w.__decorate([x.property()],v.prototype,"children",void 0);w.__decorate([x.property({readOnly:!0})],v.prototype,"effectList",null);w.__decorate([x.property()],
v.prototype,"layerView",void 0);w.__decorate([x.property()],v.prototype,"layer",void 0);w.__decorate([x.property()],v.prototype,"legendElements",void 0);w.__decorate([x.property({readOnly:!0})],v.prototype,"opacity",null);w.__decorate([x.property()],v.prototype,"parent",void 0);w.__decorate([x.property({readOnly:!0,dependsOn:[]})],v.prototype,"ready",null);w.__decorate([x.property()],v.prototype,"hideLayersNotInCurrentView",void 0);w.__decorate([x.property()],v.prototype,"keepCacheOnDestroy",void 0);
w.__decorate([x.property()],v.prototype,"respectLayerVisibility",void 0);w.__decorate([x.property({readOnly:!0})],v.prototype,"scale",null);w.__decorate([x.property()],v.prototype,"sublayerIds",void 0);w.__decorate([x.property({readOnly:!0})],v.prototype,"isScaleDriven",null);w.__decorate([x.property()],v.prototype,"title",void 0);w.__decorate([x.property({readOnly:!0,dependsOn:["ready"],value:0})],v.prototype,"version",null);w.__decorate([x.property()],v.prototype,"view",void 0);return v=w.__decorate([Fa.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],
v)});
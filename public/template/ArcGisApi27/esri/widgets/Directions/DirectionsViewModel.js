// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../intl/locale ../../rest/networkService ../../rest/support/RouteParameters ../../rest/support/Stop ../../rest/support/TravelMode ../support/GoTo".split(" "),
function(x,d,A,p,c,B,y,u,e,I,J,K,C,D,E,z,w,F,G){var h;(function(k){k[k.Active=0]="Active";k[k.Complete=1]="Complete";k[k.Failed=2]="Failed";k[k.Idle=3]="Idle";k[k.Suspended=4]="Suspended"})(h||(h={}));c=function(k){function v(a){a=k.call(this,a)||this;a._highlight=null;a._loadPromise=null;a._loadController=null;a._routeController=null;a._serviceDescriptionStatus=h.Idle;a.apiKey=void 0;a.defaultTravelMode=null;a.departureTime="now";a.lastError=null;a.lastRoute=null;a.layer=null;a.maxStops=50;a.routeParameters=
new z({directionsLengthUnits:"kilometers",findBestSequence:!1,returnZ:!0,startTime:null,startTimeIsUTC:!0,useTimeWindows:!1});a.serviceDescription=null;a.view=null;return a}x._inherits(v,k);var g=v.prototype;g.initialize=function(){this.addHandles([u.on(()=>this.layer?.stops,"change",()=>{this.clearResults()}),u.watch(()=>this.layer,a=>{if(null!=a){for(;2>a.stops.length;)a.stops.add(new w);this._set("defaultTravelMode",null);this.addHandles(u.when(()=>null!=this.serviceDescription?a.routeInfo?.analysisSettings?.travelMode:
null,f=>{this.defaultTravelMode=this._resolveDefaultTravelMode(f)},{once:!0}))}},u.syncAndInitial)])};g.load=async function(){if(null!=this._loadPromise)return this._loadPromise;this._loadPromise=this._load();await this._loadPromise;this._loadPromise=null};g.highlight=async function(a){this.clearHighlights();this.view&&this.layer&&(this._highlight=(await this.view.whenLayerView(this.layer)).highlight(a))};g.clearHighlights=function(){null!=this._highlight&&(this._highlight.remove(),this._highlight=
null)};g.centerAt=function(a){null!=this.view&&(a="esri.rest.support.Stop"===a?.declaredClass||"esri.Graphic"===a?.declaredClass?a.geometry:a,null!=a&&this.callGoTo({target:a}))};g.clearResults=function(){this._set("lastRoute",null);this.layer?.removeResult()};g.getDirections=async function(){const {apiKey:a,departureTime:f,layer:b,state:m}=this;if(null==b)throw new p("directions-view-model:missing-route-layer","A route layer must be associated with the view model.");if("unauthenticated"===m||"initializing"===
m||"disabled"===m||this._serviceDescriptionStatus===h.Failed)throw new p("directions-view-model:not-loaded","Cannot get directions until view model loads.");this._set("lastError",null);null!=this._routeController&&(this._routeController.abort(),this._routeController=null);var n="now"===f,l="now"===f?new Date:f;if(l&&!n){var r=6E4*l.getTimezoneOffset();l.setTime(l.getTime()-r)}const H=null!=this.view?this.view.spatialReference:null;r=this.routeParameters.clone();r.set({startTime:l,startTimeIsUTC:n,
directionsLanguage:this._directionsLanguage,apiKey:a,outSpatialReference:H});null!=this.selectedTravelMode&&(r.travelMode=this.selectedTravelMode);if(2>b.stops.filter(({geometry:q})=>null!=q).length){var t=new p("directions-view-model:not-enough-stops","Not enough stops for routing");this._set("lastError",t);throw t;}this._routeController=new AbortController;({signal:n}=this._routeController);l=null;try{l=await b.solve(r,{signal:n})}catch(q){if(!y.isAbortError(q))throw t=new p("directions-view-model:unable-to-route",
"Unable to route to these addresses",{error:q}),this._set("lastError",t),this._set("lastRoute",null),t;}finally{this._routeController=null}for(const q of l.stops)null==q.geometry&&(q.name=null);b.update(l);this._set("lastRoute",l);this.zoomToRoute();return l};g.getCostAttribute=function(a){return(this.serviceDescription?.networkDataset?.networkAttributes??[]).find(({name:f,usageType:b})=>f===a&&"cost"===b)??null};g.reset=function(){this.clearHighlights();this.clearResults();null!=this.layer&&(this.layer.removeAll(),
this.layer.stops=new A([new w,new w]))};g.save=function(){if(!this.layer)throw new p("directions-view-model:missing-layer","save() requires a layer");return this.layer.save()};g.saveAs=function(a,f={}){if(!this.layer)throw new p("directions-view-model:missing-layer","saveAs() requires a layer");return this.layer.saveAs(a,f)};g.zoomToRoute=function(){const {view:a,layer:f}=this;if(null!=a&&null!=f?.routeInfo){var {geometry:b}=f.routeInfo;if(null!=b&&(b=b.extent)){var m=b.width>b.height;b=b.clone().expand(m?
2:1);this.callGoTo({target:b})}}};g._load=async function(){if(null==this.serviceDescription&&null!=this.layer){null!=this._loadController&&(this._loadController.abort(),this._loadController=null);this._loadController=new AbortController;var {signal:a}=this._loadController;try{this._serviceDescriptionStatus=h.Active;const b=await E.fetchServiceDescription(this.layer.url,this.apiKey,{signal:a});this._set("serviceDescription",b);this._serviceDescriptionStatus=h.Complete}catch(b){if(y.isAbortError(b))this._serviceDescriptionStatus=
h.Idle;else if("identity-manager:user-aborted"===b.name)this._serviceDescriptionStatus=h.Suspended;else{var f=new p("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:b});this._serviceDescriptionStatus=h.Failed;this._set("lastError",f);throw f;}}finally{this._loadController=null}}};g._resolveDefaultTravelMode=function(a){if(null==this.serviceDescription)return null;const {defaultTravelMode:f,supportedTravelModes:b}=this.serviceDescription,m=/^<(?<name>.*)>$/i.exec(a.name)?.groups?.name;
if(m){const n=b?.find(({name:l})=>l.toLocaleLowerCase()===m.trim().toLocaleLowerCase());return F.fromJSON({...(n??f)?.toJSON(),...a.toJSON()})}return b?.find(({name:n})=>n.toLocaleLowerCase()===a.name.toLocaleLowerCase())??f};x._createClass(v,[{key:"_directionsLanguage",get:function(){if(null!=this.serviceDescription){var a=this.serviceDescription.directionsSupportedLanguages;if(a){var f=(this.routeParameters.directionsLanguage??D.getLocale()).slice(0,2);return a.find(b=>b.toLowerCase().slice(0,2)===
f)}}}},{key:"impedanceAttribute",get:function(){return this.getCostAttribute(this.routeParameters.travelMode?.impedanceAttributeName??this.routeParameters.impedanceAttribute??this.serviceDescription?.impedance??null)}},{key:"selectedTravelMode",get:function(){return null==this.serviceDescription?null:this.defaultTravelMode??this.serviceDescription.defaultTravelMode??this.serviceDescription.supportedTravelModes?.[0]??null},set:function(a){this._override("selectedTravelMode",a)}},{key:"state",get:function(){if(null!=
this._routeController)return"routing";if(null!=this.lastError)return"error";switch(this._serviceDescriptionStatus){case h.Suspended:return"unauthenticated";case h.Idle:return"disabled";case h.Active:return"initializing";case h.Failed:return"error";default:return"ready"}}},{key:"timeAttribute",get:function(){return this.getCostAttribute(this.routeParameters.travelMode?.timeAttributeName??this.routeParameters.directionsTimeAttribute??this.serviceDescription?.directionsTimeAttribute??null)}},{key:"travelModes",
get:function(){const a=this.serviceDescription?.supportedTravelModes?.slice()??[];null==this.defaultTravelMode||a.includes(this.defaultTravelMode)||a.unshift(this.defaultTravelMode);return a}}]);return v}(B.HandleOwnerMixin(G.GoToMixin(c.EventedAccessor)));d.__decorate([e.property()],c.prototype,"_directionsLanguage",null);d.__decorate([e.property()],c.prototype,"_routeController",void 0);d.__decorate([e.property()],c.prototype,"_serviceDescriptionStatus",void 0);d.__decorate([e.property()],c.prototype,
"apiKey",void 0);d.__decorate([e.property()],c.prototype,"defaultTravelMode",void 0);d.__decorate([e.property()],c.prototype,"departureTime",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"impedanceAttribute",null);d.__decorate([e.property()],c.prototype,"lastError",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"lastRoute",void 0);d.__decorate([e.property()],c.prototype,"layer",void 0);d.__decorate([e.property({type:Number,range:{min:2,max:50},nonNullable:!0})],c.prototype,
"maxStops",void 0);d.__decorate([e.property({type:z,nonNullable:!0})],c.prototype,"routeParameters",void 0);d.__decorate([e.property()],c.prototype,"selectedTravelMode",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"serviceDescription",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"state",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"timeAttribute",null);d.__decorate([e.property()],c.prototype,"travelModes",null);d.__decorate([e.property()],c.prototype,"view",
void 0);d.__decorate([e.property()],c.prototype,"getDirections",null);d.__decorate([e.property()],c.prototype,"zoomToRoute",null);return c=d.__decorate([C.subclass("esri.widgets.Directions.DirectionsViewModel")],c)});
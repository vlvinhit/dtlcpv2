// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/MapUtils ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass".split(" "),function(l,w,p,z,u,v,t,B,C,D,A){l.FormExpressionsManager=function(d){function m(b){var c=d.call(this,b)||this;c._fieldReferencesLookup=new Map;c._fieldsAffectedLookup=new Map;c._latestFieldValues=
{...b.feature.attributes};return c}w._inherits(m,d);var f=m.prototype;f.initialize=function(){this._dependencyGraph=this._buildDependencyGraph()};f.evaluateAll=function(){return this._evaluate(this.executors)};f.evaluateExpressions=function(b){return this._evaluate(b)};f.evaluateInvalidated=function(b){const {_fieldReferencesLookup:c,_latestFieldValues:h,feature:g}=this,k=new Set;for(const a of b)if(h[a]=g.getAttribute(a),c.has(a))for(const n of c.get(a))k.add(n);return this._evaluate([...k])};f.evaluateInvalidatedByGeometry=
async function(){if(this._fieldReferencesLookup.has("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY"))return this._evaluate([...this._fieldReferencesLookup.get("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY")])};f.resetExecutors=function(){for(const b of this.executors)b.reset()};f._buildDependencyGraph=function(){const {_fieldReferencesLookup:b,_fieldsAffectedLookup:c,executors:h}=this,g=new Map(this.fieldInputs.map(a=>[a.name,a])),k=new Map(h.map(a=>[a,[]]));for(const a of h){for(const n of a.fieldsUsed){u.getOrCreateMapValue(b,
n,()=>new Set).add(a);const q=g.get(n),e=q?.valueExpressionExecutor,r=q?.editableExpressionExecutor;null!=e&&e!==a&&(k.get(e).push(a),u.getOrCreateMapValue(c,e,()=>new Set).add(q));null!=r&&r!==a&&(k.get(r).push(a),u.getOrCreateMapValue(c,r,()=>new Set).add(q))}a.geometryUsed&&u.getOrCreateMapValue(b,"#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",()=>new Set).add(a)}return k};f._evaluate=async function(b){const c=new Map,{_dependencyGraph:h,_fieldsAffectedLookup:g,_latestFieldValues:k}=this;for(const a of b)x(a,
c,h);for(const [a,{resolver:n,dependencyPromises:q}]of c)Promise.all(q).then(async()=>{const [e,r]=this._makeContext(k);return a.executeAsync(e,r)}).then(()=>{if(g.has(a))for(const e of g.get(a))this._latestFieldValues[e.name]=e.value;n.resolve()},e=>{!e||v.isAbortError(e)||y(e)||a.markStale();n.reject(e)});b=(await Promise.allSettled(Array.from(c.values(),({resolver:a})=>a.promise))).filter(a=>"rejected"===a.status&&!(v.isAbortError(a.reason)||y(a.reason)));if(0<b.length)throw new AggregateError(b,
"One or more expression executions failed");};f._makeContext=function(b){const [c,h]=this._baseContext,g=this.feature.clone();g.attributes=b;return[{...c,$feature:g},h]};w._createClass(m,[{key:"_baseContext",get:function(){const {editType:b,layer:c,map:h,originalFeature:g,spatialReference:k}=this.arcadeContextInfo,a="feature"===c?.type?c:"scene"===c?.type&&null!=c.associatedLayer?c.associatedLayer:void 0;return[{$originalfeature:g,$editcontext:{editType:b},$layer:a,$featureset:a,$datastore:c?.url,
$map:h},{spatialReference:k??void 0}]}},{key:"feature",set:function(b){this._latestFieldValues={...b?.attributes};this._set("feature",b)}}]);return m}(z);p.__decorate([t.property()],l.FormExpressionsManager.prototype,"_baseContext",null);p.__decorate([t.property()],l.FormExpressionsManager.prototype,"feature",null);p.__decorate([t.property()],l.FormExpressionsManager.prototype,"executors",void 0);p.__decorate([t.property()],l.FormExpressionsManager.prototype,"fieldInputs",void 0);p.__decorate([t.property()],
l.FormExpressionsManager.prototype,"arcadeContextInfo",void 0);l.FormExpressionsManager=p.__decorate([A.subclass("esri.widgets.FeatureForm.FormExpressionsManager")],l.FormExpressionsManager);const x=(d,m,f)=>{if(!m.has(d)){var b=v.createResolver();m.set(d,{resolver:b,dependencyPromises:[]});d.abort();d=f.get(d);for(const c of d)x(c,m,f),m.get(c).dependencyPromises.push(b.promise)}},y=d=>d&&"object"===typeof d&&"message"in d&&"Cancelled"===d.message;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
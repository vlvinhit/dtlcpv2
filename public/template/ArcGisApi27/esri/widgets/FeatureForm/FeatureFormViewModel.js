// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../core/deprecate ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/Promise ../../core/reactiveUtils ../../core/string ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../form/FormTemplate ../../layers/support/ContingentValue ../../layers/support/editableLayers ../../layers/support/LayerContingentValuesCache ./featureFormUtils ./FieldInput ./FormExpressionArcadeExecutor ./FormExpressionsManager ./GroupInput ./RelationshipInput".split(" "),
function(D,m,l,x,I,J,y,K,L,B,E,p,Z,aa,ba,M,N,F,O,P,t,G,Q,R,S,T){function H(w){if("field"===w.type||"group"===w.type||"relationship"===w.type)return!0;y.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel").warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${w.label} has unsupported type '${w.type}'`);return!1}const C=new l({attributes:{}}),U=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],
V=["visibilityExpression"],W=["editableExpression","visibilityExpression"],z=y.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel");l=function(w){function A(a){a=w.call(this,a)||this;a._expressionExecutorLookup=new Map;a._expressionsManager=null;a._contingentValuesCache=null;a._featureClone=C.clone();a._initialFeature=C.clone();a.arcadeEditType="NA";a.contingencyConstraintViolations=new Map;a.disabled=!1;a.inputs=[];a.map=null;a.relatedRecordCallbacks=null;a.strict=!1;return a}D._inherits(A,
w);var n=A.prototype;n.initialize=function(){const a=B.watch(()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.arcadeEditType],([c,e])=>{null!=c&&(e?this._updateInputs():c.load().catch(()=>y.getLogger(this).error("Failed to load layer",c.loadError)))},{equals:([c,e,f,g,k],[h,q,r,u,v])=>c===h&&e===q&&f===r&&g===u&&k===v,initial:!0}),b=B.watch(()=>this._arcadeContextInfo,c=>{null!=this._expressionsManager&&(this._expressionsManager.arcadeContextInfo=c)}),d=B.watch(()=>this.layer,
c=>{(c="subtype-sublayer"===c?.type?c.parent:"feature"===c?.type?c:null)&&this.addResolvingPromise(P.createLoadedLayerContingentValuesCache(c).then(e=>{this._contingentValuesCache=e;this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.handles.add([a,b,d])};n.destroy=function(){this.layer=this.feature=null;this._contingentValuesCache=K.destroyMaybe(this._contingentValuesCache)};n.formHeaderVisible=function(){const {activeRelationshipInput:a,formDescription:b,formTitle:d}=this;return!(a||
!b&&!d)};n.findField=function(a){return this.allFieldInputs.find(b=>b.name===a)};n.getValue=function(a){const {_featureClone:b,layer:d}=this,c=!!d?.getField(a);return b.getAttribute(a)??(c?null:void 0)};n.setValue=function(a,b){const {_featureClone:d,strict:c}=this,e=this.findField(a);b=""===b?null:b;e&&d.getAttribute(a)!==b&&(e.value=b,!c||e.valid)&&(this._afterValueChange(e),null!=this._expressionsManager&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([e.name]).finally(()=>
this._afterExpressionsEvaluated())))};n.getValues=function(){return{...this._featureClone.attributes}};n.submit=function(){var a=this.allFieldInputs;const b=new Set(a.filter(c=>c.valid).map(({name:c})=>c));a=a.filter(c=>!c.valid).map(({name:c})=>c);const d=this.getValues();if(0<this.validateContingencyConstraints(d,{includeIncompleteViolations:!0}).length)for(const [c,e]of this.contingencyConstraintViolations.entries())"error"===e.type&&(b.delete(c),a.push(c));this.emit("submit",{valid:[...b],invalid:a,
values:d})};n.validateContingencyConstraints=function(a,b){const {_contingentValuesCache:d}=this,c=new Map;this.contingencyConstraintViolations=c;if(null==d)return[];const {invalid:e,incomplete:f}=d.validateContingencyConstraints(a);a=[...e,...(b?.includeIncompleteViolations?f:[])];for(const g of a)for(const k of g.fieldGroup.fields)c.set(k,g);return a};n.notifyFeatureGeometryChanged=function(){const {_expressionsManager:a,feature:b,_featureClone:d}=this;d.geometry=b.geometry;null!=a&&this.updatingHandles.addPromise(a.evaluateInvalidatedByGeometry().finally(()=>
this._afterExpressionsEvaluated()))};n._emitChangeEvent=function({name:a,valid:b,value:d}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:d,valid:b})};n._updateInputs=function(){const {_featureClone:a,_initialFeature:b,arcadeEditType:d,formTemplate:c,inputs:e,layer:f}=this;if(f){var g={arcadeEditType:d,feature:a,initialFeature:b,layer:f},k=e.slice();this.inputs=null!=c&&c.elements&&0<c.elements.length?this._updateInputsUsingFormElements(k,c.elements,g):this._updateInputsUsingLayerFields(k,
f?.fields,g)}};n._updateInputsUsingFormElements=function(a,b,d){const c=new Map;for(const f of a)if(t.isGroupInput(f)){c.set(f.element,f);for(const g of f.inputs)g.element&&c.set(g.element,g)}else f.element&&c.set(f.element,f);a=new Map;const e=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:c,updatedElements:b.filter(H),sharedInitializationProperties:d,group:null,newExpressionExecutorPromises:a});this.updatingHandles.addPromise(Promise.all(Array.from(a.values())).then(()=>{const f=
Array.from(this._expressionExecutorLookup.values()),g=t.flattenFieldInputs(e);this._createExpressionsManager(f,g);return this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())}));for(const [f,g]of c.entries())c.delete(f),g.destroy();return e};n._updateInputsUsingFormElementsRecursive=function(a){const {existingInputsByElement:b,updatedElements:d,sharedInitializationProperties:c,group:e,newExpressionExecutorPromises:f}=a;a=[];for(const k of d){var g=b.has(k);const h=
g?b.get(k):t.isGroupElement(k)?this._makeGroupInputFromElement(k,c):t.isFieldElement(k)?this._makeFieldInputFromElement(k,c,e):t.isRelationshipElement(k)?this._makeRelationshipInputFromElement(k,c,e):null;h&&(a.push(h),g?(b.delete(k),t.isGroupInput(h)?({feature:g}=c,h.set({feature:g})):t.isRelationshipInput(h)?(g=this.relationshipId===k.relationshipId,h.set(c),h.set({map:this.map,showAllEnabled:g})):h.set(c)):this._assignExpressionExecutors(h,k,f),t.isGroupElement(k)&&(g=k.elements.filter(q=>H(q)),
h.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:b,updatedElements:g,sharedInitializationProperties:c,group:h,newExpressionExecutorPromises:f})))}return a};n._updateInputsUsingLayerFields=function(a,b,d){if(!Array.isArray(b))return y.getLogger(this).warn(this.declaredClass,"No attribute fields found."),[];const c=new Map;for(const h of a)if(t.isGroupInput(h)){for(const q of h.inputs)q.destroy();h.inputs.length=0;h.destroy()}else t.isRelationshipInput(h)?h.destroy():t.isFieldInput(h)&&
(null!==h.element?h.destroy():c.set(h.field,h));a=[];const {arcadeEditType:e,feature:f,initialFeature:g,layer:k}=d;for(const h of b)b=c.get(h)??new G({arcadeEditType:e,field:h,feature:f,initialFeature:g,layer:k,value:f?.getAttribute(h.name)??null}),a.push(b),c.delete(h);for(const [h,q]of c.entries())c.delete(h),q.destroy();return a};n._resetFieldInputValues=function(a){for(const b of this.allFieldInputs)b.value=a.getAttribute(b.name)};n._makeFieldInputFromElement=function(a,b,d){const {arcadeEditType:c,
feature:e,initialFeature:f,layer:g}=b;({fieldName:b}=a);return(b=b&&this._layerFieldsByName.get(b))?new G({arcadeEditType:c,element:a,field:b,value:e?.getAttribute(a.fieldName)??null,feature:e,initialFeature:f,layer:g,group:d}):null};n._makeGroupInputFromElement=function(a,b){const {feature:d,layer:c}=b;return new S({element:a,inputs:[],feature:d,layer:c})};n._makeRelationshipInputFromElement=function(a,b,d=null){const {map:c}=this,{feature:e,layer:f}=b;return new T({element:a,feature:e,group:d,layer:f,
map:c})};n._assignExpressionExecutors=function(a,b,d){var c=t.isGroupElement(b)?V:t.isRelationshipElement(b)?W:U;for(const e of c){c=b[e];const {_expressionExecutorLookup:f}=this;if(null!=c&&""!==c){const g=`${e}Executor`,k=this._expressionInfosLookup.get(c)?.expression??c;f.has(k)?a[g]=f.get(k):d.has(k)?(c=d.get(k).then(h=>a[g]=h),d.set(k,c)):(c=Q.createFormExpressionArcadeExecutor(k,this.layer).then(h=>{a[g]=h;f.set(k,h);return h}),d.set(k,c))}}return[]};n._createExpressionsManager=function(a,b){const {_arcadeContextInfo:d,
_featureClone:c}=this;this._expressionsManager=new R.FormExpressionsManager({executors:a,feature:c,arcadeContextInfo:d,fieldInputs:b})};n._afterValueChange=function(a){const {name:b,value:d}=a,{_featureClone:c,formTemplate:e,layer:f}=this;if(f){var g=c.getAttribute(b);c.setAttribute(b,d);var {typeFieldName:k,types:h}=t.getNormalizedFeatureTypeInfo(f);if(b===k&&d!==g){"subtype-sublayer"===f.type&&(g=f.parent?.findSublayerForFeature(c),c.sourceLayer=this.feature.sourceLayer=g);g=new Set;for(var q of h)if(q.domains&&
"object"===typeof q.domains)for(const r of Object.keys(q.domains))g.add(r);for(const r of g)(q=this.findField(r))&&q.notifyChange("domain")}if(null!=e){const {description:r,title:u}=e;u&&E.templateHasKey(u,b)&&this.notifyChange("formTitle");r&&E.templateHasKey(r,b)&&this.notifyChange("formDescription")}this._emitChangeEvent(a)}};n._afterExpressionsEvaluated=function(){const {_featureClone:a}=this;for(const b of this.allFieldInputs)b.value!==a.getAttribute(b.name)&&this._afterValueChange(b)};n._joinContingentValues=
function(){var a=this._contingentValuesCache;if(null==a)return[];var {typeFieldName:b}=t.getNormalizedFeatureTypeInfo(this.layer);b=b?this.getValue(b):null;const d=[];for(var c of a.fieldGroups){const {contingencies:k,fields:h,name:q}=c;a=[];for(var e of k)e.isRetired||(null==e.subtype||e.subtype.code===b)&&a.push({values:e.values});0<a.length&&d.push({name:q,fields:h,contingencies:a})}const [f,g]=this._generateJoinPlan(d);c=f.flatMap(k=>this._joinFieldGroupContingencies(k));e=g.flatMap(k=>k.contingencies);
return[...c,...e]};n._generateJoinPlan=function(a){var b=new Map,d=[],c=new Set;for(var e of a)for(const h of e.fields)if(b.has(h)){const q=b.get(h),r=e,u=[q.name,r.name].sort().join("|");c.has(u)||(d.push([q,r]),c.add(u),b.set(h,r))}else b.set(h,e);b=new Set(d.flat());a=new Set(a);for(var f of b)a.delete(f);f=new Map;b=new Map;for(var g of new Set(d.flat()))c=Symbol(g.name),f.set(c,new Set([g])),b.set(g,c);for(const [h,q]of d)if(d=b.get(h),g=b.get(q),d!==g){c=f.get(d);e=f.get(g);for(var k of e)c.add(k),
b.set(k,d);f.delete(g)}k=[...f.values()].map(h=>[...h]);d=[...a];return[k,d]};n._joinFieldGroupContingencies=function(a){const b=a.slice();var d=b.shift(),c=b.shift();a=this._generateJoinKey(d.fields,c.fields);let e=new Set([...d.fields,...c.fields]),f=new Map;for(var g of d.contingencies)[d]=this._hashContingency(g,a.codedValueFields,!0),f.has(d)?f.get(d)?.push(g):f.set(d,[g]);for(;0<b.length;){g=new Map;d=b.shift();const q=this._generateJoinKey(e,d.fields);for(var k of c.contingencies){const [r,
u]=this._hashContingency(k,a.codedValueFields);c=u?this._findMatchingContingenciesWithAnyHashMask(f,r):f.get(r);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&c?.push(...this._findMatchingContingenciesContainingAny(k,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(null!=c)for(var h of c){c=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(h,k,a.rangeFields):this._joinContingencies(h,k);if(null==c)break;const [v]=this._hashContingency(c,q.codedValueFields,!0);g.has(v)?g.get(v)?.push(c):
g.set(v,[c])}}f=g;c=d;a=q;e=new Set([...e,...c.fields])}k=[];for(const q of c.contingencies){const [r,u]=this._hashContingency(q,a.codedValueFields);h=u?this._findMatchingContingenciesWithAnyHashMask(f,r):f.get(r);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&h.push(...this._findMatchingContingenciesContainingAny(q,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(null!=h)for(const v of h)h=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(v,q,a.rangeFields):this._joinContingencies(v,
q),null!=h&&k.push(h)}return k};n._joinContingencies=function(a,b){b={values:{...a.values,...b.values}};for(const [d,c]of Object.entries(b.values))"any"===c.objectType&&null!=a.values[d]&&(b.values[d]=a.values[d]);return b};n._joinContingenciesWithRangeDomains=function(a,b,d){const c=this._joinContingencies(a,b);for(const f of d){var e=a.values[f];const g=b.values[f],{leftIsNull:k,rightIsNull:h,bothAreNull:q,leftIsAny:r,rightIsAny:u,bothAreAny:v,leftIsRange:X,rightIsRange:Y}=this._compareObjectTypes(e.objectType,
g.objectType);if(!q&&!v)if(k&&u||h&&r)c.values[f]=new F({objectType:"null"});else{if(k&&Y||h&&X)return null;r?(e.minValue=-Infinity,e.maxValue=Infinity):u&&(g.minValue=-Infinity,g.maxValue=Infinity);d=Math.max(e.minValue,g.minValue);e=Math.min(e.maxValue,g.maxValue);if(d>e)return null;c.values[f]=new F({objectType:"range",minValue:d,maxValue:e})}}return c};n._findMatchingContingenciesContainingAny=function(a,b,d){return b.filter(c=>d.every(e=>{const f=c.values[e];e=a.values[e];return"any"===f.objectType||
"any"===e.objectType||f.codedValue?.code===e.codedValue?.code}))};n._findMatchingContingenciesWithAnyHashMask=function(a,b){b=RegExp(`${b}$`);const d=[];for(const [c,e]of a){if("#JSAPI_CONTINGENT_VALUE_ANY_HASH"===c)break;b.test(c)&&d.push(...e)}return d};n._generateJoinKey=function(a,b){a=Array.isArray(a)?new Set(a):a;var d=Array.isArray(b)?new Set(b):b;b=a.size<d.size?a:d;a=b===a?d:a;d=new Set;const c=new Set;for(const e of b)if(a.has(e)&&(b=this.layer?.getFieldDomain(e,{feature:this.feature}),
null!=b))switch(b.type){case "coded-value":d.add(e);break;case "range":c.add(e)}return{codedValueFields:[...d],rangeFields:[...c]}};n._hashContingency=function(a,b,d=!1){if(1>b.length)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const c=[];let e=!1;for(const f of b)if(b=a.values[f],"any"===b.objectType){if(d)return["#JSAPI_CONTINGENT_VALUE_ANY_HASH",!0];e=!0;c.push(`${f}:.*`)}else"null"===b.objectType?c.push(`${f}:${"#JSAPI_CONTINGENT_VALUE_NULL_HASH"}`):c.push(`${f}:${b.codedValue?.code}`);return[c.sort().join("\x26"),
e]};n._compareObjectTypes=function(a,b){return{leftIsNull:"null"===a,rightIsNull:"null"===b,bothAreNull:"null"===a&&"null"===b,leftIsAny:"any"===a,rightIsAny:"any"===b,bothAreAny:"any"===a&&"any"===b,leftIsRange:"range"===a,rightIsRange:"range"===b}};D._createClass(A,[{key:"_expressionInfosLookup",get:function(){return new Map(this.formTemplate?.expressionInfos?.map(a=>[a.name,a]))}},{key:"activeRelationshipInput",get:function(){return this.allRelationshipInputs.find(a=>a.relationshipId===this.relationshipId)}},
{key:"_arcadeContextInfo",get:function(){const {_initialFeature:a,arcadeEditType:b,layer:d,map:c,spatialReference:e}=this;return{layer:O.isEditableLayer(d)?d:null,originalFeature:a,editType:b,map:c,spatialReference:e}}},{key:"allFieldInputs",get:function(){return t.flattenFieldInputs(this.inputs)}},{key:"allRelationshipInputs",get:function(){return t.flattenRelationshipInputs(this.inputs)}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer?.fields.map(a=>[a.name,a]))}},{key:"feature",
get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():C.clone();this._initialFeature=this._featureClone.clone();a?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach(b=>b.feature=a)):(this.inputs.forEach(b=>b.destroy()),this.inputs.length=0);this.contingencyConstraintViolations.clear();null!=this._expressionsManager&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>
this._afterExpressionsEvaluated())));this._set("feature",a)}},{key:"fieldsWithContingentValues",get:function(){if(null==this._contingentValuesCache)return new Set;const a=this._contingentValuesCache.fieldGroups.flatMap(b=>b.fields);return new Set(a)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(a){void 0===a?this._clearOverride("formTemplate"):this._override("formTemplate",a)}},{key:"formDescription",get:function(){const {formTemplate:a,
layer:b}=this;return null!=a&&a.description&&b?t.parseFormTemplateString(a.description,this.getValues(),b.fieldsIndex):null}},{key:"formTitle",get:function(){const {formTemplate:a,layer:b}=this;return null!=a&&a.title&&b?t.parseFormTemplateString(a.title,this.getValues(),b.fieldsIndex):null}},{key:"inputFields",get:function(){x.deprecatedProperty(z,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"});return this.inputs},set:function(a){x.deprecatedProperty(z,"inputFields",{replacement:"FeatureFormViewModel.inputs",
version:"4.27"});this.inputs=a}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(a){this._override("layer",a)}},{key:"relationshipId",get:function(){return this._get("relationshipId")},set:function(a){var b=this.allRelationshipInputs;null!=a&&a===this.relationshipId||b.forEach(d=>d.showAllEnabled=!1);null!=a&&(b=b.find(d=>
d.relationshipId===a))&&(b.showAllEnabled=!0);this._set("relationshipId",a)}},{key:"spatialReference",get:function(){return this.layer?.spatialReference??null},set:function(a){this._override("spatialReference",a)}},{key:"state",get:function(){return this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return this.valid?!0:this.allFieldInputs.filter(a=>!a.valid).every(({submittable:a})=>a)}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"valid",
get:function(){const a=this.allFieldInputs;return 0<a.length&&a.every(({valid:b})=>b)}},{key:"view",get:function(){x.deprecatedProperty(z,"view",{replacement:"FeatureForm.map",version:"4.27"});return this._get("view")},set:function(a){x.deprecatedProperty(z,"view",{replacement:"FeatureForm.map",version:"4.27"});this._set("view",a);a?.map&&(this.map=a.map)}}]);return A}(J.HandleOwnerMixin(L.EsriPromiseMixin(I.EventedAccessor)));m.__decorate([p.property()],l.prototype,"_expressionInfosLookup",null);
m.__decorate([p.property()],l.prototype,"_featureClone",void 0);m.__decorate([p.property()],l.prototype,"activeRelationshipInput",null);m.__decorate([p.property()],l.prototype,"_arcadeContextInfo",null);m.__decorate([p.property({readOnly:!0})],l.prototype,"allFieldInputs",null);m.__decorate([p.property()],l.prototype,"allRelationshipInputs",null);m.__decorate([p.property()],l.prototype,"_layerFieldsByName",null);m.__decorate([p.property()],l.prototype,"arcadeEditType",void 0);m.__decorate([p.property()],
l.prototype,"contingencyConstraintViolations",void 0);m.__decorate([p.property()],l.prototype,"disabled",void 0);m.__decorate([p.property()],l.prototype,"feature",null);m.__decorate([p.property()],l.prototype,"fieldsWithContingentValues",null);m.__decorate([p.property({type:N})],l.prototype,"formTemplate",null);m.__decorate([p.property()],l.prototype,"formDescription",null);m.__decorate([p.property()],l.prototype,"formTitle",null);m.__decorate([p.property()],l.prototype,"formHeaderVisible",null);
m.__decorate([p.property()],l.prototype,"inputs",void 0);m.__decorate([p.property()],l.prototype,"inputFields",null);m.__decorate([p.property()],l.prototype,"joinedContingentValues",null);m.__decorate([p.property()],l.prototype,"layer",null);m.__decorate([p.property()],l.prototype,"map",void 0);m.__decorate([p.property()],l.prototype,"relatedRecordCallbacks",void 0);m.__decorate([p.property()],l.prototype,"relationshipId",null);m.__decorate([p.property()],l.prototype,"spatialReference",null);m.__decorate([p.property()],
l.prototype,"state",null);m.__decorate([p.property()],l.prototype,"strict",void 0);m.__decorate([p.property()],l.prototype,"submittable",null);m.__decorate([p.property()],l.prototype,"updating",null);m.__decorate([p.property()],l.prototype,"valid",null);m.__decorate([p.property()],l.prototype,"view",null);m.__decorate([p.property()],l.prototype,"getValues",null);m.__decorate([p.property()],l.prototype,"submit",null);return l=m.__decorate([M.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],
l)});
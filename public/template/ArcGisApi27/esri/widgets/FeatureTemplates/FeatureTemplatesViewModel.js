// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Evented ../../core/HandleOwner ../../core/ObjectPool ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ./TemplateItem ./TemplateItemGroup".split(" "),function(u,h,e,z,v,A,k,G,H,I,B,w,x,C){var r;const D=({layer:c})=>({key:c,label:c.title??""}),E=
({layer:c})=>({key:c.geometryType,label:c.geometryType??""});e=r=function(c){function q(a){a=c.call(this,a)||this;a._itemPool=new v(x);a._groupPool=new v(C);a.filterFunction=null;a.selectedItem=null;return a}u._inherits(q,c);var g=q.prototype;g.initialize=function(){this._get("groupBy")||(this.groupBy="layer")};g.refresh=function(){this.notifyChange("items")};g.select=function(a,{emit:b=!0}={}){const d=this.selectedItem;a=a?.clone()||null;this._set("selectedItem",a);b&&this.emit("select",{item:a,
oldItem:d,template:a?.template??null})};g._createItem=function(a,b){const d=this._itemPool.acquire();d.set({template:a,layer:b});return d};g._createGroup=function(a,b){const d=this._groupPool.acquire();d.set("label",a);d.items=b;return d};g._releasePreviousItems=function(){this._destroyItems(this._get("items"))};g._destroyItems=function(a){a&&(a[0]instanceof x?a.forEach(b=>this._destroyItem(b)):a.forEach(b=>this._destroyGroup(b)))};g._destroyGroup=function(a){a.items.forEach(b=>this._destroyItem(b));
a.items.length=0;this._groupPool.release(a)};g._destroyItem=function(a){a.layer=null;a.template=null;this._itemPool.release(a)};g._ensureGroupByObject=function(a){return"string"===typeof a?{key:a,label:a}:a};u._createClass(q,[{key:"groupBy",set:function(a){this._set("groupBy",a);if("function"===typeof a)this._groupByFunction=b=>this._ensureGroupByObject(a(b));else switch(a){case "layer":this._groupByFunction=D;break;case "geometry":this._groupByFunction=E;break;default:this._groupByFunction=null}}},
{key:"layers",get:function(){return this._get("layers")},set:function(a){this.handles.remove("layers");if(a){const b=()=>this.notifyChange("state");this.handles.add(a.map(d=>A.when(()=>d.loadStatus,b)),"layers")}this._set("layers",a)}},{key:"state",get:function(){const {layers:a}=this;return a&&0!==a.length?a.some(b=>"loading"===b.loadStatus||"not-loaded"===b.loadStatus)?"loading":"ready":"disabled"}},{key:"_featureTemplatesByLayer",get:function(){if(!this.layers)return new Map;const a=[];for(const b of this.layers)if("subtype-group"===
b.type)for(const d of b.sublayers){const l=y(d);a.push([d,l])}else w.isTable(b)||a.push([b,y(b)]);return new Map(a)}},{key:"numberOfFeatureTemplates",get:function(){return Array.from(this._featureTemplatesByLayer.values()).reduce((a,b)=>a+b.length,0)}},{key:"items",get:function(){if(0===this.numberOfFeatureTemplates)return this._releasePreviousItems(),[];var a=this._featureTemplatesByLayer,b=[],d=null!=this.filterFunction?this.filterFunction:r._nullFilterFunction;for(const [f,m]of a)if(f.loaded||
"subtype-sublayer"===f.type&&f.parent?.loaded)if(a=w.getEffectiveLayerCapabilities(f)?.operations,a?.supportsEditing&&a?.supportsAdd)for(var l of m)b.push({layer:f,template:l,matchesFilter:d({label:l.name})});if(null==this._groupByFunction)return d=b.filter(({matchesFilter:f})=>f).map(({template:f,layer:m})=>this._createItem(f,m)),this._releasePreviousItems(),d;l=new Map;for(var n of b){const {template:f,layer:m}=n;b=this._groupByFunction({template:f,layer:m});const {key:p,label:t}=null!=b.key?b:
r.nullGroupBy;l.has(p)||l.set(p,{label:t,templateItemInfos:[]});l.get(p)?.templateItemInfos.push(n)}n=[];for(const f of l.values()){const {label:m,templateItemInfos:p}=f;b=p.filter(({matchesFilter:t})=>t);b=d({label:m})?p:0<p.length?b:[];0<b.length&&(b=b.map(({template:t,layer:F})=>this._createItem(t,F)),n.push(this._createGroup(m,b)))}if(1===n.length&&n[0].label===r.nullGroupBy.label)return this._releasePreviousItems(),n[0].items;this._releasePreviousItems();return n}}]);return q}(z.HandleOwnerMixin(e.EventedAccessor));
e.nullGroupBy={key:Symbol(),label:"Other\u200b"};e._nullFilterFunction=c=>!0;h.__decorate([k.property()],e.prototype,"_groupByFunction",void 0);h.__decorate([k.property()],e.prototype,"filterFunction",void 0);h.__decorate([k.property()],e.prototype,"groupBy",null);h.__decorate([k.property()],e.prototype,"layers",null);h.__decorate([k.property()],e.prototype,"state",null);h.__decorate([k.property({readOnly:!0})],e.prototype,"_featureTemplatesByLayer",null);h.__decorate([k.property({readOnly:!0})],
e.prototype,"numberOfFeatureTemplates",null);h.__decorate([k.property({readOnly:!0})],e.prototype,"items",null);h.__decorate([k.property({readOnly:!0})],e.prototype,"selectedItem",void 0);e=r=h.__decorate([B.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],e);const y=c=>{const q="templates"in c&&Array.isArray(c.templates)?c.templates:[];c="types"in c&&Array.isArray(c.types)?c.types.flatMap(g=>g.templates):[];return[...q,...c]};return e});
// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../Color ../../../Graphic ../../../core/compilerUtils ../../../core/Logger ../../support/lengthUtils ./sizeVariableUtils".split(" "),function(p,w,D,E,F,G,m){function x(a,c,b){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"color"===r.type):a)if("esri.renderers.visualVariables.ColorVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");else{var d="number"===typeof c,e=d?null:c,f=e&&
e.attributes,g=d?c:null,l=a.field,{ipData:h,hasExpression:k}=a.cache;c=a.cache.compiledFunc;if(!l&&!k)return(b=a.stops)&&b[0]&&b[0].color;if("number"!==typeof g)if(k){if(null==b||null==b.arcade){q.error("Use of arcade expressions requires an arcade context");return}g=b.arcade.arcadeUtils;l=g.getViewInfo({viewingMode:b.viewingMode,scale:b.scale,spatialReference:b.spatialReference});e=g.createExecContext(e,l);c||(c=g.createSyntaxTree(a.valueExpression),c=g.createFunction(c),a.cache.compiledFunc=c);
g=g.executeFunction(c,e)}else f&&(g=f[l]);e=a.normalizationField;f=null!=f&&null!=e?parseFloat(f[e]):void 0;if(null!=g&&(!e||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=v(g,h)))return f=d[0],e=d[1],b=f===e?a.stops[f].color:w.blendColors(a.stops[f].color,a.stops[e].color,d[2],null!=b?b.color:void 0),new w(b)}}function y(a,c,b){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"opacity"===r.type):a)if("esri.renderers.visualVariables.OpacityVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");
else{var d="number"===typeof c,e=d?null:c,f=e&&e.attributes,g=d?c:null,l=a.field,{ipData:h,hasExpression:k}=a.cache;c=a.cache.compiledFunc;if(!l&&!k)return(a=a.stops)&&a[0]&&a[0].opacity;if("number"!==typeof g)if(k){if(null==b||null==b.arcade){q.error("Use of arcade expressions requires an arcade context");return}g=b.arcade.arcadeUtils;b=g.getViewInfo({viewingMode:b.viewingMode,scale:b.scale,spatialReference:b.spatialReference});b=g.createExecContext(e,b);c||(e=g.createSyntaxTree(a.valueExpression),
c=g.createFunction(e),a.cache.compiledFunc=c);g=g.executeFunction(c,b)}else f&&(g=f[l]);b=a.normalizationField;f=null!=f&&null!=b?parseFloat(f[b]):void 0;if(null!=g&&(!b||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=v(g,h))){b=d[0];f=d[1];if(b===f)return a.stops[b].opacity;b=a.stops[b].opacity;return b+(a.stops[f].opacity-b)*d[2]}}}function z(a,c,b){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"rotation"===r.type):a)if("esri.renderers.visualVariables.RotationVariable"!==
a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");else{var d=a.axis||"heading",e="heading"===d&&"arithmetic"===a.rotationType?90:0;d="heading"===d&&"arithmetic"===a.rotationType?-1:1;var f="number"===typeof c?null:c,g=f&&f.attributes,l=a.field,{hasExpression:h}=a.cache;c=a.cache.compiledFunc;var k=0;if(!l&&!h)return k;if(h){if(null==b||null==b.arcade){q.error("Use of arcade expressions requires an arcade context");return}g=b.arcade.arcadeUtils;
b=g.getViewInfo({viewingMode:b.viewingMode,scale:b.scale,spatialReference:b.spatialReference});b=g.createExecContext(f,b);c||(c=g.createSyntaxTree(a.valueExpression),c=g.createFunction(c),a.cache.compiledFunc=c);k=g.executeFunction(c,b)}else g&&(k=g[l]||0);return k="number"!==typeof k||isNaN(k)?null:e+d*k}}function H(a,c,b){const d="number"===typeof c;var e=d?null:c;const f=e&&e.attributes;var g=d?c:null;const {isScaleDriven:l}=a.cache;c=a.cache.compiledFunc;if(l)e=null!=b?b.scale:void 0,b=null!=
b?b.view:void 0,null==e||"3d"===b?(e=b=null,(e=a.stops)?(b=e[0].value,e=e[e.length-1].value):(b=a.minDataValue||0,e=a.maxDataValue||0),b=(b+e)/2):b=e,g=b;else if(!d)switch(a.inputValueType){case m.InputValueType.Expression:if(null==b||null==b.arcade){q.error("Use of arcade expressions requires an arcade context");return}g=b.arcade.arcadeUtils;b=g.getViewInfo({viewingMode:b.viewingMode,scale:b.scale,spatialReference:b.spatialReference});b=g.createExecContext(e,b);c||(e=g.createSyntaxTree(a.valueExpression),
c=g.createFunction(e),a.cache.compiledFunc=c);g=g.executeFunction(c,b);break;case m.InputValueType.Field:f&&(g=f[a.field]);break;case m.InputValueType.Unknown:g=null}if(!m.isValidNumber(g))return null;if(d||!a.normalizationField)return g;a=f?parseFloat(f[a.normalizationField]):null;return m.isValidNumber(a)&&0!==a?g/a:null}function t(a,c,b){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(e=>"size"===e.type):a)if("esri.renderers.visualVariables.SizeVariable"!==a.declaredClass)q.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");
else{var d=H(a,c,b);c=A(d,a,c,b,a.cache.ipData);return null===c||void 0===c||isNaN(c)?0:c}}function n(a,c,b){return null==a?null:m.isSizeVariable(a)?t(a,c,b):m.isValidNumber(a)?a:null}function B(a,c,b){return m.isValidNumber(b)&&a>b?b:m.isValidNumber(c)&&a<c?c:a}function A(a,c,b,d,e){switch(c.transformationType){case m.TransformationType.Additive:return d=n(c.minSize,b,d),a+((d||c.minDataValue)??0);case m.TransformationType.Constant:return a=(a=c.stops)&&a.length&&a[0].size,null==a&&(a=c.minSize),
n(a,b,d);case m.TransformationType.ClampedLinear:e=(a-c.minDataValue)/(c.maxDataValue-c.minDataValue);var f=n(c.minSize,b,d);b=n(c.maxSize,b,d);d=null!=d?d.shape:void 0;a<=c.minDataValue?c=f:a>=c.maxDataValue?c=b:null==f||null==b?c=null:"area"===c.scaleBy&&d?(a=(c="circle"===d)?u*(f/2)**2:f*f,a+=e*((c?u*(b/2)**2:b*b)-a),c=c?2*Math.sqrt(a/u):Math.sqrt(a)):c=f+e*(b-f);return c;case m.TransformationType.Proportional:return e=null!=d?d.shape:void 0,a/=c.minDataValue,f=n(c.minSize,b,d),c=n(c.maxSize,b,
d),d=null,d="circle"===e?2*Math.sqrt(a*(f/2)**2):"square"===e||"diamond"===e||"image"===e?Math.sqrt(a*f**2):a*f,B(d,f,c);case m.TransformationType.Stops:{const [g,l,h]=v(a,e);g===l?c=n(c.stops?.[g].size,b,d):(a=n(c.stops?.[g].size,b,d),c=n(c.stops?.[l].size,b,d),c=a+(c-a)*h)}return c;case m.TransformationType.RealWorldSize:return e=(null!=d&&d.resolution?d.resolution:1)*G.meterIn[c.valueUnit],f=n(c.minSize,b,d),d=n(c.maxSize,b,d),{valueRepresentation:c}=c,b=null,b="area"===c?2*Math.sqrt(a/u)/e:"radius"===
c||"distance"===c?2*a/e:a/e,B(b,f,d);case m.TransformationType.Identity:return a;case m.TransformationType.Unknown:return null}}function v(a,c){if(c){var b=0,d=c.length-1;c.some((e,f)=>{if(a<e)return d=f,!0;b=f;return!1});return[b,d,(a-c[b])/(c[d]-c[b])]}}const q=F.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),C=new D,u=Math.PI;p.getAllSizes=function(a,c,b){const d=["proportional","proportional","proportional"];for(const e of a)switch(a=e.useSymbolValue?"symbol-value":t(e,
c,b),e.axis){case "width":d[0]=a;break;case "depth":d[1]=a;break;case "height":d[2]=a;break;case "width-and-depth":d[0]=a;d[1]=a;break;case "all":case void 0:case null:d[0]=a;d[1]=a;d[2]=a;break;default:E.neverReached(e.axis)}return d};p.getColor=x;p.getOpacity=y;p.getRotationAngle=z;p.getSize=t;p.getSizeForValue=A;p.getSizeFromNumberOrVariable=n;p.getSizeRangeAtScale=function(a,c,b){const {isScaleDriven:d}=a.cache;if(!(d&&"3d"===b||c))return null;b={scale:c,view:b};c=n(a.minSize,C,b);a=n(a.maxSize,
C,b);if(null!=c||null!=a)return c>a&&(b=a,a=c,c=b),{minSize:c,maxSize:a}};p.getVisualVariableValues=function(a,c,b){if(a.visualVariables){var d=[],e=[],f=[],g=[],l=[];for(const h of a.visualVariables)switch(h.type){case "color":e.push(h);break;case "opacity":f.push(h);break;case "rotation":l.push(h);break;case "size":g.push(h)}e.forEach(h=>{const k=x(h,c,b);d.push({variable:h,value:k})});f.forEach(h=>{const k=y(h,c,b);d.push({variable:h,value:k})});l.forEach(h=>{const k=z(h,c,b);d.push({variable:h,
value:k})});g.forEach(h=>{const k=t(h,c,b);d.push({variable:h,value:k})});return d.filter(h=>null!=h.value)}};p.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
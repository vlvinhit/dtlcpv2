// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../Color ../../request ../../core/Error ../../core/has ../../core/Logger ../../core/LRUCache ../../core/promiseUtils ../../core/string ../../core/Version ../../layers/support/FieldsIndex ../../support/arcadeOnDemand ../../symbols/CIMSymbol".split(" "),function(r,z,A,t,B,u,v,C,D,E,F,G,w,H){function x(n,m){if(n&&(n=n.symbolLayers))for(var a=n.length;a--;){var b=n[a];if(b&&!1!==b.enable)switch(b.type){case "CIMVectorMarker":var d=m;if(b=b.markerGraphics)for(const c of b)if(c&&
(b=c.symbol))switch(b.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":x(b,d);break;case "CIMTextSymbol":b.fieldMap=d}}}}const I={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};u=function(){function n(a,b,d){this.url=this.fieldMap=this.config=null;this._ongoingRequests=new Map;this._symbolCache=new C.LRUCache(100);this._dictionaryPromise=this._fieldIndex=this._dictionaryVersion=null;this.url=
a;this.config=b;this.fieldMap=d}var m=n.prototype;m.getSymbolFields=function(){return this._symbolFields};m.getSymbolAsync=async function(a,b){this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b));try{var d=await this._dictionaryPromise}catch(f){if(D.isAbortError(f))return this._dictionaryPromise=null}var c=this._dictionaryVersion&&this._dictionaryVersion.since(4,0),k={};if(this.fieldMap)for(var h of this._symbolFields){var e=this._getFieldName(this.fieldMap[h]);k[h]=e?c?a.attributes[e]:
""+a.attributes[e]:""}c=null;try{c=d?.(k,b)}catch(f){return null}if(!c||"string"!==typeof c)return null;const l=E.numericHash(c).toString();if(d=this._symbolCache.get(l))return d.catch(()=>{this._symbolCache.pop(l)}),d;c=c.split(";");d=[];k=[];for(const f of c)if(f)if(f.includes("po:"))e=f.substr(3).split("|"),3===e.length&&(c=e[0],h=e[1],e=e[2],"DashTemplate"===h?e=e.split(" ").map(g=>Number(g)):"Color"===h?(e=(new A(e)).toRgba(),e=[e[0],e[1],e[2],255*e[3]]):e=Number(e),k.push({primitiveName:c,propertyName:h,
value:e}));else if(f.includes("|"))for(const g of f.split("|")){if(this._itemNames.has(g)){d.push(g);break}}else this._itemNames.has(f)&&d.push(f);a=this._cimPartsToCIMSymbol(d,k,null==a.geometry||!a.geometry.hasZ&&"point"===a.geometry.type?!0:!1,b);this._symbolCache.put(l,a,1);return a};m.fetchResources=async function(a){if(this._dictionaryPromise)return this._dictionaryPromise;if(this.url){var b=t(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:null!=
a?a.signal:null}),[{data:d}]=await Promise.all([b,w.loadArcade()]);if(!d)throw this._dictionaryPromise=null,new B("esri.renderers.DictionaryRenderer","Bad dictionary data!");var {authoringInfo:c,dictionary_version:k,expression:h,itemsNames:e}=d;b=!1;k&&(this._dictionaryVersion=F.Version.parse(k),b=this._dictionaryVersion.since(4,0));this._refSymbolUrlTemplate=this.url+"/"+d.cimRefTemplateUrl;this._itemNames=new Set(e);this._symbolFields=c.symbol;d={};if(this.config){const g=this.config;for(var l in g)d[l]=
g[l]}if(c.configuration)for(var f of c.configuration)d.hasOwnProperty(f.name)||(d[f.name]=f.value);l=[];if(null!=a&&a.fields&&this.fieldMap)for(const g of this._symbolFields){const q=this.fieldMap[g];f=a.fields.filter(p=>p.name.toLowerCase()===q?.toLowerCase());0<f.length&&l.push({...f[0],type:b?f[0].type:"esriFieldTypeString"})}0<l.length&&(this._fieldIndex=new G(l));return this._dictionaryPromise=a=w.createDictionaryExpression(h,null!=a?a.spatialReference:null,l,d).then(g=>{const q={scale:0};return(p,
y)=>{if(null==g)return null;p=g.repurposeFeature({geometry:null,attributes:p});q.scale=null!=y?y.scale??void 0:void 0;return g.evaluate({$feature:p,$view:q},g.services)}}).catch(g=>{v.getLogger("esri.renderers.support.DictionaryLoader").error("Creating dictinoary expression failed:",g);return null})}v.getLogger("esri.renderers.support.DictionaryLoader").error("no valid URL!")};m._cimPartsToCIMSymbol=async function(a,b,d,c){const k=Array(a.length);for(let h=0;h<a.length;h++)k[h]=this._getSymbolPart(a[h],
c);a=await Promise.all(k);if(c=this.fieldMap)for(const h of a)x(h,c);return new H({data:this._combineSymbolParts(a,b,d)})};m._getSymbolPart=async function(a,b){if(this._ongoingRequests.has(a))return this._ongoingRequests.get(a).then(c=>c.data);const d=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,a);b=t(d,{responseType:"json",query:{f:"json"},...b});this._ongoingRequests.set(a,b);try{return(await b).data}catch(c){throw this._ongoingRequests.delete(a),c;}};m._combineSymbolParts=function(a,
b,d){if(!a||0===a.length)return null;const c={...a[0]};if(1<a.length){c.symbolLayers=[];for(const k of a)c.symbolLayers.unshift(...k.symbolLayers)}d&&(c.callout=I);return{type:"CIMSymbolReference",symbol:c,primitiveOverrides:b}};m._getFieldName=function(a){if(null!==this._fieldIndex){const b=this._fieldIndex.get(a);return b?b.name:a}return a};return z._createClass(n)}();r.DictionaryLoader=u;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
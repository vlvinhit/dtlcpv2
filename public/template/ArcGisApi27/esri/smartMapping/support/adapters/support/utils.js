// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../core/has ../../../../layers/support/CodedValueDomain ../../../../layers/support/Domain ../../../../layers/support/InheritedDomain ../../../../layers/support/RangeDomain ../../../../layers/support/Field ../../../../layers/support/fieldUtils ../../../../rest/support/StatisticDefinition ../../../statistics/support/predominanceUtils ../../../statistics/support/utils ../../utils ../../../../statistics/utils".split(" "),
function(n,M,G,U,N,V,W,X,O,P,H,Q,w,y,x){function C(a){const {field:b,normalizationType:c,normalizationField:d,normalizationTotal:e,layer:f}=a;a=y.isIntegerField(f,b);let k=b;"percent-of-total"===c?k=`((${a?y.castIntegerFieldToFloat(b):b} / ${e}) * 100)`:"log"===c?k=`(log(${b}) * ${R})`:"field"===c?k=`(${a?y.castIntegerFieldToFloat(b):b} / ${d})`:"natural-log"===c?k=`(log(${a?y.castIntegerFieldToFloat(b):b}))`:"square-root"===c&&(k=`(power(${a?y.castIntegerFieldToFloat(b):b}, 0.5))`);return k}function I(a,
b){let c;b=b.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()!==b){c=a[d];break}return c}function z(a,b){let c;b=b.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()===b){c=a[d];break}return c}function D(a,b){if(b)for(const c in a)a[c].label=b[c];return{count:a}}async function E(a,b,c){var d=a?c.getField(a):null;if(d=d?c.getFieldDomain(d.name):null)return d;({uniqueValueInfos:a}=await c.uniqueValues({field:a,sqlWhere:b.sqlWhere,features:b.features,useFeaturesInView:b.useFeaturesInView,view:b.view,
signal:b.signal}));a=a.map(e=>({code:e.value}));return new N({codedValues:a})}function J(a,b){return y.getDateDiffSQL(a,new Date(0),b,"milliseconds").sqlExpression}function K(a,b){switch(a.statisticType){case "avg":case "avg_angle":return"double";case "count":return"integer";case "min":case "max":case "sum":return a.onStatisticField?b.get(a.onStatisticField)?.type??null:a.onStatisticExpression?"string"===a.onStatisticExpression.returnType?null:"double":null;case "mode":return a.onStatisticField?b.get(a.onStatisticField)?.type??
null:a.onStatisticExpression?"string"===a.onStatisticExpression.returnType?"string":"double":null;default:return null}}function F(a,b){b&&(a.geometry=b.geometry,a.spatialRelationship=b.spatialRelationship)}function S(a,b,c,d,e,f,k){const l=[],g=b.length;for(let m=0;m<g;m++){const t=w.mergeWhereClauses(d,w.mergeWhereClauses(c+" \x3e\x3d "+b[m][0],null!==b[m][1]?c+(m===g-1?" \x3c\x3d ":" \x3c ")+b[m][1]:""));l.push(t)}return G.eachAlways(l.map(m=>a.queryFeatureCount({whereClause:m,view:e,filter:f,signal:k})))}
const T=/_value$/i,R=Math.LOG10E;n.defaultNumBins=10;n.ensureFeaturesJSON=function(a){return a.map(b=>b.toJSON())};n.generateBinParams=function(a){const b=[],c=a.classBreaks,d=c[0].minValue,e=c[c.length-1].maxValue;c.forEach(f=>{b.push([f.minValue,f.maxValue])});return{min:d,max:e,intervals:b,sqlExpr:C({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};
n.getAggregateFieldType=K;n.getBins=function(a,b,c,d=10,e,f,k){const {min:l,max:g,normTotal:m,excludeZerosExpr:t}=b,p=b.intervals||x.getEqualIntervalBins(l,g,d);return S(a,p,b.sqlExpr||c,t,e,f,k).then(r=>({bins:r.map((u,q)=>({minValue:p[q][0],maxValue:p[q][1],count:u.value})),minValue:l,maxValue:g,normalizationTotal:m}))};n.getDomainsForFields=async function(a,b){if(!a.returnAllCodedValues)return[];const {field:c,field2:d,field3:e}=a;if(c&&!d)return(b=(a=c?b.getField(c):null)?b.getFieldDomain(a.name):
null)?[b]:[];const f=[];c&&(f.push(E(c,a,b)),d&&(f.push(E(d,a,b)),e&&f.push(E(e,a,b))));return Promise.all(f)};n.getFeatureReductionFields=function(a){const b="featureReduction"in a?a.featureReduction:null;return((null!=b&&"fields"in b?b.fields:null)??[]).map(c=>{const d=K(c,a.fieldsIndex);return d?new O({type:d,name:c.name,alias:c.alias}):null}).filter(M.isSome)};n.getFieldExpr=C;n.getHistogramFromFeatureSet=function(a,b,c,d,e){const f={};a&&a.features&&a.features.forEach(l=>{var g=l.attributes;
l=I(g,"countOFExpr");g=z(g,"countOFExpr");null!=l&&null!=g&&0!==l&&(f[l]=g)});const k=[];x.getEqualIntervalBins(b,c,d).forEach((l,g)=>{g=(g+1).toString();k.push({minValue:l[0],maxValue:l[1],count:f.hasOwnProperty(g)?f[g]:0})});return{bins:k,minValue:b,maxValue:c,normalizationTotal:e}};n.getMissingFields=function(a,b,c){const d=[];if(b)for(const e of b)(b=a.getField(e))&&c&&"availableFields"in c&&!c.availableFields?.includes(b.name)&&d.push(b.name);return d};n.getMissingFieldsForBinning=function(a,
b){const c=[];a=a.layer;a="featureReduction"in a?a.featureReduction:null;const d=null!=a&&"fields"in a?a.fields?.map(e=>e.name?.toLowerCase()).filter(Boolean):[];if("binning"!==a?.type||!b)return c;for(const e of b)d.includes(e.toLowerCase())||c.push(e);return c};n.getPredominantCategoriesFromUVInfos=function(a,b){const c=a.map(e=>e.value),d=b.filter(e=>!c.includes(e));for(const e of d)a.push({value:e,count:0});a.sort((e,f)=>b.indexOf(e.value)-b.indexOf(f.value));for(const e of a)e.value===Q.noDominantCategoryField&&
(e.value=null);return{predominantCategoryInfos:a}};n.getSummaryStatisticsFromFeatureSet=function(a,b){a=a&&a.features;if(0===a?.length)return{avg:null,count:0,max:null,median:null,min:null,nullcount:0,stddev:null,sum:null,variance:null};a=a?.[0]?.attributes;const c={};for(const d in a)c[d.replace(T,"").toLowerCase()]=a[d];null!=c.totalcount&&c.totalcount>=c.count&&(c.nullcount=c.totalcount-c.count);delete c.totalcount;c.min===c.max&&null!=c.min&&null==c.stddev&&(c.stddev=c.variance=0);b&&("min max avg stddev sum variance".split(" ").forEach(d=>
{null!=c[d]&&(c[d]=Math.ceil(c[d]))}),c.min===c.max&&null!=c.min&&(c.avg=c.min,c.stddev=c.variance=0));return c};n.getSummaryStatsQuery=function(a,b,c){const {field:d,normalizationType:e,normalizationField:f,normalizationTotal:k,minValue:l,maxValue:g,filter:m}=b;c=a.supportsSQLExpression&&c?J(a,d):b.sqlExpression;var t=C({field:d,normalizationType:e,normalizationField:f,normalizationTotal:k,layer:a});const p=c||t;t=p?w.getRangeExpr(p,l,g):null;var r=w.getSQLFilterForNormalization({field:d,normalizationField:f,
normalizationType:e});b=w.mergeWhereClauses(b.sqlWhere,r);b=w.mergeWhereClauses(b,t);const u=x.isNullCountSupported({normalizationField:f,normalizationType:e,sqlExpression:c,supportsSQLExpression:a.supportsSQLExpression,minValue:l,maxValue:g}),q=P.isStringField(a.getField(d??void 0));t=x.statisticTypes.filter(h=>"nullcount"===h?u:q?"count"===h:!0);r=a.createQuery();r.where=w.mergeWhereClauses(r.where,b);r.sqlFormat=c?"standard":null;r.outStatistics=t.map(h=>{const v=new H;let A=null,B=null,L=`${h}_value`;
"variance"===h?(A="var",B=p):"nullcount"===h?(A="count",B=a.objectIdField,L="totalcount_value"):"median"===h?(A="percentile-continuous",B=p,v.statisticParameters={value:.5}):(A=h,B=p);v.statisticType=A;v.onStatisticField=B;v.outStatisticFieldName=L;return v});F(r,m);return r};n.getUVQuery=function(a,b){const {field:c,field2:d,field3:e,sqlExpression:f}=b;var k=!(!c||!d);a=a.createQuery();a.where=w.mergeWhereClauses(a.where,b.sqlWhere);a.sqlFormat=f?"standard":null;var l=k?null:c;k=k?"1":f;const g=
"countOF"+(l||"Expr"),m=new H;m.statisticType="count";m.onStatisticField=k?"1":l;m.outStatisticFieldName=g;a.outStatistics=[m].filter(Boolean);a.groupByFieldsForStatistics=[c||f,d,e].filter(Boolean);F(a,b.filter);return a};n.getUniqueValuesFromFeatureSet=function(a,b){a=a&&a.features;const {field:c,field2:d,field3:e,fieldDelimiter:f,layer:k,view:l,signal:g,labels:m}=b,t=`countOF${c&&d?"Expr":c||"Expr"}`,p={};let r=!1;a.forEach(u=>{var q=u.attributes;u=z(q,t);var h=c?z(q,c):I(q,t);let v=d?z(q,d):null;
q=e?z(q,e):null;null===h&&0===u&&(r=!0);if(null==h||"string"===typeof h&&""===h.trim())h=null;d&&(null==v||"string"===typeof v&&""===v.trim())&&(v=null);e&&(null==q||"string"===typeof q&&""===q.trim())&&(q=null);d&&(h=`${x.processNullValue(h)}${f}${x.processNullValue(v)}`,e&&(h=`${h}${f}${x.processNullValue(q)}`));null==p[h]?p[h]={count:u,data:h}:p[h].count+=u});return c&&r?k.queryFeatureCount({whereClause:c+" is NULL",view:l,signal:g}).then(u=>{p["null"].count+=u||0;return D(p,m)}).catch(()=>{G.throwIfAborted(g);
return D(p,m)}):Promise.resolve(D(p,m))};n.getViewInfoParams=function(a){return{viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference?.toJSON()}};n.msSinceUnixEpochSQL=J;n.updateQueryWithFeatureFilter=F;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
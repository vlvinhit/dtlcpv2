// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../core/CircularArray ./geohashUtils ../geometry/SpatialReference ../layers/graphics/featureConversionUtils ../layers/graphics/OptimizedGeometry ../layers/graphics/data/projectionSupport ../views/2d/layers/features/support/FeatureSetReaderJSON".split(" "),function(I,J,P,Q,K,F,G,L,M){let R=function(){function A(b=[],a,e=8096){this.onRelease=d=>{};this._nodes=0;this._root=new H(this,0,0,0);this._statisticFields=b;this._pool=e?new P(8096):null;this._serviceInfo=
a}var r=A.prototype;r.destroy=function(){this.clear()};r._acquire=function(b,a,e){this._nodes++;let d=null;null!=this._pool&&(d=this._pool.dequeue());null!=d?d.realloc(b,a,e):d=new H(this,b,a,e);return d};r._release=function(b){this.onRelease(b);this._nodes--;null!=this._pool&&this._pool.enqueue(b)};r.dropLevels=function(b){this.forEach(a=>{if(a.depth>=b)for(let e=0;e<a.children.length;e++){const d=a.children[e];d&&this._release(d)}});this.forEach(a=>{if(a.depth>=b)for(let e=0;e<a.children.length;e++)a.children[e]=
null})};r.clear=function(){this.forEach(b=>this._release(b));this._root=new H(this,0,0,0)};r.insert=function(b,a,e=0){const d=M.FeatureSetReaderJSON.fromOptimizedFeatures([b],this._serviceInfo).getCursor();d.next();const g=d.readGeometry();if(g){var [f,c]=g.coords;this.insertCursor(d,b.displayId,f,c,b.geohashX,b.geohashY,a,e)}};r.insertCursor=function(b,a,e,d,g,f,c,m=0){let h=this._root,l=0,n=0,t=0;for(;null!==h;){h.depth>=m&&(h.count+=1,h.xTotal+=e,h.yTotal+=d,h.xGeohashTotal+=g,h.yGeohashTotal+=
f,h.referenceId=a,this._updateStatisticsCursor(b,h,1));if(l>=c){h.add(a);break}var q=Math.ceil((l+1)/2),k=Math.floor((l+1)/2);const u=1-l%2;var p=30-(3*q+2*k);q=30-(2*q+3*k);p=(g&7*u+3*(1-u)<<p)>>p;q=(f&3*u+7*(1-u)<<q)>>q;k=p+q*(8*u+4*(1-u));const v=2*u+3*(1-u);n=n<<3*u+2*(1-u)|p;t=t<<v|q;null==h.children[k]&&(h.children[k]=this._acquire(n,t,l+1));l+=1;h=h.children[k]}};r.remove=function(b,a){const e=M.FeatureSetReaderJSON.fromOptimizedFeatures([b],this._serviceInfo).getCursor();e.next();const d=
e.readGeometry();if(d){var [g,f]=d.coords;this.removeCursor(e,g,f,b.geohashX,b.geohashY,a)}};r.removeCursor=function(b,a,e,d,g,f){let c=this._root,m=0;for(;null!==c;){--c.count;c.xTotal-=a;c.yTotal-=e;c.xGeohashTotal-=d;c.yGeohashTotal-=g;this._updateStatisticsCursor(b,c,-1);if(m>=f){c.remove(b.getDisplayId());break}var h=Math.ceil((m+1)/2);const t=Math.floor((m+1)/2);var l=1-m%2,n=30-(3*h+2*t);h=30-(2*h+3*t);l=((d&7*l+3*(1-l)<<n)>>n)+((g&3*l+7*(1-l)<<h)>>h)*(8*l+4*(1-l));n=c.children[l];1===n?.count&&
(this._release(n),c.children[l]=null);m+=1;c=n}};r.forEach=function(b){let a=this._root;for(;null!==a;){const e=this._linkChildren(a)||a.next;b(a);a=e}};r.find=function(b,a,e){return this._root.find(b,a,e,0,0,0)};r.findIf=function(b){let a=null;this.forEach(e=>{b(e)&&(a=e)});return a};r.findAllIf=function(b){const a=[];this.forEach(e=>{b(e)&&a.push(e)});return a};r.findSingleOccupancyNode=function(b,a,e,d,g){let f=this._root;for(;null!==f;){var c=f.depth,m=f.xNode,h=f.yNode;const p=1-c%2;var l=f.xGeohashTotal/
f.count,n=f.yGeohashTotal/f.count;if(1===f.count&&b<l&&l<=e&&a<n&&n<=d)return f;if(c>=g)f=f.next;else{n=Math.ceil((c+1)/2);c=Math.floor((c+1)/2);l=30-(3*n+2*c);var t=30-(2*n+3*c),q=~((1<<l)-1),k=~((1<<t)-1);m<<=3*p+2*(1-p);h<<=2*p+3*(1-p);c=Math.max(m,(b&q)>>l);n=Math.max(h,(a&k)>>t);l=Math.min(m+8*p+4*(1-p),(e&q)>>l);t=Math.min(h+4*p+8*(1-p),(d&k)>>t);for(q=k=null;n<=t;n++)for(let u=c;u<=l;u++){const v=f.children[u-m+(n-h)*(8*p+4*(1-p))];v&&(k||(k=v,k.next=f.next),q&&(q.next=v),q=v,v.next=f.next)}f=
k||f.next}}return null};r.getRegionDisplayIds=function(b){let a=this._root;const {bounds:e,geohashBounds:d,level:g}=b,[f,c,m,h]=e,l=[];for(;null!==a;){b=a.depth;var n=a.xNode,t=a.yNode;if(b>=g)b=a.xTotal/a.count,n=a.yTotal/a.count,b>=f&&b<=m&&n>=c&&n<=h&&a.displayIds.forEach(y=>l.push(y)),a=a.next;else{var q=Math.ceil((b+1)/2),k=Math.floor((b+1)/2);b=1-b%2;var p=30-(3*q+2*k),u=30-(2*q+3*k),v=~((1<<p)-1),w=~((1<<u)-1);n<<=3*b+2*(1-b);t<<=2*b+3*(1-b);q=Math.max(n,(d.xLL&v)>>p);k=Math.max(t,(d.yLL&w)>>
u);p=Math.min(n+8*b+4*(1-b),(d.xTR&v)>>p);u=Math.min(t+4*b+8*(1-b),(d.yTR&w)>>u);for(v=w=null;k<=u;k++)for(let y=q;y<=p;y++){const z=a.children[y-n+(k-t)*(8*b+4*(1-b))];z&&(w||(w=z,w.next=a.next),v&&(v.next=z),v=z,z.next=a.next)}a=w||a.next}}return l};r.getRegionStatistics=function(b){var a=this._root;let e=0,d=0,g=0;const f={},{bounds:c,geohashBounds:m,level:h}=b,[l,n,t,q]=c;for(b=0;null!==a;){var k=a.depth,p=a.xNode,u=a.yNode;if(k>=h)k=a.xTotal/a.count,p=a.yTotal/a.count,k>l&&k<=t&&p>n&&p<=q&&(e+=
a.count,d+=a.xTotal,g+=a.yTotal,1===a.count&&(b=a.referenceId),this._aggregateStatistics(f,a.statistics)),a=a.next;else{var v=Math.ceil((k+1)/2),w=Math.floor((k+1)/2);k=1-k%2;var y=30-(3*v+2*w),z=30-(2*v+3*w),C=~((1<<y)-1),B=~((1<<z)-1);p<<=3*k+2*(1-k);u<<=2*k+3*(1-k);v=Math.max(p,(m.xLL&C)>>y);w=Math.max(u,(m.yLL&B)>>z);y=Math.min(p+8*k+4*(1-k),(m.xTR&C)>>y);z=Math.min(u+4*k+8*(1-k),(m.yTR&B)>>z);C=B=null;for(let D=w;D<=z;D++)for(let E=v;E<=y;E++){const x=a.children[E-p+(D-u)*(8*k+4*(1-k))];if(x)if(D!==
w&&D!==z&&E!==v&&E!==y){const N=x.xTotal/x.count,O=x.yTotal/x.count;N>l&&N<=t&&O>n&&O<=q&&(e+=x.count,d+=x.xTotal,g+=x.yTotal,1===x.count&&(b=x.referenceId),this._aggregateStatistics(f,x.statistics))}else B||(B=x,B.next=a.next),C&&(C.next=x),C=x,x.next=a.next}a=B||a.next}}a=this.normalizeStatistics(f,e);return{count:e,attributes:a,xTotal:d,yTotal:g,referenceId:b}};r.getBins=function(b){const a=[],{geohashBounds:e,level:d}=b;for(b=this._root;null!==b;){var g=b.depth,f=b.xNode,c=b.yNode;if(g>=d)a.push(b),
b=b.next;else{var m=Math.ceil((g+1)/2),h=Math.floor((g+1)/2);g=1-g%2;var l=30-(3*m+2*h),n=30-(2*m+3*h),t=~((1<<l)-1),q=~((1<<n)-1);f<<=3*g+2*(1-g);c<<=2*g+3*(1-g);m=Math.max(f,(e.xLL&t)>>l);h=Math.max(c,(e.yLL&q)>>n);l=Math.min(f+8*g+4*(1-g),(e.xTR&t)>>l);n=Math.min(c+4*g+8*(1-g),(e.yTR&q)>>n);for(t=q=null;h<=n;h++)for(let k=m;k<=l;k++){const p=b.children[k-f+(h-c)*(8*g+4*(1-g))];p&&(q||(q=p,q.next=b.next),t&&(t.next=p),t=p,p.next=b.next)}b=q||b.next}}return a};r._linkChildren=function(b){let a=null,
e=null;for(let d=0;d<=b.children.length;d++){const g=b.children[d];g&&(a||(a=g,a.next=b.next),e&&(e.next=g),e=g,g.next=b.next)}return a};r._updateStatisticsCursor=function(b,a,e){for(const f of this._statisticFields){const c=f.name,m=f.inField?b.readAttribute(f.inField):b.getComputedNumericAtIndex(f.inFieldIndex);switch(f.statisticType){case "min":if(isNaN(m))break;if(!a.statistics[c]){a.statistics[c]={value:m};break}a.statistics[c].value=Math.min(a.statistics[c].value,m);break;case "max":if(isNaN(m))break;
if(!a.statistics[c]){a.statistics[c]={value:m};break}a.statistics[c].value=Math.max(a.statistics[c].value,m);break;case "sum":case "avg":a.statistics[c]||(a.statistics[c]={value:0,nanCount:0});var d=a.statistics[c].value,g=a.statistics[c].nanCount??0;null==m||isNaN(m)?a.statistics[c].nanCount=g+e:a.statistics[c].value=d+e*m;break;case "avg_angle":a.statistics[c]||(a.statistics[c]={x:0,y:0,nanCount:0});d=a.statistics[c].x;g=a.statistics[c].y;const h=a.statistics[c].nanCount??0,l=Math.PI/180;null==
m||isNaN(m)?a.statistics[c].nanCount=h+e:(a.statistics[c].x=d+e*Math.cos(m*l),a.statistics[c].y=g+e*Math.sin(m*l));break;case "mode":a.statistics[c]||(a.statistics[c]={}),a.statistics[c][m]=(a.statistics[c][m]||0)+e}}};r._aggregateStatistics=function(b,a){for(const e of this._statisticFields){const d=e.name;switch(e.statisticType){case "min":if(!b[d]){b[d]={value:a[d].value};break}b[d].value=Math.min(b[d].value,a[d].value);break;case "max":if(!b[d]){b[d]={value:a[d].value};break}b[d].value=Math.max(b[d].value,
a[d].value);break;case "sum":case "avg":case "avg_angle":case "mode":b[d]||(b[d]={});for(const g in a[d])b[d][g]=(b[d][g]||0)+a[d][g]}}};r.normalizeStatistics=function(b,a){const e={};for(const g of this._statisticFields){const f=g.name;switch(g.statisticType){case "min":case "max":var d=b[f];if(!a||!d)break;e[f]=d.value;break;case "count":if(!a)break;e[f]=a;break;case "sum":if(!a)break;const {value:c,nanCount:m}=b[f];if(!(a-m))break;e[f]=c;break;case "avg":if(!a)break;const {value:h,nanCount:l}=
b[f];if(!(a-l))break;e[f]=h/(a-l);break;case "avg_angle":if(!a)break;const {x:n,y:t,nanCount:q}=b[f];if(!(a-q))break;e[f]=180/Math.PI*Math.atan2(t/(a-q),n/(a-q));break;case "mode":d=b[f];let k=0,p=0,u=null;for(const v in d){const w=d[v];w===k?p+=1:w>k&&(k=w,p=1,u=v)}e[f]="null"===u||1<p?null:u}}return e};J._createClass(A,[{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return this._pool?.size??0}},{key:"depth",get:function(){let b=
0;this.forEach(a=>b=Math.max(b,a.depth));return b}}]);return A}(),H=function(){function A(b,a,e,d){this.yTotal=this.xTotal=this.count=0;this.statistics={};this.referenceId=this.displayId=0;this.displayIds=new Set;this.next=null;this.yGeohashTotal=this.xGeohashTotal=this.yNode=this.xNode=this.depth=0;this._tree=b;this.children=Array(32);for(b=0;b<this.children.length;b++)this.children[b]=null;this.xNode=a;this.yNode=e;this.depth=d}var r=A.prototype;r.realloc=function(b,a,e){for(let d=0;d<this.children.length;d++)this.children[d]=
null;this.xNode=b;this.yNode=a;this.depth=e;this.next=null;this.count=this.yTotal=this.xTotal=this.referenceId=this.displayId=this.yGeohashTotal=this.xGeohashTotal=0;this.statistics={};this.displayIds.clear();return this};r.add=function(b){this.displayIds.add(b)};r.remove=function(b){this.displayIds.delete(b)};r.getAttributes=function(){const b=this._tree.normalizeStatistics(this.statistics,this.count);b.referenceId=null;b.aggregateId=this.id;b.aggregateCount=this.count;return b};r.getGeometry=function(b,
a){const e=this.getLngLatBounds(),[d,g,f,c]=e;b=L.project({rings:[[[d,g],[d,c],[f,c],[f,g],[d,g]]]},K.WGS84,b);b=F.convertFromPolygon(new G,b,!1,!1);return null!=a?F.quantizeOptimizedGeometry(new G,b,!1,!1,"esriGeometryPolygon",a,!1,!1):b};r.getGeometryCentroid=function(b,a){const e=this.getLngLatBounds(),[d,g,f,c]=e;b=L.project({x:(d+f)/2,y:(g+c)/2},K.WGS84,b);b=F.convertFromPoint(new G,b);return null!=a?F.quantizeOptimizedGeometry(new G,b,!1,!1,"esriGeometryPoint",a,!1,!1):b};r.getLngLatBounds=
function(){var b=this.depth;const a=Math.ceil(b/2);b=Math.floor(b/2);return Q.decodeGeohashXY({geohashX:this.xNode<<30-(3*a+2*b),geohashY:this.yNode<<30-(2*a+3*b)},this.depth)};r.find=function(b,a,e,d,g,f){if(d>=e)return this;var c=1-d%2;const m=3*c+2*(1-c),h=2*c+3*(1-c),l=30-g-m,n=30-f-h;c=this.children[((b&7*c+3*(1-c)<<l)>>l)+((a&3*c+7*(1-c)<<n)>>n)*(8*c+4*(1-c))];return null==c?null:c.find(b,a,e,d+1,g+m,f+h)};J._createClass(A,[{key:"id",get:function(){return`${this.xNode}.${this.yNode}`}}]);return A}();
I.GeohashNode=H;I.GeohashTree=R;Object.defineProperty(I,Symbol.toStringTag,{value:"Module"})});
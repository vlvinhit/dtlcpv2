// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../Color ../../core/fontUtils ../../core/lang ../../core/Logger ../../core/screenUtils ../../core/string ../../support/arcadeOnDemand ./CIMSymbolDrawHelper ./CIMSymbolHelper ./enums ./quantizeTime ./SDFHelper ./utils ./effects/CIMEffectHelper ../../views/2d/arcade/callExpressionWithFeature ../../views/2d/engine/webgl/definitions ../../views/2d/engine/webgl/grouping".split(" "),function(aa,ka,la,ma,X,ba,ha,D,S,K,L,M,na,Y,h,ia,V,oa,pa){function ca(x){switch(x){case "Butt":return M.CapType.BUTT;
case "Square":return M.CapType.SQUARE;default:return M.CapType.ROUND}}function da(x){switch(x){case "Bevel":return M.JoinType.BEVEL;case "Miter":return M.JoinType.MITER;default:return M.JoinType.ROUND}}function ea(x){return x&&0===x.indexOf("Level_")&&(x=parseInt(x.substr(6),10),!isNaN(x))?x:0}function I(x){if(!x||0===x.length)return null;x=(new la(x)).toRgba();return{r:x[0],g:x[1],b:x[2],a:x[3]}}function fa(x){return x?x.charAt(0).toLowerCase()+x.substr(1):x}const qa=ba.getLogger("esri.symbols.cim.cimAnalyzer");
ba=function(){function x(a,e){this._cimLayers=[];this._poMap={};this._primitiveOverrides=[];this._resourceManager=a;this._info=e}var w=x.prototype;w.analyzeSymbolReference=async function(a,e,c){this._cimLayers=c??[];if(!a)return this._cimLayers;if(a.primitiveOverrides){this._primitiveOverrides=a.primitiveOverrides;this._poMap={};c=[];const b=this._info;for(const d of this._primitiveOverrides){var g=d.valueExpressionInfo;g&&b?(g=S.createRendererExpression(g.expression,b.spatialReference,b.fields).then(k=>
{null!=k&&this._setPoMap(d.primitiveName,d.propertyName,k)}),c.push(g)):null!=d.value&&this._setPoMap(d.primitiveName,d.propertyName,d.value);0<c.length&&await Promise.all(c)}}a=a.symbol;c=[];L.CIMSymbolHelper.fetchResources(a,this._resourceManager,c);0<c.length&&await Promise.all(c);this._analyzeSymbol(a,e);return this._cimLayers};w._analyzeSymbol=function(a,e){switch(a?.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":this._analyzeMultiLayerSymbol(a,e,1,0,0,0)}};w._analyzeMultiLayerSymbol=
function(a,e,c,g,b,d){const k=a?.symbolLayers;if(k){var f=a.effects,l=M.Alignment.SCREEN,q=L.CIMSymbolHelper.getSize(a)??0;"CIMPointSymbol"===a.type&&"Map"===a.angleAlignment&&(l=M.Alignment.MAP);for(var r="CIMPolygonSymbol"===a.type,n=k.length;n--;){const t=k[n];if(!t||!1===t.enable)continue;let p;f&&f.length&&(p=[...f]);var m=t.effects;m&&m.length&&(f?p.push(...m):p=[...m]);m=[];L.OverrideHelper.findEffectOverrides(p,this._primitiveOverrides,m);m=0<m.length?this._createEffectsOverrideFunction(p,
m):p;L.OverrideHelper.findApplicableOverrides(t,this._primitiveOverrides,[]);switch(t.type){case "CIMSolidFill":this._analyzeSolidFill(t,m);break;case "CIMPictureFill":this._analyzePictureFill(t,m);break;case "CIMHatchFill":this._analyzeHatchFill(t,m);break;case "CIMGradientFill":this._analyzeGradientFill(t,m);break;case "CIMSolidStroke":this._analyzeSolidStroke(t,m,r,q);break;case "CIMPictureStroke":this._analyzePictureStroke(t,m,r,q);break;case "CIMGradientStroke":this._analyzeGradientStroke(t,
m,r,q);break;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":"CIMLineSymbol"===a.type&&(l=(l=t.markerPlacement)&&l.angleToLine?M.Alignment.MAP:M.Alignment.SCREEN);const u=[],v=t.primitiveName;v&&u.push(v);this._analyzeMarker(t,m,null,u,l,q,1,e,c,g,b,d);break;default:qa.error("Cannot analyze CIM layer",t.type)}}}};w._analyzeSolidFill=function(a,e){const c=a.primitiveName,g=h.fromCIMColor(a.color),[b,d]=this._analyzePrimitiveOverrides(c,e,null,null),k=D.numericHash(JSON.stringify(a)+
d).toString();this._cimLayers.push({type:"fill",templateHash:k,materialHash:b?()=>k:k,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,color:this._createOverrideFunction(c,"Color",g,I),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e,applyRandomOffset:!1,sampleAlphaOnly:!0})};w._analyzePictureFill=function(a,e){const c=a.primitiveName,g=h.getTintColor(a),[b,d]=this._analyzePrimitiveOverrides(c,e,null,null),k=D.numericHash(JSON.stringify(a)+d).toString(),f=D.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString(),
l=h.getValue(a.height,K.DEFAULT_PICTURE_FILL_HEIGHT);let q=h.getValue(a.scaleX,1);if("width"in a&&"number"===typeof a.width){const r=a.width;let n=1;const m=this._resourceManager.getResource(a.url);null!=m&&(n=m.width/m.height);q/=l/r*n}this._cimLayers.push({type:"fill",templateHash:k,materialHash:b?()=>f:f,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,effects:e,color:this._createOverrideFunction(c,"TintColor",g,I),height:this._createOverrideFunction(c,"Height",l),scaleX:this._createOverrideFunction(c,
"ScaleX",q),angle:this._createOverrideFunction(c,"Rotation",h.getValue(a.rotation)),offsetX:this._createOverrideFunction(c,"OffsetX",h.getValue(a.offsetX)),offsetY:this._createOverrideFunction(c,"OffsetY",h.getValue(a.offsetY)),url:a.url,applyRandomOffset:!1,sampleAlphaOnly:!1})};w._analyzeHatchFill=function(a,e){const c=a.primitiveName,g=this._analyzeMaterialOverrides(c,["Rotation","OffsetX","OffsetY"]);let [b,d]=this._analyzePrimitiveOverrides(c,e,null,null);const k=D.numericHash(JSON.stringify(a)+
d).toString(),f=D.numericHash(`${a.separation}${JSON.stringify(a.lineSymbol)}`).toString();let l={r:255,g:255,b:255,a:1};var q=!1;const r=a.lineSymbol?.symbolLayers?.find(n=>"CIMSolidStroke"===n.type&&null!=this._poMap[n.primitiveName]?.Color);r&&(l=h.fromCIMColor(r.color),l=this._createOverrideFunction(r.primitiveName,"Color",l,I),q="function"===typeof l,b=b||q,q=null!=r.color||q);this._cimLayers.push({type:"fill",templateHash:k,materialHash:b&&g?this._createMaterialHashFunction(f,g):f,cim:a,materialOverrides:g,
colorLocked:!!a.colorLocked,effects:e,color:l,height:this._createOverrideFunction(c,"Separation",h.getValue(a.separation,K.DEFAULT_HATCH_FILL_SEPARATION)),scaleX:1,angle:this._createOverrideFunction(c,"Rotation",h.getValue(a.rotation)),offsetX:this._createOverrideFunction(c,"OffsetX",h.getValue(a.offsetX)),offsetY:this._createOverrideFunction(c,"OffsetY",h.getValue(a.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!q})};w._analyzeGradientFill=function(a,e){const [c,
g]=this._analyzePrimitiveOverrides(a.primitiveName,e,null,null),b=D.numericHash(JSON.stringify(a)+g).toString();this._cimLayers.push({type:"fill",templateHash:b,materialHash:c?()=>b:b,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked,effects:e,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})};w._analyzeSolidStroke=function(a,e,c,g){const b=a.primitiveName,d=h.fromCIMColor(a.color),k=h.getValue(a.width,K.DEFAULT_STROKE_WIDTH),
f=ca(a.capStyle),l=da(a.joinStyle),q=a.miterLimit,[r,n]=this._analyzePrimitiveOverrides(b,e,null,null),m=D.numericHash(JSON.stringify(a)+n).toString();let t;if(e&&e instanceof Array&&0<e.length){const u=e[e.length-1];if("CIMGeometricEffectDashes"===u.type&&"NoConstraint"===u.lineDashEnding&&null===u.offsetAlongLine){e=[...e];var p=e.pop();t=p.dashTemplate;p=p.scaleDash}}this._cimLayers.push({type:"line",templateHash:m,materialHash:r?()=>m:m,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,
effects:e,color:this._createOverrideFunction(b,"Color",d,I),width:this._createOverrideFunction(b,"Width",k),cap:this._createOverrideFunction(b,"CapStyle",f),join:this._createOverrideFunction(b,"JoinStyle",l),miterLimit:q&&this._createOverrideFunction(b,"MiterLimit",q),referenceWidth:g,zOrder:ea(a.name),dashTemplate:t,scaleDash:p,sampleAlphaOnly:!0})};w._analyzePictureStroke=function(a,e,c,g){const b=D.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}`).toString(),d=a.primitiveName,k=h.getTintColor(a),
f=h.getValue(a.width,K.DEFAULT_STROKE_WIDTH),l=ca(a.capStyle),q=da(a.joinStyle),r=a.miterLimit,[n,m]=this._analyzePrimitiveOverrides(d,e,null,null),t=D.numericHash(JSON.stringify(a)+m).toString();this._cimLayers.push({type:"line",templateHash:t,materialHash:n?()=>b:b,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,effects:e,color:this._createOverrideFunction(d,"TintColor",k,I),width:this._createOverrideFunction(d,"Width",f),cap:this._createOverrideFunction(d,"CapStyle",l),join:this._createOverrideFunction(d,
"JoinStyle",q),miterLimit:r&&this._createOverrideFunction(d,"MiterLimit",r),referenceWidth:g,zOrder:ea(a.name),dashTemplate:null,scaleDash:!1,url:a.url,sampleAlphaOnly:!1})};w._analyzeGradientStroke=function(a,e,c,g){const b=a.primitiveName,d=h.getValue(a.width,K.DEFAULT_STROKE_WIDTH),k=ca(a.capStyle),f=da(a.joinStyle),l=a.miterLimit,[q,r]=this._analyzePrimitiveOverrides(b,e,null,null),n=D.numericHash(JSON.stringify(a)+r).toString();this._cimLayers.push({type:"line",templateHash:n,materialHash:q?
()=>n:n,cim:a,materialOverrides:null,isOutline:c,colorLocked:!!a.colorLocked,effects:e,color:{r:128,g:128,b:128,a:1},width:this._createOverrideFunction(b,"Width",d),cap:this._createOverrideFunction(b,"CapStyle",k),join:this._createOverrideFunction(b,"JoinStyle",f),miterLimit:l&&this._createOverrideFunction(b,"MiterLimit",l),referenceWidth:g,zOrder:ea(a.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})};w._analyzeMarker=function(a,e,c,g,b,d,k,f,l,q,r,n,m=!1){if(!this._analyzeMarkerInsidePolygon(a,
e)){l=h.getValue(a.size,K.DEFAULT_MARKER_SIZE);var t=h.getValue(a.rotation),p=h.getValue(a.offsetX),u=h.getValue(a.offsetY);l=this._createOverrideFunction(a.primitiveName,"Size",l);t=this._createOverrideFunction(a.primitiveName,"Rotation",t);p=this._createOverrideFunction(a.primitiveName,"OffsetX",p);u=this._createOverrideFunction(a.primitiveName,"OffsetY",u);l=this._transformSize(l,k);t=this._transformRotation(t,!!a.rotateClockwise,q);r=this._transformOffsetX(p,u,q,k,r);q=this._transformOffsetY(p,
u,q,k,n);p=r;u=q;switch(a.type){case "CIMPictureMarker":this._analyzePictureMarker(a,e,c,g,b,d,l,t,p,u,a.colorLocked||m);break;case "CIMVectorMarker":this._analyzeVectorMarker(a,e,c,g,b,d,k,f,l,t,p,u,a.colorLocked||m)}}};w._analyzeMarkerInsidePolygon=function(a,e){const {markerPlacement:c,type:g}=a;if(!c||"CIMMarkerPlacementInsidePolygon"!==c.type)return!1;if("CIMVectorMarker"===g||"CIMPictureMarker"===g){var b=a.primitiveName;if(b&&([b]=this._analyzePrimitiveOverrides([b],e,null,null),b))return!1;
if(b=c.primitiveName)if([b]=this._analyzePrimitiveOverrides([b],e,null,null),b)return!1;if("CIMVectorMarker"===g){if({markerGraphics:b}=a,b)for(var d of b)if({symbol:b}=d,"CIMPolygonSymbol"===b?.type&&b.symbolLayers){({symbolLayers:b}=b);for(var k of b)if("CIMSolidStroke"===k.type)return!1}}else if({animatedSymbolProperties:d}=a,d)return!1}var f=Math.abs(c.stepX),l=Math.abs(c.stepY);if(0===f||0===l)return!0;const q=["Rotation","OffsetX","OffsetY"];d=this._primitiveOverrides.filter(m=>m.primitiveName!==
a.primitiveName||!q.includes(m.propertyName));k="url"in a&&"string"===typeof a.url?a.url:void 0;b=D.numericHash(JSON.stringify(a)).toString();let r=null;if("Random"===c.gridType){var n=ha.px2pt(oa.RANDOM_INSIDE_POLYGON_TEXTURE_SIZE);const m=Math.max(Math.floor(n/f),1),t=Math.max(Math.floor(n/l),1);n=l*t;r=p=>p?p*t:0;f=m*f/n}else c.shiftOddRows?(n=2*l,r=m=>m?2*m:0,f=f/l*.5):(n=l,r=null,f/=l);l=h.getTintColor(a);this._cimLayers.push({type:"fill",templateHash:b,materialHash:b,cim:a,materialOverrides:d,
colorLocked:!!a.colorLocked,effects:e,color:l,height:this._createOverrideFunction(c.primitiveName,"StepY",n,r),scaleX:f,angle:c.gridAngle,offsetX:h.getValue(c.offsetX),offsetY:h.getValue(c.offsetY),url:k,applyRandomOffset:"Random"===c.gridType,sampleAlphaOnly:!k,hasUnresolvedReplacementColor:!0});return!0};w._analyzePictureMarker=function(a,e,c,g,b,d,k,f,l,q,r){let n=h.getValue(a.scaleX,1);const m=h.getTintColor(a),t=D.numericHash(`${a.url}${JSON.stringify(a.colorSubstitutions)}${JSON.stringify(a.animatedSymbolProperties)}`).toString();
c||(c=this._createMarkerPlacementOverrideFunction(a.markerPlacement));const p=this._createAnimatedSymbolPropertiesOverrideFunction(a.animatedSymbolProperties),[u,v]=this._analyzePrimitiveOverrides(g,e,c,p);g=D.numericHash(JSON.stringify(a)+v).toString();const y=a.anchorPoint??{x:0,y:0};if("width"in a&&"number"===typeof a.width){const z=a.width;let B=1;var A=this._resourceManager.getResource(a.url);null!=A&&(B=A.width/A.height);A=h.getValue(a.size);n/=A/z*B}this._cimLayers.push({type:"marker",templateHash:g,
materialHash:a.animatedSymbolProperties&&!0===a.animatedSymbolProperties.randomizeStartTime?(z,B,F,G)=>{F=pa.getMaterialGroup(G??0);z=null!=p?h.evaluateValueOrFunction(p,z,B):null;return t+`-MATERIALGROUP(${F})`+`-ASP(${JSON.stringify(z)})`}:u?(z,B)=>{z=null!=p?h.evaluateValueOrFunction(p,z,B):null;return t+`-ASP(${JSON.stringify(z)})`}:t,cim:a,materialOverrides:null,colorLocked:!!a.colorLocked||!!r,effects:e,scaleSymbolsProportionally:!1,alignment:b,size:k,scaleX:this._createOverrideFunction(a.primitiveName,
"ScaleX",n),rotation:f,offsetX:l,offsetY:q,color:this._createOverrideFunction(a.primitiveName,"TintColor",m,I),anchorPoint:{x:y.x,y:y.y},isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:!1,referenceSize:d,sizeRatio:1,markerPlacement:c,url:a.url,animatedSymbolProperties:p})};w._analyzeVectorMarker=function(a,e,c,g,b,d,k,f,l,q,r,n,m){var t=a.markerGraphics;if(t){var p=a.frame,u=0,v=1;a.scaleSymbolsProportionally&&p&&(u=
p.ymax-p.ymin,v=this._transformSize(l,1/u));v=this._transformSize(v,k);c||(c=this._createMarkerPlacementOverrideFunction(a.markerPlacement));for(const z of t)if(z&&(k=z.symbol)){(t=z.primitiveName)&&g.push(t);var y=r,A=n;if(("CIMPointSymbol"===k.type||"CIMTextSymbol"===k.type)&&p){let B=A=0;y=z.geometry;"x"in y&&"y"in y&&(A+=y.x-.5*(p.xmin+p.xmax),B+=y.y-.5*(p.ymin+p.ymax));if(y=a.anchorPoint)"Absolute"===a.anchorPointUnits?(A-=y.x,B-=y.y):p&&(A-=(p.xmax-p.xmin)*y.x,B-=(p.ymax-p.ymin)*y.y);y=this._transformOffsetX(A,
B,q,v,r);A=this._transformOffsetY(A,B,q,v,n)}switch(k.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":f?this._analyzeMultiLayerGraphicNonSDF(a,e,c,null,z,g,b,d,u,!!m||!!a.colorLocked):this._analyzeMultiLayerGraphic(a,e,c,null,z,g,b,d,u,v,l,q,y,A,!!m||!!a.colorLocked);break;case "CIMTextSymbol":this._analyzeTextGraphic(a,e,c,z,g,b,d,u,v,l,q,y,A,m)}t&&g.pop()}}};w._analyzeMultiLayerGraphic=function(a,e,c,g,b,d,k,f,l,q,r,n,m,t,p){var u=b.symbol;const v=u.symbolLayers;if(v){var y=
v.length;if(v&&2===v.length&&v[0].enable&&v[1].enable&&"CIMSolidStroke"===v[0].type&&"CIMSolidFill"===v[1].type&&!v[0].effects&&!v[1].effects)this._analyzeCompositeMarkerGraphic(a,e,c,g,b,v,d,k,f,l,r,n,m,t,!!p||!!a.colorLocked);else{var A=this._resourceManager.geometryEngine;if(u=ia.CIMEffectHelper.applyEffects(u.effects,b.geometry,A))for(;y--;){const C=v[y];if(!C||!1===C.enable)continue;const E=C.primitiveName;E&&d.push(E);switch(C.type){case "CIMSolidFill":case "CIMSolidStroke":var z=ia.CIMEffectHelper.applyEffects(C.effects,
u,A),B=Y.getExtent(z);if(!B)continue;const O="Relative"!==a.anchorPointUnits,[H,P,Q]=Y.getSDFMetrics(B,a.frame,a.size,a.anchorPoint,O);var F="CIMSolidFill"===C.type;z={type:"sdf",geom:z,asFill:F};B=C.path;const R=F?h.fromCIMColor(h.getFillColor(C)):h.fromCIMColor(h.getStrokeColor(C)),W=F?{r:0,g:0,b:0,a:0}:h.fromCIMColor(h.getStrokeColor(C)),T=h.getStrokeWidth(C)??0;if(!F&&!T)break;var G=b.primitiveName;let J=null;!F||C.colorLocked||p||(J=this._createOverrideFunction(G,"FillColor",R,I));F=null;C.colorLocked||
p||(F=this._createOverrideFunction(G,"StrokeColor",W,I));G=this._createOverrideFunction(G,"StrokeWidth",T);let Z=!1;var N="";for(const U of this._primitiveOverrides)d.includes(U.primitiveName)&&(null!=U.value?N+=`-${U.primitiveName}-${U.propertyName}-${JSON.stringify(U.value)}`:U.valueExpressionInfo&&(Z=!0));if(null!=e&&"function"===typeof e||null!=c&&"function"===typeof c)Z=!0;if(h.isFeatureValueFn(r)||h.isFeatureValueFn(n)||h.isFeatureValueFn(m)||h.isFeatureValueFn(t))Z=!0;const ra=JSON.stringify({...a,
markerGraphics:null}),ja=D.numericHash(JSON.stringify(z)+B).toString();N=D.numericHash(JSON.stringify(b)+JSON.stringify(C)+ra+N).toString();this._cimLayers.push({type:"marker",templateHash:N,materialHash:Z?()=>ja:ja,cim:z,materialOverrides:null,colorLocked:!!C.colorLocked||!!p,effects:e,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,alignment:k,anchorPoint:{x:P,y:Q},isAbsoluteAnchorPoint:O,size:r,rotation:n,offsetX:m,offsetY:t,scaleX:1,frameHeight:l,rotateClockwise:!1,referenceSize:f,sizeRatio:H,
color:h.isFeatureValueFn(J)?J:this._createOverrideFunction(E,"Color",R,I),outlineColor:h.isFeatureValueFn(F)?F:this._createOverrideFunction(E,"Color",W,I),outlineWidth:h.isFeatureValueFn(G)?G:this._createOverrideFunction(E,"Width",T),markerPlacement:c,animatedSymbolProperties:g,path:B});break;case "CIMVectorMarker":C.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(a,e,c,g,b,d,k,f,l,!!p||!!C.colorLocked):this._analyzeMarker(C,e,c,d,k,f,q,!1,r,n,m,t,!!p||!!a.colorLocked);break;default:this._analyzeMultiLayerGraphicNonSDF(a,
e,c,g,b,d,k,f,l,!!p||!!a.colorLocked)}E&&d.pop()}}}};w._analyzeTextGraphic=function(a,e,c,g,b,d,k,f,l,q,r,n,m,t){L.OverrideHelper.findApplicableOverrides(g,this._primitiveOverrides,[]);f=g.geometry;if("x"in f&&"y"in f){f=g.symbol;q=h.fromCIMFontDecoration(f);var p=h.fromCIMFontStyle(f.fontStyleName),u=ma.getFontFamily(f.fontFamilyName);f.font={family:u,decoration:q,...p};var v=h.getValue(f.height,K.DEFAULT_TEXT_HEIGHT),y=h.getValue(f.angle),A=h.getValue(f.offsetX),z=h.getValue(f.offsetY);v=this._transformSize(v,
l);y=this._transformRotation(y,!1,r);n=this._transformOffsetX(A,z,r,l,n);z=this._transformOffsetY(A,z,r,l,m);A=n;r=h.fromCIMColor(h.getFillColor(f));m=h.fromCIMColor(h.getStrokeColor(f));n=h.getStrokeWidth(f)??0;n||(m=h.fromCIMColor(h.getFillColor(f.haloSymbol)),n=h.getValue(f.haloSize));n=this._transformSize(n,l);var B=l=null,F=0;if(f.callout&&"CIMBackgroundCallout"===f.callout.type){var G=f.callout;if(G.backgroundSymbol&&(G=G.backgroundSymbol.symbolLayers))for(const H of G)"CIMSolidFill"===H.type?
l=h.fromCIMColor(H.color):"CIMSolidStroke"===H.type&&(B=h.fromCIMColor(H.color),F=h.getValue(H.width,K.DEFAULT_STROKE_WIDTH))}var [N,C]=this._analyzePrimitiveOverrides(b,e,c,null);b=JSON.stringify(a.effects)+Number(a.colorLocked||t).toString()+JSON.stringify(a.anchorPoint)+a.anchorPointUnits+JSON.stringify(a.markerPlacement)+a.size.toString();b=D.numericHash(JSON.stringify(g)+b+C).toString();var E=this._createOverrideFunction(g.primitiveName,"TextString",g.textString??"",h.adjustTextCase,f.textCase);
if(null!=E){({fontStyleName:g}=f);var O=u+(g?"-"+g.toLowerCase():"-regular");"string"===typeof E&&E.includes("[")&&f.fieldMap&&(E=h.createLabelOverrideFunction(f.fieldMap,E,f.textCase));this._cimLayers.push({type:"text",templateHash:b,materialHash:N||"function"===typeof E||/\[(.*?)\]/.test(E)?(H,P,Q)=>O+"-"+h.evaluateValueOrFunction(E,H,P,Q):O+"-"+D.numericHash(E),cim:f,materialOverrides:null,colorLocked:!!a.colorLocked||!!t,effects:e,alignment:d,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:"Relative"!==
a.anchorPointUnits,fontName:O,decoration:q,weight:p.weight,style:p.style,size:v,angle:y,offsetX:A,offsetY:z,horizontalAlignment:h.fromCIMHorizontalAlignment(f.horizontalAlignment),verticalAlignment:h.fromCIMVerticalAlignment(f.verticalAlignment),text:E,color:r,outlineColor:m,outlineSize:n,backgroundColor:l,borderLineColor:B,borderLineWidth:F,referenceSize:k,sizeRatio:1,markerPlacement:c})}}};w._analyzeMultiLayerGraphicNonSDF=function(a,e,c,g,b,d,k,f,l,q){b=this._buildSimpleMarker(a,b);const r=a.primitiveName,
n=this._analyzeMaterialOverrides(r,["Rotation","OffsetX","OffsetY"]);var [,m]=this._analyzePrimitiveOverrides(d,null,null,null);const [t,p,u]=L.CIMSymbolHelper.getTextureAnchor(b,this._resourceManager);d=h.getValue(a.rotation);const v=h.getValue(a.offsetX),y=h.getValue(a.offsetY);m=D.numericHash(JSON.stringify(b)+m).toString();this._cimLayers.push({type:"marker",templateHash:m,materialHash:(n&&0<n.length||null!=e&&"function"===typeof e)&&n?this._createMaterialHashFunction(m,n):m,cim:b,materialOverrides:n,
colorLocked:!!a.colorLocked||!!q,effects:e,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,alignment:k,anchorPoint:{x:t,y:p},isAbsoluteAnchorPoint:!1,size:h.getValue(a.size,K.DEFAULT_MARKER_SIZE),rotation:this._createOverrideFunction(r,"Rotation",d),offsetX:this._createOverrideFunction(r,"OffsetX",v),offsetY:this._createOverrideFunction(r,"OffsetY",y),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:l,rotateClockwise:!!a.rotateClockwise,referenceSize:f,
sizeRatio:u/ha.pt2px(a.size),markerPlacement:c,animatedSymbolProperties:g,avoidSDFRasterization:!0})};w._buildSimpleMarker=function(a,e){return{type:a.type,enable:!0,name:a.name,colorLocked:a.colorLocked,primitiveName:a.primitiveName,anchorPoint:a.anchorPoint,anchorPointUnits:a.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:a.rotateClockwise,rotation:0,size:a.size,billboardMode3D:a.billboardMode3D,depth3D:a.depth3D,frame:a.frame,markerGraphics:[e],scaleSymbolsProportionally:a.scaleSymbolsProportionally,
respectFrame:a.respectFrame,clippingPath:a.clippingPath}};w._analyzeCompositeMarkerGraphic=function(a,e,c,g,b,d,k,f,l,q,r,n,m,t,p){var u=b.geometry;const v=d[0],y=d[1];var A=Y.getExtent(u);if(A){d="Relative"!==a.anchorPointUnits;var [z,B,F]=Y.getSDFMetrics(A,a.frame,a.size,a.anchorPoint,d);u={type:"sdf",geom:u,asFill:!0};A=y.path;var G=y.primitiveName,N=v.primitiveName,C=h.fromCIMColor(y.color),E=h.fromCIMColor(v.color),O=h.getValue(v.width,K.DEFAULT_STROKE_WIDTH),H=b.primitiveName,P=null;y.colorLocked||
p||(P=this._createOverrideFunction(H,"FillColor",C,I));var Q=null;v.colorLocked||p||(Q=this._createOverrideFunction(H,"StrokeColor",E,I));H=this._createOverrideFunction(H,"StrokeWidth",O);var R=!1,W="";for(const J of this._primitiveOverrides)if(J.primitiveName===G||J.primitiveName===N||k.includes(J.primitiveName))null!=J.value?W+=`-${J.primitiveName}-${J.propertyName}-${JSON.stringify(J.value)}`:J.valueExpressionInfo&&(R=!0);null!=c&&"function"===typeof c&&(R=!0);if(h.isFeatureValueFn(r)||h.isFeatureValueFn(n)||
h.isFeatureValueFn(m)||h.isFeatureValueFn(t))R=!0;k=JSON.stringify({...a,markerGraphics:null});var T=D.numericHash(JSON.stringify(u)+A).toString();b=D.numericHash(JSON.stringify(b)+JSON.stringify(y)+JSON.stringify(v)+k+W).toString();this._cimLayers.push({type:"marker",templateHash:b,materialHash:R?()=>T:T,cim:u,materialOverrides:null,colorLocked:!!p,effects:e,scaleSymbolsProportionally:!!a.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:B,y:F},isAbsoluteAnchorPoint:d,size:r,rotation:n,offsetX:m,
offsetY:t,scaleX:1,frameHeight:q,rotateClockwise:!1,referenceSize:l,sizeRatio:z,color:h.isFeatureValueFn(P)?P:this._createOverrideFunction(G,"Color",C,I),outlineColor:h.isFeatureValueFn(Q)?Q:this._createOverrideFunction(N,"Color",E,I),outlineWidth:h.isFeatureValueFn(H)?H:this._createOverrideFunction(N,"Width",O),markerPlacement:c,path:A,animatedSymbolProperties:g})}};w._createMaterialHashFunction=function(a,e){const c=this._info?.geometryType;if(c){const g=this._poMap;for(const b of e)if(b.valueExpressionInfo){const d=
g[b.primitiveName]&&g[b.primitiveName][b.propertyName];d instanceof S.ArcadeExpression&&(b.fn=(k,f,l)=>V(d,k,{$view:l},c,f))}}return(g,b,d)=>{for(const k of e)k.fn&&(k.value=k.fn(g,b,d));return D.numericHash(a+L.OverrideHelper.buildOverrideKey(e)).toString()}};w._setPoMap=function(a,e,c){let g;this._poMap[a]?g=this._poMap[a]:(g={},this._poMap[a]=g);g[e]=c};w._createOverrideFunction=function(a,e,c,g,b){if(null==a)return c;a=this._poMap[a];if(null==a)return c;const d=a[e];if("string"===typeof d||"number"===
typeof d||d instanceof Array)return g?g.call(null,d,b):d;const k=this._info?.geometryType;return null!=d&&d instanceof S.ArcadeExpression&&null!=k?(f,l,q)=>{f=V(d,f,{$view:q},k,l);null!==f&&g&&(f=g.call(null,f,b));return null!==f?f:c}:c};w._createEffectsOverrideFunction=function(a,e){const c=this._poMap,g=this._info?.geometryType;for(const b of e)if(b.valueExpressionInfo&&g){const d=c[b.primitiveName]&&c[b.primitiveName][b.propertyName];d instanceof S.ArcadeExpression&&(b.fn=(k,f,l)=>V(d,k,{$view:l},
g,f))}return(b,d,k)=>{for(var f of e)f.fn&&(f.value=f.fn(b,d,k));b=[];for(let l of a){if(d=l?.primitiveName){k=!1;for(const q of e)q.primitiveName===d&&(f=fa(q.propertyName),null!=q.value&&q.value!==l[f]&&(k||(l=X.clone(l),k=!0),l[f]=q.value))}b.push(l)}return b}};w._createMarkerPlacementOverrideFunction=function(a){const e=[];L.OverrideHelper.findApplicableOverrides(a,this._primitiveOverrides,e);if(null==a||0===e.length)return a;const c=this._poMap,g=this._info?.geometryType;for(const b of e)if(b.valueExpressionInfo&&
g){const d=c[b.primitiveName]&&c[b.primitiveName][b.propertyName];d instanceof S.ArcadeExpression&&(b.fn=(k,f,l)=>V(d,k,{$view:l},g,f))}return(b,d,k)=>{for(const f of e)f.fn&&(f.value=f.fn(b,d,k));b=X.clone(a);d=a.primitiveName;for(const f of e)f.primitiveName===d&&(k=fa(f.propertyName),null!=f.value&&f.value!==b[k]&&(b[k]=f.value));return b}};w._createAnimatedSymbolPropertiesOverrideFunction=function(a){const e=[];L.OverrideHelper.findApplicableOverrides(a,this._primitiveOverrides,e);if(null==a||
0===e.length)return a;const c=this._info?.geometryType;if(c){const g=this._poMap;for(const b of e)if(b.valueExpressionInfo){const d=g[b.primitiveName]&&g[b.primitiveName][b.propertyName];d instanceof S.ArcadeExpression&&(b.fn=(k,f,l)=>V(d,k,{$view:l},c,f))}}return(g,b,d)=>{for(var k of e)k.fn&&(k.value=k.fn(g,b,d));g=X.clone(a);b=a.primitiveName;for(const f of e)f.primitiveName===b&&(d=fa(f.propertyName),null!=f.value&&(k=na.quantizeIfNeeded(f.value,f.propertyName),k!==g[d]&&(g[d]=k)));return g}};
w._analyzePrimitiveOverrides=function(a,e,c,g){let b=!1,d="";"string"===typeof a&&(a=[a]);for(const k of this._primitiveOverrides)a?.includes(k.primitiveName)&&(null!=k.value?d+=`-${k.primitiveName}-${k.propertyName}-${JSON.stringify(k.value)}`:k.valueExpressionInfo&&(b=!0));null!=e&&"function"===typeof e&&(b=!0);null!=c&&"function"===typeof c&&(b=!0);null!=g&&"function"===typeof g&&(b=!0);return[b,d]};w._analyzeMaterialOverrides=function(a,e){return this._primitiveOverrides.filter(c=>c.primitiveName!==
a||!e.includes(c.propertyName))};w._transformSize=function(a,e){return h.isFeatureValueFn(a)||h.isFeatureValueFn(e)?(c,g,b)=>{const d=h.isFeatureValueFn(a)?a(c,g,b):a;c=h.isFeatureValueFn(e)?e(c,g,b):e;return d*c}:a*e};w._transformRotation=function(a,e,c){return h.isFeatureValueFn(a)||h.isFeatureValueFn(c)?(g,b,d)=>{const k=h.isFeatureValueFn(a)?a(g,b,d):a;g=h.isFeatureValueFn(c)?c(g,b,d):c;return e?g-k:g+k}:e?c-a:c+a};w._transformOffsetX=function(a,e,c,g,b){if(!(h.isFeatureValueFn(a)||h.isFeatureValueFn(e)||
h.isFeatureValueFn(c)||h.isFeatureValueFn(g)||h.isFeatureValueFn(b))){const d=c*Math.PI/180;return d?(Math.cos(d)*a-Math.sin(d)*e)*g+b:a*g+b}return(d,k,f)=>{var l=h.isFeatureValueFn(c)?c(d,k,f):c;const q=h.isFeatureValueFn(g)?g(d,k,f):g,r=h.isFeatureValueFn(a)?a(d,k,f):a,n=h.isFeatureValueFn(b)?b(d,k,f):b;if(l){l*=Math.PI/180;const m=Math.cos(l);l=Math.sin(l);d=h.isFeatureValueFn(e)?e(d,k,f):e;return(m*r-l*d)*q+n}return r*q+n}};w._transformOffsetY=function(a,e,c,g,b){if(!(h.isFeatureValueFn(a)||h.isFeatureValueFn(e)||
h.isFeatureValueFn(c)||h.isFeatureValueFn(g)||h.isFeatureValueFn(b))){const d=c*Math.PI/180;return d?(Math.sin(d)*a+Math.cos(d)*e)*g+b:e*g+b}return(d,k,f)=>{var l=h.isFeatureValueFn(c)?c(d,k,f):c;const q=h.isFeatureValueFn(g)?g(d,k,f):g,r=h.isFeatureValueFn(e)?e(d,k,f):e,n=h.isFeatureValueFn(b)?b(d,k,f):b;if(l){l*=Math.PI/180;const m=Math.cos(l);l=Math.sin(l);d=h.isFeatureValueFn(a)?a(d,k,f):a;return(l*d+m*r)*q+n}return r*q+n}};return ka._createClass(x)}();aa.CIMAnalyzer=ba;aa.analyzeCIMResource=
function(x,w){if(!w||0===w.length)return x;x=X.clone(x);L.OverrideHelper.applyOverrides(x,w);return x};Object.defineProperty(aa,Symbol.toStringTag,{value:"Module"})});
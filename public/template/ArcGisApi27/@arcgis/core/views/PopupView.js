/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{c as p}from"../chunks/asyncUtils.js";import{a as s}from"../chunks/deprecate.js";import t from"../core/Error.js";import{L as i}from"../chunks/Logger.js";import{eachAlwaysValues as o,throwIfAborted as r}from"../core/promiseUtils.js";import{watch as a,initial as n,whenOnce as u}from"../core/reactiveUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/typedArrayUtil.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import{V as h}from"../chunks/InputManager.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../core/lang.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/Queue.js";import"../chunks/SimpleObservable.js";import"../chunks/PropertiesPool.js";import"../core/signal.js";function d(e){return null!=e&&"open"in e&&"declaredClass"in e}function m(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const y=y=>{let w=class extends y{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([a((()=>[this.ui,this.popup]),(([e,p],s)=>{const t="popup";if(s){const[e,p]=s;e&&d(p)&&(p.view=null,m(p)&&e.remove(p,t))}e&&d(p)&&(p.view=this,m(p)&&e.add(p,{key:t,position:"manual",internal:!0}))}),n),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(!d(this.popup)&&"autoOpenEnabled"in this.popup&&!1===this.popup.autoOpenEnabled||(d(this.popup)?this.popup.viewModel.handleViewClick(e):e.async((async()=>{await this.setupPopup(),d(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)}))))}),h.WIDGET)]),u((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{import("../widgets/Popup.js")}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){d(this.popup)&&this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void i.getLogger(this).error(new t("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),d(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,p){await this.when();const{location:s,queryArea:t,layerViewsAndGraphics:i,clientOnlyGraphics:r}=await this._prepareFetchPopupFeatures(e,p),a=Promise.resolve(r),n=this._queryLayerPopupFeatures(t,i,p),u=n.map((e=>e.promise));return{location:s,clientOnlyGraphics:r,allGraphicsPromise:o([a,...u]).then((e=>Array.from(new Set(e.flat())))),promisesPerLayerView:n}}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!d(this.popup))return this._popupSetupTask=p((async e=>{const{default:p}=await import("../widgets/Popup.js");if(r(e),!this.popup||d(this.popup))return;const s=this.popup;delete s.open,delete s.close,this.popup=new p(s)})),this._popupSetupTask.promise}_queryLayerPopupFeatures(e,p,s){return p.map((({layerView:p,graphics:t})=>{const i={clientGraphics:t,event:null!=s?s.event:void 0,signal:null!=s?s.signal:void 0,defaultPopupTemplateEnabled:null!=s&&!!s.defaultPopupTemplateEnabled},o=p.fetchPopupFeatures(e,i);return{layerView:p,promise:o}}))}_isValidPopupGraphic(e,p){return e&&!!e.getEffectivePopupTemplate(null!=p&&p.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(e,p){const{clientGraphics:s,queryArea:t,location:i}=await this._popupHitTestGraphics(e,p),o=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:r,clientOnlyGraphics:a}=this._graphicsPerFetchPopupLayerView(s,o);return{clientOnlyGraphics:a,layerViewsAndGraphics:r,queryArea:t,location:i}}async _popupHitTestGraphics(e,p){const s=await this.popupHitTest(e),t=s.results,i=s.mapPoint,o=t.filter((e=>"graphic"===e.type&&this._isValidPopupGraphic(e.graphic,p))),r=o.length?o[0].mapPoint:null;return{clientGraphics:o.map((e=>e.graphic)),queryArea:i,location:i||r}}_getFetchPopupLayerViews(){const e=[];return this.allLayerViews.forEach((p=>{this._isValidPopupLayerView(p)&&e.push(p)})),null!=this.graphicsView&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()}_isValidPopupLayerView(e){return null!=e&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e}_graphicsPerFetchPopupLayerView(e,p){const s=[],t=new Map,i=p.map((e=>{const p=[];return"layer"in e?t.set(e.layer,p):t.set(e.graphics,p),{layerView:e,graphics:p}}));for(const p of e){const e=t.get(p.layer)||t.get(p.sourceLayer)||null;e?e.push(p):s.push(p)}return{layerViewsAndGraphics:i,clientOnlyGraphics:s}}};return e([c({cast(e){return!e||d(e)||"object"==typeof e&&(e.open=e=>(s(i.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(e)),e.close=()=>(s(i.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),e}})],w.prototype,"popup",void 0),e([c()],w.prototype,"popupEnabled",void 0),w=e([l("esri.views.PopupView")],w),w};export{y as PopupView};

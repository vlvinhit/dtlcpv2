/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{j as e}from"./mat4.js";import{c as t}from"./mat4f64.js";import{c as n}from"./vec3f64.js";import{projectBuffer as r,computeTranslationToOriginAndRotation as o}from"../geometry/projection.js";import{i as s,a as i,g as a}from"./ElevationProvider.js";import{u}from"./graphicUtils.js";import{g as l,a as f}from"./unitConversionUtils.js";import{L as c}from"./Logger.js";import{throwIfAborted as d}from"../core/promiseUtils.js";import{a as m}from"./hydratedFeatures.js";import{l as h}from"./arcadeOnDemand.js";function p(e,t,n,o,s,i,a,u,l,f,c){const d=_[c.mode];let m,h,p=0;if(r(e,t,n,o,l.spatialReference,s,u))return d.requiresAlignment(c)?(p=d.applyElevationAlignmentBuffer(o,s,i,a,u,l,f,c),m=i,h=a):(m=o,h=s),r(m,l.spatialReference,h,i,f.spatialReference,a,u)?p:void 0}function g(e,t,n,r,o){const u=(s(e)?e.z:i(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":{const n=a(t,e,"ground")??0;return o.verticalDistanceToGround=0,o.sampledElevation=n,void(o.z=n)}case"relative-to-ground":{const s=a(t,e,"ground")??0,i=n.geometryZWithOffset(u,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"relative-to-scene":{const s=a(t,e,"scene")??0,i=n.geometryZWithOffset(u,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"absolute-height":{const s=n.geometryZWithOffset(u,r),i=a(t,e,"ground")??0;return o.verticalDistanceToGround=s-i,o.sampledElevation=i,void(o.z=s)}default:return void(o.z=0)}}function E(e,t,n,r){return g(e,t,n,r,C),C.z}function v(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?R.UPDATE:e.onTheGroundChanged}function x(e){return"relative-to-ground"===e||"relative-to-scene"===e}function U(e){return"absolute-height"!==e}function I(t,n,r,s,i){g(n,r,i,s,C),u(t,C.verticalDistanceToGround);const a=C.sampledElevation,l=e(y,t.transformation);return A[0]=n.x,A[1]=n.y,A[2]=C.z,o(n.spatialReference,A,l,s.spatialReference)?t.transformation=l:console.warn("Could not locate symbol object properly, it might be misplaced"),a}class O{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var R;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(R||(R={}));const _={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,n,r,o,s,i,a){const u=a.calculateOffsetRenderUnits(i),l=a.featureExpressionInfoContext;t*=3,r*=3;for(let s=0;s<o;++s){const o=e[t],s=e[t+1],i=e[t+2];n[r]=o,n[r+1]=s,n[r+2]=null==l?i+u:u,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,n,r,o,s){let i=0;const a=s.spatialReference;t*=3,r*=3;for(let u=0;u<o;++u){const o=e[t],u=e[t+1],l=e[t+2],f=s.getElevation(o,u,l,a,"ground")??0;i+=f,n[r]=o,n[r+1]=u,n[r+2]=f,t+=3,r+=3}return i/o},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,n,r,o,s,i,a){let u=0;const l=a.calculateOffsetRenderUnits(i),f=a.featureExpressionInfoContext,c=s.spatialReference;t*=3,r*=3;for(let i=0;i<o;++i){const o=e[t],i=e[t+1],a=e[t+2],d=s.getElevation(o,i,a,c,"ground")??0;u+=d,n[r]=o,n[r+1]=i,n[r+2]=null==f?a+d+l:d+l,t+=3,r+=3}return u/o},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,n,r,o,s,i,a){let u=0;const l=a.calculateOffsetRenderUnits(i),f=a.featureExpressionInfoContext,c=s.spatialReference;t*=3,r*=3;for(let i=0;i<o;++i){const o=e[t],i=e[t+1],a=e[t+2],d=s.getElevation(o,i,a,c,"scene")??0;u+=d,n[r]=o,n[r+1]=i,n[r+2]=null==f?a+d+l:d+l,t+=3,r+=3}return u/o},requiresAlignment:()=>!0}},y=t(),C=new O,A=n(),j=c.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function T(e){const t=e&&e.expression;if("string"==typeof t){const e=q(t);if(null!=e)return{cachedResult:e}}return null}async function b(e,t,n,r){const o=e&&e.expression;if("string"!=typeof o)return null;const s=q(o);if(null!=s)return{cachedResult:s};const i=await h();d(n);const a=i.arcadeUtils,u=a.createSyntaxTree(o);return a.dependsOnView(u)?(null!=r&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(u),context:a.createExecContext(null,{sr:t}),modules:i}}}function z(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function D(e,t){if(null!=e&&!G(e)){if(!t||!e.arcade)return void j.errorOncePerTick("Arcade support required but not provided");const n=t;n._geometry&&(n._geometry=m(n._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function P(e,t=!1){let n=e&&e.featureExpressionInfo;const r=n&&n.expression;return t||"0"===r||(n=null),n??null}const w={cachedResult:0};function G(e){return null!=e.cachedResult}function q(e){return"0"===e?0:null}class F{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=l(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const n=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?n:e+n}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const n=this.featureExpressionInfoContext;return null!=n&&(t+=function(e){if(null!=e){if(G(e))return e.cachedResult;const t=e.arcade;let n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof n&&(e.cachedResult=0,n=0),n}return 0}(n)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=f(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,n){if(null==e)return void(this._featureExpressionInfoContext=null);const r=e&&e.arcade;var o;r&&null!=t&&null!=n?(this._featureExpressionInfoContext={cachedResult:(o=e).cachedResult,arcade:o.arcade?{func:o.arcade.func,context:o.arcade.modules.arcadeUtils.createExecContext(null,{sr:o.arcade.context.spatialReference}),modules:o.arcade.modules}:null},D(this._featureExpressionInfoContext,z(r.modules,t,n))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new F;return null!=e&&t.setFromElevationInfo(e),t}}export{F as E,O as S,g as a,R as b,I as c,v as d,E as e,z as f,p as g,U as h,P as i,b as j,T as k,x as n,D as s,w as z};

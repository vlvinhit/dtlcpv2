/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{F as e,z as n}from"./unitUtils.js";import{c as t}from"./mat3f64.js";import{d as r,m as o,c as a,g as i}from"./mat4.js";import{I as s,c as l}from"./mat4f64.js";import{h as c}from"./vec3.js";import{Z as f,f as p}from"./vec3f64.js";import{n as u}from"./mat3.js";import{projectBuffer as g,canProjectWithoutEngine as m,computeTranslationToOriginAndRotation as h}from"../geometry/projection.js";import{g as y}from"./spatialReferenceEllipsoidUtils.js";import{n as j,c as w}from"./DoubleArray.js";import R from"../geometry/support/MeshGeoreferencedRelativeVertexSpace.js";import A from"../geometry/support/MeshGeoreferencedVertexSpace.js";import v from"../geometry/support/MeshLocalVertexSpace.js";import x from"../geometry/support/MeshTransform.js";import{t as F,a as d}from"./vec32.js";import{L as S}from"./Logger.js";import{c as b,d as M,e as T,p as z,a as G,b as O,t as L,f as P}from"./projection.js";function _(e,n){return e.isGeographic||e.isWebMercator&&(n?.geographic??!0)}function V(e,n,t){const r=!e.isGeoreferenced;null!=t?.geographic&&t.geographic!==r&&S.getLogger(n).warnOnce(`Specifying the 'geographic' parameter (${t.geographic}) for a Mesh vertex space of type "${e.type}" is not supported. This parameter will be ignored.`)}function B(e,n,t){return _(n.spatialReference,t)?function(e,n,t){const r=n.spatialReference,o=W(n,t,k),a=new Float64Array(e.position.length),i=function(e,n,t,r){F(r,e,n);const o=new Float64Array(e.length);return b(r,o,t)}(e.position,o,r,a),s=u(H,o),l=function(e,n,t,r,o){if(null==t)return null;const a=new Float32Array(t.length);return d(a,t,r),M(a,e,n,o,a),a}(i,a,e.normal,s,r),c=function(e,n,t,r,o){if(null==t)return null;const a=new Float32Array(t.length);d(a,t,r,4);for(let e=3;e<a.length;e+=4)a[e]=t[e];return T(a,e,n,o,a),a}(i,a,e.tangent,s,r);return{position:i,normal:l,tangent:c}}(e,n,t):function(e,n,t){const r=new Float64Array(e.position.length),o=e.position,a=n.x,i=n.y,s=n.z??0,l=Z(t?t.unit:null,n.spatialReference);for(let e=0;e<o.length;e+=3)r[e]=o[e]*l+a,r[e+1]=o[e+1]*l+i,r[e+2]=o[e+2]*l+s;return{position:r,normal:e.normal,tangent:e.tangent}}(e,n,t)}function U(e,n,t,r){const{position:o,normal:a,tangent:i}=e;if(!n.isRelative)return{position:o,normal:a,tangent:i};const l=t?.localMatrix??s;return B({position:F(new Float64Array(o.length),o,l),normal:null!=a?L(a,new Float32Array(a.length),l):null,tangent:null!=i?P(i,new Float32Array(i.length),l):null},n.getOriginPoint(r),{geographic:!n.isGeoreferenced})}function $(e,n,t){if(t?.useTransform){const{position:r,normal:o,tangent:a}=e,{x:i,y:s,z:l}=n,c=p(i,s,l??0);return{vertexAttributes:{position:r,normal:o,tangent:a},vertexSpace:t.geographic??1?new v({origin:c}):new R({origin:c}),transform:new x}}return{vertexAttributes:B(e,n,t),vertexSpace:new A,transform:null}}function q(e,n,t){return _(n.spatialReference,t)?function(e,n,t){const r=n.spatialReference;W(n,t,k);const o=a(C,k),i=new Float64Array(e.position.length),s=function(e,n,t,r){const o=z(e,n,r),a=new Float64Array(o.length);return F(a,o,t),a}(e.position,r,o,i),l=u(H,o),c=function(e,n,t,r,o){if(null==e)return null;const a=G(e,n,t,r,new Float32Array(e.length));return d(a,a,o),a}(e.normal,e.position,i,r,l),f=function(e,n,t,r,o){if(null==e)return null;const a=O(e,n,t,r,new Float32Array(e.length));return d(a,a,o,4),a}(e.tangent,e.position,i,r,l);return{position:s,normal:c,tangent:f}}(e,n,t):I(e,n,t)}function D(e,n,t,r,o){if(!n.isRelative)return q(e,r,o);const{spatialReference:a}=r,i=U(e,n,t,a);return r.equals(n.getOriginPoint(a))?I(i,r,o):q(i,r,o)}function E({positions:e,transform:n,vertexSpace:t,inSpatialReference:a,outSpatialReference:i,outPositions:l,local:p}){const u=t.isRelative?t.origin:f,R=t.isRelative?n?.localMatrix??s:s;if(t.isGeoreferenced){const n=l??j(e.length);if(r(R,s)?w(n,e):F(n,e,R),!c(u,f)){const[e,t,r]=u;for(let o=0;o<n.length;o+=3)n[o]+=e,n[o+1]+=t,n[o+2]+=r}return g(n,a,0,n,i,0,n.length/3),n}const A=y(a),v=!p&&m(a,A)?A:a;h(a,u,k,v),o(k,k,R);const x=l??j(e.length);return F(x,e,k),g(x,v,0,x,i,0,x.length/3),x}function I(e,n,t){const r=new Float64Array(e.position.length),o=e.position,a=n.x,i=n.y,s=n.z??0,l=Z(t?t.unit:null,n.spatialReference);for(let e=0;e<o.length;e+=3)r[e]=(o[e]-a)/l,r[e+1]=(o[e+1]-i)/l,r[e+2]=(o[e+2]-s)/l;return{position:r,normal:e.normal,tangent:e.tangent}}function W(e,n,t){h(e.spatialReference,[e.x,e.y,e.z??0],t,y(e.spatialReference));const r=Z(n?n.unit:null,e.spatialReference);return i(t,t,[r,r,r]),t}function Z(t,r){if(null==t)return 1;const o=e(r);return 1/n(o,"meters",t)}const k=l(),C=l(),H=t(),J=Object.freeze(Object.defineProperty({__proto__:null,georeference:B,georeferenceApplyTransform:U,georeferenceByTransform:$,project:E,ungeoreference:q,ungeoreferenceByTransform:D},Symbol.toStringTag,{value:"Module"}));export{$ as a,U as b,D as c,J as d,B as g,_ as i,E as p,q as u,V as v};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{j as e,m as t,k as s}from"./mat4.js";import{I as i,c as r}from"./mat4f64.js";import{x as a,d as o,z as n,s as h,a as l,h as c,c as d,b as m,i as u,e as p,l as f}from"./vec3.js";import{f as _,c as T}from"./vec3f64.js";import{c as g}from"./sphere.js";import{b}from"./mathUtils2.js";import{O as A}from"./basicInterfaces.js";import{a as v,C as O,b as S,R as E,i as y}from"./Material.js";import{O as R,b as I,r as j,s as L,c as P,d as C,e as N,f as U,g as x,h as D,i as M,G as w}from"./DefaultBufferWriter.js";import{a as B,i as V}from"./Util2.js";import W from"../core/Evented.js";import F from"../core/Handles.js";import{d as G}from"./maybe.js";import{P as J}from"./PooledArray.js";import{O as z}from"./Octree.js";import{h as k}from"./typedArrayUtil.js";import{L as H}from"./Logger.js";import{c as Y}from"./mathUtils.js";import{b as X}from"./screenUtils.js";import{k as Z}from"./vec2.js";import{O as Q}from"./vec4f64.js";import{P as q}from"./frustum.js";import{c as K,d as $,f as ee,a as te}from"./lineSegment.js";import{c as se,d as ie,s as re,n as ae}from"./plane.js";import{n as oe}from"./InterleavedLayout.js";import{S as ne}from"./ShaderOutput.js";import{R as he}from"./RenderSlot.js";import{V as le}from"./VertexAttribute.js";import{V as ce}from"./FloatsPassUniform.js";import{L as de}from"./MarkerSizing.glsl.js";import{R as me,a as ue,C as pe,b as fe}from"./RibbonLine.glsl.js";import{S as _e,P as Te,R as ge}from"./Program2.js";import{c as be,o as Ae,a as ve,b as Oe,O as Se}from"./OrderIndependentTransparency.js";import{T as Ee}from"./TransparencyPassType.js";import{e as ye}from"./enums3.js";import{m as Re,d as Ie,a as je}from"./renderState.js";class Le extends v{get geometries(){return this._geometries}get transformation(){return this._transformation??i}set transformation(t){this._transformation=e(this._transformation??r(),t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}get shaderTransformation(){return this._shaderTransformation??this.transformation}set shaderTransformation(t){this._shaderTransformation=e(this._shaderTransformation??r(),t),this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)}clearShaderTransformation(){this._shaderTransformation=void 0,this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)}constructor(e={}){super(),this.type=O.Object,this._hasVolatileTransformation=!1,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Pe),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){B(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("objectGeometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new R(A.MaskOccludee);for(const t of this._geometries)t.occludees=I(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=j(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new R(A.Highlight);for(const t of this._geometries)t.highlights=I(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=j(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,s){return t(s,this.transformation,e.transformation)}getCombinedShaderTransformation(e,s=r()){return t(s,this.shaderTransformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._bvWorldSpace&&!this._hasVolatileTransformation||(this._bvWorldSpace=this._bvWorldSpace||new Ce,this._validateBoundingVolume(this._bvWorldSpace,we.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace&&!this._hasVolatileTransformation||(this._bvObjectSpace=this._bvObjectSpace||new Ce,this._validateBoundingVolume(this._bvObjectSpace,we.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const s=t===we.ObjectSpace;for(const t of this._geometries){const i=t.boundingInfo;i&&Ne(i,e,s?t.shaderTransformation:this.getCombinedShaderTransformation(t))}a(e.bounds,e.min,e.max,.5);for(const t of this._geometries){const i=t.boundingInfo;if(null==i)continue;const r=s?t.shaderTransformation:this.getCombinedShaderTransformation(t),a=b(r);o(Me,i.center,r);const h=n(Me,e.bounds),l=i.radius*a;e.bounds[3]=Math.max(e.bounds[3],h+l)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Pe{constructor(){this.min=_(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=_(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Ce extends Pe{constructor(){super(...arguments),this.bounds=g()}}function Ne(e,t,i){const r=e.bbMin,a=e.bbMax;if(s(i)){const e=h(Ue,i[12],i[13],i[14]);l(xe,r,e),l(De,a,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],xe[e]),t.max[e]=Math.max(t.max[e],De[e])}else if(o(xe,r,i),c(r,a))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],xe[e]),t.max[e]=Math.max(t.max[e],xe[e]);else{o(De,a,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],xe[e],De[e]),t.max[e]=Math.max(t.max[e],xe[e],De[e]);for(let e=0;e<3;++e){d(xe,r),d(De,a),xe[e]=a[e],De[e]=r[e],o(xe,xe,i),o(De,De,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],xe[e],De[e]),t.max[e]=Math.max(t.max[e],xe[e],De[e])}}}const Ue=T(),xe=T(),De=T(),Me=T();var we,Be;!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(we||(we={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(Be||(Be={}));const Ve=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];class We extends v{get objects(){return this._objects}constructor(e,t,s=""){super(),this.stage=e,this.apiLayerUid=s,this.type=O.Layer,this.events=new W,this.sliceable=!1,this._objects=new J,this._objectsAdded=new J,this._handles=new F,this.apiLayerUid=s,this.visible=t?.visible??!0,this.pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??Be.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(const t of Ve)this._handles.add(this.events.on(t,(s=>e.handleEvent(t,s))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==Be.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new z((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=G(this._octree),this._objectsAdded.clear()}}function Fe(e){return null!=e&&e.type===O.Layer}const Ge=new Map([[le.POSITION,0],[le.SUBDIVISIONFACTOR,1],[le.UV0,2],[le.AUXPOS1,3],[le.AUXPOS2,4],[le.COLOR,5],[le.COLORFEATUREATTRIBUTE,5],[le.SIZE,6],[le.SIZEFEATUREATTRIBUTE,6],[le.OPACITYFEATUREATTRIBUTE,7],[le.OBJECTANDLAYERIDCOLOR,8]]);class Je extends _e{initializeProgram(e){return new Te(e.rctx,Je.shader.get().build(this.configuration),Ge)}_makePipelineState(e,t){const s=this.configuration,i=e===Ee.NONE,r=e===Ee.FrontFace;return Re({blending:s.output===ne.Color||s.output===ne.Alpha?i?be:Ae(e):null,depthTest:{func:ve(e)},depthWrite:i?s.writeDepth?Ie:null:Oe(e),colorWrite:je,stencilWrite:s.hasOccludees?L:null,stencilTest:s.hasOccludees?t?P:C:null,polygonOffset:i||r?s.hasPolygonOffset?ze:null:Se})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?ze:null;this._occluderPipelineTransparent=Re({blending:be,polygonOffset:t,depthTest:N,depthWrite:null,colorWrite:je,stencilWrite:null,stencilTest:U}),this._occluderPipelineOpaque=Re({blending:be,polygonOffset:t,depthTest:N,depthWrite:null,colorWrite:je,stencilWrite:x,stencilTest:D}),this._occluderPipelineMaskWrite=Re({blending:null,polygonOffset:t,depthTest:M,depthWrite:null,colorWrite:null,stencilWrite:L,stencilTest:P})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?ye.LINES:ye.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===he.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===he.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}Je.shader=new ge(me,(()=>import("./RibbonLine.glsl.js").then((e=>e.R))));const ze={factor:0,units:-4};var ke;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(ke||(ke={}));class He extends S{constructor(e){super(e,new Xe),this._configuration=new ue,this._vertexAttributeLocations=Ge}isClosed(e,t){return Ke(this.parameters,e,t)}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===he.DRAPED_MATERIAL;const s=null!=this.parameters.stipplePattern&&e!==ne.Highlight;var i;return this._configuration.stippleEnabled=s,this._configuration.stippleOffColorEnabled=s&&null!=this.parameters.stippleOffColor,this._configuration.stippleScaleWithLineWidth=s&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=s&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&(i=this.parameters.markerParameters).anchor===de.Tip&&i.hideOnShortSegments&&"begin-end"===i.placement&&i.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===E.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,s,i,r,a){if(!s.options.selectionMode)return;const o=e.vertexAttributes.get(le.POSITION).data,n=e.vertexAttributes.get(le.SIZE);let h=this.parameters.width;if(this.parameters.vvSize){const t=e.vertexAttributes.get(le.SIZEFEATUREATTRIBUTE).data[0];h*=Y(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n&&(h*=n.data[0]);const l=i[0],c=i[1],d=(h/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,u=0;for(let e=0;e<o.length-5;e+=3){const t=o[e],s=o[e+1],i=l-t,r=c-s,a=o[e+3]-t,n=o[e+4]-s,h=Y((a*i+n*r)/(a*a+n*n),0,1),d=a*h-i,p=n*h-r,f=d*d+p*p;f<m&&(m=f,u=e/3)}m<d*d&&r(a.dist,a.normal,u,!1)}intersect(e,t,s,i,r,a){if(!s.options.selectionMode||!e.visible)return;if(!V(t))return void H.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.vertexAttributes,c=o.get(le.POSITION).data;let _=this.parameters.width;if(this.parameters.vvSize){const e=o.get(le.SIZEFEATUREATTRIBUTE).data[0];_*=Y(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(le.SIZE)&&(_*=o.get(le.SIZE).data[0]);const T=s.camera,g=it;Z(g,s.point);const b=_*T.pixelRatio/2+4*T.pixelRatio;h(ut[0],g[0]-b,g[1]+b,0),h(ut[1],g[0]+b,g[1]+b,0),h(ut[2],g[0]+b,g[1]-b,0),h(ut[3],g[0]-b,g[1]-b,0);for(let e=0;e<4;e++)if(!T.unprojectFromRenderScreen(ut[e],pt[e]))return;ie(T.eye,pt[0],pt[1],ft),ie(T.eye,pt[1],pt[2],_t),ie(T.eye,pt[2],pt[3],Tt),ie(T.eye,pt[3],pt[0],gt);let A=Number.MAX_VALUE,v=0;const O=qe(this.parameters,o,e.indices)?c.length-2:c.length-5;for(let e=0;e<O;e+=3){$e[0]=c[e]+t[12],$e[1]=c[e+1]+t[13],$e[2]=c[e+2]+t[14];const s=(e+3)%c.length;if(et[0]=c[s]+t[12],et[1]=c[s+1]+t[13],et[2]=c[s+2]+t[14],re(ft,$e)<0&&re(ft,et)<0||re(_t,$e)<0&&re(_t,et)<0||re(Tt,$e)<0&&re(Tt,et)<0||re(gt,$e)<0&&re(gt,et)<0)continue;if(T.projectToRenderScreen($e,rt),T.projectToRenderScreen(et,at),rt[2]<0&&at[2]>0){m(tt,$e,et);const e=T.frustum,t=-re(e[q.NEAR],$e)/u(tt,ae(e[q.NEAR]));p(tt,tt,t),l($e,$e,tt),T.projectToRenderScreen($e,rt)}else if(rt[2]>0&&at[2]<0){m(tt,et,$e);const e=T.frustum,t=-re(e[q.NEAR],et)/u(tt,ae(e[q.NEAR]));p(tt,tt,t),l(et,et,tt),T.projectToRenderScreen(et,at)}else if(rt[2]<0&&at[2]<0)continue;rt[2]=0,at[2]=0;const i=$(ee(rt,at,ht),g);i<A&&(A=i,d(ot,$e),d(nt,et),v=e/3)}const S=s.rayBegin,E=s.rayEnd;if(A<b*b){let e=Number.MAX_VALUE;if(te(ee(ot,nt,ht),ee(S,E,lt),st)){m(st,st,S);const t=f(st);p(st,st,1/t),e=t/n(S,E)}a(e,st,v,!1)}}get _layout(){const e=oe().vec3f(le.POSITION).f32(le.SUBDIVISIONFACTOR).vec2f(le.UV0).vec3f(le.AUXPOS1).vec3f(le.AUXPOS2);return this.parameters.vvSize?e.f32(le.SIZEFEATUREATTRIBUTE):e.f32(le.SIZE),this.parameters.vvColor?e.f32(le.COLORFEATUREATTRIBUTE):e.vec4f(le.COLOR),this.parameters.vvOpacity&&e.f32(le.OPACITYFEATUREATTRIBUTE),k("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(le.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Ze(this._layout,this.parameters)}requiresSlot(e,t){return!(t!==ne.Color&&t!==ne.Alpha&&t!==ne.Highlight&&t!==ne.Depth&&t!==ne.ObjectAndLayerIdColor||e!==he.DRAPED_MATERIAL&&(this.parameters.renderOccluded===E.OccludeAndTransparentStencil?e!==he.OPAQUE_MATERIAL&&e!==he.OCCLUDER_MATERIAL&&e!==he.TRANSPARENT_OCCLUDER_MATERIAL:t===ne.Color||t===ne.Alpha?e!==(this.parameters.writeDepth?he.TRANSPARENT_MATERIAL:he.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e!==he.OPAQUE_MATERIAL))}createGLMaterial(e){return new Ye(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class Ye extends w{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==ne.Color&&this._output!==ne.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(Je,e)}}class Xe extends ce{constructor(){super(...arguments),this.width=0,this.color=Q,this.join="miter",this.cap=pe.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class Ze{constructor(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const s=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=s;break;case"round":this.numJoinSubdivisions=fe+s}}_isClosed(e){return qe(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.indices.get(le.POSITION).length/2+1,s=this._isClosed(e);let i=s?2:4;return i+=((s?t:t-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,s,i,r){const a=ct,l=dt,c=mt,m=s.vertexAttributes.get(le.POSITION).data,u=s.indices&&s.indices.get(le.POSITION),p=s.vertexAttributes.get(le.DISTANCETOSTART)?.data;u&&u.length!==2*(m.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,_=0;this._parameters.vvSize?_=s.vertexAttributes.get(le.SIZEFEATUREATTRIBUTE).data[0]:s.vertexAttributes.has(le.SIZE)&&(f=s.vertexAttributes.get(le.SIZE).data[0]);let T=[1,1,1,1],g=0;this._parameters.vvColor?g=s.vertexAttributes.get(le.COLORFEATUREATTRIBUTE).data[0]:s.vertexAttributes.has(le.COLOR)&&(T=s.vertexAttributes.get(le.COLOR).data);const b=k("enable-feature:objectAndLayerId-rendering")?s.objectAndLayerIdColor:null;let A=0;this._parameters.vvOpacity&&(A=s.vertexAttributes.get(le.OPACITYFEATUREATTRIBUTE).data[0]);const v=m.length/3,O=new Float32Array(i.buffer),S=k("enable-feature:objectAndLayerId-rendering")?new Uint8Array(i.buffer):null,E=this.vertexBufferLayout.stride/4;let y=r*E;const R=y;let I=0;const j=p?(e,t,s)=>I=p[s]:(e,t,s)=>I+=n(e,t),L=k("enable-feature:objectAndLayerId-rendering"),P=(e,t,s,i,r,a,o)=>{if(O[y++]=t[0],O[y++]=t[1],O[y++]=t[2],O[y++]=i,O[y++]=o,O[y++]=r,O[y++]=e[0],O[y++]=e[1],O[y++]=e[2],O[y++]=s[0],O[y++]=s[1],O[y++]=s[2],O[y++]=this._parameters.vvSize?_:f,this._parameters.vvColor)O[y++]=g;else{const e=Math.min(4*a,T.length-4);O[y++]=T[e],O[y++]=T[e+1],O[y++]=T[e+2],O[y++]=T[e+3]}this._parameters.vvOpacity&&(O[y++]=A),L&&(null!=b&&(S[4*y]=b[0],S[4*y+1]=b[1],S[4*y+2]=b[2],S[4*y+3]=b[3]),y++)};y+=E,h(l,m[0],m[1],m[2]),e&&o(l,l,e);const C=this._isClosed(s);if(C){const t=m.length-3;h(a,m[t],m[t+1],m[t+2]),e&&o(a,a,e)}else h(c,m[3],m[4],m[5]),e&&o(c,c,e),P(l,l,c,1,ke.LEFT_CAP_START,0,0),P(l,l,c,1,ke.RIGHT_CAP_START,0,0),d(a,l),d(l,c);const N=C?0:1,U=C?v:v-1;for(let t=N;t<U;t++){const s=(t+1)%v*3;h(c,m[s],m[s+1],m[s+2]),e&&o(c,c,e),j(a,l,t),P(a,l,c,0,ke.LEFT_JOIN_END,t,I),P(a,l,c,0,ke.RIGHT_JOIN_END,t,I);const i=this.numJoinSubdivisions;for(let e=0;e<i;++e){const s=(e+1)/(i+1);P(a,l,c,s,ke.LEFT_JOIN_END,t,I),P(a,l,c,s,ke.RIGHT_JOIN_END,t,I)}P(a,l,c,1,ke.LEFT_JOIN_START,t,I),P(a,l,c,1,ke.RIGHT_JOIN_START,t,I),d(a,l),d(l,c)}C?(h(c,m[3],m[4],m[5]),e&&o(c,c,e),I=j(a,l,U),P(a,l,c,0,ke.LEFT_JOIN_END,N,I),P(a,l,c,0,ke.RIGHT_JOIN_END,N,I)):(I=j(a,l,U),P(a,l,l,0,ke.LEFT_CAP_END,U,I),P(a,l,l,0,ke.RIGHT_CAP_END,U,I)),Qe(O,R+E,O,R,E),y=Qe(O,y-E,O,y,E),this._parameters.wireframe&&this._addWireframeVertices(i,R,y,E)}_addWireframeVertices(e,t,s,i){const r=new Float32Array(e.buffer,s*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,s-t);let o=0;const n=e=>o=Qe(a,e,r,o,i);for(let e=0;e<a.length-1;e+=2*i)n(e),n(e+2*i),n(e+1*i),n(e+2*i),n(e+1*i),n(e+3*i)}}function Qe(e,t,s,i,r){for(let a=0;a<r;a++)s[i++]=e[t++];return i}function qe(e,t,s){return Ke(e,t.get(le.POSITION).data,s?s.get(le.POSITION):null)}function Ke(e,t,s){return!!e.isClosed&&(s?s.length>2:t.length>6)}const $e=T(),et=T(),tt=T(),st=T(),it=T(),rt=X(),at=X(),ot=T(),nt=T(),ht=K(),lt=K(),ct=T(),dt=T(),mt=T(),ut=[X(),X(),X(),X()],pt=[T(),T(),T(),T()],ft=se(),_t=se(),Tt=se(),gt=se(),bt=oe().vec3f(le.POSITION),At=oe().vec3f(le.POSITION).vec2f(le.UV0),vt=oe().vec3f(le.POSITION).vec4u8(le.COLOR);oe().vec3f(le.POSITION).vec4u8(le.OBJECTANDLAYERIDCOLOR);const Ot=oe().vec3f(le.POSITION).vec2f(le.UV0).vec4u8(le.OBJECTANDLAYERIDCOLOR);oe().vec3f(le.POSITION).vec4u8(le.COLOR).vec4u8(le.OBJECTANDLAYERIDCOLOR);class St extends S{intersect(e,t,s,i,r,a){return y(e,s,i,r,void 0,a)}}export{Le as O,At as P,He as R,St as T,Be as U,We as W,Ot as a,vt as b,bt as c,Fe as i};

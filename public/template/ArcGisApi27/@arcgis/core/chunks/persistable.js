/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as r}from"./multiOriginJSONSupportUtils.js";import{isAbsolute as t,isBlobProtocol as e,join as o,getPathExtension as s}from"../core/urlUtils.js";import{g as n}from"./uuid.js";import{g as i}from"./metadata.js";import{n as a}from"../core/Accessor.js";import{propertyJSONMeta as c}from"../core/accessorSupport/decorators/property.js";import{g as p}from"./resourceExtension.js";import{r as u,t as l,M as m,i as f,p as d,a as y}from"./persistableUrlUtils.js";function g(o){const n=o?.origins??[void 0];return(d,g)=>{const w=function(o,n,c){if("resource"===o?.type)return function(o,n,c){const d=i(n,c);return{type:String,read:(r,t,e)=>{const o=u(r,t,e);return d.type===String?o:"function"==typeof d.type?new d.type({url:o}):void 0},write:{writer(n,i,u,y){if(!y||!y.resources)return"string"==typeof n?void(i[u]=l(n,y)):void(i[u]=n.write({},y));const g=null==(N=n)?null:"string"==typeof N?N:N.url,w=l(g,{...y,verifyItemRelativeUrls:y&&y.verifyItemRelativeUrls?{writtenUrls:y.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},m.NO),j=d.type!==String&&(!r(this)||y&&y.origin&&this.originIdOf(c)>a(y.origin)),I={object:this,propertyName:c,value:n,targetUrl:w,dest:i,targetPropertyName:u,context:y,params:o};var N;y&&y.portalItem&&w&&!t(w)?j?function(r){const{context:t,targetUrl:e,params:o,value:n,dest:i,targetPropertyName:a}=r;if(!t.portalItem)return;const c=t.portalItem.resourceFromPath(e),u=U(n,e,t),l=p(u),m=s(c.path),f=o?.compress??!1;l===m?(t.resources&&v({...r,resource:c,content:u,compress:f,updates:t.resources.toUpdate}),i[a]=e):h(r)}(I):function({context:r,targetUrl:t,dest:e,targetPropertyName:o}){r.portalItem&&r.resources&&(r.resources.toKeep.push({resource:r.portalItem.resourceFromPath(t),compress:!1}),e[o]=t)}(I):y&&y.portalItem&&(null==w||null!=f(w)||e(w)||j)?h(I):i[u]=w}}}}(o,n,c);switch(o?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:r,write:t}=y;return{read:r,write:t}}}}(o,d,g);for(const r of n){const t=c(d,r,g);for(const r in w)t[r]=w[r]}}}function h(r){const{targetUrl:t,params:s,value:i,context:a,dest:c,targetPropertyName:u}=r;if(!a.portalItem)return;const l=d(t),m=l?.filename??n(),f=s?.prefix??l?.prefix,y=U(i,t,a),g=o(f,m),h=`${g}.${p(y)}`,w=a.portalItem.resourceFromPath(h);e(t)&&a.resources&&a.resources.pendingOperations.push(async function(r){const t=(await import("../request.js").then((r=>r.r))).default,{data:e}=await t(r,{responseType:"blob"});return e}(t).then((r=>{w.path=`${g}.${p(r)}`,c[u]=w.itemRelativeUrl})).catch((()=>{})));const j=s?.compress??!1;a.resources&&v({...r,resource:w,content:y,compress:j,updates:a.resources.toAdd}),c[u]=w.itemRelativeUrl}function v({object:r,propertyName:t,updates:e,resource:o,content:s,compress:n}){e.push({resource:o,content:s,compress:n,finish:e=>{!function(r,t,e){"string"==typeof r[t]?r[t]=e.url:r[t].url=e.url}(r,t,e)}})}function U(r,t,e){return"string"==typeof r?{url:t}:new Blob([JSON.stringify(r.toJSON(e))],{type:"application/json"})}export{g as p};

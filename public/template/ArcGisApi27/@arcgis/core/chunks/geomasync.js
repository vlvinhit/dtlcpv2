/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{version as n}from"../kernel.js";import{G as t,p as e,H as r,w as i,m as o,n as a,z as s,J as l,q as c,K as u,L as f,M as m,O as p,P as d,Q as w,t as y,T as h,U as j,F as g,V as v}from"./arcadeUtils.js";import{e as P,f as A,g as I,s as F}from"./centroid2.js";import b from"../geometry/Extent.js";import R from"../geometry/Geometry.js";import{disjoint as x,intersects as N,touches as O,crosses as S,within as U,contains as D,overlaps as k,equals as C,relate as T,intersect as z,union as M,difference as J,symmetricDifference as L,clip as E,cut as Z,planarArea as q,geodesicArea as B,planarLength as G,geodesicLength as Q,distance as V,densify as W,geodesicDensify as H,generalize as K,buffer as X,geodesicBuffer as Y,offset as $,rotate as _,simplify as nn,isSimple as tn,convexHull as en,nearestCoordinate as rn,nearestVertex as on}from"../geometry/geometryEngineAsync.js";import an from"../geometry/Multipoint.js";import sn from"../geometry/Point.js";import ln from"../geometry/Polygon.js";import cn from"../geometry/Polyline.js";import{fromJSON as un}from"../geometry/support/jsonUtils.js";import{A as fn,E as mn}from"./executionError.js";import{g as pn,l as dn}from"./portalUtils.js";import{g as wn}from"./unitUtils.js";import yn from"../portal/Portal.js";import"./typedArrayUtil.js";import"../core/urlUtils.js";import"../config.js";import"./object.js";import"../core/lang.js";import"../core/Error.js";import"./Logger.js";import"./string.js";import"./maybe.js";import"../geometry.js";import"./ensureType.js";import"../geometry/SpatialReference.js";import"./tslib.es6.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./writer.js";import"./jsonMap.js";import"./typeUtils.js";import"../geometry/support/webMercatorUtils.js";import"./reader.js";import"./zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"./ArcadeDate.js";import"./datetime.js";import"./ImmutableArray.js";import"./number3.js";import"./locale.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./OptimizedGeometry.js";import"./arcadeTimeUtils.js";import"../layers/support/FieldsIndex.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"./TimeReference.js";import"../core/Clonable.js";import"./hash.js";import"../request.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"./assets.js";import"../intl.js";import"./date.js";import"./number.js";import"./messages.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";function hn(t){return 0===n.indexOf("4.")?ln.fromExtent(t):new ln({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function jn(n,t,r){if(e(n,2,2,t,r),n[0]instanceof R&&n[1]instanceof R);else if(n[0]instanceof R&&null===n[1]);else if(n[1]instanceof R&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new fn(t,mn.InvalidParameter,r)}async function gn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid)&&(e=I(n.spatialReference)/wn(n.spatialReference));let r=0;if("polyline"===n.type)for(const t of n.paths)for(let n=1;n<t.length;n++)r+=F(t[n],t[n-1],e);else if("polygon"===n.type)for(const t of n.rings){for(let n=1;n<t.length;n++)r+=F(t[n],t[n-1],e);(t[0][0]!==t[t.length-1][0]||t[0][1]!==t[t.length-1][1]||void 0!==t[0][2]&&t[0][2]!==t[t.length-1][2])&&(r+=F(t[0],t[t.length-1],e))}else"extent"===n.type&&(r+=2*F([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*F([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(f(n.zmax,0)*e-f(n.zmin,0)*e));const i=new cn({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return G(i,t)}function vn(n){"async"===n.mode&&(n.functions.disjoint=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null===o[0]||null===o[1]||x(o[0],o[1]))))},n.functions.intersects=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&N(o[0],o[1]))))},n.functions.touches=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&O(o[0],o[1]))))},n.functions.crosses=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&S(o[0],o[1]))))},n.functions.within=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&U(o[0],o[1]))))},n.functions.contains=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&D(o[0],o[1]))))},n.functions.overlaps=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null!==o[1]&&k(o[0],o[1]))))},n.functions.equals=function(t,i){return n.standardFunctionAsync(t,i,((n,o,a)=>(e(a,2,2,t,i),a[0]===a[1]||(a[0]instanceof R&&a[1]instanceof R?C(a[0],a[1]):!(!r(a[0])||!r(a[1]))&&a[0].equals(a[1])))))},n.functions.relate=function(r,o){return n.standardFunctionAsync(r,o,((n,a,s)=>{if(s=t(s),e(s,3,3,r,o),s[0]instanceof R&&s[1]instanceof R)return T(s[0],s[1],i(s[2]));if(s[0]instanceof R&&null===s[1])return!1;if(s[1]instanceof R&&null===s[0])return!1;if(null===s[0]&&null===s[1])return!1;throw new fn(r,mn.InvalidParameter,o)}))},n.functions.intersection=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null===o[0]||null===o[1]?null:z(o[0],o[1]))))},n.functions.union=function(e,r){return n.standardFunctionAsync(e,r,((n,i,c)=>{const u=[];if(0===(c=t(c)).length)throw new fn(e,mn.WrongNumberOfParameters,r);if(1===c.length)if(o(c[0])){const n=t(c[0]);for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new fn(e,mn.InvalidParameter,r);u.push(n[t])}}else{if(!a(c[0])){if(c[0]instanceof R)return s(l(c[0]),e.spatialReference);if(null===c[0])return null;throw new fn(e,mn.InvalidParameter,r)}{const n=t(c[0].toArray());for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new fn(e,mn.InvalidParameter,r);u.push(n[t])}}}else for(let n=0;n<c.length;n++)if(null!==c[n]){if(!(c[n]instanceof R))throw new fn(e,mn.InvalidParameter,r);u.push(c[n])}return 0===u.length?null:M(u)}))},n.functions.difference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null!==o[0]&&null===o[1]?l(o[0]):null===o[0]?null:J(o[0],o[1]))))},n.functions.symmetricdifference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,o)=>(jn(o=t(o),e,r),null===o[0]&&null===o[1]?null:null===o[0]?l(o[1]):null===o[1]?l(o[0]):L(o[0],o[1]))))},n.functions.clip=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[1]instanceof b)&&null!==a[1])throw new fn(r,mn.InvalidParameter,i);if(null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return null===a[1]?null:E(a[0],a[1])}))},n.functions.cut=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[1]instanceof cn)&&null!==a[1])throw new fn(r,mn.InvalidParameter,i);if(null===a[0])return[];if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return null===a[1]?[l(a[0])]:Z(a[0],a[1])}))},n.functions.area=function(r,i){return n.standardFunctionAsync(r,i,(async(n,s,l)=>{if(e(l,1,2,r,i),null===(l=t(l))[0])return 0;if(c(l[0])){const n=await l[0].sumArea(u(f(l[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new fn(r,mn.Cancelled,i);return n}if(o(l[0])||a(l[0])){const n=m(l[0],r.spatialReference);return null===n?0:q(n,u(f(l[1],-1)))}if(!(l[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return q(l[0],u(f(l[1],-1)))}))},n.functions.areageodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,s,l)=>{if(e(l,1,2,r,i),null===(l=t(l))[0])return 0;if(c(l[0])){const n=await l[0].sumArea(u(f(l[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new fn(r,mn.Cancelled,i);return n}if(o(l[0])||a(l[0])){const n=m(l[0],r.spatialReference);return null===n?0:B(n,u(f(l[1],-1)))}if(!(l[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return B(l[0],u(f(l[1],-1)))}))},n.functions.length=function(r,i){return n.standardFunctionAsync(r,i,(async(n,s,l)=>{if(e(l,1,2,r,i),null===(l=t(l))[0])return 0;if(c(l[0])){const n=await l[0].sumLength(p(f(l[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new fn(r,mn.Cancelled,i);return n}if(o(l[0])||a(l[0])){const n=d(l[0],r.spatialReference);return null===n?0:G(n,p(f(l[1],-1)))}if(!(l[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return G(l[0],p(f(l[1],-1)))}))},n.functions.length3d=function(r,i){return n.standardFunctionAsync(r,i,((n,s,l)=>{if(e(l,1,2,r,i),null===(l=t(l))[0])return 0;if(o(l[0])||a(l[0])){const n=d(l[0],r.spatialReference);return null===n?0:!0===n.hasZ?gn(n,p(f(l[1],-1))):G(n,p(f(l[1],-1)))}if(!(l[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return!0===l[0].hasZ?gn(l[0],p(f(l[1],-1))):G(l[0],p(f(l[1],-1)))}))},n.functions.lengthgeodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,s,l)=>{if(e(l,1,2,r,i),null===(l=t(l))[0])return 0;if(c(l[0])){const n=await l[0].sumLength(p(f(l[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new fn(r,mn.Cancelled,i);return n}if(o(l[0])||a(l[0])){const n=d(l[0],r.spatialReference);return null===n?0:Q(n,p(f(l[1],-1)))}if(!(l[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return Q(l[0],p(f(l[1],-1)))}))},n.functions.distance=function(r,i){return n.standardFunctionAsync(r,i,((n,s,l)=>{l=t(l),e(l,2,3,r,i);let c=l[0];(o(l[0])||a(l[0]))&&(c=w(l[0],r.spatialReference));let u=l[1];if((o(l[1])||a(l[1]))&&(u=w(l[1],r.spatialReference)),!(c instanceof R))throw new fn(r,mn.InvalidParameter,i);if(!(u instanceof R))throw new fn(r,mn.InvalidParameter,i);return V(c,u,p(f(l[2],-1)))}))},n.functions.distancegeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{a=t(a),e(a,2,3,r,i);const s=a[0],l=a[1];if(!(s instanceof sn))throw new fn(r,mn.InvalidParameter,i);if(!(l instanceof sn))throw new fn(r,mn.InvalidParameter,i);const c=new cn({paths:[],spatialReference:s.spatialReference});return c.addPath([s,l]),Q(c,p(f(a[2],-1)))}))},n.functions.densify=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);const s=y(a[1]);if(isNaN(s))throw new fn(r,mn.InvalidParameter,i);if(s<=0)throw new fn(r,mn.InvalidParameter,i);return a[0]instanceof ln||a[0]instanceof cn?W(a[0],s,p(f(a[2],-1))):a[0]instanceof b?W(hn(a[0]),s,p(f(a[2],-1))):a[0]}))},n.functions.densifygeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);const s=y(a[1]);if(isNaN(s))throw new fn(r,mn.InvalidParameter,i);if(s<=0)throw new fn(r,mn.InvalidParameter,i);return a[0]instanceof ln||a[0]instanceof cn?H(a[0],s,p(f(a[2],-1))):a[0]instanceof b?H(hn(a[0]),s,p(f(a[2],-1))):a[0]}))},n.functions.generalize=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,4,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);const s=y(a[1]);if(isNaN(s))throw new fn(r,mn.InvalidParameter,i);return K(a[0],s,h(f(a[2],!0)),p(f(a[3],-1)))}))},n.functions.buffer=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);const s=y(a[1]);if(isNaN(s))throw new fn(r,mn.InvalidParameter,i);return 0===s?l(a[0]):X(a[0],s,p(f(a[2],-1)))}))},n.functions.buffergeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,2,3,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);const s=y(a[1]);if(isNaN(s))throw new fn(r,mn.InvalidParameter,i);return 0===s?l(a[0]):Y(a[0],s,p(f(a[2],-1)))}))},n.functions.offset=function(r,o){return n.standardFunctionAsync(r,o,((n,a,s)=>{if(s=t(s),e(s,2,6,r,o),null===s[0])return null;if(!(s[0]instanceof ln||s[0]instanceof cn))throw new fn(r,mn.InvalidParameter,o);const l=y(s[1]);if(isNaN(l))throw new fn(r,mn.InvalidParameter,o);const c=y(f(s[4],10));if(isNaN(c))throw new fn(r,mn.InvalidParameter,o);const u=y(f(s[5],0));if(isNaN(u))throw new fn(r,mn.InvalidParameter,o);return $(s[0],l,p(f(s[2],-1)),i(f(s[3],"round")).toLowerCase(),c,u)}))},n.functions.rotate=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{a=t(a),e(a,2,3,r,i);let s=a[0];if(null===s)return null;if(!(s instanceof R))throw new fn(r,mn.InvalidParameter,i);s instanceof b&&(s=ln.fromExtent(s));const l=y(a[1]);if(isNaN(l))throw new fn(r,mn.InvalidParameter,i);const c=f(a[2],null);if(null===c)return _(s,l);if(c instanceof sn)return _(s,l,c);throw new fn(r,mn.InvalidParameter,i)}))},n.functions.centroid=function(r,i){return n.standardFunctionAsync(r,i,((n,c,u)=>{if(u=t(u),e(u,1,1,r,i),null===u[0])return null;let f=u[0];if((o(u[0])||a(u[0]))&&(f=w(u[0],r.spatialReference)),null===f)return null;if(!(f instanceof R))throw new fn(r,mn.InvalidParameter,i);return f instanceof sn?s(l(u[0]),r.spatialReference):f instanceof ln?f.centroid:f instanceof cn?P(f):f instanceof an?A(f):f instanceof b?f.center:null}))},n.functions.multiparttosinglepart=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{a=t(a),e(a,1,1,r,i);const c=[];if(null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);if(a[0]instanceof sn)return[s(l(a[0]),r.spatialReference)];if(a[0]instanceof b)return[s(l(a[0]),r.spatialReference)];const u=await nn(a[0]);if(u instanceof ln){const n=[],t=[];for(let e=0;e<u.rings.length;e++)if(u.isClockwise(u.rings[e])){const t=un({rings:[u.rings[e]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(t)}else t.push({ring:u.rings[e],pt:u.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(u instanceof cn){const n=[];for(let t=0;t<u.paths.length;t++){const e=un({paths:[u.paths[t]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(e)}return n}if(a[0]instanceof an){const n=s(l(a[0]),r.spatialReference);for(let t=0;t<n.points.length;t++)c.push(n.getPoint(t));return c}return null}))},n.functions.issimple=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return!0;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return tn(a[0])}))},n.functions.simplify=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return nn(a[0])}))},n.functions.convexhull=function(r,i){return n.standardFunctionAsync(r,i,((n,o,a)=>{if(a=t(a),e(a,1,1,r,i),null===a[0])return null;if(!(a[0]instanceof R))throw new fn(r,mn.InvalidParameter,i);return en(a[0])}))},n.functions.getuser=function(t,r){return n.standardFunctionAsync(t,r,(async(n,o,a)=>{e(a,0,2,t,r);let s=f(a[1],""),l=!0===s;if(s=!0===s||!1===s?"":i(s),0===a.length||a[0]instanceof j){let n=null;n=t.services&&t.services.portal?t.services.portal:yn.getDefault(),a.length>0&&(n=pn(a[0],n));const e=await dn(n,s,l);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return g.convertObjectToArcadeDictionary(n,v(t))}return null}let u=null;if(c(a[0])&&(u=a[0]),u){if(l=!1,s)return null;await u.load();const n=await u.getOwningSystemUrl();if(!n){if(!s){const n=await u.getIdentityUser();return n?g.convertObjectToArcadeDictionary({username:n},v(t)):null}return null}let e=null;e=t.services&&t.services.portal?t.services.portal:yn.getDefault(),e=pn(new j(n),e);const r=await dn(e,s,l);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return g.convertObjectToArcadeDictionary(n,v(t))}return null}throw new fn(t,mn.InvalidParameter,r)}))}),n.functions.nearestcoordinate=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[0]instanceof R||null===a[0]))throw new fn(r,mn.InvalidParameter,i);if(!(a[1]instanceof sn||null===a[1]))throw new fn(r,mn.InvalidParameter,i);if(null===a[0]||null===a[1])return null;const s=await rn(a[0],a[1]);return null===s?null:g.convertObjectToArcadeDictionary({coordinate:s.coordinate,distance:s.distance},v(r),!1,!0)}))},n.functions.nearestvertex=function(r,i){return n.standardFunctionAsync(r,i,(async(n,o,a)=>{if(a=t(a),e(a,2,2,r,i),!(a[0]instanceof R||null===a[0]))throw new fn(r,mn.InvalidParameter,i);if(!(a[1]instanceof sn||null===a[1]))throw new fn(r,mn.InvalidParameter,i);if(null===a[0]||null===a[1])return null;const s=await on(a[0],a[1]);return null===s?null:g.convertObjectToArcadeDictionary({coordinate:s.coordinate,distance:s.distance},v(r),!1,!0)}))}}export{vn as registerFunctions};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Accessor.js";import s from"../core/Evented.js";import r from"../core/Handles.js";import{s as i}from"./ensureType.js";import{h as a,f as n,d as o}from"./maybe.js";import{P as h}from"./PooledArray.js";import{watch as l,syncAndInitial as c,on as d}from"../core/reactiveUtils.js";import{g as u,s as m}from"./watch.js";import{M as p,s as g,n as _}from"../core/scheduling.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import{h as y,r as w,B as R}from"./typedArrayUtil.js";import{subclass as v}from"../core/accessorSupport/decorators/subclass.js";import{n as b,m as T,c as S,q as x,t as C,u as O,f as M,j as A}from"./mat4.js";import{b as E,h as D,c as I,A as P,d as L,s as j}from"./vec3.js";import{c as H,f as V}from"./vec3f64.js";import{V as G}from"./ViewingMode.js";import{d as N}from"./FloatsPassUniform.js";import{R as U,f as F,O as B,d as W,e as z}from"./View.glsl.js";import{T as q,c as k,a as Q,i as Y,R as X,U as Z,f as $,e as J}from"./enums3.js";import{F as K,a as ee}from"./FramebufferObject.js";import{T as te,a as se,v as re}from"./Texture.js";import{S as ie}from"./ShaderOutput.js";import{T as ae,a as ne}from"./TextureOnly.glsl.js";import{N as oe}from"./NestedMap.js";import{S as he,p as le}from"./ShaderTechniqueConfiguration.js";import{C as ce}from"./Camera.js";import{L as de}from"./Logger.js";import{a as ue,l as me,v as pe,b as ge,s as _e}from"./Util2.js";import{V as fe,c as ye,a as we}from"./glUtil3D.js";import{f as Re,c as ve}from"./vec4f64.js";import{projectBuffer as be}from"../geometry/projection.js";import{A as Te}from"./Attribute.js";import{C as Se,R as xe,D as Ce,A as Oe,M as Me}from"./Material.js";import{a as Ae,G as Ee,D as De}from"./DefaultBufferWriter.js";import{R as Ie,W as Pe,O as Le,T as je,a as He,P as Ve,U as Ge}from"./TriangleMaterial.js";import{V as Ne}from"./VertexAttribute.js";import{a as Ue,f as Fe}from"./vec2f64.js";import{S as Be,C as We,W as ze}from"./WaterSurface.glsl.js";import{M as qe}from"./MultipassGeometryTest.glsl.js";import{M as ke}from"./MultipassTerrainTest.glsl.js";import{R as Qe}from"./RenderSlot.js";import{T as Ye}from"./TransparencyPassType.js";import{S as Xe,a as Ze,A as $e}from"./SSAOHelper.js";import{c as Je,l as Ke,b as et}from"./mathUtils.js";import{c as tt}from"./mat3f64.js";import{c as st}from"./mat4f64.js";import{s as rt,j as it,b as at,l as nt,a as ot,c as ht,g as lt,n as ct,e as dt,k as ut}from"./vec2.js";import{s as mt,t as pt}from"./vec4.js";import{O as gt}from"./Intersector.js";import{S as _t,n as ft,I as yt}from"./Intersector2.js";import{g as wt}from"./glUtil.js";import{R as Rt}from"./basicInterfaces.js";import{V as vt}from"./VertexNormal.glsl.js";import{c as bt,o as Tt,a as St,b as xt,g as Ct,d as Ot}from"./OrderIndependentTransparency.js";import{P as Mt}from"./PhysicallyBasedRendering.glsl.js";import"./interfaces2.js";import"./ShaderBuilder.js";import{R as At,S as Et,P as Dt}from"./Program2.js";import{D as It}from"./DefaultTechniqueConfiguration.js";import{m as Pt,d as Lt,a as jt,s as Ht}from"./renderState.js";import{R as Vt,b as Gt}from"./MemCache.js";import{B as Nt}from"./VertexArrayObject.js";import{T as Ut,n as Ft}from"./Scheduler.js";import{N as Bt,c as Wt}from"./sphere.js";import{b as zt}from"./mathUtils2.js";var qt,kt,Qt,Yt,Xt;!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(qt||(qt={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(kt||(kt={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(Qt||(Qt={})),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(Yt||(Yt={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(Xt||(Xt={}));class Zt{constructor(e,t){this._fbo=null;const s=new te;s.wrapMode=q.CLAMP_TO_EDGE,s.samplingMode=k.LINEAR_MIPMAP_LINEAR,s.hasMipmap=t,s.maxAnisotropy=8,this._fbo=new K(e,s)}dispose(){this._fbo=a(this._fbo)}getTexture(){return this._fbo?.colorTexture}isValid(){return null!=this._fbo}resize(e,t){this._fbo?.resize(e,t)}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo?.colorTexture;e?.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){this._fbo?.resize(0,0)}get gpuMemoryUsage(){return this._fbo?.gpuMemoryUsage??0}}class $t{constructor(e,t,s,r=!0){this.output=t,this.type=s,this.valid=!1,this.lastUsed=p(1/0),this.fbo=new Zt(e,r)}}class Jt{constructor(e){this.renderTargets=[new $t(e,ie.Color,U.Color),new $t(e,ie.Color,U.ColorNoRasterImage),new $t(e,ie.Highlight,U.Highlight,!1),new $t(e,ie.Normal,U.Water),new $t(e,ie.Color,U.Occluded)],y("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new $t(e,ie.ObjectAndLayerIdColor,U.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,s){return e?(t.lastUsed=s,!1):s-t.lastUsed>Kt?(t.fbo.disposeRenderTargetMemory(),t.lastUsed=p(1/0),!1):t.lastUsed<1/0}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const Kt=p(1e3);class es{constructor(e){this._context=e,this._perConstructorInstances=new oe,this._frameCounter=0,this._keepAliveFrameCount=ss}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=rs){const s=t.key;let r=this._perConstructorInstances.get(e,s);if(null==r){const i=new e(this._context,t,(()=>this.release(i)));r=new ts(i),this._perConstructorInstances.set(e,s,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,s){if(null!=s){if(t.key===s.key)return s;this.release(s)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==ss&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,s)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,s))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,s)=>{e.push((async(e,t)=>{const s=t.shader;s&&(await s.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,s))})),await Promise.all(e)}}class ts{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const ss=-1,rs=new he;class is{constructor(e,t,s,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=s,this.requestRender=r,this._id2glMaterialRef=new oe}dispose(){this._textureRepository.destroy()}acquire(e,t,s){if(this._ownMaterial(e),!e.requiresSlot(t,s))return null;let r=this._id2glMaterialRef.get(s,e.id);if(null==r){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:s});r=new as(t),this._id2glMaterialRef.set(s,e.id,r)}return r.ref(),r.glMaterial}release(e,t){const s=this._id2glMaterialRef.get(t,e.id);null!=s&&(s.unref(),s.referenced||(a(s.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){null!=e.repository&&e.repository!==this&&de.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class as{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ue(this._refCnt>=0)}get referenced(){return this._refCnt>0}}class ns{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+u()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=F(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const s=this._gridSize,r=Math.round(e[0]/s),i=Math.round(e[1]/s),a=Math.round(e[2]/s),n=`${r}/${i}/${a}`;let o=this._origins.get(n);const h=.5*s;if(E(os,e,t.vec3),os[0]=Math.abs(os[0]),os[1]=Math.abs(os[1]),os[2]=Math.abs(os[2]),os[0]<h&&os[1]<h&&os[2]<h){if(o){const t=Math.max(...os);if(E(os,e,o.vec3),os[0]=Math.abs(os[0]),os[1]=Math.abs(os[1]),os[2]=Math.abs(os[2]),Math.max(...os)<t)return o}return t}return o||(o=F(r*s,i*s,a*s,n),this._origins.set(n,o)),o}_drawOriginBox(e,t=Re(1,1,0,1)){const s=window.view,r=s._stage,i=t.toString();if(!this._objects.has(i)){this._material=new Ie({width:2,color:t}),r.add(this._material);const e=new Pe(r,{pickable:!1}),s=new Le({castShadow:!1});r.add(s),e.add(s),this._objects.set(i,s)}const a=this._objects.get(i),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=n.length,h=new Array(3*o),l=new Array,c=.5*this._gridSize;for(let t=0;t<o;t++)h[3*t]=e[0]+(1&n[t]?c:-c),h[3*t+1]=e[1]+(2&n[t]?c:-c),h[3*t+2]=e[2]+(4&n[t]?c:-c),t>0&&l.push(t-1,t);be(h,this._originSR,0,h,s.renderSpatialReference,0,o);const d=new Ae(this._material,[[Ne.POSITION,new Te(h,3,!0)]],[[Ne.POSITION,l]],null,Se.Line);r.add(d),a.addGeometry(d)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const os=H();class hs{constructor(e,t,s){this.shadowMap=e,this.ssaoHelper=t,this.slicePlane=s,this.slot=Qe.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Ye.NONE,this.alignPixelEnabled=!1,this._camera=new ce,this._inverseViewport=Ue(),this.oldLighting=new Xe,this.newLighting=new Xe,this._fadedLighting=new Xe,this._lighting=this.newLighting,this.ssr=new Be,this.multipassTerrain=new ke,this.multipassGeometry=new qe,this.overlays=[],this.cloudsFade=new We}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:s}=this;e>=1?this._lighting=s:(this._fadedLighting.lerpLighting(t,s,e),this._lighting=this._fadedLighting)}}class ls{constructor(e,t,s,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new ce,this.output=ie.Color,this.renderOccludedMask=ds,this.bindParameters=new hs(t,s,null!=r?r.plane:null),this.bindParameters.alignPixelEnabled=!0}resetRenderOccludedMask(){this.renderOccludedMask=ds}}class cs extends ls{constructor(e,t,s,r,i){super(e,s,r,i),this.offscreenRenderingHelper=t,this.sliceHelper=i,this.time=p(0)}}const ds=xe.Occlude|xe.OccludeAndTransparent|xe.OccludeAndTransparentStencil;let us=class extends ce{constructor(){super(...arguments),this._projectionMatrix=st()}get projectionMatrix(){return this._projectionMatrix}};function ms(e){return 16*Math.ceil(e/16)}var ps;e([f()],us.prototype,"_projectionMatrix",void 0),e([f({readOnly:!0})],us.prototype,"projectionMatrix",null),us=e([v("esri.views.3d.webgl-engine.lib.CascadeCamera")],us),function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}(ps||(ps={}));class gs{constructor(){this.camera=new us,this.lightMat=st()}}class _s{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class fs{get depthTexture(){return this._fbo?.colorTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return mt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,t){this._rctx=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this.settings=new _s,this._projectionView=st(),this._projectionViewInverse=st(),this._modelViewLight=st(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ve(),this._cascades=[new gs,new gs,new gs,new gs],this._lastOrigin=null,this._maxTextureSize=Math.min(y("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._fbo=a(this._fbo),this._discardAllSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Je(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)Os[e]=this._cascades[e];return Os.length=this._numCascades,Os}start(e,t,s,r,i){ue(this.enabled),this._textureSize=this._computeTextureSize(e,i,r),this._ensureDepthTexture();const{near:a,far:n}=this._clampNearFar(s);this._computeCascadeDistances(n,a,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:h}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,h,o,t);this._lastOrigin=null,this.clear()}finish(e){ue(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!D(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||H(),I(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){b(Ms,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)As[16*t+e]=Ms[e]}}return As}takeCascadeSnapshotTo(e,t){ue(this.enabled);const s=this._ensureSnapshot(t);this._bindFbo();const r=this._rctx,i=r.bindTexture(s,se.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(Q.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),r.bindTexture(i,se.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Y.COLOR_BUFFER_BIT|Y.DEPTH_BUFFER_BIT)}_computeTextureSize(e,t,s){const r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,i=Math.max(e.fullWidth,e.fullHeight)*r,a=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return Math.floor(Math.min(this._maxTextureSize,ms((1===this.numCascades?1:2)*i*a)))}_ensureDepthTexture(){if(this._fbo?.width===this._textureSize)return;const e=new te(this._textureSize);e.wrapMode=q.CLAMP_TO_EDGE,e.samplingMode=k.NEAREST,this._fbo?.dispose(),this._fbo=new K(this._rctx,e,new ee(X.DEPTH_COMPONENT16,this._textureSize))}_ensureSnapshot(e){let t=this._snapshots[e];if(null!=t&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);const s=new te;return s.wrapMode=q.CLAMP_TO_EDGE,s.samplingMode=k.NEAREST,s.width=this._textureSize,s.height=this._textureSize,t=new se(this._rctx,s),this._snapshots[e]=t,t}_discardSnapshot(e){this._snapshots[e]=a(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,t,s,r){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);ue(o<h);for(let e=0;e<8;++e){mt(ws,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:h,1);const t=Rs[e];pt(t,ws,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}P(Cs,Rs[0]),i.camera.viewMatrix=b(ys,this._modelViewLight,Cs);for(let e=0;e<8;++e)L(Rs[e],Rs[e],i.camera.viewMatrix);let l=Rs[0][2],c=Rs[0][2];for(let e=1;e<8;++e)l=Math.min(l,Rs[e][2]),c=Math.max(c,Rs[e][2]);l-=200,c+=200,i.camera.near=-c,i.camera.far=-l,function(e,t,s,r,i){const a=1/Rs[0][3],n=1/Rs[4][3];ue(a<n);let o=a+Math.sqrt(a*n);const h=Math.sin(et(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,function(e,t,s,r,i,a,n,o){rt(Es,0,0);for(let t=0;t<4;++t)it(Es,Es,e[t]);at(Es,Es,.25),rt(Ds,0,0);for(let t=4;t<8;++t)it(Ds,Ds,e[t]);at(Ds,Ds,.25),nt(Is[0],e[4],e[5],.5),nt(Is[1],e[5],e[6],.5),nt(Is[2],e[6],e[7],.5),nt(Is[3],e[7],e[4],.5);let h=0,l=ot(Is[0],Es);for(let e=1;e<4;++e){const t=ot(Is[e],Es);t<l&&(l=t,h=e)}ht(Ps,Is[h],e[h+4]);const c=Ps[0];let d,u;Ps[0]=-Ps[1],Ps[1]=c,ht(Ls,Ds,Es),lt(Ls,Ps)<0&&ct(Ps,Ps),nt(Ps,Ps,Ls,s),dt(Ps,Ps),d=u=lt(ht(js,e[0],Es),Ps);for(let t=1;t<8;++t){const s=lt(ht(js,e[t],Es),Ps);s<d?d=s:s>u&&(u=s)}ut(r,Es),at(js,Ps,d-t),it(r,r,js);let m=-1,p=1,g=0,_=0;for(let t=0;t<8;++t){ht(Hs,e[t],r),dt(Hs,Hs);const s=Ps[0]*Hs[1]-Ps[1]*Hs[0];s>0?s>m&&(m=s,g=t):s<p&&(p=s,_=t)}pe(m>0,"leftArea"),pe(p<0,"rightArea"),at(Vs,Ps,d),it(Vs,Vs,Es),at(Gs,Ps,u),it(Gs,Gs,Es),Ns[0]=-Ps[1],Ns[1]=Ps[0];const f=ge(r,e[_],Gs,it(js,Gs,Ns),1,i),y=ge(r,e[g],Gs,js,1,a),w=ge(r,e[g],Vs,it(js,Vs,Ns),1,n),R=ge(r,e[_],Vs,js,1,o);pe(f,"rayRay"),pe(y,"rayRay"),pe(w,"rayRay"),pe(R,"rayRay")}(Rs,o,h,vs,bs,Ts,Ss,xs),function(e,t,s,r,i){ht(Ws,s,r),at(Ws,Ws,.5),zs[0]=Ws[0],zs[1]=Ws[1],zs[2]=0,zs[3]=Ws[1],zs[4]=-Ws[0],zs[5]=0,zs[6]=Ws[0]*Ws[0]+Ws[1]*Ws[1],zs[7]=Ws[0]*Ws[1]-Ws[1]*Ws[0],zs[8]=1,zs[Us(0,2)]=-lt(Bs(zs,0),e),zs[Us(1,2)]=-lt(Bs(zs,1),e);let a=lt(Bs(zs,0),s)+zs[Us(0,2)],n=lt(Bs(zs,1),s)+zs[Us(1,2)],o=lt(Bs(zs,0),r)+zs[Us(0,2)],h=lt(Bs(zs,1),r)+zs[Us(1,2)];a=-(a+o)/(n+h),zs[Us(0,0)]+=zs[Us(1,0)]*a,zs[Us(0,1)]+=zs[Us(1,1)]*a,zs[Us(0,2)]+=zs[Us(1,2)]*a,a=1/(lt(Bs(zs,0),s)+zs[Us(0,2)]),n=1/(lt(Bs(zs,1),s)+zs[Us(1,2)]),zs[Us(0,0)]*=a,zs[Us(0,1)]*=a,zs[Us(0,2)]*=a,zs[Us(1,0)]*=n,zs[Us(1,1)]*=n,zs[Us(1,2)]*=n,zs[Us(2,0)]=zs[Us(1,0)],zs[Us(2,1)]=zs[Us(1,1)],zs[Us(2,2)]=zs[Us(1,2)],zs[Us(1,2)]+=1,a=lt(Bs(zs,1),t)+zs[Us(1,2)],n=lt(Bs(zs,2),t)+zs[Us(2,2)],o=lt(Bs(zs,1),s)+zs[Us(1,2)],h=lt(Bs(zs,2),s)+zs[Us(2,2)],a=-.5*(a/n+o/h),zs[Us(1,0)]+=zs[Us(2,0)]*a,zs[Us(1,1)]+=zs[Us(2,1)]*a,zs[Us(1,2)]+=zs[Us(2,2)]*a,a=lt(Bs(zs,1),t)+zs[Us(1,2)],n=lt(Bs(zs,2),t)+zs[Us(2,2)],o=-n/a,zs[Us(1,0)]*=o,zs[Us(1,1)]*=o,zs[Us(1,2)]*=o,i[0]=zs[0],i[1]=zs[1],i[2]=0,i[3]=zs[2],i[4]=zs[3],i[5]=zs[4],i[6]=0,i[7]=zs[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=zs[6],i[13]=zs[7],i[14]=0,i[15]=zs[8]}(vs,bs,Ss,xs,i.projectionMatrix),i.projectionMatrix[10]=2/(s-r),i.projectionMatrix[14]=-(s+r)/(s-r)}(s,r,l,c,i.camera),T(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this._textureSize/(1===this.numCascades?1:2);i.camera.viewport=[e%2==0?0:d,0===Math.floor(e/2)?0:d,d,d]}_setupMatrices(e,t){T(this._projectionView,e.projectionMatrix,e.viewMatrix),S(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===G.Global?e.eye:j(Cs,0,0,1);x(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],s)}_clampNearFar(e){let{near:t,far:s}=e;return t<2&&(t=2),s<2&&(s=2),t>=s&&(t=2,s=4),{near:t,far:s}}_computeCascadeDistances(e,t,s){const r=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(me(e/t,4)),r);const i=(e-t)/this._numCascades,a=(e/t)**(1/this._numCascades);let n=t,o=t;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=Ke(n,o,this.settings.splitSchemeLambda),n*=a,o+=i}get gpuMemoryUsage(){return this._snapshots.reduce(((e,t)=>e+(t?.gpuMemoryUsage??0)),this._fbo?.gpuMemoryUsage??0)}get test(){return{cascades:this._cascades,textureSize:this._textureSize}}}const ys=st(),ws=ve(),Rs=[];for(let e=0;e<8;++e)Rs.push(ve());const vs=Ue(),bs=Ue(),Ts=Ue(),Ss=Ue(),xs=Ue(),Cs=H(),Os=[],Ms=st(),As=new Array(64),Es=Ue(),Ds=Ue(),Is=[Ue(),Ue(),Ue(),Ue()],Ps=Ue(),Ls=Ue(),js=Ue(),Hs=Ue(),Vs=Ue(),Gs=Ue(),Ns=Ue();function Us(e,t){return 3*t+e}const Fs=Ue();function Bs(e,t){return rt(Fs,e[t],e[t+3]),Fs}const Ws=Ue(),zs=tt();class qs{constructor(){this.adds=new h,this.removes=new h,this.updates=new h({allocator:e=>e||new ks,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class ks{}class Qs{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function Ys(e){const t=new Map,s=e=>{let s=t.get(e);return s||(s=new Qs,t.set(e,s)),s};return e.removes.forAll((e=>{Xs(e)&&s(e.material).removes.push(e)})),e.adds.forAll((e=>{Xs(e)&&s(e.material).adds.push(e)})),e.updates.forAll((e=>{Xs(e.renderGeometry)&&s(e.renderGeometry.material).updates.push(e)})),t}function Xs(e){return e.geometry.indexCount>=1}class Zs{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,s){if(!this._material.requiresSlot(t,s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,t,s));const r=this._map.get(s);if(null!=r){if(r.ensureResources(e)===Rt.LOADED)return r;this._repository.requestRender()}return null}}class $s extends vt{constructor(e=H()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class Js extends Et{initializeConfiguration(e,t){t.spherical=e.viewingMode===G.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Dt(e.rctx,Js.shader.get().build(this.configuration),Ce)}_setPipelineState(e){const t=this.configuration,s=e===Ye.NONE,r=e===Ye.FrontFace;return Pt({blending:t.output!==ie.Normal&&t.output!==ie.Highlight&&t.output!==ie.ObjectAndLayerIdColor&&t.transparent?s?bt:Tt(e):null,depthTest:{func:St(e)},depthWrite:s?t.writeDepth?Lt:null:xt(e),colorWrite:jt,polygonOffset:s||r?null:Ct(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Js.shader=new At(ze,(()=>import("./WaterSurface.glsl.js").then((e=>e.W))));class Ks extends It{constructor(){super(...arguments),this.output=ie.Color,this.transparencyPassType=Ye.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}e([le({count:ie.COUNT})],Ks.prototype,"output",void 0),e([le({count:Ye.COUNT})],Ks.prototype,"transparencyPassType",void 0),e([le()],Ks.prototype,"spherical",void 0),e([le()],Ks.prototype,"receiveShadows",void 0),e([le()],Ks.prototype,"hasSlicePlane",void 0),e([le()],Ks.prototype,"transparent",void 0),e([le()],Ks.prototype,"enableOffset",void 0),e([le()],Ks.prototype,"writeDepth",void 0),e([le()],Ks.prototype,"hasScreenSpaceReflections",void 0),e([le()],Ks.prototype,"doublePrecisionRequiresObfuscation",void 0),e([le()],Ks.prototype,"hasCloudsReflections",void 0),e([le()],Ks.prototype,"objectAndLayerIdColorInstanced",void 0),e([le()],Ks.prototype,"isDraped",void 0),e([le()],Ks.prototype,"hasMultipassTerrain",void 0),e([le()],Ks.prototype,"cullAboveGround",void 0),e([le({constValue:Mt.Water})],Ks.prototype,"pbrMode",void 0),e([le({constValue:!0})],Ks.prototype,"useCustomDTRExponentForWater",void 0),e([le({constValue:!0})],Ks.prototype,"highStepCount",void 0),e([le({constValue:!1})],Ks.prototype,"useFillLights",void 0);class er extends Ee{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const t=null!=e.cloudsFade.data;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===ie.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(Js,e)}}class tr extends je{constructor(e){super(e,new sr),this._configuration=new Ks,this.animation=new Oe}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Ot,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<rr;const s=this.animation.advance(e);return this.setParameters({timeElapsed:g(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&s}requiresSlot(e,t){switch(t){case ie.Normal:return e===Qe.DRAPED_WATER;case ie.Color:if(this.parameters.isDraped)return e===Qe.DRAPED_MATERIAL;break;case ie.Alpha:break;case ie.Highlight:case ie.ObjectAndLayerIdColor:return e===Qe.OPAQUE_MATERIAL||e===Qe.DRAPED_MATERIAL;default:return!1}let s=Qe.OPAQUE_MATERIAL;return this.parameters.transparent&&(s=this.parameters.writeDepth?Qe.TRANSPARENT_MATERIAL:Qe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===s}createGLMaterial(e){return new er(e)}createBufferWriter(){return new De(y("enable-feature:objectAndLayerId-rendering")?He:Ve)}}class sr extends Me{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=Fe(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Re(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=H(),this.modelTransformation=null}}const rr=35e3;class ir{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function ar(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let s=!0;for(;s;)s=!1,e.forEach((r=>{const i=t.get(r.to);i&&(r.to=i.to,t.delete(i.from),e.removeUnordered(i),s=!0)}))}class nr extends ir{constructor(e,t,s){super(t,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class or{constructor(){this.first=0,this.count=0}}class hr{constructor(){this._numElements=0,this._instances=new Map,this.holes=new h({allocator:e=>e||new ir,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=lr(),this.drawCommandsHighlight=lr(),this.drawCommandsOccludees=lr(),this.drawCommandsShadowHighlightRest=lr()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,s){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=s,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),s=this.holes.front();return null!=this.vao&&1===this.holes.length&&s.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=s.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(cr(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),cr(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function lr(){return new h({allocator:e=>e||new or,deallocator:e=>e})}function cr(e,t){const s=e.back();if(null==s){const s=e.pushNew();return s.first=t.from,void(s.count=t.numElements)}if(i=t,(r=s).first+r.count>=i.from){const e=t.from-s.first+t.numElements;s.count=e}else{const s=e.pushNew();s.first=t.from,s.count=t.numElements}var r,i}class dr{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}const ur=Gt+1;class mr{constructor(e,t,s){this._rctx=e,this._locations=t,this._layout=s,this._cache=e.newCache("VaoCache",pr)}dispose(){this._cache.destroy()}newVao(e){const t=e.toString(),s=this._cache.pop(t);if(null!=s){const r=s.pop();return s.length>0&&this._cache.put(t,s,e*s.length,ur),r}const r=new fe(this._rctx,this._locations,{geometry:this._layout},{geometry:Nt.createVertex(this._rctx,Z.STATIC_DRAW)});return r.vertexBuffers.geometry.setSize(e),r}deleteVao(e){if(null==e)return null;const t=e.byteSize,s=t.toString(),r=this._cache.pop(s);return null!=r?(r.push(e),this._cache.put(s,r,t*r.length,-1)):this._cache.put(s,[e],t,-1),null}}function pr(e,t){if(t===Vt.ALL)return void e.forEach((e=>e.dispose()));const s=e.pop(),r=e.length*s.byteSize;return s.dispose(),r}class gr{constructor(e,t,s){this._rctx=e,this._materialRepository=t,this.material=s,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new Zs(this.material,this._materialRepository),this._bufferWriter=s.createBufferWriter(),this._vaoCache=new mr(e,s.vertexAttributeLocations,wt(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof tr}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==xe.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),a=i?.findBuffer(e.id);if(null==a)return;const n=a.instances.get(e.id);if(r.updateType&(Xt.GEOMETRY|Xt.TRANSFORMATION)){const r=Mr(t.elementCount(n.geometry.geometry)*s),i=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,i,0),a.vao.vertexBuffers.geometry.setSubData(r,n.from*s,0,n.numElements*s),Er()}r.updateType&(Xt.HIGHLIGHT|Xt.OCCLUDEE|Xt.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,t){const s=new oe;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=s.get(e.id,null);null==r&&(r=new _r(e.vec3),s.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id),i=r?.findBuffer(e.id);if(null==i)continue;let a=s.get(t.id,i);null==a&&(a=new _r(t.vec3),s.set(t.id,i,a)),a.changes.push(e)}return s}_addAndRemoveGeometries(e,t){const{_bufferWriter:s,_dataByOrigin:r}=this,i=s.vertexBufferLayout.stride/4,a=this._computeDeltas(e,t);a.forEach(((e,t)=>{const n=e.get(null),o=null!=n?n.changes:[];a.delete(t,null);let h=r.get(t);if(e.forEach(((e,n)=>{if(a.delete(t,n),null==n)return void ue(!1,"No VAO for removed geometries");if(n.instances.size===e.changes.length)return this._vaoCache.deleteVao(n.vao),w(h.buffers,n),void(0===h.buffers.length&&0===o.length&&r.delete(t));const l=n.numElements,c=n.vao.byteSize/4,d=o.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),u=e.changes.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),m=Math.min((l+d-u)*i,Cr),p=m>c;m>br&&m<c/2?(e.changes.forEach((({id:e})=>n.deleteInstance(e))),n.instances.forEach((({geometry:e})=>o.push(e))),this._vaoCache.deleteVao(n.vao),w(h.buffers,n)):p?this._applyAndRebuild(n,o,e):this._applyRemoves(n,e)})),o.length>0)for(null==h&&(h=new dr(n.origin),r.set(t,h)),h.buffers.forEach((e=>this._applyAdds(e,o)));o.length>0;)h.buffers.push(this._applyAndRebuild(new hr,o,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,i(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,s){if(null!=s)for(const t of s.changes)e.deleteInstance(t.id);const r=this._bufferWriter,i=r.vertexBufferLayout.stride,a=i/4,n=Math.floor(Cr/a);let o=e.numElements;for(;t.length>0;){const s=t.pop(),i=r.elementCount(s.geometry);if(o+i>n&&o>0){t.push(s);break}o+=i;const a=new nr(s,0,0);ue(null==e.instances.get(s.id)),e.addInstance(s.id,a)}const h=o*a,l=Mr(h),c=r.vertexBufferLayout.createView(l.buffer);let d=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,s)=>{this._writeGeometry(t.geometry,c,d);const i=d;d+=r.elementCount(t.geometry.geometry),e.updateInstance(s,i,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Ar(h)),e.vao.vertexBuffers.geometry.setSubData(l,0,0,d*a),Er(),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.byteSize/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=vr.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const a=vr.pushNew();a.from=r.from,a.to=r.to}ar(vr);const s=this._bufferWriter.vertexBufferLayout.stride/4,r=vr.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,i=Mr(r);i.fill(0,0,r);const a=e.vao.vertexBuffers.geometry;vr.forAll((e=>a.setSubData(i,e.from*s,0,e.numElements*s))),Er(),e.holes.pushArray(vr.data,vr.length),vr.forAll(((e,t)=>vr.data[t]=null)),vr.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const s=this._bufferWriter,r=s.vertexBufferLayout.stride/4,i=e.numElements,a=t.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),n=Math.min((i+a)*r,Cr),o=4*n;if(e.vao.byteSize<Ar(Cr-br)&&o>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);ar(e.holes);const h=new Array;for(const r of t){const t=s.elementCount(r.geometry),i=fr(e.holes,t);h.push(i)}const l=e.vao.vertexBuffers.geometry;let c=0,d=0,u=0;const m=Mr(n),p=s.vertexBufferLayout.createView(m.buffer);t.forEach(((t,i)=>{const a=h[i];if(null==a)return;if(u!==a){const e=u-d;e>0&&l.setSubData(m,d*r,0,e*r),d=a,c=0}const n=s.elementCount(t.geometry);this._writeGeometry(t,p,c),c+=n,u=a+n;const o=new nr(t,a,a+n);ue(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=u-d;g>0&&l.setSubData(m,d*r,0,g*r),R(t,((e,t)=>null==h[t])),Er()}_writeGeometry(e,t,s){const r=e.localOrigin.vec3;_e(yr,-r[0],-r[1],-r[2]);const i=T(wr,yr,e.transformation);S(Rr,i),C(Rr,Rr),this._bufferWriter.write(i,Rr,e.geometry,t,s)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,t){return this.material.requiresSlot(e,t)}prepareTechnique(e){const{output:t,bindParameters:s}=e;if(!this.requiresSlot(s.slot,t))return null;const r=t===ie.Highlight||t===ie.ShadowHighlight;if(r&&!this._hasHighlights)return null;const i=t===ie.ShadowExcludeHighlight,a=!(r||i);for(const n of this._dataByOrigin.values())for(const o of n.buffers){if(r&&!o.hasHighlights)continue;const n=(r?o.drawCommandsHighlight:i&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null,h=a&&o.drawCommandsOccludees||null;if(n?.length||h?.length){const r=this._glMaterials.load(e.rctx,s.slot,t),i=null!=r?r.beginSlot(s):null;if(null!=i)return i}}return null}render(e,t){const{output:s,bindParameters:r}=e,i=s===ie.Highlight||s===ie.ShadowHighlight,a=s===ie.ShadowExcludeHighlight,n=!(i||a),o=this._rctx;o.appleAmdDriverHelper?.resetIndicesType(),o.bindTechnique(t,this.material.parameters,r);for(const e of this._dataByOrigin.values())for(const s of e.buffers){if(i&&!s.hasHighlights)continue;const h=(i?s.drawCommandsHighlight:a&&s.needsMultipleCommands()?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null,l=n&&s.drawCommandsOccludees||null;(h?.length||l?.length)&&(t.program.bindDraw(new $s(e.origin),r,this.material.parameters),t.ensureAttributeLocations(s.vao),o.bindVAO(s.vao),h?.length&&(t.bindPipelineState(o,r.slot,!1),h.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),l?.length&&(t.bindPipelineState(o,r.slot,!0),l.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class _r{constructor(e){this.origin=e,this.changes=new Array}}function fr(e,t){let s;if(!e.some((e=>!(e.numElements<t||(s=e,0)))))return null;const r=s.from;return s.from+=t,s.from>=s.to&&e.removeUnordered(s),r}const yr=st(),wr=st(),Rr=st(),vr=new h({allocator:e=>e||new ir,deallocator:null}),br=65536,Tr=4*br,Sr=1024,xr=16777216,Cr=xr/4;let Or=new Float32Array(br);function Mr(e){return Or.length<e&&(Or=new Float32Array(e)),Or}function Ar(e){const t=4*e;return t<=Sr?Sr:t<Tr?Tr:Math.max(Math.min(Math.ceil(1.5*t/Tr)*Tr,xr),t)}function Er(){Or=new Float32Array(2)}let Dr=class extends t{constructor(e){super(e),this._pending=new Ir,this._changes=new qs,this._materialRenderers=new Map,this._sortedMaterialRenderers=new h,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return i(this._materialRenderers,(e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=Ys(this._changes);let t=!1,s=!1,r=!1;return e.forEach(((e,i)=>{let a=this._materialRenderers.get(i);if(!a&&e.adds.length>0&&(a=new gr(this.rctx,this._materialRepository,i),this._materialRenderers.set(i,a),t=!0,s=!0,r=!0),!a)return;const n=s||a.hasHighlights,o=r||a.hasWater;a.modify(e),s=s||n!==a.hasHighlights,r=r||o!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(i),a.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),s&&(this._hasHighlights=i(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=i(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const s=this._validateRenderGeometries(e);for(const e of s)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of s)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===Yt.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const s=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);s&&!this._pending.empty&&this.notifyChange("updating"),t===Yt.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const s=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(s),e.updateType=t}switch(s&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case Xt.TRANSFORMATION:case Xt.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Xt.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((s=>t=s.updateAnimation(e)||t)),t}render(e){this._sortedMaterialRenderers.forAll((t=>{if(t.material.shouldRender(e)){const s=t.prepareTechnique(e);null!=s&&t.render(e,s)}}))}intersect(e,t,s,r,i){return this._geometries.forEach((a=>{if(r&&!r(a))return;this._intersectRenderGeometry(a,s,t,0,e,i);const n=this.rendererContext.longitudeCyclical;n&&(a.boundingSphere[0]-a.boundingSphere[3]<n.min&&this._intersectRenderGeometry(a,s,t,n.range,e,i),a.boundingSphere[0]+a.boundingSphere[3]>n.max&&this._intersectRenderGeometry(a,s,t,-n.range,e,i)),i++})),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,s)=>{s.insertOrder=e++,this._sortedMaterialRenderers.push(t)})),this._sortedMaterialRenderers.sort(((e,t)=>{const s=t.material.renderPriority-e.material.renderPriority;return 0!==s?s:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,s,r,i,a){if(!e.visible)return;let n=0;r+=e.transformation[12],n=e.transformation[13],Pr[0]=s[0]-r,Pr[1]=s[1]-n,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,i,Pr,((s,r,n)=>{!function(e,t,s,r,i,a,n){const o=new gt(a,n,t),h=t=>{t.set(yt.OVERLAY,o,e.dist,e.normal,e.transformation,s,r)};if((null==i.results.min.drapedLayerOrder||s>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&h(i.results.min),i.options.store!==_t.MIN&&(null==i.results.max.drapedLayerOrder||s<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&h(i.results.max),i.options.store===_t.ALL){const e=ft(i.ray);h(e),i.results.all.push(e)}}(t,n,e.material.renderPriority,a,i,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const s of e){const e=s.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const s of e){const e=s.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};e([f()],Dr.prototype,"drapeSource",void 0),e([f()],Dr.prototype,"updating",null),e([f()],Dr.prototype,"rctx",null),e([f()],Dr.prototype,"rendererContext",void 0),e([f()],Dr.prototype,"_materialRepository",null),e([f()],Dr.prototype,"_localOriginFactory",null),e([f({readOnly:!0})],Dr.prototype,"isEmpty",null),e([f()],Dr.prototype,"_materialRenderers",void 0),e([f()],Dr.prototype,"_geometries",void 0),Dr=e([v("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Dr);class Ir{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Pr=Ue();class Lr extends Et{initializeProgram(e){return new Dt(e.rctx,Lr.shader.get().build(),Ce)}initializePipeline(){return this.configuration.hasAlpha?Pt({blending:Ht($.SRC_ALPHA,$.ONE,$.ONE_MINUS_SRC_ALPHA,$.ONE_MINUS_SRC_ALPHA),colorWrite:jt}):Pt({colorWrite:jt})}}Lr.shader=new At(ae,(()=>import("./TextureOnly.glsl.js").then((e=>e.T))));class jr extends he{constructor(){super(...arguments),this.hasAlpha=!1}}e([le()],jr.prototype,"hasAlpha",void 0);let Hr=class extends t{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new r,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new h,this._passParameters=new ne,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new ce,this.worldToPCSRatio=1,this.events=new s,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView,{waterTextureRepository:t,stippleTextureRepository:s,markerTextureRepository:r}=e;this._shaderTechniqueRepository=new es({rctx:this._rctx,viewingMode:G.Local,stippleTextureRepository:s,markerTextureRepository:r,waterTextureRepository:t}),this._renderContext=new ls(this._rctx,new fs(this._rctx,this.view.state.viewingMode),new Ze(this.view,this._shaderTechniqueRepository,this._rctx,(()=>{}))),this._handles.add([l((()=>t.updating),(()=>this.events.emit("content-changed")),c),l((()=>this.spatialReference),(e=>this._localOriginFactory=new ns(e)),c),d((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new is(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&Ur)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=Qe.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=ye(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Ye.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new $e(V(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(Ut.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=n(this._debugTextureTechnique),this._passParameters.texture=a(this._passParameters.texture),this._bindParameters.highlightDepthTexture=a(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=o(this._shaderTechniqueRepository),this._temporaryFBO=a(this._temporaryFBO),this._quadVAO=a(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||i(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._overlayRenderTarget}get gpuMemoryUsage(){return null!=this._overlayRenderTarget?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Dr)}createDrapeSourceRenderer(e,t,s){const r=this._renderers.get(e);null!=r&&r.destroy();const i=new t({...s,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(l((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),t.destroy())}collectUnusedRenderTargetMemory(){let e=!1;const t=_();if(null!=this._overlayRenderTarget)for(const s of this._overlayRenderTarget.renderTargets){const r=this.overlays[B.INNER].validTargets[s.type];e=this._overlayRenderTarget.validateUsageForTarget(r,s,t)||e}return e}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){null!=this._overlays&&this._overlays.forEach((t=>t.hasTargetWithoutRasterImage=m(e,(e=>e.drapeTargetType===Qt.WithoutRasterImage))))}ensureDrapeSources(e){null!=this._overlays&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=m(e,(e=>e.drapeSourceType===qt.Features)),t.hasDrapedRasterSource=m(e,(e=>e.drapeSourceType===qt.RasterImage))}))}ensureOverlays(e,t){null==this._overlays&&(this._overlayRenderTarget=new Jt(this._rctx),this._overlays=[new W(B.INNER,this._overlayRenderTarget),new W(B.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=a(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let s=!1;for(const[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(s=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,s=!0,this._updateSortedDrapeSourceRenderers()),s&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ft,(e=>e.updatePolicy===Ge.SYNC))}get isEmpty(){return!N.OVERLAY_DRAW_DEBUG_TEXTURE&&!i(this._renderers,(e=>!e.isEmpty))}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._renderers.forEach((s=>t=s.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,t,s){const r=e.canvasGeometries;if(0===r.numViews)return!1;const{alignPixelEnabled:i,contentPixelRatio:a}=s;this._screenToWorldRatio=a*e.mapUnitsPerPixel/z;const n=t.output;if(this.isEmpty||n===ie.Highlight&&!this.hasHighlights||n===ie.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const o=t.fbo;if(!o.isValid())return!1;const h=2*e.resolution,l=e.resolution;o.resize(h,l);const c=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*a,this._renderContext.output=n,this._bindParameters.alignPixelEnabled=i,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===ie.Normal?Qe.DRAPED_WATER:Qe.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(c),e.index===B.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Y.COLOR_BUFFER_BIT)),t.type===U.Occluded&&(this._renderContext.renderOccludedMask=Ur),N.OVERLAY_DRAW_DEBUG_TEXTURE&&t.type!==U.Occluded)for(let t=0;t<r.numViews;t++)this._setViewParameters(r.extents[t],e),this._drawDebugTexture(e.resolution,Gr[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll((({drapeSource:s,renderer:i})=>{if(t.type===U.ColorNoRasterImage&&s.drapeSourceType===qt.RasterImage)return;const{fullOpacity:a}=s,d=null!=a&&a<1&&n===ie.Color;d&&(this.bindTemporaryFramebuffer(this._rctx,h,l),c.clearSafe(Y.COLOR_BUFFER_BIT));for(let t=0;t<r.numViews;t++)this._setViewParameters(r.extents[t],e),i.render(this._renderContext);d&&null!=this._temporaryFBO&&(o.bind(c),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),a,e.index))})),c.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,s){null==this._temporaryFBO&&(this._temporaryFBO=new Zt(e,!1)),this._temporaryFBO.resize(t,s),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,s,r){let i=0;for(const a of this._renderers.values())i=a.intersect?.(e,t,s,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((t,s)=>{const r=e.indexOf(s.layer),i=r>=0,a=this._renderers.size*(s.renderGroup??(i?kt.MapLayer:kt.ViewLayer))+(i?r:0);this._sortedRenderers.push(new Vr(s,t,a))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const s=this._camera;s.viewport=[0,0,t.resolution,t.resolution],O(s.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],s.near,s.far),M(s.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=i(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=i(this._renderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=i(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,t);const s=this._rctx;s.bindTechnique(this._debugTextureTechnique,this._passParameters,null),s.bindVAO(this._quadVAO),s.drawArrays(J.TRIANGLE_STRIP,0,re(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(j(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const s=new Uint8Array(e*e*4);let r=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){const a=Math.floor(i/10),n=Math.floor(t/10);a<2||n<2||10*a>e-20||10*n>e-20?(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=255):(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=1&a&&1&n?1&i^1&t?0:255:1&a^1&n?0:128)}const i=new te(e);i.samplingMode=k.NEAREST,this._passParameters.texture=new se(this._rctx,i,s);const a=new jr;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(Lr,a),this._quadVAO=we(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};e([f()],Hr.prototype,"_sortedDrapeSourceRenderersDirty",void 0),e([f({autoDestroy:!0})],Hr.prototype,"_shaderTechniqueRepository",void 0),e([f({constructOnly:!0})],Hr.prototype,"view",void 0),e([f()],Hr.prototype,"worldToPCSRatio",void 0),e([f()],Hr.prototype,"spatialReference",void 0),e([f({type:Boolean,readOnly:!0})],Hr.prototype,"updating",null),e([f()],Hr.prototype,"isEmpty",null),Hr=e([v("esri.views.3d.terrain.OverlayRenderer")],Hr);class Vr{constructor(e,t,s){this.drapeSource=e,this.renderer=t,this.index=s}}const Gr=[[1,.5,.5],[.5,.5,1]],Nr=-2,Ur=xe.OccludeAndTransparent;class Fr{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=st(),this._shaderTransformation=null,this._boundingSphere=null,this.id=u(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.shaderTransformer=t.shaderTransformer,this.castShadow=t.castShadow??!1}get transformation(){return this._transformation}get boundingInfo(){return this.geometry.boundingInfo}updateTransformation(e){e(this._transformation),this._shaderTransformation=this._boundingSphere=null}shaderTransformationChanged(){this._shaderTransformation=null}get boundingSphere(){return this._boundingSphere?this._boundingSphere:this.boundingInfo?(this._boundingSphere=L(Wt(),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*zt(this.shaderTransformation),this._boundingSphere):Bt}get hasShaderTransformation(){return null!=this.shaderTransformer}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return null==this.shaderTransformer?this.transformation:(this._shaderTransformation||(this._shaderTransformation=A(st(),this.shaderTransformer(this.transformation))),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{hs as B,qs as C,Nr as D,ns as G,gr as M,Hr as O,Fr as R,Dr as S,Lr as T,sr as W,qt as a,kt as b,Yt as c,ms as d,$s as e,Xt as f,fs as g,ps as h,cs as i,jr as j,es as k,is as l,Zs as m,tr as n,Ur as o,Qt as p,Ys as s};

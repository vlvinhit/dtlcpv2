/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{t as e,a as s}from"./screenUtils.js";import{i as t,p as n}from"./color.js";import{N as i}from"./definitions.js";import{c as l}from"./enums4.js";import o from"../core/Error.js";import{L as r}from"./Logger.js";const a=8388607,u=8388608,p=0,c=1,f=e=>(e&u)>>>23,v=e=>e&a,m=e=>1===f(e)?254:255;function d(e){return 1===f(e)}function S(e,s){return((s?u:0)|e)>>>0}const y=(e,s)=>e&&((...e)=>s.warn("DEBUG:",...e))||(()=>null),E=!1;function g(e){return t(e.minDataValue)&&t(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?l.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?l.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?l.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?l.SIZE_UNIT_VALUE:(r.getLogger("esri.views.2d.engine.webgl").error(new o("mapview-bad-type","Found invalid size VisualVariable",e)),l.NONE)}function x(e,s){if(!e||!s)return e;switch(s){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function z(s){return(s??[]).map((s=>function(s){return{value:s.value,size:e(s.size)}}(s)))}function h(s){if("string"==typeof s||"number"==typeof s)return e(s);const t=s;return{type:"size",expression:t.expression,stops:z(t.stops)}}const w=e=>{const t=[],n=[],l=z(e),o=l.length;for(let e=0;e<6;e++){const r=l[Math.min(e,o-1)];t.push(r.value),n.push(null==r.size?i:s(r.size))}return{values:new Float32Array(t),sizes:new Float32Array(n)}};function _(e){const s=e&&e.length>0?{}:null,t=s?{}:null;if(!s||!t)return{vvFields:s,vvRanges:t};for(const n of e)if(n.field&&(s[n.type]=n.field),"size"===n.type){t.size||(t.size={});const e=n;switch(g(e)){case l.SIZE_MINMAX_VALUE:t.size.minMaxValue={minDataValue:e.minDataValue,maxDataValue:e.maxDataValue,minSize:h(e.minSize),maxSize:h(e.maxSize)};break;case l.SIZE_SCALE_STOPS:t.size.scaleStops={stops:z(e.stops)};break;case l.SIZE_FIELD_STOPS:if(e.levels){const s={};for(const t in e.levels)s[t]=w(e.levels[t]);t.size.fieldStops={type:"level-dependent",levels:s}}else t.size.fieldStops={type:"static",...w(e.stops)};break;case l.SIZE_UNIT_VALUE:t.size.unitValue={unit:e.valueUnit,valueRepresentation:e.valueRepresentation??void 0}}}else if("color"===n.type)t.color=V(n);else if("opacity"===n.type)t.opacity=A(n);else if("rotation"===n.type){const e=n;t.rotation={type:e.rotationType}}return{vvFields:s,vvRanges:t}}function A(e){const s={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;const t=e.stops;for(let e=0;e<8;++e){const n=t[Math.min(e,t.length-1)];s.values[e]=n.value,s.opacities[e]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const t=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;for(let e=0;e<8;e++)s.values[e]=1/0,s.opacities[e]=t}}return s}function I(e,s,t){e[4*s]=t.r/255,e[4*s+1]=t.g/255,e[4*s+2]=t.b/255,e[4*s+3]=t.a}function V(e){if(null==e)return null;if(e.normalizationField)return null;const s={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;s.field=e.field;const t=e.stops;for(let e=0;e<8;++e){const n=t[Math.min(e,t.length-1)];s.values[e]=n.value,I(s.colors,e,n.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const t=e.stops&&e.stops.length>=0&&e.stops[0].color;for(let e=0;e<8;e++)s.values[e]=1/0,I(s.colors,e,t)}}for(let e=0;e<32;e+=4)n(s.colors,e,!0);return s}export{a as D,c as a,p as b,S as c,f as d,m as e,y as f,v as g,E as h,x as i,d as j,g as k,_ as l};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{b as e,h as i,d as a,r as n}from"./utils.js";import{d as o,r as s}from"./maybe.js";import{watch as r,on as l,syncAndInitial as p,when as h,initial as c,sync as u}from"../core/reactiveUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{h as m,r as g}from"./typedArrayUtil.js";import{subclass as _}from"../core/accessorSupport/decorators/subclass.js";import{k as y,s as v,a as f,e as M,E as b,b as S,n as x,i as w,f as E,B as j,D as O,l as A,x as T,C as D,c as G,r as I}from"./vec3.js";import{c as R,f as L,e as P}from"./vec3f64.js";import{g as C,e as V,l as U,b as z,d as H,c as k}from"./elevationInfoUtils.js";import{E as N}from"./ElevationInfo.js";import{e as F,b as X,s as Z}from"./screenUtils.js";import"./Logger.js";import"../core/Error.js";import Y from"../core/Accessor.js";import{c as B,b as q}from"./analysisThemeUtils.js";import{c as W}from"./asyncUtils.js";import{throwIfAborted as Q}from"../core/promiseUtils.js";import{e as J}from"./quantityFormatUtils.js";import{a as K,s as $,e as tt,b as et,l as it,j as at,c as nt}from"./vec2.js";import{a as ot}from"./vec2f64.js";import{i as st,t as rt}from"../geometry/Polygon.js";import{f as lt}from"./messages.js";import{g as pt}from"./getDefaultUnitForView.js";import{T as ht}from"./TextOverlayItem.js";import{d as ct,b as ut,T as dt,S as mt,a as gt,e as _t}from"./automaticLengthMeasurementUtils.js";import{v as yt}from"./viewUtils.js";import{S as vt}from"./SnappingVisualizer3D.js";import{M as ft}from"./interfaces5.js";import{g as Mt,O as bt}from"./OutlineVisualElement.js";import{E as St}from"./ExtendedLineVisualElement.js";import{V as xt}from"./VerticesVisualElement.js";import{e as wt,E as Et}from"./ElevationContext.js";import{G as jt}from"./GraphicState.js";import{R as Ot}from"./Material.js";import{D as At,g as Tt,m as Dt,c as Gt,b as It,a as Rt,u as Lt}from"./editPlaneUtils.js";import{D as Pt,S as Ct,E as Vt}from"./drawSurfaces.js";import{unitRGBAFromColor as Ut,darken as zt,multiplyOpacity as Ht}from"../views/support/colorUtils.js";import kt from"../core/Collection.js";import Nt from"../core/Evented.js";import{HandleOwnerMixin as Ft,HandleOwner as Xt}from"../core/HandleOwner.js";import{s as Zt,z as Yt,c as Bt,e as qt}from"./quantityUtils.js";import{m as Wt}from"./dehydratedFeatures.js";import{M as Qt,R as Jt,c as Kt,g as $t,f as te,p as ee,a as ie,d as ae}from"./manipulatorUtils.js";import{b as ne,S as oe,g as se,i as re}from"./isSupportedGraphic.js";import{c as le}from"./manipulatorUtils2.js";import{d as pe,c as he,r as ce}from"./mathUtils.js";import{L as ue}from"./LaserlineVisualElement.js";import{projectVectorToVector as de,projectPointToVector as me}from"../geometry/projection.js";import{c as ge,k as _e,G as ye}from"./aaBoundingBox.js";import{j as ve}from"./aaBoundingRect.js";import{P as fe}from"./PointVisualElement.js";import Me from"../core/Handles.js";import be from"../Color.js";import{f as Se,y as xe,m as we,a as Ee,x as je,n as Oe,o as Ae,g as Te,C as De,r as Ge}from"./mat4.js";import{c as Ie,f as Re,I as Le}from"./mat4f64.js";import{s as Pe,d as Ce,w as Ve,h as Ue,j as ze,c as He}from"./ray.js";import{b as ke,c as Ne,d as Fe,e as Xe,f as Ze,g as Ye,s as Be}from"./dragEventPipeline3D.js";import{d as qe,b as We,c as Qe,e as Je,f as Ke,g as $e,E as ti,h as ei,I as ii,i as ai,j as ni,s as oi,k as si}from"./dragEventPipeline.js";import{C as ri}from"./basicInterfaces.js";import{o as li,t as pi,k as hi,p as ci,e as ui,a as di,f as mi}from"./GeometryUtil.js";import{C as gi}from"./ColorMaterial.js";import{a as _i,M as yi}from"./interfaces4.js";import{G as vi}from"./GraphicManipulator.js";import{E as fi,P as Mi,O as bi,A as Si,b as xi}from"./EditGeometryOperations.js";import wi from"../views/interactive/sketch/SketchTooltipOptions.js";import{S as Ei}from"./SnappingContext.js";import{c as ji}from"./SnappingDragPipelineStep.js";import{T as Oi,a as Ai,b as Ti,c as Di,d as Gi,e as Ii}from"./TranslateTooltipInfos.js";import{v as Ri,g as Li,h as Pi}from"./euclideanLengthMeasurementUtils.js";import"../geometry.js";import{g as Ci,$ as Vi}from"./unitUtils.js";import Ui from"../geometry/Polyline.js";import{n as zi,f as Hi,c as ki,q as Ni,h as Fi}from"./plane.js";import{l as Xi}from"./utils6.js";import{M as Zi}from"./IViewEvents.js";import{a as Yi}from"./automaticAreaMeasurementUtils.js";import Bi from"../geometry/SpatialReference.js";import qi from"../views/interactive/sketch/SketchLabelOptions.js";import Wi from"../geometry/Point.js";import{V as Qi}from"./ViewingMode.js";import{a as Ji}from"./Cyclical.js";import{addFrameTask as Ki}from"../core/scheduling.js";import{c as $i,d as ta,g as ea,e as ia,a as aa}from"./axisAngleDegrees.js";import na from"../geometry/support/MeshTransform.js";import{c as oa,a as sa}from"./boundedPlane.js";import{A as ra,c as la,O as pa,B as ha,e as ca,C as ua,E as da,F as ma,l as ga,R as _a,o as ya,q as va,v as fa}from"./sliceToolUtils.js";import{g as Ma}from"./Factory.js";import{f as ba}from"./ray2.js";import{E as Sa,a as xa}from"./ExtentTooltipInfos.js";import"../core/lang.js";import"./watch.js";import"./ArrayPool.js";import"./ObjectPool.js";import"./get.js";import"./tracking.js";import"../config.js";import"./object.js";import"./string.js";import"./nextTick.js";import"./PooledArray.js";import"./metadata.js";import"./common.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./jsonMap.js";import"../core/JSONSupport.js";import"./ObservableBase.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./extentUtils.js";import"./vec4.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./unitFormatUtils.js";import"./ByteSizeUnit.js";import"./number.js";import"./locale.js";import"../portal/Portal.js";import"../kernel.js";import"../core/urlUtils.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./projector.js";import"./widgetUtils.js";import"../intl.js";import"./date.js";import"./datetime.js";import"./assets.js";import"../widgets/Widget.js";import"./domUtils.js";import"./uuid.js";import"./dom.js";import"./guid.js";import"./index.js";import"./jsxWidgetSupport.js";import"./messageBundle.js";import"./jsxFactory.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./_commonjsHelpers.js";import"./hydrated.js";import"../geometry/support/geodesicUtils.js";import"./geodesicConstants.js";import"./vec4f32.js";import"./EngineVisualElement.js";import"../core/Identifiable.js";import"./RenderGeometry.js";import"./FloatsPassUniform.js";import"./mat3.js";import"./mat3f64.js";import"./interfaces2.js";import"./ShaderBuilder.js";import"./Util2.js";import"./vec4f64.js";import"./View.glsl.js";import"./Float3PassUniform.js";import"./FloatPassUniform.js";import"./Matrix4PassUniform.js";import"./enums3.js";import"./FramebufferObject.js";import"./VertexArrayObject.js";import"./Texture.js";import"./contextUtils.js";import"./ShaderOutput.js";import"./TextureOnly.glsl.js";import"./ScreenSpacePass.glsl.js";import"./VertexAttribute.js";import"./Float4PassUniform.js";import"./Texture2DPassUniform.js";import"./NestedMap.js";import"./ShaderTechniqueConfiguration.js";import"./Camera.js";import"./frustum.js";import"./vector.js";import"./glUtil3D.js";import"./VertexElementDescriptor.js";import"./Attribute.js";import"./DefaultBufferWriter.js";import"./Indices.js";import"./triangle.js";import"./lineSegment.js";import"./doublePrecisionUtils.js";import"./BufferView.js";import"./TriangleMaterial.js";import"./sphere.js";import"./mathUtils2.js";import"./Octree.js";import"./InterleavedLayout.js";import"./types.js";import"./RenderSlot.js";import"./MarkerSizing.glsl.js";import"./VisualVariables.glsl.js";import"./Matrix3PassUniform.js";import"./sdfPrimitives.js";import"./floatRGBA.js";import"./Texture2.js";import"./requestImageUtils.js";import"./TransparencyPassType.js";import"./DefaultTechniqueConfiguration.js";import"./RibbonLine.glsl.js";import"./ForwardLinearDepth.glsl.js";import"./RgbaFloatEncoding.glsl.js";import"./Slice.glsl.js";import"./ObjectAndLayerIdColor.glsl.js";import"./OutputDepth.glsl.js";import"./LineStipple.glsl.js";import"./MultipassTerrainTest.glsl.js";import"./ReadLinearDepth.glsl.js";import"./PiUtils.glsl.js";import"./AlphaCutoff.js";import"./ColorConversion.glsl.js";import"./Program2.js";import"./OrderIndependentTransparency.js";import"./renderState.js";import"./WaterSurface.glsl.js";import"./Transform.glsl.js";import"./OutputHighlight.glsl.js";import"./PhysicallyBasedRendering.glsl.js";import"./compilerUtils.js";import"./Texture2DDrawUniform.js";import"./NormalUtils.glsl.js";import"./BooleanPassUniform.js";import"./MultipassGeometryTest.glsl.js";import"./SSAOHelper.js";import"./SSAOBlur.glsl.js";import"./SSAO.glsl.js";import"./CameraSpace.glsl.js";import"./Intersector.js";import"./Intersector2.js";import"./verticalOffsetUtils.js";import"./quat.js";import"./quatf64.js";import"./vec3f32.js";import"./glUtil.js";import"./VertexNormal.glsl.js";import"./MemCache.js";import"./Scheduler.js";import"../core/signal.js";import"./SimpleObservable.js";import"./debugFlags.js";import"./VisualElement.js";import"./VisualElementResources.js";import"./RightAngleQuadVisualElement.js";import"./Settings2.js";import"./LineSnappingHint.js";import"./snappingUtils.js";import"./InputManager.js";import"./Queue.js";import"./PropertiesPool.js";import"./keybindings.js";import"./memoize.js";import"./lineStippleUtils.js";import"./DoubleArray.js";import"./line.js";import"./line2.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./LineVisualElement.js";import"./ElevationProvider.js";import"./graphicUtils.js";import"./hydratedFeatures.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"./shared.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"./colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"../layers/mixins/ScaleRangeLayer.js";import"./WatchUpdatingTracking.js";import"../geometry/Circle.js";import"./surfaceCoordinateSystems.js";import"./mat2d.js";import"./mat2df64.js";import"./helpMessageUtils.js";import"./centroid2.js";import"./diffUtils.js";import"./dehydratedFeatureComparison.js";import"./SnappingOperation.js";import"./colorUtils2.js";import"./byteSizeEstimations.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./ImageMaterial.js";import"./GLTextureMaterial.js";import"./ImageMaterial.glsl.js";import"./NativeLineMaterial.js";import"./NativeLine.glsl.js";import"./VertexColor.glsl.js";import"./ShadedColorMaterial.glsl.js";import"./LaserlinePath.glsl.js";import"./Laserline.glsl.js";import"./Laserlines.glsl.js";import"./pe.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./HUDMaterial.js";import"./HUD.glsl.js";import"./VerticalOffset.glsl.js";import"./HUDMaterial.glsl.js";import"./drawUtils.js";import"./ColorMaterial.glsl.js";import"./defaults.js";import"./defaultsJSON.js";import"./drapedUtils.js";import"./geometry2dUtils.js";import"./RightAngleSnappingHint.js";import"./PointSnappingHint.js";import"./measurementUtils2.js";import"./spatialReferenceEllipsoidUtils.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./LRUCache.js";import"./euclideanAreaMeasurementUtils.js";import"../analysis/SlicePlane.js";import"./persistable.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"./RenderCoordsHelper.js";const wa={default:15,far:25};let Ea=class extends Y{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=W((async t=>{const e=await lt("esri/core/t9n/Units");Q(t),this._messagesUnits=e}));this.addHandles([r((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((t=>l((()=>this.context?.editGeometryOperations),t,(()=>this._update())))),e((()=>t.abort()))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return null==this._messagesUnits}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((t=>t.label.text))}}get _edgeDistancePixels(){return wa[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(null==t)return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const n=e.length;for(let o=0;o<n;++o){const s=[];if(e[o].iterateVertices((t=>{s.push(a.toXYZ(t.pos))})),0===o&&null!=this.stagedVertex&&s.push(a.toXYZ(this.stagedVertex)),s.length<2)continue;const r=s[0],l=s[s.length-1];"polygon"===i.type&&s.length>2&&!y(r,l)&&s.push(r);const p=1===n&&!st(s,!1,!1);let h=Aa,c=Ta;this.toScreenPointArray(t,r,h);for(let e=1;e<s.length;++e){const i=s[e-1],a=s[e];this.toScreenPointArray(t,a,c),this._addLabel(t,i,h,a,c,p),[h,c]=[c,h]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,n,o){const{label:s}=this._getOrCreateLabel(t);if(!this.visible||K(i,n)<3025)return void(s.visible=!1);const r=null!=t.graphicState?t.graphicState.isDraped?"on-the-ground":"absolute-height":C(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,p=ct(e,a,l,r),h=this._messagesUnits,c=pt(t.view);s.text=null!=h&&null!=p?J(h,p,c):"",s.visible=!0;const u=n[0]-i[0],d=n[1]-i[1];o?$(ja,-d,u):$(ja,d,-u),tt(ja,ja),et(ja,ja,this._edgeDistancePixels),it(Oa,i,n,.5),at(Oa,Oa,ja),s.position=[Oa[0],Oa[1]],Math.abs(ja[0])>Math.abs(ja[1])?s.anchor=ja[0]>0?"left":"right":s.anchor=-ja[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new ht({anchor:"center",fontSize:10,textColor:B(),backgroundColor:q(.6)});t.view.overlay?.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){this.context?.view.overlay?.items.remove(t),t.destroy()}};t([d()],Ea.prototype,"context",void 0),t([d()],Ea.prototype,"stagedVertex",void 0),t([d()],Ea.prototype,"visible",void 0),t([d()],Ea.prototype,"edgeDistance",void 0),t([d()],Ea.prototype,"updating",null),t([d()],Ea.prototype,"_messagesUnits",void 0),t([d()],Ea.prototype,"_edgeDistancePixels",null),Ea=t([_("esri.views.interactive")],Ea);const ja=ot(),Oa=ot(),Aa=F(),Ta=F();let Da=class extends Ea{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,n=F()){const{spatialReference:o}=i.data.coordinateHelper;return yt(a,o,e,t,Ga),t.state.camera.projectToScreen(Ga,n),n}};Da=t([_("esri.views.3d.interactive.SegmentLabels3D")],Da);const Ga=R();function Ia(t){const{graphic:i}=t;return[r((()=>t.displaying),(t=>{t?function(t){const{geometry:e}=t;La(e)&&t.notifyMeshTransformChanged({action:ft.EnableFastUpdates})}(i):Ra(i)}),{...p}),e((()=>Ra(i)))]}function Ra(t){const{geometry:e}=t;La(e)&&t.notifyMeshTransformChanged({action:ft.DisableFastUpdates})}function La(t){return"mesh"===t?.type&&!t.vertexSpace.isGeoreferenced}let Pa=class extends At{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new N({mode:t,offset:e})}normalizeCtorArgs(t){if(!t.elevationInfo){const e=t.hasZ??!0;return{...t,elevationInfo:V(e)}}return t}initializeGraphic(t){const{view:e}=this,a=this._createGraphicState=new jt({graphic:t});return i([e.maskOccludee(t),e.trackGraphicState(a),r((()=>({element:this._outlineVisualElement,isDraped:a.isDraped})),(({element:t,isDraped:e})=>{t&&(t.isDraped=e)}),p),this._setupLoadingIndicator(a),...Ia(a)])}makeDrawOperation(){const{geometryType:t}=this,e="circle"!==t&&"rectangle"!==t;return new Pt({view:this.view,manipulators:this.manipulators,geometryType:Tt(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ct(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Vt(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new vt,segmentLabels:e?new Da:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===U(this.hasZ,this.elevationInfo)})}onActiveVertexChanged(t){const{view:i}=this,a=Mt(i);if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[t],this._updateVerticalLineVisualElement(t),null;const n=a.manipulators,s=n.vertex;this._activeVertexVisualElement=new xt({view:i,spatialReference:i.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,color:Ut(s.color),size:s.size,outlineColor:Ut(s.outlineColor),outlineSize:s.outlineSize,renderOccluded:s.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=Ut(n.selected.color),this._activeVertexVisualElement.attached=!0;const r=a.visualElements.zVerticalLine;return this._verticalLineVisualElement=new St({view:i,extensionType:r.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ot.OccludeAndTransparent}),r.apply(this._verticalLineVisualElement),e((()=>{this._activeVertexVisualElement=o(this._activeVertexVisualElement),this._verticalLineVisualElement=o(this._verticalLineVisualElement)}))}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(!e)return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;v(Va,t[0],t[1],t[2]),Ca.setFromElevationInfo(this.elevationInfo),Va[2]=wt(Va,a,Ca,i),i.toRenderCoords(Va,this.view.spatialReference,Va)?(e.setStartEndFromWorldDownAtLocation(Va),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=t,null;const i=this.internalGraphicsLayer.elevationInfo,{view:a}=this,n=Mt(a);return this._outlineVisualElement=new bt({view:a,geometry:t,elevationInfo:i,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===U(this.hasZ,i),attached:!1}),n.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),n.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,e((()=>{this._outlineVisualElement=o(this._outlineVisualElement)}))}onRegularVerticesChanged(t){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=t,null;const{view:i}=this,a=Mt(i).manipulators.vertex;return this._verticesVisualElement=new xt({view:i,spatialReference:i.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,color:Ut(a.color),size:a.size,outlineColor:Ut(a.outlineColor),outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,e((()=>{this._verticesVisualElement=o(this._verticesVisualElement)}))}_updateGraphicGeometry(t,e){if("mesh"===this.geometryType&&"point"===e?.type){const i=this.geometryToPlace;return i&&i.centerAt(e),void(i&&t.geometry===i?i.vertexSpace.isGeoreferenced?t.notifyGeometryChanged():t.notifyMeshTransformChanged():t.geometry=i)}super._updateGraphicGeometry(t,e)}_setupLoadingIndicator(t){const{drawOperation:a}=this;if(!this.geometryToPlace)return a.loading=!1,null;a.loading=!0;const n=e((()=>{a.loading=!1}));let o;const s=()=>o&&cancelAnimationFrame(o);return i([h((()=>t.displaying),(()=>{s(),o=requestAnimationFrame((()=>n.remove()))}),{...p,once:!0}),e(s),n])}};t([d({constructOnly:!0})],Pa.prototype,"elevationInfo",void 0),t([d({constructOnly:!0})],Pa.prototype,"geometryType",void 0),t([d()],Pa.prototype,"type",void 0),t([d({constructOnly:!0})],Pa.prototype,"view",void 0),Pa=t([_("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Pa);const Ca=new Et,Va=R();var Ua,za;!function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"}(Ua||(Ua={})),function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"}(za||(za={}));class Ha{constructor(){this.grabbingState=Ua.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=Ua.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator(((t,e)=>{if(e===za.TRANSLATE_Z&&(this.zManipulator=t),t instanceof Qt&&(t.selected&&(0===this.numSelected&&(this.firstSelected=t),this.numSelected++),null==this.firstGrabbedXY&&t.grabbing&&e===za.TRANSLATE_XY&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=Ua.ANY,e){case za.TRANSLATE_Z:this.grabbingState|=Ua.Z;break;case za.TRANSLATE_XY:this.grabbingState|=Ua.XY}}))}}function ka(t){return null!=t.geometry&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const Na=R();function Fa(t){const{view:e,graphic:o}=t,s=new jt({graphic:o}),l=[],p=function(t,e,i){const{view:o,graphic:s}=t,l=new fe({view:o,geometry:Xa(s),elevationInfo:z(s),attached:!1});return function(t,e,i,a){(function(t,e,i,a){const{view:o,graphic:s}=t;let r=null;const l=()=>{const t=Xa(s);(t=>{null!=r&&(r.remove(),r=null),i.isDraped&&null!=t&&(r=function(i,a,n){const o=i.elevationProvider.spatialReference;me(a,Za,o);const s=Za[0],r=Za[1];return i.elevationProvider.on("elevation-change",(i=>{ve(i.extent,s,r)&&(e.geometry=t)}))}(o,t))})(t),e.geometry=t};a.push(i.on("changed",l),n((()=>r))),l()})(t,e,i,a),Mt(t.view).visualElements.pointGraphics.outline.apply(e),a.push(r((()=>i.displaying),(()=>e.attached=i.displaying),c))}(t,l,e,i),i.push(a(l)),l}(t,s,l);return function(t,e,i,n){const{view:o,graphic:s}=t,l=Mt(o),p=new St({view:o,extensionType:l.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ot.OccludeAndTransparent});l.visualElements.zVerticalLine.apply(p);const h=new ue({view:o,intersectsLineInfinite:!0,attached:!1});l.visualElements.pointGraphics.shadowStyle.apply(h);const c=pe(l.visualElements.heightPlaneAngleCutoff),u=new ue({view:o,attached:!1,angleCutoff:c});l.visualElements.heightPlane.apply(u);const d=z(t.graphic),m=Et.fromElevationInfo(d),g="on-the-ground"===d.mode||!d.offset&&"absolute-height"!==d.mode,_=new Ha;let y=1,f=1;const M=()=>{_.update(t);const i=Xa(s),a=g&&(e.isDraped||null==i||!i.hasZ);let r=!0;if(a||null==i)r=!1;else{const t=wt(i,o.elevationProvider,m,o.renderCoordsHelper);v(Za,i.x,i.y,t),de(Za,i.spatialReference,Za,o.renderCoordsHelper.spatialReference),p.setStartEndFromWorldDownAtLocation(Za),h.intersectsWorldUpAtLocation=Za}const c=_.grabbingState&Ua.Z?l.visualElements.laserlineAlphaMultiplier:1;c!==y&&(y=c,l.visualElements.heightPlane.apply(u,c));const d=_e(Ya);!a&&e.displaying&&n.calculateMapBounds(d)&&de(ye(d,Za),o.spatialReference,Za,o.renderCoordsHelper.spatialReference)?(u.heightManifoldTarget=Za,u.attached=!0):u.attached=!1;const M=_.grabbingState&Ua.XY?l.visualElements.laserlineAlphaMultiplier:1;M!==f&&(f=M,l.visualElements.pointGraphics.shadowStyle.apply(h,M));const b=r&&e.displaying&&!a;h.attached=b,p.attached=b};i.push(r((()=>[e.displaying,e.isDraped]),M),e.on("changed",M)),t.forEachManipulator((t=>{i.push(t.events.on("grab-changed",M))})),i.push(a(h)),i.push(a(p)),i.push(a(u)),M()}(t,s,l,p),l.push(e.trackGraphicState(s)),{visualElement:p,remove(){i(l).remove()}}}function Xa(t){const e=t.geometry;return null==e?null:"point"===e.type?e:"mesh"===e.type?e.anchor.clone():null}const Za=R(),Ya=ge();function Ba(t){switch(t.graphic.geometry.type){case"point":case"mesh":return Fa(t);case"polygon":case"polyline":return function(t){const{view:e,graphic:o}=t,s=new jt({graphic:o}),l=function(t,e){const{view:n,graphic:o}=t,s=new bt({view:n,geometry:ka(o)?o.geometry:null,elevationInfo:z(o),attached:!1}),l=Mt(n).visualElements.lineGraphics;l.shadowStyle.apply(s);const p=()=>{s.attached=e.displaying};l.outline.apply(s);const h=[r((()=>e.displaying),p),r((()=>e.isDraped),(t=>{s.isDraped=t})),e.on("changed",(()=>s.geometry=ka(o)?o.geometry:null)),a(s)];return p(),{visualElement:s,remove:()=>i(h).remove()}}(t,s),p=function(t,e,o){const{graphic:s,view:l}=t,p=[],h=z(s),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,u=new Ha,d=Mt(l).visualElements,m=new St({view:l,extensionType:d.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Ot.OccludeAndTransparent});d.pointGraphics.shadowStyle.apply(m);const g=pe(d.heightPlaneAngleCutoff),_=new ue({view:l,attached:!1,angleCutoff:g});d.heightPlane.apply(_);let y=1,b=1;const S=()=>{if(u.update(t),!o.displaying||c&&(o.isDraped||!ka(s)||!s.geometry.hasZ))return e.laserlineEnabled=!1,m.attached=!1,void(_.attached=!1);e.laserlineEnabled=!0;const i=u.grabbingState&Ua.XY?d.laserlineAlphaMultiplier:1;i!==y&&(y=i,d.lineGraphics.shadowStyle.apply(e,i),d.pointGraphics.shadowStyle.apply(m,i));const a=u.grabbingState&Ua.Z?d.laserlineAlphaMultiplier:1;a!==b&&(b=a,d.heightPlane.apply(_,a)),function(t,e){const i=1===e.numSelected?e.firstSelected:e.numSelected>1&&null!=e.firstGrabbedXY?e.firstGrabbedXY:null;null!=i?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}(m,u),function(t,e,i,a){if(a.numSelected>0){v(Na,0,0,0);let e=0;t.forEachManipulator(((t,i)=>{i===za.TRANSLATE_XY&&t.selected&&t instanceof Qt&&(f(Na,Na,t.renderLocation),e++)})),e>0?(i.heightManifoldTarget=M(Na,Na,1/e),i.attached=!0):i.attached=!1}else{const a=e.attachmentOrigin;null!=a&&t.view.renderCoordsHelper.toRenderCoords(a,Na)?(i.heightManifoldTarget=Na,i.attached=!0):i.attached=!1}}(t,e,_,u)};d.zVerticalLine.apply(m),p.push(o.on("changed",S),r((()=>o.displaying),S),e.events.on("attachment-origin-changed",S),a(m),a(_));const x=[],w=()=>{i(x).remove(),x.length=0,t.forEachManipulator((t=>x.push(t.events.on("grab-changed",S)))),t.forEachManipulator((t=>x.push(t.events.on("select-changed",S)))),S()};return w(),p.push(t.onManipulatorsChanged(w),n((()=>i(x)))),i(p)}(t,l.visualElement,s),h=[l,p,e.maskOccludee(o),e.trackGraphicState(s)];return{visualElement:l.visualElement,remove:()=>i(h).remove()}}(t);default:return null}}const qa=70,Wa=Math.ceil(qa/3*2),Qa=5*Math.PI/12,Ja=1*Math.PI/3;class Ka{constructor(){this._available=!0}set location(t){this._forEachManipulator3D((e=>e.location=t))}set elevationAlignedLocation(t){this._forEachManipulator3D((e=>e.elevationAlignedLocation=t))}set elevationInfo(t){this._forEachManipulator3D((e=>e.elevationInfo=t))}get renderLocation(){let t;return this._forEachManipulator3D((e=>{t||(t=e.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D((e=>e.available=t))}get hovering(){return this.someManipulator((t=>t.hovering))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}hasManipulator(t){return this.someManipulator((e=>e===t))}someManipulator(t){let e=!1;return this.forEachManipulator((i=>{!e&&t(i)&&(e=!0)})),e}_forEachManipulator3D(t){this.forEachManipulator(((e,i)=>{e instanceof Qt&&t(e,i)}))}}function $a(t,e,i,a){const n=t.graphic,o=(t,i)=>e({action:t,graphic:n,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((t,e,i)=>(e.next((t=>("start"===t.action&&o("start",t),t))).next(qe(n,a)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&o("update",t);break;case"end":o("end",t)}return t})),{steps:e,cancel:i=i.next(We(n)).next((t=>(o("end",{screenDeltaX:0,screenDeltaY:0}),t)))})))}function tn(t){if(null==t||"polyline"!==t.type&&"polygon"!==t.type)return 0;const e=("polyline"===t.type?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}function en(t){if(null==t||null==t.axis)return 1;const{mapStart:e,mapEnd:i,axis:a}=t,n=[i.x-e.x,i.y-e.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}class an extends Ka{constructor(t){super(),this._handles=new Me,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=qa,this._updateAfterDrag=!1,this.events=new Nt,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=o(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,za.TRANSLATE_XY)}createGraphicDragPipeline(t,e,i){const a=e.graphic,n=z(a),o=a.geometry.spatialReference;return $a(e,i,(e=>this.createDragPipeline(((i,a,n,o,s)=>(({steps:a,cancel:n}=t(i,a,n,o,s)),e(i,a,n))),n,o,a)),this._view.state.viewingMode)}createDragPipeline(t,e,a,n){return i(this._arrowManipulatorInfos.map((({manipulator:i},o)=>Qe(i,((i,s,r,l,p)=>{const h=s.next((t=>({...t,manipulatorType:za.TRANSLATE_XY}))).next(Je(this._view,i.elevationAlignedLocation)).next(ke(this._view,i.elevationAlignedLocation,e,a,n)).next(Ke(i.location,this.angle+(o+1)*Math.PI*.5)).next($e());t(i,h,r,l,p)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},i){const a=this._radius/qa,n=54*a,o=n*Math.sqrt(3)/2,s=li(this._opaqueMaterial,o,n/2,n/2,.02);pi(s,Se(Ce.get(),v(Pe.get(),0,-o/3,0))),t.renderObjects=[new Jt(s,_i.Focused),new Jt(s.instantiate({material:this._transparentMaterial}),_i.Unfocused)],t.radius=o/3*2*1.2;const r=xe(Ce.get(),i*Math.PI/2),l=Se(Ce.get(),v(Pe.get(),0,100*a,0));we(e,r,l)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=Ee(Ce.get(),t,L(0,0,1));if(null==e)return;const i=je(Ce.get(),v(Pe.get(),this.displayScale,this.displayScale,this.displayScale)),a=we(Ce.get(),i,e);for(const t of this._arrowManipulatorInfos){const e=we(Ce.get(),a,t.transform);t.manipulator.modelTransform=e}}_createArrowManipulator(t){const e=new Qt({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:L(0,0,1)}}),i={manipulator:e,transform:Ie()};return this._updateArrowManipulator(i,t),this._handles.add(e.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(t=1){const e=Mt(this._view),i=be.toUnitRGBA(e.colors.accent);return i[3]*=t,new gi({color:i,transparent:1!==t,cullFace:ri.Back,renderOccluded:Ot.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}class nn{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e=this._lastDragEvent.mapEnd,i=this._snap(this._lastDragEvent.screenEnd);if(null!=i){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:!0===t?i:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=t}_snap(t){const e=null!=this._view?this._view.toMap(t,{exclude:[]}):null;return null!=e&&null!=this._view&&(e.z=H(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const i=new ti;return this._next=i,[t=>{if(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const e=this._snap(t.screenEnd);return null!=e?{action:t.action,mapStart:t.mapStart,mapEnd:e,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}},i]}}class on extends Ka{constructor(t){super(),this._snapToScene=new nn,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=qa,this._view=t.view,this._tool=t.tool,null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,za.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,i){const a=e.graphic,n=z(a),o=a.geometry.spatialReference;return $a(e,i,(e=>this.createDragPipeline(((i,a,n,o,s)=>(({steps:a,cancel:n}=t(i,a,n,o,s)),e(i,a,n))),n,o,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){const n=this._view;return Qe(this._manipulator,((o,s,r,l,p)=>{const h=s.next(Je(n,o.elevationAlignedLocation)).next(ke(n,o.elevationAlignedLocation,e,i,a)).next(...this._snapToScene.createDragEventPipelineStep(n,e)).next((t=>({...t,manipulatorType:za.TRANSLATE_XY}))).next($e());t(o,h,r,l,p)}))}_updateManipulatorTransform(){const t=je(Ce.get(),v(Pe.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new Qt({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:L(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=hi(this._discMaterial,.02,1,128,L(0,0,1),L(0,0,0));t.transformation=je(Ie(),L(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new Jt(t,_i.Focused),new Jt(t.instantiate({material:this._discMaterialTransparent}),_i.Unfocused)],this._manipulator.radius=this._radius/qa*80}_createMaterial(t=1){const e=Mt(this._view),i=be.toUnitRGBA(e.colors.accent);return i[3]*=t,new gi({color:i,transparent:1!==t,cullFace:ri.Back,renderOccluded:Ot.Transparent})}get test(){return{discManipulator:this._manipulator}}}class sn extends Ka{constructor(t){super(),this._radius=qa,this.events=new Nt,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._manipulator.applyObjectTransform=hn,this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,za.TRANSLATE_Z)}createGraphicDragPipeline(t,e,i){const a=e.graphic.geometry.spatialReference;return $a(e,i,(e=>this.createDragPipeline(((i,a,n,o,s)=>(({steps:a,cancel:n}=t(i,a,n,o,s)),e(i,a,n))),a)),this._view.state.viewingMode)}createDragPipeline(t,e){const i=this._view;return Qe(this._manipulator,((a,n,o,s,r)=>{const l=n.next((t=>({...t,manipulatorType:za.TRANSLATE_Z}))).next(Ne(i,a.renderLocation,e)).next($e());t(a,l,o,s,r)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/qa,e=Mt(this._view),i=e.zManipulator.height*t,a=e.zManipulator.coneHeight*t,n=e.zManipulator.coneWidth*t,o=e.zManipulator.width*t,s=[L(0,0,0),L(0,0,i)],r=[L(0,0,0),L(0,0,i+a)],l=(t=>{const e=Ie();return Oe(e,e,[0,0,i]),Ae(e,e,Math.PI/2),e})(),p=(t,i)=>{const a=zt(e.zManipulator.color,i);return a.a*=t,be.toUnitRGBA(a)},h=Kt(p(1,.25),Ot.Occlude),c=Kt(p(1,0),Ot.Occlude),u=Kt(p(.7,0),e.zManipulator.renderOccluded),d=Kt(p(.85,0),e.zManipulator.renderOccluded),m=ci(h,s,o/2,16,!1),g=ui(h,a,n/2,16,!1);g.transformation=l,this._manipulator.renderObjects=[new Jt(g,_i.Unfocused),new Jt(m,_i.Unfocused),new Jt(g.instantiate({material:c}),_i.Focused),new Jt(m.instantiate({material:c}),_i.Focused),new Jt(g.instantiate({material:u}),_i.Unfocused),new Jt(m.instantiate({material:u}),_i.Unfocused),new Jt(g.instantiate({material:d}),_i.Focused),new Jt(m.instantiate({material:d}),_i.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[r]}}_createManipulator(){const t=this._view,e=Mt(t),i=new Qt({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});i.applyObjectTransform=i=>{const a=t.state.camera,n=rn;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,n);const o=b(a.eye,n),s=a.computeRenderPixelSizeAtDist(o),r=S(ln,n,a.eye);x(r,r);const l=pn;t.renderCoordsHelper.worldUpAtPosition(rn,l);const p=Math.abs(w(r,l)),h=E(ln,r,l),c=E(ln,h,l),u=he(p,.01,1),d=1-Math.sqrt(1-u*u)/u/a.fullWidth,m=this._radius/qa,g=e.zManipulator.width*m;M(c,x(c,c),(1/d-1)*o+s*g),i[12]-=ln[0],i[13]-=ln[1],i[14]-=ln[2]},this._manipulator=i,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const rn=R(),ln=R(),pn=R(),hn=()=>{};class cn extends Ka{constructor(t){super(),this._handles=new Me,this._interactive=!0;const{tool:e,view:i,snapToScene:a,radius:n}=t;this._view=i,this.xyManipulation=new on({tool:e,view:i,snapToScene:a,radius:n}),this.xyAxisManipulation=new an({tool:e,view:i,radius:n}),this.zManipulation=new sn({tool:e,view:i,radius:n}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((t=>this._handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,a){return i([this.xyManipulation.createGraphicDragPipeline(((e,i,a,n,o)=>t(dn.XY,e,i,a,n,o)),e,a),this.xyAxisManipulation.createGraphicDragPipeline(((e,i,a,n,o)=>t(dn.XY_AXIS,e,i,a,n,o)),e,a),this.zManipulation.createGraphicDragPipeline(((e,i,a,n,o)=>t(dn.Z,e,i,a,n,o)),e,a)])}createDragPipeline(t,e,a,n){return i([this.xyManipulation.createDragPipeline(((e,i,a,n,o)=>t(dn.XY,e,i,a,n,o)),e,a,n),this.xyAxisManipulation.createDragPipeline(((e,i,a,n,o)=>t(dn.XY_AXIS,e,i,a,n,o)),e,a,n),this.zManipulation.createDragPipeline(((e,i,a,n,o)=>t(dn.Z,e,i,a,n,o)),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((e=>t(e,za.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((e=>t(e,za.TRANSLATE_XY))),this.zManipulation.forEachManipulator((e=>t(e,za.TRANSLATE_Z)))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(m("esri-mobile"))return;const i=[];e.forEachManipulator((t=>i.push(t))),t.forEachManipulator((t=>i.push(t)));const a=()=>{const e=[];this._xyAxisVisible||t.forEachManipulator((t=>e.push(t.disableDisplay()))),this._handles.remove(un),this._handles.add(e,un)};for(const t of i)this._handles.add(t.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(h((()=>this._view.inputManager?.latestPointerType),a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((e=>{e.interactive=!t&&this._interactive||e.grabbing}))}static radiusForSymbol(t){const e=null!=t&&"point-3d"===t.type&&t.symbolLayers;return e&&e.length>0&&e.some((t=>"icon"===t.type))?Wa:qa}}const un="disable-xy-axis-display";var dn;!function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"}(dn||(dn={}));class mn extends Ka{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,za.TRANSLATE_XY)}createGraphicDragPipeline(t){return $a(this._graphicState,t,(t=>this.createDragPipeline(t)),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,i=this._graphicState.graphic,a=null!=i.geometry?i.geometry.spatialReference:null;return Qe(this._manipulator,((n,o,s,r,l)=>{const p=o.next(Fe(l,e,i,a)).next(ei()).next($e());t(n,p,s,r,l)}))}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new vi({graphic:e,view:t,selectable:!0,cursor:"move"})}}class gn{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class _n{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class yn{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const vn="manipulators";let fn=class extends(Ft(Nt.EventedMixin(ii))){constructor(t){super(t),this._infos=new Map,this.graphics=new kt,this.enableZ=!0,this.tooltipOptions=new wi,this.type="move-3d",this._moveManipulation=null,this._tooltip=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),r((()=>this.tooltipOptions.enabled),(e=>{this._tooltip=e?new dt({view:t}):o(this._tooltip)}),p)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=o(this._tooltip),this._moveManipulation=o(this._moveManipulation),this.removeAllHandles(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:e}){for(const e of t){if(ne(e)!==oe.SUPPORTED)continue;const t=new Mn(e),i=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:i})}for(const t of e)this._infos.get(t)?.handle.remove(),this._infos.delete(t)}_setupFastTransformUpdates(t){for(const e of t){const{info:t}=this._infos.get(e);this.addHandles(Ia(t.state),e)}}_refreshManipulators(){if(this.removeHandles(vn),this._moveManipulation=o(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new mn({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{const{tooltipOptions:e,_tooltip:i}=this;null!=i&&("start"===t?i.info=new Oi({tooltipOptions:e}):i.clear())}))],vn))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,a,n)=>this._buildDragEventPipeline(t,dn.XY,e,i,a,n))),vn)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new cn({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?cn.radiusForSymbol(t[0].graphic.symbol):qa});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),vn)}));const i=e=>i=>{this.addHandles(i.events.on("focus-changed",(({action:i})=>{const a=this._tooltip;null!=a&&("focus"===i?this._updateMoveTooltip(t,e):a.clear())})),vn)};this._moveManipulation.xyManipulation.forEachManipulator(i(dn.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(dn.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(dn.Z));const a=()=>this._updateMoveManipulation(t);for(const e of t)this.addHandles([e.state.on("changed",a),r((()=>e.state.displaying),a)],vn);const n=t[t.length-1];this.addHandles(n.state.on("changed",(()=>this._updateMoveManipulationAngle(n))),vn),this.addHandles(e.createDragPipeline(((e,i,a,n,o)=>this._buildDragEventPipeline(t,e,i,a,n,o)),z(n.graphic),n.graphic.geometry.spatialReference,n.graphic),vn),this._updateMoveManipulationAngle(n)}_createVisualElements(t){for(const i of t){const a=i.graphic,n=Ba({view:this.view,graphic:a,forEachManipulator:t=>{i.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>e()});null!=n&&(i.geometryRepresentation=n.visualElement,i.geometryRepresentation instanceof bt&&this.addHandles([i.geometryRepresentation.events.on("attachment-origin-changed",(()=>{i.state.isDraped||this._updateMoveManipulation(t)})),r((()=>i.state.isDraped),(()=>this._updateMoveManipulation(t)))],vn),this.addHandles(n,vn))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=tn(t.graphic.geometry))}_updateMoveManipulation(t){const e=Wt(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;if(n){for(const n of t){if(!n.state.displaying)continue;const t=n.state.graphic;this.enableZ&&le(t)&&(a=!0);const o=n.geometryRepresentation instanceof bt&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:$t(this.view,t);if(null!=o){const{x:t,y:a,z:n}=o;e.x+=t,e.y+=a,n&&(e.z??=0,e.z+=n),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,n.location=e,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(t,e,i,a,n,o){const s=[],r=[];let l=null,p=null;const h=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===dn.XY){const e=t[0].graphic;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(e,z(e),a,n,o))}return n=n.next((t=>p?.(t))).next((()=>(this.emit("graphic-move-stop",new yn(r)),this.destroyed||h(),null))),{steps:a=a.next((e=>{if("start"===e.action){s.length=0,r.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),r.push(e.graphic),e.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=ai(r,this.view.state.viewingMode),p=ni(r),this.emit("graphic-move-start",new gn(r)),this.destroyed))return null}return 0!==r.length?e:null})).next((t=>l?.(t))).next((i=>(this._updateMoveTooltip(t,e,i),i))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,n=i.y-e.y;if(this.emit("graphic-move",new _n(a,n,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new yn(r)),this.destroyed)return null;h()}return null})),cancel:n}}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:n}=this;if(null==n)return;n.clear();const o=0===t.length?"absolute-height":t[0].state.isDraped?"on-the-ground":"absolute-height";switch(e){case dn.XY:n.info=new Oi({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,((t,e)=>ut(t,e,o)));break;case dn.XY_AXIS:n.info=new Ti({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,((t,e)=>{const a=ut(t,e,o);return Zt(a,en(i))}));break;case dn.Z:n.info=new Ai({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,Ri)}}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:n}=e,o=i(a,n);t.distance=null!=o?o:Yt}}_buildSnappingPipelineSteps(t,e,i,a,n){const o=t.geometry;if(null==o||"point"!==o.type&&"mesh"!==o.type)return{steps:i,cancel:a};const s=("point"===o.type?o:o.anchor).clone(),r=new Ei({elevationInfo:e,pointer:n,editGeometryOperations:fi.fromGeometry(s,this.view.state.viewingMode),visualizer:new vt,excludeFeature:t}),l=this.snappingManager,{snappingStep:p,cancelSnapping:h}=ji({snappingContext:r,snappingManager:l,updatingHandles:this.updatingHandles});return a=a.next(h),{steps:i=i.next((e=>(s.z=k(this.view,s,z(t),{mode:"absolute-height",offset:0}),{...e,snapOrigin:r.coordinateHelper.pointToVector(s)}))).next(...p),cancel:a}}get test(){return{tooltip:this._tooltip}}};t([d({constructOnly:!0,nonNullable:!0})],fn.prototype,"view",void 0),t([d()],fn.prototype,"graphics",void 0),t([d({constructOnly:!0,nonNullable:!0})],fn.prototype,"enableZ",void 0),t([d({constructOnly:!0,type:wi})],fn.prototype,"tooltipOptions",void 0),t([d({constructOnly:!0})],fn.prototype,"snappingManager",void 0),t([d()],fn.prototype,"type",void 0),t([d()],fn.prototype,"updating",null),fn=t([_("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],fn);class Mn{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new jt({graphic:t})}get graphic(){return this.state.graphic}}function bn(t,e,i){const a="on-the-ground"===i.mode?Mi.XY:Mi.XYZ;return new bi(t,a,e,0)}function Sn(t,e,i){const a=R();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const n=xn(t,e,zi(i.plane)),o=xn(t,e,i.edgeDirection);if(null==n||null==o)return null;const s=E(R(),n,o);return Hi(a,s,ki())}function xn(t,e,i){const a=Wt(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),n=R(),o=R();return t.renderCoordsHelper.toRenderCoords(e,n)&&t.renderCoordsHelper.toRenderCoords(a,o)?j(o,n,o):null}let wn=class extends mt{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=Yt,this.area=null,this.totalLength=null}};t([d()],wn.prototype,"type",void 0),t([d()],wn.prototype,"distance",void 0),t([d()],wn.prototype,"area",void 0),t([d()],wn.prototype,"totalLength",void 0),wn=t([_("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],wn);let En=class extends(Nt.EventedMixin(Xt)){constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new Me,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=Gn.NONE,this._recreatingManipulators=!1,this.outputGeometry=null,this._vertexLaserLineVisualElement=null;const e=Mt(t.tool.view).manipulators,i=e.vertex;this._vertexManipulatorMaterial=Kt(Ut(i.color),i.renderOccluded),this._vertexManipulatorOutlineMaterial=te(Ut(i.outlineColor),i.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=te(Ut(i.hoverOutlineColor),i.renderOccluded);const a=e.edge;this._edgeManipulatorMaterial=Kt(Ut(a.color),a.renderOccluded),this._edgeManipulatorOutlineMaterial=te(Ut(a.outlineColor),a.renderOccluded);const n=e.edgeOffset;this._edgeOffsetManipulatorMaterial=Kt(Ut(n.color),n.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Kt(Ut(n.hoverColor),n.renderOccluded,!1);const o=e.selected;this._selectedManipulatorMaterial=Kt(Ut(o.color),o.renderOccluded),this._selectedManipulatorOutlineMaterial=te(Ut(o.outlineColor),o.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=te(Ut(o.hoverOutlineColor),o.renderOccluded)}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new jt({graphic:t});this._tooltip=new dt({view:e}),this.addHandles([r((()=>i.displaying),(t=>{for(const e of this._manipulatorInfos)e.manipulator.available=t})),r((()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:t,enabled:e,edgeOffsetEnabled:i})=>{null!=t&&(t.visible=e,t.edgeDistance=i?"far":"default")}),c),h((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),c),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=o(this._segmentLabels),this._tooltip=o(this._tooltip),this._removeManipulators()}get inputGeometry(){return null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter((t=>t.manipulator.selected&&"vertex"===t.type));this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=o(this._moveManipulation),this._graphicMoveManipulation=o(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(null==this._editGeometryOperations)return;const e=z(this.graphic);for(const i of this._editGeometryOperations.data.components){const a=t?.byComponentIndex.get(i.index);for(const t of i.vertices){const i=a?.has(t.index);this._createVertexOrEdgeManipulator(t,e,i)}for(const t of i.edges)this._createVertexOrEdgeManipulator(t,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canRedo}get canUndo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canUndo}redo(){if(null==this._editGeometryOperations)return null;const t=this._editGeometryOperations.redo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(null==this._editGeometryOperations)return null;this.emit("undo");const t=this._editGeometryOperations.undo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(null!=t&&null!=this.inputGeometry&&rt(t,this.inputGeometry))for(const t of this._manipulatorInfos)if("vertex"===t.type&&t.manipulator.selected){const{index:i,component:{index:a}}=t.handle,{byComponentIndex:n}=e,o=n.get(a)||new Set;o.add(i),n.set(a,o)}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=o(this._editGeometryOperations),this._segmentLabels=o(this._segmentLabels),null==t)return void(this._recreatingManipulators=!1);const i="mesh"===t.type?t.anchor:t;this._editGeometryOperations=fi.fromGeometry(i,this.view.state.viewingMode),this._createManipulators(e),this._segmentLabels=new Da({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:z(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if("end"===e.action)return e;let i=0;const a=[],n=this._manipulatorInfos.some((t=>"vertex"===t.type&&t.manipulator.selected)),o=t===In.SELECTED_OR_ALL&&n;for(const t of this._manipulatorInfos)"vertex"===t.type&&(t.manipulator.grabbing||o&&!t.manipulator.selected||a.push(t),i++);if(0===a.length)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(Gn.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(Gn.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce(((t,e)=>"vertex"===e.type&&e.manipulator.selected?t+1:t),0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(Gn.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const n=[];for(const e of this._manipulatorInfos)"vertex"===e.type&&(e.manipulator.selected&&!e.manipulator.grabbing||e===t.info)&&n.push(e);this._moveVertices(n,t,Si.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case Gn.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case Gn.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case Gn.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case Gn.MOVING:switch(this._reshapeEventState){case Gn.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case Gn.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case Gn.RESHAPING:switch(this._reshapeEventState){case Gn.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case Gn.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,i=this._graphicState;if(this._graphicMoveManipulation=new mn({tool:t,view:e,graphicState:i}),this.enableMoveGraphic){let t=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,i,a)=>{i.next((t=>this._trackNumDragging(t))).next((e=>("start"===e.action&&(t=this._editGeometryOperations.createUndoGroup()),e))).next((t=>this._perGraphicManipulatorDragAction(In.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(dn.XY,t),t))).next((e=>{"end"===e.action&&(this._tooltip.clear(),t=s(t))})),a.next((()=>this._onDragCancel(!0,(()=>t=s(t)))))}))),this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(t,!1))))}else this._graphicMoveManipulation.forEachManipulator((t=>{t.grabbable=!1,t.cursor=null}));this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(t.events.on("immediate-click",(t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()})))))}_createMoveManipulation(t){const{graphic:e,handles:i,tool:a,view:n}=this,o=this._graphicState;this._moveManipulation=new cn({tool:a,view:n,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&le(e),snapToScene:!1,radius:cn.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((t=>i.add([t.events.on("immediate-click",(i=>{this._moveManipulation.zManipulation.hasManipulator(t)||this._manipulatorInfos.some((t=>t.manipulator.selected))||this.emit("immediate-click",{...i,graphic:e}),i.stopPropagation()})),this._watchAndUpdateGrabState(t,!1)])));const s=t=>e=>{i.add(e.events.on("focus-changed",(({action:e})=>{"focus"===e&&this._tooltipOptions.enabled?this._updateTranslateTooltip(t):this._tooltip.clear()})))};this._moveManipulation.xyManipulation.forEachManipulator(s(dn.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(s(dn.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(s(dn.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const l=e.geometry.spatialReference;i.add([this._moveManipulation.createDragPipeline(((i,n,o,s,r)=>{const{snappingStep:l,cancelSnapping:p}=ji({predicate:t=>!!t.info,snappingManager:a.snappingManager,snappingContext:new Ei({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:r,excludeFeature:e,visualizer:new vt}),updatingHandles:this.updatingHandles,useZ:!1});return s=s.next((t=>(this._onDragCancel(),t))).next(p),{steps:o=o.next((t=>this._trackNumDragging(t))).next((t=>{const e=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));return t.manipulatorType===za.TRANSLATE_XY&&1===e.length?{...t,info:e[0],snapOrigin:e[0].handle.pos}:t})).next(oi(this.view,t,e)).next(...l).next(ei()).next((t=>this._perGraphicManipulatorDragAction(In.SELECTED_OR_ALL,t))).next((t=>(this._updateTranslateTooltip(i,t),t))),cancel:s}}),t,l,e),r((()=>o.displaying),(()=>this._updateMoveManipulationPosition()),c),o.on("changed",(()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()})),r((()=>o.isDraped),(t=>{this._updateMoveManipulationPosition();const e="align-move-manipulation";t?i.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):i.remove(e)}),c)])}_createVisualElements(){const{graphic:t,view:e}=this,i=Ba({view:e,graphic:t,forEachManipulator:t=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(t),this._moveManipulation.forEachManipulator(t);for(const e of this._manipulatorInfos)t(e.manipulator,za.TRANSLATE_XY)}},onManipulatorsChanged:t=>this.on("manipulators-changed",t)});null!=i&&(this._outlineVisualElement=i.visualElement instanceof bt?i.visualElement:null),null!=this._outlineVisualElement&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}))),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=z(this.graphic)){const a=Mt(this.view).manipulators.edgeOffset,n=a.size/2,o=n+a.collisionPadding,s=n/o,r=s*Math.sqrt(3)/2;null==this._edgeOffsetManipulatorGeometryInside&&(this._edgeOffsetManipulatorGeometryInside=li(this._edgeOffsetManipulatorMaterial,r,s/2,s/2,a.height,a.offset)),null==this._edgeOffsetManipulatorGeometryOutside&&(this._edgeOffsetManipulatorGeometryOutside=li(this._edgeOffsetManipulatorMaterial,-r,s/2,s/2,a.height,-a.offset));const l=[new Jt(this._edgeOffsetManipulatorGeometryInside.instantiate(),_i.Unfocused),new Jt(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),_i.Focused),new Jt(this._edgeOffsetManipulatorGeometryOutside.instantiate(),_i.Unfocused),new Jt(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),_i.Focused)],p=new Qt({view:this.view,renderObjects:l,elevationInfo:"on-the-ground"!==e.mode||Xi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionType:{type:"disc",direction:L(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new Qt({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),c={manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const u=[];for(const t of[c.handle.leftVertex,c.handle.rightVertex]){const e=this._getManipulatorInfoFromHandle(t);null!=e&&u.push(e.manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))))}c.locationUpdateHandle=i(u),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(Qe(p,this._createEdgeOffsetPipeline(c,e)),p),this._manipulatorHandles.add(Qe(h,((t,i,a,n)=>{if("touch"===n)this._createEdgeOffsetPipeline(c,e)(t,i,a);else if(this.enableMoveGraphic){const n=this.graphic,o=null!=n.geometry?n.geometry.spatialReference:null;i.next((t=>this._trackNumDragging(t))).next(Je(this.view,t.elevationAlignedLocation)).next(ke(this.view,t.elevationAlignedLocation,e,o,n)).next($e()).next(ei()).next((t=>this._perGraphicManipulatorDragAction(In.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(dn.XY,t),t))).next((t=>{"end"===t.action&&this._tooltip.clear()})),a.next((()=>this._onDragCancel(!t.metadata.deleting)))}})),p);const d=t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",d),h.events.on("immediate-click",d),p.events.on("focus-changed",(({action:t})=>{const e=this._tooltipOptions;if("focus"===t&&e.enabled){const t=this._tooltip.info=new wn({tooltipOptions:e});this._updateTooltipAreaOrTotalLength(t)}else this._tooltip.clear()}))],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(t,e){const a=t.manipulator,n=t.edgeManipulator,o=()=>{t.visibilityHandle=s(t.visibilityHandle);const o=this._getManipulatorInfoFromHandle(t.handle.leftVertex),r=this._getManipulatorInfoFromHandle(t.handle.rightVertex),l=null!=o&&null!=r&&function(t,e,i){const a=i.projectToRenderScreen(t,X()),n=i.projectToRenderScreen(e,X());return null!=a&&null!=n?O(S(a,a,n)):0}(o.manipulator.renderLocation,r.manipulator.renderLocation,this.view.state.camera)<e;(!a.focused&&!n.focused||l)&&(a.grabbable=!l,n.grabbable=!l,t.visibilityHandle=i([a.disableDisplay(),{remove:()=>{a.grabbable=!0,n.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([a.events.on("focus-changed",o),n.events.on("focus-changed",o),{remove:()=>{s(t.visibilityHandle),n.metadata.deleting=!0,this.manipulators.remove(n)}}],a),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=this._editGeometryOperations.data,i=Sn(this.view,t.manipulator.elevationAlignedLocation,bn(e,t.handle,t.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),n=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==a||null==n)return;const o=a.manipulator.renderLocation,s=n.manipulator.renderLocation,r=null!=i?function(t,e,i){const a=zi(t),n=j(R(),e,i),o=E(R(),n,a),s=E(R(),n,o);return Re(n[0],n[1],n[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}(i,o,s):Le;t.manipulator.modelTransform=r,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=r;const l=A(S(An,o,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,n)=>{this._clearSelection();const{step:o,cleanup:s}=this._initializeEdgeOffset(t,e);a.next((t=>this._trackNumDragging(t))).next(Je(this.view,i.elevationAlignedLocation)).next(o).next(Xe(this.view)).next(Ze(this.view,this._editGeometryOperations.data.spatialReference)).next(ei()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next((t=>{"end"===t.action&&s()})),n.next((()=>{i.metadata.deleting||(s(),this._onDragCancel())}))}}_initializeEdgeOffset(t,e){const{view:n}=this,o=this._editGeometryOperations,l=bn(o.data.coordinateHelper,t.handle,e),p=o.createUndoGroup(),h=Sn(n,t.manipulator.elevationAlignedLocation,l);if(l.requiresSplitEdgeLeft){const e=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);null!=e&&this._splitEdgeManipulator(e,1)}if(l.requiresSplitEdgeRight){const e=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);null!=e&&this._splitEdgeManipulator(e,0)}const c=()=>new Ui({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:o.data.spatialReference}),u=Mt(n),d=new bt({view:n,isDraped:this._graphicState.isDraped,geometry:c(),elevationInfo:t.elevationInfo,width:u.visualElements.lineGraphics.outline.width,color:Ut(u.colors.accent),attached:!0});let m;const g=()=>{this._cleanEdgeOffsetCollapsedEdges(t),m=s(m)},_=this.on("undo",g);return m=i([a(d),r((()=>this._graphicState.isDraped),(t=>d.isDraped=t)),this._graphicState.on("changed",(()=>d.geometry=c())),p,_]),{step:t=>null==l||null==h?(g(),null):{...t,operation:l,plane:h},cleanup:g}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||null==e.operation)return e;this._updateEventState(Gn.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:n}=e;return(i||a||n)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;return null==e||null==i?t:("start"===t.action&&e.selectArrowFromStartPoint(i),{...t,signedDistance:e.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,n=this._tooltip,o=this._tooltipOptions;if(!o.enabled||null==i)return n.clear(),t;let s=n.info;null!=s&&"reshape-edge-offset"===s.type||(s=n.info=new wn({tooltipOptions:o}));const{coordinateHelper:r}=this._editGeometryOperations.data;return s.distance="end"===t.action?Yt:function(t,e,i,a,n){if(t){const t=n.toXYZ(n.pointToVector(i)),o=Ni(a,t,Pe.get()),s=_t(o,t,n.spatialReference);if(null!=s)return Bt(s.value*Math.sign(e),s.unit)}return Bt(e*Ci(i.spatialReference),"meters")}(this._graphicState.isDraped,i*a.selectedArrow,e,a.plane,r),this._updateTooltipAreaOrTotalLength(s),t}}_cleanEdgeOffsetCollapsedEdges(t){const e=t.handle.leftVertex.leftEdge?.leftVertex,i=t.handle.leftVertex,a=t.handle.rightVertex.rightEdge?.rightVertex,n=t.handle.rightVertex,o=this._editGeometryOperations.data.coordinateHelper,s=[];if(e&&o.distance(e.pos,i.pos)<Tn){const t=this._getManipulatorInfoFromHandle(i);null!=t&&s.push(t)}if(o.distance(i.pos,n.pos)<Tn||a&&o.distance(a.pos,n.pos)<Tn){const t=this._getManipulatorInfoFromHandle(n);null!=t&&s.push(t)}s.length&&this._removeVertices(s)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=z(this.graphic),a=!1){const{view:n}=this,o=Mt(n);if("edge"===t.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(null==this._vertexManipulatorGeometry||null==this._vertexManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.vertex);this._vertexManipulatorGeometry=di(this._vertexManipulatorMaterial,t,16,16),this._vertexManipulatorOutlineGeometry=di(this._vertexManipulatorOutlineMaterial,e,16,16)}if(null==this._edgeManipulatorGeometry||null==this._edgeManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.edge);this._edgeManipulatorGeometry=di(this._edgeManipulatorMaterial,t,16,16),this._edgeManipulatorOutlineGeometry=di(this._edgeManipulatorOutlineMaterial,e,16,16)}const{geometry:r}=this.graphic,l=r?.type,p="point"===l||"mesh"===l?[]:[new Jt(this._vertexManipulatorGeometry.instantiate(),Dn.Vertex|_i.Unselected),new Jt(this._vertexManipulatorOutlineGeometry.instantiate(),Dn.Vertex|_i.Unfocused|_i.Unselected),new Jt(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Dn.Vertex|_i.Focused|_i.Unselected),new Jt(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),_i.Selected),new Jt(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),_i.Selected|_i.Unfocused),new Jt(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),_i.Selected|_i.Focused)];this.enableMidpoints&&p.push(new Jt(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),Dn.Edge|_i.Focused|_i.Unselected),new Jt(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Dn.Edge|_i.Focused|_i.Unselected),new Jt(this._edgeManipulatorGeometry.instantiate(),Dn.Edge|_i.Unfocused|_i.Unselected),new Jt(this._edgeManipulatorOutlineGeometry.instantiate(),Dn.Edge|_i.Unfocused|_i.Unselected));const h=new Qt({view:n,renderObjects:p,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),metadata:{deleting:!1}});h.selected=a,this._setTypeSpecificManipulatorSettings(h,t,e);const c="edge"===t.type?{manipulator:h,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:h,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(c),this.manipulators.add(h),this._updateManipulatorPosition(c),"edge"===c.type){const t=[];for(const e of[c.handle.leftVertex,c.handle.rightVertex]){const i=this._getManipulatorInfoFromHandle(e);null!=i&&t.push(i.manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(c))))}c.locationUpdateHandle=i(t),this._manipulatorHandles.add(c.locationUpdateHandle,h)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(h,!0),h);const u=Qe(h,((t,i,a,n)=>{let o=null;const{snappingStep:r,cancelSnapping:l}=ji({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Ei({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:n,excludeFeature:this.graphic,visualizer:new vt}),updatingHandles:this.updatingHandles,useZ:!1});a=a.next((e=>(this._onDragCancel(!t.metadata.deleting,(()=>o=s(o))),e))).next(l),i.next((t=>this._trackNumDragging(t))).next((t=>{if("start"===t.action&&(o=this._editGeometryOperations.createUndoGroup()),"edge"===c.type){const e=this._splitEdgeManipulator(c);return{...t,info:e,snapOrigin:e.handle.pos}}return{...t,info:c,snapOrigin:c.handle.pos}})).next(Je(this.view,t.elevationAlignedLocation)).next(Ye(this.view,this.graphic,t.elevationAlignedLocation,t.location.spatialReference,this.graphic)).next(oi(this.view,e,this.graphic)).next(...r).next(ei()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(o=s(o)),this._updateTranslateVertexTooltip(t,dn.XY,e)}))}));return this._manipulatorHandles.add([u,h.events.on("immediate-click",(t=>this._manipulatorClickCallback(t,c))),h.events.on("select-changed",(()=>{c.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),h.events.on("focus-changed",(({action:t})=>{"focus"===t&&"edge"!==c.type?this._updateTranslateVertexTooltip(h,dn.XY):this._tooltip.clear()}))],h),this.emit("manipulators-changed"),c}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null),null!=this.tool.snappingManager&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case Gn.NONE:break;case Gn.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case Gn.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(Gn.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){const{graphic:a,view:n}=this,o=Mt(n);switch(e.type){case"vertex":{t.state=Dn.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;const{size:e,collisionPadding:n}=o.manipulators.vertex;t.radius=e/2+n,t.elevationInfo=i;const{geometry:s}=a,r=s?.type;t.interactive=null!=r&&"point"!==r&&"mesh"!==r;break}case"edge":{t.state=Dn.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;const{size:e,collisionPadding:n}=o.manipulators.edge;t.radius=e/2+n,t.elevationInfo="on-the-ground"!==i.mode||Xi(a.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",(i=>this._onGrabStateChanged(t,e,i.action,i.pointerType)))}_onGrabStateChanged(t,e,i,a="mouse"){if(!this._recreatingManipulators){if("start"===i)e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(Gn.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((t=>{const{manipulator:e}=t,{geometry:i}=this.graphic,a=i?.type;e.interactive=e.grabbing||!this._numGrabbing&&null!=a&&"point"!==a&&"mesh"!==a,"edgeManipulator"in t&&(t.edgeManipulator.interactive=t.edgeManipulator.grabbing||!this._numGrabbing)})),this._graphicMoveManipulation.forEachManipulator((t=>{t.interactive=t.grabbing||!this._numGrabbing})))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){null!=t&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),g(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t)for(const e of this._manipulatorInfos)if(t===e.handle)return e;return null}_updateManipulatorPosition(t){if(null==t)return;const e=this._editGeometryOperations;if("vertex"===t.type)t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,On),t.manipulator.grabbing&&null!=this._vertexLaserLineVisualElement&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if("edge"===t.type){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==i||null==a)return;const n=i.manipulator,o=a.manipulator;if(null!=t.manipulator.elevationInfo&&"on-the-ground"===t.manipulator.elevationInfo.mode){const i=n.location,a=o.location,s=.5,r=i.x+s*(a.x-i.x),l=i.y+s*(a.y-i.y),p=i.hasZ&&a.hasZ?0:void 0;t.manipulator.location=Wt(r,l,p,e.data.spatialReference)}else T(An,n.renderLocation,o.renderLocation,.5),t.manipulator.renderLocation=An}}_splitEdgeManipulator(t,e=.5){const i=this._editGeometryOperations,a=i.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=s(t.locationUpdateHandle);const n=z(this.graphic);let o;this.enableEdgeOffset?(this._removeManipulator(t),o=this._createVertexOrEdgeManipulator(a)):(o=t,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(o),this.enableEdgeOffset||this._updateTranslateVertexTooltip(o.manipulator,dn.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(Gn.RESHAPING),l=i.data.coordinateHelper.vectorToArray(o.handle.pos),p=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:l,componentIndex:p,vertexIndex:a.index}],added:l}),r&&this._updateEventState(Gn.NONE),o}_updateMoveManipulationPosition(){const t=v(An,0,0,0);let e=0,i=!1,a=null,n=null;for(const o of this._manipulatorInfos)"vertex"===o.type&&(o.manipulator.selected?(e++,f(t,t,o.manipulator.renderLocation),null==a||o.selectedIndex>a.selectedIndex?(n=a,a=o):(null==n||o.selectedIndex>n.selectedIndex)&&(n=o)):i=!0);if(0===e){const t=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t,this._moveManipulation.zManipulation.available=t&&this.enableZShape&&le(this.graphic),this._moveManipulation.angle=tn(this.graphic.geometry),this._moveManipulation.radius=cn.radiusForSymbol(this.graphic.symbol)}else{const t=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.zManipulation.available=t&&this.enableZVertex&&le(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t&&1!==e;let i=0;if(null!=a){const t=a.handle.pos,e=null!=n?n.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,o=null==n&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;e&&o?this._moveManipulation.xyAxisManipulation.available=!1:e?i=jn(e,t):o&&(i=jn(t,o))}this._moveManipulation.angle=i,this._moveManipulation.radius=Wa}0!==e&&i?(M(t,t,1/e),On.spatialReference=this._editGeometryOperations.data.spatialReference,On.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,On),this._moveManipulation.elevationAlignedLocation=On):null==this._outlineVisualElement||this._graphicState.isDraped||null==this._outlineVisualElement.attachmentOrigin?ee(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){const e=new Array,i=this._editGeometryOperations;for(const a of t)if("vertex"===a.type&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const t=i.removeVertices([a.handle]),n=t.removedVertices?.[0].createdEdge;n&&this._createVertexOrEdgeManipulator(n)}if(e.length>0){const t=e.map((t=>{const e=i.data.components.indexOf(t.component);return{coordinates:i.data.coordinateHelper.vectorToArray(t.pos),componentIndex:e,vertexIndex:t.index}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(Gn.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:t.map((t=>t.coordinates)),vertices:t}),this.destroyed)return;if(a&&(this._updateEventState(Gn.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=("start"===e.action?Si.NEW_STEP:Si.ACCUMULATE_STEPS)){const a=this._editGeometryOperations;a.moveVertices(t.map((t=>t.handle)),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const e of t)this._updateManipulatorPosition(e)}_offsetEdge(t,e){if(null==e.operation||null==e.signedDistance)return;const i=this._editGeometryOperations,a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),"vertex"===e.type&&(e.manipulator.selected=!e.manipulator.selected,t.button===Zi.Right&&this._removeVertices([e])),"edge"===e.type&&t.button===Zi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));1===i.length?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case dn.XY:this._tooltip.info=new Oi({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,((t,e)=>ut(t,e,a)));break;case dn.XY_AXIS:this._tooltip.info=new Ti({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,((t,i)=>{const n=ut(t,i,a);return Zt(n,en(e))}));break;case dn.Z:this._tooltip.info=new Ai({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,e,Ri)}}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;let n;const o=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case dn.XY:n=new Ii({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,((t,e)=>ut(t,e,o))),this._updateTooltipAreaOrTotalLength(n);break;case dn.XY_AXIS:n=new Gi({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,((t,e)=>{const a=ut(t,e,o);return Zt(a,en(i))})),this._updateTooltipAreaOrTotalLength(n);break;case dn.Z:n=new Di({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,Ri)}const s=Li(t.elevationAlignedLocation);null!=s&&(n.elevation={mode:"absolute-height",...s}),this._tooltip.info=n}_updateTranslateTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:n}=e,o=i(a,n);t.distance=null!=o?o:Yt}}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(null==e)return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";t.area="polygon"===e.type?Yi(e,i):null,t.totalLength="polyline"===e.type?gt(e,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function jn(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}t([d()],En.prototype,"_editGeometryOperations",void 0),t([d()],En.prototype,"_segmentLabels",void 0),t([d({constructOnly:!0})],En.prototype,"tool",void 0),t([d()],En.prototype,"_tooltip",void 0),t([d()],En.prototype,"inputGeometry",null),t([d()],En.prototype,"outputGeometry",void 0),t([d({readOnly:!0})],En.prototype,"updating",null),t([d()],En.prototype,"manipulators",null),t([d()],En.prototype,"view",null),t([d()],En.prototype,"graphic",null),t([d()],En.prototype,"enableZShape",null),t([d()],En.prototype,"enableZVertex",null),t([d()],En.prototype,"enableMoveGraphic",null),t([d()],En.prototype,"enableMidpoints",null),t([d()],En.prototype,"enableEdgeOffset",null),t([d()],En.prototype,"_labelOptions",null),t([d()],En.prototype,"_tooltipOptions",null),En=t([_("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],En);const On=Wt(0,0,void 0,Bi.WGS84),An=R(),Tn=1e-6;var Dn,Gn,In;!function(t){t.Vertex=yi.Custom1,t.Edge=yi.Custom2}(Dn||(Dn={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(Gn||(Gn={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(In||(In={}));let Rn=class extends(Nt.EventedMixin(ii)){constructor(t){super(t),this._handles=new Me,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new qi,this.tooltipOptions=new wi,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new En({tool:this});this.addHandles([t.on("reshape",(t=>{"reshape"===t.type&&this._onReshapeGeometryChanged(),this.emit("reshape",t)})),t.on("move",(t=>{"move"===t.type&&this._onReshapeGeometryChanged(),this.emit("move",t)})),t.on("vertex-add",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)})),t.on("vertex-remove",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)})),t.on("immediate-click",(t=>this.emit("immediate-click",t))),this.view.on("pointer-down",["Shift"],(t=>t.stopPropagation())),r((()=>this.graphic),(()=>this._updateGraphic()),p)]),this.finishToolCreation()}destroy(){this._handles=o(this._handles),this._reshapeOperation=o(this._reshapeOperation)}get updating(){return this._reshapeOperation?.updating??!1}_updateGeometry(){const t=se(this.graphic);this._reshapeOperation.inputGeometry=null!=t?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),re(this.graphic)!==oe.SUPPORTED)return;const t=r((()=>this.graphic?.geometry),(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),u);this._handles.add(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0;const{graphic:e}=this,{geometry:i}=e;"mesh"===i?.type&&"point"===t.type?(e.geometry=i.centerAt(t),e.notifyGeometryChanged()):e.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:t}=this._reshapeOperation;null!=this.graphic&&t&&this._updateGeometryInternally(t.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.undo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.redo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}onInputEvent(t){"key-down"!==t.type||"Delete"!==t.key&&"Backspace"!==t.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};t([d()],Rn.prototype,"_reshapeOperation",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"view",void 0),t([d({constructOnly:!0})],Rn.prototype,"graphic",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"enableZShape",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"enableZVertex",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"enableMoveGraphic",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"enableMidpoints",void 0),t([d({constructOnly:!0,nonNullable:!0})],Rn.prototype,"enableEdgeOffset",void 0),t([d()],Rn.prototype,"type",void 0),t([d({constructOnly:!0,type:qi})],Rn.prototype,"labelOptions",void 0),t([d({constructOnly:!0,type:wi})],Rn.prototype,"tooltipOptions",void 0),t([d({constructOnly:!0})],Rn.prototype,"snappingManager",void 0),t([d()],Rn.prototype,"updating",null),t([d()],Rn.prototype,"automaticManipulatorSelection",void 0),Rn=t([_("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Rn);let Ln=class extends mt{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};t([d()],Ln.prototype,"type",void 0),t([d()],Ln.prototype,"rotation",void 0),t([d()],Ln.prototype,"rotationPrecision",void 0),t([d()],Ln.prototype,"orientation",void 0),t([d()],Ln.prototype,"orientationPrecision",void 0),t([d()],Ln.prototype,"rotationType",void 0),Ln=t([_("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],Ln);let Pn=class extends mt{constructor(t){super(t),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};t([d()],Pn.prototype,"type",void 0),t([d()],Pn.prototype,"scale",void 0),t([d()],Pn.prototype,"size",void 0),t([d()],Pn.prototype,"sizeUnit",void 0),t([d()],Pn.prototype,"sizePrecision",void 0),Pn=t([_("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Pn);let Cn=class extends mt{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};var Vn,Un;t([d()],Cn.prototype,"type",void 0),t([d()],Cn.prototype,"orientation",void 0),t([d()],Cn.prototype,"orientationPrecision",void 0),t([d()],Cn.prototype,"rotationType",void 0),t([d()],Cn.prototype,"size",void 0),t([d()],Cn.prototype,"sizePrecision",void 0),t([d()],Cn.prototype,"sizeUnit",void 0),Cn=t([_("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Cn),function(t){t.ScaleIn=yi.Custom2,t.ScaleOut=yi.Custom3,t.RotateLeft=yi.Custom4,t.RotateRight=yi.Custom5,t.Unlocked=yi.Custom7,t.DelayedFocused=yi.Custom8,t.TouchInput=yi.Custom12}(Vn||(Vn={}));class zn{get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}constructor({adapter:t,tooltipOptions:e,mode:i,tool:a}){this._mode=null,this._handles=new Me,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=200,this.events=new Nt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this._adapter.scale:1,this.tool=a,this._mode=i,this._adapter=t,this._tooltipOptions=e,this._tooltip=new dt({view:a.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(h((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),c))}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this._handles=o(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=o(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=Ki({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=o(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,za.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=Qe(t,((t,i,a)=>{this._scaleRotateDragData=null;const n=this._adapter.startInteraction(),o={mode:"none",origin:P(t.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=o,this._updateDragState();const s=Pe.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,s),i.next(Be(this.tool.view,Hi(t.renderLocation,s,ki()))).next((t=>{const i=zi(t.plane),a=ie(t.renderStart,t.renderEnd,o.origin,i),s=Ji.shortestSignedDiff(o.angle,a);o.angleDir=he(o.angleDir+s,-.3,.3),o.angle=a;const r=function(t,e){const i=S(Pe.get(),e.renderStart,t.origin),a=S(Pe.get(),e.renderEnd,t.origin),n=A(i),o=A(a);return 0===n?0:o/n}(o,t),l=r-this._adapter.scale;if(o.scaleDir=he(o.scaleDir+l,-.2,.2),this._onScaleChanged(),"none"===o.mode){const i=this._mode||function(t,e,i,a){const{renderStart:n,renderEnd:o}=t,s=Hn(n,a,Pe.get()),r=Hn(o,a,Pe.get());if(D(s,r)<100)return null;const l=S(Pe.get(),n,i),p=E(Pe.get(),l,zi(e)),h=n,c=f(Pe.get(),h,p),u=Hn(i,a,Pe.get()),d=s,m=Hn(c,a,Pe.get()),g=S(Pe.get(),m,d),_=S(Pe.get(),s,u),y=Ve(d,g),v=Ve(u,_);return Ue(y,r)<Ue(v,r)?"rotate":"scale"}(t,t.plane,o.origin,this.tool.view.state.camera);if(null!=i){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}o.mode=i}}switch(o.mode){case"rotate":n.state.angle=o.initialAngle+a;break;case"scale":n.state.scale=r,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:ce(o.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:r,yScale:r})}break;case"end":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:ce(o.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:r,yScale:r})}}return"end"===t.action&&(this.startAnimation(kn(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),n.done()),t})).next(this._updateTooltipPipelineStep(o)),a.next((()=>{if(n.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(kn(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e,i){let a=0,n=null;const o=()=>!1;return{start:()=>{n=t.getFocused,t.getFocused=o,a=0,e()},update:t=>(a+=t,!n?.()||a>=i.delayMs?Un.STOP:Un.CONTINUE),destroy:()=>{n&&(t.getFocused=n),e()}}}(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),r((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),c)])}_updateTooltipPipelineStep(t){return e=>{const i=this._tooltipOptions;if(!i.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const a=this._tooltip,n=this._tooltipOptions.visualVariables;switch(t.mode){case"scale":{const{size:t,scale:e}=this._adapter,o=n?.size;a.info=new Pn({tooltipOptions:i,scale:{value:e},size:null!=t?Bt(t,"meters"):void 0,sizePrecision:Nn(o?.valueType),sizeUnit:o?.unit});break}case"rotate":{const{orientationClockwise:t,relativeAngleClockwise:e}=this._adapter,o=n?.rotation,s=Nn(o?.valueType);a.info=new Ln({tooltipOptions:i,rotation:null!=e?qt(e,"radians","geographic"):void 0,rotationPrecision:s,rotationType:o?.rotationType??"geographic",orientation:null!=t?qt(t,"radians","geographic"):void 0,orientationPrecision:s})}}return e}}_updateFocusTooltip(){if(this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=t?.rotation,i=t?.size,a=this._mode,{size:n,orientationClockwise:o}=this._adapter,s=null!=o&&(null==a||"rotate"===a),r=null!=n&&(null==a||"scale"===a);this._tooltip.info=new Cn({tooltipOptions:this._tooltipOptions,orientation:s?qt(o,"radians","geographic"):void 0,orientationPrecision:Nn(e?.valueType),rotationType:e?.rotationType??"geographic",size:r?Bt(n,"meters"):void 0,sizeUnit:i?.unit,sizePrecision:Nn(i?.valueType)})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(Vn.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(Vn.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(Vn.ScaleIn|Vn.ScaleOut,!1),this._ringManipulator.updateStateEnabled(Vn.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(Vn.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(Vn.RotateLeft|Vn.RotateRight,!1),this._ringManipulator.updateStateEnabled(Vn.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(Vn.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(Vn.ScaleIn|Vn.ScaleOut|Vn.RotateLeft|Vn.RotateRight,!1)}_updateManipulatorTransform(){const t=Ee(Ce.get(),this._adapter.angle,L(0,0,1));if(null==t)return;const e=this.getScale(),i=je(Ce.get(),v(Pe.get(),e,e,e));this._ringManipulator.modelTransform=we(Ce.get(),i,t)}_createRingManipulator(){const t=(t,e,i)=>{const a=[],n=Math.ceil(128*(e-t)/(2*Math.PI));for(let o=0;o<n+1;o++){const s=t+o*(e-t)/n;a.push(L(i*Math.cos(s),i*Math.sin(s),0))}return a},e=e=>t(0,2*Math.PI,e),i=this._createMaterial(1),a=(t,e,a=i)=>mi(a,(t=>[[-t/2,0],[t/2,0],[t/2,.25],[-t/2,.25]])(e),t,[],[],!1),n=e(160),o=a(n,24),s={left:new Array,right:new Array},r=[];for(let e=0;e<2;e++){const n=e*Math.PI-Math.PI/4,o=Math.PI/2-Qa,l=n+o,p=n+Math.PI/2-o,h=t(l,p,190),c=a(h,9);r.push(h),r.push(t(l,p,201)),s.left.push(c),s.right.push(c.instantiate());for(let t=0;t<2;t++){const e=0===t,a=Ie();if(e){Te(a,a,[1,-1,1]),De(a,a,-l,[0,0,1]);const t=Math.round(.2*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}else{De(a,a,p,[0,0,1]);const t=Math.round(.8*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}const n=li(i,60,0,23,.5);pi(n,a),(e?s.left:s.right).push(n)}}const l=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,n=Math.PI/2-Ja,o=i+n,s=i+Math.PI/2-n,r=t(o,s,213);l.push(a(r,9))}const p=this._createMaterial(.66),h=this._createMaterial(.5),c=this._createMaterial(.33),u=e(190),d=e(213),m=a(u,9,p),g=a(d,9,c),_=e(130),y=e(107),v=a(_,9,p),f=a(y,9,c);let M=[new Jt(o,Vn.DelayedFocused),new Jt(o.instantiate({material:h}),_i.None)];this._mode&&"scale"!==this._mode||(M=M.concat([...l.map((t=>new Jt(t,Vn.DelayedFocused|Vn.Unlocked))),new Jt(m,Vn.DelayedFocused|Vn.ScaleIn),new Jt(g,Vn.DelayedFocused|Vn.ScaleIn),new Jt(v,Vn.DelayedFocused|Vn.ScaleOut),new Jt(f,Vn.DelayedFocused|Vn.ScaleOut)])),this._mode&&"rotate"!==this._mode||(M=M.concat([...s.right.map((t=>new Jt(t.instantiate(),Vn.DelayedFocused|Vn.Unlocked))),...s.left.map((t=>new Jt(t,Vn.DelayedFocused|Vn.RotateLeft))),...s.right.map((t=>new Jt(t,Vn.DelayedFocused|Vn.RotateRight)))]));const b=[n,...r];return new Qt({view:this.tool.view,renderObjects:M,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:z(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:L(0,0,1)}})}_createMaterial(t){const e=Mt(this.tool.view).colors.accent.clone();return e.a=t,new gi({color:Ut(e),transparent:1!==t,cullFace:ri.Back,renderOccluded:Ot.Transparent})}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}}function Hn(t,e,i){return e.projectToScreen(t,Fn),v(i,Fn[0],Fn[1],0)}function kn(t,e){let i=null,a=1;const n=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=n,e()},update:t=>(a+=((a+1)/2-a)*Math.min(3*t,1),e(),Math.abs(a-1)<.01?Un.STOP:Un.CONTINUE),destroy:()=>{i&&(t.getScale=i),e()}}}function Nn(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(Un||(Un={}));const Fn=F();function Xn(t){return null!=t.geometry&&"mesh"===t.geometry.type?(e=t.geometry).vertexSpace.isRelative?function(t,e,i){let a=e?.clone(),n=P(i.origin),o=null,s=null;return{undo:e=>{o=t.transform?.clone(),s=P(i.origin),t.transform=a,t.vertexSpace.origin=n,e.notifyMeshTransformChanged()},redo:e=>{a=t.transform?.clone(),n=P(i.origin),t.transform=o,t.vertexSpace.origin=s,e.notifyMeshTransformChanged()}}}(e,e.transform,e.vertexSpace):function(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}(e):function(t){let e=t.geometry,i=null;return{undo(t){i=t.geometry,t.geometry=e},redo(t){e=t.geometry,t.geometry=i}}}(t);var e}let Zn=class extends Xt{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([h((()=>{const t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null}),(({interactionState:t})=>{this._updateMeshRotation(t)}),u),h((()=>{const t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null}),(({interactionState:t})=>{this._updateMeshSize(t)}),u)])}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const t=this.geometry.transform;if(null==t)return this._interactionState?.angle??0;const e=ta(t.rotation)[2];return Math.abs(e)>.999999?pe(ea(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const t=new Yn({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Xn(this.graphic)}_updateMeshRotation(t){const{angle:e,previousAngle:i}=t;t.previousAngle=e;const{geometry:a}=this,{vertexSpace:n}=a,o=ce(e-i);if(n.isGeoreferenced){const t=!n.isRelative&&this.viewingMode===Qi.Global,e=this.geometry.anchor;this.geometry.rotate(0,0,o,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new na;const{transform:t}=a,e=ia(0,0,o,Bn);t.rotation=aa(t.rotation,e,t.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(t){const{scale:e,previousScale:i}=t;t.previousScale=e;const{geometry:a}=this,{vertexSpace:n}=a,o=e/i;if(n.isGeoreferenced){const t=!n.isRelative&&this.viewingMode===Qi.Global,e=this.geometry.anchor;this.geometry.scale(o,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new na;const{transform:t}=a;t.scale=M(t.scale,t.scale,o),this.graphic.notifyMeshTransformChanged()}}};t([d({constructOnly:!0})],Zn.prototype,"graphic",void 0),t([d({constructOnly:!0})],Zn.prototype,"geometry",void 0),t([d({constructOnly:!0})],Zn.prototype,"viewingMode",void 0),t([d()],Zn.prototype,"initialAngle",null),t([d()],Zn.prototype,"angle",null),t([d()],Zn.prototype,"angleClockwise",null),t([d()],Zn.prototype,"relativeAngle",null),t([d()],Zn.prototype,"relativeAngleClockwise",null),t([d()],Zn.prototype,"scale",null),t([d()],Zn.prototype,"_interactionState",void 0),Zn=t([_("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Zn);let Yn=class extends Y{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};t([d()],Yn.prototype,"angle",void 0),t([d()],Yn.prototype,"initialAngle",void 0),t([d()],Yn.prototype,"previousAngle",void 0),t([d()],Yn.prototype,"previousScale",void 0),t([d()],Yn.prototype,"scale",void 0),t([d()],Yn.prototype,"state",null),Yn=t([_("InteractionState")],Yn);const Bn=$i();let qn=class extends Xt{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(h((()=>null!=this._interactionState?this._interactionState.state:null),(t=>{this._updateSymbol(t)}),u))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return null!=this._interactionState?this._interactionState.angle:null!=this._orientationReferenceSymbolLayer?(t=this._orientationReferenceSymbolLayer.heading??0,-pe(t)):0;var t}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){const t=this._sizeReferenceSymbolLayer;if(null==t)return null;const e=this.findLayerView(),i=this._graphicSymbol;if(null==e||null==i||"point-3d"!==i.type)return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&null!=a.size)return a.size;const n=this.sizeAxis;return!("width"in a)||null==a.width||null!=n&&"width"!==n&&"all"!==n&&"width-and-depth"!==n?!("depth"in a)||null==t.depth||null!=n&&"depth"!==n&&"all"!==n&&"width-and-depth"!==n?!("height"in a)||null==t.height||null!=n&&"height"!==n&&"all"!==n?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type))}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type&&null!=t.heading))}get _graphicSymbol(){return null!=this.graphic&&null!=this.graphic.symbol&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(null!=this._interactionState||null==t||null==e)return Wn;const i=t.symbolLayers.map((i=>"object"===i.type?e.getSymbolLayerSize(t,i):null)).toArray(),a=t.clone(),n=this.angle,o=new Qn({originalSymbol:a,angle:n,initialSizes:i});this._interactionState=o;const s=()=>{this._interactionState=null};return{state:o,done:s,cancel:()=>{this._graphicSymbol=a,s()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const n=this._graphicSymbol;if(null==n||"point-3d"!==n.type)return;const o=n.clone(),s=-ce(e-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,o,((e,i,n)=>{const o=(e.heading??0)+s;i.heading!==o&&(i.heading=o,r=!0);const l=a[n];if(null!=l&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const e=l.width*t;i.width!==e&&(i.width=e,r=!0);const a=l.depth*t;i.depth!==a&&(i.depth=a,r=!0);const n=l.height*t;i.height!==n&&(i.height=n,r=!0)}})),r&&(this._graphicSymbol=o)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach(((t,a)=>{const n=e.symbolLayers.at(a);"object"===t.type&&"object"===n.type&&i(t,n,a)}))}};t([d()],qn.prototype,"initialAngle",null),t([d()],qn.prototype,"angle",null),t([d()],qn.prototype,"angleClockwise",null),t([d()],qn.prototype,"orientation",null),t([d()],qn.prototype,"orientationClockwise",null),t([d()],qn.prototype,"relativeAngle",null),t([d()],qn.prototype,"relativeAngleClockwise",null),t([d()],qn.prototype,"scale",null),t([d()],qn.prototype,"size",null),t([d()],qn.prototype,"sizeAxis",void 0),t([d({constructOnly:!0})],qn.prototype,"graphic",void 0),t([d()],qn.prototype,"_interactionState",void 0),t([d({constructOnly:!0})],qn.prototype,"findLayerView",void 0),t([d({constructOnly:!0})],qn.prototype,"sizeFilter",void 0),t([d()],qn.prototype,"_sizeReferenceSymbolLayer",null),t([d()],qn.prototype,"_orientationReferenceSymbolLayer",null),t([d()],qn.prototype,"_graphicSymbol",null),qn=t([_("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],qn);const Wn={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let Qn=class extends Y{get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:n}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:n}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}};t([d()],Qn.prototype,"originalSymbol",void 0),t([d()],Qn.prototype,"angle",void 0),t([d()],Qn.prototype,"initialAngle",void 0),t([d()],Qn.prototype,"initialSizes",void 0),t([d()],Qn.prototype,"scale",void 0),t([d()],Qn.prototype,"state",null),Qn=t([_("InteractionState")],Qn);let Jn=class extends(Ft(Nt.EventedMixin(ii))){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new wi,this.type="transform-3d",this._scaleRotate=null,this._tooltip=null}initialize(){const{graphic:t,view:i}=this;this.graphicState=new jt({graphic:t}),this.addHandles(r((()=>this.tooltipOptions.enabled),(t=>{this._tooltip=t?new dt({view:i}):o(this._tooltip)}),p)),this._moveManipulation=new cn({tool:this,view:i,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&le(t),radius:cn.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})))));const a=t=>e=>{this.handles.add(e.events.on("focus-changed",(({action:e})=>{const i=this._tooltip;null!=i&&("focus"===e?this._updateMoveTooltip(t):i.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(a(dn.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(a(dn.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(a(dn.Z));const n=z(t);this._moveManipulation.elevationInfo=n,this.addHandles(Ia(this.graphicState));const{geometry:s}=t;if(this._moveManipulation.createGraphicDragPipeline(((e,a,o,r,l)=>{if(null!=s&&e===dn.XY){const{snappingStep:e,cancelSnapping:a}=ji({snappingContext:new Ei({elevationInfo:n,pointer:l,editGeometryOperations:fi.fromGeometry(new Wi({spatialReference:s.spatialReference}),i.state.viewingMode),visualizer:new vt,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,useZ:!1});r=r.next(a),o=o.next(si(this.view,n)).next(...e)}return{steps:o=o.next((t=>(this._updateMoveTooltip(e,t),t))),cancel:r}}),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:n}=t,o={graphic:i,dxScreen:a,dyScreen:n};switch(e){case"start":this.emit("graphic-translate-start",o),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",o);break;case"end":this.emit("graphic-translate-stop",o)}})),this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(r((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new zn({tool:this,mode:t,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([Ba({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>e()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),r((()=>i.scale),(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof Qt&&this.handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this._tooltip=o(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=o(this._scaleRotate),this._scaleRotateAdapter=o(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return null!=this.graphic.geometry&&"mesh"===this.graphic.geometry.type?new Zn({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new qn({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:this.tooltipOptions?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return r((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&le(this.graphic)}))}_createGeometryUndoRecord(){return Xn(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===Qi.Local||this.view.scale<1e6?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){ee(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{tooltipOptions:i,_tooltip:a}=this;if(null==a)return;a.clear();const n=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case dn.XY:a.info=new Oi({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,e)=>ut(t,e,n)));break;case dn.XY_AXIS:a.info=new Ti({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,i)=>{const a=ut(t,i,n);return Zt(a,en(e))}));break;case dn.Z:a.info=new Ai({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,e,Ri)}}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:n}=e,o=i(a,n);t.distance=null!=o?o:Yt}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};t([d({constructOnly:!0,nonNullable:!0})],Jn.prototype,"view",void 0),t([d({constructOnly:!0,nonNullable:!0})],Jn.prototype,"graphic",void 0),t([d({constructOnly:!0,nonNullable:!0})],Jn.prototype,"enableZ",void 0),t([d()],Jn.prototype,"enableRotation",void 0),t([d()],Jn.prototype,"enableScaling",void 0),t([d({constructOnly:!0,type:wi})],Jn.prototype,"tooltipOptions",void 0),t([d()],Jn.prototype,"graphicState",void 0),t([d({value:!1})],Jn.prototype,"snapToScene",null),t([d({constructOnly:!0})],Jn.prototype,"snappingManager",void 0),t([d({readOnly:!0})],Jn.prototype,"type",void 0),t([d({readOnly:!0})],Jn.prototype,"updating",null),Jn=t([_("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Jn);class Kn{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new ti;return this._next=t,[t=>(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t),t]}_adjustScaleFactors(t){const e=ra(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):0===t.handle.direction[0]?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let $n=class extends(Nt.EventedMixin(ii)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new wi,this._preserveAspectRatio=new Kn,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new Me,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=oa(),this._mapBoundsStart=oa(),this._zmax=0,this._sizeStart=null,this._displayBounds=oa(),this._displayBoundsStart=oa(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=ot(),this._endScale=ot()}initialize(){const{view:t,graphic:i,manipulators:a,_handles:n}=this,o=Mt(t).colors,s=this._graphicState=new jt({graphic:i}),l=i.geometry;this._editGeometryOperations=fi.fromGeometry(l,t.state.viewingMode),this._graphicMoveManipulation=new mn({tool:this,view:t,graphicState:s}),this._moveZManipulator=la(t,{offsetMode:pa.CENTER_ON_CALLOUT,calloutColor:o.accent,color:o.contrast,outlineColor:o.accent}),this._moveZManipulator.state|=ha,n.add([this._createMoveXYGraphicDragPipeline(),r((()=>this.enableZ),(()=>this._updateManipulatorAvailability(this._moveZManipulator,za.TRANSLATE_Z))),this._createMoveZDragPipeline()]),a.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map((e=>{const i=ca(t,e,{color:o.accent});return n.add([r((()=>this.enableScaling),(()=>this._updateManipulatorAvailability(i,za.SCALE))),i.events.on("grab-changed",(t=>this._onResizeGrab(t))),this._createResizeDragPipeline(i,e)]),i})),a.addMany(this._resizeManipulators);const p=!this.view._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._rotateManipulatorTexture=Ma(t.toolViewManager.textures,{accentColor:Ht(o.accent,.5),contrastColor:o.contrast,preMultiplyAlpha:p}),this._rotateManipulator=ae(t,{calloutColor:Ut(o.accent),texture:this._rotateManipulatorTexture.texture}),n.add([r((()=>this.enableRotation),(()=>this._updateManipulatorAvailability(this._rotateManipulator,za.ROTATE))),this._rotateManipulator.events.on("grab-changed",(t=>{this._onRotateGrab(t)})),this._createRotateDragPipeline(this._rotateManipulator)]),a.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const h=Ba({view:t,graphic:i,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>e()});null!=h&&(this._outlineVisualElement=h.visualElement instanceof bt?h.visualElement:null),null!=this._outlineVisualElement&&n.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>this._updateDisplayBounds()))),n.add(h),n.add([s.on("changed",(()=>this._onGeometryChanged())),r((()=>s.displaying),(()=>this._updateAllManipulatorAvailability())),r((()=>s.isDraped),(()=>this._graphicDrapedChanged()),c),t.trackGraphicState(s)]);const u=t.pointsOfInterest;n.add(r((()=>u?.centerOnSurfaceFrequent.location),(()=>this._updateDisplayBounds()))),this._forEachManipulator((t=>{n.add(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))})),this._forEachManipulator(((t,e)=>{n.add(t.events.on("immediate-click",(t=>{e===za.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:i}),t.stopPropagation()})))})),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:t,view:e}=this,i=this._tooltip=new dt({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()})),this.on("graphic-rotate-start",(t=>{this._startAngle=t.angle,a()})),this.on("graphic-rotate",(t=>{this._endAngle=t.angle,a()})),this.on("graphic-rotate-stop",(()=>{this._startAngle=0,this._endAngle=0,a()})),this.on("graphic-scale-start",(t=>{$(this._startScale,t.xScale,t.yScale),$(this._endScale,t.xScale,t.yScale),a()})),this.on("graphic-scale",(t=>{$(this._endScale,t.xScale,t.yScale),a()})),this.on("graphic-scale-stop",(()=>{$(this._startScale,0,0),$(this._endScale,0,0),a()}))]),this._forEachManipulator((e=>{t.add([e.events.on("focus-changed",a),e.events.on("grab-changed",a),e.events.on("drag",(t=>{"cancel"===t.action?this._tooltip.clear():a()}))])}))}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some((t=>t.focused))?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo??=new Oi({tooltipOptions:this.tooltipOptions})}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo??=new Ai({tooltipOptions:this.tooltipOptions}),e=this._moveUnit;if(this._moveZManipulator.dragging){const e=this._mapBoundsStart.origin,i=this._mapBounds.origin,a=Pi(e,i,this.view.spatialReference);if(null==a)return null;t.distance=a}else t.distance=Bt(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo??=new Sa({tooltipOptions:this.tooltipOptions});return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(null==t)return null;const e=this._scaleTooltipInfo??=new xa({tooltipOptions:this.tooltipOptions}),i=Dt(this._mapBounds,this._zmax,t.spatialReference,this._graphicState.isDraped);return null==i?null:(e.xSize=i[0],e.ySize=i[1],null!=this._sizeStart&&this._resizeManipulators.some((t=>t.dragging))?(e.xScale=i[0].value/this._sizeStart[0].value,e.yScale=i[1].value/this._sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this._handles.remove(to),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",(t=>{null!=this._attachmentOrigin&&ve(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()})),to)}_updateAllManipulatorAvailability(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof Qt){const a=this._graphicState.displaying,n=this.enableZ&&le(this.graphic);switch(e){case za.ROTATE:t.available=a&&this.enableRotation;break;case za.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||n),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?ua:da;break;case za.TRANSLATE_Z:t.available=a&&n;break;default:t.available=a}}}_forEachManipulator(t){this._graphicMoveManipulation.forEachManipulator(t),this._resizeManipulators.forEach((e=>t(e,za.SCALE))),t(this._rotateManipulator,za.ROTATE),t(this._moveZManipulator,za.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return Vi(this.view.spatialReference)??"meters"}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this._editGeometryOperations.data,i=e.components[0].edges[0],a=nt(ze.get(),i.leftVertex.pos,i.rightVertex.pos);tt(a,a);const n=$t(this.view,this.graphic)??t.extent?.center;let o=n?io*this.view.pixelSizeAt(n):0;const s=this.view.spatialReference,r=t.spatialReference;s.equals(r)||(o*=Ci(s)/Ci(r)),Gt(a,e,o,this._mapBounds),this._updateZMax()}_updateZMax(){const t=this._editGeometryOperations.data;if(!t.geometry.hasZ)return void(this._zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const t of a.vertices){const a=e.getZ(t.pos)??0;i=Math.max(a,i)}this._zmax=i}_updateDisplayBounds(){const{geometry:t}=this.graphic;if(null==t)return;const{extent:e}=t;if(!e)return;const i=null==this._outlineVisualElement||this._graphicState.isDraped||null==this._outlineVisualElement.attachmentOrigin?$t(this.view,this.graphic):this._outlineVisualElement.attachmentOrigin;this._attachmentOrigin=i??e.center;const a=null!=i?i.z:wt(this._mapBounds.origin,this.view.elevationProvider,Et.fromElevationInfo(z(this.graphic)),this.view.renderCoordsHelper),n=sa(this._mapBounds);n.origin[2]=a??0,It(n,this.view.renderCoordsHelper,t.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this._editGeometryOperations.data.geometry.extent?.center;return e?eo*this.view.pixelSizeAt(e):0}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline(((t,e,i)=>this._applyGraphicMoveSteps(e,i,dn.XY)))}_createMoveZDragPipeline(){const t=this.view,e=this._editGeometryOperations.data.spatialReference;return Qe(this._moveZManipulator,((i,a,n)=>{const o=P(i.renderLocation),s=a.next(Ne(t,o,e)).next($e());this._applyGraphicMoveSteps(s,n,dn.Z)}))}_applyGraphicMoveSteps(t,e,i){const a=t.next((t=>("start"===t.action&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(ei()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&this.emit("graphic-translate",e);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",e)}return t})).next((t=>this._updateMoveTooltip(t,i)));return e.next((()=>{null!=this.inputState&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()})),a}_updateOperationStartProperties(){sa(this._displayBounds,this._displayBoundsStart),sa(this._mapBounds,this._mapBoundsStart),null!=this.graphic.geometry?this._sizeStart=Dt(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped):this._sizeStart=null}_moveDragUpdateGeometry(){return t=>{if(null==this.inputState||"move"!==this.inputState.type)return t;const e=[];for(const t of this._editGeometryOperations.data.components)e.push(...t.vertices);const i="start"===t.action?Si.NEW_STEP:Si.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return Rt(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===dn.XY||e===dn.XY_AXIS){const e=ut(t.mapStart,t.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");null!=e&&null!=this._moveXYTooltipInfo&&(this._moveXYTooltipInfo.distance=e)}return t}_onResizeGrab({action:t,screenPoint:e}){if("start"!==t||!e)return;const i=this._calculatePickRay(e);Fi(this._displayBounds.plane,i,Pe.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return Qe(t,((t,i,a)=>{null!=this.inputState&&(i.next((t=>("start"===t.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),t))).next(Be(this.view,this._displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatio.createDragEventPipelineStep()).next(this._resizeDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":this.emit("graphic-scale",e);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",e)}return t})),a.next((()=>{null!=this.inputState&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()})))}))}_resizeDragRenderPlaneToFactors(){return t=>{const e=this._displayBoundsStart,i=t.handle.direction,a=this._displayBoundsMargin,n=this._displayBoundsMarginStart,o=G(Pe.get(),e.origin);I(o,o,e.basis1,-i[0]),I(o,o,e.basis2,-i[1]);const s=S(Pe.get(),t.renderEnd,o),r=S(Pe.get(),t.renderStart,o),l=ra(t.handle),p=ma(e),h=ma(this._displayBounds)/p,c=(t,e)=>{if(0===t)return 1;let i=A(e),o=.5*t*w(e,s)/i;const p=o<0?-1:1;l&&(o+=(i-.5*t*w(e,r)/i)*p*h);const c=i<1.5*n?1:ao;return i=Math.max(i-n,ao),p>0&&(o-=a),p*Math.max(p*(o/i),c)};return{...t,factor1:c(i[0],e.basis1),factor2:c(i[1],e.basis2)}}}_resizeDragUpdateGeometry(){return t=>{const e=G(R(),this._mapBoundsStart.origin);I(e,e,this._mapBoundsStart.basis1,-t.handle.direction[0]),I(e,e,this._mapBoundsStart.basis2,-t.handle.direction[1]);const i=$(ot(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);tt(i,i);const a=[];for(const t of this._editGeometryOperations.data.components)a.push(...t.vertices);const n="start"===t.action?Si.NEW_STEP:Si.ACCUMULATE_STEPS,o=this._editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,n,xi.REPLACE);return sa(this._mapBoundsStart,this._mapBounds),Rt(o,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_onRotateGrab({action:t,screenPoint:e}){if("start"!==t||!e)return;const i=ga(this._displayBounds,this.view.renderCoordsHelper,_a.HEADING,ki()),a=this._calculatePickRay(e);Fi(i,a,Pe.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:i})}_createRotateDragPipeline(t){return Qe(t,((t,e,i)=>{const a=this.inputState;null!=a&&(e.next((t=>("start"===t.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),t))).next(Be(this.view,a.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(a)).next(this._rotateDragUpdateGeometry()).next((t=>{const e={graphic:this.graphic,angle:ce(t.rotateAngle)};switch(t.action){case"start":case"update":this.emit("graphic-rotate",e);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",e)}return t})),i.next((()=>{null!=this.inputState&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()})))}))}_rotateDragRenderPlaneToRotate(t){return e=>{const i=zi(t.rotatePlane),a=ie(e.renderStart,e.renderEnd,this._displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return t=>{const e=G(R(),this._mapBoundsStart.origin),i=[];for(const t of this._editGeometryOperations.data.components)i.push(...t.vertices);const a="start"===t.action?Si.NEW_STEP:Si.ACCUMULATE_STEPS,n=this._editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,xi.REPLACE);return sa(this._mapBoundsStart,this._mapBounds),Rt(n,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=He(),i=Z(t);return ba(this.view.state.camera,i,e),x(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=ya(this._displayBounds,Ce.get());va(this._rotateManipulator,t,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,t),this._resizeManipulators.forEach(((e,i)=>{fa(e,this._resizeHandles[i],t,this._displayBounds)}))}_updateZMoveHandle(t,e){const i=this._displayBounds,a={basis:i.basis1,direction:-1,position:S(Pe.get(),i.origin,i.basis1),edge:2},n=Ce.get();Ge(n,e,a.edge*Math.PI/2),n[12]=0,n[13]=0,n[14]=0,t.modelTransform=n,t.renderLocation=a.position}_cancel(){const t=this._editGeometryOperations.lastOperation;null!=t&&(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,Lt(t,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(null!=this.inputState)this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Lt(t,this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,Rt(t,this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};t([d({constructOnly:!0,nonNullable:!0})],$n.prototype,"view",void 0),t([d({constructOnly:!0,nonNullable:!0})],$n.prototype,"graphic",void 0),t([d({constructOnly:!0,nonNullable:!0})],$n.prototype,"enableZ",void 0),t([d()],$n.prototype,"enableRotation",void 0),t([d()],$n.prototype,"enableScaling",void 0),t([d({constructOnly:!0,type:wi})],$n.prototype,"tooltipOptions",void 0),t([d()],$n.prototype,"preserveAspectRatio",null),t([d()],$n.prototype,"grabbing",void 0),t([d()],$n.prototype,"inputState",void 0),t([d({readOnly:!0})],$n.prototype,"type",void 0),t([d()],$n.prototype,"_moveUnit",null),$n=t([_("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],$n);const to="draped-elevation-changes",eo=10,io=80,ao=1e-6;export{Pa as DrawGraphicTool3D,$n as ExtentTransformTool,fn as GraphicMoveTool,Rn as GraphicReshapeTool,Jn as GraphicTransformTool};

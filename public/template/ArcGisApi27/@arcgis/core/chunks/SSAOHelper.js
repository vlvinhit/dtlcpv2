/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{c as e,l as t}from"./mathUtils.js";import{s as i,c as s,A as r,e as h,a,x as n}from"./vec3.js";import{c,f as o}from"./vec3f64.js";import{h as l}from"./maybe.js";import{M as m}from"../core/scheduling.js";import{s as g}from"./vec2.js";import{a as u}from"./glUtil3D.js";import{R as d,S as f,P as j}from"./Program2.js";import{D as p}from"./Material.js";import{S as E}from"./SSAOBlur.glsl.js";import{m as _,a as G}from"./renderState.js";import{S as z,g as M}from"./SSAO.glsl.js";import{a as F}from"./vec2f64.js";import{N as B}from"./interfaces2.js";import{e as b,i as q,T as Y,P as J}from"./enums3.js";import{F as y}from"./FramebufferObject.js";import{v as Z,T as H,a as x}from"./Texture.js";class S{constructor(e=c()){this.intensity=e}}class I{constructor(e=c(),t=o(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class O{constructor(e=c(),t=o(.57735,.57735,.57735),i=!0,s=1,r=1){this.intensity=e,this.direction=t,this.castShadows=i,this.specularStrength=s,this.environmentStrength=r}}class X{constructor(){this.r=[0],this.g=[0],this.b=[0]}}function W(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]*t[s];return i}function R(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]*t;return i}function w(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]+t[s];return i}function U(e){return(e+1)*(e+1)}function K(e,t,i){const s=e[0],r=e[1],h=e[2],a=i||[];return a.length=U(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*s,a[2]=.4886025119*h,a[3]=.4886025119*r),t>=2&&(a[4]=1.09254843059*s*r,a[5]=1.09254843059*r*h,a[6]=.31539156525*(3*h*h-1),a[7]=1.09254843059*s*h,a[8]=.54627421529*(s*s-r*r)),a}const P=[],L=[],V=[],T=[0],D=[0],N=c(),A=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class C{constructor(){this.color=c(),this.intensity=1}}class v{constructor(){this.direction=c(),this.ambient=new C,this.diffuse=new C}}const k=.4;class Q{constructor(){this._shOrder=2,this._legacy=new v,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new X,this._mainLight=new O(c(),o(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){(function(t,h,a,n){!function(e,t){const i=U(e),s=t||{r:[],g:[],b:[]};s.r.length=s.g.length=s.b.length=i;for(let e=0;e<i;e++)s.r[e]=s.g[e]=s.b[e]=0}(h,n),i(a.intensity,0,0,0);let c=!1;const o=P,l=L,m=V;o.length=0,l.length=0,m.length=0;for(const e of t)e instanceof O&&!c?(s(a.direction,e.direction),s(a.intensity,e.intensity),a.specularStrength=e.specularStrength,a.environmentStrength=e.environmentStrength,a.castShadows=e.castShadows,c=!0):e instanceof O||e instanceof I?o.push(e):e instanceof S?l.push(e):e instanceof X&&m.push(e);(function(t,i){const s=(h=i.r.length,e(Math.floor(Math.sqrt(h)-1),0,2));var h;for(const e of t)r(N,e.direction),K(N,s,T),W(T,A),R(T,e.intensity[0],D),w(i.r,D),R(T,e.intensity[1],D),w(i.g,D),R(T,e.intensity[2],D),w(i.b,D)})(o,n),function(e,t){K(N,0,T);for(const i of e)t.r[0]+=T[0]*A[0]*i.intensity[0]*4*Math.PI,t.g[0]+=T[0]*A[0]*i.intensity[1]*4*Math.PI,t.b[0]+=T[0]*A[0]*i.intensity[2]*4*Math.PI}(l,n);for(const e of m)w(n.r,e.r),w(n.g,e.g),w(n.b,e.b)})(t,this._shOrder,this._mainLight,this._sphericalHarmonics),s(this._legacy.direction,this._mainLight.direction);const n=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*n,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*n,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*n,h(this._legacy.diffuse.color,this._mainLight.intensity,n),s($,this._legacy.diffuse.color),h($,$,.4*this.globalFactor),a(this._legacy.ambient.color,this._legacy.ambient.color,$)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),s(this._mainLight.direction,e.mainLight.direction),s(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,r){if(n(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,r),this._mainLight.environmentStrength=t(e.mainLight.environmentStrength,i.mainLight.environmentStrength,r),this._mainLight.specularStrength=t(e.mainLight.specularStrength,i.mainLight.specularStrength,r),s(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=t(e.globalFactor,i.globalFactor,r),this.noonFactor=t(e.noonFactor,i.noonFactor,r),e.sh.r.length===i.sh.r.length)for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=t(e.sh.r[s],i.sh.r[s],r),this._sphericalHarmonics.g[s]=t(e.sh.g[s],i.sh.g[s],r),this._sphericalHarmonics.b[s]=t(e.sh.b[s],i.sh.b[s],r);else for(let e=0;e<i.sh.r.length;e++)this._sphericalHarmonics.r[e]=i.sh.r[e],this._sphericalHarmonics.g[e]=i.sh.g[e],this._sphericalHarmonics.b[e]=i.sh.b[e]}}const $=c();class ee extends f{initializeProgram(e){return new j(e.rctx,ee.shader.get().build(),p)}initializePipeline(){return _({colorWrite:G})}}ee.shader=new d(E,(()=>import("./SSAOBlur.glsl.js").then((e=>e.S))));class te extends f{initializeProgram(e){return new j(e.rctx,te.shader.get().build(),p)}initializePipeline(){return _({colorWrite:G})}}te.shader=new d(z,(()=>import("./SSAO.glsl.js").then((e=>e.S))));class ie extends B{constructor(){super(...arguments),this.projScale=1}}class se extends ie{constructor(){super(...arguments),this.intensity=1}}class re extends B{}class he extends re{constructor(){super(...arguments),this.blurSize=F()}}const ae=2;class ne{constructor(e,t,i,s){this._view=e,this._techniqueRepository=t,this._rctx=i,this._requestRender=s,this._quadVAO=null,this._passParameters=new se,this._drawParameters=new he}dispose(){this.enabled=!1,this._quadVAO=l(this._quadVAO)}destroy(){this.dispose()}disposeOffscreenBuffers(){this._ssaoFBO?.resize(0,0),this._blurFBO?.resize(0,0)}set enabled(e){e?this._enable():this._disable()}get enabled(){return null!=this._enableTime}get active(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}get colorTexture(){return this._ssaoFBO?.colorTexture}render(e,t,i,s){if(null==this._enableTime||null==i||null==s||null==this._ssaoFBO||null==this._blurFBO)return;if(!this.active)return this._enableTime=t,void this._requestRender();0===this._enableTime&&(this._enableTime=t);const r=this._rctx,h=e.camera,a=this._view.qualitySettings.fadeDuration,n=a>0?Math.min(a,t-this._enableTime)/a:1;this._passParameters.normalTexture=s,this._passParameters.depthTexture=i,this._passParameters.projScale=1/h.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*ce/M(h)**6*n;const c=h.fullViewport,o=c[2],l=c[3],m=o/2,d=l/2;this._ssaoFBO.resize(o,l),this._blurFBO.resize(m,d),null==this._quadVAO&&(this._quadVAO=u(this._rctx)),r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,o,l),r.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),r.bindVAO(this._quadVAO);const f=Z(this._quadVAO,"geometry");r.drawArrays(b.TRIANGLE_STRIP,0,f);const j=r.bindTechnique(this._blurTechnique,this._passParameters,e);r.setViewport(0,0,m,d),r.bindFramebuffer(this._blurFBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,g(this._drawParameters.blurSize,0,2/l),j.bindDraw(this._drawParameters,e,this._passParameters),r.setViewport(0,0,m,d),r.drawArrays(b.TRIANGLE_STRIP,0,f),r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,o,l),r.setClearColor(1,1,1,0),r.clear(q.COLOR_BUFFER_BIT),r.setViewport(0,0,m,d),this._drawParameters.colorTexture=this._blurFBO.colorTexture,g(this._drawParameters.blurSize,2/o,0),j.bindDraw(this._drawParameters,e,this._passParameters),r.drawArrays(b.TRIANGLE_STRIP,0,f),r.setViewport(c[0],c[1],c[2],c[3]),n<1&&this._requestRender()}_enable(){if(null!=this._enableTime)return;const e=new H;e.wrapMode=Y.CLAMP_TO_EDGE,this._ssaoFBO=new y(this._rctx,e),this._blurFBO=new y(this._rctx,e);const t=Uint8Array.from(atob("eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM"),(e=>e.charCodeAt(0)));e.pixelFormat=J.RGB,e.wrapMode=Y.REPEAT,e.hasMipmap=!0,e.width=32,e.height=32,this._passParameters.noiseTexture=new x(this._rctx,e,t),null==this._ssaoTechnique&&(this._ssaoTechnique=this._techniqueRepository.acquire(te)),null==this._blurTechnique&&(this._blurTechnique=this._techniqueRepository.acquire(ee)),this._enableTime=m(0),this._requestRender()}_disable(){this._enableTime=null,this._passParameters.noiseTexture=l(this._passParameters.noiseTexture),this._blurFBO=l(this._blurFBO),this._ssaoFBO=l(this._ssaoFBO)}get gpuMemoryUsage(){return(this._blurFBO?.gpuMemoryUsage??0)+(this._ssaoFBO?.gpuMemoryUsage??0)}}const ce=.5;export{S as A,I as F,O as M,Q as S,ne as a,ae as b,k as c};

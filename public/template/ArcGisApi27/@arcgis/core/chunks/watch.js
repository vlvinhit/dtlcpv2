/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{A as e}from"./ArrayPool.js";import{equals as t,equalsShallow as s}from"../core/lang.js";import{n as r}from"./maybe.js";import{O as n}from"./ObjectPool.js";import{schedule as o}from"../core/scheduling.js";import{v as i}from"./get.js";import{r as l}from"./tracking.js";import{p as u,o as c}from"./utils.js";class a extends n{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=r(this._set)}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}function d(e,t){for(const s of e.entries())if(t(s[0]))return!0;return!1}function h(e,t){const s=new Set;return null!=e&&e.forEach((e=>s.add(e))),null!=t&&t.forEach((e=>s.add(e))),s}let f=0;const _=0;function v(){return++f}class m{constructor(e){this._accessed=[],this._handles=[],this._observerObject=new p(e),g.register(this,new WeakRef(this._observerObject),this)}destroy(){g.unregister(this._observerObject),this._accessed.length=0,this._observerObject?.destroy(),this.clear()}onObservableAccessed(e){const t=this._accessed;t.includes(e)||t.push(e)}onTrackingEnd(){const e=this._handles,t=this._accessed,s=this._observerObject;for(let r=0;r<t.length;++r)e.push(t[r].observe(s));t.length=0}clear(){const e=this._handles;for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}class p{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(1===e)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=y}}const g=new FinalizationRegistry((e=>{e.deref()?.destroy()}));function y(){}let b=!1;const k=[];function j(e,t){let s=new m((function o(){if(!s||n)return;if(b)return void V(o);const i=r;s.clear(),b=!0,n=!0,r=l(s,e),n=!1,b=!1,t(r,i),O()})),r=null,n=!1;return n=!0,r=l(s,e),n=!1,{remove:function(){s&&(s.destroy(),s=null,r=null)}}}function q(e,t){let s=new m((function(){t(r,n)})),r=null;function n(){return s?(s.clear(),r=l(s,e),r):null}return n(),{remove:function(){s&&(s.destroy(),s=null),r=null}}}function w(e){let t=new m((function r(){t&&!s&&(b?V(r):(t.clear(),b=!0,s=!0,l(t,e),s=!1,b=!1,O()))})),s=!1;return s=!0,l(t,e),s=!1,{remove:function(){t&&(t.destroy(),t=null)}}}function V(e){k.includes(e)||k.unshift(e)}function O(){for(;k.length;)k.pop()()}var C;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(C||(C={}));class T{constructor(){this.uid=v(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,s,r,n,o){return this.pool.acquire(C.Untracked,e,s,r,n,o,t)}static acquireTracked(e,t,s,r){return this.pool.acquire(C.Tracked,e,t,s,null,null,r)}notify(e,t){this.type===C.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,s,r,n,o,i){this.uid=v(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=s,this.getValue=r,this.target=n,this.path=o,this.equals=i}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=v(),this.removed=!0}}T.pool=new a(T);const U=new e,S=new Set;let E;function A(e){S.delete(e),S.add(e),E||(E=o(z))}function R(e){if(e.removed)return;const t=e.oldValue,s=e.getValue();e.equals(t,s)||(e.oldValue=s,e.notify(s,t))}function x(e){for(const t of S.values())t.target===e&&(t.removed=!0)}function z(){let e=10;for(;E&&e--;){E=null;const e=P(),t=U.acquire();for(const s of e){const e=s.uid;R(s),e===s.uid&&s.removed&&t.push(s)}for(const e of S)e.removed&&(t.push(e),S.delete(e));for(const e of t)T.pool.release(e);U.release(t),U.release(e),F.forEach((e=>e()))}}function P(){const e=U.acquire();e.length=S.size;let t=0;for(const s of S)e[t]=s,++t;return S.clear(),e}const F=new Set;function I(e){return F.add(e),{remove(){F.delete(e)}}}function N(e,s,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?function(e,s,r){const n=u(e,s,r,((e,s,r)=>{let o=!1;return j((()=>i(e,s)),((i,l)=>{e.__accessor__.destroyed?n.remove():o||(o=!0,t(l,i)||r.call(e,i,l,s,e),o=!1)}))}));return n}(e,s,r):function(e,t,s){let r=u(e,t,s,((e,t,s)=>{let n,o,l=q((()=>i(e,t)),((i,l)=>{e.__accessor__.destroyed||n&&n.uid!==o?r.remove():(n||(n=T.acquireUntracked(i,s,l,e,t),o=n.uid),A(n))}));return{remove:c((()=>{l.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,A(n)),n=null),r=l=null}))}}));return r}(e,s,r)}function W(e,t,r=!1,n=s){return r?function(e,t,s){let r=!1;return j(e,((e,n)=>{r||(r=!0,s(n,e)||t(e,n),r=!1)}))}(e,t,n):function(e,t,s){let r,n,o=q(e,((e,i)=>{r&&r.uid!==n?o.remove():(r||(r=T.acquireTracked(e,t,i,s),n=r.uid),A(r))}));return{remove:c((()=>{o.remove(),r&&(r.uid!==n||r.removed||(r.removed=!0,A(r)),r=null),o=null}))}}(e,t,n)}function B(e){return d(S,(t=>t.oldValue===e))}export{_ as N,a as R,m as S,w as a,W as b,I as c,v as g,B as i,x as r,d as s,h as u,N as w};

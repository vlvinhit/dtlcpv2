/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../Color.js";import{g as t}from"./analysisThemeUtils.js";import"./typedArrayUtil.js";import{d as r}from"./utils.js";import{h as i,c as s,n as o,b as n,a,x as c}from"./vec3.js";import{c as l,f as d}from"./vec3f64.js";import{projectVectorToVector as p}from"../geometry/projection.js";import{o as u,f as m}from"./elevationInfoUtils.js";import{E as h,a as f}from"./ExtendedLineVisualElement.js";import{watch as g}from"../core/reactiveUtils.js";import{h as _,e as j}from"./screenUtils.js";import{e as y,c as O,b as R,s as D,j as v}from"./vec2.js";import{a as w}from"./vec2f64.js";import{e as b,c as E}from"./vec4.js";import{f as S}from"./vec4f32.js";import{m as x}from"./dehydratedFeatures.js";import{E as G}from"./EngineVisualElement.js";import{R as A,D as C,b as P}from"./RenderGeometry.js";import{c as V}from"./GeometryUtil.js";import{R as H}from"./Material.js";import{V as T}from"./VertexAttribute.js";import{R as z}from"./TriangleMaterial.js";import{P as F}from"./PointVisualElement.js";import{R as L}from"./RightAngleQuadVisualElement.js";import{d as U}from"./Settings2.js";import{L as I,a as M}from"./LineSnappingHint.js";import{a as N,L as q,c as W}from"./snappingUtils.js";import{a as B}from"./SnappingContext.js";import{v as k}from"./viewUtils.js";class Q extends G{constructor(e){super(e),this._location=l(),this._direction=d(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=S(1,0,1,1),this._renderOccluded=H.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyObject3DResources(e),recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyDrapedResources(e),recreateGeometry:e=>this._recreateDrapedGeometry(e)}}get location(){return this._location}set location(e){i(this._location,e)||(s(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){i(this._direction,e)||(s(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){o(this._direction,n(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){b(e,this._color)||(E(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new z(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,r){const[i,s]=this._createGeometries(e);t.addGeometry(i),t.addGeometry(s),r.push(i),r.push(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new z(this.materialParameters),t=g((()=>this.view.state.contentPixelRatio),(()=>{this.drapedResources.recreateGeometry()}));return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map((e=>new A(e)))}_createGeometries(e){return[V(e,[l(),l()]),V(e,[l(),l()])]}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Y),a(Z,this.location,this.direction),t.projectToScreen(Z,$),y($,O($,$,Y)),this._updateVertexAttributesObject3D(t,e,0,Y,$,1),this._updateVertexAttributesObject3D(t,e,1,Y,$,-1)}_updateVertexAttributesObject3D(e,t,r,i,s,o){const n=t.geometries[r],a=n.getMutableAttribute(T.POSITION)?.data;if(!a)return;const{start:c,end:l}=this._computeStartEnd(s,i,o,this.offset,this.width,this.length);e.unprojectFromScreen(_(c),Z),a[0]=Z[0],a[1]=Z[1],a[2]=Z[2],e.unprojectFromScreen(_(l),Z),a[3]=Z[0],a[4]=Z[1],a[5]=Z[2],t.geometryVertexAttrsUpdated(n)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:i,width:s,length:o,offset:n}=this,a=ee;a.spatialReference=t.renderer.spatialReference,a.x=i[0],a.y=i[1];const c=t.overlayPixelSizeInMapUnits(a)*r,l=s*c,d=o*c,p=n*c;this._updateVertexAttributesDraped(e[0],l,d,p,-1),this._updateVertexAttributesDraped(e[1],l,d,p,1)}_updateVertexAttributesDraped(e,t,r,i,s){const o=e.getMutableAttribute(T.POSITION)?.data;if(!o)return;const{location:n,direction:a}=this,{start:c,end:l}=this._computeStartEnd(a,n,s,i,t,r);o[0]=c[0],o[1]=c[1],o[2]=C,o[3]=l[0],o[4]=l[1],o[5]=C,e.invalidateBoundingInfo()}_computeStartEnd(e,t,r,i,s,o){const n=R(X,D(X,e[1]*r,e[0]*-r),i+s/2),a=v(J,v(J,v(J,t,R(J,e,o/2)),n),n);return{start:a,end:v(K,a,R(K,e,-o))}}}const Z=l(),X=w(),J=w(),K=w(),Y=j(),$=j(),ee=x(0,0,void 0,null);class te extends B{sortUniqueHints(e){return e.sort(((e,t)=>(t instanceof I?t.length:0)-(e instanceof I?e.length:0)))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:s}=t,o=re();return r(new F({view:s,primitive:"circle",geometry:N(e.intersectionPoint,i),elevationInfo:e.isDraped?u:m,size:20,outlineSize:2,color:o.intersectionPointColor,outlineColor:o.intersectionPointOutlineColor,pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:i,spatialReference:s}=t,o=re(),n=ie(e.point,e.domain,t);return r(new F({view:i,primitive:"circle",geometry:N(n,s),elevationInfo:se(e,t),size:20,outlineSize:2,color:o.pointColor,outlineColor:o.pointOutlineColor,pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:i,spatialReference:s}=t,o=re(),n=ie(e.lineStart,e.domain,t),a=ie(e.lineEnd,e.domain,t);return r(this._createLineSegmentHint(e.type,n,a,s,se(e,t),i,o,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:s}=t,o=re(),{isDraped:n}=e,a=se(e,t),l=ie(e.lineStart,e.domain,t),d=ie(e.lineEnd,e.domain,t),p=ne(l,s,a,i,n),u=ne(d,s,a,i,n),m=c(u,p,u,.5),h=new Q({view:i,attached:!1,offset:U.parallelLineHintOffset,length:U.parallelLineHintLength,width:U.parallelLineHintWidth,color:o.parallelSignColor,location:m,renderOccluded:n?H.OccludeAndTransparent:H.Opaque,isDraped:n,renderGroup:P.SnappingHint});return h.setDirectionFromPoints(p,m),h.attached=!0,r(h)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:s}=t,o=re(),n=se(e,t),{isDraped:a}=e,c=ie(e.previousVertex,e.domain,t),l=ie(e.centerVertex,e.domain,t),d=ie(e.nextVertex,e.domain,t),p=ne(c,s,n,i,a),u=ne(l,s,n,i,a),m=ne(d,s,n,i,a);return r(new L({view:i,attached:!0,color:a?o.rightAngleColorDraped:o.rightAngleColor,renderOccluded:a?H.OccludeAndTransparent:H.Transparent,outlineRenderOccluded:a?H.OccludeAndTransparent:H.Opaque,outlineColor:o.rightAngleOutlineColor,outlineSize:U.rightAngleHintOutlineSize,size:U.rightAngleHintSize,isDraped:a,geometry:{previous:p,center:u,next:m},renderGroup:P.SnappingHint}))}_createLineSegmentHint(e,t,r,i,s,o,n,a=!1,c=!0,l=!0){const d=ne(t,i,s,o,a),p=ne(r,i,s,o,a),u=new h({view:o,extensionType:f.FADED,start:d,end:p,isDraped:a,color:n.lineColor,renderOccluded:a?H.OccludeAndTransparent:H.Opaque,renderGroup:P.SnappingHint});switch(e){case q.TARGET:u.width=U.lineHintWidthTarget,u.fadedExtensions={start:0,end:U.lineHintFadedExtensions};break;case q.REFERENCE_EXTENSION:u.width=U.lineHintWidthReference,u.fadedExtensions={start:0,end:0};break;case q.REFERENCE:u.width=U.lineHintWidthReference,u.fadedExtensions={start:c?U.lineHintFadedExtensions:0,end:l?U.lineHintFadedExtensions:0}}return u.attached=!0,u}}function re(r){const i=e.toUnitRGBA(t()),s=[0,0,0,0];return{intersectionPointColor:s,intersectionPointOutlineColor:i,pointColor:s,pointOutlineColor:i,lineColor:i,lineOutlineColor:void 0,parallelSignColor:i,rightAngleColor:i,rightAngleColorDraped:e.toUnitRGBA(t(.5)),rightAngleOutlineColor:i}}function ie(e,t,r){const i=oe(t,r);return null==i?e:W(e[0],e[1],i)}function se(e,t){return null!=oe(e.domain,t)?t.selfSnappingZ.elevationInfo:e.isDraped?u:m}function oe(e,{selfSnappingZ:t}){return e===M.SELF&&null!=t?t.value:null}function ne(e,t,r,i,s,o=l()){if(s){const r=i.basemapTerrain.overlayManager.renderer.spatialReference;p(e,t,o,r)}else k(e,t,r,i,o);return o}export{te as S};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{s as e,b as t,c as i,a as s}from"./vec3.js";import{c as n,f as r,e as a}from"./vec3f64.js";import{c as l,b as h,e as c}from"./lineSegment.js";import{V as o}from"./VisualElement.js";import{h as d,f as _}from"./maybe.js";import{b as u,d as f,e as g,g as p,h as P}from"./frustum.js";import{w as m}from"./ray.js";import{V as b}from"./ViewingMode.js";import{n as V}from"./DoubleArray.js";import{g as L}from"./glUtil.js";import{n as E}from"./InterleavedLayout.js";import{V as y,a as R}from"./glUtil3D.js";import{V as D}from"./VertexAttribute.js";import{R as S,S as q,P as M}from"./Program2.js";import{L as v}from"./LaserlinePath.glsl.js";import{f as C,e as T,U as A}from"./enums3.js";import{m as w,b as I,a as x}from"./renderState.js";import{B as j}from"./VertexArrayObject.js";import{R as O}from"./RenderSlot.js";import{D as B,c as N,u as U}from"./Material.js";import{_ as H}from"./tslib.es6.js";import{p as W,S as z}from"./ShaderTechniqueConfiguration.js";import{d as G}from"./mathUtils.js";import{N as X}from"./interfaces2.js";import{L as F,d as k}from"./Laserlines.glsl.js";class J extends q{initializeProgram(e){return new M(e.rctx,J.shader.get().build(this.configuration),K)}initializePipeline(){return w({blending:I(C.ONE,C.ONE_MINUS_SRC_ALPHA),colorWrite:x})}}J.shader=new S(v,(()=>import("./LaserlinePath.glsl.js").then((e=>e.L))));const K=new Map([[D.START,0],[D.END,1],[D.UP,2],[D.EXTRUDE,3]]);class Q{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=n(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=V(3*e.length);let i=0;for(const s of e)t[i++]=s[0],t[i++]=s[1],t[i++]=s[2];this.buffers=[t]}set buffers(t){if(this._buffers=t,this._buffers.length>0){const t=this._buffers[0],i=3*Math.floor(t.length/3/2);e(this._origin,t[i],t[i+1],t[i+2])}else e(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this._ensureVAO(e);null!=t&&(e.bindVAO(t),e.drawArrays(T.TRIANGLES,0,this._count))}dispose(){null!=this._vao&&this._vao.dispose()}_ensureVAO(e){return null==this._buffers?null:(null==this._vao&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new y(e,K,{data:L($)},{data:j.createVertex(e,A.STATIC_DRAW,i)})}_ensureVertexData(e,t){if(!this._dirty)return;const i=this._createDataBuffer(t);e.vertexBuffers.data?.setData(i),this._dirty=!1}_numberOfRenderVertices(e){return 2*(e.length/3-1)*3}_createDataBuffer(i){const s=i.reduce(((e,t)=>e+this._numberOfRenderVertices(t)),0);this._count=s;const n=$.createBuffer(s),r=this._origin;let a=0,l=0;for(const s of i){for(let i=0;i<s.length;i+=3){const h=e(Z,s[i],s[i+1],s[i+2]);0===i?l=this._renderCoordsHelper.getAltitude(h):this._renderCoordsHelper.setAltitude(h,l);const c=this._renderCoordsHelper.worldUpAtPosition(h,Y),o=a+2*i,d=t(Z,h,r);if(i<s.length-3){n.up.setVec(o,c),n.up.setVec(o+3,c),n.up.setVec(o+5,c);for(let e=0;e<6;e++)n.start.setVec(o+e,d);n.extrude.setValues(o,0,-1),n.extrude.setValues(o+1,1,-1),n.extrude.setValues(o+2,1,1),n.extrude.setValues(o+3,0,-1),n.extrude.setValues(o+4,1,1),n.extrude.setValues(o+5,0,1)}if(i>0){n.up.setVec(o-2,c),n.up.setVec(o-4,c),n.up.setVec(o-5,c);for(let e=-6;e<0;e++)n.end.setVec(o+e,d)}}a+=this._numberOfRenderVertices(s)}return n.buffer}}const Y=n(),Z=n(),$=E().vec3f(D.START).vec3f(D.END).vec3f(D.UP).vec2f(D.EXTRUDE);class ee extends z{constructor(){super(...arguments),this.contrastControlEnabled=!1}}H([W()],ee.prototype,"contrastControlEnabled",void 0);class te extends X{constructor(){super(...arguments),this.innerColor=r(1,1,1),this.innerWidth=1,this.glowColor=r(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=G(6),this.pointDistanceOrigin=n(),this.pointDistanceTarget=n(),this.lineVerticalPlaneSegment=l(),this.intersectsLineSegment=l(),this.intersectsLineRadius=3,this.heightManifoldTarget=n(),this.lineStartWorld=n(),this.lineEndWorld=n()}}class ie extends q{initializeProgram(e){return new M(e.rctx,ie.shader.get().build(this.configuration),B)}initializePipeline(){return w({blending:I(C.ONE,C.ONE_MINUS_SRC_ALPHA),colorWrite:x})}}ie.shader=new S(F,(()=>import("./Laserlines.glsl.js").then((e=>e.L))));class se extends ee{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.spherical=!1}}H([W()],se.prototype,"heightManifoldEnabled",void 0),H([W()],se.prototype,"pointDistanceEnabled",void 0),H([W()],se.prototype,"lineVerticalPlaneEnabled",void 0),H([W()],se.prototype,"intersectsLineEnabled",void 0),H([W()],se.prototype,"spherical",void 0);class ne{constructor(e,t={contrastControlEnabled:!1}){this._config=t,this._technique=null,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._viewingMode=b.Local,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._passParameters=N(e,new te)}get renderSlots(){return[this._config.contrastControlEnabled?O.LASERLINES_CONTRAST_CONTROL:O.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){i(this._passParameters.heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){i(this._passParameters.pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){i(this._passParameters.pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){h(e,this._passParameters.lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){h(e,this._passParameters.intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get viewingMode(){return this._viewingMode}set viewingMode(e){e!==this._viewingMode&&(this._viewingMode=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,null!=this._pathVerticalPlaneData&&this._requestRender())}set pathVerticalPlaneVertices(e){null==this._pathVerticalPlaneData&&(this._pathVerticalPlaneData=new Q(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){null==this._pathVerticalPlaneData&&(this._pathVerticalPlaneData=new Q(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){U(this._passParameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=R(t),this._techniqueRepository=e.techniqueRepository,this._techniqueConfig=new se;const i=new ee;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(J,i)}uninitializeRenderContext(){this._quadVAO=d(this._quadVAO),this._technique=_(this._technique),this._pathVerticalPlaneData=d(this._pathVerticalPlaneData),this._pathTechnique=_(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._techniqueConfig.spherical=this._viewingMode===b.Global,this._technique=this._techniqueRepository.releaseAndAcquire(ie,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,t){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,t){const i=e.rctx;this._updatePassParameters(e),i.bindTechnique(t,this._passParameters,e.bindParameters),i.bindVAO(this._quadVAO),i.drawArrays(T.TRIANGLE_STRIP,0,4)}_renderPath(e){if(null==this._pathVerticalPlaneData||null==this._pathTechnique)return;const t=e.rctx,i=this._pathTechnique;t.bindTechnique(i,{...this._passParameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters),this._pathVerticalPlaneData.draw(e.rctx)}_updatePassParameters(e){if(!this._intersectsLineEnabled)return;const t=e.bindParameters.camera;if(this._intersectsLineInfinite){if(f(m(this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector),re),re.c0=-Number.MAX_VALUE,!g(t.frustum,re))return;p(re,this._passParameters.lineStartWorld),P(re,this._passParameters.lineEndWorld)}else i(this._passParameters.lineStartWorld,this._passParameters.intersectsLineSegment.origin),s(this._passParameters.lineEndWorld,this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector)}_requestRender(){this._context&&this._context.requestRender()}}const re=u();class ae extends o{constructor(e){super(e.view),this._angleCutoff=k,this._style={},this._heightManifoldTarget=n(),this._heightManifoldEnabled=!1,this._intersectsLine=l(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this._renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){null!=e?(i(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(null==e)return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,le);this.intersectsLine=c(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){null!=e?(h(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=null!=e?h(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=null!=e?{origin:a(e.origin),target:e.target?a(e.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||null!=this._pointDistanceLine||null!=this._pathVerticalPlaneBuffers)?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){null==this._renderer&&(this._renderer=new ne({renderCoordsHelper:this.view.renderCoordsHelper},{contrastControlEnabled:!0}),this._renderer.viewingMode=this.view.state.viewingMode,this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this._renderer.renderSlots,this._renderer))}_syncStyle(){null!=this._renderer&&(this._renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){null!=this._renderer&&this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){null!=this._renderer&&(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){null!=this._renderer&&(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){null!=this._renderer&&(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){null!=this._renderer&&(this._renderer.pathVerticalPlaneEnabled=null!=this._pathVerticalPlaneBuffers&&this.visible,null!=this._pathVerticalPlaneBuffers&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){null!=this._renderer&&(this._renderer.lineVerticalPlaneEnabled=null!=this._lineVerticalPlaneSegment&&this.visible,null!=this._lineVerticalPlaneSegment&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(null==this._renderer)return;const e=this._pointDistanceLine,t=null!=e;this._renderer.pointDistanceEnabled=t&&null!=e.target&&this.visible,t&&(this._renderer.pointDistanceOrigin=e.origin,null!=e.target&&(this._renderer.pointDistanceTarget=e.target))}_disposeRenderer(){null!=this._renderer&&this.view._stage&&(this.view._stage.removeRenderPlugin(this._renderer),this._renderer=null)}}const le=n();export{ae as L};

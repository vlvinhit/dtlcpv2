/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../config.js";import t from"../core/Error.js";import{h as o}from"./typedArrayUtil.js";import{L as r}from"./Logger.js";import i from"../geometry/Point.js";import{geographicToWebMercator as n}from"../geometry/support/webMercatorUtils.js";import s from"../portal/Portal.js";import{p as c}from"./project.js";import u from"../rest/support/ProjectParameters.js";const a=r.getLogger("esri.widgets.support.geolocationUtils"),m={maximumAge:0,timeout:15e3,enableHighAccuracy:!0};function l(){return function(){const e=o("esri-geolocation");return e||a.warn("geolocation-unsupported","Geolocation unsupported."),e}()&&function(){const e=window.isSecureContext;return e||a.warn("insecure-context","Geolocation requires a secure origin."),e}()}function g(e){return e||(e=m),new Promise(((o,r)=>{setTimeout((()=>r(new t("geolocation:timeout","getting the current geolocation position timed out"))),15e3),navigator.geolocation.getCurrentPosition(o,r,e??void 0)}))}function p(o,r){const{position:a,view:m}=o,l=function(e){const t=e&&e.coords||{},o={accuracy:t.accuracy,altitude:t.altitude,altitudeAccuracy:t.altitudeAccuracy,heading:t.heading,latitude:t.latitude,longitude:t.longitude,speed:t.speed};return e?{coords:o,timestamp:e.timestamp}:e}(a),g=l?.coords;if(!g)throw new t("geometry-service:no-coords","Geolocation has no coordinates");return function(o,r,i){if(!r)return Promise.resolve(o);const a=r.spatialReference;return a.isWGS84?Promise.resolve(o):a.isWebMercator?Promise.resolve(n(o)):function(t){if(e.geometryServiceUrl)return Promise.resolve(e.geometryServiceUrl);const o=s.getDefault();return o.load(t).catch((()=>{})).then((()=>o.get("helperServices.geometry.url")))}(i).then((e=>{if(!e)throw new t("geometry-service:missing-url","Geometry service URL is missing");const r=new u({geometries:[o],outSpatialReference:a});return c(e,r,i).then((e=>e[0]))}))}(function({longitude:e,latitude:t,altitude:o}){return new i({longitude:e,latitude:t,z:o||void 0,spatialReference:{wkid:4326}})}(g),m,r)}export{g,p,l as s};

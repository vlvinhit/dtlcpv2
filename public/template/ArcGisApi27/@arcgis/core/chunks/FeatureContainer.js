/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{createResolver as e}from"../core/promiseUtils.js";import{Q as t}from"./Queue.js";import{A as s}from"./AttributeStoreView.js";import{T as i}from"./TileContainer.js";import{a}from"./screenUtils.js";import{g as r}from"./unitUtils.js";import{m as o}from"./lengthUtils.js";import{F as n,i as l}from"./color.js";import{T as u,g as v}from"./WGLContainer.js";import{g as h}from"./capabilities2.js";function c(e,t){const s=t.length;if(e<t[0].value||1===s)return t[0].size;for(let i=1;i<s;i++)if(e<t[i].value){const s=(e-t[i-1].value)/(t[i].value-t[i-1].value);return t[i-1].size+s*(t[i].size-t[i-1].size)}return t[s-1].size}class m{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=u}getSizeVVFieldStops(e){const t=this._vvSizeFieldStops;if(t)switch(t.type){case"static":return t;case"level-dependent":return t.levels[e]??(()=>{let s=1/0,i=0;for(const a in t.levels){const t=parseFloat(a),r=Math.abs(e-t);r<s&&(s=r,i=t)}if(s===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const a=2**((e-i)/2),r=t.levels[i],o=new Float32Array(r.values);return o[2]*=a,o[3]*=a,{sizes:r.sizes,values:o}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){null!=this._vvInfo&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,s){this._updateEffects(s),this._vvInfo=t,this._technique=v(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:h("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){this.outsideLabelsVisible=null!=e&&e.excludedLabelsVisible}_updateVisualVariables(e,t){const s=this._vvMaterialParameters;if(s.vvOpacityEnabled=!1,s.vvSizeEnabled=!1,s.vvColorEnabled=!1,s.vvRotationEnabled=!1,!e)return;const i=e.size;if(i){if(s.vvSizeEnabled=!0,i.minMaxValue){const e=i.minMaxValue;let s,r;if(n(e.minSize)&&n(e.maxSize))if(l(e.minSize)&&l(e.maxSize))s=a(e.minSize),r=a(e.maxSize);else{const i=t.scale;s=a(c(i,e.minSize.stops)),r=a(c(i,e.maxSize.stops))}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,s,r])}if(i.scaleStops&&(this.vvSizeScaleStopsValue=a(c(t.scale,i.scaleStops.stops))),i.unitValue){const e=r(t.spatialReference)/o[i.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/t.resolution}i.fieldStops&&(this._vvSizeFieldStops=i.fieldStops)}const u=e.color;u&&(s.vvColorEnabled=!0,this.vvColorValues.set(u.values),this.vvColors.set(u.colors));const v=e.opacity;v&&(s.vvOpacityEnabled=!0,this.vvOpacityValues.set(v.values),this.vvOpacities.set(v.opacities));const h=e.rotation;h&&(s.vvRotationEnabled=!0,s.vvRotationType=h.type)}}class p extends i{constructor(e){super(e),this._rendererInfo=new m,this._materialItemsRequestQueue=new t,this.attributeView=new s((()=>this.onAttributeStoreUpdate()))}destroy(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(e,t,s){this._rendererInfo.setInfo(e,t,s),this.requestRender()}async getMaterialItems(t,s){if(!t||0===t.length)return[];const i=e();return this._materialItemsRequestQueue.push({items:t,abortOptions:s,resolver:i}),this.requestRender(),i.promise}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop()}super.doRender(e)}renderChildren(e){for(const t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e)}updateTransforms(e){if(this.children.some((e=>e.hasData)))for(const t of this.children)t.setTransform(e)}createRenderParams(e){const t=super.createRenderParams(e);return t.rendererInfo=this._rendererInfo,t.attributeView=this.attributeView,t}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:s,resolver:i}){const{painter:a,pixelRatio:r}=e,o=t.map((e=>a.textureManager.rasterizeItem(e.symbol,r,e.glyphIds,s)));Promise.all(o).then((e=>{if(!this.stage)return void i.reject();const s=e.map(((e,s)=>({id:t[s].id,mosaicItem:e})));i.resolve(s)}),i.reject)}}export{p as F};

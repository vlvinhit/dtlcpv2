/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import{symbolTypesRenderer as e}from"../symbols.js";import r from"../core/Error.js";import{J as s}from"./jsonMap.js";import{parseWhereClause as n}from"../core/sql.js";import{c as a}from"../core/accessorSupport/decorators/subclass.js";import{g as o}from"./layerUtils.js";import i from"../renderers/SimpleRenderer.js";import u from"../renderers/UniqueValueRenderer.js";import c from"../rest/support/AttachmentQuery.js";import p from"../rest/support/Query.js";import l from"../rest/support/RelationshipQuery.js";const d=new s({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function y(t,e,s,n){const a=await C(t);if(await f(t,e,n),!a.addAttachment)throw new r(n,"Layer source does not support addAttachment capability");return a.addAttachment(e,s)}function f(t,e,s){const{attributes:n}=e,{objectIdField:a}=t;return t.get("capabilities.data.supportsAttachment")?e?n?a&&n[a]?Promise.resolve():Promise.reject(new r(s,`feature is missing the identifying attribute ${a}`)):Promise.reject(new r(s,"'attributes' are required on a feature to query attachments")):Promise.reject(new r(s,"A feature is required to add/delete/update attachments")):Promise.reject(new r(s,"this layer doesn't support attachments"))}async function m(t,e,s,n,a){const o=await C(t);if(await f(t,e,a),!o.updateAttachment)throw new r(a,"Layer source does not support updateAttachment capability");return o.updateAttachment(e,s,n)}async function h(t,e,r){const{applyEdits:s}=await import("./editingSupport.js"),n=await t.load();return s(n,n.source,e,r)}async function w(t,e,r){const{uploadAssets:s}=await import("./editingSupport.js"),n=await t.load();return s(n,n.source,e,r)}async function b(t,e,s,n){const a=await C(t);if(await f(t,e,n),!a.deleteAttachments)throw new r(n,"Layer source does not support deleteAttachments capability");return a.deleteAttachments(e,s)}async function g(t,e,s){const n=(await t.load({signal:e?.signal})).source;if(!n.fetchRecomputedExtents)throw new r(s,"Layer source does not support fetchUpdates capability");return n.fetchRecomputedExtents(e)}async function j(t,e,s,n){e=c.from(e),await t.load();const a=t.source,o=t.capabilities;if(!o?.data?.supportsAttachment)throw new r(n,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:p,num:l,size:d,start:y,where:f}=e;if(!o?.operations?.supportsQueryAttachments&&(i?.length>0||p?.length>0||d?.length>0||l||y||f))throw new r(n,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(u?.length||p?.length||f))throw new r(n,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!a.queryAttachments)throw new r(n,"Layer source does not support queryAttachments capability",e);return a.queryAttachments(e)}async function q(t,e,s,n){const a=await C(t);if(!a.queryObjectIds)throw new r(n,"Layer source does not support queryObjectIds capability");return a.queryObjectIds(p.from(e)??t.createQuery(),s)}async function F(t,e,s,n){const a=await C(t);if(!a.queryFeatureCount)throw new r(n,"Layer source does not support queryFeatureCount capability");return a.queryFeatureCount(p.from(e)??t.createQuery(),s)}async function I(t,e,s,n){const a=await C(t);if(!a.queryExtent)throw new r(n,"Layer source does not support queryExtent capability");return a.queryExtent(p.from(e)??t.createQuery(),s)}async function P(t,e,s,n){const a=await C(t);if(!a.queryRelatedFeatures)throw new r(n,"Layer source does not support queryRelatedFeatures capability");return a.queryRelatedFeatures(l.from(e),s)}async function A(t,e,s,n){const a=await C(t);if(!a.queryRelatedFeaturesCount)throw new r(n,"Layer source does not support queryRelatedFeaturesCount capability");return a.queryRelatedFeaturesCount(l.from(e),s)}async function O(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:s}=await e.refresh();if(null!=s&&(t.sourceJSON={...t.sourceJSON,...s},t.read(s,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await n(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function E(t){const e=new p,r=t.get("capabilities.data"),s=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,s&&(e.compactGeometryEnabled=s.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=s.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:n,timeExtent:a}=t;return e.timeExtent=null!=n&&null!=a?a.offset(-n.value,n.unit):a||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function S(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeGlobalID"===t.type)return t.name}function R(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeOID"===t.type)return t.name}function x(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function C(t){return(await t.load()).source}async function L(e,r){const s=e.parsedUrl?.path;s&&function(t){const e=t.editFieldsInfo;return!(!e?.creatorField&&!e?.editorField)||(t.userHasUpdateItemPrivileges?t.hasUpdateItemRestrictions:!!t.userHasFullEditingPrivileges&&t.hasFullEditingRestrictions)}(e)&&await async function(e,r){if(!t)return;if(t.findCredential(e))return;let s;try{const n=await o(e,r);n&&(s=await t.checkSignInStatus(`${n}/sharing`))}catch(t){}if(s)try{const s=null!=r?r.signal:null;await t.getCredential(e,{signal:s})}catch(t){}}(s,r)}function M(t){return!t.sourceJSON?.isMultiServicesView&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const G=a({types:e});function Q(t,e){if(t.defaultSymbol)return t.types&&t.types.length?new u({defaultSymbol:G(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map((t=>({id:t.id,symbol:G(t.symbol,t,e)})))}):new i({symbol:G(t.defaultSymbol,t,e)})}export{R as a,Q as b,M as c,y as d,L as e,h as f,w as g,E as h,b as i,g as j,q as k,F as l,I as m,P as n,A as o,O as p,j as q,S as r,d as s,x as t,m as u};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../symbols.js";import"./typedArrayUtil.js";import t from"../core/Error.js";import{f as n,c as i}from"./date.js";import{r as s}from"./numberUtils.js";import{a as o}from"./PointSizeSplatAlgorithm.js";import{a as l}from"./scaleUtils.js";import a from"../renderers/visualVariables/SizeVariable.js";import{s as r}from"./spatialStatistics.js";import{v as u}from"./binningUtils.js";import{b as m,f as c,c as f,g as d}from"./layerUtils2.js";import p from"../smartMapping/statistics/classBreaks.js";import y from"../smartMapping/statistics/summaryStatistics.js";import{d as w,e as h,f as g}from"./utils12.js";import b from"../symbols/edges/SketchEdges3D.js";import v from"../symbols/edges/SolidEdges3D.js";import{getBackgroundColorTheme as j}from"../views/support/colorUtils.js";import S from"../symbols/MeshSymbol3D.js";import D from"../symbols/FillSymbol3DLayer.js";import z from"../symbols/SimpleFillSymbol.js";import x from"../symbols/PolygonSymbol3D.js";import V from"../symbols/ExtrudeSymbol3DLayer.js";import U from"../symbols/SimpleLineSymbol.js";import L from"../symbols/LineSymbol3D.js";import k from"../symbols/LineSymbol3DLayer.js";import T from"../symbols/PathSymbol3DLayer.js";import B from"../symbols/SimpleMarkerSymbol.js";import F from"../symbols/PointSymbol3D.js";import M from"../symbols/IconSymbol3DLayer.js";import I from"../symbols/ObjectSymbol3DLayer.js";const A=[{size:10,width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}];async function C(e){const{layerAdapter:n,...i}=await async function(e){const{view:n}=e;if(!(e&&n&&e.layer))throw new t("outline:missing-parameters","'view' and 'layer' parameters are required");e.forBinning&&u(e,"outline");const{layer:i,...s}=e,o=e.forBinning?m:c,l=f(i,o,e.forBinning);if(!l)throw new t("outline:invalid-parameters","'layer' must be one of these types: "+d(o).join(", "));const a={layerAdapter:l,...s,view:n};await n.when();const r=null!=a.signal?{signal:a.signal}:null;if(await l.load(r),"polygon"!==l.geometryType)throw new t("outline:not-supported",`outline is not supported for geometryType: ${l.geometryType}`);return a}(e),s=await n.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...i});if(!s?.length)throw new t("outline:insufficient-info","No features are available to calculate statistics");const o=await r({features:s,geometryType:n.geometryType});if(!(o&&"avgSize"in o&&o.avgSize))throw new t("outline:insufficient-info","average polygon size is invalid");return function(e,t){const n=e.avgSize,i=l(1,t.spatialReference),s=A.map((e=>({size:e.width,value:Math.round(n/e.size*i)})));return s.sort(((e,t)=>e.value-t.value)),{visualVariables:[new a({target:"outline",valueExpression:"$view.scale",stops:s})],opacity:.25}}({...o,avgSize:o.avgSize},i.view)}const E=/^(\d+(\.\d+)?)\s*(%)$/i,P=[0,0,0,.4],R=["hours","minutes","seconds"],q=[...w.light,...w.dark];function Y(e,t,s){if("string"==typeof e){const t=s.getField(e);if(t&&"date"===t.type)return t.alias||t.name}else if("number"==typeof e||e instanceof Date){const s=null!=t&&R.includes(t)?"short-date-short-time":"short-date";return n(e,i(s))}return e}function $(e,t,n){return e+t>0&&0>e-t&&n<0?0:e}function N(e,t,n,i,s){const o="90-10"===n&&t?{min:t.classBreakInfos[0].maxValue,max:t.classBreakInfos[t.classBreakInfos.length-1].minValue,avg:null,stddev:null}:e,{avg:l,stddev:a,min:r,max:u}=o,m=W(o,!!i,s??!0);let c=m?m[0]:r,f=m?m[1]:u;return m?{minDataValue:c,maxDataValue:f,defaultValuesUsed:!0}:("above"===n?c=$(l,a,r):"below"===n&&(f=$(l,a,r)),{minDataValue:c,maxDataValue:f,defaultValuesUsed:!1})}function W(e,t,n){let i,s;const o=function(e){let t,n,i=e&&e.statistics;if(i||(i={}),null==i.min)if(e.isDate){const e=G();t=e[0],n=e[1]}else t=0,n=100;else if(i.min===i.max)if(e.isDate){const e=G(i.min);t=e[0],n=e[1]}else i.min<0?(t=2*i.min,n=0):i.min>0?(t=0,n=2*i.min):(t=0,n=100);return{min:null!=t?t:i.min,max:null!=n?n:i.max,defaultValuesUsed:null!=t||null!=n}}({statistics:e,isDate:t});return o.defaultValuesUsed?(i=o.min,s=o.max):!n||null!=e.avg&&e.stddev||(i=e.min,s=e.max),null!=i&&null!=s?[i,s]:null}function G(e){const t=("number"==typeof e?new Date(e):new Date).getUTCFullYear();let n=Date.UTC(t,0,1,12,0,0,0),i=Date.UTC(t,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>i&&(i=e)),[n,i]}function O(t,n){const i=[],s=t.length;for(let o=0;o<n;o++)i.push(new e(t[o%s]));return i}function H({minDataValue:e,maxDataValue:t,defaultValuesUsed:n},i,s,o=!0){return n||"above"===s||"below"===s||"90-10"===s?Q(e,t,5):X(i,o)}function J(e,t){const{avg:n,stddev:i}=e,o=e.min,l=e.max;if(null==n||null==i){const[n,i]=W(e,t,!0);return Q(n,i,5)}const a=$(n,i,o),r=l-a,u=a-o,m=Math.max(r,u);return s([a-m,a-m/2,a,m/2+a,a+m],{strictBounds:!0})}function K(e,t){const{min:n,max:i}=t,[o,l,a,r,u]=e,m=null!=n&&o<n,c=null!=i&&u>i;if(null==n||null==i||!m&&!c)return e;const f=m?n:o,d=c?i:u;return s([f,m?f+(a-f)/2:l,a,c?a+(d-a)/2:r,d],{strictBounds:!0})}function Q(e,t,n){const i=(t-e)/(n-1),o=[e];for(let t=1;t<=n-2;t++)o.push(e+t*i);return o.push(t),s(o,{strictBounds:!0})}function X({min:e,max:t,avg:n,stddev:i},o=!0){if(null==e||null==t||null==n||null==i)return[];let l=n-i,a=n+i;l<e&&(l=e),a>t&&(a=t),o&&(n=l+(a-l)/2);let r=s([l,a],{strictBounds:!0});return l=r[0],a=r[1],r=[l,l+(n-l)/2,n,n+(a-n)/2,a],s(r,{strictBounds:!0})}function Z(e,t,n){switch(t){case"point":case"multipoint":return n?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return n?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;default:return}}function _(e,t,n){switch(t){case"point":case"multipoint":case"polygon":{if(!("outline"in e))return null;const t={color:e.outline.color,width:e.outline.width};if(null!=n&&t.color){const e=t.color.clone();e.a=n,t.color=e}return t}default:return}}function ee(e,t){const{type:n,size:i,color:s,outline:o}=t;let l;switch(e){case"point":case"multipoint":if("2d"===n)l=new B({color:s,size:i,outline:{color:o.color,width:o.width}});else if("3d-flat"===n)l=new F({symbolLayers:[new M({size:i,resource:{primitive:"circle"},material:{color:s},outline:{color:o.color,size:o.width}})]});else if(n?.includes("3d-volumetric")){const e="3d-volumetric-uniform"===n,o=new I({height:i,resource:{primitive:e?"sphere":"cylinder"},material:{color:s}});e||(o.width=t.widthAndDepth,o.depth=t.widthAndDepth),l=new F({symbolLayers:[o]})}break;case"polyline":"2d"===n?l=new U({color:s,width:i}):"3d-flat"===n?l=new L({symbolLayers:[new k({size:i,material:{color:s}})]}):"3d-volumetric"===n&&(l=new L({symbolLayers:[new T({width:"number"==typeof i?i:parseFloat(i),height:"number"==typeof i?i:parseFloat(i),material:{color:s}})]}));break;case"polygon":"2d"===n?l=new z({color:s,outline:{color:o.color,width:o.width}}):"3d-flat"===n?l=new x({symbolLayers:[new D({material:{color:s},outline:{color:o.color,size:o.width}})]}):"3d-volumetric"===n&&(l=new x({symbolLayers:[new V({size:i,material:{color:s}})]}));break;case"mesh":{const e=t.meshInfo?.colorMixMode,n=t.meshInfo?.edgesType;l=new S({symbolLayers:[new D({material:{color:s,colorMixMode:e||null},edges:"solid"===n?new v({color:P}):"sketch"===n?new b({color:P}):null})]});break}}return l}function te(e,n,i){const s=function(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}({layer:e,fields:n});if(s.length)return new t(i,"Unknown fields: "+s.join(", ")+". You can only use fields defined in the layer schema");const o=function(e){const t=e.layer;return e.fields.filter((e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsRenderer}))}({layer:e,fields:n});return o.length?new t(i,"Unsupported fields: "+o.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}async function ne(e,t){const n={layer:e.layer,view:e.view,signal:e.signal},[i,s]=await Promise.all([p(e).catch(ue),t?C(n).catch(ue):null]),o=W({min:i?.minValue,max:i?.maxValue,avg:null,stddev:null},!1,!1);return{result:o?await p({...e,classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:o[0],maxValue:o[1],normalizationTotal:o[0]+o[1]}):i,defaultValuesUsed:!!o,outlineResult:s}}function ie(e){return y(e)}function se(e,t){let{minSize:n,maxSize:i}=e;return"height"===t&&(n=((i-n)/2+n)/4.6,i*=2),{minSize:n,maxSize:i}}function oe(e){return E.test(e)}function le(e){if(null==e)return;const t=e.match(E),n=Number(t[1]);return"%"===t[3]?new o({scaleFactor:n/100}):void 0}function ae(e,t,n,i){e.startTime=t instanceof Date?t.getTime():t,e.endTime=n instanceof Date?n.getTime():n,e.units=i,e.field="string"==typeof t?t:"string"==typeof n?n:null}async function re(e,t){let n=null,i=null;if(!e&&!t)return{basemapId:n,basemapTheme:i};if(!e&&t&&(e=t&&t.map?.basemap),e&&(n=h(e,q,!1),n)){const e=g(n);null!=e&&(i=e)}return n||"2d"!==t?.type||(i=await j(t),null!=i&&(n="dark"===i?"dark-gray":"gray")),{basemapId:n,basemapTheme:i}}function ue(e){const t=e.name?.toLowerCase();if(!t||t?.includes(":insufficient-info")||t?.includes(":insufficient-data"))return null;throw e}export{O as a,re as b,H as c,ie as d,ne as e,ue as f,N as g,le as h,Y as i,oe as j,W as k,Q as l,X as m,ee as n,C as o,Z as p,_ as q,se as r,J as s,K as t,ae as u,te as v};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import"../geometry.js";import e from"../analysis/SlicePlane.js";import{h as r}from"./typedArrayUtil.js";import{L as s}from"./Logger.js";import{d as o,r as i}from"./mathUtils.js";import{f as n}from"./screenUtils.js";import{y as a,g as c,m as l,o as d,r as u,i as g,n as m,z as p}from"./mat4.js";import{c as f}from"./mat4f64.js";import{r as h}from"./quat.js";import{c as b,l as _,s as T,a as C,e as O,b as w,n as A,i as I,f as R,D as E}from"./vec3.js";import{c as j,e as S,f as v}from"./vec3f64.js";import{tryProjectWithZConversion as P}from"../geometry/projection.js";import{b as U,A as L}from"./vector.js";import{f as M,i as N,c as V,r as y,n as k,u as G}from"./boundedPlane.js";import{f as W,j as x}from"./plane.js";import{c as H,s as B,d as F,k as D}from"./ray.js";import{g as q,a as X}from"./analysisThemeUtils.js";import{O as z,L as Y,a as Z}from"./LineVisualElement.js";import{b as $,M as J,R as K,w as Q,d as tt}from"./manipulatorUtils.js";import{c as et}from"./vec4.js";import{f as rt}from"./vec4f64.js";import{d as st,c as ot,e as it,f as nt}from"./GeometryUtil.js";import{D as at,R as ct}from"./Material.js";import{S as lt}from"./ShaderOutput.js";import{S as dt}from"./ShaderTechniqueConfiguration.js";import{D as ut,G as gt}from"./DefaultBufferWriter.js";import{R as mt}from"./RenderSlot.js";import{T as pt,P as ft,R as ht}from"./TriangleMaterial.js";import{g as bt,N as _t}from"./interfaces2.js";import{R as Tt,S as Ct,P as Ot}from"./Program2.js";import{a as wt}from"./View.glsl.js";import{F as At}from"./Float4PassUniform.js";import{F as It}from"./FloatPassUniform.js";import{S as Rt}from"./ShaderBuilder.js";import{V as Et}from"./VertexAttribute.js";import{f as jt,g as St}from"./enums3.js";import{m as vt,s as Pt,a as Ut}from"./renderState.js";import{R as Lt}from"./RenderCoordsHelper.js";import{a as Mt}from"./ray2.js";import{C as Nt}from"./basicInterfaces.js";import{C as Vt}from"./ColorMaterial.js";import{N as yt}from"./NativeLineMaterial.js";import{M as kt,a as Gt}from"./interfaces4.js";class Wt{constructor(){this.color=q()}}class xt{constructor(){this.color=new t([0,0,0,.04]),this.gridColor=q(.5),this.outlineColor=q(.7)}}class Ht{constructor(){this.color=q()}}class Bt{constructor(){this.color=q(.5),this.contrastColor=X()}}class Ft{constructor(){this.color=X(),this.outlineColor=q()}}let Dt=new class{constructor(){this.callouts=new Wt,this.plane=new xt,this.resizeManipulators=new Ht,this.rotateManipulators=new Bt,this.shiftManipulator=new Ft}};const qt=r("mac")?"Meta":"Control",Xt="Shift",zt=2500,Yt=.02,Zt=Math.cos(o(45)),$t=Math.cos(o(5)),Jt=.95,Kt=.3,Qt=2,te=1,ee=22.5,re=.3,se=Object.freeze(Object.defineProperty({__proto__:null,build:function(t){const e=new Rt,{vertex:r,fragment:s,attributes:o,varyings:i}=e;return wt(r,t),o.add(Et.POSITION,"vec3"),o.add(Et.UV0,"vec2"),i.add("vUV","vec2"),r.code.add(bt`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),s.uniforms.add(new At("backgroundColor",(t=>t.backgroundColor)),new At("gridColor",(t=>t.gridColor)),new It("gridWidth",(t=>t.gridWidth))),s.code.add(bt`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}},Symbol.toStringTag,{value:"Module"}));class oe extends _t{constructor(){super(...arguments),this.backgroundColor=rt(1,0,0,.5),this.gridColor=rt(0,1,0,.5),this.gridWidth=4}}class ie extends Ct{initializeProgram(t){return new Ot(t.rctx,ie.shader.get().build(this.configuration),at)}initializePipeline(){return vt({blending:Pt(jt.ONE,jt.ONE,jt.ONE_MINUS_SRC_ALPHA,jt.ONE_MINUS_SRC_ALPHA),depthTest:{func:St.LESS},colorWrite:Ut})}}ie.shader=new Tt(se,(()=>Promise.resolve().then((()=>se))));class ne extends pt{constructor(t){super(t,new ce),this._configuration=new dt}createBufferWriter(){return new ut(ft)}requiresSlot(t,e){return e===lt.Color&&t===mt.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return new ae(t)}getConfiguration(){return this._configuration}}class ae extends gt{constructor(t){super(t),this.ensureTechnique(ie,null)}beginSlot(){return this.technique}}class ce extends oe{constructor(){super(...arguments),this.renderOccluded=ct.Occlude}}class le extends z{constructor(t){super(t),this._material=null,this._renderOccluded=ct.OccludeAndTransparent,this._gridWidth=1,this._gridColor=rt(1,0,0,1),this._backgroundColor=rt(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){et(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){et(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new ne(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){null!=this._material&&t(this._material)}createGeometries(t){if(null!=this._material){const e=st(this._material);t.addGeometry(e)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){null!=this._material&&this._material.setParameters(this._materialParameters)}}function de(t,e,r,s,o,i,n,a){return function(t,e,r,s,o,i){const n=I(t,e),a=B.get(),c=B.get();switch(s===ke.HORIZONTAL_OR_VERTICAL?Math.abs(n)>Zt?ke.HORIZONTAL:ke.VERTICAL:s){case ke.VERTICAL:{const s=Math.abs(n)<=$t?t:r.viewUp;R(a,s,e),b(c,e);break}case ke.HORIZONTAL:R(a,r.viewUp,e),R(c,e,a);break;case ke.TILTED:{const s=Math.abs(n)<=$t?e:r.viewUp;R(a,s,t),R(c,t,a);break}}const l=R(B.get(),a,c);I(l,r.viewForward)>0&&O(c,c,-1),A(o,a),A(i,c)}(e,n.worldUpAtPosition(t,B.get()),o,i,a.basis1,a.basis2),O(a.basis1,a.basis1,r),O(a.basis2,a.basis2,s),b(a.origin,t),x(a.basis2,a.basis1,a.origin,a.plane),a}function ue(t,e,r,s,o,i){const n=b(B.get(),o.origin);C(n,n,O(B.get(),o.basis1,t.direction[0]<0?1:-1)),C(n,n,O(B.get(),o.basis2,t.direction[1]<0?1:-1));const a=_(o.basis1),c=_(o.basis2),l=w(B.get(),r,n),d=w(B.get(),e,n);let u=0,g=0;if(Re(t)){const e=Ie(o),r=Ie(i);u=a-.5*t.direction[0]*I(o.basis1,d)/a,g=c-.5*t.direction[1]*I(o.basis2,d)/c;const s=r/e;u*=s,g*=s}const m=u+.5*t.direction[0]*I(o.basis1,l)/a,p=g+.5*t.direction[1]*I(o.basis2,l)/c,f=O(B.get(),o.basis1,m/a),h=O(B.get(),o.basis2,p/c);(m<=0||we(i.origin,f,s)<=1600)&&b(f,i.basis1),(p<=0||we(i.origin,h,s)<=1600)&&b(h,i.basis2);const T=b(B.get(),n);return C(T,T,O(B.get(),f,t.direction[0]<0?-1:1)),C(T,T,O(B.get(),h,t.direction[1]<0?-1:1)),M(T,f,h,i)}function ge(t,e){return.4*Math.min(e.width,e.height)*e.computeRenderPixelSizeAt(t)}function me(t,e,r,s){const o=R(B.get(),e,r);return R(o,o,e),W(t,o,s)}function pe(t,e){return $(t.basis1,t.basis2,t.origin,e)}function fe(t,e,r,s){const o=e.worldUpAtPosition(t.origin,B.get()),i=B.get();switch(r){case ye.HEADING:b(i,o);break;case ye.TILT:b(i,t.basis1)}return W(t.origin,i,s)}function he(t,e,r,s){const o=Oe(r,Ce.NEGATIVE_X),i=F.get();u(i,e,o.edge*Math.PI/2);const a=A(B.get(),o.basis);let c=O(B.get(),a,o.direction*s.computeScreenPixelSizeAt(o.position)*40);C(c,c,o.position);const l=s.projectToRenderScreen(c,n(B.get())),d=function(t,e){const[r,s,o,i]=t.viewport,n=Math.min(o,i)/16;let a=!0;return e[0]<r+n?(e[0]=r+n,a=!1):e[0]>r+o-n&&(e[0]=r+o-n,a=!1),e[1]<s+n?(e[1]=s+n,a=!1):e[1]>s+i-n&&(e[1]=s+i-n,a=!1),a}(s,l);Mt(s,l,We),A(We.direction,We.direction);const g=B.get();!d&&N(r,We,g)&&(c=g),i[12]=0,i[13]=0,i[14]=0,t.modelTransform=i,t.renderLocation=S(c),d?t.state|=Ge:t.state&=~Ge}function be(t,e,r,s){const o=_(s.basis1),i=_(s.basis2),n=Ae(s),d=Ie(s),u=T(B.get(),0,0,0);C(u,O(B.get(),s.basis1,e.direction[0]),O(B.get(),s.basis2,e.direction[1])),C(u,s.origin,u);let g=0,m=1;if(Re(e))1===e.direction[0]&&-1===e.direction[1]?g=xe:1===e.direction[0]&&1===e.direction[1]?g=Math.PI:-1===e.direction[0]&&1===e.direction[1]&&(g=3*Math.PI/2),m=d;else{const t=0!==e.direction[0]?1:2;g=1===t?xe:0,m=(1===t?i:o)-n}const p=a(F.get(),g);c(p,p,T(B.get(),m,m,m)),l(p,r,p),p[12]=0,p[13]=0,p[14]=0,t.modelTransform=p,t.renderLocation=u}function _e(t,e,r,s){const o=s.worldUpAtPosition(r.origin,B.get()),i=Oe(r,Ce.POSITIVE_X),n=a(F.get(),i.edge*Math.PI/2);d(n,n,-Le(r,o)),l(n,e,n),n[12]=0,n[13]=0,n[14]=0,t.modelTransform=n,t.renderLocation=i.position}function Te(t,e,r){const s=Oe(r,Ce.POSITIVE_Y),o=a(F.get(),s.edge*Math.PI/2);d(o,o,xe),l(o,e,o),o[12]=0,o[13]=0,o[14]=0,t.modelTransform=o,t.renderLocation=s.position}var Ce;function Oe(t,e){switch(e){case Ce.POSITIVE_X:return{basis:t.basis1,direction:1,position:C(B.get(),t.origin,t.basis1),edge:e};case Ce.POSITIVE_Y:return{basis:t.basis2,direction:1,position:C(B.get(),t.origin,t.basis2),edge:e};case Ce.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:w(B.get(),t.origin,t.basis1),edge:e};case Ce.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:w(B.get(),t.origin,t.basis2),edge:e}}}function we(t,e,r){const s=r.projectToRenderScreen(C(B.get(),t,e),n(B.get())),o=r.projectToRenderScreen(w(B.get(),t,e),n(B.get()));return E(w(s,s,o))}function Ae(t){const e=_(t.basis1),r=_(t.basis2);return re*Math.min(e,r)}function Ie(t){return Ae(t)}function Re(t){return 0!==t.direction[0]&&0!==t.direction[1]}function Ee(e,r){const s=r.offsetMode===Fe.CENTER_ON_CALLOUT?40:0,o=[v(s,0,-24),v(s,0,24)],i=function(t,e){const r=w(j(),t[t.length-1],t[t.length-2]);A(r,r),O(r,r,ee),C(r,r,t[t.length-1]);{const e=w(j(),t[0],t[1]);return A(e,e),O(e,e,ee),C(e,e,t[0]),[e,...t,r]}}(o),n=(e,s)=>function(e,r,s,o){const i=t.blendColors(o.color,o.outlineColor,.4),n=t.blendColors(o.color,o.outlineColor,.14),a=new Vt({color:t.toUnitRGBA(o.color),cullFace:Nt.Back,renderOccluded:ct.Opaque}),d=new Vt({color:t.toUnitRGBA(i),cullFace:Nt.Back,renderOccluded:ct.Opaque}),u=new Vt({color:t.toUnitRGBA(n),cullFace:Nt.Back,renderOccluded:ct.Opaque}),b=new Vt({color:t.toUnitRGBA(o.outlineColor),transparent:!0,writeDepth:!1,cullFace:Nt.Front,renderOccluded:ct.Transparent}),_=t=>{const o=e.slice(0),i=w(B.get(),o[0],o[1]);A(i,i);const n=w(B.get(),o[o.length-1],o[o.length-2]);if(A(n,n),r>0){const t=O(j(),n,-r);o[o.length-1]=C(t,t,o[o.length-1]);const e=O(j(),i,-r);o[0]=C(e,e,o[0])}const _=t?1.15:1,I=ee*_,R=11*_,E=g(F.get());if(r>0){const t=I/4,e=T(B.get(),0,t,0),s=1+r/t;m(E,E,e),c(E,E,T(B.get(),s,s,s)),m(E,E,O(e,e,-1/s))}const S=g(f()),P=v(0,1,0),U=p(f(),h(D.get(),P,n));U[12]=o[o.length-1][0],U[13]=o[o.length-1][1],U[14]=o[o.length-1][2],l(U,U,E);const L=function(t,e,r){const s=[];for(let e=0;e<12;e++){const r=e/12*2*Math.PI;s.push([Math.cos(r)*t,Math.sin(r)*t])}return nt(r,s,e,[],[],!1)}(3*(t?1.15:1)+r,o,s?b:u);L.transformation=S;const M=[L],N=it(s?b:a,I,R,24,!1,!1,!0);N.transformation=U,M.push(N);const V=it(s?b:d,I,R,24,!1,!0,!1);V.transformation=U,M.push(V);const y=p(f(),h(D.get(),P,i));return y[12]=o[0][0],y[13]=o[0][1],y[14]=o[0][2],l(y,y,E),M.push(N.instantiate({transformation:y})),M.push(V.instantiate({transformation:y})),M};return{normal:_(!1),focused:_(!0)}}(o,e,s,r),a=n(0,!1),d=n(2.25,!0),u=new yt({color:t.toUnitRGBA(r.calloutColor),renderOccluded:ct.OccludeAndTransparent}),b=ot(u,[[s,0,0],[s-40,0,0]]),_=ot(u,[[s,0,0],[s-40,0,0]]);return new J({view:e,renderObjects:[...a.normal.map((t=>new K(t,Gt.Unfocused|Ve))),...d.normal.map((t=>new K(t,Gt.Unfocused|Ve))),new K(b,Gt.Unfocused|Ve|Ge),...a.focused.map((t=>new K(t,Gt.Focused|Ve))),...d.focused.map((t=>new K(t,Gt.Focused|Ve))),new K(_,Gt.Focused|Ve|Ge)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:11,state:Ve})}function je(e,r){const s=tt(e,{calloutColor:t.toUnitRGBA(Dt.callouts.color),customStateMask:Ve,texture:r});return s.state=Ve,s}function Se(e){return new Y({view:e,attached:!1,color:t.toUnitRGBA(Dt.plane.outlineColor),width:1,renderOccluded:ct.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function ve(e){return new le({view:e,attached:!1,backgroundColor:t.toUnitRGBA(Dt.plane.color),gridColor:t.toUnitRGBA(Dt.plane.gridColor),gridWidth:4,renderOccluded:ct.OccludeAndTransparent})}function Pe(e,r,s){const o=Re(r),i=o?[v(1,0,0),v(0,0,0),v(0,1,0)]:[v(1,0,0),v(-1,0,0)],n=t.toUnitRGBA(s.color),a=o?4:1,c=2*a,l=t=>t>1?(t=>new ht({color:n,width:t,renderOccluded:ct.OccludeAndTransparent}))(t):new yt({color:n,renderOccluded:ct.OccludeAndTransparent}),d=[new K(ot(l(a),i),Gt.Unfocused|He),new K(ot(l(c),i),Gt.Focused|He),new K(ot(l(1),i),Be)],u=new J({view:e,renderObjects:d,collisionType:{type:"line",paths:[i]},radius:o?6:4,...Q});return u.state=He,u}function Ue(t,r,s,o=new e){if(null==t)return null;const{renderCoordsHelper:n}=r,a=n.fromRenderCoords(t.origin,r.spatialReference);if(null==a)return null;const c=P(a,s);if(null==c)return null;o.position=c;const l=2*_(t.basis1),d=2*_(t.basis2),u=Lt.renderUnitScaleFactor(r.spatialReference,s);o.width=l*u,o.height=d*u;const g=n.worldUpAtPosition(t.origin,B.get());return o.tilt=i(Le(t,g)),o.heading=n.headingAtPosition(t.origin,t.basis1)-90,o}function Le(t,e){return U(e,t.basis2,t.basis1)+xe}function Me(t,e){if(null==t||null==t.position)return null;const r=Z(t.position,e.spatialReference,e.elevationProvider);if(null==r)return null;const s=Lt.renderUnitScaleFactor(t.position.spatialReference,e.spatialReference),o=t.width*s,i=t.height*s;return{position:r,heading:t.heading,tilt:t.tilt,renderWidth:o,renderHeight:i}}function Ne(t,e,r,i=V()){if(null==t)return null;const n=function(t,e,r,i,n,a,c=V()){return a.toRenderCoords(t,c.origin)?(a.worldBasisAtPosition(c.origin,L.X,c.basis1),a.worldBasisAtPosition(c.origin,L.Y,c.basis2),x(c.basis2,c.basis1,c.origin,c.plane),y(c,-o(e),k(c),c),y(c,o(r),c.basis1,c),O(c.basis1,c.basis1,i/2),O(c.basis2,c.basis2,n/2),G(c),c):(s.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${t.spatialReference.wkid} is not supported`),null)}(t.position,t.heading,t.tilt,t.renderWidth,t.renderHeight,e.renderCoordsHelper,i);return r.tiltEnabled||null==n||function(t,e,r){const s=e.worldUpAtPosition(t.origin,B.get()),o=t.basis1,i=Le(t,s),n=Math.round(i/xe)*xe;y(t,n-i,o,r)}(n,e.renderCoordsHelper,n),n}!function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"}(Ce||(Ce={}));const Ve=kt.Custom1;var ye,ke;!function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"}(ye||(ye={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(ke||(ke={}));const Ge=kt.Custom2,We=H(),xe=Math.PI/2,He=kt.Custom1,Be=kt.Custom2;var Fe;function De(t){return null!=("building-scene-3d"===t.type?t:null)}!function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(Fe||(Fe={}));export{Re as A,Ge as B,He as C,Ve as D,Be as E,Ie as F,Yt as I,Fe as O,zt as P,ye as R,ke as S,Ne as a,Ue as b,Ee as c,je as d,Pe as e,ve as f,Se as g,Qt as h,De as i,Xt as j,qt as k,fe as l,ge as m,de as n,pe as o,Me as p,_e as q,ue as r,Dt as s,Te as t,he as u,be as v,me as w,Jt as x,Kt as y,te as z};

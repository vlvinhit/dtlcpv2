/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{o as r}from"./ensureType.js";import{q as o,r as s}from"./mathUtils.js";import{n}from"./mat3.js";import{c as i}from"./mat3f64.js";import{f as a}from"./vec3f64.js";import{f as m}from"./vec4f64.js";import l,{M as p}from"../geometry/support/MeshComponent.js";import c from"../geometry/support/MeshMaterialMetallicRoughness.js";import u from"../geometry/support/MeshTexture.js";import f from"../geometry/support/MeshTextureTransform.js";import{c as j,b as g,t as d,p as y,B as x,s as T,a as h,e as b}from"./BufferView.js";import{c as v,b as M,d as w,e as A}from"./vec32.js";import{D as C,l as S,a as U,f as E,d as R,e as B,g as O,h as P,i as $,j as D,k as G,m as V,C as q}from"./DefaultMaterial_COLOR_GAMMA.js";import{e as I}from"./types.js";import"./typedArrayUtil.js";import{a as L}from"./georeference.js";import{i as k}from"./resourceUtils2.js";import{T as F}from"./enums3.js";import"./colorUtils.js";import"./vec3.js";import"./common.js";import"./vec4.js";import"./Logger.js";import"../config.js";import"./object.js";import"../core/lang.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./maybe.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./imageUtils.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"../core/Clonable.js";import"./vec2.js";import"./asyncUtils.js";import"./mat4f64.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./quatf64.js";import"./compilerUtils.js";import"./Indices.js";import"./unitUtils.js";import"./jsonMap.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./spatialReferenceEllipsoidUtils.js";import"./DoubleArray.js";import"../geometry/support/MeshGeoreferencedRelativeVertexSpace.js";import"./enumeration.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../geometry/support/MeshTransform.js";import"./axisAngleDegrees.js";import"./projection.js";import"./basicInterfaces.js";function _(t,e){return new t(new ArrayBuffer(e*t.ElementCount*I(t.ElementType)))}async function z(o,n,i){const l={...i,useTransform:i?.useTransform??!0},d=new C(function(t){const r=t?.resolveFile;return r?{busy:!1,request:async(t,o,s)=>{const n=r(t),i="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(n,{responseType:i,signal:null!=s?s.signal:null})).data}}:null}(l)),y=(await S(d,n,l,!0)).model,T=y.lods.shift(),v=new Map,M=new Map;y.textures.forEach(((t,e)=>{return v.set(e,new u({data:(k((o=t).data),o.data),wrap:(r=o.parameters.wrap,{horizontal:K(r.s),vertical:K(r.t)})}));var r,o})),y.materials.forEach(((e,r)=>M.set(r,function(e,r){const o=new t((l=e.color,p=e.opacity,m(Q(l[0]),Q(l[1]),Q(l[2]),p))),n=e.emissiveFactor?new t(function(t){return a(Q(t[0]),Q(t[1]),Q(t[2]))}(e.emissiveFactor)):null,i=t=>t?new f({scale:t.scale?[t.scale[0],t.scale[1]]:[1,1],rotation:s(t.rotation??0),offset:t.offset?[t.offset[0],t.offset[1]]:[0,0]}):null;var l,p;return new c({color:o,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:n,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:J(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:i(e.colorTextureTransform),normalTextureTransform:i(e.normalTextureTransform),occlusionTextureTransform:i(e.occlusionTextureTransform),emissiveTextureTransform:i(e.emissiveTextureTransform),metallicRoughnessTextureTransform:i(e.metallicRoughnessTextureTransform)})}(e,v))));const w=function(t){let e=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,n=new Map,i=[];for(const m of t.parts){const{attributes:{position:t,normal:l,color:p,tangent:c,texCoord0:u}}=m,f=`\n      ${N(t,s)}/\n      ${N(l,s)}/\n      ${N(p,s)}/\n      ${N(c,s)}/\n      ${N(u,s)}/\n      ${a=m.transform,null!=a?a.toString():"-"}\n    `;let j=!1;const g=r(n,f,(()=>(j=!0,{start:e,length:t.count})));j&&(e+=t.count),l&&(o.normal=!0),p&&(o.color=!0),c&&(o.tangent=!0),u&&(o.texCoord0=!0),i.push({gltf:m,writeVertices:j,region:g})}var a;return{vertexAttributes:{position:_(h,e),normal:o.normal?_(x,e):null,tangent:o.tangent?_(j,e):null,color:o.color?_(g,e):null,texCoord0:o.texCoord0?_(b,e):null},parts:i,components:[]}}(T);for(const t of w.parts)H(w,t,M);const{position:A,normal:U,tangent:E,color:R,texCoord0:B}=w.vertexAttributes,O={position:A.typedBuffer,normal:null!=U?U.typedBuffer:null,tangent:null!=E?E.typedBuffer:null,uv:null!=B?B.typedBuffer:null,color:null!=R?R.typedBuffer:null},P=L(O,o,l);return{transform:P.transform,vertexSpace:P.vertexSpace,components:w.components,spatialReference:o.spatialReference,vertexAttributes:new p({position:P.vertexAttributes.position,normal:P.vertexAttributes.normal,tangent:P.vertexAttributes.tangent,color:O.color,uv:O.uv})}}function N(t,e){if(null==t)return"-";const o=t.typedBuffer;return`${r(e,o.buffer,(()=>e.size))}/${o.byteOffset}/${o.byteLength}`}function H(t,e,r){e.writeVertices&&function(t,e){const{position:r,normal:s,tangent:a,color:m,texCoord0:l}=t.vertexAttributes,p=e.region.start,{attributes:c,transform:u}=e.gltf,f=c.position.count;if(v(r.slice(p,f),c.position,u),null!=c.normal&&null!=s){const t=n(i(),u),e=s.slice(p,f);M(e,c.normal,t),o(t)&&w(e,e)}else null!=s&&E(s,0,0,1,{dstIndex:p,count:f});if(null!=c.tangent&&null!=a){const t=n(i(),u),e=a.slice(p,f);R(e,c.tangent,t),o(t)&&B(e,e)}else null!=a&&O(a,0,0,1,1,{dstIndex:p,count:f});if(null!=c.texCoord0&&null!=l?P(l.slice(p,f),c.texCoord0):null!=l&&$(l,0,0,{dstIndex:p,count:f}),null!=c.color&&null!=m){const t=c.color,e=m.slice(p,f);if(4===t.elementCount)t instanceof j?D(e,t,255):t instanceof g?G(e,t):t instanceof d&&D(e,t,1/256);else{O(e,255,255,255,255);const r=y.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof x?A(r,t,255):t instanceof y?V(r,t):t instanceof T&&A(r,t,1/256)}}else null!=m&&O(m.slice(p,f),255,255,255,255)}(t,e);const{indices:s,attributes:a,primitiveType:m,material:p}=e.gltf;let c=U(s||a.position.count,m);const u=e.region.start;if(u){const t=new Uint32Array(c);for(let e=0;e<c.length;e++)t[e]+=u;c=t}t.components.push(new l({faces:c,material:r.get(p),shading:a.normal?"source":"flat",trustSourceNormals:!0}))}function J(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function K(t){switch(t){case F.CLAMP_TO_EDGE:return"clamp";case F.MIRRORED_REPEAT:return"mirror";case F.REPEAT:return"repeat"}}function Q(t){return t**(1/q)*255}export{z as loadGLTFMesh};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import t from"../layers/Layer.js";import{b as r}from"./arcgisLayerUrl.js";import{a as o,f as s}from"./fetchService.js";import a from"../portal/Portal.js";import i from"../portal/PortalItem.js";import{c as p}from"./jsonContext.js";import{h as n}from"./portalItemUtils.js";import{l}from"./styleUtils2.js";import"../core/lang.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./tslib.es6.js";import"../geometry.js";import"./ensureType.js";import"../geometry/Extent.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./maybe.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"./persistableUrlUtils.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"./mat4.js";import"./pe.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./asyncUtils.js";async function m(t,r){const a=t.instance.portalItem;if(a&&a.id)return await a.load(r),function(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r?.type,expectedType:t.supportedTypes.join(", ")})}(t),async function(t,r){const a=t.instance,i=a.portalItem;if(!i)return;const{url:m,title:y}=i,f=p(i);if("group"===a.type)return a.read({title:y},f),async function(t,r){let a;const{portalItem:i}=t;if(!i)return;const p=i.type,l=r.layerModuleTypeMap,m=n(i,"Oriented Imagery Layer")??!1;switch(p){case"Feature Service":a=m?l.OrientedImageryLayer:l.FeatureLayer;break;case"Stream Service":a=l.StreamLayer;break;case"Scene Service":a=l.SceneLayer;break;case"Feature Collection":a=l.FeatureLayer;break;default:throw new e("portal:unsupported-item-type-as-group",`The item type '${p}' is not supported as a 'IGroupLayer'`)}let[y,f]=await Promise.all([a(),j(r)]),h=()=>y;if("Feature Service"===p){if(f=i.url?await d(f,i.url):{},b(f).length){const e=l.SubtypeGroupLayer,t=await e();h=e=>"SubtypeGroupLayer"===e.layerType?t:y}const e=await async function(e){const{layersJSON:t}=await s(e);if(!t)return null;const r=[...t.layers,...t.tables];return e=>r.find((t=>t.id===e.id))}(i.url);return u(t,h,f,e)}return g(f)>0?u(t,h,f):async function(e,t){const{portalItem:r}=e;if(!r?.url)return;const s=await o(r.url);s&&u(e,t,{layers:s.layers?.map(c),tables:s.tables?.map(c)})}(t,h)}(a,t);m&&a.read({url:m},f);const h=await j(t,r);return h&&a.read(h,f),a.resourceReferences={portalItem:i,paths:f.readResourcePaths??[]},"subtype-group"!==a.type&&a.read({title:y},f),l(a,f)}(t,r)}function c(e){return{id:e.id,name:e.name}}function u(o,s,a,p){let n=a.layers||[];const l=a.tables||[];if("Feature Collection"===o.portalItem?.type&&(n.forEach((e=>{"Table"===e?.layerDefinition?.type&&l.push(e)})),n=n.filter((e=>"Table"!==e?.layerDefinition?.type))),"coverage"in a){const s=function(o){const{coverage:s}=o;if(!s)return null;const a=new URL(s);if(s.toLowerCase().includes("item.html")){const e=a.searchParams.get("id"),r=a.origin;return t.fromPortalItem({portalItem:new i({id:e,url:r})})}if(r(s))return t.fromArcGISServerUrl({url:s});throw new e("portal:oriented-imagery-layer-coverage","the provided coverage url couldn't be loaded as a layer")}(a);s&&o.add(s)}n.reverse().forEach((e=>{const t=p?.(e);if(t||!p){const r=y(o,s(e),a,e,t);o.add(r)}})),l.reverse().forEach((e=>{const t=p?.(e);if(t||!p){const r=y(o,s(e),a,e,t);o.tables.add(r)}}))}function y(e,t,r,o,s){const i=e.portalItem,p=new t({portalItem:i.clone(),layerId:o.id});if("sourceJSON"in p&&(p.sourceJSON=s),"subtype-group"!==p.type&&(p.sublayerTitleMode="service-name"),"Feature Collection"===i.type){const e={origin:"portal-item",portal:i.portal||a.getDefault()};p.read(o,e);const t=r.showLegend;null!=t&&p.read({showLegend:t},e)}return p}async function j(e,t){if(!1===e.supportsData)return;const r=e.instance,o=r.portalItem;if(!o)return;let s=null;try{s=await o.fetchData("json",t)}catch(e){}if(function(e){return"stream"!==e.type&&"oriented-imagery"!==e.type&&"layerId"in e}(r)){let e=null,t=!0;if(s&&g(s)>0){if(null==r.layerId){const e=b(s);r.layerId="subtype-group"===r.type?e?.[0]:f(s)}e=function(e,t){const{layerId:r}=t,o=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return o&&function(e,t){return!("feature"===t.type&&"layerType"in e&&"SubtypeGroupLayer"===e.layerType||"subtype-group"===t.type&&!("layerType"in e))}(o,t)?o:null}(s,r),e&&(1===g(s)&&(t=!1),null!=s.showLegend&&(e.showLegend=s.showLegend))}return t&&"sublayerTitleMode"in r&&"service-name"!==r.sublayerTitleMode&&(r.sublayerTitleMode="item-title-and-service-name"),e}return s}async function d(e,t){if(null==e?.layers||null==e?.tables){const r=await o(t);(e=e||{}).layers=e.layers||r?.layers,e.tables=e.tables||r?.tables}return e}function f(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function g(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function b(e){const t=[];return e?.layers?.forEach((e=>{"SubtypeGroupLayer"===e.layerType&&t.push(e.id)})),t}export{f as getFirstLayerOrTableId,g as getNumLayersAndTables,b as getSubtypeGroupLayerIds,m as load,d as preprocessFSItemData};

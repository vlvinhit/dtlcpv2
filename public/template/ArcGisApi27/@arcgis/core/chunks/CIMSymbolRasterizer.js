/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{u as o}from"./maybe.js";import{throwIfAborted as s}from"../core/promiseUtils.js";import{a as r}from"./screenUtils.js";import{T as i,O as a,C as m,a as l,b as n,c,d as p}from"./cimAnalyzer.js";import{C as h}from"./CIMResourceManager.js";import{R as y}from"./Rasterizer.js";import{m as g,A as j,B as u,C as b}from"./utils7.js";import{scaleCIMMarker as d}from"../symbols/support/cimSymbolUtils.js";import{S as f}from"../symbols/IconSymbol3DLayer.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"./ensureType.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"./object.js";import"../core/lang.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./fontUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./shapingUtils.js";import"./BidiEngine.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./alignmentUtils.js";import"./number2.js";import"./Rect.js";import"./OptimizedGeometry.js";import"./GeometryUtils.js";import"./enums.js";import"../symbols/Font.js";import"./definitions.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"./enumeration.js";import"../layers/support/fieldUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./persistableUrlUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./floatRGBA.js";import"./imageutils2.js";import"./_commonjsHelpers.js";import"./rasterizingUtils.js";var S;!function(t){t.Legend="legend",t.Preview="preview"}(S||(S={}));const w=t=>t&&t.scaleFactor?t.scaleFactor:1;class C{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new i,this._cimResourceManager=new h,this._rasterizer=new y(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,o,s,r,i,n,c){if(!t)return null;const{data:h}=t;if(!h||"CIMSymbolReference"!==h.type||!h.symbol)return null;const{symbol:y}=h;i||(i=g(y));const j=await a.resolveSymbolOverrides(h,e,this._spatialReference,r,i,n,c);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const u=this._imageDataCanvas,b=this._cimResourceManager,d=[];m.fetchResources(j,b,d),m.fetchFonts(j,b,d),d.length>0&&await Promise.all(d);const{width:f,height:S}=o,w=function(t,e,o,s){const r=-e/2+1,i=e/2-1,a=o/2-1,m=-o/2+1;switch(t){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[r,0],[0,0],[i,0]]]};default:return"legend"===s?{rings:[[[r,a],[i,0],[i,m],[r,m],[r,a]]]}:{rings:[[[r,a],[i,a],[i,m],[r,m],[r,a]]]}}}(i,f,S,s),C=m.getEnvelope(j,w,b);if(!C)return null;const M=1.3333333333333333*(window.devicePixelRatio||1);let D=1,P=0,v=0;switch(y.type){case"CIMPointSymbol":case"CIMTextSymbol":{let t=1;C.width>f&&(t=f/C.width);let e=1;C.height>S&&(e=S/C.height),"preview"===s&&(C.width<f&&(t=f/C.width),C.height<S&&(e=S/C.height)),D=Math.min(t,e),P=C.x+C.width/2,v=C.y+C.height/2}break;case"CIMLineSymbol":{let t=1;C.height>S&&(t=S/C.height),D=t,v=C.y+C.height/2;const e=C.x*D+f/2,o=(C.x+C.width)*D+f/2;if(e<0){const{paths:t}=w;t[0][0][0]-=e}if(o>f){const{paths:t}=w;t[0][2][0]-=o-f}}break;case"CIMPolygonSymbol":{P=C.x+C.width/2,v=C.y+C.height/2;const t=C.x*D+f/2,e=(C.x+C.width)*D+f/2,o=C.y*D+S/2,s=(C.y+C.height)*D+S/2,{rings:r}=w;t<0&&(r[0][0][0]-=t,r[0][3][0]-=t,r[0][4][0]-=t),o<0&&(r[0][0][1]+=o,r[0][1][1]+=o,r[0][4][1]+=o),e>f&&(r[0][1][0]-=e-f,r[0][2][0]-=e-f),s>S&&(r[0][2][1]+=s-S,r[0][3][1]+=s-S)}}u.width=f*M,u.height=S*M,u.width+=2,u.height+=2;const _=u.getContext("2d"),x=p.createIdentity();return x.translate(-P,-v),x.scale(D*M,-D*M),x.translate(f*M/2+1,S*M/2+1),_.clearRect(0,0,u.width,u.height),new l(_,b,x,!0).drawSymbol(j,w),_.getImageData(0,0,u.width,u.height)}async analyzeCIMSymbol3D(t,e,o,r,i){const a=[],l=e?{geometryType:r,spatialReference:this._spatialReference,fields:e}:null,c=[];m.fetchFonts(t.data.symbol,this._cimResourceManager,c),await Promise.all(c);const p=new n(this._cimResourceManager,l);let h;await p.analyzeSymbolReference(t.data,this._avoidSDF,a),s(i);for(const t of a)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(h||(h=[]),h.push(this._fetchPictureMarkerResource(t,i))),o&&"text"===t.type&&"string"==typeof t.text&&t.text.includes("[")&&(t.text=j(o,t.text,t.cim.textCase));return h&&await Promise.all(h),a}rasterizeCIMSymbol3D(t,e,o,s,r,i){const a=[];for(const m of t){s&&"function"==typeof s.scaleFactor&&(s.scaleFactor=s.scaleFactor(e,r,i));const t=this._getRasterizedResource(m,e,o,s,r,i);if(!t)continue;let l=0,n=t.anchorX||0,c=t.anchorY||0,p=!1,h=0,y=0;if("esriGeometryPoint"===o){const t=w(s);if(h=u(m.offsetX,e,r,i)*t||0,y=u(m.offsetY,e,r,i)*t||0,"marker"===m.type)l=u(m.rotation,e,r,i)||0,p=m.rotateClockwise??!1;else if("text"===m.type){if(l=u(m.angle,e,r,i)||0,void 0!==m.horizontalAlignment)switch(m.horizontalAlignment){case"left":n=-.5;break;case"right":n=.5;break;default:n=0}if(void 0!==m.verticalAlignment)switch(m.verticalAlignment){case"top":c=.5;break;case"bottom":c=-.5;break;case"baseline":c=-.25;break;default:c=0}}}null!=t&&a.push({angle:l,rotateClockWise:p,anchorX:n,anchorY:c,offsetX:h,offsetY:y,rasterizedResource:t})}return this.getSymbolImage(a)}getSymbolImage(t){const e=document.createElement("canvas"),s=o(e.getContext("2d"));let i=0,a=0,m=0,l=0;const n=[];for(let e=0;e<t.length;e++){const o=t[e],c=o.rasterizedResource;if(!c)continue;const p=c.size,h=o.offsetX,y=o.offsetY,g=o.anchorX,j=o.anchorY,u=o.rotateClockWise||!1;let b=o.angle,d=r(h)-p[0]*(.5+g),f=r(y)-p[1]*(.5+j),S=d+p[0],w=f+p[1];if(b){u&&(b=-b);const t=Math.sin(b*Math.PI/180),e=Math.cos(b*Math.PI/180),o=d*e-f*t,s=d*t+f*e,r=d*e-w*t,i=d*t+w*e,a=S*e-w*t,m=S*t+w*e,l=S*e-f*t,n=S*t+f*e;d=Math.min(o,r,a,l),f=Math.min(s,i,m,n),S=Math.max(o,r,a,l),w=Math.max(s,i,m,n)}i=d<i?d:i,a=f<a?f:a,m=S>m?S:m,l=w>l?w:l;const C=s.createImageData(c.size[0],c.size[1]);C.data.set(new Uint8ClampedArray(c.image.buffer));const M={offsetX:h,offsetY:y,rotateClockwise:u,angle:b,rasterizedImage:C,anchorX:g,anchorY:j};n.push(M)}e.width=m-i,e.height=l-a;const c=-i,p=l;for(let t=0;t<n.length;t++){const e=n[t],o=this._imageDataToCanvas(e.rasterizedImage),i=e.rasterizedImage.width,a=e.rasterizedImage.height,m=c-i*(.5+e.anchorX),l=p-a*(.5-e.anchorY);if(e.angle){const t=(360-e.angle)*Math.PI/180;s.save(),s.translate(r(e.offsetX),-r(e.offsetY)),s.translate(c,p),s.rotate(t),s.translate(-c,-p),s.drawImage(o,m,l),s.restore()}else s.drawImage(o,m+r(e.offsetX),l-r(e.offsetY))}const h=new f({x:c/e.width-.5,y:p/e.height-.5});return{imageData:0!==e.width&&0!==e.height?s.getImageData(0,0,e.width,e.height):s.createImageData(1,1),anchorPosition:h}}async _fetchPictureMarkerResource(t,o){const s=t.materialHash;if(!this._pictureMarkerCache.get(s)){const r=(await e(t.cim.url,{responseType:"image",signal:o&&o.signal})).data;this._pictureMarkerCache.set(s,r)}}_imageDataToCanvas(t){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const e=this._imageDataCanvas,s=o(e.getContext("2d"));return e.width=t.width,e.height=t.height,s.putImageData(t,0,0),e}_imageTo32Array(e,s,r,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,m=o(a.getContext("2d"));if(a.width=s,a.height=r,m.drawImage(e,0,0,s,r),i){m.save();const o=new t(i);m.fillStyle=o.toHex(),m.globalCompositeOperation="multiply",m.fillRect(0,0,s,r),m.globalCompositeOperation="destination-atop",m.drawImage(e,0,0,s,r),m.restore()}return new Uint32Array(m.getImageData(0,0,s,r).data.buffer)}_getRasterizedResource(t,e,s,r,i,a){let m,l,n;if("text"===t.type)return this._rasterizeTextResource(t,e,r,i,a);({analyzedCIM:m,hash:l}=function(t,e,o,s){let r,i;return"function"==typeof t.materialHash?(r=(0,t.materialHash)(e,o,s),i=c(t.cim,t.materialOverrides)):(r=t.materialHash,i=t.cim),{analyzedCIM:i,hash:r}}(t,e,i,a));const p=w(r);if("CIMPictureMarker"===t.cim.type){const s=u(t.size,e,i,a)*p,{image:r,width:m,height:l}=o(this._getPictureResource(t,s,u(t.color,e,i,a)));return n={image:r,size:[m,l],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},n}d(m,p,{preserveOutlineWidth:!1});const h=m;l+=s,r&&(l+=JSON.stringify(r));const y=this._resourceCache;return y.has(l)?y.get(l):(n=this._rasterizer.rasterizeJSONResource({cim:h,type:t.type,url:t.url,mosaicHash:l,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),y.set(l,n),n)}_rasterizeTextResource(t,e,o,s,r){const i=w(o),a=u(t.text,e,s,r);if(!a||0===a.length)return null;const m=t.cim,l=u(m?.fontFamilyName||t.fontName,e,s,r),n=u(m?.font?.style||t.style,e,s,r),c=u(m?.font?.weight||t.weight,e,s,r),p=u(m?.font?.decoration||t.decoration,e,s,r),h=u(t.size,e,s,r)*i,y=u(t.horizontalAlignment,e,s,r),g=u(t.verticalAlignment,e,s,r),j=b(u(t.color,e,s,r)),d=b(u(t.outlineColor,e,s,r)),f=u(t.outlineSize,e,s,r),S=null!=t.backgroundColor?b(t.backgroundColor):null,C=null!=t.borderLineColor?b(t.borderLineColor):null,M=null!=t.borderLineWidth?t.borderLineWidth:null,D={color:j,size:h,horizontalAlignment:y,verticalAlignment:g,font:{family:l,style:n,weight:c,decoration:p},halo:{size:f||0,color:d,style:n},backgroundColor:S,borderLine:null!=C&&null!=M?{color:C,size:M}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(a,D)}_getPictureResource(t,e,o){const s=this._pictureMarkerCache.get(t.materialHash);if(!s)return null;const i=s.height/s.width,a=e?i>1?r(e):r(e)/i:s.width,m=e?i>1?r(e)*i:r(e):s.height;return{image:this._imageTo32Array(s,a,m,o),width:a,height:m}}}export{C as CIMSymbolRasterizer,S as GeometryStyle};

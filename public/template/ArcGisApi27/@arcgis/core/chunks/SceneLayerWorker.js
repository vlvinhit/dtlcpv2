/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../geometry/SpatialReference.js";import{t}from"./DoubleArray.js";import r from"../geometry/support/MeshGeoreferencedRelativeVertexSpace.js";import n from"../geometry/support/MeshGeoreferencedVertexSpace.js";import o from"../geometry/support/MeshLocalVertexSpace.js";import{a as s,n as i}from"./vec32.js";import{g as a}from"./assets.js";import{N as f}from"./I3SNode.js";var c,l;function u(e){return a(`esri/libs/i3s/${e}`)}let m,d,y;function p(e){const t=e.modifications,r=y._malloc(8*t.length),n=new Float64Array(y.HEAPU8.buffer,r,t.length);for(let e=0;e<t.length;++e)n[e]=t[e];y.setModifications(e.context,r,t.length,e.isGeodetic),y._free(r)}function b(e,t){if(!y)return null;const{context:r,localOrigin:n,globalTrafo:o,mbs:s,obb:i,elevationOffset:a,geometryBuffer:f,geometryDescriptor:l,indexToVertexProjector:u,vertexToRenderProjector:m}=e,d=y._malloc(f.byteLength),p=y._malloc(33*Float64Array.BYTES_PER_ELEMENT),b=new Uint8Array(y.HEAPU8.buffer,d,f.byteLength);b.set(new Uint8Array(f));const h=new Float64Array(y.HEAPU8.buffer,p,33);w(h,n);let g=h.byteOffset+3*h.BYTES_PER_ELEMENT,E=new Float64Array(h.buffer,g);w(E,o),g+=16*h.BYTES_PER_ELEMENT,E=new Float64Array(h.buffer,g),w(E,s),g+=4*h.BYTES_PER_ELEMENT,null!=i&&(E=new Float64Array(h.buffer,g),w(E,i.center),g+=3*h.BYTES_PER_ELEMENT,E=new Float64Array(h.buffer,g),w(E,i.halfSize),g+=3*h.BYTES_PER_ELEMENT,E=new Float64Array(h.buffer,g),w(E,i.quaternion));const S=l,A={isDraco:!1,isLegacy:!1,color:e.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:e.needNormals&&e.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:e.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:e.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:S.featureIndex},I=y.process(r,!!e.obb,d,b.byteLength,S,A,p,a,u,m,e.normalReferenceFrame);if(y._free(p),y._free(d),I.error.length>0)throw new Error(`i3s.wasm: ${I.error}`);if(I.discarded)return null;const _=I.componentOffsets.length>0?I.componentOffsets.slice():null,L=I.featureIds.length>0?I.featureIds.slice():null,M=I.anchorIds.length>0?Array.from(I.anchorIds):null,j=I.anchors.length>0?Array.from(I.anchors):null,R=I.interleavedVertedData.slice().buffer,O=I.indicesType===c.Int16?new Uint16Array(I.indices.buffer,I.indices.byteOffset,I.indices.byteLength/2).slice():new Uint32Array(I.indices.buffer,I.indices.byteOffset,I.indices.byteLength/4).slice(),P=I.positions.slice(),x=I.positionIndicesType===c.Int16?new Uint16Array(I.positionIndices.buffer,I.positionIndices.byteOffset,I.positionIndices.byteLength/2).slice():new Uint32Array(I.positionIndices.buffer,I.positionIndices.byteOffset,I.positionIndices.byteLength/4).slice(),T={layout:e.layouts[0],interleavedVertexData:R,indices:O,hasColors:I.hasColors,hasModifications:I.hasModifications,positionData:{data:P,indices:x}};return L&&t.push(L.buffer),_&&t.push(_.buffer),t.push(R),t.push(O.buffer),t.push(P.buffer),t.push(x.buffer),{componentOffsets:_,featureIds:L,anchorIds:M,anchors:j,transformedGeometry:T,obb:I.obb}}function h(e){return 0===e?f.Unmodified:1===e?f.PotentiallyModified:2===e?f.Culled:f.Unknown}function g(e){const{context:t,buffer:r}=e,n=y._malloc(r.byteLength),o=r.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(y.HEAPU8.buffer,n,o),i=new Float64Array(r);s.set(i),y.filterOBBs(t,n,o),i.set(s),y._free(n)}function E(e){y&&(y.destroy(e),y=null)}function w(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}function S(){return y?Promise.resolve():(d||(d=(m||(m=new Promise((e=>import("./i3s.js").then((e=>e.i)).then((({default:t})=>{const r=t({locateFile:u,onRuntimeInitialized:()=>e(r)});delete r.then})))).catch((e=>{throw e}))),m).then((e=>{y=e,d=null}))),d)}!function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(c||(c={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(l||(l={}));const A={transform:b,destroy:E},I=Object.freeze(Object.defineProperty({__proto__:null,destroyContext:function(e){E(e)},dracoDecompressPointCloudData:async function(e){await S();const t=[e.geometryBuffer],{geometryBuffer:r}=e,n=r.byteLength,o=y._malloc(n),s=new Uint8Array(y.HEAPU8.buffer,o,n);s.set(new Uint8Array(r));const i=y.dracoDecompressPointCloudData(o,s.byteLength);if(y._free(o),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);const a=i.featureIds?.length>0?i.featureIds.slice():null,f=i.positions.slice();return a&&t.push(a.buffer),t.push(f.buffer),{result:{positions:f,featureIds:a},transferList:t}},filterObbsForModifications:async function(e){await S(),g(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}},filterObbsForModificationsSync:g,initialize:S,interpretObbModificationResults:h,process:async function(e){await S();const t=[e.geometryBuffer];return{result:b(e,t),transferList:t}},project:async function(s){const{localMatrix:i,origin:a,positions:f,vertexSpace:c,local:l}=s,u=e.fromJSON(s.inSpatialReference),m=e.fromJSON(s.outSpatialReference),d={georeferenced:n,georeferencedRelative:r,local:o}[c.type].fromJSON(c);let y;if("georeferenced"===d.type){const{projectBuffer:e,initializeProjection:t}=await import("../geometry/projection.js");await t(u,m),y=new Float64Array(f.length),e(f,u,0,y,m,0,y.length/3)}else{const{project:e}=await import("./georeference.js").then((e=>e.d));y=t(e({positions:f,transform:i?{localMatrix:i}:void 0,vertexSpace:d,inSpatialReference:u,outSpatialReference:m,local:l}))}const p=y.length,[b,h,g]=a;for(let e=0;e<p;e+=3)y[e]-=b,y[e+1]-=h,y[e+2]-=g;return{result:{projected:y,original:f},transferList:[y.buffer,f.buffer]}},setLegacySchema:async function(e){await S(),y.setLegacySchema(e.context,e.jsonSchema)},setModifications:async function(e){await S(),p(e)},setModificationsSync:p,test:A,transformNormals:async function({normalMatrix:e,normals:t}){const r=new Float32Array(t.length);return s(r,t,e),i(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}},Symbol.toStringTag,{value:"Module"}));export{l as M,I as S,h as a,g as f,S as i,p as s};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../request.js";import{d as t,f as r,h as n,q as a,s as o}from"./typedArrayUtil.js";import s from"../core/Error.js";import{c as i}from"./maybe.js";import{eachAlways as l}from"../core/promiseUtils.js";import{a as c}from"./mat3.js";import{c as u}from"./mat3f64.js";import{c as f}from"./mat4.js";import{c as p}from"./mat4f64.js";import{c as h,m,a as d}from"./quat.js";import{c as y}from"./quatf32.js";import{s as b,c as g,m as S,o as w,e as M,a as T,d as E}from"./vec3.js";import{c as v}from"./vec3f64.js";import{E as I,p as x}from"./unitUtils.js";import{computeTranslationToOriginAndRotation as R,canProjectWithoutEngine as j,projectBuffer as q,projectVectorToVector as C}from"../geometry/projection.js";import U from"../geometry/SpatialReference.js";import{g as N}from"./spatialReferenceEllipsoidUtils.js";import{c as z,e as A,b as W,i as k}from"./aaBoundingRect.js";import D from"../rest/support/Query.js";import{r as F}from"./I3SBinaryReader.js";import{c as O,a as _}from"./edgeUtils.js";import{p as L,C as G}from"./symbolColorUtils.js";import{c as K,a as B,b as P}from"./orientedBoundingBox.js";import{A as $}from"./Attribute.js";function Q(e,t,r,n){const a=J(e,t,r),o=p();return R(r,a,o,n),o}const Z=1,H=5-Z;function J(e,t,r){const n=v(),a=e[3],o=2**(Math.ceil(Math.log(a)*Math.LOG2E/H)*H+Z);if(r.isGeographic){const t=o/I(r).radius*180/Math.PI,a=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,a*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;n[0]=l,n[1]=s}else{const t=Math.round(e[0]/o),r=Math.round(e[1]/o);n[0]=t*o,n[1]=r*o}const s=e[2]+t,i=Math.round(s/o);return n[2]=i*o,n}function V(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function X(e){if(n("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function Y(e,t,r,n){r.traverse(t,(t=>{const r=t.mbs;return(null!=r&&oe(e,r))!==ae.OUTSIDE&&(n(t),!0)}))}function ee(e,t,r){let n=0,a=0;for(let o=0;o<t.length&&n<e.length;o++)e[n]===t[o]&&(r(o)&&(e[a]=e[n],a++),n++);e.length=a}function te(e,t,r){let n=0,o=0;for(;n<r.length;)a(e,r[n])>=0===t&&(r[o]=r[n],o++),n++;r.length=o}const re=z();function ne(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return re[0]=(e[0]-t.position[0])/t.rotationScale[0],re[1]=(e[1]-t.position[1])/t.rotationScale[4],re[2]=(e[2]-t.position[0])/t.rotationScale[0],re[3]=(e[3]-t.position[1])/t.rotationScale[4],re}var ae;function oe(e,t){const r=t[0],n=t[1],a=t[3],o=e[0]-r,s=r-e[2],i=e[1]-n,l=n-e[3],c=Math.max(o,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>a*a?ae.OUTSIDE:f>0?ae.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,s,i,l)>a?ae.INSIDE:ae.INTERSECTS_CENTER_INSIDE}function se(e,t,r){const n=[],a=r&&r.missingFields,o=r&&r.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const a of t)if(e===a.name.toLowerCase()){n.push(a.name),s=!0,o&&o.push(r);break}!s&&a&&a.push(r)}return n}async function ie(e,t,r,n,a){if(0===t.length)return[];const o=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,n){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const a=t.map((e=>e.attributes[r])),o=[],s=se(n,e.fields,{originalFields:o}),i=await le(e,a,s);for(let e=0;e<t.length;e++){const r=t[e],n=i[e],a={};if(r.attributes)for(const e in r.attributes)a[e]=r.attributes[e];for(let e=0;e<o.length;e++)a[o[e]]=n[s[e]];r.attributes=a}return t}(e.associatedLayer,t,r,n)}catch(t){if(e.associatedLayer.loaded)throw t}if(o){const i=function(e,t,r){const n=new Map,a=[],o=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<o.length;t++){const s=o[t],i=s.featureIds.indexOf(e);if(i>=0){let e=n.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},a.push(e),n.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)o[e]=o[e-1];o[0]=s;break}}}return a}(t,r,a);if(null==i)throw new s("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const l=e.parsedUrl.path,c=await Promise.all(i.map((e=>function(e,t,r,n,a){return ce(e,t,r.resources.attributes,n,a)}(l,o,e.node,e.indices,n).then((t=>{for(let r=0;r<e.graphics.length;r++){const n=e.graphics[r],a=t[r];if(n.attributes)for(const e in n.attributes)e in a||(a[e]=n.attributes[e]);n.attributes=a}return e.graphics})))));return c.flat()}throw new s("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function le(e,t,r){const n=e.capabilities.query.maxRecordCount;if(null!=n&&t.length>n){const a=o(t,n);return Promise.all(a.map((t=>le(e,t,r)))).then((e=>e.flat()))}const a=new D({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(a).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new s("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function ce(t,r,n,a,o){const s=[];for(const e of r)if(e&&o.includes(e.name)){const r=`${t}/nodes/${n}/attributes/${e.key}/0`;s.push({url:r,storageInfo:e})}return l(s.map((t=>e(t.url,{responseType:"array-buffer"}).then((e=>F(t.storageInfo,e.data)))))).then((e=>{const t=[];for(const r of a){const n={};for(let t=0;t<e.length;t++){const a=e[t].value;null!=a&&(n[s[t].storageInfo.name]=pe(a,r))}t.push(n)}return t}))}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(ae||(ae={}));const ue=-32768,fe=-(2**31);function pe(e,n){if(!e)return null;const a=e[n];return t(e)?a===ue?null:a:r(e)?a===fe?null:a:a!=a?null:a}function he(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=void 0===r?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new U(V(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function me(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=void 0===r?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=r?new U(V(r)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function de(e,t){return null==t?"@null":t===N(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function ye(e,t,r){if(!j(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function be(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||i(e.associatedLayer,(e=>e.url))!==i(t.associatedLayer,(e=>e.url)))throw new s("layerview:recycle-failed")}function ge(e,t,r){const n=he(e),a=me(e);ye(n,t,r),ye(a,t,r)}function Se(e){if(null==e.store||null==e.store.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new s("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function we(e,t){ge(e,t.spatialReference,t.viewingMode)}function Me(e){if(null==e.store||null==e.store.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function Te(e,t){ye(e.spatialReference,t.spatialReference,t.viewingMode)}function Ee(e){return"mesh-3d"===e.type}function ve(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!Ee(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material||null==t.material.color||"replace"!==t.material.colorMixMode)return!0}return!1}const Ie=O({color:[0,0,0,0],opacity:0});class xe{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function Re(e){const t=new xe;let r=!1,n=!1;for(const a of e.symbolLayers.items)if("fill"===a.type&&a.enabled){const e=a.material,o=a.edges;if(null!=e&&!r){const n=e.color,o=L(e.colorMixMode);t.material=null!=n?{color:[n.r/255,n.g/255,n.b/255],alpha:n.a,colorMixMode:o}:{color:[1,1,1],alpha:1,colorMixMode:G.Multiply},t.castShadows=a.castShadows,r=!0}null==o||n||(t.edgeMaterial=_(o,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:G.Multiply}),t}function je(e,t){return(0|e)+(0|t)|0}function qe(e,t,r,n,a=0){n===N(n)?t.isGeographic?function(e,t,r,n){const a=I(r),o=1+Math.max(0,n)/(a.radius+e.center[2]);b(t.center,e.center[0],e.center[1],e.center[2]+n),q(t.center,r,0,t.center,N(r),0,1),h(t.quaternion,e.quaternion),d(Ge,e.quaternion),b(Qe,0,0,1),w(Qe,Qe,Ge),b(Qe,e.halfSize[0]*Math.abs(Qe[0]),e.halfSize[1]*Math.abs(Qe[1]),e.halfSize[2]*Math.abs(Qe[2])),M(Qe,Qe,a.inverseFlattening),T(t.halfSize,e.halfSize,Qe),M(t.halfSize,t.halfSize,o)}(e,r,t,a):function(e,t,r,n){P(e,Ke),b(t.center,e.center[0],e.center[1],e.center[2]+n),R(r,t.center,Le,N(r)),b(t.center,Le[12],Le[13],Le[14]);const a=2*Math.sqrt(1+Le[0]+Le[5]+Le[10]);Ge[0]=(Le[6]-Le[9])/a,Ge[1]=(Le[8]-Le[2])/a,Ge[2]=(Le[1]-Le[4])/a,Ge[3]=.25*a,m(t.quaternion,Ge,e.quaternion),d(Ge,t.quaternion);let o=0,s=0,i=0;for(const e of Ke)e[2]+=n,q(e,r,0,e,N(r),0,1),S(Qe,e,t.center),w(Qe,Qe,Ge),o=Math.max(o,Math.abs(Qe[0])),s=Math.max(s,Math.abs(Qe[1])),i=Math.max(i,Math.abs(Qe[2]));b(t.halfSize,o,s,i)}(e,r,t,a):t.isWGS84&&(n.isWebMercator||x(n))?function(e,t,r,n,a){g(ze,t.center),ze[2]+=a;const o=N(r);q(ze,e,0,ze,o,0,1),We(o,t,ze,r,n)}(t,e,n,r,a):t.isWebMercator&&x(n)?function(e,t,r,n,a){g(ze,t.center),ze[2]+=a,We(e,t,ze,r,n)}(t,e,n,r,a):e===r?(r.center[2]+=a,q(r.center,t,0,r.center,n,0,1)):(b(r.center,e.center[0],e.center[1],e.center[2]+a),q(r.center,t,0,r.center,n,0,1),h(r.quaternion,e.quaternion),g(r.halfSize,e.halfSize))}const Ce=new Array(24),Ue=new $(Ce,3,!0),Ne=v(),ze=v(),Ae=u();function We(e,t,r,n,a){const o=c(Ae,t.quaternion);for(let e=0;e<8;++e){for(let r=0;r<3;++r)Ne[r]=t.halfSize[r]*(0!=(e&1<<r)?-1:1);for(let t=0;t<3;++t){let n=r[t];for(let e=0;e<3;++e)n+=Ne[e]*o[3*e+t];Ce[3*e+t]=n}}q(Ce,e,0,Ce,n,0,8),B(Ue,a)}function ke(e,t,r,n,a,o){if(!o||0===o.length||null==t||!e.mbs)return null;const s=Q(e.mbs,a,r,t);f(He,s);let i=null,l=1/0,c=-1/0;if(o.forEach((o=>(o=>{if("replace"!==o.type)return;const s=o.geometry;if(!s?.hasZ)return;A(Be);const u=s.spatialReference||n,f=s.rings.reduce(((e,r)=>r.reduce(((e,r)=>(C(r,u,Qe,t),E(Qe,Qe,He),W(Be,Qe),Math.min(Qe[2],e))),e)),1/0);(()=>{if(!i)if(i=Ke,A(Pe),null!=e.serviceObb){qe(e.serviceObb,r,$e,t,a),P($e,i);for(const e of i)E(e,e,He),W(Pe,e)}else{const n=e.mbs;if(!n)return;const o=n[3];C(n,r,Qe,t),E(Qe,Qe,He),Qe[2]+=a;for(let e=0;e<8;++e){const t=1&e?o:-o,r=2&e?o:-o,n=4&e?o:-o,a=i[e];g(a,[Qe[0]+t,Qe[1]+r,Qe[2]+n]),W(Pe,a)}}})(),k(Pe,Be)&&(l=Math.min(l,f),c=Math.max(c,f))})(o))),l===1/0)return null;for(let e=0;e<8;++e)u=Ze.data,p=3*e,h=i[e],E(Qe,h,s),u[p]=Qe[0],u[p+1]=Qe[1],u[p+2]=Qe[2],p+=24,h[2]=l,E(Qe,h,s),u[p]=Qe[0],u[p+1]=Qe[1],u[p+2]=Qe[2],p+=24,h[2]=c,E(Qe,h,s),u[p]=Qe[0],u[p+1]=Qe[1],u[p+2]=Qe[2];var u,p,h;return B(Ze)}function De(e){return null!=e&&e.halfSize[0]>=0}function Fe(e){return e[3]>=0}function Oe(e){null!=e&&(e.halfSize[0]=-1)}function _e(e){null!=e&&(e[3]=-1)}const Le=p(),Ge=y(),Ke=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Be=z(),Pe=z(),$e=K(),Qe=v(),Ze={data:new Array(72),size:3,exclusive:!0,stride:3},He=p();export{Y as A,Me as B,Te as C,be as D,ge as E,X as F,ae as M,Fe as a,Se as b,ye as c,we as d,de as e,se as f,he as g,Q as h,De as i,ke as j,J as k,ee as l,pe as m,oe as n,je as o,Re as p,ce as q,ve as r,ne as s,Ie as t,te as u,_e as v,ie as w,Oe as x,qe as y,me as z};

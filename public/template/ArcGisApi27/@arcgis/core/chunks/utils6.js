/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../Color.js";import{isSymbol3D as t,isSymbol2D as o}from"../symbols.js";import{f as n}from"./asyncUtils.js";import"./typedArrayUtil.js";import{u as r}from"./maybe.js";import{a as l,p as s}from"./screenUtils.js";import{O as i}from"./vec3f64.js";import{e as a}from"./jsonUtils.js";import{getCIMSymbolColor as c}from"../symbols/support/cimSymbolUtils.js";import{g as u}from"./assets.js";import f from"../request.js";import{L as m}from"./LRUCache.js";import{S as y}from"./Symbol3DMaterial.js";const p="picture-fill",h="simple-fill",b="simple-line",d="simple-marker",w=new m(1e3);function g(e){const t=e.style;let o=null;if(e)switch(e.type){case d:"cross"!==t&&"x"!==t&&(o=e.color);break;case h:"solid"===t?o=e.color:"none"!==t&&(o={type:"pattern",x:0,y:0,src:u(`esri/symbols/patterns/${t}.png`),width:5,height:5});break;case p:o={type:"pattern",src:e.url,width:l(e.width)*e.xscale,height:l(e.height)*e.yscale,x:l(e.xoffset),y:l(e.yoffset)};break;case"text":o=e.color;break;case"cim":o=c(e)}return o}function j(e,t){const o=e+"-"+t;return void 0!==w.get(o)?Promise.resolve(w.get(o)):f(e,{responseType:"image"}).then((e=>{const n=e.data,r=n.naturalWidth,l=n.naturalHeight,s=document.createElement("canvas");s.width=r,s.height=l;const i=s.getContext("2d");i.fillStyle=t,i.fillRect(0,0,r,l),i.globalCompositeOperation="destination-in",i.drawImage(n,0,0);const a=s.toDataURL();return w.put(o,a),a}))}function k(e){if(!e)return null;let t=null;switch(e.type){case h:case p:case d:t=k(e.outline);break;case b:{const o=l(e.width);null!=e.style&&"none"!==e.style&&0!==o&&(t={color:e.color,style:L(e.style),width:o,cap:e.cap,join:"miter"===e.join?l(e.miterLimit):e.join});break}default:t=null}return t}const L=(()=>{const e={};return t=>{if(e[t])return e[t];const o=t.replaceAll("-","");return e[t]=o,o}})(),x=new e([128,128,128]),S=new e("white");function z(e){if(!e)return 0;if(t(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return s(k(e)?.width)}function v(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function U(e){return r(e.resource).href}function C(n,r){if(!n)return null;let l=null;return t(n)?l=function(t){const o=t.symbolLayers;if(!o)return null;let n=null;return o.forEach((e=>{"object"===e.type&&e.resource?.href||(n="water"===e.type?e.color:e.material?e.material.color:null)})),n?new e(n):null}(n):o(n)&&(l="cim"===n.type?c(n):n.color?new e(n.color):null),l?R(l,r):null}function R(t,o){if(null==o||null==t)return t;const n=t.toRgba();return n[3]=n[3]*o,new e(n)}function E(n,r,l){n&&(r||null!=l)&&(r&&(r=new e(r)),t(n)?function(e,t,o){const n=e.symbolLayers;if(!n)return;const r=e=>R(t=t??e??(null!=o?S:null),o);n.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=r(e.color);else{const t=null!=e.material?e.material.color:null,n=r(t);null==e.material?e.material=new y({color:n}):e.material.color=n,null!=o&&"outline"in e&&null!=e.outline&&null!=e.outline.color&&(e.outline.color=R(e.outline.color,o))}}))}(n,r,l):o(n)&&function(e,t,o){(t=t??e.color)&&(e.color=R(t,o)),null!=o&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=R(e.outline.color,o))}(n,r,l))}function O(e){for(const t of e)if("number"==typeof t)return t;return null}function A(e,t,o){for(let n=0;n<3;n++){const r=e[n];switch(r){case"symbol-value":{const e=o[n];return null!=e?e/t[n]:1}case"proportional":break;default:if(r&&t[n])return r/t[n]}}return 1}function D(e,t,o,n){switch(e){case"proportional":return o*n;case"symbol-value":return null!=t?t:o;default:return e}}async function I(e,r){if(e&&r)return t(e)?async function(e,t){const o=e.symbolLayers;o&&await n(o,(async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){e.size="number"==typeof t[2]?t[2]:0}(e,t);break;case"icon":case"line":case"text":!function(e,t){const o=O(t);null!=o&&(e.size=o)}(e,t);break;case"path":!function(e,t){const o=A(t,i,[e.width,void 0,e.height]);e.width=D(t[0],e.width,1,o),e.height=D(t[2],e.height,1,o)}(e,t);break;case"object":await async function(e,t){const{resourceSize:o,symbolSize:n}=await async function(e){const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js"),o=await t(e,10),{width:n,height:r,depth:l}=e,s=[n,l,r];let i=1;for(let e=0;e<3;e++){const t=s[e];if(null!=t){i=t/o[e];break}}for(let e=0;e<3;e++)null==s[e]&&(s[e]=o[e]*i);return{resourceSize:o,symbolSize:s}}(e),r=A(t,o,n);e.width=D(t[0],n[0],o[0],r),e.depth=D(t[1],n[1],o[1],r),e.height=D(t[2],n[2],o[2],r)}(e,t)}}(e,t)))}(e,r):void(o(e)&&function(e,t){const o=O(t);if(null!=o)switch(e.type){case"simple-marker":e.size=o;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=o,e.height=o*t):(e.width=o*t,e.height=o);break}case"simple-line":e.width=o;break;case"text":e.font.size=o}}(e,r))}function M(e,n,r){if(e&&null!=n)if(t(e)){const t=e.symbolLayers;t&&t.forEach((e=>{if(e&&"object"===e.type)switch(r){case"tilt":e.tilt=n;break;case"roll":e.roll=n;break;default:e.heading=n}}))}else o(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=n))}function q(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return a(t)}function H(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}async function J(e,t){return await e.fetchSymbol(t)||e.fetchCIMSymbol(t)}export{I as a,M as b,E as c,q as d,k as e,g as f,C as g,J as h,R as i,x as j,j as k,v as l,L as m,U as n,z as o,H as s};

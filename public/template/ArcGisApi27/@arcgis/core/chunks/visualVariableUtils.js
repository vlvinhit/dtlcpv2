/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../Color.js";import a from"../Graphic.js";import{n}from"./compilerUtils.js";import{L as i}from"./Logger.js";import{m as r}from"./lengthUtils.js";var t,l;function s(e){return e&&"esri.renderers.visualVariables.SizeVariable"===e.declaredClass}function o(e){return null!=e&&!isNaN(e)&&isFinite(e)}function c(e){return e.valueExpression?t.Expression:e.field&&"string"==typeof e.field?t.Field:t.Unknown}function u(e,a){const n=a||c(e),i=e.valueUnit||"unknown";return n===t.Unknown?l.Constant:e.stops?l.Stops:null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue?l.ClampedLinear:"unknown"===i?null!=e.minSize&&null!=e.minDataValue?e.minSize&&e.minDataValue?l.Proportional:l.Additive:l.Identity:l.RealWorldSize}!function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"}(t||(t={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(l||(l={}));const d=i.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),f=new a,p=Math.PI,v=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function b(a,n,i){const r="visualVariables"in a&&a.visualVariables?a.visualVariables.find((e=>"color"===e.type)):a;if(!r)return;if("esri.renderers.visualVariables.ColorVariable"!==r.declaredClass)return void d.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const t="number"==typeof n,l=t?null:n,s=l&&l.attributes;let o=t?n:null;const c=r.field,{ipData:u,hasExpression:f}=r.cache;let p=r.cache.compiledFunc;if(!c&&!f){const e=r.stops;return e&&e[0]&&e[0].color}if("number"!=typeof o)if(f){if(null==i||null==i.arcade)return void d.error("Use of arcade expressions requires an arcade context");const e={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},a=i.arcade.arcadeUtils,n=a.getViewInfo(e),t=a.createExecContext(l,n);if(!p){const e=a.createSyntaxTree(r.valueExpression);p=a.createFunction(e),r.cache.compiledFunc=p}o=a.executeFunction(p,t)}else s&&(o=s[c]);const v=r.normalizationField,b=null!=s&&null!=v?parseFloat(s[v]):void 0;if(null!=o&&(!v||t||!isNaN(b)&&0!==b)){isNaN(b)||t||(o/=b);const a=z(o,u);if(a){const n=a[0],t=a[1],l=n===t?r.stops[n].color:e.blendColors(r.stops[n].color,r.stops[t].color,a[2],null!=i?i.color:void 0);return new e(l)}}}function m(e,a,n){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.OpacityVariable"!==i.declaredClass)return void d.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const r="number"==typeof a,t=r?null:a,l=t&&t.attributes;let s=r?a:null;const o=i.field,{ipData:c,hasExpression:u}=i.cache;let f=i.cache.compiledFunc;if(!o&&!u){const e=i.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof s)if(u){if(null==n||null==n.arcade)return void d.error("Use of arcade expressions requires an arcade context");const e={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},a=n.arcade.arcadeUtils,r=a.getViewInfo(e),l=a.createExecContext(t,r);if(!f){const e=a.createSyntaxTree(i.valueExpression);f=a.createFunction(e),i.cache.compiledFunc=f}s=a.executeFunction(f,l)}else l&&(s=l[o]);const p=i.normalizationField,v=null!=l&&null!=p?parseFloat(l[p]):void 0;if(null!=s&&(!p||r||!isNaN(v)&&0!==v)){isNaN(v)||r||(s/=v);const e=z(s,c);if(e){const a=e[0],n=e[1];if(a===n)return i.stops[a].opacity;{const r=i.stops[a].opacity;return r+(i.stops[n].opacity-r)*e[2]}}}}function h(e,a,n){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.RotationVariable"!==i.declaredClass)return void d.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const r=i.axis||"heading",t="heading"===r&&"arithmetic"===i.rotationType?90:0,l="heading"===r&&"arithmetic"===i.rotationType?-1:1,s="number"==typeof a?null:a,o=s&&s.attributes,c=i.field,{hasExpression:u}=i.cache;let f=i.cache.compiledFunc,p=0;if(!c&&!u)return p;if(u){if(null==n||null==n.arcade)return void d.error("Use of arcade expressions requires an arcade context");const e={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},a=n.arcade.arcadeUtils,r=a.getViewInfo(e),t=a.createExecContext(s,r);if(!f){const e=a.createSyntaxTree(i.valueExpression);f=a.createFunction(e),i.cache.compiledFunc=f}p=a.executeFunction(f,t)}else o&&(p=o[c]||0);return p="number"!=typeof p||isNaN(p)?null:t+l*p,p}function V(e,a,n){const i="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!i)return;if("esri.renderers.visualVariables.SizeVariable"!==i.declaredClass)return void d.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const r=function(e,a,n){const i="number"==typeof a,r=i?null:a,l=r&&r.attributes;let s=i?a:null;const{isScaleDriven:c}=e.cache;let u=e.cache.compiledFunc;if(c){const a=null!=n?n.scale:void 0,i=null!=n?n.view:void 0;s=null==a||"3d"===i?function(e){let a=null,n=null;const i=e.stops;return i?(a=i[0].value,n=i[i.length-1].value):(a=e.minDataValue||0,n=e.maxDataValue||0),(a+n)/2}(e):a}else if(!i)switch(e.inputValueType){case t.Expression:{if(null==n||null==n.arcade)return void d.error("Use of arcade expressions requires an arcade context");const a={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},i=n.arcade.arcadeUtils,t=i.getViewInfo(a),l=i.createExecContext(r,t);if(!u){const a=i.createSyntaxTree(e.valueExpression);u=i.createFunction(a),e.cache.compiledFunc=u}s=i.executeFunction(u,l);break}case t.Field:l&&(s=l[e.field]);break;case t.Unknown:s=null}if(!o(s))return null;if(i||!e.normalizationField)return s;const f=l?parseFloat(l[e.normalizationField]):null;return o(f)&&0!==f?s/f:null}(i,a,n),l=S(r,i,a,n,i.cache.ipData);return null==l||isNaN(l)?0:l}function x(e,a,n){return null==e?null:s(e)?V(e,a,n):o(e)?e:null}function g(e,a,n){return o(n)&&e>n?n:o(a)&&e<a?a:e}function S(e,a,n,i,t){switch(a.transformationType){case l.Additive:return function(e,a,n,i){return e+((x(a.minSize,n,i)||a.minDataValue)??0)}(e,a,n,i);case l.Constant:return function(e,a,n){const i=e.stops;let r=i&&i.length&&i[0].size;return null==r&&(r=e.minSize),x(r,a,n)}(a,n,i);case l.ClampedLinear:return function(e,a,n,i){const r=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),t=x(a.minSize,n,i),l=x(a.maxSize,n,i),s=null!=i?i.shape:void 0;if(e<=a.minDataValue)return t;if(e>=a.maxDataValue)return l;if(null==t||null==l)return null;if("area"===a.scaleBy&&s){const e="circle"===s,a=e?p*(t/2)**2:t*t,n=a+r*((e?p*(l/2)**2:l*l)-a);return e?2*Math.sqrt(n/p):Math.sqrt(n)}return t+r*(l-t)}(e,a,n,i);case l.Proportional:return function(e,a,n,i){const r=null!=i?i.shape:void 0,t=e/a.minDataValue,l=x(a.minSize,n,i),s=x(a.maxSize,n,i);let o=null;return o="circle"===r?2*Math.sqrt(t*(l/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(t*l**2):t*l,g(o,l,s)}(e,a,n,i);case l.Stops:return function(e,a,n,i,r){const[t,l,s]=z(e,r);if(t===l)return x(a.stops?.[t].size,n,i);{const e=x(a.stops?.[t].size,n,i);return e+(x(a.stops?.[l].size,n,i)-e)*s}}(e,a,n,i,t);case l.RealWorldSize:return function(e,a,n,i){const t=(null!=i&&i.resolution?i.resolution:1)*r[a.valueUnit],l=x(a.minSize,n,i),s=x(a.maxSize,n,i),{valueRepresentation:o}=a;let c=null;return c="area"===o?2*Math.sqrt(e/p)/t:"radius"===o||"distance"===o?2*e/t:e/t,g(c,l,s)}(e,a,n,i);case l.Identity:return e;case l.Unknown:return null}}function w(e,a,n){const{isScaleDriven:i}=e.cache;if(!(i&&"3d"===n||a))return null;const r={scale:a,view:n};let t=x(e.minSize,f,r),l=x(e.maxSize,f,r);if(null!=t||null!=l){if(t>l){const e=l;l=t,t=e}return{minSize:t,maxSize:l}}}function y(e,a,n){if(!e.visualVariables)return;const i=[],r=[],t=[],l=[],s=[];for(const a of e.visualVariables)switch(a.type){case"color":r.push(a);break;case"opacity":t.push(a);break;case"rotation":s.push(a);break;case"size":l.push(a)}return r.forEach((e=>{const r=b(e,a,n);i.push({variable:e,value:r})})),t.forEach((e=>{const r=m(e,a,n);i.push({variable:e,value:r})})),s.forEach((e=>{const r=h(e,a,n);i.push({variable:e,value:r})})),l.forEach((e=>{const r=V(e,a,n);i.push({variable:e,value:r})})),i.filter((e=>null!=e.value))}function z(e,a){if(!a)return;let n=0,i=a.length-1;return a.some(((a,r)=>e<a?(i=r,!0):(n=r,!1))),[n,i,(e-a[n])/(a[i]-a[n])]}function F(e,a,i){const r=["proportional","proportional","proportional"];for(const t of e){const e=t.useSymbolValue?"symbol-value":V(t,a,i);switch(t.axis){case"width":r[0]=e;break;case"depth":r[1]=e;break;case"height":r[2]=e;break;case"width-and-depth":r[0]=e,r[1]=e;break;case"all":case void 0:case null:r[0]=e,r[1]=e,r[2]=e;break;default:n(t.axis)}}return r}const k=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:F,getColor:b,getOpacity:m,getRotationAngle:h,getSize:V,getSizeForValue:S,getSizeFromNumberOrVariable:x,getSizeRangeAtScale:w,getVisualVariableValues:y,viewScaleRE:v},Symbol.toStringTag,{value:"Module"}));export{l as T,u as a,F as b,h as c,V as d,b as e,m as f,c as g,w as h,s as i,o as j,y as k,k as l,v};

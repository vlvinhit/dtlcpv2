/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{c as e,f as t}from"./vec3f64.js";import{N as i}from"./interfaces2.js";import{M as r}from"../core/scheduling.js";import{g as a}from"./watch.js";import{V as s}from"./VertexAttribute.js";import{A as n}from"./typedArrayUtil.js";import{l,d as c,c as o}from"./mathUtils.js";import{s as u,f as d,n as h}from"./vec3.js";import{c as p,h as f,j as m}from"./aaBoundingBox.js";import{V as O}from"./ViewingMode.js";import{a as v}from"./Util2.js";class g{constructor(){this.id=a()}unload(){}}var x;!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Mesh=2]="Mesh",e[e.Line=3]="Line",e[e.Point=4]="Point",e[e.Material=5]="Material",e[e.Texture=6]="Texture",e[e.COUNT=7]="COUNT"}(x||(x={}));class _{constructor(){this.enabled=!0,this._time=r(0)}get time(){return this._time}advance({deltaTime:e,fixedTime:t}){return null!=t?this._time!==t&&(this._time=t,!0):(this._time=r(this._time+e),0!==e)}}class P{constructor(e,t){this.deltaTime=e,this.fixedTime=t}}const M=new Map([[s.POSITION,0],[s.NORMAL,1],[s.NORMALCOMPRESSED,1],[s.UV0,2],[s.COLOR,3],[s.COLORFEATUREATTRIBUTE,3],[s.SIZE,4],[s.TANGENT,4],[s.AUXPOS1,5],[s.SYMBOLCOLOR,5],[s.AUXPOS2,6],[s.FEATUREATTRIBUTE,6],[s.INSTANCEFEATUREATTRIBUTE,6],[s.INSTANCECOLOR,7],[s.OBJECTANDLAYERIDCOLOR,7],[s.INSTANCEOBJECTANDLAYERIDCOLOR,7],[s.MODEL,8],[s.MODELNORMAL,12],[s.MODELORIGINHI,11],[s.MODELORIGINLO,15]]);function A(e,t){return new R(e,E,t)}function T(e,t){const{curvatureDependent:i,scaleStart:r,scaleFallOffRange:a}=E;return new R(e,{curvatureDependent:{min:{curvature:i.min.curvature,tiltAngle:i.min.tiltAngle,scaleFallOffFactor:D.curvatureDependent.min.scaleFallOffFactor},max:{curvature:i.max.curvature,tiltAngle:i.max.tiltAngle,scaleFallOffFactor:D.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:a,minPixelSize:D.minPixelSize},t)}function C(e,t,i){const r=i.parameters,a=i.paddingPixelsOverride;return I.scale=Math.min(r.divisor/(t-r.offset),1),I.factor=function(e){return Math.abs(e*e*e)}(e),I.minPixelSize=r.minPixelSize,I.paddingPixels=a,I}function F(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function b(e,t){return Math.max(l(e*t.scale,e,t.factor),F(e,t))}function L(e,t,i,r){r.scale=function(e,t,i){const r=C(e,t,i);return r.minPixelSize=0,r.paddingPixels=0,b(1,r)}(e,t,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function S(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,F(e[1],t)/Math.max(1e-5,e[1])),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}class R{get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}constructor(e,t,i,r={camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0},a){this._viewingMode=e,this._description=t,this._ellipsoidRadius=i,this.parameters=r,this._paddingPixelsOverride=a,this._viewingMode===O.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overridePadding(e){return e!==this.paddingPixelsOverride?new R(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,i){const{scaleStart:r,scaleFallOffRange:a,minPixelSize:s}=this._description,{fovY:n,distance:l}=e,c=this._calculateCurvatureDependentParameters(e,t),o=this._coverageCompensation(e,t,c),{tiltAngle:u,scaleFallOffFactor:d}=c,h=Math.sin(u)*l,p=.5*Math.PI-u-n*(.5-r*o),f=h/Math.cos(p),m=p+n*a*o,O=(f-d*(h/Math.cos(m)))/(1-d);return i.camera.fovY=e.fovY,i.camera.distance=e.distance,i.offset=O,i.divisor=f-O,i.minPixelSize=s,i}_calculateCurvatureDependentParametersLocal(e,t,i=N){return i.tiltAngle=this._description.curvatureDependent.min.tiltAngle,i.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,i}_calculateCurvatureDependentParametersGlobal(e,t,i=N){const r=this._description.curvatureDependent,a=1+e.distance/t,s=Math.sqrt(a*a-1),[n,c]=[r.min.curvature,r.max.curvature],u=o((s-n)/(c-n),0,1),[d,h]=[r.min,r.max];return i.tiltAngle=l(d.tiltAngle,h.tiltAngle,u),i.scaleFallOffFactor=l(d.scaleFallOffFactor,h.scaleFallOffFactor,u),i}_surfaceCoverageCompensationLocal(e,t,i){return(e.fovY-i.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,i){const r=t*t,a=i.tiltAngle+.5*Math.PI,{fovY:s,distance:n}=e,l=n*n+r-2*Math.cos(a)*n*t,c=Math.sqrt(l),o=Math.sqrt(l-r);return(Math.acos(o/c)-Math.asin(t/(c/Math.sin(a)))+.5*s)/s}}const E={curvatureDependent:{min:{curvature:c(10),tiltAngle:c(12),scaleFallOffFactor:.5},max:{curvature:c(70),tiltAngle:c(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},D={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},I={scale:0,factor:0,minPixelSize:0,paddingPixels:0},N={tiltAngle:0,scaleFallOffFactor:0},y=p();function j(e,t,i,r,a,n){if(e.visible)if(e.boundingInfo){v(e.type===x.Mesh);const s=t.tolerance;U(e.boundingInfo,i,r,s,a,n)}else{const t=e.indices.get(s.POSITION),l=e.vertexAttributes.get(s.POSITION);Y(i,r,0,t.length/3,t,l,void 0,a,n)}}const z=e();function U(e,t,i,r,a,s){if(null==e)return;const n=q(t,i,z);if(f(y,e.bbMin),m(y,e.bbMax),null!=a&&a.applyToAabb(y),W(y,t,n,r)){const{primitiveIndices:n,indices:l,position:c}=e,o=n?n.length:l.length/3;if(o>Q){const n=e.getChildren();if(void 0!==n){for(const e of n)U(e,t,i,r,a,s);return}}Y(t,i,0,o,l,c,n,a,s)}}const V=e();function Y(e,t,i,r,a,s,n,l,c){if(n)return function(e,t,i,r,a,s,n,l,c){const{data:o,stride:u}=s,d=e[0],h=e[1],p=e[2],f=t[0]-d,m=t[1]-h,O=t[2]-p;for(let e=i;e<r;++e){const t=n[e];let i=3*t,r=u*a[i++],s=o[r++],v=o[r++],g=o[r];r=u*a[i++];let x=o[r++],_=o[r++],P=o[r];r=u*a[i];let M=o[r++],A=o[r++],T=o[r];null!=l&&([s,v,g]=l.applyToVertex(s,v,g,e),[x,_,P]=l.applyToVertex(x,_,P,e),[M,A,T]=l.applyToVertex(M,A,T,e));const C=x-s,F=_-v,b=P-g,L=M-s,S=A-v,R=T-g,E=m*R-S*O,D=O*L-R*f,I=f*S-L*m,N=C*E+F*D+b*I;if(Math.abs(N)<=Number.EPSILON)continue;const y=d-s,j=h-v,z=p-g,U=y*E+j*D+z*I;if(N>0){if(U<0||U>N)continue}else if(U>0||U<N)continue;const Y=j*b-F*z,w=z*C-b*y,B=y*F-C*j,q=f*Y+m*w+O*B;if(N>0){if(q<0||U+q>N)continue}else if(q>0||U+q<N)continue;const W=(L*Y+S*w+R*B)/N;W>=0&&c(W,G(C,F,b,L,S,R,V),t,!1)}}(e,t,i,r,a,s,n,l,c);const{data:o,stride:u}=s,d=e[0],h=e[1],p=e[2],f=t[0]-d,m=t[1]-h,O=t[2]-p;for(let e=i,t=3*i;e<r;++e){let i=u*a[t++],r=o[i++],s=o[i++],n=o[i];i=u*a[t++];let v=o[i++],g=o[i++],x=o[i];i=u*a[t++];let _=o[i++],P=o[i++],M=o[i];null!=l&&([r,s,n]=l.applyToVertex(r,s,n,e),[v,g,x]=l.applyToVertex(v,g,x,e),[_,P,M]=l.applyToVertex(_,P,M,e));const A=v-r,T=g-s,C=x-n,F=_-r,b=P-s,L=M-n,S=m*L-b*O,R=O*F-L*f,E=f*b-F*m,D=A*S+T*R+C*E;if(Math.abs(D)<=Number.EPSILON)continue;const I=d-r,N=h-s,y=p-n,j=I*S+N*R+y*E;if(D>0){if(j<0||j>D)continue}else if(j>0||j<D)continue;const z=N*C-T*y,U=y*A-C*I,Y=I*T-A*N,w=f*z+m*U+O*Y;if(D>0){if(w<0||j+w>D)continue}else if(w>0||j+w<D)continue;const B=(F*z+b*U+L*Y)/D;B>=0&&c(B,G(A,T,C,F,b,L,V),e,!1)}}const w=e(),B=e();function G(e,t,i,r,a,s,n){return u(w,e,t,i),u(B,r,a,s),d(n,w,B),h(n,n),n}function q(e,t,i){return u(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function W(e,t,i,r){return k(e,t,i,r,1/0)}function k(e,t,i,r,a){const s=(e[0]-r-t[0])*i[0],n=(e[3]+r-t[0])*i[0];let l=Math.min(s,n),c=Math.max(s,n);const o=(e[1]-r-t[1])*i[1],u=(e[4]+r-t[1])*i[1];if(c=Math.min(c,Math.max(o,u)),c<0)return!1;if(l=Math.max(l,Math.min(o,u)),l>c)return!1;const d=(e[2]-r-t[2])*i[2],h=(e[5]+r-t[2])*i[2];return c=Math.min(c,Math.max(d,h)),!(c<0)&&(l=Math.max(l,Math.min(d,h)),!(l>c)&&l<a)}function H(e,t,i,r,a){let s=(i.screenLength||0)*e.pixelRatio;null!=a&&(s=function(e,t,i,r){return b(e,C(t,i,r))}(s,r,t,a));const n=s*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return o(n*t,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)}function J(e,t){const i=t?J(t):{};for(const t in e){let r=e[t];r&&r.forEach&&(r=Z(r)),null==r&&t in i||(i[t]=r)}return i}function X(e,t){let i=!1;for(const r in t){const a=t[r];void 0!==a&&(Array.isArray(a)?null===e[r]?(e[r]=a.slice(),i=!0):n(e[r],a)&&(i=!0):e[r]!==a&&(i=!0,e[r]=a))}return i}function Z(e){const t=[];return e.forEach((e=>t.push(e))),t}const K={multiply:1,ignore:2,replace:3,tint:4},Q=1e3;class $ extends g{constructor(e,i){super(),this.type=x.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=M,this._pp0=t(0,0,1),this._pp1=t(0,0,0),this._parameters=J(e,i),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){X(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&0!=(this.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){null!=this.repository&&this.repository.materialChanged(this)}intersectDraped(e,t,i,r,a,s){return this._pp0[0]=this._pp1[0]=r[0],this._pp0[1]=this._pp1[1]=r[1],this.intersect(e,t,i,this._pp0,this._pp1,a)}}class ee extends P{constructor(e,t,i){super(t,i),this.camera=e}}var te;!function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(te||(te={}));class ie extends i{constructor(){super(...arguments),this.renderOccluded=te.Occlude}}export{_ as A,x as C,M as D,ie as M,te as R,ee as U,g as a,$ as b,J as c,b as d,S as e,T as f,A as g,k as h,j as i,G as j,Y as k,q as l,W as m,K as n,L as p,X as u,H as v};

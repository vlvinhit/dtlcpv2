/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{L as e}from"./Logger.js";import{r as t}from"./string.js";import{f as r,d as n,b as a,a as i,c as o}from"./date.js";import{f as s,c as l}from"./number.js";import{featureHasFields as u,isRasterPixelValueField as f}from"../layers/support/fieldUtils.js";import{b as c,n as d}from"./layerUtils.js";import p from"../popup/support/FieldInfoFormat.js";import{l as y}from"./arcadeOnDemand.js";const m=e.getLogger("esri.widgets.Feature.support.featureUtils"),g=/href=(""|'')/gi,h=/(\{([^\{\r\n]+)\})/g,I=/\'/g,b=/^\s*expression\//i,F=/(\n)/gi,w=/[\u00A0-\u9999<>\&]/gim,j=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,N=/^(?:mailto:|tel:)/,E="relationships/",T=o("short-date-short-time");function x(e){if(null!=e)return e.get("sourceLayer")||e.get("layer")}async function q(e,t){return"function"==typeof e?e(t):e}function C(e=""){if(e)return!N.test(e.trim().toLowerCase())}function A(e){return!!e&&b.test(e)}function M(e,t){const r=function(e,t){if(!A(t)||!e)return null;const r=t.replace(b,"").toLowerCase();let n=null;return e.some((e=>e.name.toLowerCase()===r&&(n=e,!0))),n}(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function R(e,t){const r=L(t,e);return r?r.name:e}function v(e,t){return e&&e.map((e=>R(e,t)))}function L(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function D(e){return`${e}`.trim()}function U({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:a,fieldInfoMap:i}){return n?$({formattedAttributes:t,template:S(n,{...t,...a,...e},r),fieldInfoMap:i}):""}function $({formattedAttributes:e,template:r,fieldInfoMap:n}){return D((a=t(t(r,(e=>function(e,t){const r=t.get(e.toLowerCase());return`{${r&&r.fieldName||e}}`}(e,n))),e),a.replaceAll(g,"")));var a}function O(e,t){return e.replaceAll(h,((e,r,n)=>{const a=L(t,n);return a?`{${a.name}}`:r}))}function S(e,r,n){const a=O(e,n);return a?a.replaceAll(j,((e,n,a)=>function(e,r,n){const a=(r=D(r))&&"{"!==r[0];return t(e,function(e,t=!1){const r={...e};return Object.keys(r).forEach((e=>function(e,t,r=!1){const n=t[e];if("string"==typeof n){const a="%27",i=(r?encodeURIComponent(n):n).replaceAll(I,a);t[e]=i}}(e,r,t))),r}(n,a||!1))}(e,n||a,r))):a}function k(e){return null!=e&&"object"==typeof e&&"layer"in e&&!!e.layer}function G(e){return function(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&"feature"===e.type&&"when"in e}(e)&&function(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}(e)}function P(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&G(e.sourceLayer)}function Q(e,t){if(e&&e.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function _(e,t){const{creatorField:n,creationDateField:a,editorField:i,editDateField:o}=e;if(!t)return;const s=t[o];if("number"==typeof s){const e=t[i];return{type:"edit",date:r(s,T),user:e}}const l=t[a];if("number"==typeof l){const e=t[n];return{type:"create",date:r(l,T),user:e}}return null}function z(e,t){const r=new Map;return e?(e.forEach((e=>{const n=R(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r):r}function H(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach((e=>{if("fields"===e.type){const r=e&&e.fieldInfos;r&&t.push(...r)}})),t):t}function V(e){return e.replaceAll(w,(e=>`&#${e.charCodeAt(0)};`))}function Z(e){return"string"==typeof e?e.replaceAll(F,'<br class="esri-text-new-line" />'):e}function B(e){const{value:t,fieldName:o,fieldInfos:u,fieldInfoMap:c,layer:y,graphic:m}=e;if(null==t)return"";const g=function({fieldName:e,value:t,graphic:r,layer:n}){if(X(e))return null;if(!n||"function"!=typeof n.getFieldDomain)return null;const a=r&&n.getFieldDomain(e,{feature:r});return a&&"coded-value"===a.type?a.getName(t):null}({fieldName:o,value:t,graphic:m,layer:y});if(g)return g;const h=function({fieldName:e,graphic:t,layer:r}){if(X(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const a=r.getFeatureType(t);return a?a.name:null}({fieldName:o,graphic:m,layer:y});if(h)return h;if(c.get(o.toLowerCase()))return function(e,t){const{fieldInfos:r,fieldName:n,preventPlacesFormatting:a,layer:i}=t,o=Q(r,n),u=o?.clone(),c=L(i,n);if(u&&!f(n)){const t=c?.type;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||u.format?.dateFormat){const r=u.format??new p;if(r.dateFormat??="date-only"===t?"short-date":"short-date-short-time","number"==typeof e){const t=!k(i)&&d(i)&&i.datesInUnknownTimezone||k(i)&&function(e){return null!=e&&"object"==typeof e&&"type"in e&&"map-image"===e.type}(i.layer)&&i.layer.datesInUnknownTimezone;return r.formatDate(e,t)}switch(t){case"date-only":return r.formatDateOnly(e);case"time-only":return r.formatTimeOnly(e);case"timestamp-offset":return r.formatTimestamp(e)}}}const y=u?.format;return"string"==typeof e&&f(n)&&y?y.formatRasterPixelValue(e):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,y),"string"==typeof e||null==e||null==y?Z(e):a?s(e,{...l(y),minimumFractionDigits:0,maximumFractionDigits:20}):y.formatNumber(e))}(t,{fieldInfos:u||Array.from(c.values()),fieldName:o,layer:y});switch(y?.fieldsIndex?.get(o)?.type){case"date":return r(t);case"date-only":return i(t);case"time-only":return a(t);case"timestamp-offset":return n(t)}return Z(t)}function J({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:a,relatedInfos:i}){const o={};return i?.forEach((t=>function({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a}){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((i=>Y({attributes:e,graphic:i,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a}))),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((i=>Y({attributes:e,graphic:i,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a}))))}({attributes:o,relatedInfo:t,fieldInfoMap:a,fieldInfos:e,layer:r}))),t&&Object.keys(t).forEach((i=>{const s=t[i];o[i]=B({fieldName:i,fieldInfos:e,fieldInfoMap:a,layer:r,value:s,graphic:n})})),o}async function K(e,t){const{layer:r,graphic:n,outFields:a,objectIds:i,returnGeometry:o,spatialReference:s}=e,l=i[0];if("number"!=typeof l&&"string"!=typeof l){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:n,objectId:l,requiredFields:a};return m.warn(e,t),null}if(!c(r)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:r,graphic:n,requiredFields:a,returnGeometry:o};return m.warn(e,t),null}const u=r.createQuery();return u.objectIds=i,u.outFields=a?.length?a:[r.objectIdField],u.returnGeometry=!!o,u.returnZ=!!o,u.returnM=!!o,u.outSpatialReference=s,(await r.queryFeatures(u,t)).features[0]}async function W({graphic:e,popupTemplate:t,layer:r,spatialReference:n},a){if(!r||!t)return;if("function"==typeof r.load&&await r.load(a),!e.attributes)return;const i=e.attributes[r.objectIdField];if(null==i)return;const o=[i],s=await t.getRequiredFields(r.fieldsIndex),l=u(s,e),f=l?[]:s,c=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await y(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}(t);if(l&&!c)return;const d=await K({layer:r,graphic:e,outFields:f,objectIds:o,returnGeometry:c,spatialReference:n},a);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function X(e=""){return!!e&&e.includes(E)}function Y({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:a,layer:i}){e&&t&&r&&Object.keys(t.attributes).forEach((o=>{const s=(l={layerId:r.relation.id.toString(),fieldName:o})?`${E}${l.layerId}/${l.fieldName}`:"";var l;const u=t.attributes[o];e[s]=B({fieldName:s,fieldInfos:n,fieldInfoMap:a,layer:i,value:u,graphic:t})}))}const ee=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},te=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const a=null!=r.where?r.where:null,i=null!=r.geometry?r.geometry:null;ee(n)||ee(a)||"extent"===i?.type||"tile"===r.resultType||(r.cacheHint=!0)},re=({query:e,layer:t,method:r})=>{te({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},ne=({queryPayload:e,layer:t,method:r})=>{te({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};function ae(e,t,r){return e&&t&&r?ie(e.allLayers,t,r)||ie(e.allTables,t,r):null}function ie(e,t,r){return e.filter(G).find((e=>e!==t&&e.url===t.url&&e.layerId===r.relatedTableId))}export{G as a,R as b,q as c,M as d,X as e,ae as f,x as g,U as h,P as i,O as j,$ as k,v as l,A as m,Q as n,Z as o,V as p,z as q,H as r,C as s,K as t,_ as u,W as v,J as w,re as x,ne as y};

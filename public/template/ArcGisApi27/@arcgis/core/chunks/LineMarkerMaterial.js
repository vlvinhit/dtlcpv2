/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{s as e,k as t,d as r}from"./vec3.js";import{c as s}from"./vec3f64.js";import{n as i}from"./InterleavedLayout.js";import{S as a}from"./ShaderOutput.js";import{G as n}from"./GLTextureMaterial.js";import{b as o,R as l}from"./Material.js";import{R as c}from"./RenderSlot.js";import{V as h}from"./VertexAttribute.js";import{V as p}from"./FloatsPassUniform.js";import{R as u,S as m,P as d}from"./Program2.js";import{c as T,o as A,a as _,b as f}from"./OrderIndependentTransparency.js";import{s as E,c as O,d as v,e as S,f as g,g as R,h as P,i as I}from"./DefaultBufferWriter.js";import{T as L}from"./TransparencyPassType.js";import{L as C}from"./LineMarker.glsl.js";import{m as U,d as b,a as D}from"./renderState.js";import{b as N,a as y,L as x}from"./MarkerSizing.glsl.js";import{C as M}from"./RibbonLine.glsl.js";const w=new Map([[h.POSITION,0],[h.UV0,2],[h.AUXPOS1,3],[h.NORMAL,4],[h.COLOR,5],[h.COLORFEATUREATTRIBUTE,5],[h.SIZE,6],[h.SIZEFEATUREATTRIBUTE,6],[h.OPACITYFEATUREATTRIBUTE,7]]);class k extends m{initializeProgram(e){return new d(e.rctx,k.shader.get().build(this.configuration),w)}_makePipelineState(e,t){const r=this.configuration,s=e===L.NONE;return U({blending:r.output===a.Color||r.output===a.Alpha?s?T:A(e):null,depthTest:{func:_(e)},depthWrite:s?r.writeDepth?b:null:f(e),colorWrite:D,stencilWrite:r.hasOccludees?E:null,stencilTest:r.hasOccludees?t?O:v:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=U({blending:T,depthTest:S,depthWrite:null,colorWrite:D,stencilWrite:null,stencilTest:g}),this._occluderPipelineOpaque=U({blending:T,depthTest:S,depthWrite:null,colorWrite:D,stencilWrite:R,stencilTest:P}),this._occluderPipelineMaskWrite=U({blending:null,depthTest:I,depthWrite:null,colorWrite:null,stencilWrite:E,stencilTest:O})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===c.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===c.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}k.shader=new u(C,(()=>import("./LineMarker.glsl.js").then((e=>e.L))));class j extends o{constructor(e){super(e,new B),this._vertexAttributeLocations=w,this._configuration=new N,this._layout=this.createLayout()}dispose(){}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===c.DRAPED_MATERIAL?y.Draped:this.parameters.worldSpace?y.World:y.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==M.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===l.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=i().vec3f(h.POSITION).vec2f(h.UV0).vec3f(h.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(h.NORMAL),this.parameters.vvSize?e.f32(h.SIZEFEATUREATTRIBUTE):e.f32(h.SIZE),this.parameters.vvColor?e.f32(h.COLORFEATUREATTRIBUTE):e.vec4f(h.COLOR),this.parameters.vvOpacity&&e.f32(h.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new F(this._layout,this.parameters)}requiresSlot(e,t){return!(t!==a.Color&&t!==a.Alpha&&t!==a.Highlight&&t!==a.Depth||e!==c.DRAPED_MATERIAL&&(this.parameters.renderOccluded===l.OccludeAndTransparentStencil?e!==c.OPAQUE_MATERIAL&&e!==c.OCCLUDER_MATERIAL&&e!==c.TRANSPARENT_OCCLUDER_MATERIAL:t===a.Color||t===a.Alpha?e!==(this.parameters.writeDepth?c.TRANSPARENT_MATERIAL:c.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e!==c.OPAQUE_MATERIAL))}createGLMaterial(e){return new W(e)}}class W extends n{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(k,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==a.Color&&this._output!==a.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class B extends p{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=M.BUTT,this.anchor=x.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class F{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(s,i,a,n,o){const l=a.vertexAttributes.get(h.POSITION).data,c=l.length/3;let p=[1,0,0];const u=a.vertexAttributes.get(h.NORMAL);this._parameters.worldSpace&&null!=u&&(p=u.data);let m=1,d=0;this._parameters.vvSize?d=a.vertexAttributes.get(h.SIZEFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(h.SIZE)&&(m=a.vertexAttributes.get(h.SIZE).data[0]);let T=[1,1,1,1],A=0;this._parameters.vvColor?A=a.vertexAttributes.get(h.COLORFEATUREATTRIBUTE).data[0]:a.vertexAttributes.has(h.COLOR)&&(T=a.vertexAttributes.get(h.COLOR).data);let _=0;this._parameters.vvOpacity&&(_=a.vertexAttributes.get(h.OPACITYFEATUREATTRIBUTE).data[0]);const f=new Float32Array(n.buffer);let E=o*(this.vertexBufferLayout.stride/4);const O=(e,t,r,s)=>{if(f[E++]=e[0],f[E++]=e[1],f[E++]=e[2],f[E++]=r[0],f[E++]=r[1],f[E++]=t[0],f[E++]=t[1],f[E++]=t[2],this._parameters.worldSpace&&(f[E++]=p[0],f[E++]=p[1],f[E++]=p[2]),this._parameters.vvSize?f[E++]=d:f[E++]=m,this._parameters.vvColor)f[E++]=A;else{const e=Math.min(4*s,T.length-4);f[E++]=T[e],f[E++]=T[e+1],f[E++]=T[e+2],f[E++]=T[e+3]}this._parameters.vvOpacity&&(f[E++]=_)};let v;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(v||(v={}));const S=(i,a)=>{const n=e(G,l[3*i],l[3*i+1],l[3*i+2]),o=z;let h=i+a;do{e(o,l[3*h],l[3*h+1],l[3*h+2]),h+=a}while(t(n,o)&&h>=0&&h<c);s&&(r(n,n,s),r(o,o,s)),O(n,o,[-1,-1],i),O(n,o,[1,-1],i),O(n,o,[1,1],i),O(n,o,[-1,-1],i),O(n,o,[1,1],i),O(n,o,[-1,1],i)},g=this._parameters.placement;"begin"!==g&&"begin-end"!==g||S(0,v.ASCENDING),"end"!==g&&"begin-end"!==g||S(c-1,v.DESCENDING)}}const G=s(),z=s();export{j as L};

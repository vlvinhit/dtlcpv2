/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{t as r}from"./layerUtils.js";import{l as t}from"./lazyLayerLoader.js";import a from"../portal/PortalItem.js";import{getNumLayersAndTables as o,preprocessFSItemData as s,getSubtypeGroupLayerIds as i,getFirstLayerOrTableId as p}from"./layersLoader.js";import{h as m}from"./portalItemUtils.js";import{a as c}from"./fetchService.js";import"../core/lang.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"./maybe.js";import"../request.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"./assets.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./get.js";import"./ObjectPool.js";import"./ObservableBase.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../portal/Portal.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../layers/Layer.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"./arcgisLayerUrl.js";import"./persistableUrlUtils.js";import"./jsonContext.js";import"./styleUtils2.js";import"./asyncUtils.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"./mat4.js";import"./pe.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";async function n(e){!e.portalItem||e.portalItem instanceof a||(e={...e,portalItem:new a(e.portalItem)});const r=await async function(e){return await e.load(),async function(e){const r=e.className,a=t[r];return{constructor:await a(),properties:e.properties}}(await l(e))}(e.portalItem);return new(0,r.constructor)({portalItem:e.portalItem,...r.properties})}async function l(t){switch(t.type){case"Map Service":return async function(e){const r=await async function(e){return(await c(e.url)).tileInfo}(e);return r?{className:"TileLayer"}:{className:"MapImageLayer"}}(t);case"Feature Service":return async function(e){if(m(e,"Oriented Imagery Layer"))return async function(e){return await e.load(),{className:"OrientedImageryLayer",properties:await e.fetchData()}}(e);const r=await y(e);if("object"==typeof r){const e={};return null!=r.id&&(e.layerId=r.id),{className:r.className||"FeatureLayer",properties:e}}return{className:"GroupLayer"}}(t);case"Feature Collection":return async function(e){await e.load();const r=m(e,"Map Notes"),t=m(e,"Markup");if(r||t)return{className:"MapNotesLayer"};if(m(e,"Route Layer"))return{className:"RouteLayer"};const a=await e.fetchData();return 1===o(a)?{className:"FeatureLayer"}:{className:"GroupLayer"}}(t);case"Scene Service":return async function(e){const t=await y(e);if("object"==typeof t){const a={};let o;if(null!=t.id?(a.layerId=t.id,o=`${e.url}/layers/${t.id}`):o=e.url,e.typeKeywords?.length)for(const t of Object.keys(r))if(e.typeKeywords.includes(t))return{className:r[t]};const s=await c(o);return{className:r[s?.layerType]||"SceneLayer",properties:a}}if(!1===t){const r=await c(e.url);return"Voxel"===r?.layerType?{className:"VoxelLayer"}:{className:"GroupLayer"}}return{className:"GroupLayer"}}(t);case"Image Service":return async function(e){await e.load();const r=e.typeKeywords?.map((e=>e.toLowerCase()))??[];if(r.includes("elevation 3d layer"))return{className:"ElevationLayer"};if(r.includes("tiled imagery"))return{className:"ImageryTileLayer"};const t=await e.fetchData(),a=t?.layerType;if("ArcGISTiledImageServiceLayer"===a)return{className:"ImageryTileLayer"};if("ArcGISImageServiceLayer"===a)return{className:"ImageryLayer"};const o=await c(e.url),s=o.cacheType?.toLowerCase(),i=o.capabilities?.toLowerCase().includes("tilesonly");return"map"===s||i?{className:"ImageryTileLayer"}:{className:"ImageryLayer"}}(t);case"Stream Service":case"Feed":return{className:"StreamLayer"};case"Vector Tile Service":return{className:"VectorTileLayer"};case"GeoJson":return{className:"GeoJSONLayer"};case"CSV":return{className:"CSVLayer"};case"KML":return{className:"KMLLayer"};case"WFS":return{className:"WFSLayer"};case"WMTS":return{className:"WMTSLayer"};case"WMS":return{className:"WMSLayer"};default:throw new e("portal:unknown-item-type","Unknown item type '${type}'",{type:t.type})}}async function y(e){const r=e.url;if(!r||/\/\d+$/.test(r))return{};await e.load();const t=await e.fetchData();if("Feature Service"===e.type){const e=u(await s(t,r));if("object"==typeof e){const r=i(t);e.className=null!=e.id&&r.includes(e.id)?"SubtypeGroupLayer":"FeatureLayer"}return e}return o(t)>0?u(t):u(await c(r))}function u(e){return 1===o(e)&&{id:p(e)}}export{n as fromItem,l as selectLayerClassPath};

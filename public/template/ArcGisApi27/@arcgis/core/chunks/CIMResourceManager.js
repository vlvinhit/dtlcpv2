/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{l as r}from"./fontUtils.js";import{throwIfAborted as i,isAbortError as s}from"../core/promiseUtils.js";import{b as a}from"../core/urlUtils.js";import{p as n,a as o,d as c}from"./Rasterizer.js";import{M as h}from"../core/scheduling.js";import{c as u}from"./imageutils2.js";const d=[137,80,78,71,13,10,26,10],l=[71,73,70];class p{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(r,p){const g=this._resourceMap.get(r);if(g)return{width:g.width,height:g.height};let m=this._inFlightResourceMap.get(r);return m?m.then((e=>({width:e.width,height:e.height}))):(m=async function(r,p){const{arrayBuffer:g,mediaType:m}=await async function(r,i){let n;const o=";base64,";if(r.includes(o)){const e=r.indexOf(o),t=r.indexOf(o)+8,i=r.substring(t);n={arrayBuffer:a(i),mediaType:r.substring(0,e).replace("data:","")}}else try{const t=await e(r,{responseType:"array-buffer",...i});n={arrayBuffer:t.data,mediaType:t.getHeader("Content-Type")}}catch(e){if(!s(e))throw new t("mapview-invalid-resource",`Could not fetch requested resource at ${r}`)}return n}(r,p),f="image/png"===m;return"image/gif"===m&&function(e){if(!function(e){const t=new Uint8Array(e);return!l.some(((e,r)=>e!==t[r]))}(e))return!1;const t=new DataView(e),r=t.getUint8(10);let i=13+(128&r?3*2**(1+(7&r)):0),s=0,a=!1;for(;!a;){switch(t.getUint8(i++)){case 33:if(!n())return!1;break;case 44:o();break;case 59:a=!0;break;default:return!1}if(s>1)return!0}function n(){switch(t.getUint8(i++)){case 249:i++,i+=4,c();break;case 1:s++,i++,i+=12,c();break;case 254:c();break;case 255:i++,i+=8,i+=3,c();break;default:return!1}return!0}function o(){s++,i+=8;const e=t.getUint8(i++);i+=128&e?3*2**(1+(7&e)):0,i++,c()}function c(){let e;for(;e=t.getUint8(i++);)i+=e}return!1}(g)?async function(e,t){const r=o(e),i=c(r,!0),{width:s,height:a}=r.lsd,n=document.createElement("canvas");n.width=s,n.height=a;const d=n.getContext("2d",{willReadFrequently:!0}),l=[],p=[];for(const e of i){p.push(h(e.delay||100));const t=new ImageData(e.patch,e.dims.width,e.dims.height),r=u(t),i=3===e.disposalType?d.getImageData(e.dims.left,e.dims.top,e.dims.width,e.dims.height):void 0;d.drawImage(r,e.dims.left,e.dims.top);const n=d.getImageData(0,0,s,a);l.push(n),1===e.disposalType||(2===e.disposalType?d.clearRect(e.dims.left,e.dims.top,e.dims.width,e.dims.height):3===e.disposalType&&d.putImageData(i,e.dims.left,e.dims.top))}return{frameDurations:p,getFrame:e=>l[e],width:s,height:a}}(g):f&&function(e){if(!function(e){const t=new Uint8Array(e);return!d.some(((e,r)=>e!==t[r]))}(e))return!1;const t=new DataView(e),r=new Uint8Array(e);let i,s=8;do{const e=t.getUint32(s);if(i=String.fromCharCode.apply(String,Array.prototype.slice.call(r.subarray(s+4,s+8))),"acTL"===i)return!0;s+=12+e}while("IEND"!==i&&s<r.length);return!1}(g)?async function(e,t){const r=n(e);if(r instanceof Error)throw r;await r.createImages(),i(t);const{frames:s,width:a,height:o}=r,c=document.createElement("canvas");c.width=a,c.height=o;const u=c.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of s){l.push(h(e.delay||100));const t=e.imageElement;0===e.blendOp?u.globalCompositeOperation="copy":u.globalCompositeOperation="source-over";const r=2===e.disposeOp?u.getImageData(e.left,e.top,e.width,e.height):void 0;u.drawImage(t,e.left,e.top);const i=u.getImageData(0,0,a,o);d.push(i),0===e.disposeOp||(1===e.disposeOp?u.clearRect(e.left,e.top,e.width,e.height):2===e.disposeOp&&u.putImageData(r,e.left,e.top))}return{frameDurations:l,getFrame:e=>d[e],width:a,height:o}}(g,p):async function(r,i){const a=window.URL.createObjectURL(r);try{const{data:t}=await e(a,{...i,responseType:"image"});return t}catch(e){if(!s(e))throw new t("mapview-invalid-resource",`Could not fetch requested resource at ${a}`);throw e}finally{window.URL.revokeObjectURL(a)}}(new Blob([g],{type:m}),p)}(r,p),this._inFlightResourceMap.set(r,m),m.then((e=>(this._inFlightResourceMap.delete(r),this._resourceMap.set(r,e),{width:e.width,height:e.height})),(()=>({width:0,height:0}))))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return r(e)}}export{p as C};

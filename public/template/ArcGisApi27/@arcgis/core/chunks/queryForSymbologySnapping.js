/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../geometry.js";import{throwIfAborted as e}from"../core/promiseUtils.js";import{m as n}from"./dehydratedFeatures.js";import{j as t}from"./elevationInfoUtils.js";import{E as o,i as a,j as r,a as s,S as i}from"./ElevationContext.js";import c from"../geometry/SpatialReference.js";import{l as d}from"./arcadeOnDemand.js";async function p(n,o,i,c,d){const{elevationProvider:p,renderCoordsHelper:m,spatialReference:g}=n,{elevationInfo:h}=o,y=a(h,!0),j=await r(y,g,d);e(d);const I=[],S=new Set,b=new Set;for(const{objectId:e,points:a}of c){const r=i(e);if(null==r){for(const e of a)I.push(e.z??0);S.add(e);continue}r.isDraped&&b.add(e);const c=r.graphic.geometry;l.setFromElevationInfo(t(c,h)),l.updateFeatureExpressionInfoContext(j,r.graphic,o),f.spatialReference=n.spatialReference;for(const{x:e,y:n,z:t}of a)f.x=e,f.y=n,f.z=t??0,s(f,p,l,m,u),I.push(u.z)}return{elevations:I,drapedObjectIds:b,failedObjectIds:S}}const l=new o,f=n(0,0,0,c.WGS84),u=new i;async function m(n,t,o){if(null==n||0===t.candidates.length)return g;const a=n.graphics3DGraphicsByObjectID??n.graphics3DGraphics,r=[],s=[],{renderer:i}=n,c=null!=i&&"arcadeRequired"in i&&i.arcadeRequired?d():null,p=async(e,{graphic:t,graphics3DSymbol:a})=>{const r=await c,s=await n.getRenderingInfoAsync(t,i,r,{signal:o});return null==s?[]:a.queryForSnapping(e,f,s,o)},{candidates:l,spatialReference:f}=t;for(let e=0;e<l.length;++e){const n=l[e],{objectId:t}=n,o="number"==typeof t?a?.get(t):void 0;if(null==o)continue;const{graphics3DSymbol:i}=o;i.symbologySnappingSupported&&(r.push(p(n,o)),s.push(e))}if(0===r.length)return g;const u=await Promise.all(r);e(o);const m=[],h=[];for(let e=0;e<u.length;++e){const n=u[e],t=s[e];for(const e of n)m.push(e),h.push(t)}return{candidates:m,sourceCandidateIndices:h}}const g={candidates:[],sourceCandidateIndices:[]};export{p as e,m as q};

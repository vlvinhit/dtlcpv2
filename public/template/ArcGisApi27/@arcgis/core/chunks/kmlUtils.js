/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../config.js";import{id as o}from"../kernel.js";import t from"../PopupTemplate.js";import r from"../request.js";import{clone as s}from"../core/lang.js";import{addQueryParameters as n}from"../core/urlUtils.js";import i from"../geometry/SpatialReference.js";import{c as a,N as f,b as l,d as u}from"./aaBoundingBox.js";import{b as p}from"./extentUtils.js";import{fromJSON as m}from"../renderers/support/jsonUtils.js";import y from"../rest/support/FeatureSet.js";const c={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function d(e){const o=e.folders||[],t=o.slice(),r=new Map,n=new Map,i=new Map,a=new Map,f=new Map,l={esriGeometryPoint:n,esriGeometryPolyline:i,esriGeometryPolygon:a};(e.featureCollection&&e.featureCollection.layers||[]).forEach((e=>{const o=s(e);o.featureSet.features=[];const t=e.featureSet.geometryType;r.set(t,o);const f=e.layerDefinition.objectIdField;"esriGeometryPoint"===t?G(n,f,e.featureSet.features):"esriGeometryPolyline"===t?G(i,f,e.featureSet.features):"esriGeometryPolygon"===t&&G(a,f,e.featureSet.features)})),e.groundOverlays&&e.groundOverlays.forEach((e=>{f.set(e.id,e)})),o.forEach((o=>{o.networkLinkIds.forEach((r=>{const s=function(e,o,t){const r=function(e,o){let t;return o.some((o=>o.id===e&&(t=o,!0))),t}(e,t);return r&&(r.parentFolderId=o,r.networkLink=r),r}(r,o.id,e.networkLinks);s&&t.push(s)}))})),t.forEach((e=>{if(e.featureInfos){e.points=s(r.get("esriGeometryPoint")),e.polylines=s(r.get("esriGeometryPolyline")),e.polygons=s(r.get("esriGeometryPolygon")),e.mapImages=[];for(const o of e.featureInfos)switch(o.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const t=l[o.type].get(o.id);t&&e[c[o.type]]?.featureSet.features.push(t);break}case"GroundOverlay":{const t=f.get(o.id);t&&e.mapImages.push(t);break}}e.fullExtent=P([e])}}));const u=P(t);return{folders:o,sublayers:t,extent:u}}function g(t,s,i,a){const f=o&&o.findCredential(t);t=n(t,{token:f&&f.token});const l=e.kmlServiceUrl;return r(l,{query:{url:t,model:"simple",folders:"",refresh:0!==i||void 0,outSR:JSON.stringify(s)},responseType:"json",signal:a})}function S(e,o,t=null,r=[]){const s=[],n={},i=o.sublayers,a=o.folders.map((e=>e.id));return i.forEach((o=>{const i=new e;if(t?i.read(o,t):i.read(o),r.length&&a.includes(i.id)&&(i.visible=r.includes(i.id)),n[o.id]=i,null!=o.parentFolderId&&-1!==o.parentFolderId){const e=n[o.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers?.unshift(i)}else s.unshift(i)})),s}function G(e,o,t){t.forEach((t=>{e.set(t.attributes[o],t)}))}async function h(e){const o=y.fromJSON(e.featureSet).features,r=e.layerDefinition,s=m(r.drawingInfo.renderer),n=t.fromJSON(e.popupInfo),i=[];for(const e of o){const o=await s.getSymbolAsync(e);e.symbol=o,e.popupTemplate=n,e.visible=!0,i.push(e)}return i}function P(e){const o=a(f),t=a(f);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const e of r.polygons.featureSet.features)p(o,e.geometry),l(t,o);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const e of r.polylines.featureSet.features)p(o,e.geometry),l(t,o);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const e of r.points.featureSet.features)p(o,e.geometry),l(t,o);if(r.mapImages)for(const e of r.mapImages)p(o,e.extent),l(t,o)}return u(t,f)?void 0:{xmin:t[0],ymin:t[1],zmin:t[2],xmax:t[3],ymax:t[4],zmax:t[5],spatialReference:i.WGS84}}export{P as c,g as f,h as g,d as p,S as s};

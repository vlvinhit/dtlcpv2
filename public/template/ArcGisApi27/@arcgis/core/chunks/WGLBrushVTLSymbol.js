/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{e}from"./mathUtils.js";import{c as t}from"./mat3f32.js";import{f as a}from"./vec4f32.js";import{V as i,n as r,o as n}from"./definitions.js";import{W as s}from"./enums4.js";import{u as o}from"./number2.js";import{B as l,V as f}from"./VertexArrayObject.js";import{c as u,g as c,e as d,U as p,D as m}from"./enums3.js";import{T as g,R as y,b as _}from"./StyleDefinition.js";import{c as M,f as U}from"./vec2f32.js";import{F as E}from"./config.js";import{d as h}from"./GeometryUtils2.js";class v{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(e,t){}draw(e,t,a){}drawMany(e,t,a){for(const i of t)i.visible&&this.draw(e,i,a)}}class P extends v{constructor(){super(...arguments),this._color=a(1,0,0,1),this._patternMatrix=t(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(t,a){const{context:n,painter:l,styleLayerUID:f,requestRender:p,allowDelayedRender:m}=t;this._loadWGLResources(t);const g=t.displayLevel,y=t.styleLayer,_=y.backgroundMaterial,M=l.vectorTilesMaterialManager,U=y.getPaintValue("background-color",g),E=y.getPaintValue("background-opacity",g),h=y.getPaintValue("background-pattern",g),v=void 0!==h,P=U[3]*E,T=1|window.devicePixelRatio,I=t.spriteMosaic;let x,R;const D=T>r?2:1,S=t.drawPhase===s.HITTEST,w=this._programOptions;w.id=S,w.pattern=v;const V=M.getMaterialProgram(n,_,w);if(!m||null==p||V.compiled){if(n.bindVAO(this._vao),n.useProgram(V),v){const e=I.getMosaicItemPosition(h,!0);if(null!=e){const{tl:t,br:a,page:r}=e;x=a[0]-t[0],R=a[1]-t[1];const s=I.getPageSize(r);null!=s&&(I.bind(n,u.LINEAR,r,i),V.setUniform4f("u_tlbr",t[0],t[1],a[0],a[1]),V.setUniform2fv("u_mosaicSize",s),V.setUniform1i("u_texture",i))}V.setUniform1f("u_opacity",E)}else this._color[0]=P*U[0],this._color[1]=P*U[1],this._color[2]=P*U[2],this._color[3]=P,V.setUniform4fv("u_color",this._color);if(V.setUniform1f("u_depth",y.z||0),S){const e=o(f+1);V.setUniform4fv("u_id",e)}for(const t of a){if(V.setUniform1f("u_coord_range",t.rangeX),V.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),v){const a=Math.max(2**(Math.round(g)-t.key.level),1),i=D*t.width*a,r=i/e(x),n=i/e(R);this._patternMatrix[0]=r,this._patternMatrix[4]=n,V.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}n.setStencilFunction(c.EQUAL,0,255),n.drawArrays(d.TRIANGLE_STRIP,0,4)}}else p()}_loadWGLResources(e){if(this._vao)return;const{context:t,styleLayer:a}=e,i=a.backgroundMaterial,r=new Int8Array([0,0,1,0,0,1,1,1]),n=l.createVertex(t,p.STATIC_DRAW,r),s=new f(t,i.getAttributeLocations(),i.getLayoutInfo(),{geometry:n});this._vao=s}}class T extends v{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(e,t){const{context:a,displayLevel:i,requiredLevel:r,state:n,drawPhase:l,painter:f,spriteMosaic:u,styleLayerUID:p,requestRender:y,allowDelayedRender:_}=e;if(!t.some((e=>e.layerData.get(p)?.circleIndexCount??!1)))return;const M=e.styleLayer,U=M.circleMaterial,E=f.vectorTilesMaterialManager,h=M.getPaintValue("circle-translate",i),v=M.getPaintValue("circle-translate-anchor",i),P=l===s.HITTEST,T=this._programOptions;T.id=P;const I=E.getMaterialProgram(a,U,T);if(_&&null!=y&&!I.compiled)return void y();a.useProgram(I),I.setUniformMatrix3fv("u_displayMat3",v===g.VIEWPORT?n.displayMat3:n.displayViewMat3),I.setUniform2fv("u_circleTranslation",h),I.setUniform1f("u_depth",M.z),I.setUniform1f("u_antialiasingWidth",1.2);let x=-1;if(P){const e=o(p+1);I.setUniform4fv("u_id",e)}for(const e of t){if(!e.layerData.has(p))continue;e.key.level!==x&&(x=e.key.level,U.setDataUniforms(I,i,M,x,u));const t=e.layerData.get(p);if(!t.circleIndexCount)continue;t.prepareForRendering(a);const n=t.vao;null!=n&&(a.bindVAO(n),I.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),r!==e.key.level?a.setStencilFunction(c.EQUAL,e.stencilRef,255):a.setStencilFunction(c.GREATER,255,255),a.drawElements(d.TRIANGLES,t.circleIndexCount,m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.circleIndexStart),e.triangleCount+=t.circleIndexCount/3)}}}const I=1/65536;class x extends v{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:a,drawPhase:i,renderPass:r,spriteMosaic:n,styleLayerUID:l}=e;let f=!1;for(const e of t)if(e.layerData.has(l)){const t=e.layerData.get(l);if(t.fillIndexCount>0||t.outlineIndexCount>0){f=!0;break}}if(!f)return;const u=e.styleLayer,c=u.getPaintProperty("fill-pattern"),d=void 0!==c,p=d&&c.isDataDriven;let m;if(d&&!p){const e=c.getValue(a);m=n.getMosaicItemPosition(e,!0)}const g=!d&&u.getPaintValue("fill-antialias",a);let y,_=!0,M=1;if(!d){const e=u.getPaintProperty("fill-color"),t=u.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=u.getPaintValue("fill-color",a);M=u.getPaintValue("fill-opacity",a)*e[3],M>=1&&(_=!1)}}if(_&&"opaque"===r)return;i===s.HITTEST&&(y=o(l+1));const U=u.getPaintValue("fill-translate",a),E=u.getPaintValue("fill-translate-anchor",a);(_||"translucent"!==r)&&this._drawFill(e,l,u,t,U,E,d,m,p,y);const h=!u.hasDataDrivenOutlineColor&&u.outlineUsesFillColor&&M<1;g&&"opaque"!==r&&!h&&this._drawOutline(e,l,u,t,U,E,y)}_drawFill(e,t,a,n,o,l,f,p,y,_){if(f&&!y&&null==p)return;const{context:M,displayLevel:U,state:E,drawPhase:h,painter:v,pixelRatio:P,spriteMosaic:T,requestRender:x,allowDelayedRender:R}=e,D=a.fillMaterial,S=v.vectorTilesMaterialManager,w=P>r?2:1,V=h===s.HITTEST,L=this._fillProgramOptions;L.id=V,L.pattern=f;const A=S.getMaterialProgram(M,D,L);if(R&&null!=x&&!A.compiled)return void x();if(M.useProgram(A),null!=p){const{page:e}=p,t=T.getPageSize(e);null!=t&&(T.bind(M,u.LINEAR,e,i),A.setUniform2fv("u_mosaicSize",t),A.setUniform1i("u_texture",i))}A.setUniformMatrix3fv("u_displayMat3",l===g.VIEWPORT?E.displayMat3:E.displayViewMat3),A.setUniform2fv("u_fillTranslation",o),A.setUniform1f("u_depth",a.z+I),V&&A.setUniform4fv("u_id",_);let N=-1;for(const e of n){if(!e.layerData.has(t))continue;e.key.level!==N&&(N=e.key.level,D.setDataUniforms(A,U,a,N,T));const r=e.layerData.get(t);if(!r.fillIndexCount)continue;r.prepareForRendering(M);const n=r.fillVAO;if(null!=n){if(M.bindVAO(n),A.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),M.setStencilFunction(c.EQUAL,e.stencilRef,255),f){const t=Math.max(2**(Math.round(U)-e.key.level),1),a=e.rangeX/(w*e.width*t);A.setUniform1f("u_patternFactor",a)}if(y){const e=r.patternMap;if(!e)continue;for(const[t,a]of e){const e=T.getPageSize(t);null!=e&&(T.bind(M,u.LINEAR,t,i),A.setUniform2fv("u_mosaicSize",e),A.setUniform1i("u_texture",i),M.drawElements(d.TRIANGLES,a[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else M.drawElements(d.TRIANGLES,r.fillIndexCount,m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.fillIndexStart);e.triangleCount+=r.fillIndexCount/3}}}_drawOutline(e,t,a,i,r,n,o){const{context:l,displayLevel:f,state:u,drawPhase:p,painter:y,pixelRatio:_,spriteMosaic:M,requestRender:U,allowDelayedRender:E}=e,h=a.outlineMaterial,v=y.vectorTilesMaterialManager,P=.75/_,T=p===s.HITTEST,x=this._outlineProgramOptions;x.id=T;const R=v.getMaterialProgram(l,h,x);if(E&&null!=U&&!R.compiled)return void U();l.useProgram(R),R.setUniformMatrix3fv("u_displayMat3",n===g.VIEWPORT?u.displayMat3:u.displayViewMat3),R.setUniform2fv("u_fillTranslation",r),R.setUniform1f("u_depth",a.z+I),R.setUniform1f("u_outline_width",P),T&&R.setUniform4fv("u_id",o);let D=-1;for(const e of i){if(!e.layerData.has(t))continue;e.key.level!==D&&(D=e.key.level,h.setDataUniforms(R,f,a,D,M));const i=e.layerData.get(t);if(i.prepareForRendering(l),!i.outlineIndexCount)continue;const r=i.outlineVAO;null!=r&&(l.bindVAO(r),R.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),l.setStencilFunction(c.EQUAL,e.stencilRef,255),l.drawElements(d.TRIANGLES,i.outlineIndexCount,m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i.outlineIndexStart),e.triangleCount+=i.outlineIndexCount/3)}}}class R extends v{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,t){const{context:a,displayLevel:r,state:n,drawPhase:l,painter:f,pixelRatio:p,spriteMosaic:y,styleLayerUID:_,requestRender:M,allowDelayedRender:U}=e;if(!t.some((e=>e.layerData.get(_)?.lineIndexCount??!1)))return;const E=e.styleLayer,h=E.lineMaterial,v=f.vectorTilesMaterialManager,P=E.getPaintValue("line-translate",r),T=E.getPaintValue("line-translate-anchor",r),I=E.getPaintProperty("line-pattern"),x=void 0!==I,R=x&&I.isDataDriven;let D,S;if(x&&!R){const e=I.getValue(r);D=y.getMosaicItemPosition(e)}let w=!1;if(!x){const e=E.getPaintProperty("line-dasharray");if(S=void 0!==e,w=S&&e.isDataDriven,S&&!w){const t=e.getValue(r),a=E.getDashKey(t,E.getLayoutValue("line-cap",r));D=y.getMosaicItemPosition(a)}}const V=1/p,L=l===s.HITTEST,A=this._programOptions;A.id=L,A.pattern=x,A.sdf=S;const N=v.getMaterialProgram(a,h,A);if(U&&null!=M&&!N.compiled)return void M();if(a.useProgram(N),N.setUniformMatrix3fv("u_displayViewMat3",n.displayViewMat3),N.setUniformMatrix3fv("u_displayMat3",T===g.VIEWPORT?n.displayMat3:n.displayViewMat3),N.setUniform2fv("u_lineTranslation",P),N.setUniform1f("u_depth",E.z),N.setUniform1f("u_antialiasing",V),L){const e=o(_+1);N.setUniform4fv("u_id",e)}if(D&&null!=D){const{page:e}=D,t=y.getPageSize(e);null!=t&&(y.bind(a,u.LINEAR,e,i),N.setUniform2fv("u_mosaicSize",t),N.setUniform1i("u_texture",i))}let O=-1;for(const e of t){if(!e.layerData.has(_))continue;e.key.level!==O&&(O=e.key.level,h.setDataUniforms(N,r,E,O,y));const t=2**(r-O)/p;N.setUniform1f("u_zoomFactor",t);const n=e.layerData.get(_);if(!n.lineIndexCount)continue;n.prepareForRendering(a);const s=n.vao;if(null!=s){if(a.bindVAO(s),N.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),a.setStencilFunction(c.EQUAL,e.stencilRef,255),R||w){const e=n.patternMap;if(!e)continue;for(const[t,r]of e){const e=y.getPageSize(t);null!=e&&(y.bind(a,u.LINEAR,t,i),N.setUniform2fv("u_mosaicSize",e),N.setUniform1i("u_texture",i),a.drawElements(d.TRIANGLES,r[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r[0]))}}else a.drawElements(d.TRIANGLES,n.lineIndexCount,m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.lineIndexStart);e.triangleCount+=n.lineIndexCount/3}}}}class D extends v{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=M()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let n;a===s.HITTEST&&(n=o(i+1)),this._drawIcons(e,r,t,n),this._drawText(e,r,t,n)}_drawIcons(e,t,a,r){const{context:n,displayLevel:o,drawPhase:l,painter:f,spriteMosaic:u,state:c,styleLayerUID:d,requestRender:p,allowDelayedRender:m}=e,M=t.iconMaterial,U=f.vectorTilesMaterialManager;let v,P=!1;for(const e of a)if(e.layerData.has(d)&&(v=e.layerData.get(d),v.iconPerPageElementsMap.size>0)){P=!0;break}if(!P)return;const T=t.getPaintValue("icon-translate",o),I=t.getPaintValue("icon-translate-anchor",o);let x=t.getLayoutValue("icon-rotation-alignment",o);x===y.AUTO&&(x=t.getLayoutValue("symbol-placement",o)===_.POINT?y.VIEWPORT:y.MAP);const R=x===y.MAP,D=t.getLayoutValue("icon-keep-upright",o)&&R,S=v.isIconSDF,w=l===s.HITTEST,V=this._iconProgramOptions;V.id=w,V.sdf=S;const L=U.getMaterialProgram(n,M,V);if(m&&null!=p&&!L.compiled)return void p();n.useProgram(L),L.setUniformMatrix3fv("u_displayViewMat3",x===y.MAP?c.displayViewMat3:c.displayMat3),L.setUniformMatrix3fv("u_displayMat3",I===g.VIEWPORT?c.displayMat3:c.displayViewMat3),L.setUniform2fv("u_iconTranslation",T),L.setUniform1f("u_depth",t.z),L.setUniform1f("u_mapRotation",h(c.rotation)),L.setUniform1f("u_keepUpright",D?1:0),L.setUniform1f("u_level",10*o),L.setUniform1i("u_texture",i),L.setUniform1f("u_fadeDuration",E/1e3),w&&L.setUniform4fv("u_id",r);let A=-1;for(const i of a){if(!i.layerData.has(d))continue;if(i.key.level!==A&&(A=i.key.level,M.setDataUniforms(L,o,t,A,u)),v=i.layerData.get(d),0===v.iconPerPageElementsMap.size)continue;v.prepareForRendering(n),v.updateOpacityInfo();const a=v.iconVAO;if(null!=a){n.bindVAO(a),L.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),L.setUniform1f("u_time",(performance.now()-v.lastOpacityUpdate)/1e3);for(const[t,a]of v.iconPerPageElementsMap)this._renderIconRange(e,L,a,t,i)}}}_renderIconRange(e,t,a,r,n){const{context:s,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(r)/4,this._spritesTextureSize[1]=o.getHeight(r)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(s,u.LINEAR,r,i),s.setStencilTestEnabled(!0),s.setStencilFunction(c.GREATER,255,255),s.setStencilWriteMask(0),s.drawElements(d.TRIANGLES,a[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),n.triangleCount+=a[1]/3}_drawText(e,t,a,i){const{context:r,displayLevel:o,drawPhase:l,glyphMosaic:f,painter:u,pixelRatio:d,spriteMosaic:p,state:m,styleLayerUID:M,requestRender:v,allowDelayedRender:P}=e,T=t.textMaterial,I=u.vectorTilesMaterialManager;let x,R=!1;for(const e of a)if(e.layerData.has(M)&&(x=e.layerData.get(M),x.glyphPerPageElementsMap.size>0)){R=!0;break}if(!R)return;const D=t.getPaintProperty("text-opacity");if(D&&!D.isDataDriven&&0===D.getValue(o))return;const S=t.getPaintProperty("text-color"),w=!S||S.isDataDriven||S.getValue(o)[3]>0,V=t.getPaintProperty("text-halo-width"),L=t.getPaintProperty("text-halo-color"),A=(!V||V.isDataDriven||V.getValue(o)>0)&&(!L||L.isDataDriven||L.getValue(o)[3]>0);if(!w&&!A)return;let N=t.getLayoutValue("text-rotation-alignment",o);N===y.AUTO&&(N=t.getLayoutValue("symbol-placement",o)===_.POINT?y.VIEWPORT:y.MAP);const O=N===y.MAP,b=t.getLayoutValue("text-keep-upright",o)&&O,z=l===s.HITTEST,k=.8*3/d;this._glyphTextureSize||(this._glyphTextureSize=U(f.width/4,f.height/4));const G=t.getPaintValue("text-translate",o),C=t.getPaintValue("text-translate-anchor",o),F=this._sdfProgramOptions;F.id=z;const W=I.getMaterialProgram(r,T,F);if(P&&null!=v&&!W.compiled)return void v();r.useProgram(W),W.setUniformMatrix3fv("u_displayViewMat3",N===y.MAP?m.displayViewMat3:m.displayMat3),W.setUniformMatrix3fv("u_displayMat3",C===g.VIEWPORT?m.displayMat3:m.displayViewMat3),W.setUniform2fv("u_textTranslation",G),W.setUniform1f("u_depth",t.z+152587890625e-16),W.setUniform2fv("u_mosaicSize",this._glyphTextureSize),W.setUniform1f("u_mapRotation",h(m.rotation)),W.setUniform1f("u_keepUpright",b?1:0),W.setUniform1f("u_level",10*o),W.setUniform1i("u_texture",n),W.setUniform1f("u_antialiasingWidth",k),W.setUniform1f("u_fadeDuration",E/1e3),z&&W.setUniform4fv("u_id",i);let j=-1;for(const e of a){if(!e.layerData.has(M))continue;if(e.key.level!==j&&(j=e.key.level,T.setDataUniforms(W,o,t,j,p)),x=e.layerData.get(M),0===x.glyphPerPageElementsMap.size)continue;x.prepareForRendering(r),x.updateOpacityInfo();const a=x.textVAO;if(null==a)continue;r.bindVAO(a),W.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),r.setStencilTestEnabled(!0),r.setStencilFunction(c.GREATER,255,255),r.setStencilWriteMask(0);const i=(performance.now()-x.lastOpacityUpdate)/1e3;W.setUniform1f("u_time",i),x.glyphPerPageElementsMap.forEach(((t,a)=>{this._renderGlyphRange(r,t,a,f,W,A,w,e)}))}}_renderGlyphRange(e,t,a,i,r,s,o,l){i.bind(e,u.LINEAR,a,n),s&&(r.setUniform1f("u_halo",1),e.drawElements(d.TRIANGLES,t[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),o&&(r.setUniform1f("u_halo",0),e.drawElements(d.TRIANGLES,t[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}}export{v as W,P as a,x as b,R as c,T as d,D as e};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"./typedArrayUtil.js";import e from"../renderers/PointCloudClassBreaksRenderer.js";import r from"../renderers/PointCloudStretchRenderer.js";import o from"../renderers/PointCloudUniqueValueRenderer.js";import{c as t,a as l,d as n,r as s}from"./I3SBinaryReader.js";function a(t,l,n,s){const{rendererJSON:a,isRGBRenderer:i}=t;let u=null,c=null;if(l&&i)u=l;else if(l&&"pointCloudUniqueValueRenderer"===a?.type){c=o.fromJSON(a);const e=c.colorUniqueValueInfos;u=new Uint8Array(3*s);const r=d(c.fieldTransformType);for(let o=0;o<s;o++){const t=(r?r(l[o]):l[o])+"";for(let r=0;r<e.length;r++)if(e[r].values.includes(t)){u[3*o]=e[r].color.r,u[3*o+1]=e[r].color.g,u[3*o+2]=e[r].color.b;break}}}else if(l&&"pointCloudStretchRenderer"===a?.type){c=r.fromJSON(a);const e=c.stops;u=new Uint8Array(3*s);const o=d(c.fieldTransformType);for(let r=0;r<s;r++){const t=o?o(l[r]):l[r],n=e.length-1;if(t<e[0].value)u[3*r]=e[0].color.r,u[3*r+1]=e[0].color.g,u[3*r+2]=e[0].color.b;else if(t>=e[n].value)u[3*r]=e[n].color.r,u[3*r+1]=e[n].color.g,u[3*r+2]=e[n].color.b;else for(let o=1;o<e.length;o++)if(t<e[o].value){const l=(t-e[o-1].value)/(e[o].value-e[o-1].value);u[3*r]=e[o].color.r*l+e[o-1].color.r*(1-l),u[3*r+1]=e[o].color.g*l+e[o-1].color.g*(1-l),u[3*r+2]=e[o].color.b*l+e[o-1].color.b*(1-l);break}}}else if(l&&"pointCloudClassBreaksRenderer"===a?.type){c=e.fromJSON(a);const r=c.colorClassBreakInfos;u=new Uint8Array(3*s);const o=d(c.fieldTransformType);for(let e=0;e<s;e++){const t=o?o(l[e]):l[e];for(let o=0;o<r.length;o++)if(t>=r[o].minValue&&t<=r[o].maxValue){u[3*e]=r[o].color.r,u[3*e+1]=r[o].color.g,u[3*e+2]=r[o].color.b;break}}}else u=new Uint8Array(3*s).fill(255);if(n&&c&&c.colorModulation){const e=c.colorModulation.minValue,r=c.colorModulation.maxValue,o=.3;for(let t=0;t<s;t++){const l=n[t],s=l>=r?1:l<=e?o:o+(1-o)*(l-e)/(r-e);u[3*t]=s*u[3*t],u[3*t+1]=s*u[3*t+1],u[3*t+2]=s*u[3*t+2]}}return u}function i(e,r){if(null==e.encoding||""===e.encoding){const o=t(r,e);if(null==o.vertexAttributes.position)return;const n=l(r,o.vertexAttributes.position),s=o.header.fields,a=[s.offsetX,s.offsetY,s.offsetZ],i=[s.scaleX,s.scaleY,s.scaleZ],u=n.length/3,c=new Float64Array(3*u);for(let e=0;e<u;e++)c[3*e]=n[3*e]*i[0]+a[0],c[3*e+1]=n[3*e+1]*i[1]+a[1],c[3*e+2]=n[3*e+2]*i[2]+a[2];return c}if("lepcc-xyz"===e.encoding)return n(r).result}function u(e,r,o){return null!=e&&e.attributeInfo.useElevation?r?c(r,o):null:null!=e&&e.attributeInfo.storageInfo?s(e.attributeInfo.storageInfo,e.buffer,o):null}function c(e,r){const o=new Float64Array(r);for(let t=0;t<r;t++)o[t]=e[3*t+2];return o}function f(e,r,o,t,l){const n=e.length/3;let s=0;for(let a=0;a<n;a++){let n=!0;for(let e=0;e<t.length&&n;e++){const{filterJSON:r}=t[e],o=l[e].values[a];switch(r.type){case"pointCloudValueFilter":{const e="exclude"===r.mode;r.values.includes(o)===e&&(n=!1);break}case"pointCloudBitfieldFilter":{const e=p(r.requiredSetBits),t=p(r.requiredClearBits);(o&e)===e&&0==(o&t)||(n=!1);break}case"pointCloudReturnFilter":{const e=15&o,t=o>>>4&15,l=t>1,s=1===e,a=e===t;let i=!1;for(const e of r.includedReturns)if("last"===e&&a||"firstOfMany"===e&&s&&l||"lastOfMany"===e&&a&&l||"single"===e&&!l){i=!0;break}i||(n=!1);break}}}n&&(o[s]=a,e[3*s]=e[3*a],e[3*s+1]=e[3*a+1],e[3*s+2]=e[3*a+2],r[3*s]=r[3*a],r[3*s+1]=r[3*a+1],r[3*s+2]=r[3*a+2],s++)}return s}function d(e){switch(e){default:case null:case"none":return e=>e;case"low-four-bit":return e=>15&e;case"high-four-bit":return e=>(240&e)>>4;case"absolute-value":return e=>Math.abs(e);case"modulo-ten":return e=>e%10}}function p(e){let r=0;for(const o of e||[])r|=1<<o;return r}export{c as a,a as e,f,u as g,i as r};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{L as e}from"./Logger.js";import{c as t}from"./mathUtils.js";import{b as s}from"./screenUtils.js";import{k as r}from"./vec2.js";import{s as i,b as o,i as a,e as n,a as l,c as p,l as u,z as c,d as h}from"./vec3.js";import{c as f}from"./vec3f64.js";import{O as d}from"./vec4f64.js";import{P as m}from"./frustum.js";import{c as g,d as S,f as _,a as P}from"./lineSegment.js";import{c as A,d as O,s as T,n as v}from"./plane.js";import{B as E,e as j}from"./BufferView.js";import{S as b}from"./ShaderOutput.js";import{i as N,s as C,c as x,d as y,D as R,G as I,w as L}from"./DefaultBufferWriter.js";import{D as w,b as V,M}from"./Material.js";import{R as U}from"./RenderSlot.js";import{i as D}from"./Util2.js";import{V as B}from"./VertexAttribute.js";import{b as W,c as q}from"./TriangleMaterial.js";import{S as H,P as X,R as z}from"./Program2.js";import{N as F}from"./NativeLine.glsl.js";import{f as G,e as k}from"./enums3.js";import{s as Q,m as Z,a as J,d as K}from"./renderState.js";import{_ as Y}from"./tslib.es6.js";import{p as $}from"./ShaderTechniqueConfiguration.js";import{D as ee}from"./DefaultTechniqueConfiguration.js";class te extends H{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==b.Highlight}initializeProgram(e){return new X(e.rctx,te.shader.get().build(this.configuration),w)}initializePipeline(){const e=this.configuration,t=Q(G.SRC_ALPHA,G.ONE,G.ONE_MINUS_SRC_ALPHA,G.ONE_MINUS_SRC_ALPHA),s=(t,s=null,r=null)=>Z({blending:s,depthTest:N,depthWrite:r,colorWrite:J,stencilWrite:e.hasOccludees?C:null,stencilTest:e.hasOccludees?t?x:y:null});return e.output===b.Color?(this._occludeePipelineState=s(!0,e.transparent||this._stippleEnabled?t:null,K),s(!1,e.transparent||this._stippleEnabled?t:null,K)):s(!1)}get primitiveType(){return k.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}te.shader=new z(F,(()=>import("./NativeLine.glsl.js").then((e=>e.N))));class se extends ee{constructor(){super(...arguments),this.output=b.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}}var re;Y([$({count:b.COUNT})],se.prototype,"output",void 0),Y([$()],se.prototype,"hasSlicePlane",void 0),Y([$()],se.prototype,"hasVertexColors",void 0),Y([$()],se.prototype,"transparent",void 0),Y([$()],se.prototype,"draped",void 0),Y([$()],se.prototype,"stippleEnabled",void 0),Y([$()],se.prototype,"stippleOffColorEnabled",void 0),Y([$()],se.prototype,"stipplePreferContinuous",void 0),Y([$()],se.prototype,"hasOccludees",void 0),Y([$({constValue:!1})],se.prototype,"stippleRequiresClamp",void 0),Y([$({constValue:!1})],se.prototype,"stippleScaleWithLineWidth",void 0),Y([$({constValue:!1})],se.prototype,"stippleRequiresStretchMeasure",void 0),function(e){e[e.START=0]="START",e[e.END=1]="END"}(re||(re={}));class ie extends V{constructor(e){super(e,new ne),this._configuration=new se}getConfiguration(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===U.DRAPED_MATERIAL;const s=null!=this.parameters.stipplePattern;return this._configuration.stippleEnabled=s,this._configuration.stippleOffColorEnabled=s&&null!=this.parameters.stippleOffColor,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(t,s,h,f,d,g){if(!h.options.selectionMode||!t.visible)return;if(!D(s))return void e.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const A=t.vertexAttributes.get(B.POSITION).data,E=h.camera,j=_e;r(j,h.point),i(Pe[0],j[0]-2,j[1]+2,0),i(Pe[1],j[0]+2,j[1]+2,0),i(Pe[2],j[0]+2,j[1]-2,0),i(Pe[3],j[0]-2,j[1]-2,0);for(let e=0;e<4;e++)if(!E.unprojectFromRenderScreen(Pe[e],Ae[e]))return;O(E.eye,Ae[0],Ae[1],Oe),O(E.eye,Ae[1],Ae[2],Te),O(E.eye,Ae[2],Ae[3],ve),O(E.eye,Ae[3],Ae[0],Ee);let b=Number.MAX_VALUE,N=0;for(let e=0;e<A.length-5;e+=3){if(le[0]=A[e]+s[12],le[1]=A[e+1]+s[13],le[2]=A[e+2]+s[14],pe[0]=A[e+3]+s[12],pe[1]=A[e+4]+s[13],pe[2]=A[e+5]+s[14],T(Oe,le)<0&&T(Oe,pe)<0||T(Te,le)<0&&T(Te,pe)<0||T(ve,le)<0&&T(ve,pe)<0||T(Ee,le)<0&&T(Ee,pe)<0)continue;if(E.projectToRenderScreen(le,he),E.projectToRenderScreen(pe,fe),he[2]<0&&fe[2]>0){o(ue,le,pe);const e=E.frustum,t=-T(e[m.NEAR],le)/a(ue,v(e[m.NEAR]));n(ue,ue,t),l(le,le,ue),E.projectToRenderScreen(le,he)}else if(he[2]>0&&fe[2]<0){o(ue,pe,le);const e=E.frustum,t=-T(e[m.NEAR],pe)/a(ue,v(e[m.NEAR]));n(ue,ue,t),l(pe,pe,ue),E.projectToRenderScreen(pe,fe)}else if(he[2]<0&&fe[2]<0)continue;he[2]=0,fe[2]=0;const t=S(_(he,fe,ge),j);t<b&&(b=t,p(de,le),p(me,pe),N=e/3)}const C=h.rayBegin,x=h.rayEnd;if(b<4){let e=Number.MAX_VALUE;if(P(_(de,me,ge),_(C,x,Se),ce)){o(ce,ce,C);const t=u(ce);n(ce,ce,1/t),e=t/c(C,x)}g(e,ce,N,!1)}}intersectDraped(e,s,r,i,o,a){if(!r.options.selectionMode)return;const n=e.vertexAttributes.get(B.POSITION).data,l=e.vertexAttributes.get(B.SIZE),p=l?l.data[0]:0,u=i[0],c=i[1],h=((p+1)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,d=0;for(let e=0;e<n.length-5;e+=3){const s=n[e],r=n[e+1],i=u-s,o=c-r,a=n[e+3]-s,l=n[e+4]-r,p=t((a*i+l*o)/(a*a+l*l),0,1),h=a*p-i,m=l*p-o,g=h*h+m*m;g<f&&(f=g,d=e/3)}f<h*h&&o(a.dist,a.normal,d,!1)}requiresSlot(e,t){return!(t!==b.Color&&t!==b.Highlight&&t!==b.ObjectAndLayerIdColor||e!==U.OPAQUE_MATERIAL&&e!==U.DRAPED_MATERIAL)}createGLMaterial(e){return new oe(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?W:q;return null==this.parameters.stipplePattern?new R(e):new ae(e.clone().vec3f(B.AUXPOS1).vec2f(B.UV0))}}class oe extends I{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===b.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(te,e)}}class ae{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.indices.get(B.POSITION).length}write(e,t,s,r,i){L(s,this.vertexBufferLayout,e,t,r,i),this._writeAuxpos1(e,s,r,i),this._writeUV0(e,s,r,i)}_writeAuxpos1(e,t,s,r){const i=s.getField(B.AUXPOS1,E),o=t.indices.get(B.POSITION),a=t.vertexAttributes.get(B.POSITION).data,n=e,l=i.typedBufferStride,p=i.typedBuffer;r*=l;for(let e=0;e<o.length-1;e+=2)for(const t of[1,0]){const s=3*o[e+t],i=a[s],u=a[s+1],c=a[s+2],h=n[0]*i+n[4]*u+n[8]*c+n[12],f=n[1]*i+n[5]*u+n[9]*c+n[13],d=n[2]*i+n[6]*u+n[10]*c+n[14];p[r]=h,p[r+1]=f,p[r+2]=d,r+=l}}_writeUV0(e,t,s,r){const o=s.getField(B.UV0,j),a=t.indices.get(B.POSITION),n=t.vertexAttributes.get(B.POSITION).data,l=t.vertexAttributes.get(B.DISTANCETOSTART)?.data,u=o.typedBufferStride,f=o.typedBuffer;let d=0;f[r*=u]=re.START,f[r+1]=d,r+=u;const m=3*a[0],g=i(le,n[m],n[m+1],n[m+2]);e&&h(g,g,e);const S=pe,_=a.length-1;let P=1;const A=l?(e,t,s)=>d=l[s]:(e,t,s)=>d+=c(e,t);for(let t=1;t<_;t+=2){const s=3*a[t];i(S,n[s],n[s+1],n[s+2]),e&&h(S,S,e),A(g,S,P++);for(let e=0;e<2;++e)f[r]=1-e,f[r+1]=d,r+=u;p(g,S)}const O=3*a[_];i(S,n[O],n[O+1],n[O+2]),e&&h(S,S,e),A(g,S,P),f[r]=re.END,f[r+1]=d}}class ne extends M{constructor(){super(...arguments),this.color=d,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}}const le=f(),pe=f(),ue=f(),ce=f(),he=s(),fe=s(),de=f(),me=f(),ge=g(),Se=g(),_e=f(),Pe=[s(),s(),s(),s()],Ae=[f(),f(),f(),f()],Oe=A(),Te=A(),ve=A(),Ee=A();export{ie as N};

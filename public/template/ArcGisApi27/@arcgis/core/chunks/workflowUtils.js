/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import{c as t}from"./asyncUtils.js";import"./typedArrayUtil.js";import{h as a,b as i}from"./utils.js";import{clone as n}from"../core/lang.js";import{throwIfAborted as r,whenOrAbort as s,eachAlways as l}from"../core/promiseUtils.js";import{watch as o,whenOnce as c}from"../core/reactiveUtils.js";import{p as u}from"./screenUtils.js";import{d as p}from"./diffUtils.js";import{getDisplayFieldName as y}from"../layers/support/fieldUtils.js";import{c as d,a as f}from"./drapedUtils.js";import{m}from"./lengthUtils.js";import{c as h,a as g,T as b,d as w}from"./visualVariableUtils.js";import{s as v,i as S}from"./featureFlags.js";import{t as j}from"../symbols/support/jsonUtils.js";import{getDisplayedSymbol as I}from"../symbols/support/symbolUtils.js";import{G as U}from"./GraphicState.js";import{h as V,f as F}from"./hitTestSelectUtils.js";function L(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!function(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}(t.renderer))return{rotation:null,size:null};let a=null,i=null;const n=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&null!=h(t,e)));1===n.length&&(a=function(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,n=t.fields&&t.fields.filter((e=>e.name===i)),r=n&&1===n.length?n[0].type:"double",s={initial:0,current:0};return{field:i,fieldType:r,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-a*e,T((s.current+360)%360,r)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}(n[0],t));const r=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&g(t)===b.RealWorldSize&&null!=w(t,e)));return 1===r.length&&(i=function(e,t){const a=e.field,i=e.axis,n=t.fields&&t.fields.filter((e=>e.name===a)),r=n&&1===n.length?n[0].type:"double",s={updating:!1,initial:0,current:0},l=m[e.valueUnit]??1;let o;return o="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:a,fieldType:r,getDefault:async(e,t)=>T(o(await async function(e,t,a){if(null==t)return 0;const{symbol:i}=j(t);if(null==i||"web-style"===i.type||"cim"===i.type)return 0;const n=i.symbolLayers.at(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return n.size||Math.min(D.icon,(await e(n,D.icon))[0])||D.icon}case"text":return n.size||D.text;case"line":return n.size||D.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await t(n,e.scale/D.viewScaleSizeFactor),a)}case"path":return(null!=n.width?n.width:n.height)||e.scale/D.viewScaleSizeFactor;case"extrude":return n.size||e.scale/D.viewScaleSizeFactor;default:return 0}}(t,e,i)),r),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,T(s.current,r)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,displayUnit:Q(e.valueUnit),axis:e.axis}}(r[0],t)),{rotation:a,size:i}}function T(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function x(e,t){const a=await I(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t});null!=p(e.symbol,a)&&(e.symbol=a)}async function z(e,t,n,r){await k(e,t,r);const s=e.on("create",(async a=>{if("cancel"===a.state)return k(e,t,r);if("complete"===a.state){const e=a.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template?.prototype.attributes}),await x(e,r),n(e)}}));return a([s,i((()=>e.cancel()))])}async function k(t,a,i){const n=a.layer,r={...a.template?.prototype.attributes};await async function(t,a,i,n){const r=new e({sourceLayer:a,attributes:i}),{rotation:s,size:l}=L(r);let o=await I(r,{useSourceLayer:!0,webStyleCache:n}),c=!1;for(const e of[l,s])null!=e&&null==i[e.field]&&(i[e.field]=await e.getDefault(o,t.view),c=!0);switch(c&&(o=await I(r,{useSourceLayer:!0,webStyleCache:n})),o?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=o;break;case"simple-line":case"line-3d":t.polylineSymbol=o;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=o}E(t.tooltipOptions,l,s)}(t,n,r,i),t.layer.elevationInfo=n.elevationInfo,await t.create(function(e){if(!e)throw new Error("no geometry type");return"multipatch"===e?"mesh":e}(n.geometryType),{graphicProperties:{attributes:r,sourceLayer:n},hasZ:n.capabilities.data.supportsZ,geometryToPlace:a.geometryToPlace??void 0})}function E(e,t,a){e.visualVariables=null!=t||null!=a?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=a?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function A(e,t){return e?e.find((e=>e.layer===t)):void 0}async function O(e,t,a,i){switch(t.type){case"3d":return async function(e,t,a,i){if(0===e.length)return[];const{updatable:n,graphicsByLayer:r}=await a.async((async()=>{const{results:n}=await s(V(t,a),i),r=new Map;F(n).forEach((({graphic:e})=>(e=>{const t=e.layer,a=r.get(t);if(!a){const e=new Array;return r.set(t,e),e}return a})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.includes("update")&&r.has(t)));return 0!==l.length&&a.stopPropagation(),{updatable:l,graphicsByLayer:r}}));return s(l(n.map((async({layer:e})=>{const{objectIdField:t}=e,a="displayField"in e?e.displayField:null,n=[t];null!=a&&e.fieldsIndex.has(a)&&n.push(a);const s=r.get(e);if(s.some((e=>n.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=n,t.returnGeometry=!1,t.objectIds=s.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return s}))),i)}(e,t,a,i);case"2d":return async function(e,t,a,i){if(0===e.length)return[];let n=null;const r=await a.async((async()=>{const{results:r}=await s(t.hitTest(a),i);if(0===r.length)return[];const l=new Set;n=F(r),n.forEach((({graphic:e})=>e&&l.add(e.layer)));const o=e.items.filter((({layer:e,supports:t,attachmentsOnUpdateEnabled:a})=>l.has(e)&&(t.includes("update")||t.includes("delete")||a)));return o.length>0&&a.stopPropagation(),o}));return s(l(r.map((({layer:e})=>{const r=e.objectIdField,s="displayField"in e?e.displayField:null,l=y({displayField:s,fields:e.fields}),o=[r];null!=l&&e.fieldsIndex.has(l)&&o.push(l);const c=e.createQuery();c.outFields=o,c.returnGeometry=!1;const u="renderer"in e?d({renderer:e.renderer,event:a}):0;return c.geometry=f(a.mapPoint,u,t),c.outSpatialReference=t.spatialReference,e.queryFeatures(c,{signal:i}).then((({features:t})=>(n?.forEach((({graphic:a})=>{a.layer!==e||t.some((e=>e.getObjectId()===a.getObjectId()))||t.push(a)})),t)))}))),i)}(e,t,a,i)}}async function M(e,t,a){const{sourceLayer:i}=e,n=i.createQuery();n.objectIds=[e.getAttribute(i.objectIdField)],n.outFields=["*"],n.outSpatialReference=t,n.returnM=i.capabilities.data.supportsM,n.returnZ=i.capabilities.data.supportsZ,v()&&S()&&"scene"===i.type&&null!=i.infoFor3D&&(n.returnGeometry=!0,n.formatOf3DObjects="3D_glb");const s=await i.queryFeatures(n,{signal:a});return r(a),s.features[0]}async function G(e){const{graphic:t,sketchViewModel:a,sourceLayer:i,visualVariables:n,webStyleCache:r}=e;let s=!1;const{rotation:l,size:o}=n;[l,o].forEach((async e=>{if(null==e)return;const i=t.getAttribute(e.field);if(null!=i)e.initValue(i);else{const i=await e.getDefault(t.symbol,a.view);e.initValue(i),t.setAttribute(e.field,i),s=!0}})),s&&await x(t,r);const c={multipleSelectionEnabled:!1};return"point"===i.geometryType&&(c.enableRotation=null!=l,c.enableScaling=null!=o),E(a.tooltipOptions,o,l),a.layer.elevationInfo=i.elevationInfo,a.update(t,c)}async function C(e,t,a,i,n){if(null==t.geometry||"point"!==t.geometry?.type)return;const r=i.rotation,s=null==(l=a.toolEventInfo)||"rotate-start"!==l.type&&"rotate"!==l.type&&"rotate-stop"!==l.type?null:l;var l;if(null!=r&&null!=s)if("rotate-stop"===s.type)r.isUpdatingInteractively=!1,r.initValue();else{r.isUpdatingInteractively=!0;const{field:a,getValue:i}=r;t.setAttribute(a,i(s.angle,e))}const o=i.size,c=function(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(a.toolEventInfo);if(null!=o&&null!=c)if("scale-stop"===c.type)o.isUpdatingInteractively=!1,o.initValue();else{o.isUpdatingInteractively=!0;const{field:a,getValue:i}=o;t.setAttribute(a,i(c.xScale,e))}await x(t,n)}async function R(e,n,s,l,u,p){const y=K(e);await x(y,p),l.map.add(s.layer),s.layer.add(y);const d=e.sourceLayer,f=H(l,d);await async function(e,t){if("3d"===e.type){const a=new U({graphic:t}),i=e.trackGraphicState(a);await c((()=>a.displaying)),i.remove()}else await c((()=>t.visible))}(l,y),await G({graphic:y,sketchViewModel:s,sourceLayer:d,visualVariables:n,webStyleCache:p});const m=function(e,n,s){const l=e.view,o=n.sourceLayer,u=n.layer,p=n.getAttribute(u.objectIdField);let y=null;function d(e){y?.abort(),y=t((async t=>{const a=await H(l,o);r(t),a.setVisibility?.(p,e)}))}return d(!1),a([P(l,s,(e=>d(!e))),i((async()=>{d(!0);const t=await H(l,o);await c((()=>!t.updating)),e.layer.remove(s)}))])}(s,e,y);let h=null;f.then((e=>h=e)).catch((()=>{}));const g=n.size,b=n.rotation,w=o((()=>e.attributes),(async e=>{let t=!1;for(const a in e){const i=e[a];i!==y.getAttribute(a)&&(y.setAttribute(a,i),null==g||g.isUpdatingInteractively||g.field!==a||g.initValue(i),null==b||b.isUpdatingInteractively||b.field!==a||b.initValue(i),(null==h||h.requiredFields.includes(a))&&(t=!0))}t&&await x(y,p)})),v=s.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return G({graphic:t,sketchViewModel:s,sourceLayer:d,visualVariables:n,webStyleCache:p});await C(l,t,e,n,p),u(K(t),e)})),S=s.on(["undo","redo"],(async e=>{u(K(e.graphics[0]),e)})),j=s.updateOnGraphicClick;return{visual:a([m,i((()=>{s.updateOnGraphicClick=j}))]),interactive:a([S,v,i((()=>s.cancel())),w,i((()=>{s.updateOnGraphicClick=!1}))])}}function P(e,t,i){if("3d"===e.type){const n=new U({graphic:t});return a([e.trackGraphicState(n),o((()=>n.displaying),i)])}return o((()=>t.visible),i)}const D={icon:u(24),text:u(12),line:u(1),viewScaleSizeFactor:100};function q(e,t,a){let i=!1;return e.filter((e=>!!i||(i=e===t,i))).map((e=>a[e]()))}function Z(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const a=function(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}(e.viewModel.featureTemplatesViewModel.items);null==a||a.supportsUpload||(e.creationInfo=a,t.shift())}return t}function Q(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function B(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}function W(e){const{creationInfo:t,viewModel:a}=e;if(!t)return!1;const{layer:i}=t,n=a.editableItems.find((e=>e.layer===i));if(n)return n.attachmentsOnCreateEnabled;const r=i.capabilities?.data,s=a.layerInfos?.find((e=>e.layer===i));return!(!(r&&"supportsAttachment"in r&&r.supportsAttachment)||s&&(!1===s.allowAttachments||!1===s.attachmentsOnUpdateEnabled))}const _=e=>/-stop/.test(e)||/vertex-/.test(e),H=(e,t)=>{const a="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(a)};function J(e){return"createInteractiveEditSession"in e}function K(e){const t=e.geometry;if("mesh"===t?.type){const a=e.cloneShallow();return a.attributes=n(e.attributes),a.geometry=t.cloneShallow(),a.geometry.transform=t.transform?.clone()??null,a}return e.clone()}function N(e){const t=e.cursor;return e.cursor="progress",i((()=>e.cursor=t))}export{W as a,k as b,G as c,q as d,Z as e,A as f,L as g,z as h,_ as i,M as j,J as k,R as l,O as m,B as p,N as s,x as u,C as v,H as w};

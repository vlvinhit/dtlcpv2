/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import s from"../core/Error.js";import"./typedArrayUtil.js";import{L as o}from"./Logger.js";import{L as r}from"./LRUCache.js";import{isAbortError as i}from"../core/promiseUtils.js";import{n}from"./string.js";import{V as l}from"./Version.js";import a from"../layers/support/FieldsIndex.js";import{l as m,c}from"./arcadeOnDemand.js";import p from"../symbols/CIMSymbol.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"./ensureType.js";import"../config.js";import"./object.js";import"../core/lang.js";import"../kernel.js";import"../core/urlUtils.js";import"./maybe.js";import"./MemCache.js";import"./PooledArray.js";import"../layers/support/fieldUtils.js";import"../geometry.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./enumeration.js";import"../symbols/Symbol.js";const y="esri.renderers.support.DictionaryLoader",u={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class f{constructor(t,e,s){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new r(100),this._dictionaryVersion=null,this._fieldIndex=null,this._dictionaryPromise=null,this.url=t,this.config=e,this.fieldMap=s}getSymbolFields(){return this._symbolFields}async getSymbolAsync(e,s){let o;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{o=await this._dictionaryPromise}catch(t){if(i(t))return this._dictionaryPromise=null,null}const r=this._dictionaryVersion&&this._dictionaryVersion.since(4,0),l={};if(this.fieldMap)for(const t of this._symbolFields){const s=this._getFieldName(this.fieldMap[t]);l[t]=s?r?e.attributes[s]:""+e.attributes[s]:""}let a=null;try{a=o?.(l,s)}catch(t){return null}if(!a||"string"!=typeof a)return null;const m=n(a).toString(),c=this._symbolCache.get(m);if(c)return c.catch((()=>{this._symbolCache.pop(m)})),c;const p=a.split(";"),y=[],u=[];for(const e of p)if(e)if(e.includes("po:")){const s=e.substr(3).split("|");if(3===s.length){const e=s[0],o=s[1];let r=s[2];if("DashTemplate"===o)r=r.split(" ").map((t=>Number(t)));else if("Color"===o){const e=new t(r).toRgba();r=[e[0],e[1],e[2],255*e[3]]}else r=Number(r);u.push({primitiveName:e,propertyName:o,value:r})}}else if(e.includes("|")){for(const t of e.split("|"))if(this._itemNames.has(t)){y.push(t);break}}else this._itemNames.has(e)&&y.push(e);const f=null==e.geometry||!e.geometry.hasZ&&"point"===e.geometry.type,h=this._cimPartsToCIMSymbol(y,u,f,s);return this._symbolCache.put(m,h,1),h}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void o.getLogger(y).error("no valid URL!");const r=e(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:null!=t?t.signal:null}),[{data:i}]=await Promise.all([r,m()]);if(!i)throw this._dictionaryPromise=null,new s("esri.renderers.DictionaryRenderer","Bad dictionary data!");const{authoringInfo:n,dictionary_version:p,expression:u,itemsNames:f}=i,h=u;let d=!1;p&&(this._dictionaryVersion=l.parse(p),d=this._dictionaryVersion.since(4,0)),this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(f),this._symbolFields=n.symbol;const j={};if(this.config){const t=this.config;for(const e in t)j[e]=t[e]}if(n.configuration)for(const t of n.configuration)j.hasOwnProperty(t.name)||(j[t.name]=t.value);const g=[];if(null!=t&&t.fields&&this.fieldMap)for(const e of this._symbolFields){const s=this.fieldMap[e],o=t.fields.filter((t=>t.name.toLowerCase()===s?.toLowerCase()));o.length>0&&g.push({...o[0],type:d?o[0].type:"esriFieldTypeString"})}g.length>0&&(this._fieldIndex=new a(g));const b=c(h,null!=t?t.spatialReference:null,g,j).then((t=>{const e={scale:0};return(s,o)=>{if(null==t)return null;const r=t.repurposeFeature({geometry:null,attributes:s});return e.scale=null!=o?o.scale??void 0:void 0,t.evaluate({$feature:r,$view:e},t.services)}})).catch((t=>(o.getLogger(y).error("Creating dictinoary expression failed:",t),null)));return this._dictionaryPromise=b,b}async _cimPartsToCIMSymbol(t,e,s,o){const r=new Array(t.length);for(let e=0;e<t.length;e++)r[e]=this._getSymbolPart(t[e],o);const i=await Promise.all(r),n=this.fieldMap;if(n)for(const t of i)h(t,n);return new p({data:this._combineSymbolParts(i,e,s)})}async _getSymbolPart(t,s){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then((t=>t.data));const o=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,t),r=e(o,{responseType:"json",query:{f:"json"},...s});this._ongoingRequests.set(t,r);try{return(await r).data}catch(e){throw this._ongoingRequests.delete(t),e}}_combineSymbolParts(t,e,s){if(!t||0===t.length)return null;const o={...t[0]};if(t.length>1){o.symbolLayers=[];for(const e of t){const t=e;o.symbolLayers.unshift(...t.symbolLayers)}}return s&&(o.callout=u),{type:"CIMSymbolReference",symbol:o,primitiveOverrides:e}}_getFieldName(t){if(null!==this._fieldIndex){const e=this._fieldIndex.get(t);return e?e.name:t}return t}}function h(t,e){if(!t)return;const s=t.symbolLayers;if(!s)return;let o=s.length;for(;o--;){const t=s[o];t&&!1!==t.enable&&"CIMVectorMarker"===t.type&&d(t,e)}}function d(t,e){const s=t.markerGraphics;if(s)for(const t of s){if(!t)continue;const s=t.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":h(s,e);break;case"CIMTextSymbol":s.fieldMap=e}}}export{f as DictionaryLoader};

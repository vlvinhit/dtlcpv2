/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{v as t,w as s,G as n,V as r}from"./unitUtils.js";import{e as i}from"./layerUtils.js";import{V as o}from"./ViewingMode.js";import{_ as a}from"./tslib.es6.js";import l from"../request.js";import u from"../core/Accessor.js";import{r as c}from"./typedArrayUtil.js";import h from"../core/Error.js";import{clone as f}from"../core/lang.js";import{r as m,b as p,d as T}from"./maybe.js";import{createResolver as d,onAbort as _,createAbortError as g,throwIfAborted as S,isAbortError as E}from"../core/promiseUtils.js";import{property as k}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as O}from"../core/accessorSupport/decorators/subclass.js";import{a as y}from"./Util2.js";import{T as b}from"./Scheduler.js";import{c as W,b as w,i as N,a as L,e as A}from"./vec3.js";import{c as R}from"./vec3f64.js";import{canProjectToWGS84ComparableLonLat as H}from"../geometry/projection.js";import{p as I,q as D,h as U,c as C}from"./aaBoundingRect.js";import{g as x,T as j,M as Q}from"./TerrainConst.js";class v{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class q{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new M}}class M{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class z{constructor(e,t,s,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=n.map((e=>new q(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,y(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}let G=class extends u{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new z(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(b.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=m(this._frameTask),this._tasks.forEach((e=>p(e.abortController))),this._loadQueue=T(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,n={}){const r=d();r.__signal=null!=n?n.signal:null;const i=this._createOrUpdateTask(e,t,s,n,r);return _(n,(()=>this._cancelRequest(i,r))),r.promise}_createTask(e,t,s,n,r,i){const o=new V(e,t,s,n,r);return this._updateTask(o,i),this._tasks.set(r,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){c(e.resolvers,t),t.reject(g()),0===e.resolvers.length&&(e.status===B.DOWNLOADING&&(e.status=B.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=B.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,n,r){const i=function(e,t,s){return`${e}:${t}:${s}`}(null!=n&&n.uid||e,t,s),o=this._tasks.get(i);return o?(this._updateTask(o,r),o):this._createTask(e,n,t,s,i,r)}_doneLoadingCB(e,t){this._loadQueue&&(y(e.status===B.DOWNLOADING),e.status=B.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();S(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==B.DOWNLOADED&&(t.err=t.err||g()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!E(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const n of e.resolvers)if(t)E(t)?n.reject(t):n.reject(new h("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:f(e.result);n.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===B.CANCELLED)return!1;let s,n;switch(e.startTime=performance.now(),e.status=B.DOWNLOADING,e.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=l(e.url,{...e.options,responseType:n,timeout:s,signal:r});let i=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=s=>{e.status===B.DOWNLOADING&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),a),!0):(e.request.then((t=>{const u=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(u);if(n="image",e.size=u.byteLength,"unknown"===c)return e.request=l(e.url,{responseType:n,timeout:s,signal:r}),void e.request.then((e=>o(e.data)),a);const h=new Blob([u],{type:c}),f=window.URL.createObjectURL(h);i=()=>window.URL.revokeObjectURL(f),e.request=l(f,{responseType:n,timeout:s,signal:r}),e.request.then((e=>o(new F(e.data,c,i))),a)}),a),!0)}get test(){return{loadQueue:this._loadQueue}}};a([k({readOnly:!0})],G.prototype,"updating",void 0),G=a([O("esri.views.3d.support.StreamDataLoader")],G);class F{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}class V extends v{constructor(e,t,s,n,r){super(n),this.url=e,this.options=t,this.docType=s,this.key=r,this.result=null,this.status=B.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=0}}var B,P,$;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(B||(B={})),function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(P||(P={})),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}($||($={}));const J=R(),K=R(),X=R(),Y=R();function Z(e,t,s,n){W(J,s),J[n]=t[n];const r=w(J,J,t),i=w(K,e,t),o=N(i,r),a=N(r,r);let l;l=o<=0?t:a<=o?s:L(J,t,A(r,r,o/a));const u=w(J,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const ee=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,s){if(null==e)return x();if(e.spatialReference.isGeographic&&!H(e.spatialReference))return new h("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=j.checkUnsupported(e);if(null!=n)return n;if(null==s)return new h("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const r=function(e,t){const s=e.lods,n=s[0].resolution*2**s[0].level,r=[n*e.size[0],n*e.size[1]],i=[e.origin.x,e.origin.y],o=U(t),a=C();j.computeRowColExtent(o,r,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>Q){const t=s[0].scale*2**s[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/n;const i=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**i)*10**i,new h("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:l,allowedNumRootTiles:Q})}return null}(e,s);if(r)return r;const i=e.spatialReference;return null==t||i.equals(t)||t.isWGS84&&i.isWebMercator?null:new h("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene")},isInsideExtent:function(e,t,s=0){const n=e.extent;if(null==n)return!1;if(0===s)return I(n,t);const r=Math.min(n[2]-n[0],n[3]-n[1]);return D(n,t,s*r)},tiltToExtentEdge:function(e,t,s){const n=e.extent;if(null==n)return 0;X[0]=n[0],X[1]=n[1],X[2]=s,Y[0]=n[2],Y[1]=n[3],Y[2]=s;let r=1/0,i=1/0;return t[0]<X[0]?r=Z(t,X,Y,0):t[0]>Y[0]&&(r=Z(t,Y,X,0)),t[1]<X[1]?i=Z(t,X,Y,1):t[1]>Y[1]&&(i=Z(t,Y,X,1)),Math.min(r,i)}},Symbol.toStringTag,{value:"Module"})),te=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,n){if(null==e)return x();const r=e.lods.length-1,i=e.spatialReference,o=H(i)||t(i)||s(i);if(i.isWebMercator){if(!j.makeWebMercatorAuxiliarySphere(r).compatibleWith(e))return new h("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!o)return new h("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!j.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e))return e.spatialReference.isWGS84?new h("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new h("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==n||e.spatialReference.equals(n)?void 0:new h("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),se={[o.Global]:te,[o.Local]:ee};function ne(e,t){e||console.warn("Terrain: "+t)}let re=!1,ie=!1;function oe(e){ie=e,re=re||e}function ae(e){re=e}function le(e,t){if(re&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function ue(e){return he(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function ce(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function he(e){return"imagery-tile-3d"===e?.type}function fe(e){return"tile-3d"===e?.type}function me(e){return"vector-tile-3d"===e?.type}function pe(e){return"wmts-3d"===e?.type}function Te(e){return"elevation-3d"===e?.type}function de(e){return"group"===e?.type}function _e(e){return e&&(fe(e)||pe(e)||he(e)||me(e))}function ge(e){return e&&(fe(e)||he(e)||me(e)||pe(e))}function Se(e){return ge(e)||Te(e)}function Ee(e){const t=e?.sourceLayerInfo?.data;return null!=t&&"type"in t&&"raster-tile"===t.type}function ke(e){return be(e?.sourceLayerInfo)}function Oe(e){const t=e?.sourceLayerInfo?.data;return null!=t&&"type"in t&&"tile-texture"===t.type}function ye(e){const t=e?.sourceLayerInfo?.data;return t instanceof HTMLImageElement||t instanceof F||t instanceof HTMLCanvasElement||t instanceof ImageData}function be(e){return null!=e?.data&&"type"in e.data&&"vector-tile"===e.data.type}function We(e){return null!=e&&"release"in e&&e.release(),null}function we(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Ne(e,t,s,n){return se[n].checkIfTileInfoSupportedForViewSR(e,s,t)}function Le(e,t,s){let n=null,r=null;if("wmts"===e?.type){const i=Ae(e,t,s);n=i.tileInfo,r=i.fullExtent}else{r=ce(e)?e.getCompatibleFullExtent(t):e.fullExtent;const i=s===o.Local;if(ce(e))n=e.getCompatibleTileInfo(t,r,i);else if("vector-tile"===e?.type){const s=i&&!Re(t)||He.force512VTL,r=e.tileInfo.spatialReference.isGeographic;n=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,r?1:2)}else n=e.tileInfo}return null!=n&&null!=r&&null==Ne(n,r,t,s)?{tileInfo:n,fullExtent:r}:null}function Ae(t,s,n){const r=i(t);if(null!=r){if(!e.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const e=r.find((e=>null==Ne(e.tileInfo,e.fullExtent,s,n)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Re(e){return e.isWGS84||e.isWebMercator||n(e)||!r(e)}const He={force512VTL:!1};function Ie(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function De(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function Ue(e,t,s=Ve){return Math.abs(e-t)<s}function Ce(e){return e===$.NORTH_EAST?$.SOUTH_WEST:e===$.NORTH_WEST?$.SOUTH_EAST:e===$.SOUTH_WEST?$.NORTH_EAST:$.NORTH_WEST}function xe(e){return e===$.NORTH?$.SOUTH:e===$.EAST?$.WEST:e===$.SOUTH?$.NORTH:$.EAST}function je(e){return e===$.NORTH_WEST||e===$.SOUTH_WEST}function Qe(e){return e===$.NORTH_WEST||e===$.NORTH_EAST}function ve(e){return e===$.NORTH_WEST||e===$.WEST||e===$.SOUTH_WEST}function qe(e){return e===$.NORTH_EAST||e===$.EAST||e===$.SOUTH_EAST}function Me(e){return e===$.SOUTH_EAST||e===$.SOUTH||e===$.SOUTH_WEST}function ze(e){return e===$.NORTH_EAST||e===$.NORTH||e===$.NORTH_WEST}const Ge=[$.NORTH,$.EAST,$.SOUTH,$.WEST],Fe=[$.NORTH_EAST,$.SOUTH_EAST,$.SOUTH_WEST,$.NORTH_WEST],Ve=1e-5;export{Oe as A,be as B,de as C,ge as D,re as E,Te as F,we as G,he as H,F as I,fe as J,ae as K,oe as L,Ne as M,$ as N,Ae as O,Re as P,He as Q,G as S,P as T,ce as a,le as b,ue as c,_e as d,Ge as e,xe as f,Le as g,ze as h,Se as i,Me as j,ve as k,qe as l,ie as m,Fe as n,Ce as o,je as p,Qe as q,We as r,Ue as s,Ie as t,me as u,De as v,ne as w,ke as x,Ee as y,ye as z};

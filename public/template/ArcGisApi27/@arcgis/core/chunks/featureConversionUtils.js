/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{L as t}from"./Logger.js";import{g as o}from"./maybe.js";import{i as n,a as r}from"./aaBoundingBox.js";import{f as s}from"./aaBoundingRect.js";import{isPoint as u,isPolygon as l,isPolyline as c,isMultipoint as i}from"../geometry/support/jsonUtils.js";import{O as a}from"./OptimizedFeature.js";import{O as f}from"./OptimizedFeatureSet.js";import{O as d}from"./OptimizedGeometry.js";function h(e,t){return e?t?4:3:t?3:2}const m=t.getLogger("esri.layers.graphics.featureConversionUtils"),g={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},y=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s},p=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2]},b=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+3]},w=(e,t,o,n,r,s)=>{e[o]=r,e[o+1]=s,e[o+2]=t[n+2],e[o+3]=t[n+3]};function G(e,t,o,n){if(e){if(o)return t&&n?w:p;if(t&&n)return b}else if(t&&n)return p;return y}function I({scale:e,translate:t},o){return Math.round((o-t[0])/e[0])}function M({scale:e,translate:t},o){return Math.round((t[1]-o)/e[1])}function T({scale:e,translate:t},o,n){return o*e[n]+t[n]}function N(e,t,o){return e?t?o?v(e):j(e):o?Z(e):P(e):null}function P(e){const t=e.coords;return{x:t[0],y:t[1]}}function F(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function j(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function x(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function Z(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function k(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function v(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function E(e,t){return e&&t?z:e?x:t?k:F}function L(e,t,o,n,r){const s=E(o,n);for(const{geometry:o,attributes:n}of t){const t=null!=o?s(new d,o):null;e.push(new a(t,n,null,r?n[r]:void 0))}return e}function O(e,t,o=E(null!=t.z,null!=t.m)){return o(e,t)}function U(e,t,o){if(null==e)return null;const n=h(t,o),r=[];for(let t=0;t<e.coords.length;t+=n){const o=[];for(let r=0;r<n;r++)o.push(e.coords[t+r]);r.push(o)}return t?o?{points:r,hasZ:t,hasM:o}:{points:r,hasZ:t}:o?{points:r,hasM:o}:{points:r}}function q(e,t,o,n,r){const s=h(o,n);for(const{geometry:o,attributes:n}of t){const t=null!=o?S(new d,o,s):null;e.push(new a(t,n,null,r?n[r]:void 0))}return e}function S(e,t,o=h(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const n=e.coords;let r=0;for(const e of t.points)for(let t=0;t<o;t++)n[r++]=e[t];return e}function R(e,t,o){if(!e)return null;const n=h(t,o),{coords:r,lengths:s}=e,u=[];let l=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<n;t++)e.push(r[l++]);t.push(e)}u.push(t)}return t?o?{paths:u,hasZ:t,hasM:o}:{paths:u,hasZ:t}:o?{paths:u,hasM:o}:{paths:u}}function $(e,t,o,n,r){const s=h(o,n);for(const{geometry:o,attributes:n}of t){const t=null!=o?A(new d,o,s):null;e.push(new a(t,n,null,r?n[r]:void 0))}return e}function A(e,t,o=h(t.hasZ,t.hasM)){const{lengths:n,coords:r}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<o;e++)r[s++]=t[e];n.push(e.length)}return e}function V(e,t,o){if(!e)return null;const n=h(t,o),{coords:r,lengths:s}=e,u=[];let l=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<n;t++)e.push(r[l++]);t.push(e)}u.push(t)}return t?o?{rings:u,hasZ:t,hasM:o}:{rings:u,hasZ:t}:o?{rings:u,hasM:o}:{rings:u}}function Y(e,t,o,n,r){for(const{geometry:s,centroid:u,attributes:l}of t){const t=null!=s?_(new d,s,o,n):null,c=r?l[r]:void 0;null!=u?e.push(new a(t,l,F(new d,u),c)):e.push(new a(t,l,null,c))}return e}function _(e,t,o=t.hasZ,n=t.hasM){return B(e,t.rings,o,n)}function B(e,t,o,n){const r=h(o,n),{lengths:s,coords:u}=e;let l=0;me(e);for(const e of t){for(const t of e)for(let e=0;e<r;e++)u[l++]=t[e];s.push(e.length)}return e}const C=[],D=[];function H(e,t,o,n,r){C[0]=e;const[s]=J(D,C,t,o,n,r);return ge(C),ge(D),s}function J(t,o,n,r,s,u){if(ge(t),!n){for(const e of o){const o=u?e.attributes[u]:void 0;t.push(new a(null,e.attributes,null,o))}return t}switch(n){case"esriGeometryPoint":return L(t,o,r,s,u);case"esriGeometryMultipoint":return q(t,o,r,s,u);case"esriGeometryPolyline":return $(t,o,r,s,u);case"esriGeometryPolygon":return Y(t,o,r,s,u);default:m.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${n}'`)),ge(t)}return t}function K(t,o,n,r,s,u){const l=t.length;switch(n){case"esriGeometryPoint":L(t,o,r,s,u);break;case"esriGeometryMultipoint":q(t,o,r,s,u);break;case"esriGeometryPolyline":$(t,o,r,s,u);break;case"esriGeometryPolygon":Y(t,o,r,s,u);break;default:m.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${n}'`))}for(let e=0;e<o.length;e++)t[e+l].geometryType=n,t[e+l].insertAfter=o[e].insertAfter,t[e+l].groupId=o[e].groupId;return t}function Q(e,t,o,n){D[0]=e,ee(C,D,t,o,n);const r=C[0];return ge(C),ge(D),r}function W(t,o,n){if(null==t)return null;const r=new d;return"hasZ"in t&&null==o&&(o=t.hasZ),"hasM"in t&&null==n&&(n=t.hasM),u(t)?E(null!=o?o:null!=t.z,null!=n?n:null!=t.m)(r,t):l(t)?_(r,t,o,n):c(t)?A(r,t,h(o,n)):i(t)?S(r,t,h(o,n)):void m.error("convertFromGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${t}'`))}function X(t,o,n,r){const s=t&&("coords"in t?t:t.geometry);if(null==s)return null;switch(o){case"esriGeometryPoint":{let e=P;return n&&r?e=v:n?e=j:r&&(e=Z),e(s)}case"esriGeometryMultipoint":return U(s,n,r);case"esriGeometryPolyline":return R(s,n,r);case"esriGeometryPolygon":return V(s,n,r);default:return m.error("convertToGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${o}'`)),null}}function ee(t,o,n,r,s){if(ge(t),null==n)return function(e,t){for(const o of t)e.push({attributes:o.attributes});return e}(t,o);switch(n){case"esriGeometryPoint":return function(e,t,o,n){let r=P;o&&n?r=v:o?r=j:n&&(r=Z);for(const o of t){const{geometry:t,attributes:n}=o,s=null!=t?r(t):null;e.push({attributes:n,geometry:s})}return e}(t,o,r,s);case"esriGeometryMultipoint":return function(e,t,o,n){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?U(r,o,n):null});return e}(t,o,r,s);case"esriGeometryPolyline":return function(e,t,o,n){for(const{geometry:r,attributes:s}of t)e.push({attributes:s,geometry:null!=r?R(r,o,n):null});return e}(t,o,r,s);case"esriGeometryPolygon":return function(e,t,o,n){for(const{geometry:r,attributes:s,centroid:u}of t){const t=null!=r?V(r,o,n):null;if(null!=u){const o=P(u);e.push({attributes:s,centroid:o,geometry:t})}else e.push({attributes:s,geometry:t})}return e}(t,o,r,s);default:m.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${n}'`))}return t}function te(e){const{objectIdFieldName:t,spatialReference:o,transform:n,fields:r,hasM:s,hasZ:u,features:l,geometryType:c,exceededTransferLimit:i,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=e,h={features:ee([],l,c,u,s),fields:r,geometryType:c,objectIdFieldName:t,spatialReference:o,uniqueIdField:a,queryGeometry:X(f,d,!1,!1)};return n&&(h.transform=n),i&&(h.exceededTransferLimit=i),s&&(h.hasM=s),u&&(h.hasZ=u),h}function oe(t,o){const n=new f,{hasM:r,hasZ:s,features:u,objectIdFieldName:l,spatialReference:c,geometryType:i,exceededTransferLimit:a,transform:d,fields:h}=t;return h&&(n.fields=h),n.geometryType=i??null,n.objectIdFieldName=l??o??null,n.spatialReference=c??null,n.objectIdFieldName?(u&&J(n.features,u,i,s,r,n.objectIdFieldName),a&&(n.exceededTransferLimit=a),r&&(n.hasM=r),s&&(n.hasZ=s),d&&(n.transform=d),n):(m.error(new e("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function ne(e){const{transform:t,features:o,hasM:n,hasZ:r}=e;if(!t)return e;for(const e of o)null!=e.geometry&&ae(e.geometry,e.geometry,n,r,t),null!=e.centroid&&ae(e.centroid,e.centroid,n,r,t);return e.transform=null,e}function re(e,t){const{geometryType:o,features:n,hasM:r,hasZ:s}=t;if(!e)return t;for(let t=0;t<n.length;t++){const u=n[t],l=u.weakClone();l.geometry=new d,se(l.geometry,u.geometry,r,s,o,e),u.centroid&&(l.centroid=new d,se(l.centroid,u.centroid,r,s,"esriGeometryPoint",e)),n[t]=l}return t.transform=e,t}function se(e,t,o,n,r,s,u=o,l=n){if(me(e),null==t||!t.coords.length)return null;const c=g[r],{coords:i,lengths:a}=t,f=h(o,n),d=h(o&&u,n&&l),m=G(o,n,u,l);if(!a.length)return m(e.coords,i,0,0,I(s,i[0]),M(s,i[1])),me(e,f,0),e;let y,p,b,w,T=0,N=0,P=N;for(const t of a){if(t<c)continue;let o=0;N=P,b=y=I(s,i[T]),w=p=M(s,i[T+1]),m(e.coords,i,N,T,b,w),o++,T+=f,N+=d;for(let n=1;n<t;n++,T+=f)b=I(s,i[T]),w=M(s,i[T+1]),b===y&&w===p||(m(e.coords,i,N,T,b-y,w-p),N+=d,o++,y=b,p=w);o>=c&&(e.lengths.push(o),P=N)}return ge(e.coords,P),e.coords.length?e:null}function ue(e,t,o,n,r,s,u=o,l=n){if(me(e),!t||!t.coords.length)return null;const c=g[r],{coords:i,lengths:a}=t,f=h(o,n),d=h(o&&u,n&&l),m=G(o,n,u,l);if(!a.length)return m(e.coords,i,0,0,i[0],i[1]),me(e,f,0),e;let y=0;const p=s*s;for(const t of a){if(t<c){y+=t*f;continue}const o=e.coords.length/d,n=y,r=y+(t-1)*f;m(e.coords,i,e.coords.length,n,i[n],i[n+1]),ce(e.coords,i,f,p,m,n,r),m(e.coords,i,e.coords.length,r,i[r],i[r+1]);const s=e.coords.length/d-o;s>=c?e.lengths.push(s):ge(e.coords,o*d),y+=t*f}return e.coords.length?e:null}function le(e,t,o,n){const r=e[t],s=e[t+1],u=e[o],l=e[o+1],c=e[n],i=e[n+1];let a=u,f=l,d=c-a,h=i-f;if(0!==d||0!==h){const e=((r-a)*d+(s-f)*h)/(d*d+h*h);e>1?(a=c,f=i):e>0&&(a+=d*e,f+=h*e)}return d=r-a,h=s-f,d*d+h*h}function ce(e,t,o,n,r,s,u){let l,c=n,i=0;for(let e=s+o;e<u;e+=o)l=le(t,e,s,u),l>c&&(i=e,c=l);c>n&&(i-s>o&&ce(e,t,o,n,r,s,i),r(e,t,e.length,i,t[i],t[i+1]),u-i>o&&ce(e,t,o,n,r,i,u))}function ie(e,t,o,u){if(null==t||!t.coords||!t.coords.length)return null;const l=h(o,u);let c=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=l){const o=e[t],n=e[t+1];c=Math.min(c,o),a=Math.max(a,o),i=Math.min(i,n),f=Math.max(f,n)}}return n(e)?r(e,c,i,a,f):s(c,i,a,f,e),e}function ae(e,t,n,r,s){const{coords:u,lengths:l}=t,c=h(n,r);if(!u.length)return e!==t&&me(e),e;o(s);const{originPosition:i,scale:a,translate:f}=s,d=ye;d.originPosition=i;const m=d.scale;m[0]=a[0]??1,m[1]=-(a[1]??1),m[2]=a[2]??1,m[3]=a[3]??1;const g=d.translate;if(g[0]=f[0]??0,g[1]=f[1]??0,g[2]=f[2]??0,g[3]=f[3]??0,!l.length){for(let t=0;t<c;++t)e.coords[t]=T(d,u[t],t);return e!==t&&me(e,c,0),e}let y=0;for(let t=0;t<l.length;t++){const o=l[t];e.lengths[t]=o;for(let t=0;t<c;++t)e.coords[y+t]=T(d,u[y+t],t);let n=e.coords[y],r=e.coords[y+1];y+=c;for(let t=1;t<o;t++,y+=c){n+=u[y]*m[0],r+=u[y+1]*m[1],e.coords[y]=n,e.coords[y+1]=r;for(let t=2;t<c;++t)e.coords[y+t]=T(d,u[y+t],t)}}return e!==t&&me(e,u.length,l.length),e}function fe(e,t,o,n,r,s){if(me(e),e.lengths.push(...t.lengths),o===r&&n===s)for(let o=0;o<t.coords.length;o++)e.coords.push(t.coords[o]);else{const u=h(o,n),l=G(o,n,r,s),c=t.coords;for(let t=0;t<c.length;t+=u)l(e.coords,c,e.coords.length,t,c[t],c[t+1])}return e}function de(e,t,o,n){let r=0,s=e[n*t],u=e[n*(t+1)];for(let l=1;l<o;l++){const o=s+e[n*(t+l)],c=u+e[n*(t+l)+1],i=(o-s)*(c+u);s=o,u=c,r+=i}return.5*r}function he(e,t){const{coords:o,lengths:n}=e;let r=0,s=0;for(let e=0;e<n.length;e++){const u=n[e];s+=de(o,r,u,t),r+=u}return Math.abs(s)}function me(e,t=0,o=0){ge(e.lengths,o),ge(e.coords,t)}function ge(e,t=0){e.length!==t&&(e.length=t)}const ye={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{ue as a,N as b,W as c,R as d,V as e,U as f,ie as g,_ as h,X as i,te as j,B as k,ne as l,oe as m,J as n,Q as o,H as p,se as q,fe as r,re as s,I as t,ae as u,M as v,O as w,he as x,K as y,A as z};

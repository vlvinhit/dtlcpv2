/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{a as e}from"./devEnvironmentUtils.js";import{m as t,n as r}from"./mat3.js";import{c as s}from"./mat3f64.js";import{c as o}from"./mat4.js";import{c as i}from"./mat4f64.js";import{h as a,s as n,c as l,n as u,b as c,l as h,e as p,i as d,t as m,d as f,y as g,x}from"./vec3.js";import{Z as T,c as v,d as y,f as b}from"./vec3f64.js";import{k as S,e as w}from"./aaBoundingBox.js";import{s as O,c as M,d as C,D as A,a as R,n as P}from"./DefaultBufferWriter.js";import{c as _,b as I,t as E,B as j,p as N,s as D}from"./BufferView.js";import{t as B,a as L,s as V}from"./vec32.js";import{l as F,D as U,C as k,a as z,t as q,n as G,s as H,b as W,c as $}from"./DefaultMaterial_COLOR_GAMMA.js";import{i as Q}from"./resourceUtils2.js";import{f as Y,c as Z}from"./mat3f32.js";import{Z as J,O as K}from"./vec2f32.js";import X from"../request.js";import{r as ee}from"./asyncUtils.js";import{a as te}from"./byteSizeEstimations.js";import re from"../core/Error.js";import{L as se}from"./Logger.js";import{N as oe}from"./NestedMap.js";import{throwIfAbortError as ie}from"../core/promiseUtils.js";import{V as ae}from"./Version.js";import{r as ne}from"./requestImageUtils.js";import{A as le}from"./Attribute.js";import{C as ue,b as ce,A as he}from"./basicInterfaces.js";import{T as pe}from"./Texture2.js";import{V as de}from"./VertexAttribute.js";import{h as me}from"./typedArrayUtil.js";import{V as fe}from"./ViewingMode.js";import{n as ge}from"./InterleavedLayout.js";import{S as xe}from"./ShaderOutput.js";import{V as Te,a as ve,b as ye}from"./VertexNormal.glsl.js";import{N as be}from"./Normals.glsl.js";import{d as Se,P as we}from"./PhysicallyBasedRendering.glsl.js";import{G as Oe}from"./GLTextureMaterial.js";import{R as Me,D as Ce,b as Ae,v as Re,i as Pe}from"./Material.js";import{c as _e,o as Ie,a as Ee,g as je,d as Ne}from"./OrderIndependentTransparency.js";import{R as De}from"./RenderSlot.js";import{g as Be}from"./verticalOffsetUtils.js";import{f as Le}from"./vec4f64.js";import{d as Ve}from"./AlphaCutoff.js";import{R as Fe,S as Ue,P as ke}from"./Program2.js";import{T as ze}from"./TransparencyPassType.js";import{D as qe}from"./DefaultMaterial.glsl.js";import{g as Ge,T as He}from"./enums3.js";import{m as We,c as $e,d as Qe,a as Ye}from"./renderState.js";import{_ as Ze}from"./tslib.es6.js";import{p as Je}from"./ShaderTechniqueConfiguration.js";import{D as Ke}from"./DefaultTechniqueConfiguration.js";import{R as Xe}from"./RealisticTree.glsl.js";function et({normalTexture:e,metallicRoughnessTexture:t,metallicFactor:r,roughnessFactor:s,emissiveTexture:o,emissiveFactor:i,occlusionTexture:n}){return null==e&&null==t&&null==o&&(null==i||a(i,T))&&null==n&&(null==s||1===s)&&(null==r||1===r||0===r)}const tt=[1,1,.5],rt=[0,.6,.2],st=[0,1,.2];class ot extends ve{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=y(tt),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=ue.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=b(0,0,0),this.instancedDoublePrecision=!1,this.normalType=ye.Attribute,this.receiveSSAO=!0,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=b(.2,.2,.2),this.diffuse=b(.8,.8,.8),this.externalColor=Le(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=v(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=ce.Less,this.textureAlphaMode=he.Blend,this.textureAlphaCutoff=Ve,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Me.Occlude}}class it extends Te{constructor(){super(...arguments),this.origin=v(),this.slicePlaneLocalOrigin=this.origin}}class at extends Ue{initializeConfiguration(e,t){t.spherical=e.viewingMode===fe.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,t.textureCoordinateType=t.hasColorTexture||t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture||t.hasNormalTexture?Se.Default:Se.None,t.objectAndLayerIdColorInstanced=t.instanced}initializeProgram(e){return this._initializeProgram(e,at.shader)}_initializeProgram(e,t){return new ke(e.rctx,t.get().build(this.configuration),Ce)}_convertDepthTestFunction(e){return e===ce.Lequal?Ge.LEQUAL:Ge.LESS}_makePipeline(e,t){const r=this.configuration,s=e===ze.NONE,o=e===ze.FrontFace;return We({blending:r.output!==xe.Color&&r.output!==xe.Alpha||!r.transparent?null:s?_e:Ie(e),culling:nt(r)?$e(r.cullFace):null,depthTest:{func:Ee(e,this._convertDepthTestFunction(r.customDepthTest))},depthWrite:(s||o)&&r.writeDepth?Qe:null,colorWrite:Ye,stencilWrite:r.hasOccludees?O:null,stencilTest:r.hasOccludees?t?M:C:null,polygonOffset:s||o?null:je(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}function nt(e){return e.cullFace!==ue.None||!e.hasSlicePlane&&!e.transparent&&!e.doubleSidedMode}at.shader=new Fe(qe,(()=>import("./DefaultMaterial.glsl.js").then((e=>e.D))));class lt extends Ke{constructor(){super(...arguments),this.output=xe.Color,this.alphaDiscardMode=he.Opaque,this.doubleSidedMode=be.None,this.pbrMode=we.Disabled,this.cullFace=ue.None,this.transparencyPassType=ze.NONE,this.normalType=ye.Attribute,this.textureCoordinateType=Se.None,this.customDepthTest=ce.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}}Ze([Je({count:xe.COUNT})],lt.prototype,"output",void 0),Ze([Je({count:he.COUNT})],lt.prototype,"alphaDiscardMode",void 0),Ze([Je({count:be.COUNT})],lt.prototype,"doubleSidedMode",void 0),Ze([Je({count:we.COUNT})],lt.prototype,"pbrMode",void 0),Ze([Je({count:ue.COUNT})],lt.prototype,"cullFace",void 0),Ze([Je({count:ze.COUNT})],lt.prototype,"transparencyPassType",void 0),Ze([Je({count:ye.COUNT})],lt.prototype,"normalType",void 0),Ze([Je({count:Se.COUNT})],lt.prototype,"textureCoordinateType",void 0),Ze([Je({count:ce.COUNT})],lt.prototype,"customDepthTest",void 0),Ze([Je()],lt.prototype,"spherical",void 0),Ze([Je()],lt.prototype,"hasVertexColors",void 0),Ze([Je()],lt.prototype,"hasSymbolColors",void 0),Ze([Je()],lt.prototype,"hasVerticalOffset",void 0),Ze([Je()],lt.prototype,"hasSlicePlane",void 0),Ze([Je()],lt.prototype,"hasSliceHighlight",void 0),Ze([Je()],lt.prototype,"hasColorTexture",void 0),Ze([Je()],lt.prototype,"hasMetallicRoughnessTexture",void 0),Ze([Je()],lt.prototype,"hasEmissionTexture",void 0),Ze([Je()],lt.prototype,"hasOcclusionTexture",void 0),Ze([Je()],lt.prototype,"hasNormalTexture",void 0),Ze([Je()],lt.prototype,"hasScreenSizePerspective",void 0),Ze([Je()],lt.prototype,"hasVertexTangents",void 0),Ze([Je()],lt.prototype,"hasOccludees",void 0),Ze([Je()],lt.prototype,"hasMultipassTerrain",void 0),Ze([Je()],lt.prototype,"hasModelTransformation",void 0),Ze([Je()],lt.prototype,"offsetBackfaces",void 0),Ze([Je()],lt.prototype,"vvSize",void 0),Ze([Je()],lt.prototype,"vvColor",void 0),Ze([Je()],lt.prototype,"receiveShadows",void 0),Ze([Je()],lt.prototype,"receiveAmbientOcclusion",void 0),Ze([Je()],lt.prototype,"textureAlphaPremultiplied",void 0),Ze([Je()],lt.prototype,"instanced",void 0),Ze([Je()],lt.prototype,"instancedColor",void 0),Ze([Je()],lt.prototype,"objectAndLayerIdColorInstanced",void 0),Ze([Je()],lt.prototype,"instancedDoublePrecision",void 0),Ze([Je()],lt.prototype,"doublePrecisionRequiresObfuscation",void 0),Ze([Je()],lt.prototype,"writeDepth",void 0),Ze([Je()],lt.prototype,"transparent",void 0),Ze([Je()],lt.prototype,"enableOffset",void 0),Ze([Je()],lt.prototype,"cullAboveGround",void 0),Ze([Je()],lt.prototype,"snowCover",void 0),Ze([Je()],lt.prototype,"hasColorTextureTransform",void 0),Ze([Je()],lt.prototype,"hasEmissionTextureTransform",void 0),Ze([Je()],lt.prototype,"hasNormalTextureTransform",void 0),Ze([Je()],lt.prototype,"hasOcclusionTextureTransform",void 0),Ze([Je()],lt.prototype,"hasMetallicRoughnessTextureTransform",void 0),Ze([Je({constValue:!0})],lt.prototype,"hasVvInstancing",void 0),Ze([Je({constValue:!1})],lt.prototype,"useCustomDTRExponentForWater",void 0),Ze([Je({constValue:!1})],lt.prototype,"supportsTextureAtlas",void 0),Ze([Je({constValue:!0})],lt.prototype,"useFillLights",void 0);class ut extends at{initializeConfiguration(e,t){super.initializeConfiguration(e,t),t.hasMetallicRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.hasModelTransformation=!1,t.normalType=ye.Attribute,t.doubleSidedMode=be.WindingOrder,t.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,ut.shader)}}ut.shader=new Fe(Xe,(()=>import("./RealisticTree.glsl.js").then((e=>e.R))));class ct extends Ae{constructor(e){super(e,pt),this.supportsEdges=!0,this._configuration=new lt,this._vertexBufferLayout=function(e){const t=ge().vec3f(de.POSITION);return e.normalType===ye.Compressed?t.vec2i16(de.NORMALCOMPRESSED,{glNormalized:!0}):t.vec3f(de.NORMAL),e.hasVertexTangents&&t.vec4f(de.TANGENT),(e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId)&&t.vec2f(de.UV0),e.hasVertexColors&&t.vec4u8(de.COLOR),e.hasSymbolColors&&t.vec4u8(de.SYMBOLCOLOR),me("enable-feature:objectAndLayerId-rendering")&&t.vec4u8(de.OBJECTANDLAYERIDCOLOR),t}(this.parameters)}isVisibleForOutput(e){return e!==xe.Shadow&&e!==xe.ShadowExcludeHighlight&&e!==xe.ShadowHighlight||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||0===e.layerOpacity)return!1;const{hasInstancedColor:t,hasVertexColors:r,hasSymbolColors:s,vvColor:o}=e,i="replace"===e.colorMixMode,a=e.opacity>0,n=e.externalColor&&e.externalColor[3]>0,l=t||o||s;return r&&l?i||a:r?i?n:a:l?i||a:i?n:a}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,null!=this.parameters.customDepthTest&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?ue.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=null!=this.parameters.modelTransformation,e!==xe.Color&&e!==xe.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=be.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?be.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?be.WindingOrder:be.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?we.Schematic:we.Normal:we.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Ne,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}intersect(e,t,r,s,o,i){if(null!=this.parameters.verticalOffset){const e=r.camera;n(Tt,t[12],t[13],t[14]);let i=null;switch(r.viewingMode){case fe.Global:i=u(gt,Tt);break;case fe.Local:i=l(gt,ft)}let a=0;const f=c(vt,Tt,e.eye),g=h(f),x=p(f,f,1/g);let T=null;this.parameters.screenSizePerspective&&(T=d(i,x)),a+=Re(e,g,this.parameters.verticalOffset,T??0,this.parameters.screenSizePerspective),p(i,i,a),m(xt,i,r.transform.inverseRotation),s=c(dt,s,xt),o=c(mt,o,xt)}Pe(e,r,s,o,Be(r.verticalOffset),i)}requiresSlot(e,t){return!(t!==xe.Color&&t!==xe.Alpha&&t!==xe.Depth&&t!==xe.Normal&&t!==xe.Shadow&&t!==xe.ShadowHighlight&&t!==xe.ShadowExcludeHighlight&&t!==xe.Highlight&&t!==xe.ObjectAndLayerIdColor||e!==(this.parameters.transparent?this.parameters.writeDepth?De.TRANSPARENT_MATERIAL:De.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:De.OPAQUE_MATERIAL)&&e!==De.DRAPED_MATERIAL)}createGLMaterial(e){return new ht(e)}createBufferWriter(){return new A(this._vertexBufferLayout)}}class ht extends Oe{constructor(e){super({...e,...e.material.parameters})}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==xe.Color&&this._output!==xe.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const t=this._material.parameters;this.updateTexture(t.textureId);const r=e.camera.viewInverseTransposeMatrix;return n(t.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?ut:at,e)}}const pt=new class extends ot{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}},dt=v(),mt=v(),ft=b(0,0,1),gt=v(),xt=v(),Tt=v(),vt=v();function yt(e){if(null==e)return null;const r=null!=e.offset?e.offset:J,s=null!=e.rotation?e.rotation:0,o=null!=e.scale?e.scale:K,i=Y(1,0,0,0,1,0,r[0],r[1],1),a=Y(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=Y(o[0],0,0,0,o[1],0,0,0,1),l=Z();return t(l,a,n),t(l,i,l),l}class bt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class St{constructor(e,t,r){this.name=e,this.lodThreshold=t,this.pivotOffset=r,this.stageResources=new bt,this.numberOfVertices=0}}const wt=se.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Ot(e,t){const r=await async function(e,t){const r=null!=t&&t.streamDataRequester;if(r)return async function(e,t,r){const s=await ee(t.request(e,"json",r));return!0===s.ok?s.value:(ie(s.error),void Mt(s.error.details.url))}(e,r,t);const s=await ee(X(e,t));return!0===s.ok?s.value.data:(ie(s.error),void Mt(s.error))}(e,t),s=await async function(e,t){const r=new Array;for(const s in e){const o=e[s],i=o.images[0].data;if(!i){wt.warn("Externally referenced texture data is not yet supported");continue}const a=o.encoding+";base64,"+i,n="/textureDefinitions/"+s,l="rgba"===o.channels?o.alphaChannelUsage||"transparency":"none",u={noUnpackFlip:!0,wrap:{s:He.REPEAT,t:He.REPEAT},preMultiplyAlpha:Rt(l)!==he.Opaque},c=null!=t&&t.disableTextures?Promise.resolve(null):ne(a,t);r.push(c.then((e=>({refId:n,image:e,parameters:u,alphaChannelUsage:l}))))}const s=await Promise.all(r),o={};for(const e of s)o[e.refId]=e;return o}(r.textureDefinitions??{},t);let o=0;for(const e in s)if(s.hasOwnProperty(e)){const t=s[e];o+=t?.image?t.image.width*t.image.height*4:0}return{resource:r,textures:s,size:o+te(r)}}function Mt(e){throw new re("",`Request for object resource failed: ${e}`)}function Ct(e){const t=e.params,r=t.topology;let s=!0;switch(t.vertexAttributes||(wt.warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(wt.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),s=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(wt.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),s=!1)):(wt.warn(`Indexed geometry does not specify face indices for '${r}' attribute`),s=!1)}}else wt.warn("Indexed geometries must specify faces"),s=!1;break}default:wt.warn(`Unsupported topology '${r}'`),s=!1}e.params.material||(wt.warn("Geometry requires material"),s=!1);const o=e.params.vertexAttributes;for(const e in o)o[e].values||(wt.warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function At(e){const t=S();return e.forEach((e=>{const r=e.boundingInfo;null!=r&&(w(t,r.bbMin),w(t,r.bbMax))})),t}function Rt(e){switch(e){case"mask":return he.Mask;case"maskAndTransparency":return he.MaskBlend;case"none":return he.Opaque;default:return he.Blend}}function Pt(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const _t=new ae(1,2,"wosr");async function It(t,r){const s=Et(e(t));if("wosr"===s.fileType){const e=await(r.cache?r.cache.loadWOSR(s.url,r):Ot(s.url,r)),{engineResources:t,referenceBoundingBox:o}=function(e,t){const r=new Array,s=new Array,o=new Array,i=new oe,a=e.resource,n=ae.parse(a.version||"1.0","wosr");_t.validate(n);const l=a.model.name,u=a.model.geometries,c=a.materialDefinitions??{},h=e.textures;let p=0;const d=new Map;for(let e=0;e<u.length;e++){const a=u[e];if(!Ct(a))continue;const n=Pt(a),l=a.params.vertexAttributes,m=[];for(const e in l){const t=l[e],r=t.values;m.push([e,new le(r,t.valuesPerElement,!0)])}const f=[];if("PerAttributeArray"!==a.params.topology){const e=a.params.faces;for(const t in e)f.push([t,e[t].values])}const g=n.texture,x=h&&h[g];if(x&&!d.has(g)){const{image:e,parameters:t}=x,r=new pe(e,t);s.push(r),d.set(g,r)}const T=d.get(g),v=T?T.id:void 0,b=n.material;let S=i.get(b,g);if(null==S){const e=c[b.substring(b.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const r=x&&x.alphaChannelUsage,s=e.transparency>0||"transparency"===r||"maskAndTransparency"===r,o=x?Rt(x.alphaChannelUsage):void 0,a={ambient:y(e.diffuse),diffuse:y(e.diffuse),opacity:1-(e.transparency||0),transparent:s,textureAlphaMode:o,textureAlphaCutoff:.33,textureId:v,initTextureTransparent:!0,doubleSided:!0,cullFace:ue.None,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:x?.parameters.preMultiplyAlpha??!1};null!=t&&t.materialParamsMixin&&Object.assign(a,t.materialParamsMixin),S=new ct(a),i.set(b,g,S)}o.push(S);const w=new R(S,m,f);p+=f.find((e=>e[0]===de.POSITION))?.[1].length??0,r.push(w)}return{engineResources:[{name:l,stageResources:{textures:s,materials:o,geometries:r},pivotOffset:a.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:At(r)}}(e,r);return{lods:t,referenceBoundingBox:o,isEsriSymbolResource:!1,isWosr:!0}}const a=await(r.cache?r.cache.loadGLTF(s.url,r,!!r.usePBR):F(new U(r.streamDataRequester),s.url,r,r.usePBR)),n=a.model.meta?.ESRI_proxyEllipsoid,l=a.meta.isEsriSymbolResource&&null!=n&&a.meta.uri.includes("/RealisticTrees/");l&&!a.customMeta.esriTreeRendering&&(a.customMeta.esriTreeRendering=!0,function(e,t){for(let r=0;r<e.model.lods.length;++r){const s=e.model.lods[r];for(const a of s.parts){const s=a.attributes.normal;if(null==s)return;const n=a.attributes.position,l=n.count,p=v(),d=v(),m=v(),T=new Uint8Array(4*l),y=new Float64Array(3*l),b=o(i(),a.transform);let S=0,w=0;for(let o=0;o<l;o++){n.getVec(o,d),s.getVec(o,p),f(d,d,a.transform),c(m,d,t.center),g(m,m,t.radius);const i=m[2],l=h(m),v=Math.min(.45+.55*l*l,1);g(m,m,t.radius),null!==b&&f(m,m,b),u(m,m),r+1!==e.model.lods.length&&e.model.lods.length>1&&x(m,m,p,i>-1?.2:Math.min(-4*i-3.8,1)),y[S]=m[0],y[S+1]=m[1],y[S+2]=m[2],S+=3,T[w]=255*v,T[w+1]=255*v,T[w+2]=255*v,T[w+3]=255,w+=4}a.attributes.normal=new j(y),a.attributes.color=new I(T)}}}(a,n));const p=!!r.usePBR,d=a.meta.isEsriSymbolResource?{usePBR:p,isSchematic:!1,treeRendering:l,mrrFactors:[...st]}:{usePBR:p,isSchematic:!1,treeRendering:!1,mrrFactors:[...tt]},m={...r.materialParamsMixin,treeRendering:l},{engineResources:T,referenceBoundingBox:b}=jt(a,d,m,r.skipHighLods&&null==s.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:s.specifiedLodIndex});return{lods:T,referenceBoundingBox:b,isEsriSymbolResource:a.meta.isEsriSymbolResource,isWosr:!1}}function Et(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function jt(e,t,s,o){const i=e.model,a=new Array,n=new Map,l=new Map,u=i.lods.length,c=S();return i.lods.forEach(((e,h)=>{const p=!0===o.skipHighLods&&(u>1&&0===h||u>3&&1===h)||!1===o.skipHighLods&&null!=o.singleLodIndex&&h!==o.singleLodIndex;if(p&&0!==h)return;const d=new St(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const o=p?new ct({}):function(e,t,r,s,o,i,a){const n=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),l=e.materials.get(t.material),u=null!=t.attributes.texCoord0,c=null!=t.attributes.normal;if(null==l)return null;const h=function(e){switch(e){case"BLEND":return he.Blend;case"MASK":return he.Mask;case"OPAQUE":case null:case void 0:return he.Opaque}}(l.alphaMode);if(!i.has(n)){if(u){const t=(t,r=!1)=>{if(null!=t&&!a.has(t)){const s=e.textures.get(t);if(null!=s){const e=s.data;a.set(t,new pe(Q(e)?e.data:e,{...s.parameters,preMultiplyAlpha:!Q(e)&&r,encoding:Q(e)&&null!=e.encoding?e.encoding:void 0}))}}};t(l.textureColor,h!==he.Opaque),t(l.textureNormal),t(l.textureOcclusion),t(l.textureEmissive),t(l.textureMetallicRoughness)}const r=l.color[0]**(1/k),p=l.color[1]**(1/k),d=l.color[2]**(1/k),m=l.emissiveFactor[0]**(1/k),f=l.emissiveFactor[1]**(1/k),g=l.emissiveFactor[2]**(1/k),x=null!=l.textureColor&&u?a.get(l.textureColor):null,T=et({normalTexture:l.textureNormal,metallicRoughnessTexture:l.textureMetallicRoughness,metallicFactor:l.metallicFactor,roughnessFactor:l.roughnessFactor,emissiveTexture:l.textureEmissive,emissiveFactor:l.emissiveFactor,occlusionTexture:l.textureOcclusion});i.set(n,new ct({...s,transparent:h===he.Blend,customDepthTest:ce.Lequal,textureAlphaMode:h,textureAlphaCutoff:l.alphaCutoff,diffuse:[r,p,d],ambient:[r,p,d],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",cullFace:l.doubleSided?ue.None:ue.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:c?ye.Attribute:ye.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:null!=x?x.id:void 0,colorMixMode:l.colorMixMode,normalTextureId:null!=l.textureNormal&&u?a.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:null!=x&&!!x.parameters.preMultiplyAlpha,occlusionTextureId:null!=l.textureOcclusion&&u?a.get(l.textureOcclusion).id:void 0,emissiveTextureId:null!=l.textureEmissive&&u?a.get(l.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=l.textureMetallicRoughness&&u?a.get(l.textureMetallicRoughness).id:void 0,emissiveFactor:[m,f,g],mrrFactors:T?[...rt]:[l.metallicFactor,l.roughnessFactor,s.mrrFactors[2]],isSchematic:T,colorTextureTransformMatrix:yt(l.colorTextureTransform),normalTextureTransformMatrix:yt(l.normalTextureTransform),occlusionTextureTransformMatrix:yt(l.occlusionTextureTransform),emissiveTextureTransformMatrix:yt(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:yt(l.metallicRoughnessTextureTransform),...o}))}const p=i.get(n);if(r.stageResources.materials.push(p),u){const e=e=>{null!=e&&r.stageResources.textures.push(a.get(e))};e(l.textureColor),e(l.textureNormal),e(l.textureOcclusion),e(l.textureEmissive),e(l.textureMetallicRoughness)}return p}(i,e,d,t,s,n,l),{geometry:a,vertexCount:u}=function(e,t){const s=e.attributes.position.count,o=z(e.indices||s,e.primitiveType),i=P(3*s),{typedBuffer:a,typedBufferStride:n}=e.attributes.position;B(i,a,e.transform,3,n);const l=[[de.POSITION,new le(i,3,!0)]],u=[[de.POSITION,o]];if(null!=e.attributes.normal){const t=P(3*s),{typedBuffer:i,typedBufferStride:a}=e.attributes.normal;r(Nt,e.transform),L(t,i,Nt,3,a),l.push([de.NORMAL,new le(t,3,!0)]),u.push([de.NORMAL,o])}if(null!=e.attributes.tangent){const t=P(4*s),{typedBuffer:i,typedBufferStride:a}=e.attributes.tangent;r(Nt,e.transform),q(t,i,Nt,4,a),l.push([de.TANGENT,new le(t,4,!0)]),u.push([de.TANGENT,o])}if(null!=e.attributes.texCoord0){const t=P(2*s),{typedBuffer:r,typedBufferStride:i}=e.attributes.texCoord0;G(t,r,2,i),l.push([de.UV0,new le(t,2,!0)]),u.push([de.UV0,o])}if(null!=e.attributes.color){const t=new Uint8Array(4*s);4===e.attributes.color.elementCount?e.attributes.color instanceof _?H(t,e.attributes.color,255):e.attributes.color instanceof I?W(t,e.attributes.color):e.attributes.color instanceof E&&H(t,e.attributes.color,1/256):(t.fill(255),e.attributes.color instanceof j?V(t,e.attributes.color,255,4):e.attributes.color instanceof N?$(t,e.attributes.color.typedBuffer,4,e.attributes.color.typedBufferStride):e.attributes.color instanceof D&&V(t,e.attributes.color,1/256,4)),l.push([de.COLOR,new le(t,4,!0)]),u.push([de.COLOR,o])}return{geometry:new R(t,l,u),vertexCount:s}}(e,null!=o?o:new ct({})),m=a.boundingInfo;null!=m&&0===h&&(w(c,m.bbMin),w(c,m.bbMax)),null!=o&&(d.stageResources.geometries.push(a),d.numberOfVertices+=u)})),p||a.push(d)})),{engineResources:a,referenceBoundingBox:c}}const Nt=s(),Dt=Object.freeze(Object.defineProperty({__proto__:null,fetch:It,gltfToEngineResources:jt,parseUrl:Et},Symbol.toStringTag,{value:"Module"}));export{ct as D,rt as a,it as b,tt as d,It as f,yt as g,Ot as l,Dt as o,et as u};

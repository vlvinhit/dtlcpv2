/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import o from"../core/Error.js";import{l as s}from"./fontUtils.js";import{a as e,p as r}from"./screenUtils.js";import{f as i,e as l,k as m}from"./utils6.js";import{S as a,s as p,k as n}from"./previewUtils.js";import{f as c}from"./renderUtils.js";import{B as y}from"../symbols/Font.js";import{getColorLuminance as u}from"../views/support/colorUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./vec4.js";import"./ensureType.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"./object.js";import"../core/lang.js";import"./string.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./maybe.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ObjectPool.js";import"./ObservableBase.js";import"./watch.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./nextTick.js";import"./PooledArray.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4.js";import"./_commonjsHelpers.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./assets.js";import"./LRUCache.js";import"./MemCache.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"../core/reactiveUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./vec4f64.js";const j="picture-fill",h="picture-marker",b="simple-fill",d="simple-line",f="simple-marker",g="text",S="Aa",w=a.size,v=a.maxSize,L=a.maxOutlineSize,k=a.lineWidth,x=225,M=document.createElement("canvas");function U(t,o){const s=M.getContext("2d"),e=[];return o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" "),s.measureText(t).width}const D=7.2/2.54,z=72/2.54;function P(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?e(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?e(o.height):null}}function C(t,o){return t>o?"dark":"light"}function F(t,o){const s="number"==typeof o?.size?o?.size:null,m=null!=s?e(s):null,a=null!=o?.maxSize?e(o.maxSize):null,n=null!=o?.rotation?o.rotation:"angle"in t?t.angle:null,c=i(t);let y=l(t);"dark"!==O(t,245)||o?.ignoreWhiteSymbols||(y={width:.75,...y,color:"#bdc3c7"});const u={shape:null,fill:c,stroke:y,offset:[0,0]};y?.width&&(y.width=Math.min(y.width,L));const x=y?.width||0;let M=null!=o?.size&&(null==o?.scale||o?.scale),C=0,F=0,E=!1;switch(t.type){case f:{const s=t.style,{width:r,height:i}=P(o),l=r===i&&null!=r?r:null!=m?m:Math.min(e(t.size),a||v);switch(C=l,F=l,s){case"circle":u.shape={type:"circle",cx:0,cy:0,r:.5*l},M||(C+=x,F+=x);break;case"cross":u.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[C,.5*F]},{command:"M",values:[.5*C,0]},{command:"L",values:[.5*C,F]}]};break;case"diamond":u.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[.5*C,0]},{command:"L",values:[C,.5*F]},{command:"L",values:[.5*C,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x);break;case"square":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x),n&&(E=!0);break;case"triangle":u.shape={type:"path",path:[{command:"M",values:[.5*C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},M||(C+=x,F+=x),n&&(E=!0);break;case"x":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,F]},{command:"M",values:[C,0]},{command:"L",values:[0,F]}]},n&&(E=!0);break;case"path":u.shape={type:"path",path:t.path||""},M||(C+=x,F+=x),n&&(E=!0),M=!0}break}case d:{const{width:t,height:s}=P(o),e=null!=s?s:null!=m?m:x,r=null!=t?t:k;y&&(y.width=e),C=r,F=e;const i=u?.stroke?.cap||"butt",l="round"===i;M=!0,u.stroke&&(u.stroke.cap="butt"===i?"square":i),u.shape={type:"path",path:[{command:"M",values:[l?e/2:0,F/2]},{command:"L",values:[l?C-e/2:C,F/2]}]};break}case j:case b:{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:s,height:e}=P(o);C=!t&&s!==e||null==s?null!=m?m:w:s,F=!t&&s!==e||null==e?C:e,M||(C+=x,F+=x),M=!0,u.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:p.fill[0];break}case h:{const s=Math.min(e(t.width),a||v),r=Math.min(e(t.height),a||v),{width:i,height:l}=P(o),p=i===l&&null!=i?i:null!=m?m:Math.max(s,r),c=s/r;C=c<=1?Math.ceil(p*c):p,F=c<=1?p:Math.ceil(p/c),u.shape={type:"image",x:-Math.round(C/2),y:-Math.round(F/2),width:C,height:F,src:t.url||""},n&&(E=!0);break}case g:{const s=t,i=o?.overrideText||s.text||S,l=s.font,{width:p,height:n}=P(o),c=null!=n?n:null!=m?m:Math.min(e(l.size),a||v),y=U(i,{weight:l.weight,size:c,family:l.family}),j=/[\uE600-\uE6FF]/.test(i);C=p??(j?c:y),F=c;let h=.25*function(t){if(0===t.length)return 0;if(t.length>2){const o=r(1),s=parseFloat(t);switch(t.slice(-2)){case"px":return s;case"pt":return s*o;case"in":return 72*s*o;case"pc":return 12*s*o;case"mm":return s*D*o;case"cm":return s*z*o}}return parseFloat(t)}((l?c:0).toString());j&&(h+=5),u.shape={type:"text",text:i,x:s.xoffset||0,y:s.yoffset||h,align:"middle",alignBaseline:s.verticalAlignment,decoration:l&&l.decoration,rotated:s.rotated,kerning:s.kerning},u.font=l&&{size:c,style:l.style,decoration:l.decoration,weight:l.weight,family:l.family};break}}return{shapeDescriptor:u,size:[C,F],renderOptions:{node:o?.node,scale:M,opacity:o?.opacity,rotation:n,useRotationSize:E,effectView:o?.effectView,ariaLabel:o?.ariaLabel}}}async function E(t,r){const{shapeDescriptor:i,size:l,renderOptions:a}=F(t,r);if(!i.shape)throw new o("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const s=o.fill,e=t.color;if("pattern"===s?.type&&e&&t.type!==j){const t=await m(s.src,e.toCss(!0));s.src=t,o.fill=s}}(t,i),await async function(t,o,e,r){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await s(t.font)}catch{}const{width:i}=P(r),l=/[\uE600-\uE6FF]/.test(o.shape.text);null!=i||l||(e[0]=U(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family}))}(t,i,l,r);const p=[[i]];if("object"==typeof r?.symbolConfig&&r?.symbolConfig?.applyColorModulation){const t=.6*l[0];p.unshift([{...i,offset:[-t,0],fill:n(i.fill,-.3)}]),p.push([{...i,offset:[t,0],fill:n(i.fill,.3)}]),l[0]+=2*t,a.scale=!1}return"text"===t.type&&function(t,o,s,r,i){if(null!=t.haloColor&&null!=t.haloSize){i.masking??=s.map((()=>[]));const l=e(t.haloSize);r[0]+=l,r[1]+=l,s.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),i.masking.unshift([{shape:{type:"rect",x:0,y:0,width:r[0]+2*y,height:r[1]+2*y},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(r[0]+=2*y,r[1]+=2*y,s.unshift([{shape:{type:"rect",x:0,y:0,width:r[0],height:r[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:e(t.borderLineSize)}}]),i.masking?.unshift([]))}(t,i,p,l,a),c(p,l,a)}function O(o,s=x){const e=i(o),r=l(o),m=!e||"type"in e?null:new t(e),a=r?.color?new t(r?.color):null,p=m?C(u(m),s):null,n=a?C(u(a),s):null;return n?p?p===n?p:s>=x?"light":"dark":n:p}export{O as getContrastingBackgroundTheme,F as getRenderSymbolParameters,E as previewSymbol2D};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{d as e,j as t,k as i,m as s,N as r}from"./mathUtils.js";import{c as n}from"./aaBoundingRect.js";import"../geometry.js";import l from"../core/Error.js";import{v as o,w as a,g as h}from"./unitUtils.js";import c from"../geometry/Extent.js";import{canProjectToWGS84ComparableLonLat as m}from"../geometry/projection.js";import u from"../geometry/SpatialReference.js";import{x2lon as p,y2lat as g}from"../geometry/support/webMercatorUtils.js";import f from"../layers/support/LOD.js";import x from"../layers/support/TileInfo.js";import v from"../geometry/Point.js";class w{constructor(e){const t=w.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=m(this.spatialReference)||o(this.spatialReference)||a(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const s=i.lods.reduce(((e,t,i)=>(t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e)),{min:1/0,minIndex:0,max:-1/0}),r=i.lods[s.minIndex],n=2**r.level;let l=r.resolution*n,h=r.scale*n;this.levels=new Array(s.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:l,scale:h,tileSize:[l*i.size[0],l*i.size[1]]},l/=2,h/=2}clone(){return new w(this.toTileInfo())}toTileInfo(){return new x({dpi:this.dpi,origin:new v({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new f({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,s){const r=this.levels[e],n=r.tileSize[0],l=r.tileSize[1];s[0]=this.origin[0]+i*n,s[2]=this.origin[0]+(i+1)*n,s[3]=this.origin[1]-t*l,s[1]=this.origin[1]-(t+1)*l}convertExtentToRadians(t,i){this._isWebMercator?(i[0]=p(t[0]),i[1]=g(t[1]),i[2]=p(t[2]),i[3]=g(t[3])):this._isGCS&&(i[0]=e(t[0]),i[1]=e(t[1]),i[2]=e(t[2]),i[3]=e(t[3]))}getExtentGeometry(e,t,i,s=new c){return this.getExtent(e,t,i,d),s.spatialReference=this.spatialReference,s.xmin=d[0],s.ymin=d[1],s.xmax=d[2],s.ymax=d[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof w)){if(w.checkUnsupported(e))return!1;e=new w(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,e.levels.length)-1,s=this.levels[i].resolution;let r=.5*s;return!(!t(e.origin[0],this.origin[0],r)||!t(e.origin[1],this.origin[1],r))&&(r=.5*s/2**i/this.pixelSize*12,t(s,e.levels[i].resolution,r))}rootTilesInExtent(e,t=null,i=1/0){const s=new Array,r=this.levels[0].tileSize;if(null==e||0===r[0]||0===r[1])return s;w.computeRowColExtent(e,r,this.origin,d);let n=d[1],l=d[3],o=d[0],a=d[2];const h=a-o,c=l-n;if(h*c>i){const e=Math.floor(Math.sqrt(i));c>e&&(n=n+Math.floor(.5*c)-Math.floor(.5*e),l=n+e),h>e&&(o=o+Math.floor(.5*h)-Math.floor(.5*e),a=o+e)}for(let e=n;e<l;e++)for(let t=o;t<a;t++)s.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+o*r[0],t[1]=this.origin[1]-l*r[1],t[2]=this.origin[0]+a*r[0],t[3]=this.origin[1]-n*r[1]),s}static computeRowColExtent(e,t,i,s){const r=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+r-i[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-r-i[0])/t[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+r)/t[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-r)/t[1]))}static isPowerOfTwo(e){const t=e.lods,s=t[0].resolution*2**t[0].level;return!t.some((e=>!i(e.resolution,s/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new l("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?M():e.lods.length<1?new l("tilingscheme:generic","Tiling scheme must have at least one level"):w.isPowerOfTwo(e)?w.hasGapInLevels(e)?new l("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):w.tileSizeSupported(e)?w.hasOriginPerLODs(e)?new l("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new l("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new l("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],s=e[3]-e[1],r=h(t),n=1.2*Math.max(i,s),l=256,o=new w(new x({size:[l,l],origin:new v({x:e[0]-.5*(n-i),y:e[3]+.5*(n-s)}),lods:[new f({level:0,resolution:n/l,scale:1/(l/96*.0254/(n*r))})],spatialReference:t}));return o.ensureMaxLod(20),o}static makeWebMercatorAuxiliarySphere(e){const t=new w(w.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const s=256/t,r=new w(new x({size:[t,t],origin:new v({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new f({level:0,resolution:.703125*s,scale:295497598.570834*s})]}));return r.ensureMaxLod(i),r}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}function M(){return new l("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}w.WebMercatorAuxiliarySphereTileInfo=new x({size:[256,256],origin:new v({x:-20037508.342787,y:20037508.342787,spatialReference:u.WebMercator}),spatialReference:u.WebMercator,lods:[new f({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),w.WebMercatorAuxiliarySphere=w.makeWebMercatorAuxiliarySphere(19);const d=n(),S=64,z=512,y=2.5,R=s(r/10),b=2,T=n();w.WebMercatorAuxiliarySphere.getExtent(0,0,0,T);const W=n([-180,-90,180,90]),j="Cannot extend surface to encompass all layers because it would result in too many root tiles.",E="Surface extent is too large for tile resolution at level 0.";function L(e){return 3}export{R as E,W as G,S as M,b as P,w as T,T as W,z as a,L as b,j as c,E as d,y as e,M as g};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"./chunks/tslib.es6.js";import{version as t}from"./kernel.js";import r from"./Map.js";import o from"./Viewpoint.js";import{i as s}from"./chunks/typedArrayUtil.js";import i from"./core/Collection.js";import a from"./core/Error.js";import p from"./core/Loadable.js";import{l as n}from"./chunks/loadAll.js";import{L as l}from"./chunks/Logger.js";import{M as m,a as u}from"./chunks/MultiOriginJSONSupport.js";import{EsriPromiseMixin as c}from"./core/Promise.js";import{eachAlways as h}from"./core/promiseUtils.js";import{whenOnce as d}from"./core/reactiveUtils.js";import{urlToObject as y,hasSameCanonicalArcGISOnlinePortal as j,isDataProtocol as g,dataComponents as f,addQueryParameter as b}from"./core/urlUtils.js";import{property as w}from"./core/accessorSupport/decorators/property.js";import"./chunks/ensureType.js";import{r as k}from"./chunks/reader.js";import{subclass as _}from"./core/accessorSupport/decorators/subclass.js";import{w as S}from"./chunks/writer.js";import{u as I}from"./chunks/originUtils.js";import{b as v}from"./core/JSONSupport.js";import A from"./geometry/SpatialReference.js";import{f as U}from"./chunks/unitUtils.js";import{geographicToWebMercator as L,webMercatorToGeographic as P}from"./geometry/support/webMercatorUtils.js";import{e as R}from"./chunks/arcgisLayerUrl.js";import{m as F,a as V}from"./chunks/layerUtils.js";import T from"./networks/UtilityNetwork.js";import O from"./portal/Portal.js";import C from"./portal/PortalItem.js";import{r as x,a as M,h as D,T as E}from"./chunks/portalItemUtils.js";import{p as N}from"./chunks/project.js";import W from"./rest/support/ProjectParameters.js";import{h as B,i as G,f as J}from"./chunks/basemapUtils.js";import K from"./support/MapFloorInfo.js";import z from"./webdoc/GeotriggersInfo.js";import q,{R as $}from"./webmap/InitialViewProperties.js";import{W as H}from"./chunks/Widgets.js";import{g as Q}from"./chunks/thumbnailUtils.js";import{g as Z}from"./chunks/writeUtils.js";import X from"./webmap/ApplicationProperties.js";import Y from"./webmap/Bookmark.js";import{V as ee}from"./chunks/Version.js";import te from"./webmap/background/ColorBackground.js";import"./config.js";import"./chunks/object.js";import"./core/lang.js";import"./chunks/string.js";import"./chunks/maybe.js";import"./Basemap.js";import"./chunks/collectionUtils.js";import"./chunks/deprecate.js";import"./chunks/assets.js";import"./request.js";import"./chunks/messages.js";import"./chunks/locale.js";import"./chunks/ArrayPool.js";import"./chunks/ObjectPool.js";import"./core/Evented.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/get.js";import"./chunks/utils.js";import"./chunks/metadata.js";import"./chunks/ObservableBase.js";import"./chunks/tracking.js";import"./chunks/watch.js";import"./core/scheduling.js";import"./chunks/nextTick.js";import"./chunks/PooledArray.js";import"./chunks/shared.js";import"./chunks/SimpleObservable.js";import"./chunks/asyncUtils.js";import"./chunks/jsonMap.js";import"./geometry/Extent.js";import"./geometry/Geometry.js";import"./geometry/Point.js";import"./core/accessorSupport/decorators/cast.js";import"./portal/PortalQueryParams.js";import"./portal/PortalQueryResult.js";import"./portal/PortalUser.js";import"./portal/PortalFolder.js";import"./portal/PortalGroup.js";import"./portal/PortalItemResource.js";import"./portal/PortalRating.js";import"./Ground.js";import"./Color.js";import"./chunks/colorUtils.js";import"./chunks/mathUtils.js";import"./chunks/vec3.js";import"./chunks/vec3f64.js";import"./chunks/common.js";import"./chunks/vec4.js";import"./chunks/compilerUtils.js";import"./chunks/enumeration.js";import"./chunks/opacityUtils.js";import"./chunks/CollectionFlattener.js";import"./chunks/editableLayers.js";import"./chunks/infoFor3D.js";import"./chunks/collectionUtils2.js";import"./support/LayersMixin.js";import"./layers/Layer.js";import"./geometry.js";import"./geometry/Multipoint.js";import"./chunks/zmUtils.js";import"./geometry/Polygon.js";import"./chunks/extentUtils.js";import"./chunks/aaBoundingRect.js";import"./geometry/Polyline.js";import"./chunks/typeUtils.js";import"./geometry/support/jsonUtils.js";import"./core/Identifiable.js";import"./support/TablesMixin.js";import"./Camera.js";import"./core/Clonable.js";import"./chunks/Cyclical.js";import"./chunks/multiOriginJSONSupportUtils.js";import"./chunks/persistableUrlUtils.js";import"./layers/FeatureLayer.js";import"./PopupTemplate.js";import"./layers/support/fieldUtils.js";import"./chunks/arcadeOnDemand.js";import"./popup/content.js";import"./popup/content/AttachmentsContent.js";import"./popup/content/Content.js";import"./popup/content/CustomContent.js";import"./popup/content/ExpressionContent.js";import"./popup/ElementExpressionInfo.js";import"./popup/content/FieldsContent.js";import"./popup/FieldInfo.js";import"./popup/support/FieldInfoFormat.js";import"./chunks/date.js";import"./chunks/datetime.js";import"./chunks/number.js";import"./popup/content/MediaContent.js";import"./popup/content/BarChartMediaInfo.js";import"./popup/content/mixins/ChartMediaInfo.js";import"./popup/content/mixins/MediaInfo.js";import"./popup/content/support/ChartMediaInfoValue.js";import"./popup/content/support/ChartMediaInfoValueSeries.js";import"./chunks/chartMediaInfoUtils.js";import"./popup/content/ColumnChartMediaInfo.js";import"./popup/content/ImageMediaInfo.js";import"./popup/content/support/ImageMediaInfoValue.js";import"./popup/content/LineChartMediaInfo.js";import"./popup/content/PieChartMediaInfo.js";import"./popup/content/RelationshipContent.js";import"./popup/support/RelatedRecordsInfoFieldOrder.js";import"./popup/content/TextContent.js";import"./popup/ExpressionInfo.js";import"./popup/LayerOptions.js";import"./popup/RelatedRecordsInfo.js";import"./support/actions/ActionBase.js";import"./support/actions/ActionButton.js";import"./support/actions/ActionToggle.js";import"./renderers/ClassBreaksRenderer.js";import"./symbols.js";import"./symbols/CIMSymbol.js";import"./symbols/Symbol.js";import"./symbols/ExtrudeSymbol3DLayer.js";import"./symbols/Symbol3DLayer.js";import"./chunks/utils2.js";import"./symbols/edges/Edges3D.js";import"./chunks/screenUtils.js";import"./chunks/materialUtils.js";import"./symbols/edges/SketchEdges3D.js";import"./symbols/edges/SolidEdges3D.js";import"./chunks/Symbol3DMaterial.js";import"./symbols/FillSymbol.js";import"./symbols/SimpleLineSymbol.js";import"./symbols/LineSymbol.js";import"./symbols/LineSymbolMarker.js";import"./chunks/lineMarkers.js";import"./symbols/FillSymbol3DLayer.js";import"./symbols/patterns/LineStylePattern3D.js";import"./symbols/patterns/StylePattern3D.js";import"./chunks/utils3.js";import"./chunks/colors.js";import"./chunks/symbolLayerUtils3D.js";import"./chunks/aaBoundingBox.js";import"./symbols/Font.js";import"./symbols/IconSymbol3DLayer.js";import"./symbols/LabelSymbol3D.js";import"./symbols/Symbol3D.js";import"./symbols/LineSymbol3DLayer.js";import"./symbols/LineStyleMarker3D.js";import"./symbols/ObjectSymbol3DLayer.js";import"./symbols/PathSymbol3DLayer.js";import"./symbols/TextSymbol3DLayer.js";import"./symbols/WaterSymbol3DLayer.js";import"./symbols/support/StyleOrigin.js";import"./chunks/Thumbnail.js";import"./chunks/calloutUtils.js";import"./symbols/callouts/Callout3D.js";import"./symbols/callouts/LineCallout3D.js";import"./symbols/support/Symbol3DVerticalOffset.js";import"./symbols/LineSymbol3D.js";import"./symbols/MarkerSymbol.js";import"./symbols/MeshSymbol3D.js";import"./symbols/PictureFillSymbol.js";import"./chunks/urlUtils.js";import"./symbols/PictureMarkerSymbol.js";import"./symbols/PointSymbol3D.js";import"./symbols/PolygonSymbol3D.js";import"./symbols/SimpleFillSymbol.js";import"./symbols/SimpleMarkerSymbol.js";import"./symbols/TextSymbol.js";import"./symbols/WebStyleSymbol.js";import"./renderers/Renderer.js";import"./renderers/support/AuthoringInfo.js";import"./renderers/support/AuthoringInfoVisualVariable.js";import"./chunks/colorRamps.js";import"./rest/support/AlgorithmicColorRamp.js";import"./rest/support/ColorRamp.js";import"./rest/support/MultipartColorRamp.js";import"./renderers/mixins/VisualVariablesMixin.js";import"./renderers/visualVariables/ColorVariable.js";import"./renderers/visualVariables/VisualVariable.js";import"./chunks/LegendOptions.js";import"./renderers/visualVariables/support/ColorStop.js";import"./renderers/visualVariables/OpacityVariable.js";import"./renderers/visualVariables/support/OpacityStop.js";import"./renderers/visualVariables/RotationVariable.js";import"./renderers/visualVariables/SizeVariable.js";import"./renderers/visualVariables/support/SizeStop.js";import"./chunks/visualVariableUtils.js";import"./Graphic.js";import"./chunks/lengthUtils.js";import"./renderers/support/ClassBreakInfo.js";import"./chunks/commonProperties.js";import"./symbols/support/jsonUtils.js";import"./renderers/DictionaryRenderer.js";import"./chunks/DictionaryLoader.js";import"./chunks/LRUCache.js";import"./chunks/MemCache.js";import"./layers/support/FieldsIndex.js";import"./renderers/DotDensityRenderer.js";import"./renderers/support/AttributeColorInfo.js";import"./renderers/HeatmapRenderer.js";import"./renderers/support/HeatmapColorStop.js";import"./chunks/heatmapUtils.js";import"./chunks/vec4f64.js";import"./renderers/PieChartRenderer.js";import"./renderers/SimpleRenderer.js";import"./renderers/UniqueValueRenderer.js";import"./chunks/diffUtils.js";import"./renderers/support/UniqueValue.js";import"./renderers/support/UniqueValueClass.js";import"./renderers/support/UniqueValueGroup.js";import"./renderers/support/UniqueValueInfo.js";import"./chunks/styleUtils.js";import"./chunks/featureFlags.js";import"./renderers/support/jsonUtils.js";import"./core/sql.js";import"./form/FormTemplate.js";import"./form/ExpressionInfo.js";import"./form/elements/GroupElement.js";import"./form/elements/Element.js";import"./form/support/elements.js";import"./form/elements/FieldElement.js";import"./form/elements/support/inputs.js";import"./form/elements/inputs/BarcodeScannerInput.js";import"./form/elements/inputs/TextInput.js";import"./form/elements/inputs/Input.js";import"./form/elements/inputs/ComboBoxInput.js";import"./form/elements/inputs/DateTimePickerInput.js";import"./form/elements/inputs/RadioButtonsInput.js";import"./form/elements/inputs/SwitchInput.js";import"./form/elements/inputs/TextAreaInput.js";import"./form/elements/inputs/TextBoxInput.js";import"./chunks/domains.js";import"./layers/support/CodedValueDomain.js";import"./layers/support/Domain.js";import"./layers/support/InheritedDomain.js";import"./layers/support/RangeDomain.js";import"./form/elements/RelationshipElement.js";import"./core/HandleOwner.js";import"./chunks/WatchUpdatingTracking.js";import"./core/workers/workers.js";import"./core/workers/Connection.js";import"./chunks/Queue.js";import"./core/workers/RemoteClient.js";import"./intl.js";import"./chunks/editsZScale.js";import"./chunks/queryZScale.js";import"./chunks/zscale.js";import"./rest/support/FeatureSet.js";import"./layers/support/Field.js";import"./chunks/fieldType.js";import"./layers/mixins/APIKeyMixin.js";import"./chunks/ArcGISService.js";import"./layers/mixins/BlendLayer.js";import"./chunks/jsonUtils.js";import"./chunks/parser.js";import"./chunks/mat4.js";import"./chunks/_commonjsHelpers.js";import"./layers/mixins/CustomParametersMixin.js";import"./chunks/EditBusLayer.js";import"./layers/mixins/FeatureEffectLayer.js";import"./layers/support/FeatureEffect.js";import"./layers/support/FeatureFilter.js";import"./TimeExtent.js";import"./chunks/timeUtils.js";import"./rest/support/Query.js";import"./chunks/DataLayerSource.js";import"./chunks/FullTextSearch.js";import"./chunks/QuantizationParameters.js";import"./rest/support/StatisticDefinition.js";import"./layers/mixins/FeatureLayerBase.js";import"./geometry/HeightModelInfo.js";import"./chunks/commonProperties2.js";import"./support/timeUtils.js";import"./chunks/ElevationInfo.js";import"./chunks/unitConversionUtils.js";import"./chunks/TimeReference.js";import"./chunks/featureLayerUtils.js";import"./rest/support/AttachmentQuery.js";import"./rest/support/RelationshipQuery.js";import"./layers/support/GeometryFieldsInfo.js";import"./layers/support/LayerFloorInfo.js";import"./layers/support/Relationship.js";import"./chunks/serviceCapabilitiesUtils.js";import"./layers/mixins/FeatureReductionLayer.js";import"./layers/support/AggregateField.js";import"./layers/support/ExpressionInfo.js";import"./chunks/FeatureReduction.js";import"./layers/support/FeatureReductionBinning.js";import"./layers/support/LabelClass.js";import"./chunks/labelUtils.js";import"./chunks/defaults.js";import"./chunks/defaultsJSON.js";import"./layers/support/FeatureReductionCluster.js";import"./layers/support/FeatureReductionSelection.js";import"./chunks/clusterUtils.js";import"./chunks/MD5.js";import"./chunks/OperationalLayer.js";import"./layers/mixins/OrderedLayer.js";import"./layers/mixins/PortalLayer.js";import"./geometry/projection.js";import"./chunks/pe.js";import"./chunks/geodesicConstants.js";import"./geometry/support/GeographicTransformation.js";import"./geometry/support/GeographicTransformationStep.js";import"./layers/mixins/PublishableLayer.js";import"./layers/support/PublishingInfo.js";import"./layers/mixins/RefreshableLayer.js";import"./layers/mixins/ScaleRangeLayer.js";import"./layers/mixins/TemporalLayer.js";import"./TimeInterval.js";import"./layers/support/TimeInfo.js";import"./layers/support/FeatureTemplate.js";import"./layers/support/FeatureType.js";import"./chunks/fieldProperties.js";import"./chunks/labelingInfo.js";import"./chunks/versionUtils.js";import"./chunks/styleUtils2.js";import"./rest/support/TopFeaturesQuery.js";import"./rest/support/TopFilter.js";import"./support/popupUtils.js";import"./chunks/featureQueryAll.js";import"./networks/Network.js";import"./networks/support/TopologyValidationJobInfo.js";import"./chunks/ValidateNetworkTopologyResult.js";import"./chunks/typeUtils2.js";import"./networks/support/NamedTraceConfiguration.js";import"./networks/support/TraceConfiguration.js";import"./networks/support/UNTraceConfiguration.js";import"./networks/support/NetworkSystemLayers.js";import"./networks/support/TerminalConfiguration.js";import"./networks/support/Terminal.js";import"./networks/support/TraceJobInfo.js";import"./rest/networks/support/TraceResult.js";import"./rest/networks/support/AggregatedGeometry.js";import"./rest/networks/support/FunctionResult.js";import"./rest/networks/support/NetworkElement.js";import"./chunks/utils4.js";import"./chunks/utils5.js";import"./layers/support/FacilityLayerInfo.js";import"./layers/support/LevelLayerInfo.js";import"./layers/support/SiteLayerInfo.js";import"./webdoc/geotriggersInfo/FenceGeotrigger.js";import"./webdoc/geotriggersInfo/DeviceLocationFeed.js";import"./webdoc/geotriggersInfo/ExpressionInfo.js";import"./webdoc/geotriggersInfo/FeatureFenceParameters.js";import"./webdoc/geotriggersInfo/FeatureFilter.js";import"./webdoc/geotriggersInfo/FeatureLayerSource.js";import"./webdoc/geotriggersInfo/Geotrigger.js";import"./webdoc/geotriggersInfo/GeotriggerNotificationOptions.js";import"./webdoc/applicationProperties/Viewing.js";import"./webdoc/applicationProperties/Search.js";import"./webdoc/applicationProperties/SearchLayer.js";import"./webdoc/applicationProperties/SearchLayerField.js";import"./webdoc/applicationProperties/SearchTable.js";import"./webdoc/applicationProperties/SearchTableField.js";import"./chunks/SlideThumbnail.js";class re extends ee{constructor(e,t){super(e,t,"webmap")}}const oe=new re(2,28),se="Web Map",ie=i.ofType(Y),ae=i.ofType(T),pe=new Map;pe.set("image/jpeg","jpeg"),pe.set("image/jpg","jpg"),pe.set("image/png","png"),pe.set("image/gif","gif");const ne=E.JSAPI,le="CollectorDisabled",me="Collector",ue="Data Editing",ce="OfflineDisabled",he="Offline",de="Workforce Project",ye="Workforce Worker",je="Workforce Dispatcher",ge=E.DEVELOPER_BASEMAP,fe="UtilityNetwork",be=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));let we=class extends(m(p.LoadableMixin(c(r)))){constructor(e){super(e),this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1,this._thumbnailFilename=null,this._updateFromPromise=null,this._resourceReferences={portalItem:null,paths:[]},this.applicationProperties=null,this.bookmarks=new ie,this.floorInfo=null,this.geotriggersInfo=null,this.initialViewProperties=new q,this.portalItem=null,this.presentation=null,this.sourceVersion=null,this.widgets=null,this.utilityNetworks=null,this.authoringApp=this.authoringAppVersion=null,this._isAuthoringAppSetByUser=this._isAuthoringAppVersionSetByUser=!1}destroy(){const e=this.portalItem;this.portalItem=null,e?.destroy()}initialize(){if(this.when().catch((e=>{l.getLogger(this).error("#load()","Failed to load web map",e)})),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(e)}}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp=ne}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=t}readInitialViewProperties(e,t){const r=new q;t.background&&(r.background=te.fromJSON(t.background));const s=t.initialState?.viewpoint;return s&&(s.rotation&&re.parse(t.version||"","webmap").lessThan(2,20)&&"ArcGIS Pro"===t.authoringApp&&(s.rotation*=-1),r.viewpoint=o.fromJSON(s)),t.mapRangeInfo&&(r.rangeInfo=$.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=A.fromJSON(t.spatialReference)),r}writeInitialViewProperties(e,t,r,o){if(!e)return;const s=e.background;s&&s.color&&(t.background=s.write({},o)),e.viewpoint&&(t.initialState={viewpoint:e.viewpoint.write({},o)}),e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(o)),e.spatialReference&&(t.spatialReference=e.spatialReference.write({},o))}writeLayers(e,t,r,o){t[r]=this._writeLayers(e,o,"operational-layers")}readSourceVersion(e,t){const[r,o]=t.version.split(".");return new re(parseInt(r,10),parseInt(o,10))}writeSourceVersion(e,t,r){t[r]=`${oe.major}.${oe.minor}`}writeTables(e,t,r,o){const s=this._writeLayers(e,o,"tables");s.length&&(t[r]=s)}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return n(this,(e=>{e(this.ground,this.basemap,this.layers,this.tables)}))}read(e,t){t={...t,origin:"web-map"};const r=this._getAuthoringPropsState();v(this,e,(t=>super.read(e,t)),t),this._restoreAuthoringPropsFromState(r)}write(e,t){if("loaded"!==this.loadStatus){const e=new a("webmap:not-loaded","Web map must be loaded before it can be serialized");throw l.getLogger(this).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),e}return this._removeDanglingLayerRefs(),t={...t,origin:"web-map",restrictedWebMapWriting:!0,webmap:this},super.write(e,t)}async save(e){e=e||{},this._validateItem();const t=import("./chunks/saveUtils.js");await this._updateFromPromise,await this.load(),await this._loadLayerContainers(),await this._beforeSave(),await this._validateMap();const r=this.portalItem,o=y(r.itemUrl),s={origin:"web-map",messages:[],writtenProperties:[],url:o,portal:r.portal||O.getDefault(),portalItem:r,verifyItemRelativeUrls:o?{rootPath:o.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},i=this.write({},s);return await Promise.all(s.resources.pendingOperations),this._validateJSONForWriting(s,e),await this._updateItemProperties(r),await this._updateItem(r,i,s),await Promise.all([this._updateItemThumbnail(),t.then((({saveResources:e})=>e(this._resourceReferences,s,null)))]),r}async saveAs(e,t){t=t||{};const r=this._getPortalItem(e),o=import("./chunks/saveUtils.js");await this._updateFromPromise,await this.load(),await this._loadLayerContainers(),await this._beforeSave(),await this._validateMap();const s={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:r.portal,portalItem:r,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},i=this.write({},s);await Promise.all(s.resources.pendingOperations),this._validateJSONForWriting(s,t),await this._updateItemPropertiesForSaveAs(r);const a=this._getThumbnailState();return await this._createItem(r,i,s,t)&&(this._resourceReferences.portalItem=r),this._restoreThumbnailFromState(a),await Promise.all([this._updateItemThumbnail(),o.then((({saveResources:e})=>e(this._resourceReferences,s,null)))]),r}async updateFrom(e,t){const r=this._updateFromInternal(e,t);this._updateFromPromise=r,await r,r===this._updateFromPromise&&(this._updateFromPromise=null)}getLayerJSONFromResourceInfo(e){const t=this.resourceInfo;return this._collectAllLayersJSON([...t?.baseMap?.baseMapLayers||[],...t?.operationalLayers||[],...this.basemap?.resourceInfo?.data?.baseMapLayers||[]]).find((t=>t.id===e.id))}_collectAllLayersJSON(e){return e.reduce(((e,t)=>(e.push(t),"GroupLayer"===t.layerType&&(e=e.concat(this._collectAllLayersJSON(t.layers||[]))),e)),[])}_writeLayers(e,t,r){return t={...t,layerContainerType:r},e.map((e=>Z(e,"tables"===r?null:this.getLayerJSONFromResourceInfo(e),t))).filter(s).toArray()}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):Promise.resolve()}async _loadFromItem(e){if(await e.load().catch((e=>{throw new a("webmap:load-portal-item","Failed to load portal item",{error:e})})),"Web Map"!==e.type)throw new a("webmap:invalid-portal-item",`Invalid portal item type '${e.type}', expected 'Web Map'`,{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const r={origin:"web-map",url:y(e.itemUrl),portal:e.portal||O.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,r),this._resourceReferences={portalItem:e,paths:r.readResourcePaths??[]};const s=await async function(e,t,r){const s=e?.viewpoint?.targetGeometry;if(s)return null;const i=await async function(e,t,r){const o=e?.spatialReference,s=t?.extent;if(!o||!s)return null;if(o.isWGS84)return s.clone();if(o.isWebMercator)return L(s);const{getGeometryServiceURL:i}=await import("./chunks/geometryServiceUtils.js");try{const e=await i(t),r=new W;return r.geometries=[s],r.outSpatialReference=o,(await N(e,r))[0]}catch(e){r.error("Error projecting item's extent:",e)}return null}(e,t,r);return i?new o({targetGeometry:i}):null}(this.initialViewProperties,e,l.getLogger(this));if(s){const e=this.initialViewProperties?.clone()??new q;e.viewpoint=s,this.initialViewProperties=e}}_readAndLoadFromJSON(e,t){const r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)}_validateJSON(e){const t=re.parse(e.version||"","webmap");return oe.validate(t),e.version=`${t.major}.${t.minor}`,e}_loadFromJSON(e,t){const r={context:{...t,layerContainerType:"operational-layers"}};return this.portalItem&&(r.context.portal=this.portalItem.portal||O.getDefault()),import("./chunks/layersCreator.js").then((({populateOperationalLayers:t})=>{const o=[],s=e.operationalLayers;s&&s.length&&o.push(t(this.layers,s,r));const i={...r,context:{...r.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},a=e.tables;return a&&a.length&&o.push(t(this.tables,a,i)),h(o).then((()=>{}))}))}_removeDanglingLayerRefs(){const e=this.applicationProperties,t=e&&e.viewing&&e.viewing.search,r=e=>this.allLayers.some((t=>t.id===e));t&&t.layers&&(t.layers=t.layers.filter((e=>r(e.id)))),t&&t.tables&&(t.tables=t.tables.filter((e=>this.tables.some((t=>t.id===e.id)))));const o=e&&e.editing&&e.editing.locationTracking;o&&o.info&&!r(o.info.layerId)&&(e.editing=null);const s=this.presentation&&this.presentation.slides;s&&s.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>r(e.id))))}))}async _validateMap(){if(!this.basemap?.baseLayers.length)throw new a("webmap:save","Map does not have a valid basemap with a base layer.");let e=null;if(await d((()=>{const t=J(this.initialViewProperties,this.basemap);return e=t.spatialReference,!t.updating})),!U(e,this.initialViewProperties.spatialReference))throw new a("webmap:save","The spatial reference of the basemap is not compatible with the one from the map.",{expected:this.initialViewProperties.spatialReference,actual:e})}_validateItem(){if(!this.portalItem)throw l.getLogger(this).error("save: requires the portalItem property to be set"),new a("webmap:portal-item-not-set","Portal item to save to has not been set on the WebMap");this._validateItemType(this.portalItem)}_validateItemType(e){if(e.type!==se)throw new a("webmap:portal-item-wrong-type",`Portal item needs to have type "${se}"`)}_loadLayerContainers(){const e=[];return this.basemap&&e.push(this.basemap.load()),this.ground&&e.push(this.ground.load()),h(e).then((()=>{}))}async _beforeSave(){const e=[];for(const t of this.allLayers)if("beforeSave"in t&&"function"==typeof t.beforeSave){const r=t.beforeSave();r&&e.push(r)}await h(e)}_loadAllLayers(){const e=this._getAllLayersAndTables().map((e=>e.load()));return h(e).then((()=>{}))}_getAllLayersAndTables(){return this.allLayers.concat(this.allTables)}_validateJSONForWriting(e,t){let r=(e.messages??[]).filter((e=>"error"===e.type)).map((e=>new a(e.name,e.message,e.details)));if(e.blockedRelativeUrls&&(r=r.concat(e.blockedRelativeUrls.map((e=>new a("url:unsupported",`Relative url '${e}' is not supported in Web Map`))))),t.ignoreUnsupported&&(r=r.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name))),r.length>0)throw new a("webmap:save","Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}async _updateItemProperties(e){e.extent=await this._getWGS84Extent(this.initialViewProperties.viewpoint.targetGeometry),await this._updateTypeKeywords(e)}async _updateItemPropertiesForSaveAs(e){x(e,le),x(e,"FieldMapsDisabled"),x(e,E.METADATA),x(e,ce),x(e,"Offline Map Areas"),x(e,je),x(e,de),x(e,ye),await this._updateItemProperties(e)}async _getWGS84Extent(e){const t=e.clone().normalize();let r;if(t.length>1)for(const e of t)r?e.width>r.width&&(r=e):r=e;else r=t[0];return this._projectToWGS84(r)}async _projectToWGS84(e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return P(e);const{getGeometryServiceURL:r}=await import("./chunks/geometryServiceUtils.js"),o=await r(this.portalItem),s=new W;return s.geometries=[e],s.outSpatialReference=A.WGS84,(await N(o,s))[0]}async _updateTypeKeywords(e){M(e,ne),await this._loadAllLayers(),this._evalCollectorKeyword(e),this._evalDataEditingKeyword(e),this._evalOfflineKeyword(e),this._evalDeveloperBasemapKeyword(e),this._evalUtilityNetworkKeyword(e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}_evalCollectorKeyword(e){D(e,le)||D(e,de)||D(e,ye)||D(e,je)||!this._hasEditableFeatureLayer()?x(e,me):M(e,me)}_evalDataEditingKeyword(e){this._hasEditableFeatureLayer()?M(e,ue):x(e,ue)}_evalOfflineKeyword(e){!D(e,ce)&&this._isOfflineCapableMap()?M(e,he):x(e,he)}_evalDeveloperBasemapKeyword(e){B(this.basemap)?M(e,ge):x(e,ge)}_evalUtilityNetworkKeyword(e){this.utilityNetworks?.length?M(e,fe):x(e,fe)}_hasEditableFeatureLayer(){return this._getAllLayersAndTables().some((e=>e.loaded&&F(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}_isOfflineCapableMap(){return this._getAllLayersAndTables().filter((e=>"group"!==e.type)).every((e=>e.loaded&&this._isOfflineCapableLayer(e)))}_isFeatureCollectionLike(e){return V(e)||"map-notes"===e.type||"route"===e.type}_isOfflineCapableLayer(e){return F(e)&&e.capabilities.operations.supportsSync||this._isFeatureCollectionLike(e)&&!e.portalItem||("tile"===e.type||"vector-tile"===e.type)&&(e.capabilities.operations.supportsExportTiles||this._isExportableAGOLTileLayer(e)||G(e))&&e.spatialReference.equals(this.initialViewProperties.spatialReference)}_isExportableAGOLTileLayer(e){return"tile"===e.type&&R(e.url)&&be.some((t=>e.url?.toLowerCase().includes("/"+t+"/")))}async _updateItem(e,t,r){await e.update({data:t}),this._syncUpInstanceWithItem(e,t,r)}async _createItem(e,t,r,o){const s=this.portalItem,i={item:s,authenticated:!(!s?.id||!s.portal.user)},p=e.portal;await p.signIn();const{copyAllowed:n,itemReloaded:l}=await this._isCopyAllowed(i,p);if(i.authenticated||=l,!n)throw new a("webmap:save-as-copy-not-allowed","Owner of this map does not allow others to save a copy");const m=await this._initializeNewItem(e,i,t,o);return this.portalItem=e,this._syncUpInstanceWithItem(e,t,r),m}async _isCopyAllowed(e,t){const{item:r,authenticated:o}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async _initializeNewItem(e,t,r,o){const s=e.portal,{item:i}=t,{folder:a,copyAllResources:p}=o;let n=!1;if(p&&i?.id&&j(i.portal.url,s.url)){const{total:e}=await i.fetchResources();n=!!e}if(n){const t=await i.copy({copyResources:"all",folder:a});e.id=t.id,e.portal=t.portal;const o=e.toJSON();await e.load(),e.read(o),await e.update({data:r})}else await(s.user?.addItem({item:e,folder:a,data:r}));return n}_syncUpInstanceWithItem(e,t,r){u.prototype.read.call(this,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:"web-map",ignoreDefaults:!0,url:e.itemUrl?y(e.itemUrl):void 0}),I(r),this.resourceInfo=t}async _updateItemThumbnail(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(await(this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename})),this._clearThumbnailOverride())}_getPortalItem(e){let t=C.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=se),t.portal||(t.portal=O.getDefault()),this._validateItemType(t),t}async _updateFromInternal(e,t){if(t=t||{},await d((()=>e.ready)),this._updateInitialViewProperties(e,t),e.map===this)for(const t of e.allLayerViews)"visible"in t&&"visible"in t.layer&&t._isOverridden("visible")&&(t.layer.visible=t.visible),"featureEffect"in t&&"featureEffect"in t.layer&&t._isOverridden("featureEffect")&&(t.layer.featureEffect=t.featureEffect);await this._updateThumbnailUrl(e,t)}_updateInitialViewProperties(e,t){if(t.backgroundExcluded||(this.initialViewProperties.background=e.background?.clone()),this.initialViewProperties.spatialReference=e.spatialReference?.clone(),t.viewpointExcluded||(this.initialViewProperties.viewpoint=new o({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded)for(const t of e.persistableViewModels)t.updateWebDocument(this)}_getViewExtent(e){const t=e.center.clone().normalize(),r=e.extent.clone(),o=r.width/2;return r.xmin=t.x-o,r.xmax=t.x+o,r}async _updateThumbnailUrl(e,t){if(t.thumbnailExcluded)return;const r=Q(e,t.thumbnailSize),o=await e.takeScreenshot({format:"png",width:r.width,height:r.height});this._setAutoGeneratedThumbnail(o.dataUrl)}_setAutoGeneratedThumbnail(e){this.thumbnailUrl=e,this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}_generateCustomThumbnailFilename(e){if(g(e)){const t=f(e),r=t&&t.mediaType,o=r&&pe.get(r.toLowerCase())||null,s=`thumbnail${Date.now()}`;return o?`${s}.${o}`:s}return null}_getThumbnailState(){let e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:b(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}}_restoreThumbnailFromState(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}static fromJSON(e){const t=e;if(!t)throw new a("webmap:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})}};we.VERSION=oe,e([w({type:X,json:{write:!0}})],we.prototype,"applicationProperties",void 0),e([w({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],we.prototype,"authoringApp",null),e([S("authoringApp")],we.prototype,"writeAuthoringApp",null),e([w({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],we.prototype,"authoringAppVersion",null),e([S("authoringAppVersion")],we.prototype,"writeAuthoringAppVersion",null),e([w({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],we.prototype,"basemap",void 0),e([w({type:ie,json:{write:{overridePolicy:e=>({enabled:!!(e&&e.length>0),ignoreOrigin:!0})}}})],we.prototype,"bookmarks",void 0),e([w({type:K,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],we.prototype,"floorInfo",void 0),e([w({type:z,json:{write:!0}})],we.prototype,"geotriggersInfo",void 0),e([w({type:q,nonNullable:!0,json:{read:{source:["background","initialState.viewpoint","mapRangeInfo","spatialReference"]},write:{ignoreOrigin:!0,target:{background:{type:te},"initialState.viewpoint":{type:o},mapRangeInfo:{type:$},spatialReference:{type:A}}}}})],we.prototype,"initialViewProperties",void 0),e([k("initialViewProperties")],we.prototype,"readInitialViewProperties",null),e([S("initialViewProperties")],we.prototype,"writeInitialViewProperties",null),e([w({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],we.prototype,"layers",void 0),e([S("layers")],we.prototype,"writeLayers",null),e([w({type:C})],we.prototype,"portalItem",void 0),e([w({json:{write:!0}})],we.prototype,"presentation",void 0),e([w()],we.prototype,"resourceInfo",void 0),e([w({readOnly:!0,type:re,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],we.prototype,"sourceVersion",void 0),e([k("sourceVersion")],we.prototype,"readSourceVersion",null),e([S("sourceVersion")],we.prototype,"writeSourceVersion",null),e([w({json:{read:!1,write:{ignoreOrigin:!0}}})],we.prototype,"tables",void 0),e([S("tables")],we.prototype,"writeTables",null),e([w()],we.prototype,"thumbnailUrl",null),e([w({type:H,json:{write:!0}})],we.prototype,"widgets",void 0),e([w({type:ae,json:{read:!0,write:!0}})],we.prototype,"utilityNetworks",void 0),we=e([_("esri.WebMap")],we);const ke=we;export{ke as default};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{g as n,s as i}from"../../chunks/object.js";import{l as t}from"../../chunks/arcadeOnDemand.js";import"../../core/lang.js";import"../../chunks/typedArrayUtil.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/string.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../chunks/tslib.es6.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/tracking.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";var r;function o(e,n){switch(e.type){case"range":{const i="range"in e?e.range[0]:e.minValue,t="range"in e?e.range[1]:e.maxValue;if(null!=i&&+n<i||null!=t&&+n>t)return r.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(null==e.codedValues||e.codedValues.every((e=>null==e||e.code!==n)))return r.INVALID_CODED_VALUE}return null}function s(e){if(e&&"range"===e.type)return{min:"range"in e?e.range[0]:e.minValue,max:"range"in e?e.range[1]:e.maxValue}}!function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"}(r||(r={}));const l=/^([0-9_])/,a=/[^a-z0-9_\u0080-\uffff]+/gi;function u(e){return null==e?null:e.trim().replaceAll(a,"_").replace(l,"F$1")||null}const c=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],f=["field","normalizationField"];function d(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(m(c,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)m(f,e,n)}function m(e,t,r){if(e)for(const o of e){const e=n(o,t),s=e&&"function"!=typeof e&&r.get(e);s&&i(o,s.name,t)}}function p(e,n){if(null!=e&&n?.fields?.length)if("startField"in e){const i=n.get(e.startField),t=n.get(e.endField);e.startField=i?.name??null,e.endField=t?.name??null}else{const i=n.get(e.startTimeField),t=n.get(e.endTimeField);e.startTimeField=i?.name??null,e.endTimeField=t?.name??null}}const y=new Set;function g(e,n){return e&&n?(y.clear(),F(y,e,n),Array.from(y).sort()):[]}function F(e,n,i){if(i)if(n?.fields?.length)if(i.includes("*"))for(const{name:i}of n.fields)e.add(i);else for(const t of i)h(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)null!=n&&e.add(n)}}function h(e,n,i){if("string"==typeof i)if(n){const t=n.get(i);t&&e.add(t.name)}else e.add(i)}function I(e,n){return null==n||null==e?[]:n.includes("*")?(e.fields??[]).map((e=>e.name)):n}function j(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=g(e,n);return t.length/e.fields.length>=i?["*"]:t}async function b(e,n,i){if(!i)return;const{arcadeUtils:r}=await t(),o=r.extractFieldNames(i,n?.fields?.map((e=>e.name)));for(const i of o)h(e,n,i)}async function x(n,i,t){if(t&&"1=1"!==t){const{WhereClause:r}=await import("../../core/sql/WhereClause.js").then((e=>e.W)),o=r.create(t,i);if(!o.isStandardized)throw new e("fieldUtils:collectFilterFields","Where clause is not standardized",{where:t});F(n,i,o.fieldNames)}}function T({displayField:e,fields:n}){return e||(n&&n.length?w(n,"name-or-title")||w(n,"unique-identifier")||w(n,"type-or-category")||function(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.includes("name")||e.includes("title"))return n.name}return null}(n):null)}function w(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}async function _(e){if(!e)return[];const n=new Set;return await k(n,e),Array.from(n).sort()}async function k(e,n){if(!n)return;const i=n.elevationInfo?.featureExpressionInfo;return i?i.collectRequiredFields(e,n.fieldsIndex):void 0}async function v(e,n,i){if(!n||!i||!("fields"in i))return;const t=[],r=i.popupTemplate;t.push(A(e,n,r)),i.fields&&t.push(...i.fields.map((async i=>function(e,n,i){i.onStatisticExpression?b(e,n,i.onStatisticExpression.expression):e.add(i.onStatisticField)}(e,n.fieldsIndex,i)))),await Promise.all(t)}async function A(e,n,i){const t=[];i?.expressionInfos&&t.push(...i.expressionInfos.map((i=>b(e,n.fieldsIndex,i.expression))));const r=i?.content;if(Array.isArray(r))for(const i of r)"expression"===i.type&&i.expressionInfo&&t.push(b(e,n.fieldsIndex,i.expressionInfo.expression));await Promise.all(t)}async function E(e,n,i){n&&(n.timeInfo&&null!=i&&i.timeExtent&&F(e,n.fieldsIndex,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&F(e,n.fieldsIndex,[n.floorInfo.floorField]),null!=i&&null!=i.where&&await x(e,n.fieldsIndex,i.where))}async function S(e,n,i){n&&i&&await Promise.all(i.map((i=>async function(e,n,i){n&&i&&(i.valueExpression?await b(e,n.fieldsIndex,i.valueExpression):i.field&&h(e,n.fieldsIndex,i.field))}(e,n,i))))}async function N(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?g(e.fieldsIndex,[e.trackIdField,n.startField,n.endField]):[]}function V(e){return e?g(e.fieldsIndex,C(e)):[]}function L(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?g(e.fieldsIndex,[n.shapeAreaField,n.shapeLengthField]):[]}const O=["oid","global-id","guid"],$=["oid","global-id"],D=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i];function U(e){const n=new Set;P(e).forEach((e=>n.add(e))),L(e).forEach((e=>n.add(e.toLowerCase())));const i=e&&"infoFor3D"in e?e.infoFor3D:void 0;return i&&(Object.values(i.assetMapFieldRoles).forEach((e=>n.add(e.toLowerCase()))),Object.values(i.transformFieldRoles).forEach((e=>n.add(e.toLowerCase())))),Array.from(n)}function C(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;if(!n)return[];const{creationDateField:i,creatorField:t,editDateField:r,editorField:o}=n;return[i,t,r,o].filter(Boolean)}function P(e){return C(e).map((e=>e.toLowerCase()))}function R(e,n){return e.editable&&!O.includes(e.type)&&!P(n).includes(e.name?.toLowerCase()??"")}function G(e,n){const i=e.name?.toLowerCase()??"";return!(null!=n?.objectIdField&&i===n.objectIdField.toLowerCase()||null!=n?.globalIdField&&i===n.globalIdField.toLowerCase()||U(n).includes(i)||$.includes(e.type)||D.some((e=>e.test(i))))}async function M(e){if(!e)return[];const n=new Set;return await z(n,e),Array.from(n).sort()}async function z(e,n){const{labelingInfo:i,fieldsIndex:t}=n;i&&i.length&&await Promise.all(i.map((n=>async function(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await b(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{h(e,n,i.slice(1,-1))}))}await x(e,n,r)}(e,t,n))))}function W(e){const n=e.defaultValue;return void 0!==n&&Q(e,n)?n:e.nullable?null:void 0}function B(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function X(e){return null===e||B(e)}const q="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function J(e){return null===e||q(e)}function Y(e){return null!=e&&"string"==typeof e}function H(e){return null===e||Y(e)}function K(){return!0}function Q(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?J:q;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?X:B;break;case"string":case"esriFieldTypeString":i=e.nullable?H:Y;break;default:i=K}return 1===arguments.length?i:i(n)}const Z=["integer","small-integer","single","double"],ee=new Set([...Z,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]),ne=["date","date-only","time-only","timestamp-offset"],ie=new Set([...ne,"esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]);function te(e){return null!=e&&ee.has(e.type)}function re(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function oe(e){return null!=e&&ie.has(e.type)}function se(e,n){return null===ce(e,n)}var le,ae;function ue(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function ce(e,n){return null==e||e.nullable&&null===n?null:te(e)&&!fe(e.type,Number(n))?le.OUT_OF_RANGE:Q(e,n)?e.domain?o(e.domain,n):null:ae.INVALID_TYPE}function fe(e,n){const i="string"==typeof e?me(e):e;if(!i)return!1;const t=i.min,r=i.max;return i.isInteger?q(n)&&n>=t&&n<=r:n>=t&&n<=r}function de(e){return s(e.domain)||(te(e)?me(e.type):void 0)}function me(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return ye;case"esriFieldTypeInteger":case"integer":return ge;case"esriFieldTypeBigInteger":case"big-integer":return Fe;case"esriFieldTypeSingle":case"single":return he;case"esriFieldTypeDouble":case"double":return Ie}}function pe(e){if(!B(e))return null;if(q(e)){if(e>=ye.min&&e<=ye.max)return"esriFieldTypeSmallInteger";if(e>=ge.min&&e<=ge.max)return"esriFieldTypeInteger"}return e>=he.min&&e<=he.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(le||(le={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(ae||(ae={}));const ye={min:-32768,max:32767,isInteger:!0},ge={min:-2147483648,max:2147483647,isInteger:!0},Fe={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0},he={min:-34e37,max:12e37,isInteger:!1},Ie={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function je(e,n,i){switch(e){case r.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case r.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case ae.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case le.OUT_OF_RANGE:{const{min:e,max:t}=me(n.type);return`Value ${i} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${t}`}}}function be(e,n){return!xe(e,n,null)}function xe(e,n,i){if(!n||!n.attributes||!e){if(null!=i)for(const n of e??[])i.add(n);return!0}const t=n.attributes;let r=!1;for(const n of e)if(!(n in t)){if(r=!0,null==i)break;i.add(n)}return r}async function Te(e,n){const i=new Set;for(const t of n)await b(i,e.fieldsIndex,t);return Array.from(i).sort()}function we(e){return!!e&&["raster.itempixelvalue","raster.servicepixelvalue"].some((n=>e.toLowerCase().startsWith(n)))}export{r as D,le as NumericRangeValidationError,ae as TypeValidationError,Fe as bigIntegerRange,b as collectArcadeFieldNames,k as collectElevationFields,v as collectFeatureReductionFields,h as collectField,F as collectFields,E as collectFilterFields,z as collectLabelingFields,S as collectOrderByInfos,A as collectPopupTemplateFields,ne as dateTypes,Ie as doubleRange,be as featureHasFields,g as fixFields,d as fixRendererFields,p as fixTimeInfoFields,s as g,T as getDisplayFieldName,C as getEditTrackingFields,_ as getElevationFields,Te as getExpressionFields,V as getFeatureEditFields,L as getFeatureGeometryFields,W as getFieldDefaultValue,de as getFieldRange,M as getLabelingFields,U as getLowerCaseDefaultHiddenFields,P as getLowerCaseEditTrackingFields,pe as getNumericTypeForValue,N as getTimeFields,ge as integerRange,oe as isDateField,R as isFieldEditable,G as isFieldVisibleByDefault,fe as isNumberInRange,te as isNumericField,we as isRasterPixelValueField,re as isStringField,se as isValidFieldValue,Q as isValueMatchingFieldType,u as normalizeFieldName,Z as numericTypes,j as packFields,xe as populateMissingFields,c as rendererFields,ue as sanitizeNullFieldValue,he as singleRange,ye as smallIntegerRange,I as unpackFieldNames,o as v,ce as validateFieldValue,je as validationErrorToString,f as visualVariableFields};

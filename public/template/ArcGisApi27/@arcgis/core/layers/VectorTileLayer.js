/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import e from"../request.js";import{c as r}from"../chunks/asyncUtils.js";import s from"../core/Error.js";import{clone as i}from"../core/lang.js";import{M as o}from"../chunks/MultiOriginJSONSupport.js";import{throwIfAborted as l,isAbortError as n,onAbort as a,isAborted as p,throwIfAbortError as u}from"../core/promiseUtils.js";import{urlToObject as c,objectToQuery as h,addQueryParameters as m,isAbsolute as y,join as d,isProtocolRelative as f,removeTrailingSlash as g,normalize as j,removeFile as S,getAppBaseUrl as w,p as x}from"../core/urlUtils.js";import{property as v}from"../core/accessorSupport/decorators/property.js";import{o as k}from"../chunks/ensureType.js";import{r as _}from"../chunks/reader.js";import{subclass as U}from"../core/accessorSupport/decorators/subclass.js";import{w as b}from"../chunks/writer.js";import I from"../geometry/Extent.js";import T from"../geometry/SpatialReference.js";import P from"./Layer.js";import{APIKeyMixin as R}from"./mixins/APIKeyMixin.js";import{ArcGISCachedService as O}from"./mixins/ArcGISCachedService.js";import{A as L}from"../chunks/ArcGISService.js";import{BlendLayer as A}from"./mixins/BlendLayer.js";import{CustomParametersMixin as C}from"./mixins/CustomParametersMixin.js";import{O as M}from"../chunks/OperationalLayer.js";import{PortalLayer as D}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as E}from"./mixins/ScaleRangeLayer.js";import{L as N}from"../chunks/Logger.js";import{v as q,c as B}from"../chunks/typedArrayUtil.js";import F from"./support/TileInfo.js";import{T as z}from"../chunks/TilemapCache.js";import{T as V}from"../chunks/TileKey2.js";import{d as $}from"../chunks/maybe.js";import{c as K}from"../chunks/jsonContext.js";import{e as G}from"../chunks/persistableUrlUtils.js";import W from"../geometry/Point.js";import J from"./support/LOD.js";import{S as Q}from"../chunks/StyleRepository.js";import{g as H}from"../chunks/capabilities2.js";import"../config.js";import"../chunks/object.js";import"../kernel.js";import"../chunks/string.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../core/JSONSupport.js";import"../geometry/Geometry.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/TileInfoTilemapCache.js";import"../chunks/TileKey.js";import"../chunks/ByteSizeUnit.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../core/reactiveUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../chunks/commonProperties2.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../chunks/opacityUtils.js";import"../chunks/layerUtils.js";import"../portal/Portal.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItem.js";import"../chunks/assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/SimpleObservable.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/StyleDefinition.js";import"../chunks/enums.js";import"../chunks/enums2.js";import"../chunks/enums3.js";import"../chunks/VertexElementDescriptor.js";import"../Color.js";import"../chunks/colorUtils2.js";import"../chunks/GeometryUtils.js";import"../chunks/unitBezier.js";import"../chunks/definitions.js";import"../chunks/contextUtils.js";let Y=null;class X{constructor(t,e){this._spriteSource=t,this._maxTextureSize=e,this.devicePixelRatio=1,this._spriteImageFormat="png",this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded","url"===t.type&&t.spriteFormat&&(this._spriteImageFormat=t.spriteFormat),t.pixelRatio&&(this.devicePixelRatio=t.pixelRatio),this.baseURL=t.spriteUrl}get spriteNames(){const t=[];for(const e in this._spritesData)t.push(e);return t.sort(),t}getSpriteInfo(t){return this._spritesData?this._spritesData[t]:null}async load(t){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(t),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"}async _loadSprites(t){this._isRetina=this.devicePixelRatio>1.15;const{width:e,height:r,data:i,json:o}=await this._getSpriteData(this._spriteSource,t),l=Object.keys(o);if(!l||0===l.length||!i)return this._spritesData=this.image=null,void(this.width=this.height=0);this._spritesData=o,this.width=e,this.height=r;const n=Math.max(this._maxTextureSize,4096);if(e>n||r>n){const t=`Sprite resource for style ${this.baseURL} is bigger than the maximum allowed of ${n} pixels}`;throw N.getLogger("esri.layers.support.SpriteSource").error(t),new s("SpriteSource",t)}let a;for(let t=0;t<i.length;t+=4)a=i[t+3]/255,i[t]=i[t]*a,i[t+1]=i[t+1]*a,i[t+2]=i[t+2]*a;this.image=i}async _getSpriteData(t,r){if("image"===t.type){let e,r;if(this.devicePixelRatio<1.15){if(!t.spriteSource1x)throw new s("SpriteSource","no image data provided for low resolution sprites!");e=t.spriteSource1x.image,r=t.spriteSource1x.json}else{if(!t.spriteSource2x)throw new s("SpriteSource","no image data provided for high resolution sprites!");e=t.spriteSource2x.image,r=t.spriteSource2x.json}return"width"in e&&"height"in e&&"data"in e&&(q(e.data)||B(e.data))?{width:e.width,height:e.height,data:new Uint8Array(e.data),json:r}:{...Z(e),json:r}}const i=c(this.baseURL),o=i.query?"?"+h(i.query):"",l=this._isRetina?"@2x":"",n=`${i.path}${l}.${this._spriteImageFormat}${o}`,a=`${i.path}${l}.json${o}`,[p,u]=await Promise.all([e(a,r),e(n,{responseType:"image",...r})]);return{...Z(u.data),json:p.data}}}function Z(t){const e=document.createElement("canvas"),r=e.getContext("2d");e.width=t.width,e.height=t.height,r.drawImage(t,0,0,t.width,t.height);const s=r.getImageData(0,0,t.width,t.height);return{width:t.width,height:t.height,data:new Uint8Array(s.data)}}class tt{constructor(t){this.url=t}destroy(){this._tileIndexPromise=null}async fetchTileIndex(){return this._tileIndexPromise||(this._tileIndexPromise=e(this.url).then((t=>t.data.index))),this._tileIndexPromise}async dataKey(t,e){const r=await this.fetchTileIndex();return l(e),this._getIndexedDataKey(r,t)}_getIndexedDataKey(t,e){const r=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return null;let s=e;for(;0!==s.level;)s=new V(s.level-1,s.row>>1,s.col>>1,s.world),r.push(s);let i,o,l=t,n=r.pop();if(1===l)return n;for(;r.length;)if(i=r.pop(),o=(1&i.col)+((1&i.row)<<1),l){if(0===l[o]){n=null;break}if(1===l[o]){n=i;break}n=i,l=l[o]}return n}}class et{constructor(t,e){this._tilemap=t,this._tileIndexUrl=e}destroy(){this._tilemap=$(this._tilemap),this._tileIndexPromise=null}async fetchTileIndex(t){return this._tileIndexPromise||(this._tileIndexPromise=e(this._tileIndexUrl,{query:{...t?.query}}).then((t=>t.data.index))),this._tileIndexPromise}dataKey(t,e){const{level:r,row:s,col:i}=t,o=new V(t);return this._tilemap.fetchAvailabilityUpsample(r,s,i,o,e).then((()=>(o.world=t.world,o))).catch((t=>{if(n(t))throw t;return null}))}}class rt{constructor(t){this._tileUrl=t,this._promise=null,this._abortController=null,this._abortOptions=[]}getData(t){null===this._promise&&(this._abortController=new AbortController,this._promise=this._makeRequest(this._tileUrl,this._abortController.signal));const e=this._abortOptions;return e.push(t),a(t,(()=>{e.every((t=>p(t)))&&this._abortController.abort()})),this._promise.then((t=>i(t)))}async _makeRequest(t,r){const{data:s}=await e(t,{responseType:"array-buffer",signal:r});return s}}const st=new Map;class it{constructor(t,e,r){this.tilemap=null,this.tileInfo=null,this.capabilities=null,this.fullExtent=null,this.name=t,this.sourceUrl=e;const s=c(this.sourceUrl),o=i(r),l=o.tiles;if(s)for(let t=0;t<l.length;t++){const e=c(l[t]);e&&(y(e.path)||(e.path=d(s.path,e.path)),l[t]=m(e.path,{...s.query,...e.query}))}this.tileServers=l;const n=r.capabilities&&r.capabilities.split(",").map((t=>t.toLowerCase().trim())),a=!0===r?.exportTilesAllowed,p=!0===n?.includes("tilemap"),u=a&&r.hasOwnProperty("maxExportTilesCount")?r.maxExportTilesCount:0;this.capabilities={operations:{supportsExportTiles:a,supportsTileMap:p},exportTiles:a?{maxExportTilesCount:+u}:null},this.tileInfo=F.fromJSON(o.tileInfo);const h=r.tileMap?m(d(s.path,r.tileMap),s.query??{}):null;p?(this.type="vector-tile",this.tilemap=new et(new z({layer:{parsedUrl:s,tileInfo:this.tileInfo},minLOD:o.minLOD??this.tileInfo.lods[0].level,maxLOD:o.maxLOD??this.tileInfo.lods[this.tileInfo.lods.length-1].level}),h)):h&&(this.tilemap=new tt(h)),this.fullExtent=I.fromJSON(r.fullExtent)}destroy(){this.tilemap?.destroy()}async getRefKey(t,e){return await(this.tilemap?.dataKey(t,e))??t}requestTile(t,e,r,s){return function(t,e,r,s,i){const o=c(t),l=o.query;if(l)for(const[t,i]of Object.entries(l))switch(i){case"{x}":l[t]=s.toString();break;case"{y}":l[t]=r.toString();break;case"{z}":l[t]=e.toString()}const n=o.path;return function(t,e){return k(st,t,(()=>new rt(t))).getData(e).then((e=>(st.delete(t),e))).catch((e=>{throw st.delete(t),e}))}(m(n.replaceAll(/\{z\}/gi,e.toString()).replaceAll(/\{y\}/gi,r.toString()).replaceAll(/\{x\}/gi,s.toString()),{...o.query}),i)}(this.tileServers[e%this.tileServers.length],t,e,r,s)}isCompatibleWith(t){const e=this.tileInfo,r=t.tileInfo;if(!e.spatialReference.equals(r.spatialReference))return!1;if(!e.origin.equals(r.origin))return!1;if(Math.round(e.dpi)!==Math.round(r.dpi))return!1;const s=e.lods,i=r.lods,o=Math.min(s.length,i.length);for(let t=0;t<o;t++){const e=s[t],r=i[t];if(e.level!==r.level||Math.round(e.scale)!==Math.round(r.scale))return!1}return!0}}function ot(...t){let e;for(const r of t)if(null!=r)if(f(r)){if(e){const t=e.split("://")[0];e=t+":"+r.trim()}}else e=y(r)?r:d(e,r);return e?g(e):void 0}async function lt(t,r,s,i,o){let n,a,p;if(l(o),"string"==typeof s){const t=j(s);p=await e(t,{...o,responseType:"json",query:{f:"json",...o?.query}}),p.ssl&&(n&&(n=n.replace(/^http:/i,"https:")),a&&(a=a.replace(/^http:/i,"https:"))),n=t,a=t}else null!=s&&(p={data:s},n=s.jsonUrl||null,a=i);const u=p?.data;if(nt(u))return t.styleUrl=n||null,async function(t,e,r,s){const i=r?S(r):w();t.styleBase=i,t.style=e,e["sprite-format"]&&"webp"===e["sprite-format"].toLowerCase()&&(t.spriteFormat="webp");const o=[];if(e.sources&&e.sources.esri){const r=e.sources.esri;r.url?await lt(t,"esri",ot(i,r.url),void 0,s):o.push(lt(t,"esri",r,i,s))}for(const r of Object.keys(e.sources))"esri"!==r&&"vector"===e.sources[r].type&&(e.sources[r].url?o.push(lt(t,r,ot(i,e.sources[r].url),void 0,s)):e.sources[r].tiles&&o.push(lt(t,r,e.sources[r],i,s)));await Promise.all(o)}(t,u,a,o);if(!nt(u))return t.sourceUrl?at(t,u,a,!1,r,o):(t.sourceUrl=n||null,at(t,u,a,!0,r,o));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function nt(t){return!!t&&"sources"in t&&!!t.sources}async function at(t,e,r,s,i,o){const l=r?g(r)+"/":w(),n=function(t){if(t.hasOwnProperty("tileInfo"))return t;const e={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}};let r=78271.51696400007,s=295828763.7957775;const i=[],o=t.hasOwnProperty("minzoom")?+t.minzoom:0,l=t.hasOwnProperty("maxzoom")?+t.maxzoom:22;for(let t=0;t<=l;t++)t>=o&&i.push({level:t,scale:s,resolution:r}),r/=2,s/=2;return{capabilities:"TilesOnly",initialExtent:e,fullExtent:e,minScale:0,maxScale:0,tiles:t.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:i,spatialReference:{wkid:102100}}}}(e),a=new it(i,m(l,o?.query??{}),n);if(!s&&t.primarySourceName in t.sourceNameToSource){const e=t.sourceNameToSource[t.primarySourceName];if(!e.isCompatibleWith(a))return;null!=a.fullExtent&&(null!=e.fullExtent?e.fullExtent.union(a.fullExtent):e.fullExtent=a.fullExtent.clone()),e.tileInfo&&a.tileInfo&&e.tileInfo.lods.length<a.tileInfo.lods.length&&(e.tileInfo=a.tileInfo)}if(s&&(t.sourceBase=l,t.source=e,t.validatedSource=n,t.primarySourceName=i),t.sourceNameToSource[i]=a,!t.style){if(null==e.defaultStyles)throw new Error;return"string"==typeof e.defaultStyles?lt(t,"",ot(l,e.defaultStyles,"root.json"),void 0,o):lt(t,"",e.defaultStyles,ot(l,"root.json"),o)}}const pt=1e-6;function ut(t,e){if(t===e)return!0;if(null==t&&null!=e)return!1;if(null!=t&&null==e)return!1;if(null==t||null==e)return!1;if(!t.spatialReference.equals(e.spatialReference)||t.dpi!==e.dpi)return!1;const r=t.origin,s=e.origin;if(Math.abs(r.x-s.x)>=pt||Math.abs(r.y-s.y)>=pt)return!1;let i,o;t.lods[0].scale>e.lods[0].scale?(i=t,o=e):(o=t,i=e);for(let t=i.lods[0].scale;t>=o.lods[o.lods.length-1].scale-pt;t/=2)if(Math.abs(t-o.lods[0].scale)<pt)return!0;return!1}function ct(t,e){if(t===e)return t;if(null==t&&null!=e)return e;if(null!=t&&null==e)return t;if(null==t||null==e)return null;const r=t.size[0],s=t.format,i=t.dpi,o=new W({x:t.origin.x,y:t.origin.y}),l=t.spatialReference,n=t.lods[0].scale>e.lods[0].scale?t.lods[0]:e.lods[0],a=t.lods[t.lods.length-1].scale<=e.lods[e.lods.length-1].scale?t.lods[t.lods.length-1]:e.lods[e.lods.length-1],p=n.scale,u=n.resolution,c=a.scale,h=[];let m=p,y=u,d=0;for(;m>c;)h.push(new J({level:d,resolution:y,scale:m})),d++,m/=2,y/=2;return new F({size:[r,r],dpi:i,format:s||"pbf",origin:o,lods:h,spatialReference:l})}let ht=class extends(A(E(O(L(M(D(C(R(o(P)))))))))){constructor(...t){super(...t),this._spriteSourceMap=new Map,this.currentStyleInfo=null,this.style=null,this.isReference=null,this.operationalLayerType="VectorTileLayer",this.tilemapCache=null,this.type="vector-tile",this.url=null,this.showCollisionBoxes="none",this.path=null}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}destroy(){if(this.sourceNameToSource)for(const t of Object.values(this.sourceNameToSource))t?.destroy();this.primarySource?.destroy(),this._spriteSourceMap.clear()}async prefetchResources(t){await this.loadSpriteSource(globalThis.devicePixelRatio||1,t)}load(t){const r=this.loadFromPortal({supportedTypes:["Vector Tile Service"],supportsData:!1},t).catch(u).then((async()=>{if(!this.portalItem||!this.portalItem.id)return;const r=`${this.portalItem.itemCdnUrl}/resources/styles/root.json`;(await e(r,{...t,query:{f:"json",...this.customParameters,token:this.apiKey}})).data&&this.read({url:r},K(this.portalItem))})).catch(u).then((()=>this._loadStyle(t)));return this.addResolvingPromise(r),Promise.resolve(this)}get attributionDataUrl(){const t=this.currentStyleInfo,e=t&&t.serviceUrl&&c(t.serviceUrl);if(!e)return null;const r=this._getDefaultAttribution(e.path);return r?m(r,{...this.customParameters,token:this.apiKey}):null}get capabilities(){const t=this.primarySource;return t?t.capabilities:{operations:{supportsExportTiles:!1,supportsTileMap:!1},exportTiles:null}}get fullExtent(){return this.primarySource?.fullExtent||null}get parsedUrl(){return this.serviceUrl?c(this.serviceUrl):null}get serviceUrl(){return this.currentStyleInfo&&this.currentStyleInfo.serviceUrl||null}get spatialReference(){return this.tileInfo?.spatialReference??null}get styleUrl(){return this.currentStyleInfo&&this.currentStyleInfo.styleUrl||null}writeStyleUrl(t,e){t&&f(t)&&(t=`https:${t}`);const r=x(t);e.styleUrl=G(t,r)}get tileInfo(){const t=[];for(const e in this.sourceNameToSource)t.push(this.sourceNameToSource[e]);let e=this.primarySource?.tileInfo||new F;if(t.length>1)for(let r=0;r<t.length;r++)ut(e,t[r].tileInfo)&&(e=ct(e,t[r].tileInfo));return e}readTilemapCache(t,e){const r=e.capabilities?.includes("Tilemap");return r?new z({layer:this}):null}readVersion(t,e){return e.version?parseFloat(e.version):parseFloat(e.currentVersion)}async loadSpriteSource(t=1,e){if(!this._spriteSourceMap.has(t)){const r=H("2d").maxTextureSize,s=this.currentStyleInfo?.spriteUrl?m(this.currentStyleInfo.spriteUrl,{...this.customParameters,token:this.apiKey}):null,i=new X({type:"url",spriteUrl:s,pixelRatio:t,spriteFormat:this.currentStyleInfo?.spriteFormat},r);await i.load(e),this._spriteSourceMap.set(t,i)}return this._spriteSourceMap.get(t)}async setSpriteSource(t,e){if(!t)return null;const r=H("2d").maxTextureSize,s=t.spriteUrl,i=s?m(s,{...this.customParameters,token:this.apiKey}):null;if(!i&&"url"===t.type)return null;const o=new X(t,r);try{await o.load(e);const r=t.pixelRatio||1;return this._spriteSourceMap.clear(),this._spriteSourceMap.set(r,o),i&&this.currentStyleInfo&&(this.currentStyleInfo.spriteUrl=i),this.emit("spriteSource-change",{spriteSource:o}),o}catch(t){u(t)}return null}async loadStyle(t,e){const s=t||this.style||this.url;return this._loadingTask&&"string"==typeof s&&this.url===s||(this._loadingTask?.abort(),this._loadingTask=r((t=>(this._spriteSourceMap.clear(),this._getSourceAndStyle(s,{signal:t}))),e)),this._loadingTask.promise}getStyleLayerId(t){return this.styleRepository.getStyleLayerId(t)}getStyleLayerIndex(t){return this.styleRepository.getStyleLayerIndex(t)}getPaintProperties(t){return i(this.styleRepository.getPaintProperties(t))}setPaintProperties(t,e){const r=this.styleRepository.isPainterDataDriven(t);this.styleRepository.setPaintProperties(t,e);const s=this.styleRepository.isPainterDataDriven(t);this.emit("paint-change",{layer:t,paint:e,isDataDriven:r||s})}getStyleLayer(t){return i(this.styleRepository.getStyleLayer(t))}setStyleLayer(t,e){this.styleRepository.setStyleLayer(t,e),this.emit("style-layer-change",{layer:t,index:e})}deleteStyleLayer(t){this.styleRepository.deleteStyleLayer(t),this.emit("delete-style-layer",{layer:t})}getLayoutProperties(t){return i(this.styleRepository.getLayoutProperties(t))}setLayoutProperties(t,e){this.styleRepository.setLayoutProperties(t,e),this.emit("layout-change",{layer:t,layout:e})}setStyleLayerVisibility(t,e){this.styleRepository.setStyleLayerVisibility(t,e),this.emit("style-layer-visibility-change",{layer:t,visibility:e})}getStyleLayerVisibility(t){return this.styleRepository.getStyleLayerVisibility(t)}write(t,e){return e?.origin&&!this.styleUrl?(e.messages&&e.messages.push(new s("vectortilelayer:unsupported",`VectorTileLayer (${this.title}, ${this.id}) with style defined by JSON only are not supported`,{layer:this})),null):super.write(t,e)}getTileUrl(t,e,r){return null}async _getSourceAndStyle(t,e){if(!t)throw new Error("invalid style!");const r=await async function(t,e){const r={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[s,i]="string"==typeof t?[t,null]:[null,t.jsonUrl];return await lt(r,"esri",t,i,e),{layerDefinition:r.validatedSource,url:s,serviceUrl:r.sourceUrl,style:r.style,styleUrl:r.styleUrl,spriteUrl:r.style.sprite&&ot(r.styleBase,r.style.sprite),spriteFormat:r.spriteFormat,glyphsUrl:r.style.glyphs&&ot(r.styleBase,r.style.glyphs),sourceNameToSource:r.sourceNameToSource,primarySourceName:r.primarySourceName}}(t,{...e,query:{...this.customParameters,token:this.apiKey}});"webp"===r.spriteFormat&&(await function(t){if(Y)return Y;const e="UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA";return Y=new Promise((t=>{const r=new Image;r.onload=()=>{r.onload=r.onerror=null,t(r.width>0&&r.height>0)},r.onerror=()=>{r.onload=r.onerror=null,t(!1)},r.src="data:image/webp;base64,"+e})),Y}()||(r.spriteFormat="png")),this._set("currentStyleInfo",{...r}),"string"==typeof t?(this.url=t,this.style=null):(this.url=null,this.style=t),this._set("sourceNameToSource",r.sourceNameToSource),this._set("primarySource",r.sourceNameToSource[r.primarySourceName]),this._set("styleRepository",new Q(r.style)),this.read(r.layerDefinition,{origin:"service"}),this.emit("load-style")}_getDefaultAttribution(t){const e=t.match(/^https?:\/\/(?:basemaps|basemapsbeta|basemapsdev)(?:-api)?\.arcgis\.com(\/[^\/]+)?\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i),r=["OpenStreetMap_v2","OpenStreetMap_Daylight_v2","OpenStreetMap_Export_v2","OpenStreetMap_FTS_v2","OpenStreetMap_GCS_v2","World_Basemap","World_Basemap_v2","World_Basemap_Export_v2","World_Basemap_GCS_v2","World_Basemap_WGS84","World_Contours_v2"];if(!e)return;const s=e[2]&&e[2].toLowerCase();if(!s)return;const i=e[1]||"";for(const t of r)if(t.toLowerCase().includes(s))return j(`//static.arcgis.com/attribution/Vector${i}/${t}`)}async _loadStyle(t){return this._loadingTask?.promise??this.loadStyle(null,t)}};t([v({readOnly:!0})],ht.prototype,"attributionDataUrl",null),t([v({type:["show","hide"]})],ht.prototype,"listMode",void 0),t([v({json:{read:!0,write:!0}})],ht.prototype,"blendMode",void 0),t([v({readOnly:!0,json:{read:!1}})],ht.prototype,"capabilities",null),t([v({readOnly:!0})],ht.prototype,"currentStyleInfo",void 0),t([v({json:{read:!1},readOnly:!0,type:I})],ht.prototype,"fullExtent",null),t([v()],ht.prototype,"style",void 0),t([v({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],ht.prototype,"isReference",void 0),t([v({type:["VectorTileLayer"]})],ht.prototype,"operationalLayerType",void 0),t([v({readOnly:!0})],ht.prototype,"parsedUrl",null),t([v({readOnly:!0})],ht.prototype,"serviceUrl",null),t([v({type:T,readOnly:!0})],ht.prototype,"spatialReference",null),t([v({readOnly:!0})],ht.prototype,"styleRepository",void 0),t([v({readOnly:!0})],ht.prototype,"sourceNameToSource",void 0),t([v({readOnly:!0})],ht.prototype,"primarySource",void 0),t([v({type:String,readOnly:!0,json:{write:{ignoreOrigin:!0},origins:{"web-document":{write:{ignoreOrigin:!0,isRequired:!0}}}}})],ht.prototype,"styleUrl",null),t([b(["portal-item","web-document"],"styleUrl")],ht.prototype,"writeStyleUrl",null),t([v({json:{read:!1,origins:{service:{read:!1}}},readOnly:!0,type:F})],ht.prototype,"tileInfo",null),t([v()],ht.prototype,"tilemapCache",void 0),t([_("service","tilemapCache",["capabilities","tileInfo"])],ht.prototype,"readTilemapCache",null),t([v({json:{read:!1},readOnly:!0,value:"vector-tile"})],ht.prototype,"type",void 0),t([v({json:{origins:{"web-document":{read:{source:"styleUrl"}},"portal-item":{read:{source:"url"}}},write:!1,read:!1}})],ht.prototype,"url",void 0),t([v({readOnly:!0})],ht.prototype,"version",void 0),t([_("version",["version","currentVersion"])],ht.prototype,"readVersion",null),t([v({type:String})],ht.prototype,"showCollisionBoxes",void 0),t([v({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],ht.prototype,"path",void 0),ht=t([U("esri.layers.VectorTileLayer")],ht);const mt=ht;export{mt as default};

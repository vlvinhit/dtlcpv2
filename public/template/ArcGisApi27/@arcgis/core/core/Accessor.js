/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"./Handles.js";import{a as e,d as s}from"../chunks/maybe.js";import{L as r,subclass as i,B as o}from"./accessorSupport/decorators/subclass.js";import{g as n}from"../chunks/get.js";import{a}from"../chunks/metadata.js";import"../chunks/typedArrayUtil.js";import{clone as c,equals as l}from"./lang.js";import{L as h}from"../chunks/Logger.js";import{O as u}from"../chunks/ObjectPool.js";import{O as d}from"../chunks/ObservableBase.js";import{F as p,t as _,r as f,a as m,b as g,i as v}from"../chunks/tracking.js";import{property as y,s as b}from"./accessorSupport/decorators/property.js";import{r as O,w as E}from"../chunks/watch.js";import"../chunks/ensureType.js";import"../chunks/object.js";import"./Error.js";import"../config.js";import"../chunks/string.js";import"../chunks/utils.js";import"../chunks/ArrayPool.js";import"./scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"./promiseUtils.js";var A;!function(t){t[t.DEFAULTS=0]="DEFAULTS",t[t.COMPUTED=1]="COMPUTED",t[t.SERVICE=2]="SERVICE",t[t.PORTAL_ITEM=3]="PORTAL_ITEM",t[t.WEB_SCENE=4]="WEB_SCENE",t[t.WEB_MAP=5]="WEB_MAP",t[t.LINK_CHART=6]="LINK_CHART",t[t.USER=7]="USER"}(A||(A={}));const N=A.USER+1;function j(t){switch(t){case"defaults":return A.DEFAULTS;case"service":return A.SERVICE;case"portal-item":return A.PORTAL_ITEM;case"web-scene":return A.WEB_SCENE;case"web-map":return A.WEB_MAP;case"link-chart":return A.LINK_CHART;case"user":return A.USER;default:return null}}function I(t){switch(t){case A.DEFAULTS:return"defaults";case A.SERVICE:return"service";case A.PORTAL_ITEM:return"portal-item";case A.WEB_SCENE:return"web-scene";case A.WEB_MAP:return"web-map";case A.LINK_CHART:return"link-chart";case A.USER:return"user"}return e(void 0)}function C(t){return I(t)}class S{constructor(t,e){this.propertyName=t,this.metadata=e,this.observerObject=new T,this._accessed=null,this._handles=null,this.observerObject.flags=p.Dirty|(e.nonNullable?p.NonNullable:0)|(e.hasOwnProperty("value")?p.HasDefaultValue:0)|(void 0===e.get?p.DepTrackingInitialized:0)|(void 0===e.dependsOn?p.AutoTracked:0)}destroy(){this.observerObject.destroy(),this._accessed=null,this._clearObservationHandles()}getComputed(t){const e=this.observerObject;_(e);const s=t.store,r=this.propertyName,i=e.flags,o=s.get(r);if(i&p.Computing)return o;if(~i&p.Dirty&&s.has(r))return o;e.flags|=p.Computing;const n=t.host;let a;i&p.AutoTracked?a=f(this,this.metadata.get,n):(m(n,this),a=this.metadata.get.call(n)),s.set(r,a,A.COMPUTED);const c=s.get(r);return c===o?e.flags&=~p.Dirty:g(this.commit,this),e.flags&=~p.Computing,c}onObservableAccessed(t){if(t===this.observerObject)return;let e=this._accessed;if(null==e)e=[],this._accessed=e;else if(e.includes(t))return;e.push(t)}onTrackingEnd(){this._clearObservationHandles();const t=this.observerObject;t.flags|=p.DepTrackingInitialized;const e=this._accessed;if(null==e||0===e.length)return;let s=this._handles;null==s&&(s=[],this._handles=s);for(let r=0;r<e.length;++r)s.push(e[r].observe(t));e.length=0}notifyChange(){const t=this.observerObject;t.onInvalidated(),t.onCommitted()}invalidate(){this.observerObject.onInvalidated()}commit(){const t=this.observerObject;t.flags&=~p.Dirty,t.onCommitted()}_clearObservationHandles(){const t=this._handles;if(null!==t){for(let e=0;e<t.length;++e)t[e].remove();t.length=0}}}class T extends d{constructor(){super(...arguments),this.flags=0}onInvalidated(){~this.flags&p.Overriden&&(this.flags|=p.Dirty);const t=this._observers;if(t&&t.length>0)for(const e of t)e.onInvalidated()}onCommitted(){const t=this._observers;if(t&&t.length>0){const e=t.slice();for(const t of e)t.onCommitted()}}destroy(){this.flags&p.Dirty&&this.onCommitted(),super.destroy()}}class k{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const e=new k;return this._values.forEach(((s,r)=>{t&&t.has(r)||e.set(r,c(s))})),e}get(t){return this._values.get(t)}originOf(){return A.USER}keys(){return[...this._values.keys()]}set(t,e){this._values.set(t,e)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}function w(t,e,s){return void 0!==t}function B(t,e,s,i){return!(void 0===t||null==s&&t.observerObject.flags&p.NonNullable&&(i.lifecycle,r.INITIALIZING,1))}h.getLogger("esri.core.accessorSupport.Properties");class D{constructor(t){this.host=t,this.propertiesByName=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=r.INITIALIZING,this.store=new k,this._origin=A.USER;const e=this.host.constructor.__accessorMetadata__;for(const t in e){const s=new S(t,e[t]);this.propertiesByName.set(t,s)}this.metadatas=e}initialize(){this.lifecycle=r.CONSTRUCTING}constructed(){this.lifecycle=r.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[e,s]of this.propertiesByName){if(s.metadata.autoDestroy){const r=this.internalGet(e);r&&(t=r)&&"function"==typeof t.destroy&&(r.destroy(),~s.observerObject.flags&p.NonNullable&&this._internalSet(s,null))}s.destroy()}var t}get initialized(){return this.lifecycle!==r.INITIALIZING}get(t){const e=this.propertiesByName.get(t);if(e.metadata.get)return e.getComputed(this);_(e.observerObject);const s=this.store;return s.has(t)?s.get(t):e.metadata.value}originOf(t){const e=this.store.originOf(t);if(void 0===e){const e=this.propertiesByName.get(t);if(void 0!==e&&e.observerObject.flags&p.HasDefaultValue)return"defaults"}return I(e)}has(t){return!!this.propertiesByName.has(t)&&this.store.has(t)}keys(){return[...this.propertiesByName.keys()]}internalGet(t){const e=this.propertiesByName.get(t);if(w(e))return this.store.has(t)?this.store.get(t):e.metadata.value}internalSet(t,e){const s=this.propertiesByName.get(t);w(s)&&this._internalSet(s,e)}getDependsInfo(t,e,s){const r=this.propertiesByName.get(e);if(!w(r))return"";const i=new Set,o=f({onObservableAccessed:t=>i.add(t),onTrackingEnd:()=>{}},(()=>r.metadata.get?.call(t)));let n=`${s}${t.declaredClass.split(".").pop()}.${e}: ${o}\n`;if(0===i.size)return n;s+="  ";for(const t of i)t instanceof S&&(n+=`${s}${t.propertyName}: undefined\n`);return n}setAtOrigin(t,e,s){const r=this.propertiesByName.get(t);if(w(r))return this._setAtOrigin(r,e,s)}isOverridden(t){const e=this.propertiesByName.get(t);return void 0!==e&&!!(e.observerObject.flags&p.Overriden)}clearOverride(t){const e=this.propertiesByName.get(t),s=e?.observerObject;s&&s.flags&p.Overriden&&(s.flags&=~p.Overriden,e.notifyChange())}override(t,e){const s=this.propertiesByName.get(t);if(!B(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(R.release(t),!s)return;e=i}s.observerObject.flags|=p.Overriden,this._internalSet(s,e)}set(t,e){const s=this.propertiesByName.get(t);if(!B(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(R.release(t),!s)return;e=i}const i=s.metadata.set;i?i.call(this.host,e):this._internalSet(s,e)}setDefaultOrigin(t){this._origin=j(t)}getDefaultOrigin(){return I(this._origin)}notifyChange(t){const e=this.propertiesByName.get(t);void 0!==e&&e.notifyChange()}invalidate(t){const e=this.propertiesByName.get(t);void 0!==e&&e.invalidate()}commit(t){const e=this.propertiesByName.get(t);void 0!==e&&e.commit()}_internalSet(t,e){const s=this.lifecycle!==r.INITIALIZING?this._origin:A.DEFAULTS;this._setAtOrigin(t,e,s)}_setAtOrigin(t,e,s){const r=this.store,i=t.propertyName;r.has(i,s)&&l(e,r.get(i))&&~t.observerObject.flags&p.Overriden&&s===r.originOf(i)||(t.invalidate(),r.set(i,e,s),t.commit(),v(this.host,t))}_cast(t,e){const s=R.acquire();return s.valid=!0,s.value=e,t&&(s.value=t.call(this.host,e,s)),s}}const R=new u(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});var L,P;function U(t){if(null==t)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor?.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}const H=Symbol("Accessor-Handles"),M=Symbol("Accessor-Initialized");class z{static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:e,declaredClass:s,constructor:r}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const o=this;class n extends o{constructor(...t){super(...t),this.inherited=null,r&&r.apply(this,t)}}a(n.prototype);for(const e in t){const s=t[e];n.prototype[e]="function"==typeof s?function(...t){const r=this.inherited;let i;this.inherited=function(...t){if(o.prototype[e])return o.prototype[e].apply(this,t)};try{i=s.apply(this,t)}catch(t){throw this.inherited=r,t}return this.inherited=r,i}:t[e]}for(const t in e){const s=U(e[t]);y(s)(n.prototype,t)}return i(s)(n)}constructor(...t){if(this[L]=null,this[P]=!1,this.constructor===z)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");const e=new D(this);Object.defineProperty(this,"__accessor__",{enumerable:!1,value:e}),t.length>0&&this.normalizeCtorArgs&&(e.ctorArgs=this.normalizeCtorArgs.apply(this,t)),G.register(this,e.propertiesByName,this)}postscript(t){const e=this.__accessor__,s=e.ctorArgs||t;e.initialize(),s&&(this.set(s),e.ctorArgs=null),e.constructed(),this.initialize(),this[M]=!0}initialize(){}[o](){this[H]=s(this[H])}destroy(){this.destroyed||(G.unregister(this),O(this),this.__accessor__.destroy())}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[M]}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return n(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,e){return b(this,t,e),this}watch(t,e,s){return E(this,t,e,s)}own(t){this.addHandles(t)}addHandles(e,s){if(this.destroyed){const t=Array.isArray(e)?e:[e];for(const e of t)e.remove();return}let r=this[H];null==r&&(r=this[H]=new t),r.add(e,s)}removeHandles(t){const e=this[H];null!=e&&e.remove(t)}removeAllHandles(){const t=this[H];null!=t&&t.removeAll()}hasHandles(t){const e=this[H];return null!=e&&e.has(t)}_override(t,e){void 0===e?this.__accessor__.clearOverride(t):this.__accessor__.override(t,e)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_overrideIfSome(t,e){null==e?this.__accessor__.clearOverride(t):this.__accessor__.override(t,e)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.notifyChange(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,e){return this.__accessor__.internalSet(t,e),this}}L=H,P=M;const G=new FinalizationRegistry((t=>{for(const e of t.values())e.destroy()}));export{A as O,N as a,I as b,z as default,C as i,j as n};

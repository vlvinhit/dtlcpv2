/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{a as e}from"../chunks/maybe.js";import{n as s}from"../chunks/nextTick.js";import{P as t}from"../chunks/PooledArray.js";import{createResolver as r,isAborted as n,createAbortError as o}from"./promiseUtils.js";import"../chunks/typedArrayUtil.js";import"./Error.js";import"./lang.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";class a{constructor(e,s=30){this.name=e,this._counter=0,this._samples=new Array(s)}record(e){null!=e&&(this._samples[++this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort(((e,s)=>e-s))[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce(((e,s)=>e+s),0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}}function i(e){return e}function c(e){return 1e3*e}function m(e){return e}function l(e){return.001*e}function u(){return performance.now()}class p{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class h{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let f=0,d=0;const k={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},w=["prepare","preRender","render","postRender","update","finish"],g=[],_=new t;class j{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const v={frameTasks:_,willDispatch:!1,clearFrameTasks:function(e=!1){_.forAll((e=>{e.removed=!0})),e&&M()},dispatch:b,executeFrameTasks:function(e){const s=e-f;f=e;const t=d>0?d:1e3/60,r=Math.max(0,s-t);k.time=e,k.frameDuration=t-r;for(let t=0;t<w.length;t++){const r=performance.now(),n=w[t];_.forAll((r=>{r.paused||r.removed||(0===t&&r.ticks++,r.phases[n]&&(k.elapsedFrameTime=performance.now()-e,k.deltaTime=0===r.ticks?0:s,r.phases[n]?.call(r,k)))})),U[t].record(performance.now()-r)}M(),q.record(performance.now()-e)}};function A(e){const t=new h(e);return g.push(t),v.willDispatch||(v.willDispatch=!0,s(b)),t}function T(e){const s=new p(e);return _.push(s),null==F&&(f=performance.now(),F=requestAnimationFrame(y)),new j(s)}let F=null;function x(e){d=Math.max(0,e)}function y(){const e=performance.now();F=null,F=_.length>0?requestAnimationFrame(y):null,v.executeFrameTasks(e)}const D=new t;function M(){_.forAll((e=>{e.removed&&D.push(e)})),_.removeUnorderedMany(D.data,D.length),D.clear()}function b(){for(;g.length;){const s=e(g.shift());s.isActive&&s.callback()}v.willDispatch=!1}function P(e=1,t){const a=r(),i=()=>{n(t)?a.reject(o()):0===e?a():(--e,s((()=>i())))};return i(),a.promise}function R(){const e=r(),s=T({postRender:()=>{s.remove(),A(e)}});return e.promise}const U=w.map((e=>new a(e))),q=new a("total");export{j as FrameTaskHandle,i as M,a as P,m as S,T as addFrameTask,v as debug,c as m,u as n,U as performanceInfo,q as performanceTotal,l as s,A as schedule,x as setFrameDuration,R as waitAnimationFrame,P as waitTicks};

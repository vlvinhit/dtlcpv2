/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import r,{O as t,n as s,i}from"./Accessor.js";import{a as o}from"../chunks/maybe.js";import{clone as n}from"./lang.js";import{v as a,e as u}from"../chunks/get.js";import{g as l,m as c}from"../chunks/utils.js";import{o as f,a as p,b as g,subclass as d}from"./accessorSupport/decorators/subclass.js";import{l as m}from"../chunks/typedArrayUtil.js";import h from"./Error.js";import{L as O}from"../chunks/Logger.js";import"./Handles.js";import"../chunks/metadata.js";import"../chunks/ObjectPool.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"./accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"./scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"./promiseUtils.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";class w{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new w;return this._values.forEach(((t,s)=>{e&&e.has(s)||r.set(s,n(t.value),t.origin)})),r}get(e,r){r=this._normalizeOrigin(r);const t=this._values.get(e);return null==r||t?.origin===r?t?.value:void 0}originOf(e){return this._values.get(e)?.origin??t.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return null==e?r:r.filter((r=>this._values.get(r)?.origin===e))}set(e,r,s){if((s=this._normalizeOrigin(s))===t.DEFAULTS){const r=this._values.get(e);if(r&&null!=r.origin&&r.origin>s)return}this._values.set(e,new j(r,s))}delete(e,r){null!=(r=this._normalizeOrigin(r))&&this._values.get(e)?.origin!==r||this._values.delete(e)}has(e,r){return null!=(r=this._normalizeOrigin(r))?this._values.get(e)?.origin===r:this._values.has(e)}forEach(e){this._values.forEach((({value:r},t)=>e(r,t)))}_normalizeOrigin(e){if(null!=e)return e===t.DEFAULTS?e:t.USER}}class j{constructor(e,r){this.value=e,this.origin=r}}function y(e,r,s){r.keys().forEach((e=>{s.set(e,r.get(e),t.DEFAULTS)}));const i=e.metadatas;Object.keys(i).forEach((r=>{e.internalGet(r)&&s.set(r,e.internalGet(r),t.DEFAULTS)}))}function v(e,r,t){if(!e||!e.read||!1===e.read.enabled||!e.read.source)return!1;const s=e.read.source;if("string"==typeof s){if(s===r)return!0;if(s.includes(".")&&0===s.indexOf(r)&&u(s,t))return!0}else for(const e of s){if(e===r)return!0;if(e.includes(".")&&0===e.indexOf(r)&&u(e,t))return!0}return!1}function S(e,r,t,s,i){let o=f(r[t],i);(function(e){return e&&(!e.read||!1!==e.read.enabled&&!e.read.source)})(o)&&(e[t]=!0);for(const n of Object.getOwnPropertyNames(r))o=f(r[n],i),v(o,t,s)&&(e[n]=!0)}function k(e,r,t,s){const i=t.metadatas,o=p(i[r],s),n=o?.default;if(void 0===n)return;const a="function"==typeof n?n.call(e,r,s):n;void 0!==a&&t.set(r,a)}const N={origin:"service"};function b(e,r,t=N){if(!r||"object"!=typeof r)return;const s=l(e),i=s.metadatas,o={};for(const e of Object.getOwnPropertyNames(r))S(o,i,e,r,t);s.setDefaultOrigin(t.origin);for(const n of Object.getOwnPropertyNames(o)){const o=f(i[n],t).read,u=o&&o.source;let l;l=u&&"string"==typeof u?a(r,u):r[n],o&&o.reader&&(l=o.reader.call(e,l,r,t)),void 0!==l&&s.set(n,l)}if(!t||!t.ignoreDefaults){s.setDefaultOrigin("defaults");for(const r of Object.getOwnPropertyNames(i))o[r]||k(e,r,s,t)}s.setDefaultOrigin("user")}function _(e,r,t,s=N){const i={...s,messages:[]};t(i),i.messages?.forEach((r=>{"warning"!==r.type||e.loaded?s&&s.messages&&s.messages.push(r):e.loadWarnings.push(r)}))}function E(e,r,t,s,i){const o={};return r.write?.writer?.call(e,s,o,t,i),o}function D(e,r,i,o,n,a){if(!o||!o.write)return!1;const u=e.get(i);if(!n&&o.write.overridePolicy){const r=o.write.overridePolicy.call(e,u,i,a??void 0);void 0!==r&&(n=r)}if(n||(n=o.write),!n||!1===n.enabled)return!1;if((null===u&&!n.allowNull&&!n.writerEnsuresNonNull||void 0===u)&&n.isRequired){const r=new h("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return r&&a&&a.messages?a.messages.push(r):r&&!a&&O.getLogger("esri.core.accessorSupport.write").error(r.name,r.message),!1}return!(void 0===u||null===u&&!n.allowNull&&!n.writerEnsuresNonNull||!(n.alwaysWriteDefaults||r.store.multipleOriginsSupported&&r.store.originOf(i)!==t.DEFAULTS)&&function(e,r,t,s,i){const o=s.default;if(void 0===o)return!1;if(null!=s.defaultEquals)return s.defaultEquals(i);if("function"==typeof o){if(Array.isArray(i)){const s=o.call(e,r,t??void 0);return m(s,i)}return!1}return o===i}(e,i,a,o,u)||!n.ignoreOrigin&&a&&a.origin&&r.store.multipleOriginsSupported&&r.store.originOf(i)<s(a.origin))}function J(e,r,t,s){const i=l(e),o=i.metadatas,n=g(o[r],s);return!!n&&D(e,i,r,n,t,s)}function P(e,r,t){if(e&&"function"==typeof e.toJSON&&(!e.toJSON.isDefaultToJSON||!e.write))return c(r,e.toJSON(t));const s=l(e),o=s.metadatas;for(const n in o){const a=g(o[n],t);if(!D(e,s,n,a,void 0,t))continue;const u=e.get(n),l=E(e,a,a.write&&"string"==typeof a.write.target?a.write.target:n,u,t);Object.keys(l).length>0&&(r=c(r,l),t?.resources?.pendingOperations?.length&&t.resources.pendingOperations.push(Promise.all(t.resources.pendingOperations).then((()=>c(r,l,(()=>"replace-arrays"))))),t&&t.writtenProperties&&t.writtenProperties.push({target:e,propName:n,oldOrigin:i(s.store.originOf(n)),newOrigin:t.origin}))}return r}const A=r=>{let t=class extends r{constructor(...e){super(...e);const r=o(l(this)),t=r.store,s=new w;r.store=s,y(r,t,s)}read(e,r){b(this,e,r)}write(e,r){return P(this,e??{},r)}toJSON(e){return this.write({},e)}static fromJSON(e,r){return T.call(this,e,r)}};return t=e([d("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function T(e,r){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(e,r),t}function U(e){return e&&"read"in e&&"write"in e&&"toJSON"in e}let L=class extends(A(r)){};L=e([d("esri.core.JSONSupport")],L);export{L as JSONSupport,A as JSONSupportMixin,J as a,_ as b,U as isJSONSupport,b as r,y as s,P as w};

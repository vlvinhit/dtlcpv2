/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../TimeExtent.js";import i from"../../TimeInterval.js";import n from"../../core/Collection.js";import s from"../../core/Evented.js";import{HandleOwnerMixin as l}from"../../core/HandleOwner.js";import{L as r}from"../../chunks/Logger.js";import{c as o}from"../../chunks/maybe.js";import{after as a,isAbortError as u}from"../../core/promiseUtils.js";import{watch as m,whenOnce as p,initial as c,syncAndInitial as h}from"../../core/reactiveUtils.js";import{o as d}from"../../chunks/timeUtils.js";import{property as f}from"../../core/accessorSupport/decorators/property.js";import{e as g}from"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as w}from"../../core/accessorSupport/decorators/subclass.js";import{b as v,W as T}from"../../chunks/Widgets.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../core/lang.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/Error.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../core/Clonable.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/WatchUpdatingTracking.js";function x(t){return null!=t&&void 0!==t.count}function y(t){return null!=t&&void 0!==t.interval}function E(t){return null!=t&&void 0!==t.dates}function _(t){return null!=t&&"object"==typeof t&&"declaredClass"in t&&"esri.WebMap"===t.declaredClass}let j=class extends(l(s.EventedAccessor)){constructor(t){super(t),this._animationController=null,this._isViewTimeExtentInitialized=!1,this._timerId=null,this.actions=new n,this.fullTimeExtent=null,this.loop=!1,this.mode="time-window",this.stops={count:10},this.timeExtent=null,this.view=null}initialize(){this.handles.add([m((()=>this.effectiveStops),(()=>{null==this.timeExtent&&(this.timeExtent=this._getDefaultTimeExtent())}),c),m((()=>this.view),((t,e)=>{this._unregisterWidget(e),this._registerWidget(t)}),h),m((()=>this.timeExtent),(t=>{if(null==this.view)return;const e=this.view.timeExtent;(null!=t&&!t.isAllTime||null!=e&&!e.isAllTime)&&(null!=t&&null!=e&&t.equals(e)||(this.view.timeExtent=t))}),c),m((()=>o(this.view,(t=>t.timeExtent))),(t=>{this._isViewTimeExtentInitialized?(null!=t&&!t.isAllTime||null!=this.timeExtent&&!this.timeExtent.isAllTime)&&(null!=t&&null!=this.timeExtent&&t.equals(this.timeExtent)||(this.timeExtent=t)):this._isViewTimeExtentInitialized=!0}))])}destroy(){null!=this._timerId&&(clearInterval(this._timerId),this._timerId=null),this._unregisterWidget(this.view),this.view=null,null!=this._animationController&&(this._animationController.abort(),this._animationController=null)}get effectiveStops(){const{fullTimeExtent:t,stops:e}=this;if(E(e)){const{dates:i}=e;if(null==i||0===i.length)return null;const n=i.sort(((t,e)=>t.getTime()-e.getTime()));if(null==t)return n;const{start:s,end:l}=t;return null==s||null==l?n:n.filter((t=>!(t.getTime()<s.getTime()||t.getTime()>l.getTime())))}if(x(e)){const i=e.timeExtent??t;return this._divideTimeExtentByCount(i,e.count)}if(y(e)){const i=e.timeExtent??t;return this._divideTimeExtentByInterval(i,e.interval)}return[]}set playRate(t){t<=0||t>36e5||("playing"===this.state&&this._startAnimation(),this._set("playRate",t))}get state(){return null==this.fullTimeExtent?"disabled":null!=this._animationController?"playing":"ready"}get timeExtentValues(){const{mode:t,timeExtent:e}=this;if(null==e||e.isAllTime||e.isEmpty)return null;const{start:i,end:n}=e;switch(t){case"cumulative-from-end":case"instant":return null!=i?[i.getTime()]:null;case"cumulative-from-start":return null!=n?[n.getTime()]:null;case"time-window":return null!=i&&null!=n?[i.getTime(),n.getTime()]:null}}static async getPropertiesFromWebMap(t,e){if(null==t||!_(t))return null;await t.load({signal:e});const i=t?.widgets?.timeSlider;if(!i)return null;const{getFullTimeExtentFromWebDocument:n,getModeFromTimeSlider:s,getStopsFromTimeSlider:l,getTimeExtentFromTimeSlider:r}=await import("../../chunks/utils19.js"),o=await n(t,e),a=i.loop,u=s(i);return{fullTimeExtent:o,loop:a,mode:u,playRate:i.stopDelay??2e3,stops:l(i),timeExtent:r(i,u)}}next(){this._step({forward:!0,allowRestart:!1})}play(){this._startAnimation()}previous(){this._step({forward:!1,allowRestart:!1})}stop(){this._stopAnimation()}triggerAction(t){this.emit("trigger-action",{action:t})}updateWebDocument(t){if(_(t)){const e=new v({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:x(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:y(this.stops)?this.stops.interval:null,stops:E(this.stops)?this.stops.dates:null});t.widgets?t.widgets.timeSlider=e:t.widgets=new T({timeSlider:e})}}valuesToTimeExtent(t){if(null==t)return null;const i=t.sort(((t,e)=>t-e)).map((t=>new Date(t))),n=i.length>0?i[0]:null,s=i.length>1?i[1]:null;switch(this.mode){case"time-window":return new e({start:n,end:s});case"instant":return new e({start:n,end:n});case"cumulative-from-start":return new e({start:null,end:n});case"cumulative-from-end":return new e({start:n,end:null});default:return e.allTime}}async _animate(){try{const t=this.view,e=o(this._animationController,(t=>t.signal));await Promise.all([a(this.playRate,null,e),null!=t&&p((()=>!1===t.updating),e)])}catch(t){return u(t)||r.getLogger(this).error(t),void(this._animationController=null)}this._step({forward:!0,allowRestart:!1}),null!=this._animationController&&this._animate()}_divideTimeExtentByCount(t,e=10){if(!t||!e)return[];const{start:i,end:n}=t;if(null==i||null==n)return[];if(e>1e4)return this._divideTimeExtentByCount(t);const s=[],l=i.getTime(),r=n.getTime()-l;for(let t=0;t<=e;t++)s.push(new Date(l+t/e*r));return s}_divideTimeExtentByInterval(t,e,i=1e4){if(!t||!e)return[];const{start:n,end:s}=t;if(null==n||null==s)return[];const l=s.getTime()-n.getTime(),r=e.toMilliseconds();if(r<=0||l/r>i)return this._divideTimeExtentByCount(t);const o=[],{value:a,unit:u}=e;let m=n;for(;m.getTime()<=s.getTime();)o.push(new Date(m.getTime())),m=d(m,a,u);return o}_getDefaultTimeExtent(){const{effectiveStops:t,mode:i}=this;if(null==t||!i)return null;switch(i){case"time-window":return t.length>1?new e({start:t[0],end:t[1]}):null;case"cumulative-from-start":return t.length>0?new e({start:null,end:t[0]}):null;case"cumulative-from-end":return t.length>0?new e({start:t[0],end:null}):null;case"instant":return t.length>0?new e({start:t[0],end:t[0]}):null;default:return null}}_registerWidget(t){null!=t&&(t.persistableViewModels.includes(this)||t.persistableViewModels.add(this))}_startAnimation(){this._stopAnimation(),this._animationController=new AbortController,this._step({forward:!0,allowRestart:!0}),this._animate()}_step(t){const{forward:e,allowRestart:i}=t,{effectiveStops:n}=this;if(null==this.timeExtentValues||null==n)return;const s=n.map((t=>t.getTime())),l=this.timeExtentValues.map((t=>{const e=s.indexOf(t);if(-1!==e)return e;const i=s.reduce(((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e));return s.indexOf(i)})),r=l.map((t=>t+(e?1:-1))),o=r.some((t=>t<0||t>s.length-1)),{loop:a,state:u}=this;if(o)if(a||i){const t=Math.min(...l),i=Math.max(...l),n=(e?l.map((e=>e-t)):l.map((t=>t+(s.length-1-i)))).map((t=>s[t]));this.timeExtent=this.valuesToTimeExtent(n)}else"playing"===u&&this.stop();else{const t=r.map((t=>s[t]));this.timeExtent=this.valuesToTimeExtent(t)}}_stopAnimation(){null!=this._animationController&&(this._animationController.abort(),this._animationController=null)}_unregisterWidget(t){null!=t&&t.persistableViewModels.remove(this)}};t([f()],j.prototype,"_animationController",void 0),t([f({type:n})],j.prototype,"actions",void 0),t([f({readOnly:!0})],j.prototype,"effectiveStops",null),t([f({type:e})],j.prototype,"fullTimeExtent",void 0),t([f({nonNullable:!0})],j.prototype,"loop",void 0),t([f({nonNullable:!0})],j.prototype,"mode",void 0),t([f({nonNullable:!0,value:1e3})],j.prototype,"playRate",null),t([f({readOnly:!0})],j.prototype,"state",null),t([f({cast:t=>null==t?null:(y(t)&&(t.interval=g(i,t.interval)),(y(t)||x(t))&&(t.timeExtent=g(e,t.timeExtent)),t)})],j.prototype,"stops",void 0),t([f({type:e})],j.prototype,"timeExtent",void 0),t([f({readOnly:!0})],j.prototype,"timeExtentValues",null),t([f()],j.prototype,"view",void 0),t([f()],j.prototype,"next",null),t([f()],j.prototype,"play",null),t([f()],j.prototype,"previous",null),t([f()],j.prototype,"stop",null),t([f()],j.prototype,"updateWebDocument",null),j=t([w("esri.widgets.TimeSlider.TimeSliderViewModel")],j);const b=j;export{b as default};

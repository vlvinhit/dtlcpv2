/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{clone as t}from"../../core/lang.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import s from"./SearchSource.js";import{substitute as o}from"../../intl.js";import n from"../../core/Error.js";import{L as l}from"../../chunks/Logger.js";import{g as a}from"../../chunks/unitUtils.js";import c from"../../geometry/Polygon.js";import{F as u}from"../../chunks/FullTextSearch.js";import{c as d,s as p}from"../../chunks/geometryUtils3.js";import{f as m}from"../../chunks/date.js";import"../../chunks/typedArrayUtil.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/tracking.js";import"../../core/Identifiable.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/promiseUtils.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../chunks/datetime.js";import"../../chunks/writer.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../chunks/zmUtils.js";import"../../core/Clonable.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/scaleUtils.js";const h=/https?:\/\/services.*\.arcgis\.com/i,f=/(?:\{([^}]+)\})/g,g=l.getLogger("esri.widgets.Search.support.layerSearchUtils");function y(e,t){const{filter:r,withinViewEnabled:i}=e,s=t?.extent,o=r?.geometry;return o??(i&&s?s:void 0)}function j(e){return e&&e.includes("*")}async function F(e){e&&await e.load()}function x(e){return!(!e.fullText&&!e.where)}function v(e,t){const r=e?.indexes;return!(!r||!t?.length)&&r.filter((e=>"FullText"===e.indexType)).some((e=>{const r=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>r.includes(e.toLowerCase())))}))}function k({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new u({onFields:t,searchTerm:e,searchType:"prefix"})))}function w(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function b(e){return e?.capabilities?.query?.supportsPagination??!1}function S(e){return e.displayField||e.layer.displayField||(t=e.layer,t?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??"");var t}function T(e,t){return!(!e||!t?.length)&&t.every((t=>$(e,t)))}function $(e,t){return!!e.getField(t)}function I(e){return e.replaceAll("'","''")}function L(e,t){const r=t?.where;return r?`(${e}) AND (${r})`:e}function E({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:s,query:o,type:n}){const{definitionExpression:l,url:a}=t;let c="";return!o.fullText&&e&&r&&r.forEach((r=>{const o=t.getField(r),l="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),u=l&&"coded-value"===l.type?function(e,t,r){let i=null;const{codedValues:s}=e;return s&&s.some((e=>{const s=e.name,o=r?s:s.toLowerCase();return(r?t:t.toLowerCase())===o&&(i=e.code.toString(),!0)})),i}(l,e,s):null,d=u||e||null;if(null!==d){const e=function({currentTerm:e,field:t,filter:r,exactMatch:i,url:s,type:o}){const n=t?.type,l=t?.name;if("string"===n||"date"===n||"global-id"===n){const t=h.test(s??""),n=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";return L(i&&"search"===o?`${l} = ${n}'${e}'`:t?`${l} LIKE ${n}'${e}%'`:`LOWER(${l}) LIKE ${n}'${e.toLowerCase()}%'`,r)}if("oid"===n||"small-integer"===n||"integer"===n||"single"===n||"double"===n){const t=Number(e);return isNaN(t)?null:L(`${l} = ${t}`,r)}return L(`${l} = ${e}`,r)}({currentTerm:d,field:o,filter:i,exactMatch:s,url:a,type:n});e&&(c+=function(e,t){return e?` OR (${t})`:`(${t})`}(c,e))}})),l&&c?`(${l}) AND (${c})`:l||c}function R(e,t,r){const i=e.sourceLayer,{attributes:s}=e,n="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return o(t,s);if(r&&s){const e=i.getField(r),t=(a=r,(l=s)[Object.keys(l).find((e=>e.toLowerCase()===a.toLowerCase()))]);return null==t?"":n&&"coded-value"===n.type?function(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}(n,t)??"":"date"===e?.type?m(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}var M;let U=M=class extends s{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,r)=>function(e,r){const{exactMatch:i=!1,location:s,maxResults:o,spatialReference:l,source:u,sourceIndex:m,suggestResult:h,view:f}=e,{layer:L,filter:M,zoomScale:U}=u,C=f?.scale,_=y(u,f),A=r&&r.signal;return F(L).then((()=>{const e=L.popupTemplate;return e?e.getRequiredFields(L.fieldsIndex):null})).then((e=>{const{objectIdField:r,returnZ:y}=L,F=S(u);if(!$(L,F))throw g.error("invalid-field: displayField is invalid."),new n("getResults():invalid-field","displayField is invalid.");const q=e&&e.length?e:[F],D=u.outFields||q,N=j(D);if(D.includes(r)||N||D.push(r),L.floorInfo?.floorField&&D.push(L.floorInfo.floorField),!N&&!T(L,D))throw g.error("invalid-field: outField is invalid."),new n("getResults():invalid-field","outField is invalid.");const B=L.createQuery(),{orderByFields:O}=u;if(O&&(B.orderByFields=O),l){B.outSpatialReference=l;const e=1/a(l);e&&(B.maxAllowableOffset=e)}const P="mesh"===L.geometryType||"multipatch"===L.geometryType,G=L.capabilities?.data?.supportsZ&&!P;if(B.returnZ=G&&!1!==y,B.returnGeometry=!0,B.multipatchOption=P?"xyFootprint":null,D&&(B.outFields=D),s)B.geometry=s;else if(h.key)B.objectIds=[h.key];else{const e=u.searchFields||[F];if(!T(L,e))throw g.error("invalid-field: search field is invalid."),new n("getResults():invalid-field","search field is invalid.");b(L)&&(B.num=o),_&&(B.geometry=_);const t=h.text?.trim();if(!t)return[];const r=h.text,{prefix:s="",suffix:l=""}=u,a=I(`${s}${r}${l}`);w(L)&&v(L,e)&&!i&&r&&(B.fullText=k({text:r,searchFields:e}));const c=E({searchTerm:a,layer:L,searchFields:e,filter:M,exactMatch:i,query:B,type:"search"});if(B.where=c,!x(B))return[]}return L.queryFeatures(B,{signal:A}).then((e=>function(e,r,i,s,o,n,l){return e.features.map((e=>function(e,r,i,s,o,n,l){const a=e.clone(),u=e.sourceLayer,m=u?.objectIdField,h=m?e.attributes[m]:null,f=R(e,i.searchTemplate,o),g=d(a.geometry,r,n),y="number"==typeof l?p(t(g),r,l):g,j=e.clone();return null!=y&&(j.geometry=c.fromExtent(y)),{extent:y,target:j,feature:a,key:h,name:f,sourceIndex:s}}(e,r,i,s,o,n,l)))}(e,f,u,m,F,C,U)))}))}({source:this,...e},r),this.getSuggestions=(e,t)=>function(e,t){const{source:r,spatialReference:i,view:s,suggestTerm:o,maxSuggestions:l,sourceIndex:a,exactMatch:c}=e,{layer:u,filter:d}=r,p=t&&t.signal,m=y(r,s);return F(u).then((()=>{if(!b(u))return[];const e=S(r),t=r.searchFields||[e],s=[];r.suggestionTemplate?r.suggestionTemplate.replaceAll(f,((e,t)=>(s.push(t),e))):s.push(e);const h=j(s);s.includes(u.objectIdField)||h||s.push(u.objectIdField);const y=$(u,e),F=h||T(u,s),L=T(u,t);if(!y)throw g.error("invalid-field: displayField is invalid."),new n("getSuggestions():invalid-field","displayField is invalid.");if(!F)throw g.error("invalid-field: outField is invalid."),new n("getSuggestions():invalid-field","outField is invalid.");if(!L)throw g.error("invalid-field: search field is invalid."),new n("getSuggestions():invalid-field","search field is invalid.");const M=u.createQuery(),{orderByFields:U}=r;if(U&&(M.orderByFields=U),M.outSpatialReference=i,M.returnGeometry=!1,M.num=l,M.outFields=s,m&&(M.geometry=m),!o.trim())return[];const{prefix:C="",suffix:_=""}=r,A=I(`${C}${o}${_}`);w(u)&&v(u,t)&&!c&&o&&(M.fullText=k({text:o,searchFields:t}));const q=E({searchTerm:A,layer:u,searchFields:t,filter:d,exactMatch:c,query:M,type:"suggest"});return M.where=q,x(M)?u.queryFeatures(M,{signal:p}).then((t=>function(e,t,r,i){return e.features.map((e=>function(e,t,r,i){const s=e.sourceLayer,{attributes:o}=e,{objectIdField:n}=s,l=n?o[n]:null;return{text:R(e,t.suggestionTemplate,i),key:l,sourceIndex:r}}(e,t,r,i)))}(t,r,a,e))):[]}))}({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch((()=>{}))}get name(){return this._getLayerTitle()??""}set name(e){this._overrideIfSome("name",e)}clone(){return new M({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?t(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?t(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find((e=>"string"===e.type))?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;return e.loaded?`: ${(t||[this._getDisplayField()]).map((t=>{const r=e.getField(t);return r&&r.alias||t})).join(", ")}`:""}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([r({json:{read:{source:"field.name"},write:{target:"field.name"}}})],U.prototype,"displayField",void 0),e([r({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],U.prototype,"exactMatch",void 0),e([r({value:null})],U.prototype,"layer",null),e([r()],U.prototype,"name",null),e([r({type:[String],json:{write:!0}})],U.prototype,"orderByFields",void 0),e([r()],U.prototype,"searchFields",void 0),e([r()],U.prototype,"searchTemplate",void 0),e([r()],U.prototype,"suggestionTemplate",void 0),U=M=e([i("esri.widgets.Search.LayerSearchSource")],U);const C=U;export{C as default};

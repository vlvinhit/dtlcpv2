/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{d as s}from"../../chunks/deprecate.js";import r from"../../core/Evented.js";import{HandleOwnerMixin as o}from"../../core/HandleOwner.js";import{L as i}from"../../chunks/Logger.js";import{d as n}from"../../chunks/maybe.js";import{EsriPromiseMixin as a}from"../../core/Promise.js";import{watch as l}from"../../core/reactiveUtils.js";import{t as p}from"../../chunks/string.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import{o as c}from"../../chunks/ensureType.js";import{i as m}from"../../chunks/typedArrayUtil.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../form/FormTemplate.js";import y from"../../core/Accessor.js";import{i as f}from"../../chunks/editableLayers.js";import g from"../../request.js";import{JSONSupportMixin as j}from"../../core/JSONSupport.js";import b from"../../core/Loadable.js";import{p as _}from"../../chunks/arcgisLayerUrl.js";import{S as v}from"../../chunks/Subtype.js";import{l as V,m as x,p as k,i as C,n as F,o as E,q as I,b as T,a as S,r as w}from"../../chunks/featureFormUtils.js";import R from"./FieldInput.js";import{createArcadeProfile as A,createArcadeExecutor as L}from"../../arcade.js";import{debounce as M,isAbortError as G,createResolver as U}from"../../core/promiseUtils.js";import{W as D}from"../../chunks/WatchUpdatingTracking.js";import{fixFields as P}from"../../layers/support/fieldUtils.js";import O from"./GroupInput.js";import N from"./RelationshipInput.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../core/lang.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/object.js";import"../../chunks/writer.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../core/Error.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/arcadeOnDemand.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../chunks/infoFor3D.js";import"../../chunks/layerUtils.js";import"../../intl.js";import"../../chunks/messages.js";import"../../chunks/assets.js";import"../../chunks/featureUtils.js";import"./EditableInput.js";import"./InputBase.js";import"../../chunks/ArcadeDate.js";import"../../chunks/executionError.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryLoader.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/featureFlags.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../layers/Layer.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/QuantizationParameters.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/TimeReference.js";import"../../chunks/featureLayerUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../chunks/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../geometry/projection.js";import"../../chunks/pe.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../support/popupUtils.js";import"../../chunks/FeatureRelationshipViewModel.js";let B=class extends y{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};e([u()],B.prototype,"objectType",void 0),e([u()],B.prototype,"maxValue",void 0),e([u()],B.prototype,"minValue",void 0),e([u()],B.prototype,"codedValue",void 0),B=e([d("esri.layers.support.ContingentValue")],B);const $=B;let H=class extends y{constructor(e){super(e),this.isRetired=!1}};e([u()],H.prototype,"id",void 0),e([u()],H.prototype,"isRetired",void 0),e([u()],H.prototype,"subtype",void 0),e([u()],H.prototype,"values",void 0),H=e([d("esri.layers.support.Contingency")],H);const J=H;let q=class extends y{constructor(e){super(e)}};e([u()],q.prototype,"fieldGroup",void 0),e([u()],q.prototype,"type",void 0),q=e([d("esri.layers.support.ContingencyConstraintViolation")],q);const z=q;let W=class extends y{constructor(e){super(e)}};e([u()],W.prototype,"contingentValuesAllGroups",void 0),e([u()],W.prototype,"contingentValuesByFieldGroup",void 0),W=e([d("esri.layers.support.ContingentValuesResult")],W);const Q=W;let K=class extends y{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};e([u()],K.prototype,"name",void 0),e([u()],K.prototype,"fields",void 0),e([u()],K.prototype,"isEditingRestrictive",void 0),e([u()],K.prototype,"contingencies",void 0),K=e([d("esri.layers.support.FieldGroup")],K);const Y=K;var Z;let X=Z=class extends(j(b)){constructor(e){super(e),this.request=g,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){const{layer:e}=this;return"subtype-group"===e.type?e.subtypeField:e.typeIdField}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON;if(void 0===e.layerId)return null;const s=t.hasContingentValuesDefinition;if(s)return new Z({layer:e}).load();if(void 0===s){const t=_(e.url);if(null==t)return null;const s=t.url.path;if((await Z._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const t=e.layerId.toString(),r=await Z._staticFetchEnterpriseFieldGroup(s,t);if(r){const t=r.map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names})));return new Z({layer:e,fieldGroupDefinitions:t}).load()}}}return null}async load(e){const t=this.layer.load(e).then((()=>this._initializeContingentValues(this.fieldGroupDefinitions,e)));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const s=Object.keys(e),r=[],o=[];for(const i of this.fieldGroups){const n=i.isEditingRestrictive?"error":"warning";if(t&&!i.fields.some((e=>t.includes(e))))continue;if(!i.fields.every((e=>s.includes(e)))){o.push(new z({fieldGroup:i,type:n}));continue}let a=!1;const l=e[this.subtypeFieldName],p=i.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===l));for(const t of p){let s=!0;for(const r in t.values){const o=t.values[r];if("any"!==o.objectType)if("null"===o.objectType){if(null!=e[r]){s=!1;break}}else if("code"===o.objectType){if(e[r]!==o.codedValue.code){s=!1;break}}else if("range"===o.objectType){const t=e[r];if(t<o.minValue||t>o.maxValue){s=!1;break}}}if(s){a=!0;break}}a||r.push(new z({fieldGroup:i,type:n}))}return{invalid:r,incomplete:o}}getContingentValues(e,t,s=!1){const r=e[this.subtypeFieldName],o=null!=r,i={};let n=[];const a=this.fieldGroups.filter((e=>e.fields.includes(t)));n.push(new $({objectType:"any"}));for(const l of a){let a=[];const p=l.contingencies.filter((e=>!(e.isRetired||e.subtype&&o&&e.subtype.code!==r)));let u=!1;const c={};for(const s of p){let r,o=!0;for(const i in s.values){const n=s.values[i];if(t!==i){if(void 0!==e[i]&&"any"!==n.objectType)if("null"===n.objectType)null!==e[i]&&(o=!1);else if("code"===n.objectType)e[i]!==n.codedValue.code&&(o=!1);else if("range"===n.objectType){const t=e[i];(t<n.minValue||t>n.maxValue)&&(o=!1)}}else r=n,u=u||"range"===n.objectType}if(r&&o){if("any"===r.objectType){a.length=0,a.push(r);break}const e=this._generateKey(r);c[e]||a.push(r),c[e]=!0}}u&&(a=this._joinRange(a)),i[l.name]=a,n=s?this._filterIntersection(n,a):[]}return 1===a.length&&s&&(n=[]),new Q({contingentValuesAllGroups:n,contingentValuesByFieldGroup:i})}_generateKey(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}_joinRange(e){let t,s;e.sort(((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue));const r=[];for(const o of e)"null"!==o.objectType?null!=t&&null!=s?s<o.minValue?(r.push(new $({objectType:"range",minValue:t,maxValue:s})),t=o.minValue,s=o.maxValue):s<o.maxValue&&(s=o.maxValue):(t=o.minValue,s=o.maxValue):r.push(o);return r.push(new $({objectType:"range",minValue:t,maxValue:s})),r}_filterIntersection(e,t){if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const s="range"===e[0].objectType||"range"===e[1]?.objectType,r="range"===t[0].objectType||"range"===t[1]?.objectType;return s||r?this._intersectRanges(e,t):this._intersectValues(e,t)}_intersectRanges(e,t){const s=[];let r,o=0;for(const i of e)for(;o<t.length;o++){const e=t[o];if("null"===i.objectType&&"null"===e.objectType)s.push(new $({objectType:"null"}));else{if("null"===i.objectType)break;if("null"===e.objectType)continue}if(i.maxValue<e.minValue)break;if(i.maxValue===e.minValue){s.push(new $({objectType:"range",minValue:i.maxValue,maxValue:e.minValue}));break}if(!(i.minValue>e.maxValue))if(i.minValue!==e.maxValue){if(r=i.minValue>e.minValue?i.minValue:e.minValue,i.maxValue<e.maxValue){s.push(new $({objectType:"range",minValue:r,maxValue:i.maxValue}));break}s.push(new $({objectType:"range",minValue:r,maxValue:e.maxValue}))}else s.push(new $({objectType:"range",minValue:i.minValue,maxValue:e.maxValue}))}return s}_intersectValues(e,t){const s=[];for(const r of e)t.some((e=>{if(r.objectType===e.objectType)switch(r.objectType){case"any":case"null":return!0;case"code":return r.codedValue.code===e.codedValue.code&&r.codedValue.name===e.codedValue.name}return!1}))&&s.push(r);return s}static async _staticFetchEnterpriseFeatureRoot(e,t){return g(e,{responseType:"json",query:{f:"json"},...t}).then((e=>e.data))}static async _staticFetchEnterpriseFieldGroup(e,t,s){return g(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>e.data.layerDataElements?.[0].dataElement.fieldGroups))}async _initializeContingentValues(e,t){const s=e??await this._fetchFieldGroupDefs(t);if(0===s.length)return void(this.fieldGroups=[]);const r=await this._fetchContingentValues(s,t);this.fieldGroups=r}async _fetchFieldGroupDefs(e){if(void 0===this.layer.layerId)return[];const t=this.layer.sourceJSON,s=this.layer.layerId.toString(),r=_(this.layer.url).url.path;return t.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(r,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))}))):void 0!==t.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(r,e).then((async t=>t.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(r,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))}))):[]))}async _fetchAGOLFieldGroup(e,t,s){return g(`${e}/${t}/fieldgroups`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data.fieldGroups))}async _fetchEnterpriseFieldGroup(e,t,s){return Z._staticFetchEnterpriseFieldGroup(e,t,s)}async _fetchEnterpriseFeatureRoot(e,t){return Z._staticFetchEnterpriseFeatureRoot(e,t)}async _fetchContingentValues(e,t){if(void 0===this.layer.layerId)return[];const s=this.layer.sourceJSON,r=this.layer.layerId.toString(),o=_(this.layer.url).url.path;if(s.hasContingentValuesDefinition){const s=await this._fetchAGOLContingentValues(o,r,t);return this._constructFieldGroupsAGOL(e,s)}const i=await this._fetchEnterpriseContingentValues(o,r,t);return this._constructFieldGroupsEnterprise(e,i)}_constructFieldGroupsAGOL(e,t){return e.map((e=>{const s=t.contingentValuesDefinition.fieldGroups.find((t=>t.name===e.name));if(s){let r=[];return r=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,s.subTypes):this._parseAGOLFieldGroup(e,t,s.contingentValues),new Y({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:r})}return null})).filter(m)}_parseAGOLFieldGroupSubtype(e,t,s){let r=[];return s?.forEach((s=>{const o=this._getSubtypeAGOL(s.name);r=r.concat(this._parseAGOLFieldGroup(e,t,s.contingentValues,o))})),r}_parseAGOLFieldGroup(e,t,s,r=null){const o=[];for(const i of s??[]){const s=this._parseAGOLContingency(i,e,t,r);o.push(s)}return o}_parseAGOLContingency(e,t,s,r){const o=e.id,i=!!e.retired&&1===e.retired,n={};for(let o=0,i=0;o<t.fields.length;o++){const a=t.fields[o],l=s.typeCodes[e.types[o]];if("Code"===l){let t=e.values[i];i++;const o=this._getDomain(r,a),l=this.layer.getField(a);if("string"===l?.type){const e=s.stringDicts.find((e=>e.domain===o.name));e&&(t=e.entries[t])}const p=o.codedValues.find((e=>e.code===t)),u=new $({codedValue:p,objectType:"code"});n[a]=u}else if("Range"===l){const t=e.values[i];i++;const s=t.range[0],r=t.range[1],o=new $({minValue:s,maxValue:r,objectType:"range"});n[a]=o}else if("Any"===l){const e=new $({objectType:"any"});n[a]=e}else{const e=new $({objectType:"null"});n[a]=e}}return new J({id:o,isRetired:i,subtype:r,values:n})}_constructFieldGroupsEnterprise(e,t){const s=t.fieldGroups;return e.map((e=>{const r=s.find((t=>t.name===e.name));if(r){const s=r.contingencies.map((s=>{const r=s.id,o=s.isRetired||!1,i=this._getSubtypeEnterprise(s.subtypeCode),n={};for(let r=0;r<e.fields.length;r++){const o=e.fields[r];let a=s.values[r];if("number"==typeof a||"string"==typeof a){const e=this._getDomain(i,o),s=this.layer.getField(o);if("string"===s?.type)a=t.stringDictionary[a];else if("date"===s?.type){const e=new Date(`${a}+00:00`);a=e.getTime()}const r=e.codedValues.find((e=>e.code===a)),l=new $({codedValue:r,objectType:"code"});n[o]=l}else if("object"==typeof a){const e=a.minValue,t=a.maxValue,s=new $({minValue:e,maxValue:t,objectType:"range"});n[o]=s}else if(a){const e=new $({objectType:"any"});n[o]=e}else{const e=new $({objectType:"null"});n[o]=e}}return new J({id:r,isRetired:o,subtype:i,values:n})}));return new Y({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:s})}return null})).filter(m)}async _fetchEnterpriseContingentValues(e,t,s){return g(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>e.data.contingentValueSets?.[0]))}async _fetchAGOLContingentValues(e,t,s){return g(`${e}/${t}/contingentValues`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data))}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const r=t.subtypes.find((t=>t.code===e));s=v.fromJSON(r)}return s||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const r=t.subtypes.find((t=>t.name===e));s=v.fromJSON(r)}return s||null}_getDomain(e,t){const s=e?e.domains?.[t]:this.layer.getFieldDomain(t);return"inherited"===s?.type?this.layer.getFieldDomain(t):s}};e([u({constructOnly:!0})],X.prototype,"layer",void 0),e([u({constructOnly:!0})],X.prototype,"request",void 0),e([u({type:[Y]})],X.prototype,"fieldGroups",void 0),e([u({constructOnly:!0})],X.prototype,"fieldGroupDefinitions",void 0),e([u()],X.prototype,"subtypeFieldName",null),X=Z=e([d("esri.layers.support.LayerContingentValuesCache")],X);const ee=X;var te;const se=Symbol("FormExpressionArcadeExecutor");let re=class extends y{constructor(e){super(e),this[te]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._stale=!1,this._updatingTracking=new D,this._executeAsyncDebounced=M((async(e,t,s)=>{const r=await this.executor.executeAsync(e,{...t,abortSignal:s});return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=r,this._stale=!1,r)}))}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,t){this._abortController=new AbortController;const s=this.executor.execute(e,{...t,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=s,s}async executeAsync(e,t){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,t??{},this._abortController.signal))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};te=se,e([u()],re.prototype,"_lastEvaluatedValue",void 0),e([u()],re.prototype,"_stale",void 0),e([u()],re.prototype,"_updatingTracking",void 0),e([u({constructOnly:!0})],re.prototype,"executor",void 0),e([u()],re.prototype,"isAsync",null),e([u()],re.prototype,"fieldsUsed",null),e([u()],re.prototype,"syntaxTree",null),e([u()],re.prototype,"updating",null),e([u()],re.prototype,"stale",null),e([u()],re.prototype,"geometryUsed",null),e([u()],re.prototype,"variablesUsed",null),e([u()],re.prototype,"lastEvaluatedValue",null),re=e([d("esri.widgets.FeatureForm.FormExpressionArcadeExecutor")],re);const oe=async(e,t)=>{const s=A("form-calculation"),r=await L(e,s,{});return t?.fieldsIndex&&(r.fieldsUsed=P(t.fieldsIndex,r.fieldsUsed)),new re({executor:r})},ie="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY";let ne=class extends y{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}get _baseContext(){const{editType:e,layer:t,map:s,originalFeature:r,spatialReference:o}=this.arcadeContextInfo,i="feature"===t?.type?t:"scene"===t?.type&&null!=t.associatedLayer?t.associatedLayer:void 0;return[{$originalfeature:r,$editcontext:{editType:e},$layer:i,$featureset:i,$datastore:t?.url,$map:s},{spatialReference:o??void 0}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:s,feature:r}=this,o=new Set;for(const i of e)if(s[i]=r.getAttribute(i),t.has(i))for(const e of t.get(i))o.add(e);return this._evaluate([...o])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(ie))return this._evaluate([...this._fieldReferencesLookup.get(ie)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:s}=this,r=new Map(this.fieldInputs.map((e=>[e.name,e]))),o=new Map(s.map((e=>[e,new Array])));for(const i of s){for(const s of i.fieldsUsed){c(e,s,(()=>new Set)).add(i);const n=r.get(s),a=n?.valueExpressionExecutor,l=n?.editableExpressionExecutor;null!=a&&a!==i&&(o.get(a).push(i),c(t,a,(()=>new Set)).add(n)),null!=l&&l!==i&&(o.get(l).push(i),c(t,l,(()=>new Set)).add(n))}i.geometryUsed&&c(e,ie,(()=>new Set)).add(i)}return o}async _evaluate(e){const t=new Map,{_dependencyGraph:s,_fieldsAffectedLookup:r,_latestFieldValues:o}=this;for(const r of e)ae(r,t,s);for(const[e,{resolver:s,dependencyPromises:i}]of t)Promise.all(i).then((async()=>{const[t,s]=this._makeContext(o);return e.executeAsync(t,s)})).then((()=>{if(r.has(e))for(const t of r.get(e))this._latestFieldValues[t.name]=t.value;s.resolve()}),(t=>{!t||G(t)||le(t)||e.markStale(),s.reject(t)}));const i=(await Promise.allSettled(Array.from(t.values(),(({resolver:e})=>e.promise)))).filter((e=>"rejected"===e.status&&!(G(e.reason)||le(e.reason))));if(i.length>0)throw new AggregateError(i,"One or more expression executions failed")}_makeContext(e){const[t,s]=this._baseContext,r=this.feature.clone();return r.attributes=e,[{...t,$feature:r},s]}};e([u()],ne.prototype,"_baseContext",null),e([u()],ne.prototype,"feature",null),e([u()],ne.prototype,"executors",void 0),e([u()],ne.prototype,"fieldInputs",void 0),e([u()],ne.prototype,"arcadeContextInfo",void 0),ne=e([d("esri.widgets.FeatureForm.FormExpressionsManager")],ne);const ae=(e,t,s)=>{if(t.has(e))return;const r=U();t.set(e,{resolver:r,dependencyPromises:[]}),e.abort();const o=s.get(e);for(const e of o)ae(e,t,s),t.get(e).dependencyPromises.push(r.promise)},le=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message,pe=new t({attributes:{}}),ue=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],ce=["visibilityExpression"],me=["editableExpression","visibilityExpression"],de="#JSAPI_CONTINGENT_VALUE_ANY_HASH",he="esri.widgets.FeatureForm.FeatureFormViewModel",ye=i.getLogger(he);let fe=class extends(o(a(r.EventedAccessor))){constructor(e){super(e),this._expressionExecutorLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=pe.clone(),this._initialFeature=pe.clone(),this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.inputs=[],this.map=null,this.relatedRecordCallbacks=null,this.strict=!1}initialize(){const e=l((()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.arcadeEditType]),(([e,t])=>{null!=e&&(t?this._updateInputs():e.load().catch((()=>i.getLogger(this).error("Failed to load layer",e.loadError))))}),{equals:([e,t,s,r,o],[i,n,a,l,p])=>e===i&&t===n&&s===a&&r===l&&o===p,initial:!0}),t=l((()=>this._arcadeContextInfo),(e=>{null!=this._expressionsManager&&(this._expressionsManager.arcadeContextInfo=e)})),s=l((()=>this.layer),(e=>{const t="subtype-sublayer"===e?.type?e.parent:"feature"===e?.type?e:null;t&&this.addResolvingPromise(ee.createLoadedLayerContingentValuesCache(t).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0});this.handles.add([e,t,s])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=n(this._contingentValuesCache)}get _expressionInfosLookup(){return new Map(this.formTemplate?.expressionInfos?.map((e=>[e.name,e])))}get activeRelationshipInput(){return this.allRelationshipInputs.find((e=>e.relationshipId===this.relationshipId))}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:t,layer:s,map:r,spatialReference:o}=this;return{layer:f(s)?s:null,originalFeature:e,editType:t,map:r,spatialReference:o}}get allFieldInputs(){return V(this.inputs)}get allRelationshipInputs(){return x(this.inputs)}get _layerFieldsByName(){return new Map(this.layer?.fields.map((e=>[e.name,e])))}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():pe.clone(),this._initialFeature=this._featureClone.clone(),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach((t=>t.feature=e))):(this.inputs.forEach((e=>e.destroy())),this.inputs.length=0),this.contingencyConstraintViolations.clear(),null!=this._expressionsManager&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated())))),this._set("feature",e)}get fieldsWithContingentValues(){if(null==this._contingentValuesCache)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:t}=this;return null!=e&&e.description&&t?k(e.description,this.getValues(),t.fieldsIndex):null}get formTitle(){const{formTemplate:e,layer:t}=this;return null!=e&&e.title&&t?k(e.title,this.getValues(),t.fieldsIndex):null}formHeaderVisible(){const{activeRelationshipInput:e,formDescription:t,formTitle:s}=this;return!(e||!t&&!s)}set inputFields(e){s(ye,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs=e}get inputFields(){return s(ye,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){const t=this.allRelationshipInputs;if(null!=e&&e===this.relationshipId||t.forEach((e=>e.showAllEnabled=!1)),null!=e){const s=t.find((t=>t.relationshipId===e));s&&(s.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.get("layer.loaded")?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter((e=>!e.valid)).every((({submittable:e})=>e))}get updating(){return this.updatingHandles.updating}get valid(){const e=this.allFieldInputs;return e.length>0&&e.every((({valid:e})=>e))}get view(){return s(ye,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._get("view")}set view(e){s(ye,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._set("view",e),e?.map&&(this.map=e.map)}findField(e){return this.allFieldInputs.find((t=>t.name===e))}getValue(e){const{_featureClone:t,layer:s}=this,r=!!s?.getField(e);return t.getAttribute(e)??(r?null:void 0)}setValue(e,t){const{_featureClone:s,strict:r}=this,o=this.findField(e);t=""===t?null:t,o&&s.getAttribute(e)!==t&&(o.value=t,r&&!o.valid||(this._afterValueChange(o),null!=this._expressionsManager&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([o.name]).finally((()=>this._afterExpressionsEvaluated())))))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this.allFieldInputs,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),s=e.filter((e=>!e.valid)).map((({name:e})=>e)),r=this.getValues();if(this.validateContingencyConstraints(r,{includeIncompleteViolations:!0}).length>0)for(const[e,r]of this.contingencyConstraintViolations.entries())"error"===r.type&&(t.delete(e),s.push(e));this.emit("submit",{valid:[...t],invalid:s,values:r})}validateContingencyConstraints(e,t){const{_contingentValuesCache:s}=this,r=new Map;if(this.contingencyConstraintViolations=r,null==s)return[];const{invalid:o,incomplete:i}=s.validateContingencyConstraints(e),n=[...o,...t?.includeIncompleteViolations?i:[]];for(const e of n)for(const t of e.fieldGroup.fields)r.set(t,e);return n}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:t,_featureClone:s}=this;s.geometry=t.geometry,null!=e&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally((()=>this._afterExpressionsEvaluated())))}_emitChangeEvent({name:e,valid:t,value:s}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:s,valid:t})}_updateInputs(){const{_featureClone:e,_initialFeature:t,arcadeEditType:s,formTemplate:r,inputs:o,layer:i}=this;if(!i)return;const n={arcadeEditType:s,feature:e,initialFeature:t,layer:i},a=o.slice(),l=null!=r&&r.elements&&r.elements.length>0?this._updateInputsUsingFormElements(a,r.elements,n):this._updateInputsUsingLayerFields(a,i?.fields,n);this.inputs=l}_updateInputsUsingFormElements(e,t,s){const r=new Map;for(const t of e)if(C(t)){r.set(t.element,t);for(const e of t.inputs)e.element&&r.set(e.element,e)}else t.element&&r.set(t.element,t);const o=new Map,i=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:r,updatedElements:t.filter(ge),sharedInitializationProperties:s,group:null,newExpressionExecutorPromises:o});this.updatingHandles.addPromise(Promise.all(Array.from(o.values())).then((()=>{const e=Array.from(this._expressionExecutorLookup.values()),t=V(i);return this._createExpressionsManager(e,t),this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated()))})));for(const[e,t]of r.entries())r.delete(e),t.destroy();return i}_updateInputsUsingFormElementsRecursive(e){const{existingInputsByElement:t,updatedElements:s,sharedInitializationProperties:r,group:o,newExpressionExecutorPromises:i}=e,n=[];for(const e of s){const s=t.has(e),a=s?t.get(e):F(e)?this._makeGroupInputFromElement(e,r):E(e)?this._makeFieldInputFromElement(e,r,o):I(e)?this._makeRelationshipInputFromElement(e,r,o):null;if(a){if(n.push(a),s)if(t.delete(e),C(a)){const{feature:e}=r;a.set({feature:e})}else if(T(a)){const t=this.relationshipId===e.relationshipId;a.set(r),a.set({map:this.map,showAllEnabled:t})}else a.set(r);else this._assignExpressionExecutors(a,e,i);if(F(e)){const s=e.elements.filter((e=>ge(e)));a.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:s,sharedInitializationProperties:r,group:a,newExpressionExecutorPromises:i})}}}return n}_updateInputsUsingLayerFields(e,t,s){if(!Array.isArray(t))return i.getLogger(this).warn(this.declaredClass,"No attribute fields found."),[];const r=new Map;for(const t of e)if(C(t)){for(const e of t.inputs)e.destroy();t.inputs.length=0,t.destroy()}else T(t)?t.destroy():S(t)&&(null!==t.element?t.destroy():r.set(t.field,t));const o=[],{arcadeEditType:n,feature:a,initialFeature:l,layer:p}=s;for(const e of t){const t=r.get(e)??new R({arcadeEditType:n,field:e,feature:a,initialFeature:l,layer:p,value:a?.getAttribute(e.name)??null});o.push(t),r.delete(e)}for(const[e,t]of r.entries())r.delete(e),t.destroy();return o}_resetFieldInputValues(e){for(const t of this.allFieldInputs)t.value=e.getAttribute(t.name)}_makeFieldInputFromElement(e,t,s){const{arcadeEditType:r,feature:o,initialFeature:i,layer:n}=t,{fieldName:a}=e,l=a&&this._layerFieldsByName.get(a);return l?new R({arcadeEditType:r,element:e,field:l,value:o?.getAttribute(e.fieldName)??null,feature:o,initialFeature:i,layer:n,group:s}):null}_makeGroupInputFromElement(e,t){const{feature:s,layer:r}=t;return new O({element:e,inputs:[],feature:s,layer:r})}_makeRelationshipInputFromElement(e,t,s=null){const{map:r}=this,{feature:o,layer:i}=t;return new N({element:e,feature:o,group:s,layer:i,map:r})}_assignExpressionExecutors(e,t,s){const r=F(t)?ce:I(t)?me:ue;for(const o of r){const r=t[o],{_expressionExecutorLookup:i}=this;if(null!=r&&""!==r){const t=`${o}Executor`,n=this._expressionInfosLookup.get(r)?.expression??r;if(i.has(n))e[t]=i.get(n);else if(s.has(n)){const r=s.get(n).then((s=>(e[t]=s,s)));s.set(n,r)}else{const r=oe(n,this.layer).then((s=>(e[t]=s,i.set(n,s),s)));s.set(n,r)}}}return[]}_createExpressionsManager(e,t){const{_arcadeContextInfo:s,_featureClone:r}=this;this._expressionsManager=new ne({executors:e,feature:r,arcadeContextInfo:s,fieldInputs:t})}_afterValueChange(e){const{name:t,value:s}=e,{_featureClone:r,formTemplate:o,layer:i}=this;if(!i)return;const n=r.getAttribute(t);r.setAttribute(t,s);const{typeFieldName:a,types:l}=w(i);if(t===a&&s!==n){if("subtype-sublayer"===i.type){const e=i.parent?.findSublayerForFeature(r);r.sourceLayer=this.feature.sourceLayer=e}const e=new Set;for(const t of l)if(t.domains&&"object"==typeof t.domains)for(const s of Object.keys(t.domains))e.add(s);for(const t of e){const e=this.findField(t);e&&e.notifyChange("domain")}}if(null!=o){const{description:e,title:s}=o;s&&p(s,t)&&this.notifyChange("formTitle"),e&&p(e,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_joinContingentValues(){const e=this._contingentValuesCache;if(null==e)return[];const{typeFieldName:t}=w(this.layer),s=t?this.getValue(t):null,r=[];for(const t of e.fieldGroups){const{contingencies:e,fields:o,name:i}=t,n=[];for(const t of e)t.isRetired||null!=t.subtype&&t.subtype.code!==s||n.push({values:t.values});n.length>0&&r.push({name:i,fields:o,contingencies:n})}const[o,i]=this._generateJoinPlan(r);return[...o.flatMap((e=>this._joinFieldGroupContingencies(e))),...i.flatMap((e=>e.contingencies))]}_generateJoinPlan(e){const t=new Map,s=[],r=new Set;for(const o of e)for(const e of o.fields)if(t.has(e)){const i=t.get(e),n=o,a=[i.name,n.name].sort().join("|");if(r.has(a))continue;s.push([i,n]),r.add(a),t.set(e,n)}else t.set(e,o);const o=new Set(s.flat()),i=new Set(e);for(const e of o)i.delete(e);const n=new Map,a=new Map;for(const e of new Set(s.flat())){const t=Symbol(e.name);n.set(t,new Set([e])),a.set(e,t)}for(const[e,t]of s){const s=a.get(e),r=a.get(t);if(s===r)continue;const o=n.get(s),i=n.get(r);for(const e of i)o.add(e),a.set(e,s);n.delete(r)}return[[...n.values()].map((e=>[...e])),[...i]]}_joinFieldGroupContingencies(e){const t=e.slice(),s=t.shift();let r=t.shift(),o=this._generateJoinKey(s.fields,r.fields),i=new Set([...s.fields,...r.fields]),n=new Map;for(const e of s.contingencies){const[t]=this._hashContingency(e,o.codedValueFields,!0);n.has(t)?n.get(t)?.push(e):n.set(t,[e])}for(;t.length>0;){const e=new Map,s=t.shift(),a=this._generateJoinKey(i,s.fields);for(const t of r.contingencies){const[s,r]=this._hashContingency(t,o.codedValueFields),i=r?this._findMatchingContingenciesWithAnyHashMask(n,s):n.get(s);if(n.has(de)&&i?.push(...this._findMatchingContingenciesContainingAny(t,n.get(de),o.codedValueFields)),null!=i)for(const s of i){const r=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(s,t,o.rangeFields):this._joinContingencies(s,t);if(null==r)break;const[i]=this._hashContingency(r,a.codedValueFields,!0);e.has(i)?e.get(i)?.push(r):e.set(i,[r])}}n=e,r=s,o=a,i=new Set([...i,...r.fields])}const a=[];for(const e of r.contingencies){const[t,s]=this._hashContingency(e,o.codedValueFields),r=s?this._findMatchingContingenciesWithAnyHashMask(n,t):n.get(t);if(n.has(de)&&r.push(...this._findMatchingContingenciesContainingAny(e,n.get(de),o.codedValueFields)),null!=r)for(const t of r){const s=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(t,e,o.rangeFields):this._joinContingencies(t,e);null!=s&&a.push(s)}}return a}_joinContingencies(e,t){const s={values:{...e.values,...t.values}};for(const[t,r]of Object.entries(s.values))"any"===r.objectType&&null!=e.values[t]&&(s.values[t]=e.values[t]);return s}_joinContingenciesWithRangeDomains(e,t,s){const r=this._joinContingencies(e,t);for(const o of s){const s=e.values[o],i=t.values[o],{leftIsNull:n,rightIsNull:a,bothAreNull:l,leftIsAny:p,rightIsAny:u,bothAreAny:c,leftIsRange:m,rightIsRange:d}=this._compareObjectTypes(s.objectType,i.objectType);if(l||c)continue;if(n&&u||a&&p){r.values[o]=new $({objectType:"null"});continue}if(n&&d||a&&m)return null;p?(s.minValue=-1/0,s.maxValue=1/0):u&&(i.minValue=-1/0,i.maxValue=1/0);const h=Math.max(s.minValue,i.minValue),y=Math.min(s.maxValue,i.maxValue);if(h>y)return null;r.values[o]=new $({objectType:"range",minValue:h,maxValue:y})}return r}_findMatchingContingenciesContainingAny(e,t,s){return t.filter((t=>s.every((s=>{const r=t.values[s],o=e.values[s];return"any"===r.objectType||"any"===o.objectType||r.codedValue?.code===o.codedValue?.code}))))}_findMatchingContingenciesWithAnyHashMask(e,t){const s=RegExp(`${t}$`),r=[];for(const[t,o]of e){if(t===de)break;s.test(t)&&r.push(...o)}return r}_generateJoinKey(e,t){const s=Array.isArray(e)?new Set(e):e,r=Array.isArray(t)?new Set(t):t,o=s.size<r.size?s:r,i=o===s?r:s,n=new Set,a=new Set;for(const e of o)if(i.has(e)){const t=this.layer?.getFieldDomain(e,{feature:this.feature});if(null==t)continue;switch(t.type){case"coded-value":n.add(e);break;case"range":a.add(e)}}return{codedValueFields:[...n],rangeFields:[...a]}}_hashContingency(e,t,s=!1){if(t.length<1)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const r=[];let o=!1;for(const i of t){const t=e.values[i];if("any"===t.objectType){if(s)return[de,!0];o=!0,r.push(`${i}:.*`)}else"null"===t.objectType?r.push(`${i}:#JSAPI_CONTINGENT_VALUE_NULL_HASH`):r.push(`${i}:${t.codedValue?.code}`)}return[r.sort().join("&"),o]}_compareObjectTypes(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}}};function ge(e){return"field"===e.type||"group"===e.type||"relationship"===e.type||(i.getLogger(he).warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}e([u()],fe.prototype,"_expressionInfosLookup",null),e([u()],fe.prototype,"_featureClone",void 0),e([u()],fe.prototype,"activeRelationshipInput",null),e([u()],fe.prototype,"_arcadeContextInfo",null),e([u({readOnly:!0})],fe.prototype,"allFieldInputs",null),e([u()],fe.prototype,"allRelationshipInputs",null),e([u()],fe.prototype,"_layerFieldsByName",null),e([u()],fe.prototype,"arcadeEditType",void 0),e([u()],fe.prototype,"contingencyConstraintViolations",void 0),e([u()],fe.prototype,"disabled",void 0),e([u()],fe.prototype,"feature",null),e([u()],fe.prototype,"fieldsWithContingentValues",null),e([u({type:h})],fe.prototype,"formTemplate",null),e([u()],fe.prototype,"formDescription",null),e([u()],fe.prototype,"formTitle",null),e([u()],fe.prototype,"formHeaderVisible",null),e([u()],fe.prototype,"inputs",void 0),e([u()],fe.prototype,"inputFields",null),e([u()],fe.prototype,"joinedContingentValues",null),e([u()],fe.prototype,"layer",null),e([u()],fe.prototype,"map",void 0),e([u()],fe.prototype,"relatedRecordCallbacks",void 0),e([u()],fe.prototype,"relationshipId",null),e([u()],fe.prototype,"spatialReference",null),e([u()],fe.prototype,"state",null),e([u()],fe.prototype,"strict",void 0),e([u()],fe.prototype,"submittable",null),e([u()],fe.prototype,"updating",null),e([u()],fe.prototype,"valid",null),e([u()],fe.prototype,"view",null),e([u()],fe.prototype,"getValues",null),e([u()],fe.prototype,"submit",null),fe=e([d(he)],fe);const je=fe;export{je as default};

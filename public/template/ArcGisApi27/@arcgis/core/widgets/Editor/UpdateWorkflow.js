/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import o from"../../core/Error.js";import{c as i,b as s}from"../../chunks/utils.js";import{L as r}from"../../chunks/Logger.js";import{b as a}from"../../chunks/maybe.js";import{isAborted as n,onAbort as l,createAbortError as p,throwIfAborted as c,debounce as d}from"../../core/promiseUtils.js";import{Q as m}from"../../chunks/Queue.js";import{watch as u,whenOnce as h,sync as y}from"../../core/reactiveUtils.js";import{property as w}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{i as g}from"../../chunks/editableLayers.js";import{b as k,c as j,q as b}from"../../chunks/layerUtils.js";import{h as v}from"../../chunks/layerViewUtils.js";import S from"./CreateFeaturesWorkflow.js";import{s as F,i as M}from"../../chunks/featureFlags.js";import C from"../../core/Accessor.js";import{Edits as U}from"./Edits.js";import{f as _,w as I,j as E,k as W,g as A,l as D,i as P,d as V,m as L}from"../../chunks/workflowUtils.js";import x from"./Workflow.js";import R from"./UpdateWorkflowData.js";import{i as T}from"../../chunks/featureUtils.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../core/lang.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/get.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObjectPool.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../config.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/infoFor3D.js";import"../../chunks/uuid.js";import"../../chunks/helpMessageUtils.js";import"../../chunks/centroid2.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./CreateFeaturesWorkflowData.js";import"../../chunks/asyncUtils.js";import"../../chunks/diffUtils.js";import"../../chunks/drapedUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../symbols/support/jsonUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils7.js";import"../../chunks/assets.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/previewUtils.js";import"../../chunks/renderUtils.js";import"../../chunks/colorUtils2.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/previewSymbol3D.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/hitTestSelectUtils.js";import"../../core/HandleOwner.js";import"../../chunks/WatchUpdatingTracking.js";var H;let O=H=class extends C{constructor(t){super(t),this.attachmentsCapabilities=null,this.editableItem=null,this.edits=null,this.formTemplate=null,this.viewModel=null}static async create(t){const e=H._makeConstructorProps(t);return new H(e)}static _makeConstructorProps(t){const{feature:e,viewModel:i}=t,s=i.editableItems.find((t=>t.layer===e.layer));if(!s)throw new o("no-editableItem-found","The EditorViewModel provided did not have an EditableItem associated with the specified Graphic's layer");const r=_(i.layerInfos,e.sourceLayer),a=s.supports,n=a.includes("create"),l=a.includes("update");return{attachmentsCapabilities:{editing:!0,operations:{add:n||l,update:l,delete:l}},editableItem:s,edits:new U({feature:e}),formTemplate:r?.formTemplate,viewModel:i}}};t([w()],O.prototype,"attachmentsCapabilities",void 0),t([w()],O.prototype,"editableItem",void 0),t([w()],O.prototype,"edits",void 0),t([w()],O.prototype,"formTemplate",void 0),t([w()],O.prototype,"viewModel",void 0),O=H=t([f("esri.widgets.Editor.UpdateRecordWorkflowData")],O);const G=O;var B;let N=B=class extends G{constructor(t){super(t)}static async create(t){const{feature:e,viewModel:i}=t,{view:s}=i;if(!s)throw new o("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const r=await I(s,e.layer);return new B({...B._makeConstructorProps(t),layerView:r})}};t([w()],N.prototype,"layerView",void 0),N=B=t([f("esri.widgets.Editor.UpdateFeatureWorkflowData")],N);const z=N;var q;const Q={exit:Symbol()};let J=q=class extends x{constructor(t){super(t),this.fullFeature=null,this.type="update-table-record"}async initialize(){const{data:t}=this,{edits:e}=t,s=e.feature,r=new AbortController;this.addHandles(i(r)),this.updatingHandles.addPromise(E(s,t.viewModel.view.spatialReference,r.signal).then((t=>{n(r)||this._onFullFeatureLoaded(t)}),(t=>this.cancel({force:!0,error:new o("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:t}})}))))}get editableItem(){return this.data.editableItem}get hasPendingEdits(){return this.data.edits.modified}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get updating(){return this.updatingHandles.updating}get reliesOnOwnerAdminPrivileges(){const{layer:t}=this.editableItem,e=t.capabilities?.operations.supportsUpdate,o=k(t)?.operations.supportsUpdate;return j(t)&&!t.editingEnabled||!!o&&!e}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel(),this._configureFeatureFormViewModel()}exit(t){this.removeHandles(Q.exit)}_configureAttachmentsViewModel(){const{data:t,fullFeature:e}=this,{attachmentsCapabilities:o,viewModel:i}=t,{attachmentsViewModel:s}=i;s.set({capabilities:o,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles(u((()=>s.mode),(t=>{switch(t){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})),Q.exit)}_configureFeatureFormViewModel(){const{edits:t,formTemplate:e,viewModel:{featureFormViewModel:o,view:i}}=this.data;o.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,map:i?.map,spatialReference:i.spatialReference}),this.addHandles(o.on("value-change",(()=>{t.updateAttributes(o.getValues()),this.fullFeature.attributes=t.feature.attributes})),Q.exit)}_onFullFeatureLoaded(t){this.fullFeature=t;const{edits:e}=this.data;e.updateAttributes(t.attributes),e.trackChanges()}static async create(t){const e=new q({data:await G.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(t){const{attachmentsViewModel:e}=t.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};var K;J._onCommitFactory=t=>async e=>{const{edits:o}=e,{feature:i}=o;if(!i)return;const s=i.sourceLayer,r=i.clone();if(!o.attributesModified||o.stagedForDelete){const t=s.objectIdField;if(r.attributes={[t]:i.getAttribute(t)},F()&&M()&&"scene"===s.type&&null!=s.infoFor3D){const t=s.associatedLayer?.globalIdField;null!=t&&r.setAttribute(t,i.getAttribute(t))}}o.geometryModified&&!o.stagedForDelete||(r.geometry=null);const a=o.stagedForDelete?"deleteFeatures":"updateFeatures";await t(s,{[a]:[r]})},t([w()],J.prototype,"editableItem",null),t([w()],J.prototype,"fullFeature",void 0),t([w()],J.prototype,"hasPendingEdits",null),t([w()],J.prototype,"shouldShowAttachments",null),t([w()],J.prototype,"shouldAllowAttachmentEditing",null),t([w()],J.prototype,"updating",null),t([w()],J.prototype,"reliesOnOwnerAdminPrivileges",null),J=q=t([f("esri.widgets.Editor.UpdateRecordWorkflow")],J);const $={...Q,highlights:Symbol(),interactiveGraphics:Symbol(),geometryGraphics:Symbol()};let X=K=class extends J{constructor(t){super(t),this.type="update-feature",this._layerViewEditSession=null,this._webStyleCache=new Map}async initialize(){const{edits:{feature:t},layerView:e}=this.data;W(e)&&(this._layerViewEditSession=e.createInteractiveEditSession(t))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles($.interactiveGraphics);try{const t=this.data.edits.stagedForDelete;await super.commit(),this.removeHandles($.geometryGraphics);const e=this._layerViewEditSession;t?e?.rollback():e?.commit()}catch(t){throw this.removeHandles($.geometryGraphics),await this._configureSketchViewModel(),new o("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:t})}}async enter(){await super.enter(),this.data.editableItem.geometryUpdatesEnabled?this.hasHandles($.interactiveGraphics)||await this._configureSketchViewModel():this._configureHighlight()}exit(t={removeSketchHandles:!0}){super.exit(t),t.removeSketchHandles&&this.removeHandles([$.geometryGraphics,$.interactiveGraphics])}_configureFeatureFormViewModel(){super._configureFeatureFormViewModel();const{_layerViewEditSession:t}=this,{viewModel:e}=this.data;this.addHandles(e.featureFormViewModel.on("value-change",(e=>{t?.setAttribute(e.fieldName,e.value)})),$.exit)}_configureHighlight(){const{edits:t,layerView:e}=this.data;v(e)&&this.addHandles(e.highlight(t.feature),$.highlights)}async _configureSketchViewModel(){const{data:t,_layerViewEditSession:e}=this,{edits:o,viewModel:i}=t,s=o.feature,{featureFormViewModel:r,sketchViewModel:a,view:n}=i;a.allowDeleteKey=!1;const l=A(s),{interactive:p,visual:c}=await D(s,l,a,n,(({geometry:t,attributes:i},a)=>{if(o.updateAttributes(i),o.updateGeometry(t),r.feature.geometry=t,null!=l.rotation){const{field:t}=l.rotation;r.setValue(t,i[t])}if(null!=l.size){const{field:t}=l.size;r.setValue(t,i[t])}const{sourceLayer:n}=s;null!=n&&"scene"===n.type&&null!=n.infoFor3D&&F()&&M()&&e&&null!=t&&"mesh"===t.type&&e.setGeometry(t),("undo"===a.type||"redo"===a.type||"update"===a.type&&null!=a.toolEventInfo&&P(a.toolEventInfo.type))&&r.notifyFeatureGeometryChanged()}),this._webStyleCache);this.addHandles(p,$.interactiveGraphics),this.addHandles(c,$.geometryGraphics)}_onFullFeatureLoaded(t){super._onFullFeatureLoaded(t);const{edits:e}=this.data;e.updateGeometry(t.geometry),e.trackChanges()}static async create(t){const e=new K({data:await z.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}};var Y;t([w()],X.prototype,"_layerViewEditSession",void 0),X=K=t([f("esri.widgets.Editor.UpdateFeatureWorkflow")],X);const Z="candidate-highlight",tt="esri.widgets.Editor.UpdateWorkflow",et=r.getLogger(tt);let ot=Y=class extends x{constructor(t){super(t),this._workflowStack=new m((t=>{let e;for(e of t);return e})),this.type="update"}get activeEditableItem(){const{activeWorkflow:t}=this;return st(t)?t.data.editableItem:void 0}get activeWorkflow(){return this._workflowStack.last()}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return!!this.activeEditableItem?.supports.includes("update")}get hasPendingEdits(){return Array.from(this._workflowStack).some((t=>t.hasPendingEdits))}get helpMessage(){return"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditableItem?.hasInvalidFormTemplate}get hasUnsupportedFields(){return!!this.activeEditableItem?.hasUnsupportedFields}get updating(){return this.updatingHandles.updating}async back(t=(()=>Promise.resolve(!0))){const{featureFormViewModel:e}=this.data.viewModel;if(null==e.relationshipId)if(this.activeWorkflow){if(this.activeWorkflow.hasPendingEdits&&!await t())return;this.activeWorkflow.hasPreviousStep?await this.activeWorkflow.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.relationshipId=null}async cancelActiveWorkflow(t){await(this.activeWorkflow?.cancel(t)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((t=>t.commit())),await super.commit()}static create(t,e,o){const i=new Y({data:new R({applyEditsCallback:o,viewModel:t}),onCommit:async()=>{}});return i._set("steps",this._createWorkflowSteps(i,e)),i}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(t){try{const e=await this._createNestedCreateFeaturesWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new o("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(t){try{const e=await this._createNestedUpdateWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new o("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:t}=this;if(!t)throw new o("editor:nothing-to-delete","There is no feature to delete");st(t)?await t.deleteAndCommit():await t.cancel(),1===this.nestedWorkflowCount?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack((t=>t.cancel({force:!0})))}async _createNestedCreateFeaturesWorkflow(t){const{relatedLayer:i}=t,{addAttachmentsCallback:s,applyEditsCallback:r,viewModel:a}=this.data;if(!g(i))throw new o("editor:unsupported-layer","Editing is not supported on the provided layer");const n=new e({sourceLayer:i,attributes:this._makeRelatedRecordAttributes(t)});return S.create({addAttachmentsCallback:s,applyEditsCallback:r,creationInfo:{layer:i,initialFeature:n,maxFeatures:1},startAt:"creating-features",viewModel:a})}async _createNestedUpdateWorkflow(t){const e=b(t.sourceLayer)?J:X,{applyEditsCallback:o,viewModel:i}=this.data,s=await e.create({feature:t,viewModel:i,applyEdits:o});return await h((()=>!s.updating)),s}async _drainWorkflowStack(t){const e=this._workflowStack,o=[];for(;e.length>0;){const i=e.pop(),s=t(i).then((()=>i.destroy()));this.updatingHandles.addPromise(s),o.push(s)}await Promise.all(o)}_highlight(t){this._removeHighlight();const e=this.data.viewModel.view;if(!e||!t)return;const o=t&&e.allLayerViews.items.find((({layer:e})=>e===t.layer||"subtype-sublayer"===t.layer?.type&&t.layer?.parent===e));v(o)&&this.handles.add(o.highlight(t),Z)}_makeRelatedRecordAttributes(t){const{parentFeature:e,relatedLayer:o,relationshipId:i}=t;if(!T(e))return;const s=o.relationships?.find((t=>t.id===i));if(!s)return void it("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===s.role)return void it("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=e.sourceLayer;s.relatedTableId!==r.layerId&&it("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const a=r.relationships?.find((t=>t.id===i));if(!a)return void it("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=e.getAttribute(a.keyField);return n||it("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[s.keyField]:n}}async _popWorkflow(){this._workflowStack.pop()?.destroy();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new o("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(t){const e=this._workflowRequiresSketchViewModel(t);this.activeWorkflow?.exit({removeSketchHandles:e}),await t.start(),this._workflowStack.push(t);const i=await this._reconcileWorkflowStack();if(i.failureCount>0)throw new o("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",i)}async _reconcileWorkflowStack(){const t=this._workflowStack;try{const e=t.peek();return await(e?.enter()),{activeWorkflow:e,failureCount:0}}catch(e){t.pop().destroy();const{activeWorkflow:o,failureCount:i}=await this._reconcileWorkflowStack();return{activeWorkflow:o,failureCount:i+1}}}_removeHighlight(){this.handles.remove(Z)}_workflowRequiresSketchViewModel(t){const{type:e}=t;return"update-features"===e||"create-features"===e&&!b(t.data.creationInfo?.layer)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:i,handles:r}=t;return V(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:e}=i.viewModel,o=i.viewModel.view;let n=null;r.add(s((()=>{n=a(n)})),this.id),i.rootFeature=null,i.candidates=[];const d=o.on("immediate-click",(async s=>{e.location=s.mapPoint,e.visible=!0,n?.abort();const{editableItems:r}=i.viewModel;n=new AbortController;const a=await new Promise(((t,e)=>{l(n?.signal,(()=>e(p()))),t(L(r,o,s,n?.signal))}));c(n),i.candidates=a.reduce(((t,e)=>e.error?t:[...t,...e.value]),[]),e.visible=1===i.candidates.length,0!==i.candidates.length&&(1===i.candidates.length?(i.rootFeature=i.candidates[0],t.go("editing-existing-feature").catch((()=>{})).then((()=>e.visible=!1))):t.next())}));o.focus(),r.add(d,this.id)},async tearDown(){r.remove(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){i.rootFeature=null,r.add([u((()=>i.rootFeature),(e=>t._highlight(e)),y),s((()=>t._removeHighlight()))],this.id)},async tearDown(){r.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:e,viewModel:a}=t.data;if(!e)throw new o("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await t.startUpdating(e),a.spinnerViewModel.visible=!1;const n=d((async()=>{await h((()=>!t.updating)),t.previous()})),{featureFormViewModel:l}=i.viewModel,p=l.relatedRecordCallbacks;l.relatedRecordCallbacks={addRelatedRecord:async e=>{await t.startCreatingRelatedRecord(e),l.relationshipId=null},editRelatedRecord:async({relatedFeature:e})=>{await t.startUpdating(e),l.relationshipId=null},showAllRelatedRecords:t=>l.relationshipId=t.relationshipId},r.add([s((()=>l.relatedRecordCallbacks=p)),u((()=>t.nestedWorkflowCount),((t,e)=>{0===t&&0!==e&&n()}),y)],this.id)},async tearDown(){await t.cancelAll(),r.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})})}};t([w()],ot.prototype,"activeEditableItem",null),t([w()],ot.prototype,"activeWorkflow",null),t([w()],ot.prototype,"nestedWorkflowCount",null),t([w()],ot.prototype,"shouldShowAttachments",null),t([w()],ot.prototype,"shouldAllowAttachmentEditing",null),t([w()],ot.prototype,"hasPendingEdits",null),t([w()],ot.prototype,"helpMessage",null),t([w()],ot.prototype,"reliesOnOwnerAdminPrivileges",null),t([w()],ot.prototype,"hasInvalidFormTemplate",null),t([w()],ot.prototype,"hasUnsupportedFields",null),t([w()],ot.prototype,"updating",null),ot=Y=t([f(tt)],ot);const it=(t,e)=>et.warn(`editor:${t}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),st=t=>!!t&&/update-/.test(t.type),rt=ot;export{rt as default};

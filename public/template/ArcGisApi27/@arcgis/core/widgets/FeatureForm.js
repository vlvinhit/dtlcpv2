/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{substitute as t}from"../intl.js";import{i as s}from"../chunks/typedArrayUtil.js";import{n as i}from"../chunks/compilerUtils.js";import{d as r}from"../chunks/deprecate.js";import{L as o}from"../chunks/Logger.js";import{watch as n}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import p,{l as u}from"./Widget.js";import{i as m,a as d,b as c,c as h,d as j,f as b,g as y,e as g,h as f}from"../chunks/featureFormUtils.js";import v from"./FeatureForm/FeatureFormViewModel.js";import{H as _,i as I}from"../chunks/Heading.js";import"../chunks/widgetUtils.js";import{m as k}from"../chunks/messageBundle.js";import{v as F}from"../chunks/vmEvent.js";import{t as R}from"../chunks/jsxFactory.js";import{D as w}from"../chunks/datetime.js";import{g as C}from"../chunks/locale.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../core/lang.js";import"../chunks/number.js";import"../chunks/maybe.js";import"../chunks/string.js";import"../chunks/messages.js";import"../core/Error.js";import"../config.js";import"../core/promiseUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/utils.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"../chunks/ObjectPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/PooledArray.js";import"../chunks/get.js";import"../chunks/tracking.js";import"../chunks/metadata.js";import"../chunks/domUtils.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/ObservableBase.js";import"../core/Promise.js";import"../chunks/uuid.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/projector.js";import"../chunks/dom.js";import"../chunks/guid.js";import"../chunks/index.js";import"../chunks/jsxWidgetSupport.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../core/HandleOwner.js";import"../chunks/WatchUpdatingTracking.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../form/elements/RelationshipElement.js";import"../chunks/editableLayers.js";import"../chunks/infoFor3D.js";import"../chunks/layerUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/Subtype.js";import"./FeatureForm/FieldInput.js";import"../chunks/featureUtils.js";import"./FeatureForm/EditableInput.js";import"./FeatureForm/InputBase.js";import"../arcade.js";import"../chunks/ArcadeDate.js";import"../chunks/executionError.js";import"../chunks/ImmutableArray.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../symbols/support/jsonUtils.js";import"../renderers/DictionaryRenderer.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../chunks/Version.js";import"../layers/support/FieldsIndex.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../chunks/vec4f64.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../chunks/featureFlags.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../core/sql.js";import"../layers/Layer.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../chunks/editsZScale.js";import"../chunks/queryZScale.js";import"../chunks/zscale.js";import"../rest/support/FeatureSet.js";import"../layers/support/Field.js";import"../chunks/fieldType.js";import"../layers/mixins/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../layers/mixins/CustomParametersMixin.js";import"../chunks/EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../chunks/FullTextSearch.js";import"../chunks/QuantizationParameters.js";import"../rest/support/StatisticDefinition.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"../chunks/commonProperties2.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/TimeReference.js";import"../chunks/featureLayerUtils.js";import"../rest/support/AttachmentQuery.js";import"../rest/support/RelationshipQuery.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../chunks/serviceCapabilitiesUtils.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"../chunks/FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../chunks/clusterUtils.js";import"../chunks/MD5.js";import"../chunks/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"../chunks/asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../chunks/labelingInfo.js";import"../chunks/versionUtils.js";import"../chunks/styleUtils2.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../support/popupUtils.js";import"./FeatureForm/GroupInput.js";import"./FeatureForm/RelationshipInput.js";import"../chunks/FeatureRelationshipViewModel.js";const D="esri-feature-form",M=`${D}__group`,V=`${D}__input`,x=`${D}__related-records`,L={base:D,form:`${D}__form`,formHeader:`${D}__form-header`,label:`${D}__label`,relationshipLabel:`${D}__relationship-label`,fieldInputWrapper:`${V}-wrapper`,fieldInputLoader:`${V}-loader`,fieldInput:`${V}`,inputDate:`${V}--date`,inputTime:`${V}--time`,inputRadioGroup:`${V}--radio-group`,inputRadio:`${V}--radio`,inputRadioLabel:`${V}--radio-label`,inputDisabled:`${V}--disabled`,inputSwitch:`${V}--switch`,inputInvalid:`${V}--invalid`,centeredButton:`${D}__centered-button`,description:`${D}__description-text`,listObserver:`${D}__list-observer`,relatedRecordsHeader:`${x}_header`,relatedRecordsList:`${x}_list`,dateInputContainer:`${D}__date-input-container`,group:M,groupLabel:`${M}-label`,groupHeader:`${M}-header`,groupTitle:`${M}-title`,groupToggleIcon:`${M}-toggle-icon`,groupCollapsed:`${M}--collapsed`,groupSequential:`${M}--sequential`,groupActive:`${M}--active`,collapseIcon:"esri-icon-up",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input"},S="data-field-name",T="latn",O=e=>"valueAsDate"in e,U="esri.widgets.FeatureForm",E=o.getLogger(U);let N=class extends p{constructor(e,t){super(e,t),this._dateFieldInputMap=new Map,this._activeInputName="",this._activeNumberFieldEdit=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedFieldInputNames=new Set,this._listObserverNode=null,this._listObserver=new IntersectionObserver((e=>{e.length&&e[0].isIntersecting&&this._incrementRelatedRecordPage()}),{root:window.document}),this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new v,this._onShowAllRelatedRecordsClick=e=>{const{feature:t,relatedRecordCallbacks:s}=this;t&&s?.showAllRelatedRecords&&s.showAllRelatedRecords({parentFeature:t,relationshipId:e})},this._onAddRelatedRecordsClick=(e,t)=>{const{feature:s,relatedRecordCallbacks:i}=this;s&&i?.addRelatedRecord&&i.addRelatedRecord({parentFeature:s,relatedLayer:t,relationshipId:e})},this._handleInputInput=e=>{this._commitInputValue(e.currentTarget)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this),this._afterDateInputCreateOrUpdate=this._afterDateInputCreateOrUpdate.bind(this)}initialize(){this.addHandles([n((()=>this.feature),(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e?.name||"",this._userUpdatedFieldInputNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._dateFieldInputMap.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedFieldInputNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})),n((()=>[this.viewModel.activeRelationshipInput,this._listObserverNode]),(()=>this._onObserverChange()))])}loadDependencies(){return u({button:()=>import("../chunks/calcite-button.js"),combobox:()=>import("../chunks/calcite-combobox.js"),"combobox-item":()=>import("../chunks/calcite-combobox-item.js"),"combobox-item-group":()=>import("../chunks/calcite-combobox-item-group.js"),icon:()=>import("../chunks/calcite-icon.js"),"input-date-picker":()=>import("../chunks/calcite-input-date-picker.js"),"input-message":()=>import("../chunks/calcite-input-message.js"),"input-time-picker":()=>import("../chunks/calcite-input-time-picker.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),loader:()=>import("../chunks/calcite-loader.js"),notice:()=>import("../chunks/calcite-notice.js"),progress:()=>import("../chunks/calcite-progress.js"),switch:()=>import("../chunks/calcite-switch.js")})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get relatedRecordCallbacks(){return this.viewModel.relatedRecordCallbacks}set relatedRecordCallbacks(e){this.viewModel.relatedRecordCallbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get view(){return r(E,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view}set view(e){r(E,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return R("div",{class:this.classes(L.base,L.widget,L.panel)},"ready"===e?this._renderForm():null)}_renderForm(){return R("form",{class:L.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this._renderHeader(),this._renderInputs())}_renderHeader(){const e=this.viewModel;if(!e.formHeaderVisible)return;const t=null!=e.formTitle&&R(_,{key:"title",level:this.headingLevel},e.formTitle),s=null!=e.formDescription&&R("p",{class:L.description,key:"description"},e.formDescription);return R("div",{class:L.formHeader},t,s)}_renderInputs(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(s).filter((e=>e.visible)).map(((e,t)=>m(e)?this._renderGroup(e,t):d(e)?this._renderLabeledField(e):c(e)?this._renderRelationshipInput(e):void 0))}_renderActiveRelationshipInput(e){return this._renderRelationshipInput(e)}_renderDescriptionOrEmpty(e,t){return null==e?null:R("div",{class:this.classes(L.description),id:t},e)}_renderGroup(e,t){const{formTemplate:s,disabled:i}=this,{description:r,inputs:o,label:n,state:a}=e,l=o.filter((e=>e.visible)),p=this.viewModel.findField(this._activeInputName),u=!(!p||p.group!==e),m=`${this.id}_group_${t}`,h=`${this.id}_group-label_${t}`,j=`${this.id}_group-description_${t}`,b=this._renderDescriptionOrEmpty(r,j),y="sequential"===this.groupDisplay,g=y?u:"expanded"===a,f=g?L.collapseIcon:L.expandIcon;return R("fieldset",{"aria-expanded":g.toString(),"aria-labelledby":h,"aria-describedby":r?j:"",class:this.classes(L.group,y?L.groupSequential:null,g?null:L.groupCollapsed,u?L.groupActive:null,i?L.inputDisabled:null),disabled:i,"data-group":e,id:m,key:t,onclick:this._handleGroupClick},R("button",{role:y?"presentation":void 0,class:L.groupHeader,type:"button",tabIndex:y?-1:0},R("div",{class:L.groupTitle},R(_,{class:L.groupLabel,id:h,level:null!=s&&s.title?I(this.headingLevel):this.headingLevel},n),b),y?null:R("span",{class:this.classes(f,L.groupToggleIcon)})),l.map((e=>d(e)?this._renderLabeledField(e):c(e)?this._renderRelationshipInput(e):void 0)))}_getFocusableInput(e,t){const s=this.viewModel.allFieldInputs,i="forward"===e?s:s.slice().reverse();let r;if(!t||c(t))r=0;else if(m(t)){const e=t.inputs.find(d);r=e?i.indexOf(e):0}else{let s;if(h(t)&&"collapsed"===t.group.state){const i=t.group.inputs.filter(d);s="forward"===e?i[i.length-1]:i[0]}else s=t;r=i.indexOf(s)+1}for(let e=r;e<i.length;e++){const t=i[e];if(t.visible&&d(t))return t}return null}_renderLabeledField(e){const{dataType:t,feature:s,label:i,layer:r}=e;return R("label",{key:`${r.id}-${s.uid}-${e.name}`,class:L.label},[i,"unsupported"!==t?this._renderFieldInput(e):this._renderUnsupportedField(e),this._renderAuxiliaryText(e)])}_renderFieldInput(e){const{dataType:t,domain:s,name:i,updating:r,value:o}=e,n=this.getCommonInputProps(e);if("coded-value"===s?.type){if(j(e.element,"switch")){const{element:t}=e;if(!(this._switchFieldsWithInitialIncompatibleValue.has(i)||null==o||t.input.onValue!==o&&t.input.offValue!==o))return this._renderSwitchFieldInput(e,n);this._switchFieldsWithInitialIncompatibleValue.add(i)}return"radio-buttons"===e.inputType?this._renderRadioButtonsFieldInput(e,s.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),n):this._renderSelectFieldInput(e,this._getFieldValueOptions(i,s),n)}if("datetime-picker"===e.inputType||"date"===t)return this._renderDateFieldInput(e,n);const a="number"===t?R("input",{type:"number",...n,value:null!=this._activeNumberFieldEdit&&this._activeNumberFieldEdit.fieldName===e.name?this._activeNumberFieldEdit.value:`${n.value}`}):"text-area"===e.inputType?R("textarea",{...n}):R("input",{type:"text",...n});return r?R("div",{key:`${n.key}-input-updating-wrapper`,class:L.fieldInputWrapper},a,R("div",{class:L.fieldInputLoader},R("calcite-progress",{type:"indeterminate"}))):a}_renderDateFieldInput(e,t){const{dateDataType:s,includeTime:i,label:r,name:o,valid:n,value:a}=e,{readOnly:l,required:p}=t;if("string"===s)return this._renderUnsupportedField(e,b(e.field,t.value));const{date:u,time:m}=this._formatValueForDateInputs(a),d=null!=t.max?this._formatValueForDateInputs(t.max):void 0,c=null!=t.min?this._formatValueForDateInputs(t.min):void 0,h=d?.date??void 0,j=c?.date??void 0,y={afterCreate:this._afterDateInputCreate,afterUpdate:this._afterDateInputCreateOrUpdate,"aria-invalid":!n,label:r,numberingSystem:T,overlayPositioning:"fixed",readOnly:l,required:p,tabIndex:0,[S]:o};return R("div",{key:`${t.key}-date-time-container`,class:L.dateInputContainer},R("calcite-input-date-picker",{bind:this,...y,class:this.classes(t.class,L.inputDate),"data-date-part":"date",key:`${t.key}-date-input`,valueAsDate:u??void 0,maxAsDate:h,minAsDate:j,onCalciteInputDatePickerChange:e=>this._commitDateChanges(e.target),onblur:e=>this._commitDateChanges(e.target,!0)}),i?R("calcite-input-time-picker",{bind:this,...y,class:this.classes(t.class,L.inputTime),"data-date-part":"time",key:`${t.key}-time-input`,value:m??void 0,step:1,onCalciteInputTimePickerChange:e=>this._commitDateChanges(e.target),onfocus:e=>{e.target.calciteTimePickerEl&&(e.target.calciteTimePickerEl.showSecond=!0)},onblur:e=>this._commitDateChanges(e.target,!0)}):null)}_renderUnsupportedField(e,t){const s=this.getCommonInputProps(e);return R("input",{afterCreate:s.afterCreate,afterUpdate:s.afterUpdate,class:this.classes(L.input,L.fieldInput,L.inputDisabled),onfocus:s.onfocus,readOnly:!0,tabIndex:s.tabIndex,type:"text",value:null!=t?`${t}`:s.value,[S]:s[S]})}_renderSelectFieldInput(e,t,s){const{element:i,required:r,value:o}=e,{messages:n,messagesTemplates:a}=this,l=t.map((e=>e.map((e=>R("calcite-combobox-item",{value:`${e.value}`,textLabel:e.name,key:`#${e.value}`,selected:o===e.value}))))),[p,u]=l;this._registerIncompatibleValue(o,t.flat(),e,(e=>{u.unshift(R("calcite-combobox-item",{value:`${e}`,textLabel:`${e}`,key:"incompatible-option",readOnly:!0}))}));const m=u.length>0?[R("calcite-combobox-item-group",{key:"recommended",label:n.recommended},p),R("calcite-combobox-item-group",{key:"other",label:a.other},u)]:p,d=null==i,c=j(i,"combo-box"),h=d||c&&i.input?.showNoValueOption;if(!r&&h){const e="",t=c&&i.input.noValueOptionLabel||n.empty;m.unshift(R("calcite-combobox-item",{value:e,textLabel:n.empty,key:"empty-option"},t))}return R("calcite-combobox",{...s,selectionMode:"single",disabled:s.readOnly,allowCustomValues:!1,clearDisabled:!0,onCalciteComboboxChange:e=>this._handleOptionChange(e.target)},m)}_registerIncompatibleValue(e,t,s,i){const r=this._fieldToInitialIncompatibleDomainValue,o=r.has(s.name);(o||null!=e&&""!==e&&!t.some((t=>t.value===e)))&&(o||r.set(s.name,e),i?.(e))}_renderRadioButtonsFieldInput(e,t,s){const{element:i,name:r,required:o,value:n}=e,a=t.map((e=>this._renderRadioButton({key:e.name,label:e.name,name:r,value:e.value,selected:e.value===n,props:s})));this._registerIncompatibleValue(n,t,e);const l=null==i,p=j(i,"radio-buttons"),u=l||p&&i.input?.showNoValueOption;if(!o&&u){const e="",t=p&&i.input.noValueOptionLabel||this.messages.empty,o=n===e||null===n;a.unshift(this._renderRadioButton({key:"empty-option",label:t,name:r,value:e,selected:o,props:s}))}return R("div",{key:`${s.key}-radio`,class:L.inputRadioGroup},a)}_renderSwitchFieldInput(e,t){const{value:s}=e,i=!!j(e.element,"switch")&&s===e.element.input.onValue;return R("calcite-switch",{...t,class:L.inputSwitch,onCalciteSwitchChange:e=>this._commitInputValue(e.target),checked:i,disabled:t.readOnly})}_renderRadioButton({key:e,name:t,value:s,selected:i,label:r,props:o}){return R("label",{key:e,class:L.inputRadioLabel},R("input",{...o,class:L.inputRadio,name:t,type:"radio",value:s,checked:i,disabled:o.readOnly,onchange:e=>this._commitInputValue(e.target)}),r)}_renderAuxiliaryText(e){const t=this._userUpdatedFieldInputNames.has(e.name)&&!e.valid?y(e,this.messages):null!=this.viewModel.contingencyConstraintViolations.get(e.name)?this.messages.validationErrors.valuesIncompatible:null!=e.valueExpressionExecutor&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return null!=t?R("calcite-input-message",{status:"invalid",icon:!0},t):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){const{featureCount:s,relationshipId:i,showAllActionVisible:r}=e,{relatedRecordCallbacks:o}=this;if(!r||!o?.showAllRelatedRecords)return;const n=this.messages;return R("calcite-list-item",{description:t(n.totalCount,{count:s}),label:n.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(i)},R("calcite-icon",{slot:"content-end",scale:"s",icon:"list"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:t,relationshipId:s,relatedLayer:i}=e,{relatedRecordCallbacks:r}=this;if(t&&r?.addRelatedRecord&&i)return R("calcite-button",{alignment:"center",appearance:"outline-fill",class:L.centeredButton,disabled:e.updating,iconStart:"plus",key:`${s}-add-button`,round:!0,scale:"s",width:"half",onclick:()=>this._onAddRelatedRecordsClick(s,i)},this.messages.addRecord)}_renderRelatedRecordListItem(e,t){const{feature:s,description:i,title:r}=e,{feature:o,relatedRecordCallbacks:n}=this;return R("calcite-list-item",{bind:this,description:i,label:r,key:`${t}-${s.uid}`,value:r,onclick:()=>{n?.editRelatedRecord&&o&&n.editRelatedRecord({parentFeature:o,relationshipId:t,relatedFeature:s})}},R("calcite-icon",{slot:"content-start",scale:"m",icon:g(s)}),R("calcite-icon",{slot:"content-end",scale:"s",icon:"chevron-right"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:t,relationshipId:s,showAllEnabled:i}=e,r=i?null:this._renderDescriptionOrEmpty(e.description),o=t>0?this._renderRelatedRecordsList(e):e.loaded?this._renderNoRelatedRecordsNotice():void 0;return R("label",{class:this.classes(L.label,L.relationshipLabel),key:`relationship-${s}-container`},R("div",null,this._renderRelatedRecordsHeaderContainer(e),r,o),this._renderAddRelatedRecordButton(e))}_renderRelatedRecordsHeaderContainer(e){const t=e.updating||!e.loaded;return R("div",{class:L.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},R("span",null,e.label),t?R("calcite-loader",{label:this.messagesCommon?.loading,inline:!0,key:"loader",scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:t}=e;return R("calcite-list",{class:L.relatedRecordsList},e.relatedFeatureInfos.map((e=>this._renderRelatedRecordListItem(e,t))),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoRelatedRecordsNotice(){return R("calcite-notice",{open:!0,scale:"s",kind:"brand",icon:"information",width:"full"},R("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return R("div",{key:"feature-observer",class:L.listObserver,bind:this,afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved})}getCommonInputProps(e){const{disabled:t,groupDisplay:s}=this,{dataType:i,editable:r,group:o,hint:n,label:a,maxLength:l,minLength:p,name:u,required:m,valid:d,value:c}=e,h=this._userUpdatedFieldInputNames.has(u),j=!r||t,b="all"===s&&null!=o&&"collapsed"===o.state;return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":d?"false":"true",class:this.classes(L.input,L.fieldInput,j?L.inputDisabled:null,h&&!d?L.inputInvalid:null),key:u,label:a,minlength:p>-1?`${p}`:"",maxlength:l>-1?`${l}`:"",...e.range,readOnly:j,value:null==c?"":`${c}`,[S]:u,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===i?this._handleNumberInputMouseDown:void 0,placeholder:"number"===i||"text"===i?n??void 0:"",required:m,tabIndex:b?-1:0}}_handleNumberInputMouseDown({target:e}){e.focus(),this.scheduleRender()}_getFieldValueOptions(e,t){const s=t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),i=this.viewModel.fieldsWithContingentValues.has(e)?this._getContingentValueOptions(e):[];if(i.length>0){const e=new Set(i.map((e=>e.value)));return[i,s.filter((t=>!e.has(t.value)))]}return[s,[]]}_getContingentValueOptions(e){const t={};for(const s of this.viewModel.allFieldInputs){const{name:i,value:r}=s;null!=r&&i!==e&&this.viewModel.fieldsWithContingentValues.has(i)&&(t[i]=r)}const s=this.viewModel.joinedContingentValues.slice(),i=new Map;for(const r of s){const s=r.values[e];if(null==s||"code"!==s.objectType&&"null"!==s.objectType)continue;const{code:o,name:n}=s.codedValue&&"null"!==s.objectType?s.codedValue:{code:"",name:this.messages.empty};i.has(o)||Object.entries(t).every((([e,t])=>!r.values.hasOwnProperty(e)||this._valueIsValidContingentValue(t,r.values[e])))&&i.set(o,{name:n,value:o})}return[...i.values()]}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(S))}async _afterDateInputCreate(e){this._afterDateInputCreateOrUpdate(e)}_afterDateInputCreateOrUpdate(e){const{name:t}=this._getFieldInputFromHTMLElement(e),s=this._dateFieldInputMap.get(t),i=O(e);null!=s?i?s.date=e:s.time=e:this._dateFieldInputMap.set(t,{[i?"date":"time"]:e}),this._afterInputCreateOrUpdate(e)}_afterInputCreateOrUpdate(e){const{viewModel:t}=this,s=this._getFieldInputFromHTMLElement(e),i=t.findField(this._activeInputName),r=this._fieldToInitialIncompatibleDomainValue.get(s.name)===s.value;this._fieldFocusNeeded&&i===s&&("radio-buttons"!==s.inputType||r||e.checked)&&(this._fieldFocusNeeded=!1,h(s)&&(s.group.state="expanded"),e.focus())}_handleInputFocus(e){const t=e.target,s=this._getFieldInputFromHTMLElement(t);this._activeInputName=s.name,f(s)&&(this._activeNumberFieldEdit={fieldName:s.name,input:t,value:t.value})}_handleInputBlur(e){const t=e.target,s=this._getFieldInputFromHTMLElement(t);"number"===s.dataType&&null!=this._activeNumberFieldEdit&&(this._activeNumberFieldEdit.input.value=`${s.value}`,this._activeNumberFieldEdit=null),this._commitInputValue(t),this.scheduleRender()}_commitDateChanges(e,t=!1){const{name:s}=this._getFieldInputFromHTMLElement(e);if(!this._dateFieldInputMap.has(s))return;const i=this._dateFieldInputMap.get(s);if(!i||!i.date)return;const r=this._getFieldValueFromDateInput(e),o=this._getFieldValueFromDateInputs(i.date,i.time);this.viewModel.getValue(s)!==o&&(null!==r&&null!==o?this._updateFieldValue(s,o):t&&this._updateFieldValue(s,null))}_commitInputValue(e){const t=this._getFieldInputFromHTMLElement(e);null!=this._activeNumberFieldEdit&&f(t)&&(this._activeNumberFieldEdit.value=e.value),this._updateFieldValue(t.name,this._parseValue(e))}_handleInputKeyDown(e){const{key:t,altKey:s,ctrlKey:i,metaKey:r}=e,o=this._getFieldInputFromHTMLElement(e.target);if("Enter"===t)h(o)&&"collapsed"===o.group.state&&(o.group.state="expanded");else{const{type:n}=o.field,a="single"===n||"double"===n;if(("integer"===n||"small-integer"===n||a)&&!s&&!i&&!r&&1===t.length){const s=Number(t),i=["-","+"],r=["e","."],o=a?[...i,...r]:i;isNaN(s)&&!o.includes(t)&&e.preventDefault()}}}_updateFieldValue(e,t){if(this.viewModel.setValue(e,t),this._userUpdatedFieldInputNames.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const e=Object.fromEntries(Object.entries(this.getValues()).filter((([e,t])=>null!=t)));this.viewModel.validateContingencyConstraints(e)}}_parseValue(e){const t=this._getFieldInputFromHTMLElement(e),s=e.value;if(j(t.element,"switch")&&"CALCITE-COMBOBOX"!==e.tagName)return e.checked?t.element.input.onValue:t.element.input.offValue;if("radio-buttons"===t.inputType&&"radio"===e.type&&!e.checked)return t.value;const{dataType:i}=t;return"number"===i?s?parseFloat(s):null:s}_handleOptionChange(e){this._commitInputValue(e),this.scheduleRender()}_handleGroupClick(e){const t=e.currentTarget["data-group"],s="expanded"===t.state,i="sequential"===this.groupDisplay,r=`.${L.groupHeader}`;if(!s||e.target.closest(r)){if(this._activeInputName=this._getFocusableInput("forward",t)?.name||"",i){const i=e.target.closest(r);if(s&&!i)return;this.viewModel.inputs.forEach((e=>{m(e)&&e!==t&&(e.state="collapsed")}))}t.state=s?"collapsed":"expanded",this._fieldFocusNeeded=i,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_getDefaultLocaleOptions(){return{locale:C(),numberingSystem:T}}_getFieldValueFromDateInputs(e,t){const s=this._getDateTimeFromInput(e),i=this._getDateTimeFromInput(t);if(!s&&!i)return null;const r=this._getFieldInputFromHTMLElement(e).range,o=Date.now(),n=null!=r.max&&r.max<o?r.max:o,a=w.fromMillis(n,this._getDefaultLocaleOptions()),l=s||a,{year:p,month:u,day:m}=l,{hour:d,minute:c,second:h}=i||a,j=l.set({year:p,month:u,day:m,hour:d,minute:c,second:h});return j.isValid?j.toMillis():null}_getDateTimeFromInput(e){if(!e)return null;let t=null;if(O(e)){const s=e.valueAsDate;if(!s||Array.isArray(s))return null;t=w.fromJSDate(s)}else{if(!e.value)return null;t=w.fromFormat(e.value,"TT",this._getDefaultLocaleOptions())}return t??null}_getFieldValueFromDateInput(e){return this._dateTimeToFieldValue(this._getDateTimeFromInput(e))}_dateTimeToFieldValue(e){return e?.isValid?e.toMillis():null}_dateTimeFromFieldValue(e){return null===e?null:w.fromMillis(e,this._getDefaultLocaleOptions())}_formatValueForDateInputs(e){if(null==e||isNaN(e))return{date:null,time:null};const t=this._dateTimeFromFieldValue(e);return t?{date:t.toJSDate(),time:t.toFormat("TT",this._getDefaultLocaleOptions())}:{date:null,time:null}}_valueIsValidContingentValue(e,t){switch(t.objectType){case"any":return!0;case"null":return null==e;case"code":return e===t.codedValue?.code;case"range":return null!=e&&null!=t.minValue&&null!=t.maxValue&&+e>=t.minValue&&+e<=t.maxValue;default:return i(t.objectType),!1}}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}async _onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;if(!e)return;const{showAllEnabled:t,updating:s}=e;this._listObserverNode&&!s&&t&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){const e=this.viewModel.activeRelationshipInput;e?.incrementPage()}};e([a()],N.prototype,"_listObserverNode",void 0),e([a()],N.prototype,"_relatedRecordsEnabled",null),e([a()],N.prototype,"disabled",null),e([a()],N.prototype,"feature",null),e([a()],N.prototype,"formTemplate",null),e([a()],N.prototype,"groupDisplay",void 0),e([a()],N.prototype,"headingLevel",void 0),e([a()],N.prototype,"label",null),e([a()],N.prototype,"layer",null),e([a()],N.prototype,"map",null),e([a(),k("esri/widgets/FeatureForm/t9n/FeatureForm")],N.prototype,"messages",void 0),e([a(),k("esri/t9n/common")],N.prototype,"messagesCommon",void 0),e([a(),k("esri/widgets/Feature/t9n/Feature")],N.prototype,"messagesFeature",void 0),e([a(),k("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],N.prototype,"messagesTemplates",void 0),e([a()],N.prototype,"relatedRecordCallbacks",null),e([a()],N.prototype,"relationshipId",null),e([a()],N.prototype,"spatialReference",null),e([a()],N.prototype,"strict",null),e([a()],N.prototype,"view",null),e([a(),F(["value-change","submit"])],N.prototype,"viewModel",void 0),N=e([l(U)],N);const $=N;export{$ as default};

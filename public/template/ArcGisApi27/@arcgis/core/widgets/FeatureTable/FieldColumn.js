/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{watch as e}from"../../core/reactiveUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import{f as o,c as r}from"../../chunks/date.js";import{c as s,f as a}from"../../chunks/number.js";import l from"../../layers/support/CodedValueDomain.js";import{i as u}from"../../chunks/editableLayers.js";import{isNumericField as p,isStringField as d}from"../../layers/support/fieldUtils.js";import{b as c}from"../../chunks/layerUtils.js";import{u as m,f as h}from"../../chunks/featureFormUtils.js";import f from"../FeatureForm/FieldInput.js";import g from"./Grid/EditorColumn.js";import j from"../support/DatePicker.js";import y from"../support/TimePicker.js";import{r as k}from"../../chunks/widgetUtils.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../core/lang.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/maybe.js";import"../../chunks/utils.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../chunks/ObjectPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/PooledArray.js";import"../../chunks/get.js";import"../../chunks/tracking.js";import"../../chunks/metadata.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/enumeration.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../layers/support/Domain.js";import"../../chunks/infoFor3D.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../request.js";import"../../intl.js";import"../../chunks/messages.js";import"../../chunks/assets.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/featureUtils.js";import"../../popup/support/FieldInfoFormat.js";import"../../core/Clonable.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../../core/HandleOwner.js";import"../../chunks/WatchUpdatingTracking.js";import"./Grid/Column.js";import"../../core/Evented.js";import"./Grid/support/ButtonMenu.js";import"../Widget.js";import"../../chunks/domUtils.js";import"../../core/Promise.js";import"../../chunks/uuid.js";import"../../chunks/projector.js";import"../../chunks/dom.js";import"../../chunks/guid.js";import"../../chunks/index.js";import"../../chunks/jsxWidgetSupport.js";import"./Grid/support/ButtonMenuViewModel.js";import"./Grid/support/ButtonMenuItem.js";import"../../chunks/Popover.js";import"../../chunks/jsxFactory.js";import"../../chunks/uriUtils.js";import"../support/DatePickerViewModel.js";import"../support/DateTimeElementViewModel.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../support/TimePickerViewModel.js";const b="esri-field-column",v={headerContent:`${b}__header-content`,headerLabel:`${b}__header-label`,input:`${b}__cell-input`,inputContainer:`${b}__cell__input-container`,dateInputContainer:`${b}__cell__date-input-container`,dateInputWrapper:`${b}__cell__date-input-wrapper`,button:`${b}__button`,saveIcon:"esri-icon-save",trashIcon:"esri-icon-trash",locked:"esri-icon-locked"},F=r("short-date-short-time"),_=r("short-date"),C={useGrouping:!0,maximumFractionDigits:20};let E=class extends g{constructor(t){super(t),this._inputField=null,this.cellValueFormatFunction=({rowData:t,value:e})=>{if(this.formatFunction){const{config:t,field:n}=this;return this.formatFunction({config:t,field:n,value:k.sanitize(e)})}if(null===e)return"&nbsp;";const{config:n,field:i}=this,r=t?.item?.feature,l=this._getDomainForFeature(r);if(l)return this._getComputedDomain(e,l);if("date"===i.type){const t=this._getDateFormatOptions(),n="feature"===this.layer?.type&&this.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null;return e?o(e,{...t,...n}):null}if(m.has(i.type)&&e){const t=h(i,e);return k.sanitize(t)}if(p(i)){const t=n?.format?s(n.format):C;return a(parseFloat(e),t)}return k.sanitize(e)},this.cellValueValidatorFunction=({oldValue:t,value:e})=>!(this._inputField&&!this._inputField.valid||this.required&&(null==e||""===e)||t===e),this.config=null,this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=t=>{const{root:e}=t,{editable:n,editingEnabled:i,headerMenuEnabled:o,sortable:r}=this;if(this.removeCellContent(e),e.classList.add(v.headerContent),i&&!n&&e.appendChild(this.createLockedElement()),r)this.headerSorterRenderFunction(t);else{const t=document.createElement("div");t.classList.add(v.headerLabel),t.textContent=this.label,e.appendChild(t)}o&&this.headerMenuRenderFunction(t)},this.inputRenderFunction=({root:t,column:e,rowData:n})=>{if(this.activeEditInfo?.updating)return;if(!this.editable)return;const i=this.getCellValue(e,n),o=this.createInputElement({root:t,column:e,rowData:n,value:i});if(this._set("activeEditInfo",{column:e,input:o,root:t,rowData:n,updating:!0,oldValue:i}),"date"===this.field.type)return void this._renderDateEditors(i,t,o);const r=this.createInputContainer();r.appendChild(o),this.removeCellContent(t),t.appendChild(r),o.focus(),o instanceof HTMLInputElement&&o.select(),this.grid?.notifyResize()},this.layer=null,this.parseInputValueFunction=({input:t})=>{const e=this._inputField;if(!e)return null;const n=t.value,{dataType:i,required:o}=e;return o||""!==n?"number"===i||"date"===i?parseFloat(n):"text"===i?n.trim():n:null},this.store=null,this.template=null,this.updateRowItemFunction=({rowData:t,column:e,value:n})=>{t&&(t.item.feature.attributes[e.path]=n)},this.updateStoreItemFunction=async({rowData:t,column:e,value:n})=>{if(!t||!this.store)return;const i=t.item.objectId,o=this.store.getObjectIdIndex(i)??t.index;await this.store.updateItem({index:o,name:e.path,value:n})}}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.config?.description??this.field?.description??null}get editable(){const{config:t,editingEnabled:e,field:n,layer:i,template:o}=this;if(null==n||null==i)return!1;const r=u(i),s=c(i),a=s?.operations.supportsUpdate;return!(!(n.editable&&r&&a)||m.has(n.type)||(e?!1===o?.editable||!1===t?.editable:!o?.editable&&!t?.editable))}get header(){return this.template?.label||this.config?.label||this.alias||this.path||null}get hidden(){const{config:t}=this;return!1===t?.visible||this._get("hidden")||!1}set hidden(t){this._set("hidden",t)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:t,config:e,template:n}=this,i=t?.length,o=n?.input&&"maxLength"in n.input?n.input.maxLength:e?.maxLength;return null!=o&&!isNaN(o)&&o>=-1&&(-1===i||o<=i)?o:i}get minLength(){const{config:t,template:e,maxLength:n}=this,i=e?.input&&"minLength"in e.input?e.input.minLength:t?.minLength||null;return n&&i<=n?i:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){const{config:t,field:e,template:n}=this,i=e?.nullable,o=t?.required,r=n?.required;return this.editable&&(!i||!0===o||!0===r)}get sortable(){return this.template?!1!==this.template?.sortable:!1!==this.config?.sortable}createInputElement({rowData:t,value:e}){const n=t?.item;if(!n||!n.feature)return null;this._inputField=this._setUpInputField(n.feature,e);const{field:i,maxLength:o,minLength:r,required:s}=this,{domain:a}=this._inputField;let l;"coded-value"===a?.type?(l=this._createSelectElement(e,a.codedValues.map((({code:t,name:e})=>({value:t,name:e}))),this._inputField),l.onchange=()=>{l.onblur=null,d()}):(l=document.createElement("input"),l.type=p(i)?"number":"text",o>-1&&(l.maxLength=o),r>0&&(l.minLength=r)),l.classList.add(v.input),l.value=e,l.required=s;let u=!1;l.onkeydown=t=>{u="Escape"===t.key},l.onblur=()=>{l.onblur=null,d()};const d=()=>{u?this.cancel():this.submit(),this._inputField=null};return l}createInputContainer(){const t=document.createElement("div");return t.classList.add(v.inputContainer),t}createLockedElement(){const t=document.createElement("div");return t.classList.add(v.locked),t}getCellValue({path:t},e){return e?.item?.feature?.attributes?.[t]??null}_renderDateEditors(t,n,i){const{config:o,messagesCommon:r,template:s}=this,a=t?new Date(t):new Date(Date.now()),l=new j({dateInputEnabled:!0,value:a}),u=new y({value:a});i.value=a.getTime().toString();let p=!t;const d=()=>{p=!0;const t=this._getCombinedDateTime(l.value,u.value);i.value=t.getTime().toString()},c=()=>{p?this.submit():this.cancel()},m=()=>{i.value=null,this.submit()};e((()=>[l.value,u.value]),(()=>d()));const h=document.createElement("div"),f=document.createElement("div");l.container=h,u.container=f;const g=document.createElement("button");g.classList.add(v.button,v.saveIcon),g.onclick=()=>c(),g.title=r?.save;const k=document.createElement("button");k.classList.add(v.button,v.trashIcon),k.onclick=()=>m(),k.title=r?.clear;const b=document.createElement("div");b.classList.add(v.dateInputWrapper),b.appendChild(h),(s&&s.input&&"datetime-picker"===s.input.type&&!1!==s.input.includeTime||o&&!1!==o.includeTime)&&b.appendChild(f);const F=document.createElement("div");F.classList.add(v.dateInputContainer),F.appendChild(b),F.appendChild(g),F.appendChild(k),l.when((()=>{const t=l._inputOrButtonNode;t&&(t.onblur=t=>{const e=t.relatedTarget;e&&e.className.includes("esri-date-picker")||l.close(!1)}),this.grid?.notifyResize()})),u.when((()=>this.grid?.notifyResize())),this.removeCellContent(n),n.appendChild(F),this.grid?.notifyResize()}_createSelectElement(t,e,n){let i=!1;const o=e.map((e=>{e.value===t&&(i=!0);const n=document.createElement("option");return n.text=e.name,n.value=e.value,n}));if(null!=t&&""!==t&&!i){const e=document.createElement("option");e.text=t,e.value=t,o.unshift(e)}if(!n.required&&null==n.value){const t=document.createElement("option");t.value="",o.unshift(t)}const r=document.createElement("select");return o.forEach((t=>r.add(t))),r.value=t,r}_setUpInputField(t,e){const{field:n,layer:i}=this,o=new f({feature:t,initialFeature:t.clone(),field:n,layer:i});return o.set("value",e),o}_isDomainCompatible(t){const{field:e}=this;if(t&&"coded-value"===t.type){const n=typeof t.codedValues[0].code;if("string"===n&&d(e)||"number"===n&&p(e))return!0}return!(!t||"range"!==t.type||!p(e))}_getDomainForFeature(t){const{config:e,layer:n,name:i,template:o}=this;if(!n)return null;if("wfs"===n.type||"geojson"===n.type||"csv"===n.type)return null;if(o?.domain&&this._isDomainCompatible(o.domain))return o.domain;const{typeIdField:r}=n,s=r===i,a=this.field.domain;if(s&&!a)return new l({name:"__internal-type-based-coded-value-domain__",codedValues:n.types?.map((({id:t,name:e})=>({code:t,name:e})))});const u=r&&null!=i&&n.getFieldDomain(i,{feature:t})||a,p=e?.domain;return this._isDomainCompatible(p)?p:u}_getComputedDomain(t,e){if(!e)return null;if("range"===e.type)return t;if("coded-value"===e.type){const n=e.codedValues.filter((e=>e.hasOwnProperty("code")&&e.code===t));return n&&n.length?n[0].name:t}return null}_getCombinedDateTime(t,e){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())}_getDateFormatOptions(){const{config:t,template:e}=this,n=e?.format?.dateFormat||t?.format?.dateFormat;return n?r(n):e&&e.input&&"includeTime"in e.input==0||!1===t?.includeTime?_:F}};t([n({readOnly:!0})],E.prototype,"alias",null),t([n()],E.prototype,"cellValueFormatFunction",void 0),t([n()],E.prototype,"cellValueValidatorFunction",void 0),t([n()],E.prototype,"config",void 0),t([n({readOnly:!0})],E.prototype,"defaultValue",null),t([n({readOnly:!0})],E.prototype,"description",null),t([n({readOnly:!0})],E.prototype,"editable",null),t([n()],E.prototype,"editingEnabled",void 0),t([n()],E.prototype,"expressionInfos",void 0),t([n()],E.prototype,"field",void 0),t([n()],E.prototype,"formatFunction",void 0),t([n({readOnly:!0})],E.prototype,"header",null),t([n()],E.prototype,"hidden",null),t([n()],E.prototype,"headerRenderFunction",void 0),t([n()],E.prototype,"inputRenderFunction",void 0),t([n()],E.prototype,"layer",void 0),t([n({readOnly:!0})],E.prototype,"loadingMessage",null),t([n()],E.prototype,"maxLength",null),t([n()],E.prototype,"minLength",null),t([n({readOnly:!0})],E.prototype,"name",null),t([n({readOnly:!0})],E.prototype,"nullable",null),t([n()],E.prototype,"parseInputValueFunction",void 0),t([n({readOnly:!0})],E.prototype,"path",null),t([n({readOnly:!0})],E.prototype,"required",null),t([n()],E.prototype,"sortable",null),t([n()],E.prototype,"store",void 0),t([n()],E.prototype,"template",void 0),t([n()],E.prototype,"updateRowItemFunction",void 0),t([n()],E.prototype,"updateStoreItemFunction",void 0),E=t([i("esri.widgets.FeatureTable.FieldColumn")],E);const I=E;export{I as default};

// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../Graphic ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../rest/support/Query".split(" "),function(x,u,y,p,q,z,A,B,C,v,t){class w extends y{constructor(a){super(a);this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";this._removeGeometry=!1;this._overrideFields=null;this._forceIsTable=
!1;a.spatialReference&&(this.spatialReference=a.spatialReference);this._transparent=!0;this._maxProcessing=1E3;this._layer=a.layer;this._wset=null;!0===a.isTable&&(this._forceIsTable=!0);void 0!==a.outFields&&(this._overrideFields=a.outFields);void 0!==a.includeGeometry&&(this._removeGeometry=!1===a.includeGeometry)}_maxQueryRate(){return q.defaultMaxRecords}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),this;
await this._layer.load();this._initialiseFeatureSet();return this}get gdbVersion(){return""}_initialiseFeatureSet(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const a=[],c=[];for(const b of this.fields)if("oid"===b.type)a.push(b),c.push(b.name);else for(const d of this._overrideFields)if(d.toLowerCase()===
b.name.toLowerCase()){a.push(b);c.push(b.name);break}this.fields=a;this._overrideFields=c}this.objectIdField=this._layer.objectIdField;for(const a of this.fields)"global-id"===a.type&&(this.globalIdField=a.name);this._databaseType=q.FeatureServiceDatabaseType.Standardised;this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ;this.hasM=!0===this._layer?.capabilities?.data?.supportsM;"subtype-group"===this._layer.type?(this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,
this.typeIdField=this.types=null):("oriented-imagery"===this._layer.type?this.subtypes=this.subtypeField=null:(this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes),this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types)}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return q.IdState.InFeatureSet}_candidateIdTransform(a){return a}async _getSet(a){return null===this._wset?
(await this._ensureLoaded(),this._wset=a=await this._getFilteredSet("",null,null,null,a)):this._wset}_changeFeature(a){const c={};for(const b of this.fields)c[b.name]=a.attributes[b.name];return new x({geometry:!0===this._removeGeometry?null:a.geometry,attributes:c})}async _getFilteredSet(a,c,b,d,e){let h="",n=!1;null!==d&&(h=d.constructClause(),n=!0);if(this.isTable()&&c&&null!==a&&""!==a)return new p([],[],!0,null);d=new t;d.returnZ=this.hasZ;d.returnM=this.hasM;d.where=null===b?null===c?"1\x3d1":
"":z.toWhereClause(b,q.FeatureServiceDatabaseType.Standardised);d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;d.orderByFields=""!==h?h.split(","):null;d.geometry=null===c?null:c;d.returnGeometry=!0;d.relationParameter=this._makeRelationshipParam(a);a=await this._layer.queryFeatures(d);if(null===a)return new p([],[],n,null);this._checkCancelled(e);const r=[];a.features.forEach(m=>{const f=m.attributes[this._layer.objectIdField];r.push(f);this._featureCache[f]=
this._changeFeature(m)});return new p([],r,n,null)}_makeRelationshipEnum(a){if(a.includes("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a}_makeRelationshipParam(a){return a.includes("esriSpatialRelRelation")?
a.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const a=new t;a.where="1\x3d1";await this._ensureLoaded();if(this._layer.source&&this._layer.source.items){const b=[];this._layer.source.items.forEach(d=>{const e=d.attributes[this._layer.objectIdField];b.push(e);this._featureCache[e]=this._changeFeature(d)});return this._wset=new p([],b,!1,null)}a.returnZ=this.hasZ;a.returnM=this.hasM;const c=[];(await this._layer.queryFeatures(a)).features.forEach(b=>{const d=b.attributes[this._layer.objectIdField];
c.push(d);this._featureCache[d]=this._changeFeature(b)});return this._wset=new p([],c,!1,null)}async _getFeatures(a,c,b){const d=[];-1!==c&&void 0===this._featureCache[c]&&d.push(c);for(let e=a._lastFetchedIndex;e<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[e]]&&(a._known[e]!==c&&d.push(a._known[e]),d.length>b));e++);if(0===d.length)return"success";throw new u.FeatureSetError(u.FeatureSetErrorCodes.MissingFeatures);}async _refineSetBlock(a){return a}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(a){const c=
{};for(const b in a)c[b]=a[b];return c}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(a,c){var b=a.layerDefinition.objectIdField,d=a.layerDefinition.typeIdField??"",e=[];if(a.layerDefinition.types)for(var h of a.layerDefinition.types)e.push(C.fromJSON(h));let n=a.layerDefinition.geometryType;void 0===n&&(n=a.featureSet.geometryType||"");h=a.featureSet.features;
const r=c.toJSON();if(!b){var m=!1;for(var f of a.layerDefinition.fields)if("oid"===f.type||"esriFieldTypeOID"===f.type){b=f.name;m=!0;break}if(!1===m){b="FID";f=!0;for(m=0;f;){let k=!0;for(var l of a.layerDefinition.fields)if(l.name===b){k=!1;break}!0===k?f=!1:(m++,b="FID"+m.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:b,alias:b});l=[];for(f=0;f<h.length;f++)l.push({geometry:a.featureSet.features[f].geometry,attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):
{}}),l[f].attributes[b]=f;h=l}}l=[];for(var g of a.layerDefinition.fields)g instanceof v?l.push(g):l.push(v.fromJSON(g));(g=n)||(g="");switch(g){case "esriGeometryPoint":g="point";break;case "esriGeometryPolyline":g="polyline";break;case "esriGeometryPolygon":g="polygon";break;case "esriGeometryEnvelope":g="extent";break;case "esriGeometryMultipoint":g="multipoint";break;case "":case "esriGeometryNull":g="esriGeometryNull"}if("esriGeometryNull"!==g)for(const k of h)k.geometry&&!1===k.geometry instanceof
A&&(k.geometry.type=g,void 0===k.geometry.spatialReference&&(k.geometry.spatialReference=r));else for(const k of h)k.geometry&&(k.geometry=null);e={outFields:["*"],source:h,fields:l,hasZ:!0===a?.layerDefinition?.hasZ||!0===a?.featureSet?.hasZ,hasM:!0===a?.layerDefinition?.hasM||!0===a?.featureSet?.hasM,types:e,typeIdField:d,objectIdField:b,spatialReference:c};d="esriGeometryNull"===g||null===g;d||(e.geometryType=g);e=new B(e);a?.layerDefinition?.subtypeField&&a?.layerDefinition?.subtypes&&e.read({subtypes:a.layerDefinition.subtypes,
subtypeField:a.layerDefinition.subtypeField});return new w({layer:e,spatialReference:c,isTable:d})}async queryAttachments(){return[]}async getFeatureByObjectId(a){const c=new t;c.where=this.objectIdField+"\x3d"+a.toString();c.returnZ=this.hasZ;c.returnM=this.hasM;a=await this._layer.queryFeatures(c);return 1===a.features.length?a.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??
null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo}get timeInfo(){return this._layer?.timeInfo}async getFeatureSetInfo(){const a=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:a?this._layer.id??null:null,webMapLayerTitle:a?this._layer.title??null:null,className:null,objectClassId:null}}}return w});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/has ../../../core/Logger ../../../core/mathUtils ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../chunks/vec32 ../../../geometry/Point ../../../geometry/projection ../../../geometry/support/ray ../../../chunks/sphere ../../../geometry/support/webMercatorUtils ../core/coverageUtils ../core/ExposurePoint ./groundToImageUtils ./utils ../../../widgets/PanoramicViewer/constants ../../../widgets/support/dataUtils ../../../geometry/Polygon ../../../geometry/SpatialReference".split(" "),
function(K,fa,ha,ia,L,y,z,p,J,M,N,x,O,P,E,q,U,Q,R,V){async function W(a,b,c,d,e,l,f){b=new p(b);b.spatialReference.isGeographic&&b.spatialReference.isWGS84&&4!==f?.type&&(b=x.geographicToWebMercator(b));f=q.getWebMercatorScalingFactor(b);const g=[],[k,t,v]=b.toArray();c=N.fromCenterAndRadius([k,t,v??0],c*f);const w=U.defaultImageSphereCenter.toArray();for(const m of a){var h=void 0;Q.isNumber(m.heading)&&Q.isNumber(m.pitch)?(a=m.heading,h=m.pitch):(h=q.convertPixelToHeadingPitch({x:m.x,y:m.y},d[0],
d[1]),a=h.heading,h=h.pitch);a=(a+e)%360;a=M.fromPoints([w[0],w[1],w[2]],q.convertHeadingPitchToSphereVertex(a,h));var n=M.fromValues([k,t,v??0],a.direction);h=y.create();N.intersectRay(c,n,h);n=(b.z??0)-l;h[2]<n?q.scaleAndAddWithFactor([b.x,b.y,b.z],a.direction,Math.abs((b.z-n)/-a.direction[2])*f,f,h):h[2]=n;g.push(new p(h,b.spatialReference))}return g}async function X(a,b){const {feature:c,footprintExtent:d,options:e}=b,{attributes:{cameraHeight:l,cameraOrientation:f,cameraPitch:g,cameraRoll:k,
elevationSource:t,horizontalFieldOfView:v,location:w,verticalFieldOfView:h},elevationSample:n}=c,m=q.hasCameraOrientationLTP(f),{vfov:r}=q.computeHFOVAndVFOV(v,h,k??0);let u=new p(w),F=!1;m&&(u=new p(q.ltpToGeographic(u,[f.latitude,f.longitude,f.ellipsoidRadius,f.squaredEccentricity])));u.spatialReference.isWGS84&&(F=!0,u=x.geographicToWebMercator(u));const C=q.getWebMercatorScalingFactor(u);var A=Y(b,u,C);A=m?A.map(H=>x.webMercatorToGeographic(new p(H))):A;const I=await E.transformPoints(A,b,!0).then(H=>
H.map(D=>({x:D.x,y:D.y,z:1}))),G=[];for(const H of a){a={...H,z:1};const D={...q.projectiveTransform2(a,I,A),spatialReference:u.spatialReference};var [B]=await E.transformPoints([m?x.webMercatorToGeographic(new p(D)):new p(D)],b,!0);await Z(a,B,I,A,u,D,m,b);B=c.attributes.clone();B.geometry=u.clone();const {polygon:S}=O.createCoveragePolygon(B);B=S.rings[0].map(aa=>new p(aa,S.spatialReference));a=await J.projectWithZConversion(t||n?await ba({cameraLocation:u,groundFootPrint:B,projectedPoint:D,webMercatorScalingFactor:C,
vfov:r,shouldConvertToLatLong:F,isCameraOrientationLTP:m,imgPoint:a},b):new p(T(D,u,C,u.z-l,g,r,F)),d.spatialReference,e);G.push(a)}return G}async function ba(a,b){const {cameraLocation:c,groundFootPrint:d,projectedPoint:e,webMercatorScalingFactor:l,vfov:f,shouldConvertToLatLong:g,isCameraOrientationLTP:k,imgPoint:t}=a,{cameraHeight:v,cameraPitch:w}=b.feature.attributes;await J.initializeProjection(c.spatialReference,b.footprintExtent.spatialReference,null,b.options);var h=await ca(d,b),n=0,m=(c.z??
0)-v;for(a=0;10>a;){var r=da(h,c,e);if(!r||!ea([c.x,c.y,c.z],[r.x,r.y,r.z],[e.x,e.y,e.z]))break;m=new p({x:r.x,y:r.y,z:r.z,spatialReference:c.spatialReference});m=await E.transformPoints([k?x.webMercatorToGeographic(m):m],b);n=Math.abs(t.x-m[0].x)+Math.abs(t.y-m[0].y);m=r.z;if(1>=n)break;a+=1;({extent:n}=h);h=(n?.width??0)/10;n=(n?.height??0)/10;if(1>h||1>n)break;const {x:u,y:F}=r;r=await E.updateElevation([[-h,-n],[h,-n],[h,n],[-h,n]].map(([C,A])=>new p({x:u+C,y:F+A,spatialReference:c.spatialReference})),
b,!1);r.push(r[0]);h=new R({rings:[r.map(C=>C.toArray())],spatialReference:c.spatialReference})}return new p(T(e,c,l,m,w,f,g))}function T(a,b,c,d,e,l,f){var g=Math.sqrt((a.z-b.z)**2+(Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)/c)**2)*c;g=q.scaleWithFactor(z.sub(y.zeros(),[a.x,a.y,a.z],[b.x,b.y,b.z]),1/g,1/c);a.z<d||90>e+l/2?(b=q.scaleAndAddWithFactor([b.x,b.y,b.z],g,Math.abs((b.z-d)/-g[2])*c,c),a.x=b[0],a.y=b[1],a.z=b[2]):a.z=d;return f?x.webMercatorToGeographic(new p(a)).toJSON():a}function Y(a,b,c){({feature:a}=
a);({attributes:a}=a);var d=2*Math.tan(L.deg2rad(a.verticalFieldOfView)/2)*a.farDistance*c,e=2*Math.tan(L.deg2rad(a.horizontalFieldOfView)/2)*a.farDistance*c,l=q.calculateRotationMatrix("HPR",[a.cameraHeading,a.cameraPitch,a.cameraRoll??0]),f=q.transformMat3([0,0,-1],l);a=q.scaleAndAddWithFactor([b.x,b.y,b.z],f,a.farDistance*c,c);f=q.transformMat3([0,1,0],l);l=q.transformMat3([1,0,0],l);d=q.scaleWithFactor(f,d/2,c);e=q.scaleWithFactor(l,e/2,c);c=z.sub(y.zeros(),d,e);e=z.add(y.zeros(),d,e);return[z.add(y.zeros(),
a,c),z.add(y.zeros(),a,e),z.sub(y.zeros(),a,c),z.sub(y.zeros(),a,e)].map(g=>{const [k,t,v]=g;return new p({x:k,y:t,z:v,spatialReference:b.spatialReference})})}async function ca(a,b){const c=a[0].spatialReference.isWGS84?V.WebMercator:a[0].spatialReference,{cameraHeight:d,location:e,elevation:l}=b.feature.attributes,f="number"===typeof e.z&&"number"===typeof l?e.z-l:d;a=O.limitZToGround(a.map(({x:g,y:k,z:t})=>[g,k,t]),f,e,q.getWebMercatorScalingFactor(e));b=(await E.updateElevation(a.map(g=>new p(g,
e.spatialReference)),b,!1)).map(g=>J.project(g,c));return new R({hasZ:!0,rings:[b.map(g=>[g.x,g.y,g.z])],spatialReference:c})}async function Z(a,b,c,d,e,l,f,g){let k=0;for(let t=0;8>=t;t+=1){k=Math.abs(a.x-b.x)+Math.abs(a.y-b.y);if(1>=k)break;const [v,w,h,n]=[[-k,-k],[k,-k],[k,k],[-k,k]].map(([G,B])=>({...q.projectiveTransform({x:a.x+G,y:a.y+B,z:1},c[0],c[1],c[2],c[3],{x:d[0].x,y:d[0].y,z:d[0].z},{x:d[1].x,y:d[1].y,z:d[1].z},{x:d[2].x,y:d[2].y,z:d[2].z},{x:d[3].x,y:d[3].y,z:d[3].z}),spatialReference:e.spatialReference})),
[m,r,u,F]=await E.transformPoints(f?[x.webMercatorToGeographic(new p(v)),x.webMercatorToGeographic(new p(w)),x.webMercatorToGeographic(new p(h)),x.webMercatorToGeographic(new p(n))]:[new p(v),new p(w),new p(h),new p(n)],g,!0).then(G=>G.map(B=>({...B,z:0}))),{x:C,y:A,z:I}=q.projectiveTransform(a,m,r,u,F,v,w,h,n);l.x=C;l.y=A;l.z=I;[b]=await E.transformPoints([f?x.webMercatorToGeographic(new p(l)):new p(l)],g,!0)}}function da(a,b,c){var d=a.rings[0][0][0],e=a.rings[0][0][1],l=a.rings[0][0][2],f=a.rings[0][1][0],
g=a.rings[0][1][1],k=a.rings[0][1][2],t=a.rings[0][1][0],v=a.rings[0][1][1],w=a.rings[0][1][2],h=a.rings[0][2][0],n=a.rings[0][2][1],m=a.rings[0][2][2];a=(m-w)*(g-e)-(n-v)*(k-l);k=-((m-w)*(f-d)-(k-l)*(h-t));f=(n-v)*(f-d)-(g-e)*(h-t);d=-(a*d+k*e+f*l);return q.getPlaneLineIntersectionPoint(b.toJSON(),c,a,k,f,d)}const ea=(a,b,c)=>0<z.dot(z.sub(y.zeros(),b,a),z.sub(y.zeros(),c,a));K.transformPoints=function(a,b){if(!a)return Promise.resolve([]);var c=b.feature;let d=c.attributes;d instanceof P||!(d=P.fromJSON(c))||
(c.attributes=d);({attributes:c}=b.feature);if(c.isSpherical||360===c.horizontalFieldOfView){const {location:e,cameraOrientation:l,farDistance:f,cameraHeading:g,cameraHeight:k}=c;a=W(a,e,f,[b.imageProperties.width,b.imageProperties.height],g,k,l)}else a=X(a,b);return a};Object.defineProperty(K,Symbol.toStringTag,{value:"Module"})});
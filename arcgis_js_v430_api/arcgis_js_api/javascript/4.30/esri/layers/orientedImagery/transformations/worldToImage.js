// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/mathUtils ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/math/mat3 ../../../geometry/support/Ellipsoid ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/webMercatorUtils ../core/cameraOrientationFactory ./utils ../../../geometry/Point".split(" "),function(y,T,E,I,P,Q,R,F,S,G,H){function J(a,d){a=Array.isArray(a)||"items"in a?a:[a];var e="string"===typeof d.cameraOrientation?S.getCameraOrientation(d.cameraOrientation):
d.cameraOrientation;{const {cameraHeading:q,cameraPitch:u,cameraRoll:v,cameraOrientation:m}={...d,cameraOrientation:e};if("OPK"===(m?.isAdvanced&&2===m.type?"OPK":"HPR")){const {omega:r,phi:l,kappa:g}=m;var f=G.calculateRotationMatrix("OPK",[r,l,g])}else f=G.calculateRotationMatrix("HPR",[q,u,v])}var b=new H(d.cameraLocation);if(b.spatialReference.isWGS84&&4!==e?.type||b.spatialReference.isGeographic)b=F.geographicToWebMercator(b);b.z||(b.z=d.cameraHeight);var k=K(b);const {cameraOrientation:w,cameraLocation:z,
pointsToTransform:L,rotationMatrix:h,scalingFactor:M}={cameraOrientation:e,pointsToTransform:a,rotationMatrix:f,scalingFactor:k,cameraLocation:b};a=[];if(w?.isAdvanced){const {cameraOrientation:q,cameraLocation:u,scalingFactor:v}={...d,cameraOrientation:w,scalingFactor:M,cameraLocation:z},{principalOffsetPoint:m,focalLength:r,radialDistortionCoefficients:l,affineTransformations:g,tangentialDistortionCoefficients:n}=q;for(var t of L){const [A,B,C]=N(t,q,u,v);e=(h[0]*A+h[1]*B+h[2]*C)/(h[6]*A+h[7]*B+
h[8]*C);f=(h[3]*A+h[4]*B+h[5]*C)/(h[6]*A+h[7]*B+h[8]*C);b=e**2+f**2;var c=0,x=0;let O=0;var p=k=0,D=0;d=0;l&&(c=l[0]??0,x=l[1]??0,O=l[2]??0);n&&(k=n[0],p=n[1]);m&&(D=m[0]??0,d=m[1]??0);x=1+(c||0)*b+(x||0)*b*b+(O||0)*b*b*b;c=e*x+(k||0)*(b+2*e**2)+2*(p||0)*e*f;e=f*x+(p||0)*(b+2*f**2)+2*(k||0)*e*f;c=-(r??0)*c+D;e=-(r??0)*e+d;a.push({x:Number(g[0])+Number(g[1])*c+Number(g[2])*e,y:Number(g[3])+Number(g[4])*c+Number(g[5])*e})}}else{f={...d,cameraOrientation:w,scalingFactor:M,cameraLocation:z};const {horizontalFieldOfView:q,
verticalFieldOfView:u,cameraOrientation:v,cameraLocation:m,scalingFactor:r}=f;d=E.deg2rad(f.imageRotation??0);t=Math.sin(d);d=Math.cos(d);e=f.imageWidth||1;f=f.imageHeight||1;b=[Math.abs(d*e+t*f),Math.abs(d*f-t*e)];k=1/(2*Math.tan(E.deg2rad(q)/2));p=1/(2*Math.tan(E.deg2rad(u)/2));c=I.create();c[0]=-k;c[2]=.5;c[4]=p;c[5]=.5;c=P.mul(I.create(),h,c);for(D of L){const [l,g,n]=N(D,v,m,r);k=(c[0]*l+c[1]*g+c[2]*n)/(c[6]*l+c[7]*g+c[8]*n)*b[0];p=(c[3]*l+c[4]*g+c[5]*n)/(c[6]*l+c[7]*g+c[8]*n)*b[1];a.push({x:d*
(k-b[0]/2)+t*(p-b[1]/2)+e/2,y:-t*(k-b[0]/2)+d*(p-b[1]/2)+f/2})}}return 1===a.length?a[0]:a}function N(a,d,e,f){a=new H(a);if(a.spatialReference.isGeographic)if(a.spatialReference.isWGS84&&4===d?.type){const {latitude:b,longitude:k,ellipsoidRadius:w,squaredEccentricity:z}=d;a=new H(G.geographicToLTP(a,[b,k,w,z]))}else a=F.geographicToWebMercator(a);return[(a.x-e.x)/f,(a.y-e.y)/f,(a.z??0)-(e.z??0)]}function K(a){return R.isWebMercator(a?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*
a.y/Q.earth.radius))):1}y.getScalingFactor=K;y.worldToImage=J;y.worldToImageWithLTPFlag=function(a,d,e){a=a?d.map(f=>F.webMercatorToGeographic(f)):d;return J(a,e).map(f=>({...f,z:1}))};Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/math/mat3 ../../../geometry/Point ../../../geometry/projection ../../../geometry/support/aaBoundingRect ../../../geometry/support/pointUtils ../../../geometry/support/webMercatorUtils ../../ElevationLayer ../../ImageryLayer ../core/ElevationSourceDefinitions ./utils ../../support/ElevationSampler ../../support/ElevationTile ../../support/ElevationTileData ../../support/TileInfo ../../support/TileKey ../../../widgets/PanoramicViewer/constants".split(" "),
function(B,Q,K,L,R,u,A,S,T,C,U,V,G,z,W,X,Y,Z,aa,ba){async function H(b,a,d=!1){if(d)return b;const {feature:{attributes:{cameraOrientation:l,elevationSource:f,cameraHeight:g,location:c},elevationSample:r}}=a;return r?Promise.all(b.map(I(r,a.options))):f&&(G.isConstantElevation(f)||f.url?.length)?M(b,a):E(b,l&&"number"==typeof c.z?c.z-g:0)}async function M(b,a){const {feature:d,options:l,footprintExtent:f}=a;var g=d.attributes.elevationSource;if(!g)return b;if(G.isConstantElevation(g)){var {constantElevation:c}=
g;return"number"!==typeof c?b:E(b,c)}({url:c}=g);if(!c)return b;var {elevationSample:r}=d;if(!r){if(!f)return b;a=f.clone();const {error:x,isSupported:v,isDynamic:t}=await G.validateElevationSourceURL(c);if(!v){K.getLogger(g).warn(x);const {location:m,cameraHeight:n,cameraOrientation:e}=d.attributes;return E(b,e&&"number"==typeof m.z?m.z-n:0)}r=b;let p;try{if(t){p=new V({url:c,format:"lerc",rasterFunction:{functionName:g.rasterFunction??"None"}});await p.load(l);let m=g=512,n;const e=f.width/f.height;
1<e?(m/=e,n=a.height/m):(g*=e,n=a.width/g);const h=await p.fetchImage(f,g,m,l),k=Z.create({scales:[n],size:512,spatialReference:f.spatialReference}),q=new aa.TileKey(null,0,0,0,S.fromExtent(f)),w=new Y.ElevationTileData(h.pixelData.pixelBlock.pixels[0],g,m,0),y=new X.ElevationTile(q,w);d.elevationSample=new W.TileElevationSampler(y,k,void 0)}else p=new U(c),await p.load(),d.elevationSample=await p.createElevationSampler(a,l);r=await Promise.all(b.map(I(d.elevationSample,l)))}catch(m){if(!L.isAbortError(m)){K.getLogger("esri.layers.orientedImagery.transformations.groundToImageUtils").warn(`#updateElevation() failed to update elevation using the provided elevation source URL: ${c}. Please provide a valid elevation source url.`,
m);const {location:n,cameraHeight:e,cameraOrientation:h}=d.attributes;b=E(b,h&&"number"==typeof n.z?n.z-e:0)}}finally{p?.destroy()}return r}await A.initializeProjection(b[0].spatialReference,r.spatialReference,null,a.options);return Promise.all(b.map(I(r,l)))}function I(b,a){L.throwIfAborted(a);return async d=>{d.z=1;const l=b.queryElevation(A.project(d,b.spatialReference));l?.z&&(d.z=(await A.projectWithZConversion(l,d.spatialReference,a)).z);return d}}function E(b,a){return b.map(d=>{d.z=a;return d})}
async function N(b,a){b=Array.isArray(b)?b:[b];const d=[],{location:l,cameraOrientation:f,cameraHeading:g}=a.feature.attributes;await ca(l,b,g,a.imageProperties.width??1,a.imageProperties.height??1,d,f);return d}async function ca(b,a,d,l,f,g,c){b=b.spatialReference.isWGS84&&4!==c?.type?C.geographicToWebMercator(b):new u(b);const {latitude:r,longitude:x,ellipsoidRadius:v,squaredEccentricity:t}=c??{};for(const p of a){a=p.spatialReference.isWGS84&&4===c?.type?new u(z.geographicToLTP(p,[r,x,v,t])):p.spatialReference.equals(b.spatialReference)?
new u(p):await A.projectWithZConversion(p,b.spatialReference);const m=T.distance(b,a);a.x-=b.x;a.y-=b.y;a.z=(a.z??0)-(b.z??0);a=z.convertSphereVertexToOrientation(a,m);a.heading=(a.heading-d)%360;const {x:n,y:e}=z.convertOrientationToPixelLocation(a.heading,a.pitch,l,f);g.push(new u(n,e,ba.defaultImageSphereCenter.spatialReference))}}function da(b,a){const {feature:d,imageProperties:l}=a,{width:f,height:g}=l,{attributes:c}=d;a=z.calculateRotationMatrix("HPR",[c.cameraHeading,c.cameraPitch,c.cameraRoll]);
const r=Math.sin(c.imageRotation??0*F),x=Math.cos(c.imageRotation??0*F),v=f??1,t=g??1,p=[Math.abs(x*v+r*t),Math.abs(x*t-r*v)],m=[-(1/(2*Math.tan(c.horizontalFieldOfView*F/2))),0,.5,0,1/(2*Math.tan(c.verticalFieldOfView*F/2)),.5,0,0,1];let n=new u(c.location);n.spatialReference.isWGS84&&4!==c.cameraOrientation?.type&&(n=C.geographicToWebMercator(n));const e=n.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*n.y/6378137))):1,h=R.mul(Array(9),a,m);return b.map(k=>{var q=new u(k);
q.spatialReference.isWGS84&&(4===c.cameraOrientation?.type?(k=c.cameraOrientation,q=new u(z.geographicToLTP(q,[k.latitude,k.longitude,k.ellipsoidRadius,k.squaredEccentricity]))):q=new u(C.geographicToWebMercator(q)));k=(q.z??0)-(n.z??0);const w=(q.x-n.x)/e,y=(q.y-n.y)/e;q=(h[0]*w+h[1]*y+h[2]*k)/(h[6]*w+h[7]*y+h[8]*k)*p[0];k=(h[3]*w+h[4]*y+h[5]*k)/(h[6]*w+h[7]*y+h[8]*k)*p[1];return{x:x*(q-p[0]/2)+r*(k-p[1]/2)+v/2,y:-r*(q-p[0]/2)+x*(k-p[1]/2)+t/2}})}function ea(b,a){var {feature:d}=a;const {attributes:l}=
d;d=l.cameraOrientation;if(!d)throw new Q("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let f=new u(l.location);f.spatialReference.isWGS84&&4!==l.cameraOrientation?.type&&(f=C.geographicToWebMercator(f));const g=f.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*f.y/6378137))):1;let c;if("esri.layers.orientedImagery.core.CameraOrientationOPK"===d.declaredClass){const {omega:m,phi:n,
kappa:e}=d;c=z.calculateRotationMatrix("OPK",[m,n,e])}else{const {cameraHeading:m,cameraPitch:n,cameraRoll:e}=l;c=z.calculateRotationMatrix("HPR",[m,n,e])}const {principalOffsetPoint:r,focalLength:x,radialDistortionCoefficients:v,affineTransformations:t,tangentialDistortionCoefficients:p}=d;return Promise.all(b.map(async m=>{function n(e){if(e.spatialReference.isWGS84)if(4===l.cameraOrientation?.type){var h=l.cameraOrientation;e=new u(z.geographicToLTP(e,[h.latitude,h.longitude,h.ellipsoidRadius,
h.squaredEccentricity]))}else e=new u(C.geographicToWebMercator(e));h=(e.z??0)-(f.z??0);var k=(e.x-f.x)/g,q=(e.y-f.y)/g;e=(c[0]*k+c[1]*q+c[2]*h)/(c[6]*k+c[7]*q+c[8]*h);h=(c[3]*k+c[4]*q+c[5]*h)/(c[6]*k+c[7]*q+c[8]*h);k=e**2+h**2;var w=0;let y=0,O=0,J=q=0;var D=0;let P=0;v&&(w=v[0]??0,y=v[1]??0,O=v[2]??0);p&&(q=p[0],J=p[1]);r&&(D=r[0]??0,P=r[1]??0);w=1+(w||0)*k+(y||0)*k*k+(O||0)*k*k*k;D=-(x??0)*(e*w+(q||0)*(k+2*e**2)+2*(J||0)*e*h)+D;e=-(x??0)*(h*w+(J||0)*(k+2*h**2)+2*(q||0)*e*h)+P;return{x:Number(t[0])+
Number(t[1])*D+Number(t[2])*e,y:Number(t[3])+Number(t[4])*D+Number(t[5])*e}}if(m.spatialReference.equals(f.spatialReference))return m=new u(m),n(m);await A.initializeProjection(b[0].spatialReference,f.spatialReference,null,a.options);m=A.project(m,f.spatialReference);return n(m)}))}const F=Math.PI/180;B.transformPoints=async function(b,a,d=!1){if(!b)return[];b=b.map(g=>"esri.geometry.Point"===g.declaredClass?g:u.fromJSON(g));const {feature:l}=a;var {attributes:f}=l;isNaN(parseFloat(f.elevation))&&
(f=await H([l.geometry],a),l.attributes.elevation=f[0].z);return H(b,a,d).then(g=>{{const {attributes:c}=a.feature;g=c.isSpherical||360===c.horizontalFieldOfView?N(g,a):c.cameraOrientation?.isAdvanced?ea(g,a):Promise.resolve(da(g,a))}return g})};B.transformPointsEquirectangularPanorama=N;B.updateElevation=H;B.updateElevationUsingElevationSource=M;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
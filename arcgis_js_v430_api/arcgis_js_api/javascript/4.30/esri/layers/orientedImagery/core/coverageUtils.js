// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../chunks/vec32 ../../../geometry/Circle ../../../geometry/Mesh ../../../geometry/projection ../../../geometry/support/Ellipsoid ../../../geometry/support/lineSegment ../../../geometry/support/MeshComponent ../../../geometry/support/MeshVertexAttributes ../../../geometry/support/plane ../../../geometry/support/spatialReferenceUtils ../transformations/utils ../../../geometry/Polygon ../../../geometry/SpatialReference ../../../geometry/Multipoint".split(" "),
function(H,va,ja,r,t,T,M,ka,la,Y,ma,U,L,na,k,V,Z,oa){function aa(a,d,b,f){return a.map(c=>{{var l=Math.sqrt((c[2]-d)**2+(Math.sqrt((c[0]-b.x)**2+(c[1]-b.y)**2)/f)**2)*f;const p=k.scaleWithFactor(t.sub(r.zeros(),[c[0],c[1],c[2]],[b.x,b.y,d]),1/l,1/f);var e=d/(d-c[2]);l=(1-e)*b.x+e*c[0];var m=(1-e)*b.y+e*c[1];e=(1-e)*d+e*c[2];var n=Math.sqrt((e-d)**2+(Math.sqrt((l-b.x)**2+(m-b.y)**2)/f)**2)*f;n=k.scaleWithFactor(t.sub(r.zeros(),[l,m,e],[b.x,b.y,d]),1/n,1/f);c=Math.sign(p[0])!==Math.sign(n[0])&&Math.sign(p[1])!==
Math.sign(n[1])&&Math.sign(p[2])!==Math.sign(n[2])||0<=c[2]?[c[0],c[1],0]:[l,m,e]}return c})}function ba(a){return a&&na.isWebMercator(a?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*a.y/la.earth.radius))):1}async function pa(a,d,b,f,c,l,e,m,n){{const C=ca(a),D=ca(a,"near");if(C){var {coefficients:p}=C;d=d.length;for(let B=0;B<d;B++){var g=[b[B][0],b[B][1]];g=p?(-p[3]-p[0]*g[0]-p[1]*g[1])/p[2]:void 0;var h=b[B];h[2]=(0<=h[2]?g:h[2])??0;h=[h[0]-f[0],h[1]-f[1],h[2]-(f[2]??c)];var u=
f,z=h,G=B,q=D;if(q){var w=r.create();L.intersectLineSegmentClamp(q.coefficients,Y.wrap(u,z),w)&&q.vertexPositions.splice(3*G,3,...w)}u=f;z=B;const {coefficients:I,vertexPositions:K}=C;null!=g&&0<=g?K.splice(3*z,3,...b[z]):(g=r.create(),L.intersectLineSegmentClamp(I,Y.wrap(u,h),g)&&K.splice(3*z,3,...g))}b={farPlane:C,nearPlane:D}}else b=void 0}if(b){var {farPlane:v,nearPlane:A}=b;a=await W([...(A?.vertexPositions??a.slice(0,3)),...v.vertexPositions],e,m,n);return new M({vertexAttributes:new U.MeshVertexAttributes({position:a}),
components:da(ea(l)),spatialReference:m})}}async function qa(a,d,b,f,c,l,e,m=0,n){const p=Math.cos((m??0)*x);m=Math.sin((m??0)*x);const g=Math.abs(b*p+f*m),h=Math.abs(b*-m+f*p);let u=e?[]:[a[0],a[1],a[2]];let z=[];const G=d.length;for(let v=0;v<G;v++){var q=[g/2,h/2];var w=d[v];w=[(w[0]-q[0])*p-(w[1]-q[1])*m+q[0],(w[0]-q[0])*m+(w[1]-q[1])*p+q[1]];e?(q=k.projectiveTransform({x:w[0],y:w[1],z:1},{x:0,y:0,z:1},{x:b,y:0,z:1},{x:b,y:f,z:1},{x:0,y:f,z:1},{x:a[0],y:a[1],z:a[2]},{x:a[3],y:a[4],z:a[5]},{x:a[6],
y:a[7],z:a[8]},{x:a[9],y:a[10],z:a[11]}),u=u.concat([q.x,q.y,q.z]),q=k.projectiveTransform({x:w[0],y:w[1],z:1},{x:0,y:0,z:1},{x:b,y:0,z:1},{x:b,y:f,z:1},{x:0,y:f,z:1},{x:a[12],y:a[13],z:a[14]},{x:a[15],y:a[16],z:a[17]},{x:a[18],y:a[19],z:a[20]},{x:a[21],y:a[22],z:a[23]}),z=z.concat([q.x,q.y,q.z])):(q=k.projectiveTransform({x:w[0],y:w[1],z:1},{x:0,y:0,z:1},{x:b,y:0,z:1},{x:b,y:f,z:1},{x:0,y:f,z:1},{x:a[3],y:a[4],z:a[5]},{x:a[6],y:a[7],z:a[8]},{x:a[9],y:a[10],z:a[11]},{x:a[12],y:a[13],z:a[14]}),u=u.concat([q.x,
q.y,q.z]))}u=u.concat(z);a=await W(u,c,l,n);return new M({vertexAttributes:new U.MeshVertexAttributes({position:a}),components:da(ea(e)),spatialReference:l})}async function W(a,d,b,f){if(d.equals(b))return a;a=a.reduce((c,l,e)=>{e=Math.floor(e/3);c[e]||(c[e]=[]);c[e].push(l);return c},[]);({points:d}=await ka.projectWithZConversion(new oa(a,d),b,f));ja.throwIfAborted(f);return d.flat()}function ca(a,d="far"){const b=L.create();switch(d){case "far":d=Array.from(15===a.length?a.slice(3):a.slice(12));
if(L.fromArray(b,d,!1))return{coefficients:b,vertexPositions:d};break;case "near":if(d=Array.from(a.slice(0,12)),15!==a.length&&L.fromArray(b,d,!1))return{coefficients:b,vertexPositions:d}}}const x=Math.PI/180,ea=a=>a?[{faces:new Uint32Array([4,0,3,4,7,3])},{faces:new Uint32Array([5,1,2,5,6,2])},{faces:new Uint32Array([4,0,1,4,5,1])},{faces:new Uint32Array([6,2,3,6,7,3])}]:[{faces:new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1])}],da=a=>a.map(d=>new ma(d));H.checkIfPolygonContainsSelectedPoint=function(a,
d){return a.contains(d)};H.computePolygonForInspection=function(a){const {spatialReference:d,x:b,y:f}=a.geometry,{cameraHeading:c,cameraPitch:l,farDistance:e,nearDistance:m}=a;var n=ba(a.geometry);a=new V({spatialReference:d});const p=Math.abs(1.44*e*n);n=Math.abs(1.44*m*n);if(20>l||null==c)n=p;const g=[];g[0]={x:b+p*Math.sin((c-45)*x),y:f+p*Math.cos((c-45)*x)};g[1]={x:b+p*Math.sin((c+45)*x),y:f+p*Math.cos((c+45)*x)};g[2]={x:b+n*Math.sin((c+135)*x),y:f+n*Math.cos((c+135)*x)};g[3]={x:b+n*Math.sin((c+
225)*x),y:f+n*Math.cos((c+225)*x)};a.addRing([[g[0].x,g[0].y,0],[g[1].x,g[1].y,0],[g[2].x,g[2].y,0],[g[3].x,g[3].y,0],[g[0].x,g[0].y,0]]);return a};H.createCoveragePolygon=function(a){if(a.isSpherical){const {geometry:D,farDistance:B,objectId:I,nearDistance:K,cameraHeight:N}=a;var d=k.getWebMercatorScalingFactor(D);a=new T({center:D.clone(),radius:B*d});a.imageID=I;if(K){var b=new T({center:D.clone(),radius:K*d});a.addRing(b.rings[0])}b=D.clone();b.z=N-B*d;d=M.createSphere(b,{size:2*B*d});d.imageID=
I;a={polygon:a,frustum:d}}else{const {horizontalFieldOfView:D,verticalFieldOfView:B,geometry:I,cameraHeading:K}=a;d=k.getWebMercatorScalingFactor(I);b=a.cameraPitch;let N=a.cameraRoll;var f=150;150<D&&(b=90,N=0,f=5);f=Math.ceil(D/f);var c=f,l=K;var e=D;var m=[];if(0===c%2)for(var n=0;n<c/2;n++)m.push(l-e/c*(n+.5),l+e/c*(n+.5));else for(m.push(l),n=1;n<c/2;n++)m.push(l-e/c*n,l+e/c*n);m.sort();e=m;c=a.farDistance?a.farDistance*d:a.cameraHeight*d/Math.cos(b*x);90<=a.cameraPitch+B/2&&(c=(a.farDistance||
20)*d);l=new V({spatialReference:I?.spatialReference});l.imageID=a.objectId;m=null;for(const ra of e){var p=void 0,g=void 0,h=void 0;m=a;n=I;var u=c,z=d,G=B,q=D,w=f;e=l;var v=k.calculateRotationMatrix("HPR",[ra,b,N]);const {cameraHeight:O,cameraPitch:fa,farDistance:sa,geometry:J,horizontalFieldOfView:ha,nearDistance:ia,verticalFieldOfView:X}=m;h=ba(J);var A=0>ia?0:ia*h;g=O*h/Math.cos(fa*x);var C=!0;90<=fa+X/2&&(g=(sa??20)*h,C=!1);const P=2*Math.tan(X*x/2)*A,Q=2*Math.tan(ha*x/2)*A,R=2*Math.tan(X*x/
2)*g,S=2*Math.tan(ha*x/2)*g;p=[0,0,-1];p=k.transformMat3(p,v);g=k.scaleAndAddWithFactor([J.x,J.y,O],p,g,h);C&&(g[2]=0);C=k.scaleAndAddWithFactor([J.x,J.y,O],p,A,h);let E=[0,1,0];E=k.transformMat3(E,v);let F=[1,0,0];F=k.transformMat3(F,v);let y=[];p=[];A?(p=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],y=y.concat(t.add(r.zeros(),C,t.sub(r.zeros(),k.scaleWithFactor(E,P/2,h),k.scaleWithFactor(F,Q/2,h)))),y=y.concat(t.add(r.zeros(),C,t.add(r.zeros(),k.scaleWithFactor(E,
P/2,h),k.scaleWithFactor(F,Q/2,h)))),y=y.concat(t.sub(r.zeros(),C,t.sub(r.zeros(),k.scaleWithFactor(E,P/2,h),k.scaleWithFactor(F,Q/2,h)))),y=y.concat(t.sub(r.zeros(),C,t.add(r.zeros(),k.scaleWithFactor(E,P/2,h),k.scaleWithFactor(F,Q/2,h))))):(y=[J.x,J.y,O],p=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]);y=y.concat(t.add(r.zeros(),g,t.sub(r.zeros(),k.scaleWithFactor(E,R/2,h),k.scaleWithFactor(F,S/2,h))));y=y.concat(t.add(r.zeros(),g,t.add(r.zeros(),k.scaleWithFactor(E,R/2,h),k.scaleWithFactor(F,S/2,h))));y=
y.concat(t.sub(r.zeros(),g,t.sub(r.zeros(),k.scaleWithFactor(E,R/2,h),k.scaleWithFactor(F,S/2,h))));y=y.concat(t.sub(r.zeros(),g,t.add(r.zeros(),k.scaleWithFactor(E,R/2,h),k.scaleWithFactor(F,S/2,h))));h=new U.MeshVertexAttributes({position:Float64Array.from(y)});h=new M({vertexAttributes:h,components:p,spatialReference:J.spatialReference});A=k.transformMat3([0,0,-1],v);const {x:ta,y:ua}=n;A=k.scaleAndAddWithFactor([ta,ua,m.cameraHeight],A,u,z);G=2*Math.tan(G*x/2)*u;u*=2*Math.tan(q/w*x/2);q=k.transformMat3([0,
1,0],v);v=k.transformMat3([1,0,0],v);q=k.scaleWithFactor(q,G/2,z);u=k.scaleWithFactor(v,u/2,z);v=t.sub(r.zeros(),q,u);u=t.add(r.zeros(),q,u);v=[t.add(r.zeros(),A,v),t.add(r.zeros(),A,u),t.sub(r.zeros(),A,v),t.sub(r.zeros(),A,u)];m=aa(v,m.cameraHeight,n,z);m.push(m[0]);e.addRing(m);m=h}m.imageID=a.objectId;a={polygon:l,frustum:m}}return a};H.limitZToGround=aa;H.projectVertices=W;H.resizePolygon=function(a,d){d=1+d/100;if("esri.geometry.Circle"===a.declaredClass){const {radius:f,center:c}=a;d=new T({radius:f*
d,center:c});1<a.rings.length&&d.addRing(a.rings[1]);return d}if("esri.geometry.Polygon"===a.declaredClass){const f=new V({spatialReference:a.spatialReference}),c=a.centroid;if(c){const l=[];for(let e=0;e<a.rings[0].length;e++){var b=Math.sqrt((c.x-a.rings[0][e][0])**2+(c.y-a.rings[0][e][1])**2);const m=k.scaleWithFactor(t.sub(r.zeros(),[a.rings[0][e][0],a.rings[0][e][1],0],[c.x,c.y,0]),1/b,1);b=k.scaleAndAddWithFactor([c.x,c.y,0],m,b*d,1);l.push({x:b[0],y:b[1]})}f.addRing([[l[0].x,l[0].y,0],[l[1].x,
l[1].y,0],[l[2].x,l[2].y,0],[l[3].x,l[3].y,0],[l[0].x,l[0].y,0]])}return f}return a};H.updateFrustum=async function(a,d,b){const {cameraHeight:f,cameraLocation:c,cameraPitch:l,frustumVertices:e,horizontalFieldOfView:m,imageHeight:n,imageWidth:p,inSRS:g,outSRS:h,verticalFieldOfView:u,cameraRoll:z,imageRotation:G,options:q}=b;b=new Z(g);const w=new Z(h),v=k.computeHFOVAndVFOV(m,u,z??0),A=15<e.length;return 90<=l+v.vfov/2?await qa(e,a,p,n,b,w,A,G,q):await pa(e,a,d,c,f,A,b,w,q)};Object.defineProperty(H,
Symbol.toStringTag,{value:"Module"})});
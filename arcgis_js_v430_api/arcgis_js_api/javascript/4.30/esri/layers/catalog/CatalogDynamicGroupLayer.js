// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Collection ../../core/handleUtils ../../core/LRUCache ../../core/MapUtils ../../core/MultiOriginJSONSupport ../../core/ReactiveMap ../../core/reactiveUtils ../../core/signal ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/RandomLCG ../../core/has ../../core/accessorSupport/decorators/subclass ../Layer ../mixins/BlendLayer ../mixins/ScaleRangeLayer ../support/commonProperties ../support/OrderByInfo ../../statistics/utils".split(" "),
function(d,q,l,r,m,c,t,u,v,e,w,E,F,x,y,z,A,B,C,n){c=class extends A.ScaleRangeLayer(z.BlendLayer(c.MultiOriginJSONMixin(y))){constructor(a){super(a);this._layerCache=new r.LRUCache(20,b=>b.destroy());this._oidToReference=new t;this._layerToReference=new Map;this.layers=new q;this.maximumVisibleSublayers=10;this.opacity=1;this.parent=null;this.persistenceEnabled=!0;this.title="Layers in view";this.type="catalog-dynamic-group";this.visible=!0}initialize(){this.addHandles([this.layers.on("after-add",
({item:a})=>{a.parent=this}),this.layers.on("after-remove",({item:a})=>{a.parent=null}),u.watch(()=>this._orderBy,()=>{this._updateLayerSortValues();this._sortAllLayers()})])}load(a){this.addResolvingPromise(this.parent.load());return Promise.resolve(this)}destroy(){this._layerCache.destroy();this._oidToReference.clear();this._layerToReference.clear()}get _orderBy(){return this.parent?this.parent.orderBy?.find(a=>!a.valueExpression&&a.field)??new C({field:this.parent.objectIdField}):null}get _referenceComparator(){const a=
this._orderBy;if(!this.parent||!a)return()=>0;const b=this.parent.fieldsIndex.get(a.field),g=n.getAttributeComparator(b?.toJSON().type,"descending"===a.order),h=n.getAttributeComparator("esriFieldTypeOID","descending"===a.order);return(k,f)=>g(f.sortValue,k.sortValue)||h(f.objectId,k.objectId)}get fullExtent(){return this.parent?.fullExtent??null}get updating(){return m.someMap(this._oidToReference,a=>null!=a.pending)}acquireLayer(a){if(this.destroyed)return l.makeHandle();const b=this._getLayerReference(a);
b.count++;return l.makeHandle(()=>{b.count--;b.count||this._destroyLayerReference(b)})}_getLayerReference(a){const b=a.getObjectId();return m.getOrCreateMapValue(this._oidToReference,b,()=>{var g=a.getObjectId();const h=`${g}`,k=a.getAttribute(this.parent.itemSourceField),f=new D(a,g,k);if(g=this._layerCache.pop(h))return this._addLayer(f,g),f;f.pending=this.parent.createLayerFromFootprint(a).then(p=>{f.count?this._addLayer(f,p):(this.destroyed||this._layerCache.get(h)||this._layerCache.put(h,p),
f.layer=null)}).catch(()=>{}).finally(()=>{f.pending=null});return f})}_destroyLayerReference(a){a.layer&&(this._layerToReference.delete(a.layer),this.layers.remove(a.layer),this.destroyed?a.layer.destroy():this._layerCache.put(`${a.objectId}`,a.layer),a.layer=null);this._oidToReference.delete(a.objectId)}_addLayer(a,b){a.layer=b;b.persistenceEnabled=!1;this._layerToReference.set(b,a);this._updateLayerSortValue(a);this.layers.add(b);this._sortAllLayers()}_updateLayerSortValues(){for(const a of this._layerToReference.values())this._updateLayerSortValue(a)}_updateLayerSortValue(a){this._orderBy&&
(a.sortValue=a.footprint.getAttribute(this._orderBy.field))}_sortAllLayers(){this.layers.sort((a,b)=>this._referenceComparator(this._layerToReference.get(a),this._layerToReference.get(b)))}};d.__decorate([e.property()],c.prototype,"_orderBy",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"_referenceComparator",null);d.__decorate([e.property({type:["show","hide","hide-children"],json:{write:!0}})],c.prototype,"listMode",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"fullExtent",
null);d.__decorate([e.property({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],c.prototype,"id",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"layers",void 0);d.__decorate([e.property({type:w.Integer,range:{min:0,max:50},json:{write:!0,default:10}})],c.prototype,"maximumVisibleSublayers",void 0);d.__decorate([e.property(B.opacity)],c.prototype,"opacity",void 0);d.__decorate([e.property({clonable:!1})],c.prototype,"parent",void 0);d.__decorate([e.property({type:String,
nonNullable:!0,json:{write:{ignoreOrigin:!0,isRequired:!0}}})],c.prototype,"title",void 0);d.__decorate([e.property({json:{read:!1}})],c.prototype,"type",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"updating",null);d.__decorate([e.property({type:Boolean,json:{name:"visibility",write:!0}})],c.prototype,"visible",void 0);c=d.__decorate([x.subclass("esri.layers.catalog.CatalogDynamicGroupLayer")],c);class D{constructor(a,b,g){this.footprint=a;this.objectId=b;this.itemSource=g;this.count=
0;this.layer=null;this.sortValue=void 0;this._pending=v.signal(null)}get pending(){return this._pending.value}set pending(a){this._pending.value=a}}return c});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define(["exports","../../arrayUtils","../../has","../../PooledArray","../../../chunks/quickselect"],function(B,C,Q,v,N){function H(a,b){for(w.clear();a;){if(!0===a.leaf)for(const c of a.children)b(c);else w.pushArray(a.children);a=w.pop()??null}}function q(a,b){r(a,0,a.children.length,b,a)}function r(a,b,c,d,e){e||=new x([]);e.minX=Infinity;e.minY=Infinity;e.maxX=-Infinity;e.maxY=-Infinity;for(let g=b,f;g<c;g++)f=a.children[g],t(e,a.leaf?d(f):f);return e}function t(a,b){a.minX=Math.min(a.minX,b.minX);
a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,b.maxY)}function I(a,b){return a.minX-b.minX}function J(a,b){return a.minY-b.minY}function D(a){return(a.maxX-a.minX)*(a.maxY-a.minY)}function y(a){return a.maxX-a.minX+(a.maxY-a.minY)}function E(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY}function z(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY}function K(a,b,c,d,e){for(b=[b,c];b.length;){c=b.pop();const g=
b.pop();if(c-g<=d)continue;const f=g+Math.ceil((c-g)/d/2)*d;N.quickselect(a,f,g,c,e);b.push(g,f,f,c)}}class O{constructor(a=9,b){this._compareMinX=I;this._compareMinY=J;this._toBBox=c=>c;this._maxEntries=Math.max(4,a||9);this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries));b&&("function"===typeof b?this._toBBox=b:this._initFormat(b));this.clear()}destroy(){this.clear();m.prune();w.prune();l.prune();A.prune()}all(a){H(this._data,a)}search(a,b){let c=this._data;const d=this._toBBox;if(z(a,c))for(m.clear();c;){for(let e=
0,g=c.children.length;e<g;e++){const f=c.children[e],h=c.leaf?d(f):f;z(a,h)&&(c.leaf?b(f):E(a,h)?H(f,b):m.push(f))}c=m.pop()}}collides(a){let b=this._data;const c=this._toBBox;if(!z(a,b))return!1;for(m.clear();b;){for(let d=0,e=b.children.length;d<e;d++){const g=b.children[d],f=b.leaf?c(g):g;if(z(a,f)){if(b.leaf||E(a,f))return!0;m.push(g)}}b=m.pop()}return!1}load(a){if(!a.length)return this;if(a.length<this._minEntries){for(let b=0,c=a.length;b<c;b++)this.insert(a[b]);return this}a=this._build(a.slice(0,
a.length),0,a.length-1,0);if(this._data.children.length)if(this._data.height===a.height)this._splitRoot(this._data,a);else{if(this._data.height<a.height){const b=this._data;this._data=a;a=b}this._insert(a,this._data.height-a.height-1,!0)}else this._data=a;return this}insert(a){a&&this._insert(a,this._data.height-1);return this}clear(){this._data=new x([]);return this}remove(a){if(!a)return this;let b=this._data,c=null,d=0,e=!1,g;const f=this._toBBox(a);l.clear();for(A.clear();b||0<l.length;){b||(b=
l.pop(),c=l.data[l.length-1],d=A.pop()??0,e=!0);if(b.leaf&&(g=C.indexOf(b.children,a,b.children.length,b.indexHint),-1!==g)){b.children.splice(g,1);l.push(b);this._condense(l);break}e||b.leaf||!E(b,f)?c?(d++,b=c.children[d],e=!1):b=null:(l.push(b),A.push(d),d=0,c=b,b=b.children[0])}return this}toJSON(){return this._data}fromJSON(a){this._data=a;return this}_build(a,b,c,d){var e=c-b+1,g=this._maxEntries;if(e<=g)return a=new x(a.slice(b,c+1)),q(a,this._toBBox),a;d||(d=Math.ceil(Math.log(e)/Math.log(g)),
g=Math.ceil(e/g**(d-1)));const f=new F([]);f.height=d;e=Math.ceil(e/g);g=e*Math.ceil(Math.sqrt(g));for(K(a,b,c,g,this._compareMinX);b<=c;b+=g){const h=Math.min(b+g-1,c);K(a,b,h,e,this._compareMinY);for(let k=b;k<=h;k+=e)f.children.push(this._build(a,k,Math.min(k+e-1,h),d-1))}q(f,this._toBBox);return f}_insert(a,b,c){var d=this._toBBox;c=c?a:d(a);l.clear();d=this._data;for(var e=b,g=l;;){g.push(d);if(!0===d.leaf||g.length-1===e)break;let f=Infinity,h=Infinity,k=void 0;for(let n=0,P=d.children.length;n<
P;n++){const p=d.children[n],u=D(p),G=(Math.max(p.maxX,c.maxX)-Math.min(p.minX,c.minX))*(Math.max(p.maxY,c.maxY)-Math.min(p.minY,c.minY))-u;G<h?(h=G,f=u<f?u:f,k=p):G===h&&u<f&&(f=u,k=p)}d=k||d.children[0]}d.children.push(a);for(t(d,c);0<=b;)if(l.data[b].children.length>this._maxEntries)this._split(l,b),b--;else break;for(a=l;0<=b;b--)t(a.data[b],c)}_split(a,b){const c=a.data[b];var d=c.children.length;const e=this._minEntries;this._chooseSplitAxis(c,e,d);if(d=this._chooseSplitIndex(c,e,d))d=c.children.splice(d,
c.children.length-d),d=c.leaf?new x(d):new F(d),d.height=c.height,q(c,this._toBBox),q(d,this._toBBox),b?a.data[b-1].children.push(d):this._splitRoot(c,d)}_splitRoot(a,b){this._data=new F([a,b]);this._data.height=a.height+1;q(this._data,this._toBBox)}_chooseSplitIndex(a,b,c){let d,e,g=void 0;d=e=Infinity;for(let h=b;h<=c-b;h++){var f=r(a,0,h,this._toBBox);const k=r(a,h,c,this._toBBox),n=Math.max(0,Math.min(f.maxX,k.maxX)-Math.max(f.minX,k.minX))*Math.max(0,Math.min(f.maxY,k.maxY)-Math.max(f.minY,k.minY));
f=D(f)+D(k);n<d?(d=n,g=h,e=f<e?f:e):n===d&&f<e&&(e=f,g=h)}return g}_chooseSplitAxis(a,b,c){const d=a.leaf?this._compareMinX:I,e=a.leaf?this._compareMinY:J,g=this._allDistMargin(a,b,c,d);b=this._allDistMargin(a,b,c,e);g<b&&a.children.sort(d)}_allDistMargin(a,b,c,d){a.children.sort(d);d=this._toBBox;var e=r(a,0,b,d);const g=r(a,c-b,c,d);let f=y(e)+y(g);for(let h=b;h<c-b;h++){const k=a.children[h];t(e,a.leaf?d(k):k);f+=y(e)}for(c=c-b-1;c>=b;c--)e=a.children[c],t(g,a.leaf?d(e):e),f+=y(g);return f}_condense(a){for(let b=
a.length-1;0<=b;b--){const c=a.data[b];if(0===c.children.length)if(0<b){const d=a.data[b-1],e=d.children;e.splice(C.indexOf(e,c,e.length,d.indexHint),1)}else this.clear();else q(c,this._toBBox)}}_initFormat(a){const b=["return a"," - b",";"];this._compareMinX=new Function("a","b",b.join(a[0]));this._compareMinY=new Function("a","b",b.join(a[1]));this._toBBox=new Function("a","return {minX: a"+a[0]+", minY: a"+a[1]+", maxX: a"+a[2]+", maxY: a"+a[3]+"};")}}const m=new v,w=new v,l=new v,A=new v({deallocator:void 0});
class L{constructor(){this.minY=this.minX=Infinity;this.maxY=this.maxX=-Infinity}}class M extends L{constructor(){super(...arguments);this.height=1;this.indexHint=new C.PositionHint}}class x extends M{constructor(a){super();this.children=a;this.leaf=!0}}class F extends M{constructor(a){super();this.children=a;this.leaf=!1}}B.BBox=L;B.PooledRBush=O;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require ../../chunks/tslib.es6 ../../Graphic ../../core/arrayUtils ../../core/Error ../../core/handleUtils ../../core/has ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/uuid ../../core/accessorSupport/decorators/property ../../core/Logger ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ../../views/input/InputManager ../../views/interactive/sketch/SketchOptions ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./modelUploadUtils ./Workflow ./workflowUtils ../FeatureForm/FeatureFormViewModel ../Sketch/SketchViewModel".split(" "),
function(M,q,N,H,O,w,p,B,P,z,I,r,fa,Q,R,F,S,T,U,V,W,C,X,u,Y,Z){function aa(a,c){let b=null;const e=()=>{null!=b&&(a.snappingOptions.featureSources.remove(b),b=B.destroyMaybe(b))};return w.handlesGroup([z.watch(()=>{const f=c.creationInfo?.layer,g=a.snappingOptions.featureSources.find(h=>h.layer===f);return{hasFeatureLayerSource:!!g,enabled:g?.enabled??!1}},({hasFeatureLayerSource:f,enabled:g})=>{if(f)null==b&&(b=new V({layer:a.layer}),a.snappingOptions.featureSources.add(b)),b.enabled=g;else return e()},
z.syncAndInitial),w.makeHandle(e)])}function ba(a,c,b,e){const f=[];c.forEach((g,h)=>{if(!g.error){const l=a[h];h=e.get(l)||[];l.attributes[b.objectIdField]=g.objectId;h.forEach(({form:n})=>f.push({feature:l,attachment:n}))}});return f}function ca(a,c,b){const e=[],f=c.globalIdField;a.forEach((g,h)=>{let l;(l=a[h].attributes)[f]??(l[f]=I.generateBracedUUID());(b?.get(g)||[]).forEach(({file:n})=>e.push({feature:g,attachment:{globalId:I.generateBracedUUID(),data:n}}))});return e.length?{addFeatures:a,
addAttachments:e}:{addFeatures:a}}var D;const G=Symbol(),A=Symbol(),E=Symbol();p=D=class extends X{constructor(a){super(a);this.type="create-features";this.createFeatureState="create-new";this.data=void 0;this.isNested=!1;this._getDrawMeshHelpMessage=void 0;this._featureFormHandle=null;this._visualVariableAttributes={rotation:null,size:null};this._featureFormViewModel=new Y;this._sketchViewModel=null;this._attachmentFileInfos=new Map;this._highlightHandles=new Map;this._preventDefaultActionOnCancel=
!1;this._lastActiveGraphics=[];this._isActive=!0;this._updateGraphicDebounced=P.debounce((c,b,e)=>u.updateGraphicSymbolWhenRequired(c,b,e))}initialize(){this.isNested&&(this._isActive=!1);this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(0<this.numPendingFeatures)return!0;const {creationInfo:a,upload:c}=this.data;var b=this._sketchViewModel;const {activeComponent:e}=b;b=b.createGraphic?.geometry?.type;
return!("polyline"!==b&&"polygon"!==b&&"multipoint"!==b||"draw-2d"!==e?.type&&"draw-3d"!==e?.type)&&0<e.drawOperation.committedVertices.length||c&&("pending"===c.state||"success"===c.state)||a?.geometryToPlace?!0:!1}get helpMessage(){const {creationInfo:a,viewModel:c}=this.data;if("creating-features"===this.stepId&&a){var b=a.layer.geometryType,e=this._sketchViewModel.createGraphic;return"mesh"===b?(this._getDrawMeshHelpMessage||(new Promise((f,g)=>M(["../../views/draw/support/helpMessageUtils3d"],
f,g))).then(f=>{this._getDrawMeshHelpMessage=f.getDrawMeshHelpMessage}),{view:b}=c,"3d"===b?.type?this._getDrawMeshHelpMessage?.(e,b):void 0):S.getDrawHelpMessage(b,e?.geometry)}}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??
!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0;"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1;this.removeHandles([E])}async updatePendingFeature(a,c){this._preventDefaultActionOnCancel=!0;this._sketchViewModel.cancel();H.remove(this._lastActiveGraphics,
a);return this._startUpdating(a,c)}async start(){await super.start();return F.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(a){const {addAttachmentsCallback:c,applyEditsCallback:b,isNested:e,creationInfo:f,parent:g,snappingManager:h,startAt:l,viewModel:n}=a;a=a.sketchOptions??new U;var m=f?.layer;m=m?n.findEditorItemForLayer(m):void 0;const v=new D({data:new W.CreateFeaturesWorkflowData({creationInfo:f,editorItem:m,parent:g,
sketchOptions:a,snappingManager:h,viewModel:n}),isNested:e,onCommit:async k=>{var {creationInfo:d}=k;if(d){k=k.pendingFeatures.toArray();({layer:d}=d);var x=v._attachmentFileInfos;if(d.capabilities?.editing.supportsGlobalId&&"globalIdField"in d)k=ca(k,d,x),await b(d,k,{globalIdUsed:!0});else{var y=await b(d,{addFeatures:k});0<x.size&&await c(d,ba(k,y?.addFeatureResults??[],d,x))}}}});v._set("steps",this._createWorkflowSteps(v,l));return v}_fadeExistingFeatures(a){if("effect"in a){const b=a.effect;
a.effect="saturate(0.6) opacity(0.8)";return w.makeHandle(()=>a.effect=b)}const c=a.opacity;a.opacity=.7;return w.makeHandle(()=>a.opacity=c)}_highlight(a){const c=this.data.viewModel.view;"3d"===c?.type&&this._highlightHandles.set(a,c.highlight(a))}_removeHighlight(a){B.removeMaybe(this._highlightHandles.get(a));this._highlightHandles.delete(a)}async _startCreating(a){this.removeHandles(A);const {creationInfo:c}=this.data;c&&(this.createFeatureState="create-new",a=await u.startCreatingNewFeature(this._sketchViewModel,
c,a),this.addHandles(a,A))}async _startUpdating(a,c){var {pendingFeatures:b}=this;b.includes(a)||b.add(a);const {_featureFormViewModel:e,_sketchViewModel:f}=this,{creationInfo:g,viewModel:h}=this.data,{attachmentsViewModel:l,layerInfos:n,view:m}=h;if(m&&g){b=g.layer;var v=u.findLayerInfo(n,b);e.set({arcadeEditType:"INSERT",feature:a,formTemplate:v?.formTemplate,spatialReference:m.spatialReference,map:m.map});"add"!==l.mode&&"edit"!==l.mode||h.activeWorkflow?.previous();l.graphic=a;l.fileInfos.removeAll();
l.mode="view";(this._attachmentFileInfos.get(a)||[]).forEach(({file:k,form:d})=>l.addFile(k,d));this._removeHighlight(a);await u.updateGraphicSymbolWhenRequired(a,c,"2d"===m.type?m.scale:null);this.removeHandles(A);B.removeMaybe(this._featureFormHandle);"2d"===m.type&&(v=z.watch(()=>m.scale,k=>this._updateGraphicDebounced(a,c,k)),this.addHandles(v,A));this._featureFormHandle=w.handlesGroup([e.on("value-change",async()=>{a.attributes=e.getValues();await u.updateGraphicSymbolWhenRequired(a,c,"2d"===
m.type?m.scale:null)}),f.on(["update","undo","redo"],k=>{("undo"===k.type||"redo"===k.type||"update"===k.type&&null!=k.toolEventInfo&&u.isTerminalUpdateEventType(k.toolEventInfo.type))&&e.notifyFeatureGeometryChanged()})]);this.createFeatureState="update-pending";this._visualVariableAttributes=u.getVisualVariableAttributes(a);if(!F.isTable(b))return u.startUpdatingFeature({graphic:a,sketchViewModel:f,sourceLayer:b,visualVariables:this._visualVariableAttributes,webStyleCache:c})}}static _createWorkflowSteps(a,
c="awaiting-feature-creation-info"){const {data:b}=a;c=u.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],c,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const {creationInfo:e,viewModel:f}=b,{view:g}=f;g&&(C.isModelUpload(e)?a.addHandles(await C.handleModelUpload({view:g,data:b,next:()=>a.next(),cancel:()=>f.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(b.parent&&e&&(a.addHandles(f.lockFeatureTemplatesViewModel(),
this.id),f.featureTemplatesViewModel.layers=[e.layer]),a.addHandles(f.featureTemplatesViewModel.on("select",({item:h})=>{h&&(b.creationInfo={...b.creationInfo,layer:h.layer,template:h.template},a.next())}),this.id)))},async tearDown(){a.removeHandles([this.id,A])}}),"creating-features":()=>({id:"creating-features",async setUp(){a._isActive&&await a._setUpCreatingFeaturesStep()},async tearDown(e){const {viewModel:f}=b;e.canceled&&(a.removeHandles([E,G,A]),f.attachmentsViewModel.fileInfos.removeAll(),
a._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=b.viewModel,{graphic:f,fileInfos:g}=e;a._attachmentFileInfos.set(f,g.toArray());e.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=b.viewModel,{graphic:f,fileInfos:g}=e;a._attachmentFileInfos.set(f,g.toArray());e.mode=
"view"}})});return u.avoidFeatureTemplateSelectionWithOnlyOneItem(b,c)}static _configureSketchViewModel(a,c){var {data:b}=a;const {creationInfo:e,viewModel:f}=b,{view:g}=f,h=a._sketchViewModel;let l=null;const n=[];if(!g)return w.makeHandle();"2d"===g.type&&e&&n.push(a._fadeExistingFeatures(e.layer));const m=async d=>{if("cancel"===d.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(1>a._lastActiveGraphics.length)return a._startCreating(c);d=a._lastActiveGraphics.pop();
return a._startUpdating(d,c)}if("complete"===d.state&&d.graphic)return a._startUpdating(d.graphic,c)},v=async d=>{var {attachmentsViewModel:x}=f;const {_featureFormViewModel:y}=a;var t=d.graphics[0];if("complete"===d.state){t!==l&&(a._lastActiveGraphics.push(t),a._highlight(t));l=null;const {hasPendingSubtypeChoice:da,submittable:J}=y;if(a.numPendingFeatures===e?.maxFeatures||da||!J)return!J&&y.submit(),d=a._lastActiveGraphics.pop(),a._startUpdating(d,c);"add"!==x.mode&&"edit"!==x.mode||f.activeWorkflow?.previous();
if(d.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}a.addHandles([u.showProgressCursor(g),g.on("click",ea=>ea.preventDefault())],G);await z.whenOnce(()=>!y.updating);a.removeHandles(G);a._startCreating(c)}"start"===d.state&&a._removeHighlight(t);x=a._visualVariableAttributes;await u.visualVariableInteractiveUpdate(g,t,d,x,c);d=t.attributes;const {rotation:K,size:L}=x;null!=K&&({field:t}=K,y.setValue(t,d[t]));null!=L&&({field:t}=L,y.setValue(t,d[t]))},k=async d=>
{if(!C.isModelUpload(e)&&({results:d}=await g.hitTest(d,{include:h.layer}),d=d.find(t=>"graphic"===t.type&&t.graphic.sourceLayer===e?.layer))&&(d=d.graphic,("transform"===h.activeTool||"reshape"===h.activeTool)&&h.updateGraphics.at(0)!==d)){var {submittable:x,hasPendingSubtypeChoice:y}=a._featureFormViewModel;x&&!y&&await a.updatePendingFeature(d,c)}};n.push(h.on("create",d=>a._updatingHandles.addPromise(m(d))),h.on("update",d=>a._updatingHandles.addPromise(v(d))),h.on("delete",d=>{d=d.graphics[0];
a.pendingFeatures.remove(d);H.remove(a._lastActiveGraphics,d);l=d}),g.on("immediate-click",d=>a._updatingHandles.addPromise(k(d)),T.ViewEventPriorities.TOOL),w.makeHandle(()=>{a._preventDefaultActionOnCancel=!0;h.cancel()}),aa(h,b));b=w.handlesGroup(n);h.addHandles(b);return b}_initializeSketchViewModel(){const {data:a}=this,{view:c}=a.viewModel,b=new R({elevationInfo:a.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"});this._sketchViewModel=new Z({layer:b,sketchOptions:a.sketchOptions,
snappingManager:a.snappingManager,updateOnGraphicClick:!1,view:c});c?.map.add(b);this.addHandles(w.makeHandle(()=>{c?.destroyed||c?.map.remove(b);b.destroy()}))}async _setUpCreatingFeaturesStep(){if(!this.hasHandles(E)){var {creationInfo:a,viewModel:c}=this.data,{attachmentsViewModel:b,view:e}=c;if(!e||!a?.layer)throw new O("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");var {initialFeature:f,layer:g}=a,h=this._sketchViewModel,l=new Map,n=[];this._lastActiveGraphics=
[];this._featureFormHandle=B.removeMaybe(this._featureFormHandle);this._visualVariableAttributes={rotation:null,size:null};this.data.editorItem=c.findEditorItemForLayer(a.layer);u.prepareAttachmentsForCreateFeaturesWorkflow(b);n.push(z.watch(()=>b.mode,k=>{switch(k){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}}));var m=u.showProgressCursor(e);n.push(m);var v=F.isTable(a.layer);try{if(v){const k=f??new N({attributes:{...a.template?.prototype.attributes,...a.attributeOverrides},
sourceLayer:g});await this._startUpdating(k,l)}else n.push(D._configureSketchViewModel(this,l)),f?(h.layer.add(f),await this._startUpdating(f,l)):await this._startCreating(l)}finally{m.remove()}l=w.makeHandle(()=>this.pendingFeatures.drain(k=>h.layer.remove(k)));m=z.watch(()=>e?.timeZone,k=>this._featureFormViewModel.timeZone=k,z.initial);v=w.makeHandle(()=>{C.isModelUpload(a)&&c.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&n.push(this._featureFormHandle);this.addHandles(n,this._handleKeys.beforeCommit);
this.addHandles([w.makeHandle(()=>b.fileInfos.removeAll()),w.handlesGroup(n),v,l,m],E)}}};q.__decorate([r.property()],p.prototype,"createFeatureState",void 0);q.__decorate([r.property()],p.prototype,"data",void 0);q.__decorate([r.property({constructOnly:!0})],p.prototype,"isNested",void 0);q.__decorate([r.property()],p.prototype,"featureFormViewModel",null);q.__decorate([r.property()],p.prototype,"hasPendingEdits",null);q.__decorate([r.property()],p.prototype,"_getDrawMeshHelpMessage",void 0);q.__decorate([r.property()],
p.prototype,"helpMessage",null);q.__decorate([r.property()],p.prototype,"layer",null);q.__decorate([r.property()],p.prototype,"parent",null);q.__decorate([r.property()],p.prototype,"parentLayer",null);q.__decorate([r.property()],p.prototype,"keyboardCancellationEnabled",null);q.__decorate([r.property()],p.prototype,"reliesOnOwnerAdminPrivileges",null);q.__decorate([r.property()],p.prototype,"shouldShowAttachments",null);q.__decorate([r.property()],p.prototype,"shouldAllowAttachmentEditing",null);
q.__decorate([r.property()],p.prototype,"sketchViewModel",null);return p=D=q.__decorate([Q.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],p)});
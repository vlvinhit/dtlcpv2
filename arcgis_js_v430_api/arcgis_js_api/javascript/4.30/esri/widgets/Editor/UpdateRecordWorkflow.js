// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../core/Error ../../core/handleUtils ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../support/featureFlags ../../views/draw/support/HighlightHelper ./UpdateRecordWorkflowData ./Workflow ./workflowUtils ../FeatureForm/FeatureFormViewModel".split(" "),function(d,h,r,l,t,p,k,A,B,C,u,q,v,w,x,y,z){var m;const n=
{exit:Symbol()};d.UpdateRecordWorkflow=m=class extends x{constructor(a){super(a);this.fullFeature=this._highlightHelper=null;this.type="update-table-record"}initialize(){const {data:a}=this;var {edits:b}=a;const {view:e}=a.viewModel;b=b.feature;const c=new AbortController;this.addHandles(l.abortHandle(c));this._updatingHandles.addPromise(y.fetchFullFeature(b,a.viewModel.view.spatialReference,c.signal).then(f=>{t.isAborted(c)||(this._onFullFeatureLoaded(f),this._initializeFeatureFormViewModel())},
f=>this.cancel({force:!0,error:new r("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:f}})})));e&&(this._highlightHelper=new v({view:e}),this.addHandles(l.makeHandle(()=>this._highlightHelper?.removeAll())))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const a=
this.editorItem.capabilities;return a.update.reliesOnOwnerAdminPrivileges||a.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){this.data.edits.stageDelete();return this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(a){this.removeHandles(n.exit)}async start(){await super.start();return null}_configureAttachmentsViewModel(){const {data:a,fullFeature:b}=this,{attachmentsCapabilities:e,viewModel:c}=a,{attachmentsViewModel:f}=c;f.set({capabilities:e,graphic:b,filesEnabled:!1,
mode:"view"});this.addHandles([l.makeHandle(()=>f.fileInfos.removeAll()),p.watch(()=>f.mode,g=>{switch(g){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}})],n.exit)}_initializeFeatureFormViewModel(){const {edits:a,formTemplate:b,viewModel:{view:e}}=this.data,c=this._featureFormViewModel=new z({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:b,highlightHelper:this._highlightHelper,map:e?.map,spatialReference:e.spatialReference,timeZone:e?.timeZone});
c.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:g=>c.relationshipId=g.relationshipId};const {initialFeature:f}=a;f&&c.overrideInitialFeature(f);this.addHandles([c.on("value-change",()=>{a.updateAttributes(c.getValues());this.fullFeature.attributes=a.feature.attributes}),p.watch(()=>e?.timeZone,g=>c.timeZone=g)])}_onFullFeatureLoaded(a){this.fullFeature=a;const {edits:b}=this.data;b.updateAttributes(a.attributes);b.trackChanges()}static async create(a){a=new m({data:await w.create(a),
onCommit:this._onCommitFactory(a.applyEdits)});a._set("steps",this._createWorkflowSteps(a));return a}static _createWorkflowSteps(a){const {attachmentsViewModel:b}=a.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){b.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){b.mode="view"}}]}};d.UpdateRecordWorkflow._onCommitFactory=a=>async b=>{({edits:b}=b);const {feature:e}=b;if(e){var c=e.sourceLayer,
f=e.clone();if(!b.attributesModified||b.stagedForDelete){var g=c.objectIdField;f.attributes={[g]:e.getAttribute(g)};q.sceneLayerEditingEnabled()&&q.i3sPatchingEnabled()&&"scene"===c.type&&null!=c.infoFor3D&&(g=c.associatedLayer?.globalIdField,null!=g&&f.setAttribute(g,e.getAttribute(g)))}if(!b.geometryModified||b.stagedForDelete)f.geometry=null;await a(c,{[b.stagedForDelete?"deleteFeatures":"updateFeatures"]:[f]})}};h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"editorItem",null);h.__decorate([k.property()],
d.UpdateRecordWorkflow.prototype,"featureFormViewModel",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"fullFeature",void 0);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"hasPendingEdits",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"layer",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"parent",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"parentLayer",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,
"shouldShowAttachments",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"shouldAllowAttachmentEditing",null);h.__decorate([k.property()],d.UpdateRecordWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null);d.UpdateRecordWorkflow=m=h.__decorate([u.subclass("esri.widgets.Editor.UpdateRecordWorkflow")],d.UpdateRecordWorkflow);d.handleKeys=n;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
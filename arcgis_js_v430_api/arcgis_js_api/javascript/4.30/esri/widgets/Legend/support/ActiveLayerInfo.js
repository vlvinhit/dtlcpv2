// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/tslib.es6 ../../../Color ../../../intl ../../../kernel ../../../request ../../../symbols ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/jsonMap ../../../core/Logger ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/screenUtils ../../../core/sql ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/PropertyOrigin ../../../layers/effects/EffectView ../../../layers/effects/jsonUtils ../../../layers/support/ExportImageParameters ../../../layers/support/layerUtils ../../../layers/support/rasterFormats/pixelRangeUtils ../../../renderers/support/jsonUtils ../../../renderers/support/rendererConversion ../../../renderers/visualVariables/SizeVariable ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../smartMapping/renderers/support/referenceSizeUtils ../../../symbols/support/cimSymbolUtils ../../../symbols/support/previewUtils ../../../symbols/support/renderUtils ../../../symbols/support/symbolUtils ../../../symbols/support/utils ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils ../../smartMapping/support/utils ../../../symbols/SimpleMarkerSymbol ../../../symbols/SimpleFillSymbol ../../../intl/messages ../../../intl/substitute".split(" "),
function(ua,w,ha,t,va,ia,fb,wa,M,xa,ya,C,za,z,Aa,Ba,Ca,y,gb,Da,N,Ea,Fa,Ga,Ha,ja,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,D,Qa,Ra,O,Sa,ka,Y,B,Ta,P,la,Ua,Va){function H(a){return"esri.renderers.SimpleRenderer"===a.declaredClass}function G(a){return"esri.renderers.ClassBreaksRenderer"===a.declaredClass}function Q(a){return"esri.renderers.UniqueValueRenderer"===a.declaredClass}function ma(a){return"esri.renderers.HeatmapRenderer"===a.declaredClass}function Z(a){return"esri.renderers.PointCloudClassBreaksRenderer"===a.declaredClass}
function aa(a){return"esri.renderers.PointCloudStretchRenderer"===a.declaredClass}function ba(a){return"esri.renderers.PointCloudUniqueValueRenderer"===a.declaredClass}function na(a){return"esri.renderers.DotDensityRenderer"===a.declaredClass}function oa(a){return"esri.renderers.PieChartRenderer"===a.declaredClass}function ca(a){return"esri.layers.SubtypeGroupLayer"===a.declaredClass}function da(a){return"esri.layers.MapImageLayer"===a.declaredClass}function Wa(a){a="authoringInfo"in a?a?.authoringInfo:
null;return"univariate-color-size"===a?.type&&"above-and-below"===a?.univariateTheme}async function E(a,b){const c=await Ua.fetchMessageBundle("esri/widgets/Legend/t9n/Legend");"previewTemplateAriaLabel"!==a||b||(a="previewAriaLabel");return Va.substitute(c[a],{label:b})}const U=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Xa=new ya.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),
V=new P({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ya=new la({style:"solid"}),Za=new P({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let I={};t=class extends wa{constructor(a){super(a);this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._webStyleSymbolCache=new Map;this._dotDensityUrlCache=new Map;this._scaleDrivenSizeVariable=null;this._hasClusterSizeVariable=!1;this._layerDefinitionExpressionClause=null;this.children=new xa;
this.layer=this.layerView=null;this.legendElements=[];this.parent=null;this.respectLayerDefinitionExpression=this.keepCacheOnDestroy=this.hideLayersNotInCurrentView=!1;this.respectLayerVisibility=!0;this.sublayerIds=[];this.view=this.title=null}initialize(){const a=()=>this.notifyChange("ready");this.addHandles([z.on(()=>this.children,"change",b=>{const {added:c,removed:d}=b;c.forEach(e=>{const f=`activeLayerInfo-ready-watcher-${e.layer.uid}`;this.addHandles(z.watch(()=>e.ready,a,z.initial),f)});
d.forEach(e=>this.removeHandles(e.layer.uid));a()})]);this.keepCacheOnDestroy||(I={})}destroy(){this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=null;this.keepCacheOnDestroy||(I=null);this._layerDefinitionExpressionClause=null}get effectList(){const a=this.layer;let b=null;"effect"in a&&a.effect&&(b=new Ea.EffectView,b.effect=a.effect,b.endTransitions(),b.scale=this.scale);return b}get opacity(){const a=this.layer.opacity,b=this.parent?.opacity;var c=this.layer.parent;
c=c&&"uid"in c?this._getParentLayerOpacity(c):null;return null!=b?b*a:null!=c?c*a:a}get ready(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length}get scale(){return this.view?.scale??0}get isScaleDriven(){const a=this.layer;if(null===a)return!1;if("effect"in a&&a.effect&&Array.isArray(a.effect))return!0;if("featureReduction"in a&&a.featureReduction){if("cluster"===a.featureReduction.type)return!0;if("binning"===a.featureReduction.type&&"renderer"in
a.featureReduction&&a.featureReduction.renderer)return this._isRendererScaleDriven(a.featureReduction.renderer)}return"renderer"in a&&a.renderer?this._isRendererScaleDriven(a.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(a){if(this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())this.legendElements=[],this.notifyChange("ready");else{a=Array.from(a,b=>{if(Ha.isFeatureLayer(b))return this._getRendererLegendElements(b.renderer,
{title:b.title});if(b.featureSet?.features.length){var c=b.layerDefinition,d=c?.drawingInfo;d=d&&Ia.fromJSON(d.renderer);c=Xa.read(c.geometryType);return d?this._getRendererLegendElements(d,{title:b.name,geometryType:c}):(C.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const b=[],c=await Promise.allSettled(a);for(const d of c)if("fulfilled"===d.status)for(const e of d.value??[])b.push(e);this.legendElements=b;this.notifyChange("ready")}catch(b){C.getLogger(this).warn("error while building legend for layer!",
b)}}}async buildLegendElementsForRenderer(a){try{this.legendElements=(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getRendererLegendElements(a):[],this.notifyChange("ready")}catch(b){C.getLogger(this).warn("error while building legend for layer!",b)}}async buildLegendElementsForFeatureReduction(a){try{this.legendElements=(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getLegendElementsForFeatureReduction(a):[],this.notifyChange("ready")}catch(b){C.getLogger(this).warn("error while building legend for layer!",
b)}}async buildLegendElementsForTools(){const a=this.layer;if("esri.layers.VoxelLayer"===a.declaredClass)this._constructLegendElementsForVoxelLayer();else if("esri.layers.WMTSLayer"===a.declaredClass)this._constructLegendElementsForWMTSlayer();else if("esri.layers.WMSLayer"===a.declaredClass)await this._constructLegendElementsForWMSSublayers();else if("esri.layers.BuildingSceneLayer"===a.declaredClass)await this._constructLegendElementsForBuildingSceneLayer();else if(da(a)||"esri.layers.TileLayer"===
a.declaredClass||ca(a))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");var b="default";if("esri.layers.ImageryLayer"===a.declaredClass){b=a?.rasterFunction?.functionName||"default";const c=a.bandIds?.length?a.bandIds.join(""):"###";b=b+"_"+c}"esri.layers.ImageryTileLayer"!==a.declaredClass&&await this._getLegendLayers(`${a.uid}-${b}`).then(async c=>{this.legendElements=[];this.notifyChange("ready");c=c.map(async d=>{if("esri.layers.ImageryLayer"===
a.declaredClass){const e=z.watch(()=>["renderingRule"in a&&a.rasterFunction,a.bandIds],()=>za.debounce(async()=>{I["default"]=null;a.renderer?await this.buildLegendElementsForRenderer(a.renderer):await this.buildLegendElementsForTools()})());this.addHandles(e,"imageryLayers-watcher")}d=this._generateSymbolTableElementForLegendLayer(d);d?.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(d.title=a.title),this.legendElements.push(d));this.notifyChange("ready")});await Promise.allSettled(c)}).catch(c=>
{C.getLogger(this).warn("Request to server for legend has failed!",c)})}}async _isLayerInCurrentView(){const a=this.layer,b=this.layerView,c=b&&"createQuery"in b&&"queryFeatureCount"in b;if(!(c||b&&"createQuery"in a&&"queryFeatureCount"in a))return!0;await z.whenOnce(()=>!b.updating);const d=c?"createQuery"in b&&b.createQuery():"createQuery"in a&&a.createQuery();if(!d)return!0;d.geometry=this.view.extent;return 0!==(c?"queryFeatureCount"in b&&await b.queryFeatureCount(d):"queryFeatureCount"in a&&
await a.queryFeatureCount(d))}_getParentLayerOpacity(a){let b=1;const c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));return a.opacity*b}_isGroupActive(){return this.children.some(a=>a.ready)}_isRendererScaleDriven(a){return"dot-density"===a.type||U.test("valueExpression"in a?a.valueExpression:null)||("visualVariables"in a?a.visualVariables:null)?.some(b=>this._isScaleDrivenSizeVariable(b))?!0:this._hasScaleDrivenSymbols(a)}_hasScaleDrivenSymbols(a){switch(a.type){case "simple":return this._isScaleDrivenSymbol(a.symbol);
case "class-breaks":return this._isScaleDrivenSymbol(a.defaultSymbol)||a.classBreakInfos.some(b=>this._isScaleDrivenSymbol(b.symbol));case "unique-value":return this._isScaleDrivenSymbol(a.defaultSymbol)||!!a.uniqueValueInfos?.some(b=>this._isScaleDrivenSymbol(b.symbol))}return!1}_isScaleDrivenSymbol(a){if("cim"===a?.type){const {primitiveOverrides:b,minScale:c,maxScale:d}=a.data;a=b?.some(e=>/\$view\.scale/.test(e.valueExpressionInfo?.expression||""))??!1;return null!=c||null!=d||a}return!1}_isScaleDrivenSizeVariable(a){if(a&&
"size"!==a.type)return!1;const b=a.minSize,c=a.maxSize;return"object"===typeof b&&b&&this._isScaleDrivenSizeVariable(b)||"object"===typeof c&&c&&this._isScaleDrivenSizeVariable(c)?!0:U.test(a.valueExpression)}_isLayerScaleDriven(a){if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&a.sublayers)return a.sublayers.some(c=>this._isLayerScaleDriven(c));const b=a.parent;if(!1===a.loaded&&b&&da(b)&&"source"in a&&a.source&&"map-layer"===a.source.type)for(const c of b.sourceJSON.layers??
[])if(c.id===a.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1}async _constructLegendElementsForVoxelLayer(){this.legendElements=[];this.removeHandles("voxel-style-watcher");this.removeHandles("voxel-current-variable");const a=this.layer;this.addHandles(z.watch(()=>a.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable");this.addHandles(z.watch(()=>a.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");
var b=a.getVariableStyle(null);const c=[];if(b)if(b.uniqueValues?.length){const e=[];b.uniqueValues.forEach(f=>{f.enabled&&e.push({label:f.label||`${f.value}`,value:f.value,symbol:new la({color:f.color,outline:null})})});e.length&&c.push({type:"symbol-table",title:b.label,infos:e})}else if(b.transferFunction){const {colorStops:e,stretchRange:f}=b.transferFunction,h=e.toArray().reverse(),g=f.map((v,m)=>`${0===m?B.specialCharsLessThan:B.specialCharsGreaterThan} ${Ta.formatNumberLabel(v)}`).reverse(),
n=h.map(v=>({color:v.color,value:null,label:null}));n[0].label=g[0];n[n.length-1].label=g[1];c.push({type:"color-ramp",title:b.label,infos:n,preview:D.renderColorRampPreviewHTML(h.map(v=>v.color),{ariaLabel:await E("previewColorRampAriaLabel")})})}const d=a.opacity;b=c.reduce((e,f)=>[...e,...this._getAllInfos(f)],[]).filter(e=>!!e?.symbol).map(e=>this._getSymbolPreview(e,d));await Promise.allSettled(b);this.legendElements=c;this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=
[];this.removeHandles("wmts-activeLayer-watcher");const a=this.layer.activeLayer;this.addHandles(z.watch(()=>{const {layer:c}=this;return c&&"activeLayer"in c&&c.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");const b=a.styleId?a.styles?.find(({id:c})=>c===a.styleId)?.legendUrl:void 0;b&&(this.legendElements=[{type:"symbol-table",title:a.title,infos:[{src:b,opacity:this.opacity}]}]);this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=
[];this.removeHandles("wms-sublayers-watcher");const a=this.layer;let b=null;if(a.customParameters||a.customLayerParameters)b={...a.customParameters,...a.customLayerParameters};this.addHandles(z.watch(()=>{const {layer:c}=this;return c&&"sublayers"in c&&c.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");this.legendElements=await this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(a,
b){const c=this.layer,d=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const e=this.sublayerIds?.map(f=>c.findSublayerById(f))?.filter(M.isSome)??[];a=e.length?e:a.toArray();for(const f of a)if(a=z.watch(()=>[f.title,f.visible,f.legendEnabled],()=>this._constructLegendElementsForWMSSublayers()),this.addHandles(a,"wms-sublayers-watcher"),!this.respectLayerVisibility||f.visible&&f.legendEnabled)a=await this._generateSymbolTableElementForWMSSublayer(f,
b),a?.infos.length&&d.unshift(a);return d}async _generateSymbolTableElementForWMSSublayer(a,b){return!a.legendUrl&&a.sublayers?(b=(await this._generateLegendElementsForWMSSublayers(a.sublayers,b)).filter(c=>c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)}async _generateSymbolTableElementForLegendUrl(a,b){let c=a.legendUrl;if(c){var d={type:"symbol-table",title:a.title||a.name||String(a.id??""),infos:[]};b&&(c=Ca.addQueryParameters(c,b));b=null;a=a.layer?.opacity;
try{if(b=(await ia(c,{responseType:"image"})).data)b.style.opacity=a}catch{}d.infos.push({src:c,preview:b,opacity:a});return d}}_getLegendLayers(a,b){const c=I&&I[a];return c?Promise.resolve(c):this._legendRequest(b).then(d=>{d=d.layers;return I[a]=d})}_legendRequest(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=b.exportImageServiceParameters.rasterFunction;c&&(a.renderingRule=JSON.stringify(c.functionDefinition?.toJSON()||c.toJSON()));b.bandIds&&
(a.bandIds=b.bandIds.join());if(b.raster||b.viewId||b.customParameters){const {raster:d,viewId:e,customParameters:f}=b;a={raster:d,viewId:e,...a,...f}}}c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=+b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue");return ia(c,{query:a}).then(d=>
d.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;this.addHandles(z.watch(()=>a.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){C.getLogger(this).warn("Request to server for legend has failed!",b)}}async _generateLegendElementsForBuildingSublayers(a,
b){let c=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");a=a.toArray();for(const e of a)if(a=z.watch(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer()),this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){a=null!=e?.opacity?e.opacity:null;var d=null!=a?a*b:b;"building-group"===e.type?(a={type:"symbol-table",title:e.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(e.sublayers,
d),a.infos.push(...d),c=[a,...c]):e.renderer&&(c=[...(await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:d,sublayer:e})),...c])}return c.filter(e=>!!e&&("infos"in e&&e.infos?0<e.infos.length:!0))}async _constructLegendElementsForSublayers(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;if(da(a)||"esri.layers.TileLayer"===a.declaredClass||ca(a)){this.addHandles(z.watch(()=>a.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");
try{this.legendElements=await this._generateLegendElementsForSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){C.getLogger(this).warn("Request to server for legend has failed!",b)}}}async _generateLegendElementsForSublayers(a,b,c){const d=this.layer;let e=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");a=a.toArray();!c&&this.sublayerIds&&this.sublayerIds.length&&(a=ca(d)?this.sublayerIds.map(f=>d.findSublayerForSubtypeCode(f)).filter(M.isSome):
this.sublayerIds.map(f=>d.findSublayerById(f)).filter(M.isSome));for(const f of a)if(a=z.watch(()=>[f.renderer,f.opacity,f.title,f.visible,f.legendEnabled],()=>this._constructLegendElementsForSublayers()),this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||f.visible&&f.legendEnabled&&this._isSublayerInScale(f)){a=null!=f?.opacity?f.opacity:null;a=null!=a?a*b:b;const h="sublayers"in f?f.originIdOf("renderer")>N.OriginId.SERVICE&&!f.sublayers:!0;f.renderer&&h?(await f.load(),e=[...(await this._getRendererLegendElements(f.renderer,
{title:f.title,opacity:a,sublayer:f})),...e]):"sublayers"in f&&(a=await this._generateSymbolTableElementForSublayer(f,a,c))&&e.unshift(a)}return e.filter(f=>!!f&&("infos"in f&&f.infos?0<f.infos.length:!0))}async _generateSymbolTableElementForSublayer(a,b,c){if(!c){c=new Map;var d=this.layer,e=a.source;let f=null;if(e&&("map-layer"!==e.type||e.mapLayerId!==a.id||e.gdbVersion&&e.gdbVersion!==("gdbVersion"in d&&d.gdbVersion))||a.originIdOf("renderer")>N.OriginId.SERVICE||a.originIdOf("labelingInfo")>
N.OriginId.SERVICE||a.originIdOf("labelsVisible")>N.OriginId.SERVICE)e=new Ga.ExportImageParameters({layer:this.layer}),f=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy();(await this._getLegendLayers(f||`${d.uid}-default`,f)).forEach(h=>c.set(h.layerId,h))}d=c.get(a.id);return(!d||d?.subLayerIds&&d.defaultVisibility)&&a.sublayers?(b=await this._generateLegendElementsForSublayers(a.sublayers,b,c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,b)}_generateSymbolTableElementForLegendLayer(a,
b,c){if(!a?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var d=b?.renderer;let e=b?.title||a.layerName;d&&(!b||b?.originIdOf("renderer")>N.OriginId.SERVICE)&&(d=b?.title||this._getRendererTitle(d,b))&&(e&&"string"!==typeof d&&"title"in d&&(d.title=e),e=d);const f={type:"symbol-table",title:e,legendType:a.legendType||null,infos:[]},h=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;a.legendGroups&&0<a.legendGroups.length?a.legendGroups.forEach(g=>
{const n={type:"symbol-table",title:g.heading,legendType:a.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(h.filter(v=>v.groupId===g.id),a.layerId,c)};0<n.infos?.length&&f.infos.push(n)}):f.infos=this._generateSymbolTableElementInfosForLegendLayer(h,a.layerId,c);return 0<f.infos.length?f:null}_generateSymbolTableElementInfosForLegendLayer(a,b,c){return a.map(d=>{let e=d.url;if(d.imageData&&0<d.imageData.length)e=`data:image/png;base64,${d.imageData}`;else if(0!==e.indexOf("http"))e=
va.addTokenParameter(`${this.layer.url}/${b}/images/${e}`);else return null;return{label:d.label,src:e,opacity:null==c?this.opacity:c,width:d.width,height:d.height}}).filter(M.isSome)}_isSublayerInScale(a){const b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0}_isLegendLayerInScale(a,b){b=b||this.layer;let c=null,d=null,e=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=
b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)e=!1;return e}_sanitizeLegendForSublayer(a,b){if("version"in this.layer&&10.1>+this.layer.version||0===a.length)return a;b=b.renderer;let c=0,d=null;a.some(e=>e.values)&&a.some((e,f)=>{e.values||(c=f,d=e,d.label||(d.label="others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===
b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a}async _getRendererLegendElements(a,b={}){var c=this.view;c=H(a)||G(a)||Q(a)||ma(a)||na(a)||oa(a)?"2d"===c.type||Ja.isSupportedRenderer3D(a):"raster-stretch"===a.type||"raster-colormap"===a.type||"raster-shaded-relief"===a.type||Z(a)||aa(a)||ba(a)||"vector-field"===a.type||"flow"===a.type;if(!c)return C.getLogger(this).warn(`Renderer of type '${a.type}' not supported!`),[];if(Z(a)||aa(a)||ba(a)||"esri.renderers.PointCloudRGBRenderer"===
a.declaredClass)return this._constructPointCloudRendererLegendElements(a,b);if(na(a))return this._constructDotDensityRendererLegendElements(a);a=await this._loadRenderer(a);return oa(a)?this._constructPieChartRendererLegendElements(a):this._constructRendererLegendElements(a,b)}async _getLegendElementsForFeatureReduction(a){let b=null;"binning"===a.type?b=a.renderer:"cluster"===a.type&&(b=this._getClusterRenderer(a));return b?this._getRendererLegendElements(b):[]}_getPointCloudRendererTitle(a){return(a.legendOptions?.title||
a.field)??""}async _constructPointCloudRendererLegendElements(a,b={}){var c=b.title;b=[];let d=null;var e=null;if(Z(a))d={type:"symbol-table",title:c||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(f=>{d.infos.unshift({label:f.label||f.minValue+" - "+f.maxValue,value:[f.minValue,f.maxValue],symbol:this._getAppliedCloneSymbol(V,f.color)})});else if(aa(a)){e=a.stops;let f=null;if(e?.length&&(1===e.length&&(f=e[0].color),!f)){const h=e[0].value,g=e[e.length-1].value;null!=
h&&null!=g&&(f=O.getColorFromPointCloudStops(h+(g-h)/2,e))}d={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(V,f||V.color)}]};e=O.getRampStopsForPointCloud(a.stops??[])??[];e={type:"color-ramp",title:c||this._getPointCloudRendererTitle(a),infos:e,preview:D.renderColorRampPreviewHTML(e.map(h=>h.color),{ariaLabel:await E("previewColorRampAriaLabel")})}}else ba(a)&&(d={type:"symbol-table",title:c||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos?.forEach(f=>
{d.infos.push({label:f.label||f.values.join(", "),value:f.values.join(", "),symbol:this._getAppliedCloneSymbol(V,f.color)})}));d?.infos.length&&b.push(d);e?.infos.length&&b.push(e);c=b.reduce((f,h)=>[...f,...(h.infos??[])],[]).filter(f=>!!f.symbol).map(f=>this._getSymbolPreview(f,this.opacity,{symbolConfig:{applyColorModulation:!!a.colorModulation}}));await Promise.allSettled(c);return b}async _getElementInfoForDotDensity(a,b){const {color:c,label:d,valueExpressionTitle:e}=b,{backgroundColor:f,outline:h,
dotSize:g}=a;b=this.effectList?.effects.map(m=>m.toJSON());var n=Fa.effectFunctionsFromJSON(b);b=await E("previewTemplateAriaLabel",d||e);n=g+"-"+c+"-"+f+"-"+(h&&JSON.stringify(h.toJSON()))+"-"+n;const v=this._dotDensityUrlCache;a=v.has(n)?v.get(n):D.renderDotDensityPreviewHTML(a,c,{ariaLabel:b});v.set(n,a);b=Pa.renderSymbol([[{shape:{type:"image",x:0,y:0,width:a.width,height:a.height,src:a.src},fill:null,stroke:null,offset:[0,0]}]],[a.width,a.height],{effectView:this.effectList,ariaLabel:b});return{opacity:1,
src:a.src,preview:b,width:a.width,height:a.height}}async _constructDotDensityRendererLegendElements(a){var b=a.calculateDotValue(this.view.scale);b={type:"symbol-table",title:{value:b&&Math.round(b),unit:a.legendOptions?.unit||""},infos:[]};for(const c of a.attributes){const d=await this._getElementInfoForDotDensity(a,c);d.label=c.label||c.valueExpressionTitle||c.field;b.infos.push(d)}return[b]}async _constructPieChartRendererLegendElements(a){const b=this.layer.opacity,c=[];let d=null;const e=a.outline;
a.attributes.forEach(g=>{const n=new P({color:g.color,outline:e});c.push({label:g.label||g.valueExpressionTitle||g.field,symbol:n})});var f=c.length?[...c]:[];if(a.othersCategory?.color&&0!==a.othersCategory?.threshold){var h=new P({color:a.othersCategory.color,outline:e});d=a.othersCategory.label||"Other";c.push({label:d,symbol:h})}a.defaultColor?.a&&(h=new P({color:a.defaultColor,outline:e}),c.push({label:a.defaultLabel,symbol:h}));h=await this._getVisualVariableLegendElements(a,this.layer)||[];
c.length&&(h.unshift({type:"symbol-table",title:null,infos:c}),f=f.filter(g=>g.label!==d).map(g=>g.symbol.color).filter(Boolean),f=D.renderPieChartPreviewHTML(f,{holePercentage:a.holePercentage,backgroundColor:a.backgroundFillSymbol?.color,effectList:this.effectList,outline:e,ariaLabel:await E("previewPieChartAriaLabel")}),h.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(a,this.layer),infos:c,preview:f}));a=h.reduce((g,n)=>[...g,...this._getAllInfos(n)],[]).filter(g=>!!g?.symbol&&!g?.preview).map(g=>
this._getSymbolPreview(g,b,{effectList:this.effectList}));await Promise.allSettled(a);return h}async _constructRendererLegendElements(a,b={}){const {title:c,sublayer:d}=b,e=d||this.layer,f=B.getReferenceSizeAuthoringInfoVisualVariable(a);"definitionExpression"in e&&e.definitionExpression&&!this._layerDefinitionExpressionClause&&this.respectLayerDefinitionExpression&&(this._layerDefinitionExpressionClause=await Ba.parseWhereClause(e.definitionExpression,e.fieldsIndex));this._hasSizeRamp=this._hasOpacityRamp=
this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const h=await this._getVisualVariableLegendElements(a,e)||[],g={type:"symbol-table",title:c||this._getRendererTitle(a,e),infos:[]};let n=null,v=!1;const m=new Set;if("flow"!==a.type||this._hasSizeRamp)if("univariate-color-size"===("authoringInfo"in a?a?.authoringInfo:null)?.type){var k=c,q=Wa(a)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",r=h.findIndex(l=>"color-ramp"===l.type);r=-1!==r?h.splice(r,1)[0]:null;var p=h.findIndex(l=>
"size-ramp"===l.type);p=-1!==p?h.splice(p,1)[0]:null;var A=[];r&&(k=r.title,A.push(r));p&&(k=p.title,A.push(p));0<A.length&&h.push({type:q,title:k,infos:A})}else if(ma(a))k=Sa.getHeatmapRampStops(a),h.push({type:"heatmap-ramp",title:c||this._getRendererTitle(a,e),infos:k,preview:D.renderColorRampPreviewHTML(k.map(l=>l.color),{effectList:this.effectList,ariaLabel:await E("previewColorRampAriaLabel")})});else if(Q(a)){if((q=a&&a.authoringInfo)&&"relationship"===q.type){const {numClasses:l,field1:u,
field2:x}=q;q=q.focus;if(l&&u&&x){p=[u,x];r=ka.getRotationAngleForFocus(q)||0;for(k of p){const {field:R,normalizationField:S,label:W}=k;p=W||{field:this._getFieldAlias(R,e),normField:S&&this._getFieldAlias(S,e)};A=Za.clone();A.angle=r;g.infos.push({label:p,symbol:A});m.add(A);r+=90}k=ka.getRelationshipRampElement({focus:q,numClasses:l,infos:a.uniqueValueInfos??[]});h.unshift(k)}}else if("esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass){const {field:l,
field2:u}=a;a.uniqueValueInfos?.forEach(x=>{x.symbol&&(l&&this._checkDefinitionExpression(l,x.value)||u)&&g.infos.push({label:x.label||x.value,value:x.value,symbol:x.symbol})})}else{const {field:l,field2:u,field3:x,fieldDelimiter:R,valueExpression:S,defaultSymbol:W}=a,$a=!(!l&&!S||!u&&!x),J=[];a.uniqueValueGroups?.forEach(pa=>{const ea={type:"symbol-table",title:pa.heading,infos:[]};pa.classes?.forEach(K=>{const {symbol:qa,values:ab}=K;if(qa){var L=[],F=[];for(const bb of ab??[]){const {value:ra,
value2:sa,value3:ta}=bb,T=[],X=[];if(l||S)T.push(ra),X.push(this._getDomainName(l,ra,e));u&&(T.push(sa),X.push(this._getDomainName(u,sa,e)));x&&(T.push(ta),X.push(this._getDomainName(x,ta,e)));L.push($a?T.join(R||""):T[0]);F.push(X.join(" - "))}L=L.join(", ");K=K.label;K||(F=F.filter(Boolean),K=F.length?F.join(", "):L);F=qa.clone();"cim"===F.type&&f&&Ma.updateReferenceSizeSymbol(F,{innerDotSize:8,outerRingSize:16});(this._checkDefinitionExpression(l,L)||u)&&ea.infos.push({label:K,value:L,symbol:F})}});
ea.infos.length&&J.push(ea)});J.length&&(k=J[0],1===J.length&&"title"in k&&!k.title?g.infos.push(...(k.infos??[])):(W&&(J.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:W}]}),v=!0),g.infos.push(...J)),c||a.legendOptions?.title||a.valueExpressionTitle||(g.title=null))}a.defaultSymbol&&!v&&(g.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),v=!0)}else if(G(a)){if(!f){n=this._isUnclassedRenderer(a);if(!n||!this._hasSizeRamp){k=a.classBreakInfos.filter(({symbol:l})=>
l);for(const {label:l,minValue:u,maxValue:x,symbol:R}of k)g.infos.unshift({label:l||(n?null:`${u} - ${x}`),value:[u,x],symbol:R});n&&(g.title=null);this._updateInfosForClassedSizeRenderer(a,g.infos)}a.defaultSymbol&&!n&&(g.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),v=!0)}}else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)k=await this._constructTileImageryStretchRendererElements(a),
"stretch-ramp"===k.type?h.push(k):g.infos=k;else{k=this.layer;a.statistics?.length&&(r=a.statistics[0],B.isRasterBandStatistics(r)?(q=r.min,r=r.max):[q,r]=r);p=[];p=k.serviceRasterInfo;if(k.rasterFunction)try{p=await k.generateRasterInfo(k.rasterFunction)}catch{}A=ja.getPixelValueRange(p.pixelType);if(1===p.bandCount)k=k.bandIds?.[0]||0,q=null!=q?q:p.statistics?p.statistics[k].min:A[0],r=null!=r?r:p.statistics?p.statistics[k].max:A[1],q||r?h.push(await this._getStretchLegendElements(a,{min:q,max:r})):
this._getServerSideLegend();else if(k.bandIds&&1===k.bandIds.length)q=null!=q?q:p.statistics?p.statistics[k.bandIds[0]].min:A[0],r=null!=r?r:p.statistics?p.statistics[k.bandIds[0]].max:A[1],q||r?h.push(await this._getStretchLegendElements(a,{min:q,max:r})):this._getServerSideLegend();else if(3<=p.bandCount){const {bandInfos:l}=p;({bandIds:q}=k);l.length>=p.bandCount?3===q?.length?(p=q.map(u=>l[u].name),g.infos=this._createSymbolTableElementMultiBand(p)):"lerc"===k.format?(p=[0,1,2].map(u=>l[u].name),
g.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():"lerc"===k.format?(p=["band1","band2","band3"],g.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend()}else this._getServerSideLegend()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(l=>{g.infos.push({label:l.label,value:l.value,symbol:this._getAppliedCloneSymbol(Ya,l.color)})});else if(H(a)){k=a.symbol;switch(b.geometryType){case "point":k="pointSymbol"in e?e.pointSymbol:null;break;
case "polyline":k="lineSymbol"in e?e.lineSymbol:null;break;case "polygon":k="polygonSymbol"in e?e.polygonSymbol:null}q=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;a.symbol&&q&&g.infos.push({label:a.label,symbol:k})}else"vector-field"===a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+")"),g.title=a.attributeField,k=a.getClassBreakInfos(),k?.length?k.forEach(l=>{g.infos.push({label:l.minValue+" - "+l.maxValue,symbol:l.symbol})}):g.infos.push({label:a.attributeField,
symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&h.push(await this._getStretchLegendElements(a,{min:0,max:255}));else k=await B.getSymbolForFlowRenderer(a),g.infos.push({label:null,symbol:k});const fa=a.defaultSymbol;!fa||v||H(a)||n&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||h.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:fa}]});g.infos.length&&h.unshift(g);const cb=null==b.opacity?this.opacity:b.opacity,db=this._isTallSymbol("visualVariables"in
a?a.visualVariables:null),eb="esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass;b=h.reduce((l,u)=>[...l,...this._getAllInfos(u)],[]).filter(l=>!!l?.symbol).filter(l=>{if("cim"===l.symbol.type){const {minScale:u,maxScale:x}=l.symbol.data;if(u&&u<this.scale||x&&x>this.scale)return!1}return!0}).map(l=>this._getSymbolPreview(l,cb,{isDefault:l.symbol===fa,applyScaleDrivenSize:!m.has(l.symbol),symbolConfig:{isTall:db,isSquareFill:eb},effectList:m.has(l.symbol)?
null:this.effectList}));a=null;await Promise.allSettled(b);return h}_checkDefinitionExpression(a,b){return a&&"string"===typeof a&&this._layerDefinitionExpressionClause?this._layerDefinitionExpressionClause.testFeature({[a]:b}):!0}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(a){const b=a?.infos;return b?b.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[a]}async _constructTileImageryStretchRendererElements(a){const b=this.layer,c=b.symbolizer.rasterInfo??
b.raster.rasterInfo;var d;if(d=a?.statistics?.length?a.statistics:c?.statistics){var e=d[0];B.isRasterBandStatistics(e)?(d=e.min,e=e.max):[d,e]=e}else e=ja.getPixelValueRange(c.pixelType),d=e[0],e=e[1];b.hasStandardTime()&&(d=b.getStandardTimeValue(d),e=b.getStandardTimeValue(e));if(1===c.bandCount||1===b.bandIds?.length)return this._getStretchLegendElements(a,{min:d,max:e});a=(b?.bandIds?.length?b.bandIds:Array.from(Array(Math.min(c.bandCount,3)).keys())).map(f=>c.bandInfos[f].name);3>a.length?a.push(a[1]):
3<a.length&&a.splice(3);return this._createSymbolTableElementMultiBand(a)}async _getStretchLegendElements(a,b){a=O.getStretchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:D.renderColorRampPreviewHTML(a.map(c=>c.color),{ariaLabel:await E("previewColorRampAriaLabel")})}}_getClusterSymbol(){var a=this.layer;const b=(a="featureReduction"in a&&a.featureReduction)&&"symbol"in a&&a.renderer;return b&&!0!==b?.authoringInfo?.isAutoGenerated?null:a&&"symbol"in a?a.symbol:null}async _getSizeLegendElement(a,
b,c,d){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(b):a,infos:await Y.getRampStops(c,b,await B.getMedianColor(c),this.scale,this.view,d,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(a){const b=[],c=["red","green","blue"];a.forEach((d,e)=>{b.push({label:{colorName:c[e],bandName:d},src:B.rgbImgSource[e],opacity:this.opacity??1})});return b}_updateInfosForClassedSizeRenderer(a,b){const c=a.authoringInfo&&"class-breaks-size"===
a.authoringInfo.type,d=a.classBreakInfos.some(e=>Qa.isVolumetricSymbol(e.symbol));if(c&&d){const e=Y.realWorldMaxSize;a=a.classBreakInfos.length;const f=(e-Y.realWorldMinSize)/(1<a?a-1:a);b.forEach((h,g)=>{h.size=e-f*g})}}_isTallSymbol(a){let b=!1,c=!1;if(a)for(let d=0;d<a.length&&(!b||!c);d++){const e=a[d];"size"===e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c}async _getSymbolPreview(a,b,c){var d=!c?.isDefault&&null==a.size&&this._hasSizeRamp?Aa.px2pt(Oa.SymbolSizeDefaults.size):
a.size;this._scaleDrivenSizeVariable&&c?.applyScaleDrivenSize&&({getSize:d}=await new Promise((e,f)=>ua(["../../../renderers/visualVariables/support/visualVariableUtils"],e,f)),d=d(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}));return D.renderPreviewHTML(a.symbol,{size:d,opacity:b,scale:!1,symbolConfig:c?.symbolConfig,effectView:c?.effectList,style:"legend",cimOptions:{allowScalingUp:!c?.isDefault&&this._hasSizeRamp||
!(!this._scaleDrivenSizeVariable||!c?.applyScaleDrivenSize),viewParams:this.isScaleDriven?{viewingMode:"2d"===this.view?.type?"map":this.view?.viewingMode,scale:this.view?.scale}:null},ariaLabel:a.label&&"string"!==typeof a.label?null:await E("previewTemplateAriaLabel",a.label)}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})}_getClusterRenderer(a){this._hasClusterSizeVariable=!1;var b="renderer"in this.layer?this.layer.renderer:null;b=a.renderer?.clone()||b?.clone();const c=
Ra.getEffectiveClusterSizeVariable(a,this.layerView,this.view);if(c&&null!=b&&"visualVariables"in b&&!b.visualVariables?.some(d=>"size"===d.type&&"outline"!==d.target&&!U.test(d.valueExpression))){if("clusterMinSize"in a&&"clusterMaxSize"in a){const {clusterMinSize:d,clusterMaxSize:e}=a;c.legendOptions=new La({showLegend:d!==e})}b.visualVariables=(b.visualVariables||[]).concat([c]);this._hasClusterSizeVariable=!0}return b}async _loadRenderer(a){const b=[],c=a.clone(),d=await B.getMedianColor(c);if(G(c)||
Q(c))a=(c.classBreakInfos||c.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,d).then(f=>{e.symbol=f}).catch(()=>{e.symbol=null})),Array.prototype.push.apply(b,a);b.push(this._fetchSymbol(c.symbol||c.defaultSymbol,c.defaultSymbol?null:d).then(e=>{this._applySymbolToRenderer(c,e,H(c))}).catch(()=>{this._applySymbolToRenderer(c,null,H(c))}));await Promise.allSettled(b);return c}_applySymbolToRenderer(a,b,c){c?a.symbol=b:a.defaultSymbol=b}async _fetchSymbol(a,b){if(!a)throw Error();if("web-style"===
a.type){const c=this._webStyleSymbolCache;try{const d=await ("2d"===this.view.type?a.fetchCIMSymbol({cache:c}):a.fetchSymbol({cache:c}));return this._getAppliedCloneSymbol(d,b)}catch{throw C.getLogger(this).warn("Fetching web-style failed!"),Error();}}return this._getAppliedCloneSymbol(a,b)}_getAppliedCloneSymbol(a,b){if(!a||!b)return a;a=a.clone();const c=b&&b.toRgba();a.type.includes("3d")?this._applyColorTo3dSymbol(a,c):"cim"===a.type?Na.applyCIMSymbolColor(a,b):a.color&&(a.color=new ha(c||a.color));
return a}_applyColorTo3dSymbol(a,b){b&&a.symbolLayers.forEach(c=>{c&&(c.material||(c.material={}),c.material.color=new ha(b))})}async _getVisualVariableLegendElements(a,b){if(!("visualVariables"in a)||"vector-field"===a.type)return null;var c=a.visualVariables??[],d=[];const e=[],f=[],h=B.getReferenceSizeAuthoringInfoVisualVariable(a);if(2===h?.sizeStops?.length&&(G(a)||Q(a))){const [m,k]=h.sizeStops;e.push(new Ka({field:h.field??void 0,normalizationField:h.normalizationField,minSize:m.size,maxSize:k.size,
minDataValue:m.value,maxDataValue:k.value}))}for(const m of c)"color"===m.type?d.push(m):"size"===m.type?e.push(m):"opacity"===m.type&&f.push(m);c=[...d,...e,...f];let g;if(0===d.length&&G(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var n=(n=a.classBreakInfos[0])&&n.symbol;0===d.length&&H(a)&&(n=a.symbol);n&&(n.type.includes("3d")?(d=n.symbolLayers.at(0),"water"===d.type?null!=d.color&&(g=d.color):null!=d.material?.color&&(g=d.material.color)):n.url||(g=n.color));const v=this.effectList;return(await Promise.all(c.map(async m=>
{if(!m.legendOptions||!1!==m.legendOptions.showLegend){const k="flow"===a.type?m.field:this._getRampTitle(m,b);let q=null;const r=B.getDateFormatOptions(b,m,this.view.timeZone);"color"===m.type?(m=await O.getRampStops(m,null,r)??[],q={type:"color-ramp",title:k,infos:m,preview:D.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:v,ariaLabel:await E("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=0<m.length)):"size"===m.type&&"outline"!==m.target?U.test(m.valueExpression)?
this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=m):(q=await this._getSizeLegendElement(k,m,a,r),this._hasSizeRamp||(this._hasSizeRamp=!(null==q.infos||!q.infos.length))):"opacity"===m.type&&(m=await O.getRampStops(m,g,r)??[],q={type:"opacity-ramp",title:k,infos:m,preview:D.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:v,ariaLabel:await E("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=0<m.length));return q?.infos?q:null}}))).filter(M.isSome)}_getDomainName(a,
b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField?.(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null,"coded-value"===c?.type?c.getName(b):null):null}_getClusterTitle(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(const c of b)if(c.fieldName===a)return"cluster_count"===a?c.label||{showCount:!0}:c.label;return{showCount:!0}}_getRampTitle(a,
b){let c=a.field,d=a.normalizationField,e=!1,f=!1,h=!1;var g=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;g=a.legendOptions?.title;if(null==g)if(a.valueExpressionTitle)g=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo?.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,g=0;g<a.length;g++){const n=a[g];if("color"===n.type){if("ratio"===n.style){e=!0;break}if("percent"===n.style){f=!0;break}if("percent-of-total"===
n.style){h=!0;break}}}g={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:h}}return g}_getRendererTitle(a,b){if(a.legendOptions?.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var c=a.field;let d=null,e=null;G(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?null:d;if(Q(a)){const {field2:f,field3:h,fieldDelimiter:g}=
a;c=c&&this._getFieldAlias(c,b);f&&(c=`<${c}>${g}<${this._getFieldAlias(f,b)}>`,h&&(c=`${c}${g}<${this._getFieldAlias(h,b)}>`));return c}a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a}_getFieldAlias(a,b){let c=("popupTemplate"in b?b.popupTemplate:null)?.fieldInfos?.find(h=>a===h.fieldName),d=null;"getField"in b&&b.getField?d=b.getField(a):"fieldsIndex"in b&&b.fieldsIndex&&(d=b.fieldsIndex.get(a));let e=null;if(b="featureReduction"in
b&&b.featureReduction)c??="popupTemplate"in b?b.popupTemplate?.fieldInfos?.find(h=>a?.toLowerCase()===h.fieldName?.toLowerCase()):void 0,"fields"in b&&b.fields&&(e=b.fields.find(h=>h.name?.toLowerCase()===a?.toLowerCase()));b=c||d||e;let f=null;b&&(f=c?.label||d?.alias||e?.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName||null);return f}_isUnclassedRenderer(a){const b=a.visualVariables;let c=!1;G(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(d=>!(!d||a.field!==d.field||
(a.normalizationField||d.normalizationField)&&a.normalizationField!==d.normalizationField)):!!b.length);return c}};w.__decorate([y.property()],t.prototype,"children",void 0);w.__decorate([y.property({readOnly:!0})],t.prototype,"effectList",null);w.__decorate([y.property()],t.prototype,"layerView",void 0);w.__decorate([y.property()],t.prototype,"layer",void 0);w.__decorate([y.property()],t.prototype,"legendElements",void 0);w.__decorate([y.property({readOnly:!0})],t.prototype,"opacity",null);w.__decorate([y.property()],
t.prototype,"parent",void 0);w.__decorate([y.property({readOnly:!0,dependsOn:[]})],t.prototype,"ready",null);w.__decorate([y.property()],t.prototype,"hideLayersNotInCurrentView",void 0);w.__decorate([y.property()],t.prototype,"keepCacheOnDestroy",void 0);w.__decorate([y.property()],t.prototype,"respectLayerDefinitionExpression",void 0);w.__decorate([y.property()],t.prototype,"respectLayerVisibility",void 0);w.__decorate([y.property({readOnly:!0})],t.prototype,"scale",null);w.__decorate([y.property()],
t.prototype,"sublayerIds",void 0);w.__decorate([y.property({readOnly:!0})],t.prototype,"isScaleDriven",null);w.__decorate([y.property()],t.prototype,"title",void 0);w.__decorate([y.property({readOnly:!0,dependsOn:["ready"],value:0})],t.prototype,"version",null);w.__decorate([y.property()],t.prototype,"view",void 0);return t=w.__decorate([Da.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],t)});
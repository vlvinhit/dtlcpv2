// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../renderers/support/clickToleranceUtils ../../../views/support/drapedUtils ../../../views/support/layerViewUtils".split(" "),function(C,h,k,D,l,E,F,G){async function t(){return new Promise((b,a)=>C(["../../../geometry/geometryEngineJSON"],b,a))}async function u(){return t().then(({contains:b,intersects:a,overlaps:d,simplify:c})=>({contains:b,intersects:a,overlaps:d,simplify:c}))}
function v(b){const a=[];for(let d=0;d<b.length;d++){const c=b[d];"fulfilled"===c.status&&a.push(...c.value)}return a}function H(b){const a=[],d=[],c=[];b.forEach(e=>{l.isFeatureLayer(e)?a.push(e):(l.isKnowledgeGraphLayer(e)||l.isLinkChartLayer(e))&&e.layers?.length?a.push(...e.layers.toArray()):l.isMapNotesLayer(e)&&e.sublayers?.length?c.push(...e.sublayers.toArray()):l.isGraphicsLayer(e)?c.push(e):G.isSelectableLayerView2D(e)&&d.push(e)});return{layers:a,layerViews:d,graphicsLayers:c}}function w(b,
a){if(b.includes(a))return!0;const d=a.getObjectId(),{layer:c,uid:e}=a;return null!=d?b.some(f=>{if(c===f.layer)return d===f.getObjectId()}):b.some(f=>{if(c===f.layer)return e===f.uid})}async function x(b){const {layerViews:a,selector:d,signal:c,view:e}=b;return k.whenOrAbort(Promise.allSettled(a.map(async f=>{const g=f.createQuery(),{geometry:m}=n(d,f.layer,e);g.outFields=["*"];g.geometry=m;g.returnGeometry=!0;g.outSpatialReference=e.spatialReference;return f.queryFeatures(g,{signal:c}).then(({features:p})=>
p)})),c)}async function y(b){const {layers:a,selector:d,signal:c,view:e}=b;return k.whenOrAbort(Promise.allSettled(a.map(async f=>f.queryFeatures(I(f.createQuery(),d,f,e),{signal:c}).then(({features:g})=>g))),c)}function n(b,a,d){const c=D.getDisplayFieldName({displayField:"displayField"in a?a.displayField:null,fields:a.fields}),e=[a.objectIdField];null!=c&&a.fieldsIndex.has(c)&&e.push(c);a="renderer"in a?E.calculateTolerance({renderer:a.renderer}):0;return{geometry:"point"===b.type?F.createQueryGeometry(b,
a,d):b,outFields:e}}function I(b,a,d,c){const {outFields:e,geometry:f}=n(a,d,c);b.outFields=e;b.geometry=f;b.returnGeometry=!0;b.outSpatialReference=c.spatialReference;return b}async function z(b){const {selector:a,candidates:d,view:c}=b;if(!d?.length||!a)return[];const {spatialReference:e}=c,f=await u();return d.filter(g=>f.intersects(e,a,g.geometry))}const J=async(b,a,d)=>{a=a.flatMap(c=>c.graphics.toArray())??[];return z({candidates:a,selector:b,view:d})},K=async(b,a,d,c)=>(b=await k.ignoreAbortErrors(y({selector:b,
signal:c,layers:a,view:d})))?v(b):[],L=async(b,a,d,c)=>(b=await k.ignoreAbortErrors(x({selector:b,signal:c,layerViews:a,view:d})))?v(b):[];h.getGeometryEngineOperations=u;h.getQueryOptionsFromLayer=n;h.getSelectionFromFeatureLayerViews=x;h.getSelectionFromFeatureLayers=y;h.getSelectionFromGeometry=async function(b){const {currentSelection:a,selector:d,signal:c,sources:e,view:f}=b;if(!e?.length)return{added:[],removed:[]};const {layers:g,layerViews:m,graphicsLayers:p}=H(e),q=(await k.whenOrAbort(Promise.all([K(d,
g,f,c),L(d,m,f,c),J(d,p,f)]),c)).flat();if(!a)return{added:q,removed:[]};const A=a.toArray();b=q.filter(r=>!w(A,r));const B=A.filter(r=>!w(q,r));a.removeMany(B);a.addMany(b);return{added:b,removed:B}};h.getSelectionFromGeometryEngine=z;h.importGeometryEngine=t;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
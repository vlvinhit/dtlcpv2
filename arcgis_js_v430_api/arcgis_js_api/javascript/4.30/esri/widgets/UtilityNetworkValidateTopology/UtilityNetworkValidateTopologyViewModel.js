// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../intl ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../core/support/UpdatingHandles ../../layers/support/layerUtils ../../portal/Portal ../../portal/support/utils ../../intl/locale ../../intl/messages".split(" "),function(d,c,q,r,k,l,n,f,z,A,t,u,p,v,w,x,y){c=class extends q{constructor(b){super(b);
this._initialValidationsFinished=this._activeOperationDidSucceed=!1;this._serverVersion=this._dirtyAreasLayer=null;this._updatingHandles=new u.UpdatingHandles;this._validConstructProperties=!1;this.executionError="";this.extentToValidate="current";this.loadErrors=new r}initialize(){const b=async()=>{this.messages||(this.messages=await y.fetchMessageBundle("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology"))};b().then(()=>{this.view||(this.view=null);this.utilityNetwork||
(this.utilityNetwork=null);this.addHandles([n.watch(()=>[this.view,this.utilityNetwork],async()=>{const {loadErrors:e,messages:{info:{noUtilityNetwork:a,noView:h}}}=this;this._initialValidationsFinished=!1;e.removeAll();this._validConstructProperties=!0;this._serverVersion=this._dirtyAreasLayer=null;"utility"!==this.utilityNetwork?.type&&(this.loadErrors.push(a),l.getLogger(this).error(new k("utilityNetworkValidateTopology:missing-property",a)),this._validConstructProperties=!1);"2d"!==this.view?.type&&
(this.loadErrors.push(h),l.getLogger(this).error(new k("utilityNetworkValidateTopology:missing-property",h)),this._validConstructProperties=!1);this._validConstructProperties&&(this.utilityNetwork.loaded||await this.utilityNetwork.load().catch(g=>{l.getLogger(this).error(g);this._validConstructProperties=!1}),await this._setDirtyAreasLayer());this._validConstructProperties&&await this._validateNetworkExtension()},n.initial),n.on(()=>this.view?.map?.layers,"change",async()=>{const {loadErrors:e,messages:{info:{noUtilityNetwork:a}}}=
this,h=e.find(g=>g===a);this._initialValidationsFinished=!1;h||(e.removeAll(),await this._validateNetworkExtension(),await this._setDirtyAreasLayer());this._initialValidationsFinished=!0}),x.onLocaleChange(b)])})}destroy(){this._updatingHandles.destroy()}get state(){return this.loadErrors.length||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._activeOperationDidSucceed?"success":this._initialValidationsFinished?"ready":"loading"}set utilityNetwork(b){this._get("utilityNetwork")!==
b&&this._set("utilityNetwork",b)}set view(b){this._get("view")!==b&&this._set("view",b)}async validateTopology(){const {messages:{info:{cannotAcquireVersionLock:b,noDirtyAreasInExtent:e}},utilityNetwork:a,view:h}=this;this.loadErrors.length||(this._activeOperationDidSucceed=!1,this._set("executionError",""),this._updatingHandles.addPromise(a?.validateTopology({validateArea:"current"===this.extentToValidate?h.extent.clone():a.fullExtent.clone(),outSpatialReference:h.spatialReference?.clone()||null}).then(()=>
{this._activeOperationDidSucceed=!0},g=>{let m="Error: "+g;if(g instanceof k&&g.details?.raw)switch(g.details.raw.extendedCode){case -2147208940:m=e;break;case -2147217146:case -2147220947:m=b;break;default:m=g.details.message}this._set("executionError",m)})))}async _setDirtyAreasLayer(){const {messages:{info:{noDirtyAreasLayer:b}}}=this,e=this.view?.map.allLayers.items.filter(a=>p.isFeatureLayer(a)).find(a=>a.parsedUrl?.path===this.utilityNetwork?.networkSystemLayers.dirtyAreasLayerUrl);e?(this._dirtyAreasLayer=
e,await this._dirtyAreasLayer.load(),this._serverVersion=this._dirtyAreasLayer.version??0,this._validConstructProperties=!0):(this.loadErrors.push(b),l.getLogger(this).error(new k("utilityNetworkValidateTopology:missing-layer",b)),this._validConstructProperties=!1)}async _validateNetworkExtension(){const {messages:{info:{noAdvancedEditingUserTypeExtension:b,noUtilityNetworkServiceUserTypeExtension:e}}}=this;var a=await p.getOwningPortalUrl(this.utilityNetwork.layerUrl);a=new v({url:a});await a.load();
await w.hasUserTypeExtension(a,a.user?.username??"",11.1>=Number(this._serverVersion)?"utilityNetwork":"advediting")||(a=11.1>=Number(this._serverVersion)?e:b,this.loadErrors.push(a),l.getLogger(this).error(new k("utilityNetworkValidateTopology:no-user-type-extension",a)),this._validConstructProperties=!1);this._initialValidationsFinished=!0}};d.__decorate([f.property()],c.prototype,"_initialValidationsFinished",void 0);d.__decorate([f.property()],c.prototype,"_dirtyAreasLayer",void 0);d.__decorate([f.property()],
c.prototype,"_validConstructProperties",void 0);d.__decorate([f.property({readOnly:!0})],c.prototype,"executionError",void 0);d.__decorate([f.property()],c.prototype,"extentToValidate",void 0);d.__decorate([f.property()],c.prototype,"loadErrors",void 0);d.__decorate([f.property()],c.prototype,"messages",void 0);d.__decorate([f.property({readOnly:!0})],c.prototype,"state",null);d.__decorate([f.property()],c.prototype,"utilityNetwork",null);d.__decorate([f.property()],c.prototype,"view",null);return c=
d.__decorate([t.subclass("esri.widgets.UtilityNetworkValidateTopology.UtilityNetworkValidateTopologyViewModel")],c)});
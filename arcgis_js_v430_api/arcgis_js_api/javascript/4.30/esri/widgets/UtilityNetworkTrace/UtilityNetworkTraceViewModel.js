// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../kernel ../../core/Collection ../../core/Error ../../core/Evented ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../geometry/support/jsonUtils ../../intl/messages ../../layers/FeatureLayer ../../layers/GraphicsLayer ../../layers/support/CodedValueDomain ../../layers/support/layerUtils ../../networks/UtilityNetwork ../../networks/support/utils ../../portal/Portal ../../portal/support/utils ../../rest/networks/trace ../../rest/networks/support/TraceLocation ../../rest/networks/support/TraceParameters ./support/GeometryHandler ./support/GraphicHandler ./support/ResultAreaHandler ./support/UtilityHelper".split(" "),
function(k,z,A,w,h,B,C,l,R,S,D,r,x,E,F,G,y,H,t,I,J,K,u,L,M,v,N,O){async function P(a){var b=new E({url:a.networkSystemLayers.dirtyAreasLayerUrl});await b.load();return 11.1>=Number(b.version)?(a=await y.getOwningPortalUrl(a.layerUrl),a=new I({url:a}),await a.load(),(b=a?.user?.username)?J.hasUserTypeExtension(a,b,"utilityNetwork"):!1):!0}const p=`utility-network-trace-flags-${Date.now()}`,q=`utility-network-trace-results-${Date.now()}`;h=class extends h.EventedAccessor{constructor(a){super(a);this._activeProgress=
!1;this._clickHandler=null;this._flags=[];this._flagId=0;this._geometryHandler=null;this._highlightHandler=[];this._resultAreaHandler=null;this._utilityHelper=new O.UtilityHelper;this._watchHandler=null;this._validUNLayers=[];this._traceTimeout=6E5;this._sketchViewModel=null;this.traces=[];this.graphicHandler=null;this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"};this.enableResultArea=!1;this.flags=[];this.gdbVersion="sde.DEFAULT";this.messagesUnits=this.messages=
null;this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1};this.selectedTraces=[];this.showSelectionAttributes=this.showGraphicsOnComplete=this.selectOnComplete=!0;this.traceResults=[];this.utilityNetwork=null}initialize(){this._geometryHandler=new M.GeometryHandler;this.graphicHandler=new v.GraphicHandler;this._resultAreaHandler=new N.ResultAreaHandler;(async()=>{const [a,
b]=await Promise.all([x.fetchMessageBundle("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),x.fetchMessageBundle("esri/core/t9n/Units")]);this.set({messages:a,messagesUnits:b})})()}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(a){this._set("resultAreaProperties",{...this.defaultResultAreaProperties,...a});this.graphicHandler.addCustomColor(this.resultAreaProperties.color);this.traceResults.forEach(b=>{const c=b.resultArea?.show;
b.resultArea={...this.defaultResultAreaProperties,...a};this.removeResultAreaFromMap(b);this.enableResultArea&&this.createResultAreaGraphic(b).then(d=>{if(d){b.resultAreaGraphic=d;const e=a?.show??c;b.resultArea&&(b.resultArea.show=e);e&&this.addResultAreaToMap(b,d)}})})}get state(){return this.view?.ready?"ready":"loading"}get view(){return this._get("view")}set view(a){a&&"2d"!==a.type&&B.getLogger(this).error(new w("view:invalid-view","SceneView is not supported",{view:a}));this._set("view",a);
this.utilityNetwork&&this.reset();this.utilityNetwork=null;this.loadUtilityNetwork().then(b=>{b&&this.selectTracesOnLoad()})}addFlagByHit(a,b){const c=d=>{this.view?.popup&&(this.view.popupEnabled=d)};return new Promise((d,e)=>{c(!1);this._clickHandler?.remove();this._clickHandler=this._sketchViewModel.on("create",f=>{if("complete"===f.state){const g=this._getGraphicLayer(p);g&&f.graphic&&g.remove(f.graphic);this.queryFlagByHitTest(f,a,b).then(m=>{c(!0);this._clickHandler?.remove();this.emit("add-flag-complete",
{type:a,symbol:b});d(m)}).catch(m=>{c(!0);this._clickHandler?.remove();this.emit("add-flag-error",{type:a,symbol:b});e(m)})}});this._sketchViewModel.create("point");this.emit("add-flag",{type:a})})}async addFlagsOnLoad(){if(0<this._flags.length)return[];await C.whenOnce(()=>null!=this.view&&!this.view.updating);return(await Promise.all(this.flags.map(async a=>{if(!a.mapPoint)return null;const {type:b}=a;var c=a.mapPoint.clone();c={graphic:this.graphicHandler.makeGraphic(c,"barrier"===b?v.barrierColor:
v.startingPointColor),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return await this.queryFlagByHitTest(c,a.type,null),this.emit("add-flag-complete",{type:b}),null}catch(d){return this.emit("add-flag-error",{type:b}),"barrier"===b?"barrier":"starting-point"}}))).filter(a=>!a)}async addResultAreaToMap(a,b){this.view&&((a.resultArea.show=!0,b)?(this._resultAreaHandler?.addResultAreaToMap(b,this.view.map),this.emit("add-result-area",{graphic:b})):a.results&&(b=await this.createResultAreaGraphic(a))&&
(a.resultAreaGraphic=b,this._resultAreaHandler?.addResultAreaToMap(b,this.view.map),this.emit("add-result-area",{graphic:b})))}async addResultGraphicToView(a,b){const {view:c}=this,{results:d}=a;if(c&&d&&this.utilityNetwork)for(const f in d.aggregatedGeometry)if("line,multipoint,polygon".includes(f)){var e=d.aggregatedGeometry[f];if(null!=e){e.spatialReference=this.utilityNetwork.spatialReference;a.graphicEnabled=!0;e=await this._geometryHandler.projectGeometry(e,c.spatialReference);const g={globalid:a.trace.globalId};
null!==e&&(e=this.graphicHandler.makeGraphic(e,b.color,g,c.spatialReference),this._getGraphicLayer(q)?.add(e))}}}addTerminal(a,b){const c=[...this._flags];c.forEach(d=>{d.globalId===b.globalId&&(b.selectedTerminals?.includes(parseInt(a,10))||d.selectedTerminals?.push(parseInt(a,10)))});this._flags=c}async callTrace(){const a=this.traces.filter(b=>b.selected);return 0<a.length?(0<this.traceResults.length&&this.traceResults.forEach(b=>{this.removeResultGraphicFromView(b)}),this.traceResults=[],this.removeSelection(),
await Promise.all(a.map(async(b,c)=>{const d=new L({gdbVersion:this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion,moment:null,traceType:b.traceType,traceLocations:this._flags,namedTraceConfigurationGlobalId:b.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});await this.executeTrace(b,this.utilityNetwork?.networkServiceUrl,d).then(e=>{if(e.hasOwnProperty("results")){const g={...e};if(null!==g.results){g.resultArea={...this.resultAreaProperties};e=[...g.results.elements];
g.results.elements.length=0;const m=new Map;for(var f of e)m.has(f.globalId)||(m.set(f.globalId,!0),g.results.elements.push(f));e=[...this.traceResults];e.splice(c,0,g);this.traceResults=e;null!==g.results&&(this.selectOnComplete&&this.mergeSelection(!0,g.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(g,g.graphicColor),this.enableResultArea&&this.createResultAreaGraphic(g).then(n=>{n&&(g.resultAreaGraphic=n,g.resultArea?.show&&this.addResultAreaToMap(g,g.resultAreaGraphic))}))}else f=
[...this.traceResults],f.splice(c,0,e),this.traceResults=f;this._activeProgress=!1}else this._activeProgress=!1,f=[...this.traceResults],f.splice(c,0,e),this.traceResults=f}).catch(e=>{this._activeProgress=!1;throw e;})})),!0):!1}changeResultAreaColor(a,b){a.resultArea&&(a.resultArea.color=b,b=this._resultAreaHandler?.changeResultAreaColor(a.trace.globalId,b,this.view.map),a.resultAreaGraphic&&(a.resultAreaGraphic.symbol=b))}changeResultGraphicColor(a,b){const c=[...this.traceResults];0<c.length&&
c.forEach(d=>{d.trace.globalId===b.trace.globalId&&(d.graphicColor=a,d.graphicEnabled=!0)});this.traceResults=c;this.removeResultGraphicFromView(b);this.addResultGraphicToView(b,a)}changeFlagSymbol(a,b){0<this._flags.length&&this._flags.forEach(c=>{c.type===a&&b&&c.mapGraphic&&(c.mapGraphic.symbol=b)})}checkCanTrace(){const a={status:!0,issues:[]};let b=!1;const c=this._flags.some(e=>"starting-point"===e.type);var d=this._flags.filter(e=>null!==e.allTerminals);0<d.length&&(b=d.some(e=>0>=e.selectedTerminals.length));
d=[];c?(d=this.traces.filter(e=>e.selected),0>=d.length?(a.status=!1,a.issues=["noTrace"],b&&(a.status=!1,a.issues=["noTrace","noTerminalSelected"])):b&&(a.status=!1,a.issues=["noTerminalSelected"])):(d=this.traces.filter(e=>!0===e.selected),0<d.length?(a.status=!1,a.issues=["noStart"],b&&(a.status=!1,a.issues=["noStart","noTerminalSelected"])):(a.status=!1,a.issues=["noStart","noTrace"],b&&(a.status=!1,a.issues=["noStart","noTrace","noTerminalSelected"])));return a}checkSelectionExist(){return this._highlightHandler.some(a=>
a)}clearResult(a){if(this.view){var b=this.traceResults;if(0<b.length){const c=b.filter(d=>d.trace.globalId===a.globalId);0<c.length&&(this.removeResultGraphicFromView(c[0]),this.removeResultAreaFromMap(c[0]));b=b.filter(d=>d.trace.globalId!==a.globalId)}this.traceResults=b;0===b.length?(this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,a)}}createResultAreaGeometries(a,b,c){if(this.view&&this.resultAreaProperties&&(b="convexhull"===
this.resultAreaProperties?.type?1===b.length&&(r.isPoint(b[0])||r.isMultipoint(b[0])&&1===b[0].points.length)?this._resultAreaHandler?.createBuffer(b,c,a.resultArea?.unit,!0):this._resultAreaHandler?.createConvexHull(b,a.resultArea?.distance,a.resultArea?.unit):this._resultAreaHandler?.createBuffer(b,c,a.resultArea?.unit,!0)))if(Array.isArray(b))for(var d of b){if(b=this.getResultAreaAttributes(a,d),b=this._resultAreaHandler?.createResultAreaGraphic(d,b,a.resultArea?.areaUnit,this.messages,this.messagesUnits,
a.resultArea?.color))return b}else return d=this.getResultAreaAttributes(a,b),this._resultAreaHandler?.createResultAreaGraphic(b,d,a.resultArea?.areaUnit,this.messages,this.messagesUnits,a.resultArea?.color)}async createResultAreaGraphic(a){if(a.results){const b=await this._createResultAreaInputGeometry(a.results);if(0<b.length){const c=Array(b.length).fill(a.resultArea?.distance);a=this.createResultAreaGeometries(a,b,c);this.emit("create-result-area",{graphic:a});return a}}}executeTrace(a,b,c){const d=
this._processFlags(c.traceLocations);c.traceLocations=d;return K.trace(b,c,{timeout:this._traceTimeout}).then(e=>({trace:a,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(e=>({trace:a,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:e.message,date:new Date}))}getResultAreaAttributes(a,b){const {messages:c}=this,d=[],e=[];this._flags.forEach(f=>{const g=f.displayValue?.field+
":"+f.displayValue?.value+";"+c.attributeStrings.globalid+":"+f.globalId+";"+c.attributeStrings.terminalid+":"+f.terminalId+";"+c.attributeStrings.x+":"+f.mapPoint?.x+";"+c.attributeStrings.y+":"+f.mapPoint?.y;"starting-point"===f.type?d.push(g):e.push(g)});return{traceId:a.trace.globalId,traceName:a.trace.title,traceDescription:a.trace.description??"",startingPoints:d.toString(),barriers:e.toString(),version:(this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion)??void 0,username:z.id.credentials[0].userId,
date:a.date,elementCount:a.results?.elements.length,functionResult:JSON.stringify(a.results?.globalFunctionResults),areaStatistic:b?this._geometryHandler.calculateArea(b,a.resultArea?.areaUnit):0}}getValidSources(){let a=[];const b=this.utilityNetwork?.dataElement?.domainNetworks??[];for(const c of b)a=a.concat(c.junctionSources),a=a.concat(c.edgeSources);return a}groupResultsByNetworkSource(a){return 0===a.length?[]:this._groupBy(a,"networkSourceId")}async loadUtilityNetwork(){var {view:a}=this;
if(!a)return null;await a.when();if(this.utilityNetwork){this.utilityNetwork.loaded||await this.utilityNetwork.load();if(this.utilityNetwork instanceof H){try{await a.map.loadAll(),this._loadUNSupportItems()}catch(c){this._loadUNSupportItems()}return this.utilityNetwork}return null}a=a.map;const b=a.utilityNetworks?.at(0);if(b){await b.load();this.utilityNetwork=b;if(!await P(b))throw new w("utility-network:no-user-type-extension","User type extension not found");try{await a.loadAll(),this._loadUNSupportItems()}catch(c){}finally{this._loadUNSupportItems()}return b}return null}manageFilterBarrier(a,
b){const c=[...this._flags];c.forEach(d=>{d.globalId===b.globalId&&"barrier"===b.type&&d.id===b.id&&(d.isFilterBarrier=a)});this._flags=c}mergeSelection(a,b){let c=[];const d=[...this.traceResults],e=b.globalId;d.forEach(f=>{e===f.trace.globalId&&(f.selectionEnabled=a);f.selectionEnabled&&null!==f.results?.elements&&(c=[...c,...(f.results?.elements??[])])});this.selectResults([...(new Set(c))])}async queryFeaturesById(a){const {view:b}=this;if(!b||!this.utilityNetwork)return null;const c=t.getObjectIdsFromElements(this.utilityNetwork,
a),d={layerUrl:c[0].layerUrl,objectIds:c[0].objectIds,outFields:["*"]},e=b.map?.allTables.toArray().filter(f=>f?.parsedUrl?.path===c[0].layerUrl).filter(y.isFeatureLayer)??[];this._getUniqueMapLayerViews(b).filter(({layer:f})=>f?.parsedUrl?.path===c[0].layerUrl).forEach(({layer:f})=>{"feature"!==f.type&&"subtype-group"!==f.type||e.push(f)});a=(await Promise.all(e.map(async f=>{f={layers:new A([f]),layerInfos:[d],returnGeometry:!0,outSpatialReference:b.spatialReference};[f]=await t.getFeaturesFromLayers(f,
!1);return f}))).filter(({featureSet:f})=>0<f.features.length);return 0<a.length?a:null}queryFlagByHitTest(a,b,c){return this._lookupFlagByHit(a).then(d=>{const {view:e}=this;if(!e)return!1;if(0<d.length){const f=[...this._flags];d.forEach(g=>{g=g.graphic;const m=g.attributes.hasOwnProperty("GLOBALID")?g.attributes.GLOBALID:g.attributes.globalid;if(0>=f.filter(Q=>Q.globalId===m).length){var n=this.graphicHandler.getFlagGraphic(g.attributes.mapPoint,b,g,c);this._getGraphicLayer(p)?.add(n);g=this._createFlagProperty(g,
b,n);f.push(g)}else null!==g.attributes.percentAlong&&(n=this.graphicHandler.getFlagGraphic(g.attributes.mapPoint,b,g,c),this._getGraphicLayer(p)?.add(n),g=this._createFlagProperty(g,b,n),f.push(g))});this._flags=f;return!0}return!1})}removeResultGraphicFromView(a){var {view:b}=this;b&&(b=this._getGraphicLayer(q)?.graphics,a.graphicEnabled=!1,b?.filter(c=>c.attributes[c.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===a.trace.globalId)?.forEach(c=>{this._getGraphicLayer(q)?.remove(c)}))}removeFlag(a){const b=
this._flags.filter(c=>{if(c.id!==a.id)return c});this._removeGraphic(a);this._flags=b}removeAllResultAreaGraphics(){this._resultAreaHandler?.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(a){a.resultArea&&(a.resultArea.show=!1,(a=this._resultAreaHandler?.removeResultArea(a.trace.globalId,this.view?.map))&&this.emit("remove-result-area",{graphic:a}))}removeSelection(){this._highlightHandler.forEach(a=>{a&&a.remove()});this._highlightHandler=[]}removeTerminal(a,b){const c=[...this._flags];
c.forEach(d=>{if(d.globalId===b.globalId&&b.selectedTerminals?.includes(parseInt(a,10))){const e=b.selectedTerminals.indexOf(parseInt(a,10));d.selectedTerminals?.splice(e,1)}});this._flags=c}removeFlagsOnLoadWatcher(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){this._flags=[];this.traceResults=[];const a=[...this.traces];a.forEach(b=>{b.selected=!1});this.traces=
a;this.view&&(this._getGraphicLayer(q)?.removeAll(),this._getGraphicLayer(p)?.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))}selectFeaturesById(a){const {view:b}=this;if(b&&this.utilityNetwork){var c=t.getObjectIdsFromElements(this.utilityNetwork,a);this._getUniqueMapLayerViews(b).forEach(d=>{"layer"in d&&d.layer?.parsedUrl?.path===c[0].layerUrl&&("feature"===d.layer.type||"subtype-group"===d.layer.type)&&this._highlightHandler.push(d.highlight(c[0].objectIds))})}}selectResults(a){if(0<
a.length){this.removeSelection();a=this.groupResultsByNetworkSource(a);const b=[];for(const c in a)this.selectFeaturesById(a[c]),b.push(this.queryFeaturesById(a[c]));Promise.all(b).then(c=>{this.emit("select-features",{resultSet:c})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(a,b){const c=[...this.traces];c.forEach(d=>{b===d.globalId&&(d.selected=a)});this.traces=c}selectTracesOnLoad(){this.utilityNetwork?.hasOwnProperty("sharedNamedTraceConfigurations")&&
(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(a=>{a.selected=!1;this.selectedTraces.includes(a.globalId)&&(a.selected=!0)}))}zoomToAsset(a){this.view?.goTo(a).catch(b=>console.error(b))}async _createResultAreaInputGeometry(a){if(null!=a.aggregatedGeometry)return this._geometryHandler.mergeAggregatedToGeometries(a.aggregatedGeometry);a=this.groupResultsByNetworkSource(a.elements);const b=[];for(var c in a)b.push(this.queryFeaturesById(a[c]));try{const d=await Promise.all(b);
c=[];for(const e of d)if(e)for(const f of e)for(const g of f.featureSet.features)c.push(g.geometry);return c}catch{return[]}}_loadUNSupportItems(){if(this.utilityNetwork){var {map:a}=this.view,{messages:b}=this;this._populateOutfields();this._createGraphicLayer(p);this._createGraphicLayer(q);this._resultAreaHandler?.createGraphicLayer(a,b?.alertsStrings.genericResultHeader);this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(a,this.utilityNetwork);this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,
this._getGraphicLayer(p),this._validUNLayers)}}_getUniqueMapLayerViews(a){const b=[];a.layerViews.filter(({layer:{type:c}})=>"feature"===c||"group"===c||"subtype-group"===c).toArray().forEach(c=>{switch(c.layer.type){case "group":if(void 0!==c.layerViews)for(const d of c.layerViews)b.push(d);break;case "subtype-group":b.push(c);break;default:b.some(d=>d.layer.id===c.layer.id)||b.push(c)}});return b}_processFlags(a){const b=[];a.forEach(c=>{if(null!==c.selectedTerminals&&0<c.selectedTerminals.length)c.selectedTerminals.forEach(d=>
{d=new u({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:d,type:c.type,isFilterBarrier:c.isFilterBarrier});b.push(d)});else{const d=new u({globalId:c.globalId,percentAlong:c.percentAlong,type:c.type,isFilterBarrier:c.isFilterBarrier});b.push(d)}});return b}_getDisplayField(a){return"subtype-sublayer"===a?.layer?.type?this._getDisplayFieldBySublayer(a):this._getDisplayFieldByFeatureLayer(a)}_getDisplayFieldBySublayer(a){let b="",c="";const d=a.layer;b=this._checkParentForData(d,"displayField");
for(const e in a.attributes){const f=e.toLowerCase();f===b?.toLowerCase()?(c=a.attributes[e],"assetgroup"===f||"assettype"===f?c=this._checkSubtype(d,d.subtypeCode):(c=this._checkDomain(d.fields,e,c),"string"===typeof c&&(c=this._defaultDisplayField(c,d)))):(c=this._checkDomain(d.fields,e,c),"string"===typeof c&&(c=this._defaultDisplayField(c,d)))}return{field:b,value:c.toString()}}_getDisplayFieldByFeatureLayer(a){const b=a.layer;let c=b.displayField;var d="";for(const e in a.attributes){const f=
e.toLowerCase();f===c?.toLowerCase()?(d=a.attributes[e],"assetgroup"===f||"assettype"===f?((d=a.attributes[b.typeIdField.toUpperCase()])||(d=a.attributes[b.typeIdField.toLowerCase()]),c=b.typeIdField,d=this._checkSubtype(b,d),""===c&&(b.templates&&0<b.templates.length?(c=b.templates[0]?.name,d=b.templates[0]?.name):(c=b.displayField,d=a.attributes[e]))):(d=this._checkDomain(b.fields,e,d),"string"===typeof d&&(d=this._defaultDisplayField(d,b)))):(d=this._checkDomain(b.fields,e,d),"string"===typeof d&&
(d=this._defaultDisplayField(d,b)))}return{field:c,value:d?d.toString():""}}_checkSubtype(a,b){let c=b;"subtype-sublayer"===a.type?(a=this._checkParentForData(a,"subtypes"),0<a?.length&&a.forEach(d=>{d.code===b&&(c=d.name)})):null!=a.types&&0<a.types.length&&(a=a.types.filter(d=>d.id===b),0<a.length&&(c=a[0].name));return c}_checkDomain(a,b,c){let d=c;a=a.filter(e=>e.name.toLowerCase()===b.toLowerCase());0<a.length&&a[0].domain instanceof G&&a[0].domain?.codedValues&&(a=a[0].domain.codedValues.filter(({code:e})=>
e===c),0<a.length&&(d=a[0].name));return d}_checkParentForData(a,b){return a.parent?.[b]??null}_defaultDisplayField(a,b){return a.trim()?a:b.templates&&0<b.templates?.length?b.templates[0].name:b.title}get _uniqueFlagId(){return this._flagId++}_groupBy(a,b){return a.reduce((c,d)=>{(c[d[b]]=c[d[b]]||[]).push(d);return c},{})}async _lookupFlagByHit(a){var b=a.graphic?.geometry;const c=[];if(b&&r.isPoint(b)&&this.view&&(b=this.view.toScreen(b))&&(b=await this.view.hitTest(b,{include:this._validUNLayers}))&&
0<b.results.length&&(b=b.results.find(e=>null!==e.layer),null!=b.graphic?.geometry))if("polyline"===b.graphic.geometry.type){a=this._geometryHandler.getPercentageAlong(b.graphic.geometry,a.graphic?.geometry,b.graphic.geometry.spatialReference);var d=this._getDisplayField(b.graphic);b.graphic.attributes={...b.graphic.attributes,terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:a,displayValue:d,mapPoint:b.mapPoint};c.push(b)}else"point"!==b.graphic.geometry.type&&
"polygon"!==b.graphic.geometry.type||null===this.utilityNetwork||(a=this.utilityNetwork?.getTerminalConfiguration(b.graphic),d=this._getDisplayField(b.graphic),b.graphic.attributes={...b.graphic.attributes,terminalId:a?a.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:a??null,selectedTerminals:[a?a.terminals[0].id||null:1],percentAlong:null,displayValue:d,mapPoint:b.mapPoint},c.push(b));return c}_createFlagProperty(a,b,c){const d=new u;d.terminalId=a.attributes.terminalId;d.isFilterBarrier=
a.attributes.isFilterBarrier;d.percentAlong=a.attributes.percentAlong;d.globalId=a.attributes.globalid||a.attributes.GLOBALID;d.type=b;d.details=a;d.mapGraphic=c;d.id=this._uniqueFlagId;d.allTerminals=a.attributes.allTerminals;d.selectedTerminals=a.attributes.selectedTerminals;d.displayValue=a.attributes.displayValue;d.mapPoint=a.attributes.mapPoint;return d}async _populateOutfields(){const a=this.view?.map,b=this.getValidSources();a?.layers.forEach(c=>{"group"===c.type?c.layers.forEach(d=>{b.some(e=>
e.layerId===d.layerId)&&d.fields.some(e=>"assetgroup"===e.name.toLowerCase())&&(d.outFields=["assetgroup","assettype","globalid","objectid"])}):b.some(d=>d.layerId===c.layerId)&&c.fields.some(d=>"assetgroup"===d.name.toLowerCase())&&(c.outFields=["assetgroup","assettype","globalid","objectid"])})}_removeGraphic(a){this._getGraphicLayer(p)?.remove(a.mapGraphic)}_createGraphicLayer(a){const {map:b}=this.view;b.findLayerById(a)||(a=new F({title:a,listMode:"hide",id:a}),b.add(a))}_getGraphicLayer(a){const {map:b}=
this.view;return b&&(a=b.findLayerById(a))&&"graphics"===a.type?a:null}};k.__decorate([l.property()],h.prototype,"_activeProgress",void 0);k.__decorate([l.property()],h.prototype,"_flags",void 0);k.__decorate([l.property()],h.prototype,"traces",void 0);k.__decorate([l.property()],h.prototype,"defaultGraphicColor",void 0);k.__decorate([l.property()],h.prototype,"enableResultArea",void 0);k.__decorate([l.property()],h.prototype,"flags",void 0);k.__decorate([l.property()],h.prototype,"gdbVersion",void 0);
k.__decorate([l.property()],h.prototype,"messages",void 0);k.__decorate([l.property()],h.prototype,"messagesUnits",void 0);k.__decorate([l.property()],h.prototype,"resultAreaProperties",null);k.__decorate([l.property()],h.prototype,"selectedTraces",void 0);k.__decorate([l.property()],h.prototype,"selectOnComplete",void 0);k.__decorate([l.property()],h.prototype,"showGraphicsOnComplete",void 0);k.__decorate([l.property()],h.prototype,"showSelectionAttributes",void 0);k.__decorate([l.property({readOnly:!0})],
h.prototype,"state",null);k.__decorate([l.property()],h.prototype,"traceResults",void 0);k.__decorate([l.property()],h.prototype,"utilityNetwork",void 0);k.__decorate([l.property({value:null})],h.prototype,"view",null);return h=k.__decorate([D.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],h)});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../rest/support/AttachmentQuery ../../../rest/support/RelationshipQuery ./tableUtils".split(" "),function(e,E,c,A,t,u,F,G,v,f,J,H,I,w,x){c=class extends c{constructor(a){super(a);
this._defaultOutFields=["*"];this._editOperationQueue=new t;this._loading=this._loadError=this._loaded=this._hasStaleCache=!1;this._objectIdCache=new t;this._queryOperationQueue=new t;this.attachmentsEnabled=!1;this.count=0;this.failures=new t;this.filterGeometry=null;this.itemCache=new t;this.relationshipConfig=this.outFields=this.objectIds=this.layer=null;this.returnM=this.returnZ=this.returnGeometry=this.relatedRecordsEnabled=!1;this.where=this.timeExtent=null}initialize(){this.addHandles([v.watch(()=>
[this.filterGeometry,this.layer,this.objectIds,this.relationshipConfig,this.returnGeometry,this.returnM,this.returnZ,this.timeExtent,this.where],()=>this._reset()),v.when(()=>this.attachmentsEnabled,()=>this._reset()),v.when(()=>this.relatedRecordsEnabled,()=>this._reset())])}destroy(){this.layer=null;this.itemCache?.destroy();this.failures?.destroy()}get _capabilities(){const {layer:a}=this;return a?.effectiveCapabilities??a?.capabilities}get _effectiveReturnZ(){return this.returnZ&&this.supportsZ}get _effectiveReturnM(){return this.returnM&&
this.supportsM}get _layerWithAttachments(){const {_capabilities:a,attachmentsEnabled:b,layer:d,supportsAttachments:g}=this;if(a&&d&&b&&g)return x.isIFeatureTableSupportedLayerWithAttachments(d)?d:null}get _layerWithEditing(){const a=this.layer;return x.isIFeatureTableSupportedLayerWithEditing(a)&&this.supportsEditing?a:null}get _layerWithRelationships(){const a=this.layer;return x.isIFeatureTableSupportedLayerWithRelationships(a)&&this.supportsQueryRelated?a:null}get _relatedLayer(){return this.relationshipConfig?.relatedLayer}get _relatedLayerCapabilities(){const {_relatedLayer:a}=
this;return a?.effectiveCapabilities??a?.capabilities}get _relatedLayerSupportsCacheHint(){return!!this._relatedLayerCapabilities?.queryRelated?.supportsCacheHint}get _relatedLayerSupportsQuery(){return!!this._relatedLayerCapabilities?.operations.supportsQuery}get _relatedLayerSupportsQueryRelated(){const {_relatedLayerCapabilities:a}=this;return!!a?.queryRelated?.supportsCount&&!!a?.queryRelated?.supportsPagination}get _canUseRelatedLayer(){return!(!this._relatedLayerSupportsQuery||!this._relatedLayerSupportsQueryRelated)}get canAddRelatedFeature(){const {state:a,
relationship:b,supportsAdd:d,supportsEditing:g}=this;if("loaded"!==a||!b||!d||!g)return!1;var {count:h}=this;const {cardinality:k,role:l}=b;h=0<h;return"one-to-one"===k&&h||"one-to-many"===k&&"origin"===l&&h?!1:!0}get effectiveOutFields(){return this.outFields||this._defaultOutFields}get effectiveTimeExtent(){const {layer:a,timeExtent:b}=this;return b||a&&"timeExtent"in a&&a.timeExtent||null}get effectiveWhere(){return this.where||this.layer?.definitionExpression||"1\x3d1"}get orderByFields(){return this._get("orderByFields")||
[]}set orderByFields(a){A.equals(a,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}get querying(){return 0<this._queryOperationQueue.length}get relationship(){const {relationshipConfig:a}=this;return null==a?.relationshipId?null:this.relationships?.find(b=>b.id===a.relationshipId)}get relationshipIds(){return this.relationships?.map(a=>a.id)??[]}get relationships(){return this._layerWithRelationships?.relationships}get state(){const {layer:a,_loaded:b,
_loadError:d,_loading:g}=this;return!a||a.destroyed?"disabled":d||a.loadError?"error":"loaded"===a.loadStatus&&b?"loaded":g?"loading":"ready"}get supportsAdd(){return!!this._capabilities?.operations.supportsAdd}get supportsAttachments(){const {_capabilities:a}=this;return!(!a?.data?.supportsAttachment||!a?.operations.supportsQueryAttachments)}get supportsCacheHint(){return!!this._capabilities?.query?.supportsCacheHint}get supportsCacheHintQueryRelated(){return!!this._capabilities?.queryRelated?.supportsCacheHint}get supportsDelete(){return!!this._capabilities?.operations.supportsDelete}get supportsEditing(){return!!this._capabilities?.operations.supportsEditing}get supportsM(){return!!this.layer?.hasM&&
!!this._capabilities?.data?.supportsM}get supportsOrderBy(){return!!this._capabilities?.query?.supportsOrderBy}get supportsPagination(){return!!this._capabilities?.query?.supportsPagination}get supportsQuery(){return!!this._capabilities?.operations.supportsQuery}get supportsQueryRelated(){const {_capabilities:a}=this;return!!a?.queryRelated?.supportsCount&&!!a?.queryRelated?.supportsPagination}get supportsUpdate(){return!!this._capabilities?.operations.supportsUpdate}get supportsZ(){return!!this.layer?.hasZ&&
!!this._capabilities?.data?.supportsZ}get syncing(){return 0<this._editOperationQueue.length}async load(){const {layer:a}=this;if(!this._loading&&!this._loaded&&a){this._reset();this._loading=!0;try{await a.when(),await this._syncLayerInfo(),this._loaded=!0,this._loading=!1}catch(b){throw this._reset(),this._loadError=!0,this._logError("store:load-error","An error occurred."),b;}}}async refreshLayerInfo(){return this._syncLayerInfo()}async addItems(a){}async fetchItems(a){const {page:b,pageSize:d}=
a;a=b*d;const {layer:g,state:h}=this;return g&&"loaded"===h?this._query({layer:g,start:a,num:a+d,page:b,pageSize:d}):[]}async verifyFeaturesByObjectId(a){const {layer:b,state:d}=this;if(!b||"loaded"!==d)return[];const {objectIdField:g}=b,{features:h}=await this._verifyFeaturesByObjectId(a);return a.map(k=>h.some(l=>{l=l.getObjectId()??l.attributes[g];return k===l}))}async query(a){const {state:b}=this;return this.supportsQuery&&"loaded"===b?this._query(a):[]}async removeItemAt(a){}async reset(){this._reset()}async updateItem(a){await this._update(a)}async deleteRowsByObjectId(a){const {_layerWithEditing:b}=
this;if(!this.supportsDelete||!b)throw new u("store:delete-error","Delete is not supported.");const d=a.map(g=>this.getItemByObjectId(g)?.feature).filter(A.isSome);return this._queueEditOperation(()=>b.applyEdits({deleteFeatures:d}))}getItemByObjectId(a){const {itemCache:b,layer:d}=this;if(d){var g=d.objectIdField;return b.find(({feature:h})=>h?(h.getObjectId()??h.attributes[g])===a:!1)}}getItemIndexByObjectId(a){const {itemCache:b,layer:d}=this;if(!d)return-1;const g=d.objectIdField;return b.findIndex(({feature:h})=>
h?(h.getObjectId()??h.attributes[g])===a:!1)}getLocalItemAt(a){return this.itemCache.at(a)}at(a){return Promise.resolve(this.itemCache.at(a))}_reset(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue.removeAll();this._queryOperationQueue.removeAll();this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIdCache.removeAll()}_getIdsFromFeatures(a,b){return a.map(d=>d.getObjectId()??d.attributes[b])}_resultsToFeatureData(a){const {attachments:b,
features:d,layer:g,relatedRecords:h}=a,k=g.objectIdField;return d.map(l=>{const {attributes:n}=l,m=l.getObjectId()??n[k],p=[];l.layer||l.sourceLayer||(l.layer=g,l.sourceLayer=g);h.forEach((q,r)=>{p.push({relationshipId:r,count:q[m]??0})});return{objectId:m,feature:l,attachments:b[m]??null,relatedRecords:p}})}async _update(a){const {_layerWithEditing:b}=this;if(!this.supportsUpdate||!b)throw new u("store:update-error","Update is not supported.");const {index:d,name:g,value:h}=a;a=await this.at(d);
if(!a?.feature)throw new u("store:update-error","Feature with provided 'objectId' not found.");const {feature:k}=a,l=F.clone(k.attributes);l[g]=h;a=new E({attributes:l});const n=b.applyEdits({updateFeatures:[a]}).then(m=>{const {updateFeatureResults:p}=m,q=p.find(r=>!!r.error);if(q)throw q.error;p.length&&(k.attributes=l);return m});return this._queueEditOperation(()=>n)}async _query(a){const {refresh:b}=a;if(!0===b)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(a));
this._hasStaleCache&&(await this._syncObjectIdCache(),this._hasStaleCache=!1);return this._queryFeatureData(a)}async _queryFeatureData(a){const {layer:b}=a;return this._queueQueryOperation(async()=>{const d=await this._queryFeatures(a);var g=this._getIdsFromFeatures(d,b.objectIdField);const h=await this._queryAttachments(g);g=await this._queryRelatedCounts(g);return this._resultsToFeatureData({layer:b,features:d,attachments:h,relatedRecords:g})||[]})}async _syncLayerInfo(){await this._syncCount();
await this._syncObjectIdCache()}async _syncCount(){await this._queryCount().then(a=>this._set("count",a))}async _syncObjectIdCache(){if(!this.supportsPagination){var a=await this._queryForObjectIds();this._objectIdCache.removeAll();this._objectIdCache.addMany(a)}}async _queryCount(){const {_relatedLayerSupportsCacheHint:a,layer:b,relationshipConfig:d,supportsCacheHint:g}=this;if(!b)return 0;if(d&&this._canUseRelatedLayer){const {objectId:p,relatedLayer:q,relationshipId:r}=d;return(await q.queryRelatedFeaturesCount(new w({cacheHint:a,
relationshipId:r,objectIds:[p]})))[p]??0}const {effectiveTimeExtent:h,effectiveWhere:k,filterGeometry:l,objectIds:n}=this,m=b.createQuery();m.geometry=l;m.returnGeometry=!1;m.where=k;m.timeExtent=h;m.objectIds=n?.length?n:void 0;g&&(m.cacheHint=!0);return b.queryFeatureCount(m)}async _queryRelatedCounts(a){const {_layerWithRelationships:b,relationshipIds:d,supportsCacheHintQueryRelated:g}=this,h=new Map;if(!b||!a?.length||!d.length)return h;await Promise.allSettled(d.map(async k=>{const l=await b.queryRelatedFeaturesCount(new w({cacheHint:g,
relationshipId:k,objectIds:a}));h.set(k,l)}));return h}_queryForObjectIds(){const {effectiveTimeExtent:a,effectiveWhere:b,filterGeometry:d,layer:g,objectIds:h,orderByFields:k,supportsCacheHint:l,supportsOrderBy:n}=this;if(!g)return Promise.resolve([]);const m=g.createQuery();m.geometry=d;m.outFields=[g.objectIdField];m.returnGeometry=!1;m.where=b;m.timeExtent=a;m.objectIds=h?.length?h:void 0;n&&(m.orderByFields=k);l&&(m.cacheHint=!0);return g.queryObjectIds(m)}async _queryFeatures(a){var {relationshipConfig:b}=
this;if(b&&this._canUseRelatedLayer)return this._queryRelatedFeatures(a,b);const {_effectiveReturnM:d,_effectiveReturnZ:g,effectiveOutFields:h,effectiveTimeExtent:k,effectiveWhere:l,filterGeometry:n,objectIds:m,orderByFields:p,returnGeometry:q,supportsCacheHint:r,supportsOrderBy:y,supportsPagination:z}=this,{layer:B,start:C,pageSize:D}=a;a=m?.length;b=B.createQuery();b.returnGeometry=q;b.outFields=h;b.returnM=d;b.returnZ=g;z?(b.start=C,b.num=D,b.where=l,b.timeExtent=k,b.objectIds=a?m:void 0):b.objectIds=
a?m:this._getObjectIdsForPage(C,D??0);y&&(b.orderByFields=p);n&&(b.geometry=n);r&&(b.cacheHint=!0);return(await B.queryFeatures(b)).features}async _queryRelatedFeatures(a,b){const {_defaultOutFields:d,_effectiveReturnM:g,_effectiveReturnZ:h,orderByFields:k,returnGeometry:l,supportsCacheHint:n}=this,{layer:m,start:p,pageSize:q}=a,{objectId:r,relatedLayer:y,relationshipId:z}=b;a=m.createQuery();a=new w({cacheHint:n,num:q??0,objectIds:[r],orderByFields:k,outFields:d,relationshipId:z,returnGeometry:l,
returnM:g,returnZ:h,start:p,where:a.where??void 0});return(await y.queryRelatedFeatures(a))[r]?.features||[]}async _verifyFeaturesByObjectId(a){const {layer:b}=this;if(!b||!this.supportsQuery)throw new u("store:query-error","Layer does not support query operation.");const {effectiveTimeExtent:d,effectiveWhere:g,orderByFields:h,supportsCacheHint:k,supportsOrderBy:l}=this,n=b.createQuery();n.where=g;n.timeExtent=d;n.returnGeometry=!1;n.objectIds=a.length?a:void 0;n.outFields=[b.objectIdField];l&&(n.orderByFields=
h);k&&(n.cacheHint=!0);return b.queryFeatures(n)}_getObjectIdsForPage(a,b){const d=this._objectIdCache.toArray();return d.length>=a+b?d.slice(a,a+b):d.slice(a)}_queryAttachments(a){const {_layerWithAttachments:b,effectiveWhere:d}=this;return b?b.queryAttachments(new I({objectIds:a,where:d})):Promise.resolve({})}_syncLocalCache(a){const {layer:b}=this;if(b){var {objectIdField:d}=b,{itemCache:g}=this;a.forEach(h=>{if(h?.feature){var {feature:k}=h;k=k.getObjectId()??k.attributes[d];null!=k&&(k=this.getItemIndexByObjectId(k),
-1===k?g.add(h):g.splice(k,1,h))}})}}_queueQueryOperation(a){this._queryOperationQueue.push(a);return a().then(b=>this._queryOperationQueue.includes(a)?(this._syncLocalCache(b),b):[]).catch(b=>{this._logError("store:query-error","An error occurred.");const d={error:b,retry:()=>{this.failures.remove(d);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(d)};this.failures.add(d);return[]}).then(b=>{this._queryOperationQueue.remove(a);return b})}_queueEditOperation(a){this._editOperationQueue.push(a);
return a().then(b=>{this._editOperationQueue.remove(a);return b}).catch(b=>{this._logError("store:edit-error","An error occurred.");const d={error:b,retry:()=>{this.failures.remove(d);this._queueEditOperation(a)},cancel:()=>this.failures.remove(d)};this.failures.add(d);this._editOperationQueue.remove(a);throw b;})}_logError(a,b){G.getLogger(this).error(a,b)}};e.__decorate([f.property({readOnly:!0})],c.prototype,"_capabilities",null);e.__decorate([f.property()],c.prototype,"_defaultOutFields",void 0);
e.__decorate([f.property()],c.prototype,"_editOperationQueue",void 0);e.__decorate([f.property()],c.prototype,"_effectiveReturnZ",null);e.__decorate([f.property()],c.prototype,"_effectiveReturnM",null);e.__decorate([f.property()],c.prototype,"_hasStaleCache",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"_layerWithAttachments",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"_layerWithEditing",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"_layerWithRelationships",
null);e.__decorate([f.property()],c.prototype,"_loaded",void 0);e.__decorate([f.property()],c.prototype,"_loadError",void 0);e.__decorate([f.property()],c.prototype,"_loading",void 0);e.__decorate([f.property()],c.prototype,"_objectIdCache",void 0);e.__decorate([f.property()],c.prototype,"_queryOperationQueue",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"_relatedLayer",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"_relatedLayerCapabilities",null);e.__decorate([f.property({readOnly:!0})],
c.prototype,"_relatedLayerSupportsCacheHint",null);e.__decorate([f.property()],c.prototype,"_relatedLayerSupportsQuery",null);e.__decorate([f.property()],c.prototype,"_relatedLayerSupportsQueryRelated",null);e.__decorate([f.property()],c.prototype,"_canUseRelatedLayer",null);e.__decorate([f.property()],c.prototype,"attachmentsEnabled",void 0);e.__decorate([f.property()],c.prototype,"canAddRelatedFeature",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"count",void 0);e.__decorate([f.property()],
c.prototype,"effectiveOutFields",null);e.__decorate([f.property()],c.prototype,"effectiveTimeExtent",null);e.__decorate([f.property()],c.prototype,"effectiveWhere",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"failures",void 0);e.__decorate([f.property()],c.prototype,"filterGeometry",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"itemCache",void 0);e.__decorate([f.property()],c.prototype,"layer",void 0);e.__decorate([f.property()],c.prototype,"objectIds",void 0);e.__decorate([f.property()],
c.prototype,"orderByFields",null);e.__decorate([f.property()],c.prototype,"outFields",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"querying",null);e.__decorate([f.property()],c.prototype,"relationship",null);e.__decorate([f.property()],c.prototype,"relationshipConfig",void 0);e.__decorate([f.property()],c.prototype,"relationshipIds",null);e.__decorate([f.property()],c.prototype,"relationships",null);e.__decorate([f.property()],c.prototype,"relatedRecordsEnabled",void 0);e.__decorate([f.property()],
c.prototype,"returnGeometry",void 0);e.__decorate([f.property()],c.prototype,"returnZ",void 0);e.__decorate([f.property()],c.prototype,"returnM",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"state",null);e.__decorate([f.property()],c.prototype,"supportsAdd",null);e.__decorate([f.property()],c.prototype,"supportsAttachments",null);e.__decorate([f.property()],c.prototype,"supportsCacheHint",null);e.__decorate([f.property()],c.prototype,"supportsCacheHintQueryRelated",null);e.__decorate([f.property()],
c.prototype,"supportsDelete",null);e.__decorate([f.property()],c.prototype,"supportsEditing",null);e.__decorate([f.property()],c.prototype,"supportsM",null);e.__decorate([f.property()],c.prototype,"supportsOrderBy",null);e.__decorate([f.property()],c.prototype,"supportsPagination",null);e.__decorate([f.property()],c.prototype,"supportsQuery",null);e.__decorate([f.property()],c.prototype,"supportsQueryRelated",null);e.__decorate([f.property()],c.prototype,"supportsUpdate",null);e.__decorate([f.property()],
c.prototype,"supportsZ",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"syncing",null);e.__decorate([f.property()],c.prototype,"timeExtent",void 0);e.__decorate([f.property()],c.prototype,"where",void 0);return c=e.__decorate([H.subclass("esri.widgets.FeatureTable.support.FeatureStore")],c)});
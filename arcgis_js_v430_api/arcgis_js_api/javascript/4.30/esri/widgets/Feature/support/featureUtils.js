// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../smartMapping/support/utils ../../../support/arcadeOnDemand ../../../time/timeZoneUtils".split(" "),function(g,q,r,t,m,p,Q,u,R,S){function B(a){return a?C.test(a):!1}function T(a,b){if(b&&B(b)&&a){var c=b.replace(C,"").toLowerCase();return a.find(({name:d})=>d.toLowerCase()===c)}}function v(a,b){return(b=w(b,a))?b.name:a}function w(a,
b){return a&&"function"===typeof a.getField&&b?a.getField(b)??null:null}function D({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${r.replace(r.replace(b,d=>`{${c.get(d.toLowerCase())?.fieldName||d}}`),a).replaceAll(U,"")}`.trim()}function V(a,b,c=!1){const d=b[a];"string"===typeof d&&(c=(c?encodeURIComponent(d):d).replaceAll(W,"%27"),b[a]=c)}function X(a,b=!1){const c={...a};Object.keys(c).forEach(d=>V(d,c,b));return c}function E(a,b){return a.replaceAll(Y,(c,d,f)=>(c=w(b,f))?`{${c.name}}`:
d)}function Z(a,b,c){return(a=E(a,c))?a.replaceAll(aa,(d,f,e)=>{f=`${f||e}`.trim();return r.replace(d,X(b,f&&"{"!==f[0]||!1))}):a}function F(a){return null!=a&&"object"===typeof a&&"fieldsIndex"in a&&"geometryType"in a&&"getField"in a&&"load"in a&&"loaded"in a&&"objectIdField"in a&&"spatialReference"in a&&"type"in a&&("feature"===a.type||"scene"===a.type||"sublayer"===a.type)&&"when"in a}function G(a){return null!=a&&"object"===typeof a&&"createQuery"in a&&"queryFeatureCount"in a&&"queryObjectIds"in
a&&"queryRelatedFeatures"in a&&"queryRelatedFeaturesCount"in a&&"relationships"in a}function x(a){return F(a)&&G(a)}function H(a,b){const {fieldInfos:c,fieldName:d,preventPlacesFormatting:f,layer:e,timeZone:k}=b;b=I(c,d);var h=w(e,d);if(b&&!p.isRasterPixelValueField(d)){h=h?.type;const l=b.format?.dateFormat;if("date"===h||"date-only"===h||"time-only"===h||"timestamp-offset"===h||l)return u.formatAnyDate(a,{format:l,fieldType:h,timeZoneOptions:{layerTimeZone:e&&"preferredTimeZone"in e?e.preferredTimeZone:
null,viewTimeZone:k,datesInUnknownTimezone:e&&"datesInUnknownTimezone"in e?!!e.datesInUnknownTimezone:!1}})}b=b?.format;if("string"===typeof a&&p.isRasterPixelValueField(d)&&b)return a=a.trim(),/\d{2}-\d{2}/.test(a)?a:a.includes(",")?y(a,",",", ",b):a.includes(";")?y(a,";","; ",b):a.includes(" ")?y(a," "," ",b):m.formatNumber(Number(a),m.convertNumberFormatToIntlOptions(b));"string"!==typeof a||!b||null!=b.dateFormat||null==b.places&&null==b.digitSeparator||(h=Number(a),isNaN(h)||(a=h));return"string"===
typeof a||null==a||null==b?z(a):f?m.formatNumber(a,{...m.convertNumberFormatToIntlOptions(b),minimumFractionDigits:0,maximumFractionDigits:20}):m.formatNumber(a,m.convertNumberFormatToIntlOptions(b))}function y(a,b,c,d){return a.trim().split(b).map(f=>m.formatNumber(Number(f),m.convertNumberFormatToIntlOptions(d))).join(c)}function I(a,b){if(a?.length&&b)return a.find(c=>c.fieldName?.toLowerCase()===b.toLowerCase())}function ba({fieldName:a,graphic:b,layer:c}){if(A(a)||!c||"function"!==typeof c.getFeatureType)return null;
const {typeIdField:d}=c;return d&&a===d?(a=c.getFeatureType(b))?a.name:null:null}function ca({fieldName:a,value:b,graphic:c,layer:d}){return A(a)||!d||"function"!==typeof d.getFieldDomain?null:(a=c&&d.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null}function z(a){return"string"===typeof a?a.replaceAll(da,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function J(a){const {value:b,fieldName:c,fieldInfos:d,fieldInfoMap:f,layer:e,graphic:k,timeZone:h}=a;return null==b?"":(a=ca({fieldName:c,
value:b,graphic:k,layer:e}))||(a=ba({fieldName:c,graphic:k,layer:e}))?a:f.get(c.toLowerCase())?H(b,{fieldInfos:d||Array.from(f.values()),fieldName:c,layer:e,timeZone:h}):(a=e?.fieldsIndex?.get(c))&&(u.isAnyDateField(a)||p.isTimeOnlyField(a))?u.formatAnyDate(b,{fieldType:a.type,timeZoneOptions:{layerTimeZone:e&&"preferredTimeZone"in e?e.preferredTimeZone:null,viewTimeZone:h,datesInUnknownTimezone:e&&"datesInUnknownTimezone"in e?!!e.datesInUnknownTimezone:!1}}):z(b)}async function K(a,b){const {layer:c,
graphic:d,outFields:f,objectIds:e,returnGeometry:k,spatialReference:h}=a;a=e[0];if("number"!==typeof a&&"string"!==typeof a)return b={layer:c,graphic:d,objectId:a,requiredFields:f},q.getLogger("esri.widgets.Feature.support.featureUtils").warn("Could not query required fields for the specified feature. The feature's ID is invalid.",b),null;if(!Q.getEffectiveLayerCapabilities(c)?.operations?.supportsQuery)return b={layer:c,graphic:d,requiredFields:f,returnGeometry:k},q.getLogger("esri.widgets.Feature.support.featureUtils").warn("The specified layer cannot be queried. The following fields will not be available.",
b),null;a=c.createQuery();a.objectIds=e;a.outFields=f?.length?f:[c.objectIdField];a.returnGeometry=!!k;a.returnZ=!!k;a.returnM=!!k;a.outSpatialReference=h;return(await c.queryFeatures(a,b)).features[0]}async function ea(a){if(!a.expressionInfos?.length)return!1;var b=await R.loadArcade();({arcadeUtils:{hasGeometryFunctions:b}}=b);return b(a)}function A(a=""){return a?a.includes("relationships/"):!1}function L({attributes:a,graphic:b,relatedInfo:c,fieldInfos:d,fieldInfoMap:f,layer:e,timeZone:k}){a&&
b&&c&&Object.keys(b.attributes).forEach(h=>{var l=(l={layerId:c.relation.id.toString(),fieldName:h},`${"relationships/"}${l.layerId}/${l.fieldName}`);a[l]=J({fieldName:l,fieldInfos:d,fieldInfoMap:f,layer:e,value:b.attributes[h],graphic:b,timeZone:k})})}function fa({attributes:a,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e}){a&&b&&(b.relatedFeatures?.forEach(k=>L({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e})),b.relatedStatsFeatures?.forEach(k=>
L({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e})))}function M(a,b){return a?.allTables.find(c=>"feature"===c.type&&c.layerId===b.id&&c.url===b.layer?.url)}function n({map:a,relationship:b,relationship:{relatedTableId:c},relatedLayer:d,layers:f}){if(!f)return null;for(const e of f)if("map-image"===e.type){if(f=n({layers:e.sublayers,map:a,relatedLayer:d,relationship:b})||n({layers:e.subtables,map:a,relatedLayer:d,relationship:b}))return f}else if(x(e))if("sublayer"===
d.type){if(e!==d&&e.id===c)return e.isTable?M(a,e):e}else{f="scene"===d.type&&d.associatedLayer?d.associatedLayer.url:d.url;if(!f)break;if("sublayer"===e.type){if(e!==d&&e.layer?.url===f&&e.id===c)return e.isTable?M(a,e):e}else if(e!==d&&e.url===f&&e.layerId===c)return e}return null}const U=/href=(""|'')/gi,Y=/(\{([^{\r\n]+)\})/g,W=/'/g,C=/^\s*expression\//i,da=/(\n)/gi,ha=/[\u00A0-\u9999<>&]/gim,aa=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,ia=/^(?:mailto:|tel:)/,N=t.convertDateFormatToIntlOptions("short-date-short-time"),
O=a=>{if(!a)return!1;a=a.toUpperCase();return a.includes("CURRENT_TIMESTAMP")||a.includes("CURRENT_DATE")||a.includes("CURRENT_TIME")},P=({layer:a,method:b,query:c,definitionExpression:d})=>{a.capabilities?.query?.supportsCacheHint&&"attachments"!==b&&(a=null!=c.where?c.where:null,b=null!=c.geometry?c.geometry:null,O(d)||O(a)||"extent"===b?.type||"tile"===c.resultType||(c.cacheHint=!0))};g.applyTextFormattingHTML=z;g.createFieldInfoMap=function(a,b){const c=new Map;if(!a)return c;for(const d of a)d.fieldName&&
(a=v(d.fieldName,b),d.fieldName=a,c.set(a.toLowerCase(),d));return c};g.findRelatedLayer=function(a,b,c){return a&&b&&c?"sublayer"===b.type?n({layers:b.layer?.sublayers,map:a,relatedLayer:b,relationship:c})||n({layers:b.layer?.subtables,map:a,relatedLayer:b,relationship:c}):n({layers:a.allLayers,map:a,relatedLayer:b,relationship:c})||n({layers:a.allTables,map:a,relatedLayer:b,relationship:c}):null};g.fixTokens=E;g.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:d,fieldInfoMap:f,
relatedInfos:e,timeZone:k}){const h={};e?.forEach(l=>fa({attributes:h,relatedInfo:l,fieldInfoMap:f,fieldInfos:a,layer:c,timeZone:k}));b&&Object.keys(b).forEach(l=>{h[l]=J({fieldName:l,fieldInfos:a,fieldInfoMap:f,layer:c,value:b[l],graphic:d,timeZone:k})});return h};g.formatEditInfo=function(a,b,c,d){const {creatorField:f,creationDateField:e,editorField:k,editDateField:h}=a;if(b){a=S.getTimeZoneFormattingOptions(d&&"preferredTimeZone"in d?d.preferredTimeZone:null,d&&"datesInUnknownTimezone"in d?!!d.datesInUnknownTimezone:
!1,c,N,"date");a={...N,...a};c=b[h];if("number"===typeof c)return b=b[k],{type:"edit",date:t.formatDate(c,a),user:b};c=b[e];return"number"===typeof c?(b=b[f],{type:"create",date:t.formatDate(c,a),user:b}):null}};g.formatValueToFieldInfo=H;g.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:d}=a;c&&b.push(...c);if(!d||!Array.isArray(d))return b;d.forEach(f=>{"fields"===f.type&&(f=f?.fieldInfos)&&b.push(...f)});return b};g.getFieldInfo=I;g.getFieldInfoLabel=function(a,
b){return(b=T(b,a?.fieldName))?b.title||null:a?a.label||a.fieldName:null};g.getFixedFieldName=v;g.getFixedFieldNames=function(a,b){return a&&a.map(c=>v(c,b))};g.getHighlightKeyForFeature=function(a){const b=a.getObjectId();return null!=b?`oid:${b}`:`uid:${a.uid}`};g.getSourceLayer=function(a){if(null!=a)return(a.sourceLayer||a.layer)??void 0};g.graphicCallback=async function({type:a,value:b,event:c}){try{return"function"===typeof b?b(c):b}catch(d){q.getLogger("esri.widgets.Feature.support.featureUtils").error("error",
`An error occurred when calling the "${a}" function`,{error:d,graphic:c.graphic,value:b})}};g.htmlEntities=function(a){return a.replaceAll(ha,b=>`&#${b.charCodeAt(0)};`)};g.isExpressionField=B;g.isFeatureSupportedLayer=F;g.isGraphicForRelatableFeatureSupportedLayer=function(a){return!!a&&"object"===typeof a&&"sourceLayer"in a&&x(a.sourceLayer)};g.isRelatableFeatureSupportedLayer=x;g.isRelatableLayer=G;g.isRelatedField=A;g.preLayerQueryCallback=({query:a,layer:b,method:c})=>{P({layer:b,method:c,query:a,
definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression??""}`})};g.preRequestCallback=({queryPayload:a,layer:b,method:c})=>{P({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression??""}`})};g.querySourceLayer=K;g.queryUpdatedFeature=async function({graphic:a,popupTemplate:b,layer:c,spatialReference:d},f){if(c&&b&&("function"===typeof c.load&&await c.load(f),a.attributes)){var e=c.objectIdField,k=a.attributes[e];if(null!=k){k=
[k];var h=await b.getRequiredFields(c.fieldsIndex),l=p.featureHasFields(h,a);e=l?[]:h.includes(e)?h:[...h,e];b=b.returnGeometry||await ea(b);if(!l||b)if(c=await K({layer:c,graphic:a,outFields:e,objectIds:k,returnGeometry:b,spatialReference:d},f))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes={...a.attributes,...c.attributes})}}};g.shouldOpenInNewTab=function(a=""){if(a)return!ia.test(a.trim().toLowerCase())};g.substituteAttributes=D;g.substituteFieldsInLinksAndAttributes=function({attributes:a,
globalAttributes:b,layer:c,text:d,expressionAttributes:f,fieldInfoMap:e}){return d?D({formattedAttributes:b,template:Z(d,{...b,...f,...a},c),fieldInfoMap:e}):""};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
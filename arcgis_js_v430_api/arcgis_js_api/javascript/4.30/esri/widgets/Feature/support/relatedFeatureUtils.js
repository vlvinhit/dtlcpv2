// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../request ../../../core/arrayUtils ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../core/has ../../../layers/support/source/DataLayerSource ../../../rest/query/executeQueryJSON ../../../config ../../../kernel ../../../core/urlUtils ../../../core/unitUtils ../../../geometry/ellipsoidUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/aaBoundingBox ../../../core/mathUtils ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Multipoint ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../../../geometry/support/normalizeUtilsCommon ../../../geometry/SpatialReference ../../../geometry/support/Ellipsoid ../../../geometry ../../../core/pbf ../../../rest/support/FeatureSet ../../../rest/support/Query ../../../rest/query/support/AttachmentInfo ../../../rest/support/AttachmentQuery ../../../rest/support/RelationshipQuery ../../../rest/support/TopFeaturesQuery ../../../rest/support/StatisticDefinition ./featureUtils".split(" "),
function(g,C,v,w,x,k,D,P,Q,p,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea,fa,ha,ia,ja,ka,la,q,ma,na,E,oa,F,G){function H(a,b){if(!b.relationships)return null;let c=null;({relationships:b}=b);b.some(e=>e.id===parseInt(a,10)?(c=e,!0):!1);return c}function y({originRelationship:a,relationships:b,layerId:c}){return b.find(({relatedTableId:e,id:d})=>`${e}`===c&&d===a?.id)??null}function I(a,b){b=b.toLowerCase();for(const c in a)if(c.toLowerCase()===b)return a[c];return null}function J(a,b,c,e){const d=new E;d.outFields=
["*"];d.relationshipId="number"===typeof b.id?b.id:parseInt(b.id,10);d.objectIds=[a.attributes[c.objectIdField]];d.gdbVersion=c.gdbVersion??null;d.historicMoment=c.historicMoment??null;return c.queryRelatedFeatures?.(d,e)??Promise.resolve({})}function K(a,b,c){let e=0;const d=[];for(;e<b.length;)d.push(`${a} IN (${b.slice(e,c+e)})`),e+=c;return d.join(" OR ")}function z(a){return a?v.unique(a):void 0}function A(a){return a?v.unique(a,(b,c)=>JSON.stringify(b.toJSON())===JSON.stringify(c.toJSON())):
void 0}async function L(a,b,c,e){var d=c.layerId.toString();const {layerInfo:f,relation:h,relatedFields:l,outStatistics:M,url:r,sourceSpatialReference:t}=b;b=z(l);const m=A(M);if(!f||!h)return null;const n=y({originRelationship:h,relationships:f.relationships,layerId:d});if(n?.relationshipTableId&&n.keyFieldInRelationshipTable){d=(await J(a,n,c,e))[a.attributes[c.objectIdField]];if(!d)return null;var u=d.features.map(N=>N.attributes[f.objectIdField]);if(m?.length&&f.supportsStatistics)return e=new q,
e.where=K(f.objectIdField,u,1E3),e.outFields=b,e.outStatistics=m,e.sourceSpatialReference=t,e={features:Promise.resolve(d),statsFeatures:p.executeQueryJSON(r,e)},k.eachAlways(e)}return(d=n?.keyField)?(u=D.isNumericField(O(f.fields,d)),a=I(a.attributes,h.keyField),a=u?`${d}=${a}`:`${d}='${a}'`,c=p.executeQueryJSON(r,new q({where:a,outFields:b,sourceSpatialReference:t,historicMoment:c.historicMoment,gdbVersion:c.gdbVersion}),e),e=m?.length&&f.supportsStatistics?p.executeQueryJSON(r,new q({where:a,outFields:b,
outStatistics:m,sourceSpatialReference:t}),e):null,b={features:c},e&&(b.statsFeatures=e),k.eachAlways(b)):null}function O(a,b){if(null!=a){b=b.toLowerCase();for(const c of a)if(c&&c.name.toLowerCase()===b)return c}return null}const B=new Map;g.createRelatedInfo=function(a,b){if(a=H(a,b))return{url:`${b.url}/${a.relatedTableId}`,sourceSpatialReference:b.spatialReference,relation:a,relatedFields:[],outStatistics:[]}};g.getDestinationRelation=y;g.getRelatedFieldInfo=function(a){if(!G.isRelatedField(a))return null;
const [b,c]=a.split("/").slice(1);return{layerId:b,fieldName:c}};g.getUniqueOutFields=z;g.getUniqueOutStatistics=A;g.queryLayerInfos=function({relatedInfos:a,layer:b},c){const e={};a.forEach((d,f)=>{({relation:d}=d);if(!d)throw f=new w("relation-required","A relation is required on a layer to retrieve related records."),x.getLogger("esri.widgets.Feature.support.relatedFeatureUtils").error(f),f;({relatedTableId:d}=d);if("number"!==typeof d)throw f=new w("A related table ID is required on a layer to retrieve related records."),
x.getLogger("esri.widgets.Feature.support.relatedFeatureUtils").error(f),f;d=`${b.url}/${d}`;const h=B.get(d),l=h??C(d,{query:{f:"json"},signal:(void 0)?.signal});h||B.set(d,l);e[f]=l});return k.whenOrAbort(k.eachAlways(e),c)};g.queryRelatedFeatures=function({graphic:a,relatedInfos:b,layer:c},e){const d={};b.forEach((f,h)=>{f.layerInfo&&(d[h]=L(a,f,c,e))});return k.eachAlways(d)};g.setRelatedFeatures=function(a,b){if(b&&a){var {features:c,statsFeatures:e}=a;a=c?.value;b.relatedFeatures=a?a.features:
[];a=e?.value;b.relatedStatsFeatures=a?a.features:[]}};g.updateRelatedInfo=function({relatedInfo:a,fieldName:b,fieldInfo:c}){a.relatedFields?.push(b);c.statisticType&&(b=new F({statisticType:c.statisticType,onStatisticField:b,outStatisticFieldName:b}),a.outStatistics?.push(b))};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
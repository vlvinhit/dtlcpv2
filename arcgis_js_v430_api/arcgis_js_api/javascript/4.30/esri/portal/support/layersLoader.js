// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../layers/support/arcgisLayerUrl ../../layers/support/fetchService ../../layers/support/LayerLoadContext ../../layers/support/layersCreator ../../layers/support/lazyLayerLoader ../Portal ./jsonContext ./loadUtils ./portalItemUtils ../../renderers/support/styleUtils ../../support/requestPresets".split(" "),function(p,m,v,w,q,x,y,z,r,k,A,B,C){async function D(a,c){const b=a.instance,d=b.portalItem;if(d){var {url:e,title:g}=d,f=r.createForItemRead(d,"portal-item");
if("group"===b.type)return E(b,f,a);e&&"media"!==b.type&&b.read({url:e},f);var h=new q.LayerLoadContext;(a=await t(a,h,c))&&b.read(a,f);b.resourceReferences={portalItem:d,paths:f.readResourcePaths??[]};"subtype-group"!==b.type&&b.read({title:g},f);return B.loadStyleRenderer(b,f)}}async function E(a,c,b){const d=a.portalItem;if(a.sourceIsPortalItem){var {title:e,type:g}=d;if("Group Layer"===g){if(!A.hasTypeKeyword(d,"Map"))throw new m("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");
return F(a)}a.read({title:e},c);return G(a,b)}}async function F(a){const c=a.portalItem,b=await c.fetchData("json");if(b){var d=r.createForItemRead(c,"web-map");a.read(b,d);await x.populateGroupLayer(a,b,{context:d});a.resourceReferences={portalItem:c,paths:d.readResourcePaths??[]}}}async function G(a,c){let b;var {portalItem:d}=a;if(d){var e=d.type,g=c.layerModuleTypeMap;switch(e){case "Feature Service":b=g.FeatureLayer;break;case "Stream Service":b=g.StreamLayer;break;case "Scene Service":b=g.SceneLayer;
break;case "Feature Collection":b=g.FeatureLayer;break;default:throw new m("portal:unsupported-item-type-as-group",`The item type '${e}' is not supported as a 'IGroupLayer'`);}var f=new q.LayerLoadContext,[h,l]=await Promise.all([b(),t(c,f)]);c=()=>h;if("Feature Service"===e)return e=k.getFirstLayerOrTable(l)?.customParameters,l=d.url?await k.preprocessFSItemData(l,d.url,f):{},c=await H(l,g)||c,d=await I(d.url,{customParameters:e,loadContext:f}),await n(a,c,l,d);"Scene Service"===e&&d.url&&(l=await k.populateSceneServiceItemData(d,
l,f));return 0<k.getNumLayersAndTables(l)?await n(a,c,l):await J(a,c)}}async function J(a,c){var {portalItem:b}=a;b?.url&&(b=await C.fetchArcGISServiceJSON(b.url))&&n(a,c,{layers:b.layers?.map(k.createSublayerData),tables:b.tables?.map(k.createSublayerData)})}async function n(a,c,b,d){let e=b.layers||[];const g=b.tables||[];"Feature Collection"===a.portalItem?.type?(e.forEach((f,h)=>{f.id=h;"Table"===f?.layerDefinition?.type&&g.push(f)}),e=e.filter(f=>"Table"!==f?.layerDefinition?.type)):(e.reverse(),
g.reverse());e.forEach(f=>{const h=d?.(f);if(h||!d)f=u(a,c(f),b,f,h),a.add(f)});if(g.length){const f=await y.layerLookupMap.FeatureLayer();g.forEach(h=>{const l=d?.(h);if(l||!d)h=u(a,f,b,h,l),a.tables.add(h)})}}function u(a,c,b,d,e){a=a.portalItem;const g={portalItem:a.clone(),layerId:d.id};null!=d.url&&(g.url=d.url);c=new c(g);"sourceJSON"in c&&(c.sourceJSON=e);"subtype-group"!==c.type&&"catalog"!==c.type&&(c.sublayerTitleMode="service-name");"Feature Collection"===a.type&&(e={origin:"portal-item",
portal:a.portal||z.getDefault()},c.read(d,e),b=b.showLegend,null!=b&&c.read({showLegend:b},e));return c}async function t(a,c,b){if(!1!==a.supportsData){a=a.instance;var d=a.portalItem;if(d){var e=null;try{e=await d.fetchData("json",b)}catch(g){}b="stream"===a.type?!1:"layerId"in a;return b?(b=null,c=await K(d,e,c),(e?.layers||e?.tables)&&0<c&&(null==a.layerId&&(d=(d=k.instanceTypeToLayerType(a.type))?k.getSublayersByLayerType(e,d)[0]:k.getFirstLayerOrTable(e))&&(a.layerId=d.id),b=L(e,a),"OrientedImageryLayer"===
b?.layerType&&"oriented-imagery"===a.type&&a.supportedSourceTypes.add("Feature Layer"),b&&null!=e.showLegend&&(b.showLegend=e.showLegend)),1<c&&"sublayerTitleMode"in a&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name"),b):e}}}async function K(a,c,b){if(c?.layers&&c?.tables)return k.getNumLayersAndTables(c);a=v.parse(a.url);if(!a)return 1;b=await b.fetchServiceMetadata(a.url.path,{customParameters:k.getFirstLayerOrTable(c)?.customParameters}).catch(()=>null);
return(c?.layers?.length??b?.layers?.length??0)+(c?.tables?.length??b?.tables?.length??0)}function L(a,c){const {layerId:b}=c;return(a=a.layers?.find(d=>d.id===b)||a.tables?.find(d=>d.id===b))&&M(a,c)?a:null}function M(a,c){const b="layerType"in a&&a.layerType;({type:c}=c);return"feature"===c&&b&&"ArcGISFeatureLayer"!==a.layerType||"catalog"===c&&!b||"oriented-imagery"===c&&!b||"subtype-group"===c&&!b?!1:!0}async function I(a,c){({layersJSON:a}=await w.fetchFeatureService(a,c));if(!a)return null;
const b=[...a.layers,...a.tables];return d=>b.find(e=>e.id===d.id)}async function H(a,c){var {layers:b}=a;if(b?.length){a=new Set;var d=[];for(const {layerType:f}of b)b=null==f?"ArcGISFeatureLayer":f,a.has(b)||(a.add(b),b=c[k.layerTypeToLayerModuleType(b)],d.push(b()));var e=await Promise.all(d),g=new Map;Array.from(a).forEach((f,h)=>{g.set(f,e[h])});return({layerType:f})=>g.get(null==f?"ArcGISFeatureLayer":f)}}p.load=async function(a,c){const b=a.instance.portalItem;if(b?.id){await b.load(c);var d=
a.instance.portalItem;if(!d?.type||!a.supportedTypes.includes(d.type))throw new m("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:d?.type,expectedType:a.supportedTypes.join(", ")});a.validateItem&&a.validateItem(b);return D(a,c)}};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
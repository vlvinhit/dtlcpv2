// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../core/screenUtils ../../../../chunks/rbush ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/boundsUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/spatialReferenceUtils ../../../../symbols/cim/CIMSymbolDrawHelper ../../../../symbols/cim/CIMSymbolHelper ../../engine/webgl/definitions ./GraphicStoreItem ./graphicsUtils ./GraphicUpdateMessage".split(" "),function(v,q,w,p,x,y,z,A,u,r,B,t,C){function D(a,c){return c.zOrder-
a.zOrder}class E{constructor(a,c,b,d,e){this._items=new Map;this._boundsDirty=!1;this._outSpatialReference=a;this._cimResourceManager=c;this._hittestDrawHelper=new A.HittestDrawHelper(c);this._tileInfoView=b;this._store=e;a=b.getClosestInfoForScale(d);this._resolution=this._tileInfoView.getTileResolution(a.level)}items(){return this._items.values()}getItem(a){return this._items.get(a)}async update(a,c,b){const d=[],e=[],g=[],h=new Set,f=[];let m=0;for(const k of a.items){m++;var l=k.uid;const n=this._items.get(l);
a=c(k);h.add(l);n?n.update(k,a,m)&&(e.push(n),f.push(this._updateItem(n,b))):(l=this._store.createDisplayIdForObjectId(l),a=B.GraphicStoreItem.fromGraphic(k,a,m,l),f.push(this._updateItem(a,b)),this._items.set(a.objectId,a),d.push(a))}for(const [k,n]of this._items.entries())h.has(k)||(this._store.releaseDisplayIdForObjectId(k),this._items.delete(k),g.push(n));await Promise.all(f);this._index=null;return new C.GraphicUpdateMessage(d,e,g)}updateLevel(a){this._resolution!==a&&(this._index=null,this._boundsDirty=
!0,this._resolution=a)}hitTest(a,c,b,d,e){var g=(b=v("esri-mobile"))?r.hittestToleranceMobile:r.hittestToleranceDesktop,h=g+(b?0:r.hittestToleranceSmallSymbol);a=y.normalizeMapX(a,this._tileInfoView.spatialReference);var f=d*window.devicePixelRatio*h;b=p.create();b[0]=a-f;b[1]=c-f;b[2]=a+f;b[3]=c+f;f=d*window.devicePixelRatio*g;g=p.create();g[0]=a-f;g[1]=c-f;g[2]=a+f;g[3]=c+f;h=.5*d*(h+t.pixelBuffer);c=this._searchIndex(a-h,c-h,a+h,c+h);if(!c||0===c.length)return[];a=[];h=p.create();f=p.create();
for(var m of c){if(!m.visible)continue;const {projectedGeometry:l,symbolResource:k}=m;this._getSymbolBounds(h,k,l,f,e);f[3]=f[2]=f[1]=f[0]=0;p.intersects(h,b)&&a.push(m)}if(0===a.length)return[];m=this._hittestDrawHelper;b=[];for(const l of a){const {projectedGeometry:k,symbolResource:n}=l;if(!n)continue;const {textInfo:F,symbolInfo:G}=n;m.hitTest(g,G.cimSymbol.symbol,k,F,e,d)&&b.push(l)}b.sort(D);return b.map(l=>l.objectId)}queryItems(a){return 0===this._items.size?[]:this._searchForItems(a)}clear(){this._items.clear();
this._index=null}async _updateItem(a,c){await a.projectAndNormalize(this._outSpatialReference);await c(a);({size:c}=a);c[0]=c[1]=c[2]=c[3]=0;this._getSymbolBounds(a.bounds,a.symbolResource,a.projectedGeometry,a.size,0)}_searchIndex(a,c,b,d){this._boundsDirty&&(this._items.forEach(e=>this._getSymbolBounds(e.bounds,e.symbolResource,e.projectedGeometry,e.size,0)),this._boundsDirty=!1);this._index||(this._index=w.rbush(9,e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})),this._index.load(Array.from(this._items.values())));
return this._index.search({minX:a,minY:c,maxX:b,maxY:d})}_searchForItems(a){var c=this._tileInfoView.spatialReference,b=a.bounds,d=z.getInfo(c);if(d&&c.isWrappable){const [e,g]=d.valid;c=1E-5>Math.abs(b[2]-g);d=1E-5>Math.abs(b[0]-e);if(!(c&&d||!c&&!d))return a=a.resolution,a=c?p.create([e,b[1],e+a*t.pixelBuffer,b[3]]):p.create([g-a*t.pixelBuffer,b[1],g,b[3]]),b=this._searchIndex(b[0],b[1],b[2],b[3]),a=this._searchIndex(a[0],a[1],a[2],a[3]),[...(new Set([...b,...a]))]}return this._searchIndex(b[0],
b[1],b[2],b[3])}_getSymbolBounds(a,c,b,d,e){if(!c||!c.symbolInfo.linearCIM||!b)return null;a||=p.create();x.getBoundsXY(a,b);if(!d||0===d[0]&&0===d[1]&&0===d[2]&&0===d[3]){const {textInfo:g,symbolInfo:h}=c;c=h.cimSymbol;d||=[0,0,0,0];e=u.CIMSymbolInflatedSizeHelper.getSymbolInflateSize(d,c.symbol,this._cimResourceManager,e,g);d[0]=q.pt2px(e[0]);d[1]=q.pt2px(e[1]);d[2]=q.pt2px(e[2]);d[3]=q.pt2px(e[3])}e=this._resolution;d=u.CIMSymbolInflatedSizeHelper.safeSize(d);a[0]-=d*e;a[1]-=d*e;a[2]+=d*e;a[3]+=
d*e;return a}}return E});
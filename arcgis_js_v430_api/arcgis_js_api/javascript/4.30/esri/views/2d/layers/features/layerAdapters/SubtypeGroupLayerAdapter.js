// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/has ../../../../../core/lang ../../../../../core/mathUtils ../../../../../core/sql ../../../../../layers/support/arcgisLayerUrl ../../../../../layers/support/FeatureFilter ./featureServiceUtils ./floorFilterUtils ./geometryUtils ./labelingUtils ../schema/SourceSchema ../schema/processor/SubtypeProcessorSchema".split(" "),function(r,n,w,t,x,y,z,A,p,B,C,D,E){function F(a,b){return a.sublayers.some(c=>!u(c,b))}function u(a,b){return a.visible&&(0===a.minScale||t.floatEqualAbsolute(b.scale,
a.minScale)||b.scale<a.minScale)&&(0===a.maxScale||t.floatEqualAbsolute(b.scale,a.maxScale)||b.scale>a.maxScale)}class G{constructor(a){this.layer=a}getLabelingDeconflictionInfo(a){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every(b=>C.getLayerDeconflictionEnabled(b))}]}async createServiceOptions(a){var b=this.layer;const {capabilities:c,datesInUnknownTimezone:d,editingInfo:e,globalIdField:h,objectIdField:g,refreshInterval:k,subtypeField:l}=b,m=b.fieldsIndex.toJSON(),f=B.getEffectiveGeometryType(b),
H=b.timeInfo?.toJSON(),I=b.spatialReference.toJSON(),v=w.clone(this.layer.parsedUrl);var q=null==e?.lastEditDate&&0<k;b=(q=n("featurelayer-snapshot-enabled")&&"point"===b.geometryType&&c?.query.supportsPagination&&!c?.operations.supportsEditing&&!q)&&A.exceedsMinimumSnapshotCoverage(a,b.fullExtent);const J=y.isHostedAgolService(v.path);return{type:"feature-service",source:v,isSourceHosted:J,orderByFields:g,outSpatialReference:a.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:d,subtypeField:l,
globalIdField:h,fieldsIndex:m,geometryType:f,objectIdField:g,timeInfo:H,spatialReference:I,subtypes:this.layer.subtypes?.map(K=>K.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:c.query.maxRecordCount,supportsCompactGeometry:c.query.supportsCompactGeometry,supportsDefaultSpatialReference:c.query.supportsDefaultSpatialReference,supportsFormatPBF:c.query.supportsFormatPBF,supportsMaxRecordCountFactor:c.query.supportsMaxRecordCountFactor,supportsQuantization:c.query.supportsQuantization,
lastEditDate:e?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:q,supportsSnapshotMaxThreshold:b,snapshotCountThresholds:{min:n("featurelayer-snapshot-point-min-threshold"),max:n("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(a,b){const {definitionExpression:c,customParameters:d,gdbVersion:e,historicMoment:h,subtypeField:g,timeExtent:k,apiKey:l}=this.layer,m={queryScaleRanges:this.layer.sublayers.items.map(f=>({subtypeCode:f.subtypeCode,minScale:f.minScale,
maxScale:f.maxScale})),definitionExpression:c,customParameters:d,gdbVersion:e,historicMoment:h,subtypeField:g,timeExtent:k};return D.createFeatureSourceSchema(m,a,b,l)}createProcessorSchema(a,b,c){const d={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null}))};return E.createSubtypeProcessorSchema(a,
b,d,c)}hasFilters(a){return p.hasFloorFilter(this.layer,a)||F(this.layer,a)}addFilters(a,b){a=p.addFloorFilter(this.layer,a,b);var c=this.layer.sublayers.filter(d=>!u(d,b)).map(d=>d.subtypeCode);if(!c.length)return a;a??=new z;c=`NOT ${this.layer.subtypeField} IN (${c.join(",")})`;a.where=x.sqlAnd(a.where,c);return a}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(a){var b=this.layer;const {definitionExpression:c,gdbVersion:d,apiKey:e}=b,h=b.historicMoment?.getTime()??
void 0;b=JSON.stringify(b.customParameters);a=p.hasFloorFilter(this.layer,a)?a.floors:null;const g=this.layer.sublayers.map(({renderer:k,labelsVisible:l,labelingInfo:m,visible:f})=>({renderer:k,labelsVisible:l,labelingInfo:m,visible:f}));return{outFields:this.layer.outFields,gdbVersion:d,definitionExpression:c,historicMoment:h,customParameters:b,apiKey:e,sublayers:g,floors:a}}setGraphicOrigin(a){var b=this.layer.fieldsIndex.get(this.layer.subtypeField);const c=a.attributes[b.name];b=this.layer.sublayers.find(d=>
d.subtypeCode===c);a.layer=a.sourceLayer=b}}r.SubtypeGroupLayerAdapter=G;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
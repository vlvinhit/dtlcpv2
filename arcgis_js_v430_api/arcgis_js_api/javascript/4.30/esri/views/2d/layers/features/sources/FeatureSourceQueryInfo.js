// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../TimeExtent ../../../../../core/has ../../../../../core/sql ../../../../../geometry/SpatialReference ../../../../../layers/support/arcgisLayerUrl ../../../../../rest/support/Query".split(" "),function(h,n,g,p,q,r,t){class k{static fromSchema(a,b,d){const c="feature"===b.type?b.mutable.dataFilter.queryScaleRanges:[];{var e=a.orderByFields??d.objectIdField+" ASC";const f=a.source;e={returnCentroid:!(null!==f&&"object"===typeof f&&"path"in f&&r.isHostedAgolService(f.path))&&
"esriGeometryPolygon"===d.geometryType,returnGeometry:!0,timeReferenceUnknownClient:d.timeReferenceUnknownClient??void 0,outSpatialReference:q.fromJSON(a.outSpatialReference),orderByFields:[e],where:b.mutable.dataFilter.definitionExpression??"1\x3d1",outFields:b.mutable.availableFields};if("feature"===b.type){const {gdbVersion:u,historicMoment:l,timeExtent:m}=b.mutable.dataFilter;e={...e,gdbVersion:u,historicMoment:l?new Date(l):null,timeExtent:m?n.fromJSON(m):null,outFields:b.mutable.availableFields}}}return new k(e,
c,d.subtypeField,b.mutable.dataFilter.customParameters,d.geometryType,a.queryMetadata)}constructor(a,b,d,c,e,f){this._queryParams=a;this._queryScaleRanges=b;this._subtypeField=d;this._customParameters=c;this._geometryType=e;this._queryMetadata=f}get pageSize(){if(null==this._queryMetadata)throw Error("InternalError: Service does not support paged queries");return Math.min(8E3,(this._queryMetadata.maxRecordCount??8E3)*((this._queryMetadata.supportsMaxRecordCountFactor?4:null)??1))}updateHistoricMoment(a){this._queryParams.historicMoment=
a}updateFields(a){this._queryParams.outFields=a}createPatchFieldsQuery(a,b){if(!b.getSize())return null;a=a.clone();if("*"===this._queryParams.outFields[0]){if("*"===(a.outFields??[])[0])return null;a.outFields=this._queryParams.outFields}else{const d=new Set(this._queryParams.outFields),c=[];for(const e of d)b.hasField(e)||c.push(e);if(0===c.length)return null;a.outFields=c}a.returnGeometry=!1;a.returnCentroid=!1;a.quantizationParameters=null;a.cacheHint=!0;return{inner:a,customParameters:this._customParameters}}createQuery(a=
{}){if(!this._queryParams)throw Error("InternalError: queryInfo should be defined");return{inner:new t({...this._queryParams,...a}),customParameters:this._customParameters}}createTileQuery(a,b){if(null==this._queryMetadata)throw Error("InternalError: Service does not support tile queries");const d=this.createQuery(b),c=d.inner;if(this._queryScaleRanges.length){const e=this._queryScaleRanges.filter(f=>(!f.minScale||f.minScale>=a.maxScale)&&(!f.maxScale||f.maxScale<=a.minScale)).map(f=>f.subtypeCode);
e.length&&(c.where=p.sqlAnd(c.where,`${this._subtypeField} IN (${e})`))}c.quantizationParameters=b.quantizationParameters??a.getQuantizationParameters();c.resultType="tile";c.geometry=a.extent;if(this._queryMetadata.supportsQuantization)"esriGeometryPolyline"===this._geometryType&&(c.maxAllowableOffset=a.resolution*g("feature-polyline-generalization-factor"));else if("esriGeometryPolyline"===this._geometryType||"esriGeometryPolygon"===this._geometryType)c.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===
this._geometryType&&(c.maxAllowableOffset*=g("feature-polyline-generalization-factor"));c.defaultSpatialReferenceEnabled=this._queryMetadata.supportsDefaultSpatialReference;c.compactGeometryEnabled=this._queryMetadata.supportsCompactGeometry;this._queryMetadata.supportsMaxRecordCountFactor&&(c.maxRecordCountFactor=4);g("esri-tiles-debug")&&(b=a.id.replaceAll("/","."),d.customParameters=d.customParameters?{...d.customParameters,tileId:b}:{tileId:b});return d}createPagedTileQuery(a,b){const d=this.pageSize;
return this.createTileQuery(a,{start:d*b,num:d,returnExceededLimitFeatures:!0})}createPagedQuery(a){const b=this.pageSize;return this.createQuery({start:b*a,num:b,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}h.FeatureSourceQueryInfo=k;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
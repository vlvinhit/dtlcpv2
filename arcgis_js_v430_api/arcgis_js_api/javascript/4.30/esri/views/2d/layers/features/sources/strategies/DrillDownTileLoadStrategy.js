// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/handleUtils ../../../../../../core/has ../../../../../../core/promiseUtils ./ATileLoadStrategy ./chunks/DrillDownTileSourceChunk ../../support/FeatureSetReaderJSON".split(" "),function(h,l,m,e,n,k,p){class q{constructor(a,c){this.subscription=a;this._tileIdToResult=new Map;this._controller=new AbortController;this._handles=l.handlesGroup([e.onAbort(a.signal,()=>this._controller.abort()),e.onAbort(c,()=>this._controller.abort())])}destroy(){this._controller.abort();
this._handles.remove()}get(a){return this._tileIdToResult.get(a)}set(a,c){this._tileIdToResult.set(a,c)}get options(){return{signal:this._controller.signal}}}class r extends n.ATileLoadStrategy{constructor(){super(...arguments);this._loadStates=new Map}destroy(){super.destroy();for(const a of this._loadStates.values())a.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(a){this._loadStates.has(a.key.id)||this._loadStates.set(a.key.id,
new q(a,this._options));const c=this._loadStates.get(a.key.id);let d;try{for await(const b of this._fetchChunkInfos(c,a.tile,0)){const {queryJSON:f,reader:g,sourceTile:t,sourceTileDepth:u,tile:v}=b,w=new k.DrillDownTileSourceChunk(g,f,v,t,u,!1);e.throwIfAborted(c.options);this._addChunk(w)}}catch(b){d=b}a=new k.DrillDownTileSourceChunk(p.FeatureSetReaderJSON.empty(this._metadata),null,a.tile,null,-1,!0);this._addChunk(a);if(d)throw d;}unload(a){super.unload(a);this._loadStates.get(a.key.id)?.destroy();
this._loadStates.delete(a.key.id)}async *_fetchChunkInfos(a,c,d){let b=a.get(c.id);const f=!!b;b||(b=await this._fetchChunkInfo(a,c,d),a.set(c.id,b));if(b.reader.exceededTransferLimit&&d<m("featurelayer-query-max-depth"))for(const g of c.createChildTiles())yield*this._fetchChunkInfos(a,g,d+1);else f||(yield b)}async _fetchChunkInfo(a,c,d){var b=a.subscription.tile.getQuantizationParameters();b=this._queryInfo.createTileQuery(c,{returnExceededLimitFeatures:!1,quantizationParameters:b});return{reader:await this._fetch(b,
a.options),queryJSON:b.inner.toJSON(),tile:a.subscription.tile,sourceTile:c,sourceTileDepth:d}}}h.DrillDownTileLoadStrategy=r;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/Error ../../../../../../rest/support/Query ./ALoadStrategy ./support/queryAdapters ../../support/FeatureSetReaderJSON ../../../../../support/QueueProcessor".split(" "),function(f,g,h,k,l,m,n){class p extends k.ALoadStrategy{constructor(a,b,c,d,q){super(c);this._serviceInfo=a;this._queryInfo=b;this._metadata=d;this._connection=q;this._queue=new n.QueueProcessor({concurrency:16,process:async e=>this._adapter.executeQuery(e.query.inner,{signal:e.options?.signal,
query:e.query.customParameters})});this._adapter=l.createQueryAdapter(a,d)}unsafeSetQueryHistoricMoment(a){this._queryInfo.updateHistoricMoment(a)}async updateFields(a){this._queryInfo.updateFields(a);a=Array.from(this._store.chunks()).map(async b=>{const c=h.fromJSON(b.queryInfo.queryJSON);if(c)try{return await this._tryUpdateFields(b.reader,c),null}catch(d){return d}});a=(await Promise.all(a)).filter(b=>b);if(a.length)throw new g("featurelayer-query","Encountered errors when downloading fields",
{errors:a});}async queryByObjectId(a){if(0===a.length)return m.FeatureSetReaderJSON.empty(this._metadata);a=this._queryInfo.createQuery({objectIds:a});return this._fetch(a)}async _fetch(a,b){b=await this._enqueue(a,b);await this._tryUpdateFields(b,a.inner);return b}async _tryUpdateFields(a,b){if(b=this._queryInfo.createPatchFieldsQuery(b,a))b=await this._enqueue(b,this._options),a.joinAttributes(b)}async _enqueue(a,b){this._connection.onEvent({type:"fetchStart"});return this._queue.push({query:a,
options:b}).finally(()=>{this._connection.onEvent({type:"fetchEnd",done:0===this._queue.length})})}}f.AFetchLoadStrategy=p;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
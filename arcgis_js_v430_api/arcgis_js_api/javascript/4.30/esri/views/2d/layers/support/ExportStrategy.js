// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(k,g,G,n,l,H,I,A,y,B,C,z,D,E,F){const q=y.create(),p=[0,0],v=new F(0,0,0,0);g=class extends g{constructor(f){super(f);this._imagePromise=null;this.bitmaps=[];this.hidpi=!1;this.imageMaxHeight=this.imageMaxWidth=2048;this.imageNormalizationSupported=this.imageRotationSupported=!1;this.update=n.debounce(async(c,e)=>{n.throwIfAborted(e);if(c.stationary&&!this.destroyed){var a=c.state,d=B.getInfo(a.spatialReference);c=this.hidpi?c.pixelRatio:1;var h=0<a.worldScreenWidth,b=h&&this.imageNormalizationSupported&&
a.worldScreenWidth<a.size[0],t=Math.round((this.imageMaxWidth??0)/c),u=Math.round((this.imageMaxHeight??0)/c);b?(p[0]=a.worldScreenWidth,p[1]=a.size[1]):this.imageRotationSupported?(p[0]=a.size[0],p[1]=a.size[1]):z.getOuterSize(p,a);d=d&&(a.extent.xmin<d.valid[0]||a.extent.xmax>d.valid[1]);d=!this.imageNormalizationSupported&&d;var w=!(Math.floor(p[0])>t||Math.floor(p[1])>u)&&!d,x=this.imageRotationSupported?a.rotation:0;d=this.container.children.slice();w?this._imagePromise=this._singleExport(a,
p,b?a.paddedViewState.center:a.center,a.resolution,x,c,e):(b=Math.min(t,u),h&&(b=Math.min(a.worldScreenWidth,b),b=Math.round(a.worldScreenWidth/Math.ceil(a.worldScreenWidth/b))),this._imagePromise=this._tiledExport(a,b,c,e));try{const r=await this._imagePromise??[];n.throwIfAborted(e);e=[];this._imagePromise=null;if(!this.destroyed){this.bitmaps=r;for(const m of d)r.includes(m)||e.push(m.fadeOut().then(()=>{m.remove();m.destroy()}));for(const m of r)e.push(m.fadeIn());await Promise.all(e)}}catch(r){this._imagePromise=
null,n.throwIfAbortError(r)}}},5E3);this.updateExports=n.debounce(async c=>{const e=[];for(const a of this.container.children){if(!a.visible||!a.stage)return;e.push(c(a).then(()=>{a.invalidateTexture();a.requestRender()}))}this._imagePromise=n.eachAlways(e).then(()=>this._imagePromise=null);await this._imagePromise})}destroy(){this.bitmaps.forEach(f=>f.destroy());this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(f,c,e,a,d,h){e=await this.fetchSource(f,Math.floor(c*
d),Math.floor(e*d),{rotation:a,pixelRatio:d,signal:h});n.throwIfAborted(h);const b=new D.Bitmap(null,!0);b.x=f.xmin;b.y=f.ymax;b.resolution=f.width/c;b.rotation=a;b.pixelRatio=d;b.opacity=0;this.container.addChild(b);await b.setSourceAsync(e,h);n.throwIfAborted(h);return b}async _singleExport(f,c,e,a,d,h,b){z.getBBox(q,e,a,c);f=y.toExtent(q,f.spatialReference);return[await this._export(f,c[0],c[1],d,h,b)]}_tiledExport(f,c,e,a){var d=C.create({size:c,spatialReference:f.spatialReference,scales:[f.scale]});
const h=new E(d);d=h.getTileCoverage(f);if(!d)return null;const b=[];d.forEach((t,u,w,x)=>{v.set(t,u,w,0);h.getTileBounds(q,v);const r=y.toExtent(q,f.spatialReference);b.push(this._export(r,c,c,0,e,a).then(m=>{0!==x&&(v.set(t,u,w,x),h.getTileBounds(q,v),m.x=q[0],m.y=q[3]);return m}))});return Promise.all(b)}};k.__decorate([l.property()],g.prototype,"_imagePromise",void 0);k.__decorate([l.property()],g.prototype,"bitmaps",void 0);k.__decorate([l.property()],g.prototype,"container",void 0);k.__decorate([l.property()],
g.prototype,"fetchSource",void 0);k.__decorate([l.property()],g.prototype,"hidpi",void 0);k.__decorate([l.property()],g.prototype,"imageMaxWidth",void 0);k.__decorate([l.property()],g.prototype,"imageMaxHeight",void 0);k.__decorate([l.property()],g.prototype,"imageRotationSupported",void 0);k.__decorate([l.property()],g.prototype,"imageNormalizationSupported",void 0);k.__decorate([l.property()],g.prototype,"requestUpdate",void 0);k.__decorate([l.property()],g.prototype,"updating",null);return g=k.__decorate([A.subclass("esri.views.2d.layers.support.ExportStrategy")],
g)});
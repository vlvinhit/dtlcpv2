// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ./enums ./cpuMapped/FreeList ./shaderGraph/techniques/featureTechniqueUtils ../../../webgl/enums".split(" "),function(p,x,m,k,u,n){class h{constructor(a,c,e,f,g){this.instance=a;this.materialKey=c;this.target=e;this.start=f;this.count=g}get textureKey(){return this.materialKey&255}get indexEnd(){return this.start+this.count}extend(a){this.count+=a}render(a){this.instance.techniqueRef.render(a,this)}getStencilReference(){return this.target.stencilRef}getAttributePrecisionPackFactors(){return this.target.getMesh(this.instance.instanceId).getAttributePrecisionPackFactors()}draw(a,
c){u.isHittest(a)?this.drawCompute(a.context,c):this.drawGeometry(a.context,c)}drawCompute(a,c){c=this.target.getMesh(this.instance.instanceId).getComputeVAO(a,c);const e=this.start*Uint32Array.BYTES_PER_ELEMENT/3;a.bindVAO(c);a.drawElements(n.PrimitiveType.POINTS,this.count/3,n.DataType.UNSIGNED_INT,e);a.bindVAO(null)}drawGeometry(a,c){c=this.target.getMesh(this.instance.instanceId).getGeometryVAO(a,c);const e=this.start*Uint32Array.BYTES_PER_ELEMENT;a.bindVAO(c);a.drawElements(n.PrimitiveType.TRIANGLES,
this.count,n.DataType.UNSIGNED_INT,e);a.bindVAO(null)}}class r{constructor(){this._minOrderedLength=this._length=0;this._materialKeys=new Set}static fromDisplayEntities(a,c,e,f){const g=new r;for(const b of a.values())for(const d of b.records)a=e.getInstance(d.instanceId),g.addRecord(a,a.instanceId<<16|d.textureKey&255,d.indexStart,d.indexCount,d.vertexStart,d.vertexCount,c,f);return g}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(a){const {drawPhase:c}=
a;for(const e of this.infos())e.instance.techniqueRef.drawPhase&c&&e.render(a)}addRecord(a,c,e,f,g,b,d,l){f||(e=g,f=b);if(f)if(null==this._head)a=new h(a,c,d,e,f),this._tail=this._head=new k.List(a),this._length++,this._minOrderedLength++;else{if(l===m.FeatureBatchingStrategy.STRICT_ORDER)return this._insert(a,c,d,e,f,this._tail,null);g=null;b=this._head;var t=a.instanceId,q=a.techniqueRef.symbologyPlane;if(l===m.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT&&(q===m.FeatureSymbologyDrawOrder.MARKER||
q===m.FeatureSymbologyDrawOrder.TEXT))return this._insert(a,c,d,e,f,this._tail,null);for(;b;){l=b.data.instance;const v=l.instanceId,w=g?.data.instance.instanceId;if(q<l.techniqueRef.symbologyPlane||t===w&&t!==v)return this._insert(a,c,d,e,f,g,b);g=b;b=b.next}this._insert(a,c,d,e,f,g,null)}}*infos(){if(null!=this._head)for(const a of this._head.values())yield a}_insert(a,c,e,f,g,b,d){if(null==b&&null==d)a=new h(a,c,e,f,g),this._tail=this._head=new k.List(a),this._length++,this._minOrderedLength++;
else{c!==this._tail.data.materialKey&&this._minOrderedLength++;this._materialKeys.add(c);if(null==b&&null!=d)return this._insertAtHead(a,c,e,f,g,d);if(null!=b&&null==d)return this._insertAtEnd(a,c,e,f,g,b);if(null!=b&&null!=d)return this._insertAtMiddle(a,c,e,f,g,b,d)}}_insertAtHead(a,c,e,f,g,b){c===b.data.materialKey&&e===b.data.target&&f+g===b.data.start?(b.data.start=f,b.data.count+=g):(a=new h(a,c,e,f,g),this._head=new k.List(a),this._head.next=b,this._length++)}_insertAtEnd(a,c,e,f,g,b){b.data.materialKey===
c&&b.data.indexEnd===f?b.data.count+=g:(a=new h(a,c,e,f,g),this._tail=new k.List(a),b.next=this._tail,this._length++)}_insertAtMiddle(a,c,e,f,g,b,d){b.data.materialKey===c&&b.data.target===e&&b.data.indexEnd===f?(b.data.count+=g,b.data.materialKey===d.data.materialKey&&b.data.target===d.data.target&&b.data.indexEnd===d.data.start&&(b.data.count+=d.data.count,b.next=d.next,this._length--)):c===d.data.materialKey&&e===d.data.target&&f+g===d.data.start?(d.data.start=f,d.data.count+=g):(a=new h(a,c,e,
f,g),a=new k.List(a),b.next=a,a.next=d,this._length++)}}p.DisplayList=r;p.DisplayListInfo=h;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
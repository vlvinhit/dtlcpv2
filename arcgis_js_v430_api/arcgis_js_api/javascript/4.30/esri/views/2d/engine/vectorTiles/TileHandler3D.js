// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/factories/mat3f32 ../../../../geometry/support/aaBoundingRect ./TileHandler ./VectorTile ../../tiling/TileInfoViewPOT ../../tiling/TileKey".split(" "),function(f,g,h,k,l,m,n,p){class q extends l.TileHandler{constructor(a,c,d,b){super(a,c,d,a.tileInfo.lods.length-1);this._memCache=b;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map;this._tileInfoView=new n(a.tileInfo,a.fullExtent)}destroy(){super.destroy();
this._ongoingRequestToController.forEach(a=>a.abort());this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()}async getVectorTile(a,c){const d=new p(a[0],a[1],a[2],0);let b=this._memCache.get(d.id);if(null!=b)return b.retain(),b;const e=await this._getVectorTileData(d);g.throwIfAborted(c);if(!this._layer)return null;b=this._memCache.get(d.id);if(null!=b)return b.retain(),b;c=this._layer.tileInfo.getTileBounds(k.create(),d);a=this._tileInfoView.getTileResolution(a[0]);b=new m.VectorTile(d,
a,c[0],c[3],512,512,this._styleRepository,this._memCache);b.setData(e);e&&(b.retain(),this._memCache.put(d.id,b,b.usedMemory,f.MinPriority));b.neededForCoverage=!0;b.transforms.tileUnitsToPixels=h.fromValues(.125,0,0,0,.125,0,0,0,1);return b}_getVectorTileData(a){const c=a.id;if(this._ongoingTileRequests.has(c))return this._ongoingTileRequests.get(c);const d=new AbortController;a=this._getParsedVectorTileData(a,{signal:d.signal}).then(b=>{this._ongoingTileRequests.delete(c);this._ongoingRequestToController.delete(c);
return b}).catch(()=>{this._ongoingTileRequests.delete(c);this._ongoingRequestToController.delete(c);return null});this._ongoingTileRequests.set(c,a);this._ongoingRequestToController.set(c,d);return a}_getParsedVectorTileData(a,c){return this.fetchTileData(a,c).then(d=>this.parseTileData({key:a,data:d},c))}}return q});
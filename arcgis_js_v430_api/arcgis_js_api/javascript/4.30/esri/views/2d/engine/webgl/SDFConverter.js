// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define(["../../../../core/floatRGBA","../../../../core/promiseUtils"],function(w,r){class x{constructor(a,f=2){this._textureSize=a;this._rasterizationScale=f;this._canvasSize=this._textureSize*this._rasterizationScale;this._svg=null;({_canvasSize:a}=this);f=document.createElement("canvas");f.width=f.height=a;this._context=f.getContext("2d",{willReadFrequently:!1});this._gridOuter=new Float64Array(a*a);this._gridInner=new Float64Array(a*a);this._f=new Float64Array(a);this._d=new Float64Array(a);this._z=
new Float64Array(a+1);this._v=new Int16Array(a)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null;this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(a,f,e){const {_canvasSize:d,_textureSize:g,_rasterizationScale:b}=this,c=g/4;this._initSVG();const k=this.createSVGString(a,f);return new Promise((h,y)=>{const p=new Image;p.src="data:image/svg+xml; charset\x3dutf8, "+encodeURIComponent(k);p.onload=()=>{p.onload=null;this._context.clearRect(0,
0,d,d);this._context.drawImage(p,0,0,d,d);var n=this._context.getImageData(0,0,d,d);const t=new Uint8Array(g*g*4);for(var l=0;l<d*d;l++){var m=n.data[4*l+3]/255;this._gridOuter[l]=1===m?0:0===m?1E20:Math.max(0,.5-m)**2;this._gridInner[l]=1===m?1E20:0===m?0:Math.max(0,m-.5)**2}this._edt(this._gridOuter,d,d);this._edt(this._gridInner,d,d);for(n=0;n<g*g;n++){l=0;for(m=0;m<b;m++){const z=Math.floor(n/g)*b+m;for(let q=0;q<b;q++){const u=z*d+(n%g*b+q);l+=this._gridOuter[u]-this._gridInner[u]}}l/=b*b;l/=
b;w.packFloatRGBA(.5-l/(2*c),t,4*n)}h(t)};const v=e?.signal;if(v)r.onAbort(v,()=>y(r.createAbortError()))})}_initSVG(){if(!this._svg){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("style","position: absolute;");a.setAttribute("width","0");a.setAttribute("height","0");a.setAttribute("aria-hidden","true");a.setAttribute("role","presentation");document.body.appendChild(a);this._svg=a}return this._svg}createSVGString(a,f){const e=this._initSVG(),d=document.createElementNS("http://www.w3.org/2000/svg",
"path");d.setAttribute("d",a);e.appendChild(d);a=d.getBBox();var g=a.width/a.height;const b=this._canvasSize/2;let c,k;1<g?(c=b/a.width,k=this._canvasSize/4,g=b-1/g*b/2):(c=b/a.height,k=b-b*g/2,g=this._canvasSize/4);d.setAttribute("style",`transform: matrix(${c}, 0, 0, ${c}, ${-a.x*c+k}, ${-a.y*c+g})`);d.setAttribute("stroke-width",`${.5/c}`);f=`<svg style="fill:${f?"red":"none"}; stroke:${f?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${e.innerHTML}</svg>`;
e.removeChild(d);return f}_edt(a,f,e){const d=this._f,g=this._d,b=this._v,c=this._z;for(var k=0;k<f;k++){for(var h=0;h<e;h++)d[h]=a[h*f+k];this._edt1d(d,g,b,c,e);for(h=0;h<e;h++)a[h*f+k]=g[h]}for(k=0;k<e;k++){for(h=0;h<f;h++)d[h]=a[k*f+h];this._edt1d(d,g,b,c,f);for(h=0;h<f;h++)a[k*f+h]=Math.sqrt(g[h])}}_edt1d(a,f,e,d,g){e[0]=0;d[0]=-1E20;d[1]=1E20;for(let b=1,c=0;b<g;b++){let k=(a[b]+b*b-(a[e[c]]+e[c]*e[c]))/(2*b-2*e[c]);for(;k<=d[c];)c--,k=(a[b]+b*b-(a[e[c]]+e[c]*e[c]))/(2*b-2*e[c]);c++;e[c]=b;d[c]=
k;d[c+1]=1E20}for(let b=0,c=0;b<g;b++){for(;d[c+1]<b;)c++;f[b]=(b-e[c])*(b-e[c])+a[e[c]]}}}return x});
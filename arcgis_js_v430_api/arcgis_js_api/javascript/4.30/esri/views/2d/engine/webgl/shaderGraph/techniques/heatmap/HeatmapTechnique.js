// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../FeatureTechnique ../featureTechniqueUtils ../TechniqueType ./HeatmapResources ../shaders/HeatmapAccumulateShader ../shaders/HeatmapResolveShader ../../../../../../webgl/enums".split(" "),function(n,t,h,u,v,w,x,k){function p(a){return a.key.level+1}function q(a,b){const {referenceScale:c,radius:d}=a.uniforms;return d*(0!==c?c/b.scale:1)}class y extends t.FeatureTechnique{constructor(){super(...arguments);this.type=u.TechniqueType.Heatmap;this.shaders={accumulate:new w.HeatmapAccumulateShader,
resolve:new x.HeatmapResolveShader};this.postProcessingEnabled=!0;this._isBound=!1;this._resources=new Map;this.overrideStencilRef=p}shutdown(a){super.shutdown(a);this._resources.get(a)?.destroy();this._resources.delete(a);this._prevFBO=null;this._unbind()}render(a,b){const {context:c,painter:d,state:e}=a;var f=b.instance.getInput();const {isFieldActive:g}=f.uniforms,l=this._getOrCreateResourcesRecord(c),m=l.loadQualityProfile(c);h.isHighlight(a)||(h.isHittest(a)||this._bind(a,l,f),d.setShader({shader:this.shaders.accumulate,
uniforms:{...h.getFeatureUniforms(a,b.target),kernelControls:{radius:q(f,e),isFieldActive:g?1:0}},defines:{...h.getSelectionDefines(a),...m.defines},optionalAttributes:{},useComputeBuffer:h.isHittest(a)}),f=h.isHittest(a)?z:r,d.setPipelineState(f),d.submitDraw(a,b))}postProcess(a,b){if(!h.isHittest(a)&&!h.isHighlight(a)){var {context:c,painter:d}=a,e=this._resources.get(c);if(null!=this._prevFBO&&null!=this._prevViewport&&e?.initialized){({defines:a}=e.loadQualityProfile(c));var {minDensity:f,maxDensity:g,
radius:l}=b.getInput().uniforms;b=e.accumulateFramebuffer;e=e.resolveGradientTexture;d.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:b.colorTexture},minAndInvRange:[f,1/(g-f)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:e}}},defines:a,optionalAttributes:{},useComputeBuffer:!1});c.bindFramebuffer(this._prevFBO);c.setViewport(0,0,this._prevViewport.width,this._prevViewport.height);c.bindTexture(b.colorTexture,8);c.bindTexture(e,9);
d.setPipelineState(A);d.submitDrawQuad(c);this._unbind()}}}_getOrCreateResourcesRecord(a){let b=this._resources.get(a);null==b&&(b=new v.HeatmapResources,this._resources.set(a,b));return b}_unbind(){this._prevViewport=this._prevFBO=null;this._isBound=!1}_bind(a,b,c){if(!this._isBound){var {context:d,state:e,pixelRatio:f}=a;a=d.getBoundFramebufferObject();var g=d.getViewport();this._prevFBO=a;this._prevViewport=g;var {gradient:l,gradientHash:m}=c.uniforms;b.ensureResolveGradientTexture(d,m,l);var {width:B,
height:C}=g;c=q(c,e);g=1.5<f?.25:.5;c=c<1/(2*g)?1:g;b=b.ensureAccumulateFBO(d,B*c,C*c);d.blitFramebuffer(a,b,0,0,a.width,a.height,0,0,b.width,b.height,k.ClearBufferBit.STENCIL_BUFFER_BIT,k.TextureSamplingMode.NEAREST);d.bindFramebuffer(b);d.setViewport(0,0,b.width,b.height);d.setColorMask(!0,!0,!0,!0);d.setClearColor(0,0,0,0);d.clear(k.ClearBufferBit.COLOR_BUFFER_BIT);this._isBound=!0}}}const r={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:p,compare:k.CompareFunction.GEQUAL,
mask:255,op:{fail:k.StencilOperation.KEEP,zFail:k.StencilOperation.KEEP,zPass:k.StencilOperation.REPLACE}}}},z={...r,stencil:!1},A={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};n.HeatmapTechnique=y;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
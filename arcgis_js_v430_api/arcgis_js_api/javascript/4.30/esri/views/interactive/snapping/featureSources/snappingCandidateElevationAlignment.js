// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/LRUCache ../../../../core/MapUtils ../../../../core/promiseUtils ../../../../core/unitUtils ../../../../symbols/support/unitConversionUtils".split(" "),function(m,A,q,r,t,u,v){function n(a,{x:b,y:d,z:c,spatialReference:f}){return`${a}-${b}-${d}-${c??0}}-wkid:${f?.wkid}`}function w(){return[]}class x{async alignCandidates(a,b,d){return a}notifyElevationSourceChange(){}}class y{constructor(a,b){this._elevationInfo=a;this._alignPointsInFeatures=b;
this._alignmentsCache=new q.LRUCache(1024);this._cacheVersion=0}async alignCandidates(a,b,d){const c=this._elevationInfo;if(null!=c&&"absolute-height"===c.mode&&!c.featureExpressionInfo){{const {offset:f,unit:g}=c;if(null!=f){b=u.getMetersPerVerticalUnitForSR(b);d=v.getMetersPerUnit(g??"meters");b=d/b*f;for(const e of a)switch(e.type){case "edge":e.start.z+=b;e.end.z+=b;continue;case "vertex":e.target.z+=b}}}return a}return this._alignComputedElevationCandidates(a,b,d)}notifyElevationSourceChange(){this._alignmentsCache.clear();
this._cacheVersion++}async _alignComputedElevationCandidates(a,b,d){var c=new Map;for(const h of a)r.getOrCreateMapValue(c,h.objectId,w).push(h);const [f,g,e]=this._prepareQuery(c,b);c=await this._alignPointsInFeatures(f,d);t.throwIfAborted(d);if(e!==this._cacheVersion)return this._alignComputedElevationCandidates(a,b,d);this._applyCacheAndResponse(f,c,g);const {drapedObjectIds:k,failedObjectIds:l}=c;b=[];for(const h of a)({objectId:a}=h),k.has(a)&&"edge"===h.type&&(h.draped=!0),l.has(a)||b.push(h);
return b}_prepareQuery(a,b){const d=[],c=[];for(const [f,g]of a){a=[];for(const e of g)this._addToQueriesOrCachedResult(f,e.target,a,c),"edge"===e.type&&(this._addToQueriesOrCachedResult(f,e.start,a,c),this._addToQueriesOrCachedResult(f,e.end,a,c));0!==a.length&&d.push({objectId:f,points:a})}return[{spatialReference:b.toJSON(),pointsInFeatures:d},c,this._cacheVersion]}_addToQueriesOrCachedResult(a,b,d,c){a=n(a,b);a=this._alignmentsCache.get(a);null!=a?c.push(new z(b,a)):d.push(b)}_applyCacheAndResponse(a,
{elevations:b,drapedObjectIds:d,failedObjectIds:c},f){for(var g of f)g.apply();f=0;g=this._alignmentsCache;for(const {objectId:e,points:k}of a.pointsInFeatures)if(c.has(e))f+=k.length;else{a=!d.has(e);for(const l of k){const h=n(e,l),p=b[f++];l.z=p;a&&g.put(h,p,1)}}}}class z{constructor(a,b){this.point=a;this.z=b}apply(){this.point.z=this.z}}m.getSnappingCandidateElevationAligner=function(a=!1,b){if(a){const {elevationInfo:d,alignPointsInFeatures:c}=b;return new y(d,c)}return new x};Object.defineProperty(m,
Symbol.toStringTag,{value:"Module"})});
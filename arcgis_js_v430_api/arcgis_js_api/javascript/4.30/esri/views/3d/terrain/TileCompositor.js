// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/maybe ../../../core/libs/gl-matrix-2/factories/vec2f64 ../../2d/engine/imagery/enums ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./LayerClass ./RasterColorizerTechnique ./support/MultiSizeFramebuffer ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode ../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput ../webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/BindParameters ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(u,H,l,I,v,J,w,x,y,z,t,g,q,m,A,K,L,M,n,B,N){class O{constructor(a,b){this._rctx=a;this._techniques=b;this._fbos=[];this._vectorTileHelper=new J.VectorTileRendererHelper3D;this._bindParameters=new K.BindParameters(null,null);this._blendLayersTechniqueConfig=new w.BlendLayersTechniqueConfiguration;this._current=0;this._lastUsedIds=[];this._lastCreatedBufferId=0;this._onHoldIds=[];this._vaoQuad=M.createQuadVAO(this._rctx,L.Pos2Tex)}dispose(){this._fbos.forEach(l.disposeMaybe);this._fbos=null;
this._vtFBO=l.disposeMaybe(this._vtFBO);this._vaoQuad=l.disposeMaybe(this._vaoQuad);this._vectorTileHelper=l.disposeMaybe(this._vectorTileHelper);this._backgroundTechnique=l.releaseMaybe(this._backgroundTechnique);this._applyOpacityTechnique=l.releaseMaybe(this._applyOpacityTechnique);this._blendLayersTechnique=l.releaseMaybe(this._blendLayersTechnique)}updateHeading(a){this._vectorTileHelper?.updateHeading(a)}_getBlendLayersTechnique(a,b,d,e=m.PremultipliedAlphaSource.Off,c=A.BackgroundMode.BelowLayer){this._blendLayersTechniqueConfig.output=
b;this._blendLayersTechniqueConfig.blendMode=a;this._blendLayersTechniqueConfig.baseOpacityMode=d;this._blendLayersTechniqueConfig.premultipliedSource=e;this._blendLayersTechniqueConfig.background=c;return this._blendLayersTechnique=this._techniques.releaseAndAcquire(w.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique)}drawBackground(a,b){b=this._getBlendLayersTechnique(t.LayerBlendMode.Normal,b?q.BlendLayersOutput.ColorComposite:q.BlendLayersOutput.GridComposite,g.BaseOpacityMode.NotRequired,
m.PremultipliedAlphaSource.Off,A.BackgroundMode.Only);a=this._rctx.bindTechnique(b,this._bindParameters,a);this._render(a)}_render(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(n.PrimitiveType.TRIANGLE_STRIP,0,N.vertexCount(this._vaoQuad,"geometry"))}drawGroup(a,b,d,e,c=m.PremultipliedAlphaSource.On){b===q.BlendLayersOutput.Composite&&(a.fboTexture=this._fbos[this.getLastOnHoldId()].get(d).colorTexture);a.texture=this.currentFBO(d).colorTexture;
this.closeGroup(d);b=this._getBlendLayersTechnique(e,b,1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired,c);a=this._rctx.bindTechnique(b,this._bindParameters,a);this._render(a)}drawImageData(a,b,d,e,c=m.PremultipliedAlphaSource.Off){if(null!=a.texture){var f=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;a.fboTexture=b===q.BlendLayersOutput.GroupBackgroundComposite||e===t.LayerBlendMode.Normal&&f===g.BaseOpacityMode.NotRequired&&c===m.PremultipliedAlphaSource.Off?
null:this.switch(d).colorTexture;b=this._getBlendLayersTechnique(e,b,f,c);a=this._rctx.bindTechnique(b,this._bindParameters,a);this._render(a)}}drawRasterData(a,b,d,e,c){var f=c.sourceLayerInfo.data;if(f.source&&(c.tile.surface.layerViewByIndex(c.layerIndex,x.LayerClass.MAP).ensureSymbolizerParameters(f),f.bind(this._rctx))){var r=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;a.fboTexture=e===t.LayerBlendMode.Normal&&r===g.BaseOpacityMode.NotRequired?null:this.switch(d).colorTexture;
b=this._getRasterColorizerTechnique(f,b,e,r);f.opacity=a.opacity;f=f.getUniforms();f.scale=c.scale;f.offset=c.offset;f.backgroundColor=a.backgroundColor;f.fboTexture=a.fboTexture;f.baseOpacity=a.baseOpacity;a=this._rctx.bindTechnique(b,null,f);this._render(a)}}_getRasterColorizerTechnique(a,b,d,e){const c=a.symbolizerParameters,f=["stretch","lut","hillshade"].indexOf(c.type);null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new y.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),
this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.output=b;this._rasterColorizerConfig.blendMode=d;this._rasterColorizerConfig.baseOpacityMode=e;this._rasterColorizerConfig.colorizerType=f;this._rasterColorizerConfig.applyColormap=!!c.colormap;this._rasterColorizerConfig.requireBilinearWithNN=a.isBilinearWithStretchColorRamp;this._rasterColorizerConfig.stretchType=a.hasStretchTypeNone()?v.RasterColorizerStretchType.Noop:v.RasterColorizerStretchType.PerBand;return this._rasterColorizerTechnique=
this._techniques.releaseAndAcquire(y.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique)}drawVectorData(a,b,d,e,c,f,r,C){const p=this._rctx,D=c.sourceLayerInfo.data,k=c.tile.surface.layerViewByIndex(c.layerIndex,x.LayerClass.MAP);var h=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;const E=h===g.BaseOpacityMode.Required||1>a.opacity||e!==t.LayerBlendMode.Normal||b!==q.BlendLayersOutput.Composite,F=E?m.PremultipliedAlphaSource.On:m.PremultipliedAlphaSource.Off;
h=this._getBlendLayersTechnique(e,b,h,F);p.setPipelineState(h.getPipeline());let G=h=null;E?(G=this.currentFBO(d),null==this._vtFBO&&(this._vtFBO=new z.MultiSizeFramebuffer(this._rctx)),h=this._vtFBO.get(d),p.bindFramebuffer(h),this._clearCurrentFBO()):C&&p.clear(n.ClearBufferBit.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(p,c.sourceLod,k.painter,k.layer.styleRepository,k.schemaHelper,Math.round(1/c.scale),c.offset,r,f,k.contentZoom),D&&this._vectorTileHelper.renderContent(p,c.sourceLod,
D,c.vtlNeighborInfos,k.painter,k.layer.styleRepository,k.schemaHelper,Math.round(1/c.scale),c.offset,r,f,k.contentZoom)}catch(P){H.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",P)}return null!=h?(p.bindFramebuffer(G),a.texture=h.colorTexture,a.offset=I.ZEROS,a.scale=1,this.drawImageData(a,b,d,e,F),C):!0}copyFBOToTexture(a){const b=this._rctx,d=b.bindTexture(a.texture,B.Texture.TEXTURE_UNIT_FOR_UPDATES),e=a.descriptor;b.gl.copyTexImage2D(n.TextureType.TEXTURE_2D,
0,e.pixelFormat,0,0,e.width,e.height,0);a.generateMipmap();b.bindTexture(d,B.Texture.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255);this._rctx.setClearColor(0,0,0,0);this._rctx.setClearDepth(1);this._rctx.setClearStencil(0);this._rctx.clear(n.ClearBufferBit.COLOR_BUFFER_BIT|n.ClearBufferBit.DEPTH_BUFFER_BIT|n.ClearBufferBit.STENCIL_BUFFER_BIT)}_initFBO(a,b,d){this._rctx.bindFramebuffer(a);d&&(this._rctx.setViewport(0,0,b,b),this._clearCurrentFBO())}ensureBuffer(a){this._lastUsedIds.length=
0;this._lastUsedIds.push(1);this._lastCreatedBufferId=1;this._onHoldIds.length=0;this.bind(a)}bind(a,b=0,d=!0){this._current=b;if(b>=this._fbos.length)for(let e=this._fbos.length;e<=b;e++)this._fbos.push(new z.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[b].get(a),a,d)}_bindNextFreeBuffer(a){0<this._lastUsedIds.length?this.bind(a,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(a,this._lastCreatedBufferId))}openGroup(a){this._onHoldIds.push(this._current);this._bindNextFreeBuffer(a)}switch(a){const b=
this.currentFBO(a),d=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(d);return b}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(a){const b=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(b);this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(a){return this._fbos[this._current].get(a)}}u.TileCompositor=O;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
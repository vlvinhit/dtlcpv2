// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../webgl/formats ./textureUtils ./ViewshedFaceCamera ../../../webgl/enums".split(" "),function(y,I,z,J,K,L,p,r,A,B,M,C){class N{constructor(){this.textureSizeModHighQuality=1.3;this.textureSizeModLowQuality=.9;this.textureSizeMultiple=128;
this.toleranceSides=5;this.toleranceBottomTop=10}textureSizeModifier(a){return a?this.textureSizeModHighQuality:this.textureSizeModLowQuality}textureResizeModulo(a){return Math.ceil(a/this.textureSizeMultiple)*this.textureSizeMultiple}}const u="front left right back top bottom".split(" ");class O{constructor(a){this._fbos=a;this._enabled=!1;this._faces={};this._textureHeight=this._textureWidth=0;this.settings=new N;this._maxTextureWidth=Math.min(I("esri-mobile")?4096:16384,a.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get enabled(){return this._enabled}set enabled(a){(this._enabled=
a)||this.disposeOffscreenBuffers()}get isTextureZero(){return 0===this._textureWidth||0===this._textureHeight}get nearFar(){const a=this.faces;return 0===a.length?null:a[0].nearFar}get numActiveFaces(){const a=this._faces;let b=0;Object.keys(a).forEach(c=>{a[c]&&(b+=1)});return b}get faces(){const a=this._faces,b=[];for(const c of u){const d=a[c];d&&b.push(d)}return b}get atlasRegions(){return this.faces.map(a=>[a.x/this._textureWidth,(a.x+a.width)/this._textureWidth,a.y/this._textureHeight,(a.y+
a.height)/this._textureHeight])}get viewshedProjectionMatrices(){return this.faces.map(a=>a.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(a=>a.viewMatrix)}_setupFaceCamera(a,b,c,d){const {observerRenderSpace:f,tiltedUpVector:e,targetRenderSpace:m,farDistanceRenderSpace:n,horizontalFieldOfView:q,verticalFieldOfView:l}=b,g=r.create();p.sub(g,m,f);const k=r.create(),P=r.create(),v=(Q,R)=>{const t=r.create(),D=L.create();K.fromRotation(D,Q,R);p.transformMat4(t,g,D);p.add(t,f,t);return t};
let w=e;const E=Math.min(90,q),F=Math.min(90,Math.max(0,(q-90)/2));b=-45;let x=45,G=-45,H=45;["top","bottom"].includes(a)||(G=z.clamp(-l/2,-45,45)-this.settings.toleranceBottomTop,H=z.clamp(+l/2,-45,45)+this.settings.toleranceBottomTop);switch(a){case "front":var h=m;b=-E/2;x=E/2;break;case "left":h=v(Math.PI/2,e);b=45-F;break;case "right":h=v(-Math.PI/2,e);x=-45+F;break;case "top":h=p.add(k,f,e);w=p.negate(P,g);break;case "bottom":h=p.sub(k,f,e);w=g;break;case "back":h=v(Math.PI,e)}h=new M.ViewshedFaceCamera({center:h,
eye:f,up:w,far:n});h.sectionAnglesDeg=[b-this.settings.toleranceSides,x+this.settings.toleranceSides,G,H];h.fovY=Math.PI/2;c=h.setViewport(c,d);this._faces[a]=h;return c}_bindFBO(){const a=this._fbos.rctx;a.unbindTexture(this.depthTexture);a.bindFramebuffer(this._handle?.fbo)}_computeActiveFaces(a){const b=new Set,{horizontalFieldOfView:c,verticalFieldOfView:d}=a;a=-d/2;const f=d/2;if(0===c||0===d)return b;45>=a&&-45<=f&&b.add("front");90<c&&(b.add("left"),b.add("right"));270<c&&b.add("back");f>45-
this.settings.toleranceBottomTop&&b.add("top");a<-45+this.settings.toleranceBottomTop&&b.add("bottom");return b}_computeBaseTextureSize(a,b,c,d){b=Math.min(window.devicePixelRatio,b)/a.pixelRatio;c=this.settings.textureSizeModifier(c);a=B.applyTextureResizeModulo(Math.floor(Math.max(a.fullWidth,a.fullHeight)*b*c));return B.applyTextureResizeFloorModulo(Math.min(Math.floor(this._maxTextureWidth/d),a))}_ensureFBO(){const a=this._textureWidth,b=this._textureHeight;if(this._handle?.fbo?.width!==a||this._handle?.fbo?.height!==
b)this._handle?.release(),this._handle=this._fbos.acquire(a,b,"viewshed shadow map",A.ColorFormat.RGBA4);this._handle.acquireDepth(A.DepthFormat.DEPTH16_BUFFER)}clearFBO(){const a=this._fbos.rctx;this._ensureFBO();this._bindFBO();a.setClearColor(1,1,1,1);a.clear(C.ClearBufferBit.COLOR_BUFFER_BIT|C.ClearBufferBit.DEPTH_BUFFER_BIT)}dispose(){this.enabled=!1;this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=J.releaseMaybe(this._handle)}start(a,b,c,d){this._faces={};if(!this.enabled)return!1;
const f=this._computeActiveFaces(b),e=f.size;if(0===e)return!1;const m=this._computeBaseTextureSize(a,d,c,e);if(0===m)return!1;let n=0,q=0,l=0;u.filter(g=>f.has(g)).forEach(g=>{if(4>e)var k=0;else k="front"===g||"left"===g,k=4===e?k?0:1:k||"right"===g?0:1;k>q&&(l=Math.max(l,n),n=0);q=k;n+=this._setupFaceCamera(g,b,[n,k*m],m)});l=Math.max(l,n);this._textureWidth=this.settings.textureResizeModulo(l);this._textureHeight=(4>e?1:2)*m;this.clearFBO();return!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,
faceTypes:u}}}y.ViewshedShadowMap=O;Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});
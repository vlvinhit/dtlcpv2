// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/asyncUtils ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/screenUtils ../../../../../core/urlUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../support/requestImageUtils ../../../webgl/RenderNode ./MagnifierTechnique ../../lib/basicInterfaces ../../lib/DefaultVertexAttributeLocations ../../lib/DefaultVertexBufferLayouts ../../lib/glUtil3D ../../../../../chunks/Magnifier.glsl ../../../../magnifier/resources ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(f,k,y,v,n,p,q,z,l,K,L,M,A,w,B,C,x,D,E,F,G,H,m,r,I){f.MagnifierRenderNode=class extends B{constructor(b){super(b);this.produces="magnifier-color";this.consumes={required:["magnifier-color"]};this._imageLoadTask=this._imageSources=null;this._passParameters=new G.MagnifierPassParameters;this._magnifier=this._technique=this._vao=null;this._tmpScreenPoint=q.createScreenPointArray();this._tmpRenderPoint=q.createRenderScreenPointArray()}initialize(){this.addHandles([p.watch(()=>this.view.magnifier,
b=>this._update(b),p.syncAndInitial)])}_update(b){b!==this._magnifier&&(this.removeAllHandles(),this._magnifier=b,b=()=>{const a=this._validMagnifier;a?(this._loadResources(a),this.produces="magnifier-color"):this.produces="disabled";this.requestRender()},this._magnifier&&this.addHandles(p.watch(()=>this._magnifier?.version,b)),b())}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&0<this._magnifier?.size?this._magnifier:null}get _factor(){return this._magnifier?.factor||
1}destroy(){this._magnifier=null;null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeTextures();this._vao=n.disposeMaybe(this._vao)}_disposeTextures(){this._passParameters.mask=n.disposeMaybe(this._passParameters.mask);this._passParameters.overlay=n.disposeMaybe(this._passParameters.overlay);this._passParameters.input=n.disposeMaybe(this._passParameters.input)}render(b){const a=this._validMagnifier;b=b.find(({name:J})=>"magnifier-color"===J);if(null==
a)return b;if(null==this._imageSources)return this.requestRender(x.RenderRequestType.UPDATE),b;const d=this.renderingContext;var c=Math.ceil(this.camera.pixelRatio*a.size);this._vao??(this._vao=F.createQuadVAO(d,E.Pos2,D.Default3D,0,1));this._technique??(this._technique=this.techniques.acquire(C.MagnifierTechnique));this._ensureTextureResources(d,c);if(!this._technique?.compiled||!this._passParameters.input)return this.requestRender(x.RenderRequestType.UPDATE),b;c=Math.ceil(1/this._factor*c);const g=
this._passParameters.input;g.resize(c,c);q.screenPointObjectToArray(a.position,this._tmpScreenPoint);var e=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullHeight;const t=.5*c,u=.5*c;e[0]=v.clamp(e[0],t,this.camera.fullWidth-t-1);e[1]=v.clamp(e[1],u,h-u-1);h=Math.floor(e[0]-t);e=Math.floor(e[1]-u);d.bindFramebuffer(b.fbo);this._technique.program.bindTexture("textureInput",g);d.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,h,e,c,c,0);this._passParameters.magnifier=
a;d.bindTechnique(this._technique,this.bindParameters,this._passParameters);d.bindVAO(this._vao);d.drawArrays(m.PrimitiveType.TRIANGLE_STRIP,0,4);return b}_loadResources(b){const {maskUrl:a,overlayUrl:d}=b;if(this._imageLoadTask?.maskUrl!==a||this._imageLoadTask?.overlayUrl!==d)this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null;this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:a,overlayUrl:d,task:y.createTask(async c=>{const g=null==a||null==d?H.loadMagnifierResources(c):
null,e=null!=a?w.requestImage(a,{signal:c}):g.then(h=>h.mask);c=null!=d?w.requestImage(d,{signal:c}):g.then(h=>h.overlay);this._imageSources={mask:await e,overlay:await c}})})}_ensureTextureResources(b,a){null==this._imageSources||this._passParameters.size===a&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=a,this._imageSources.overlay.height=this._imageSources.mask.height=
a,a=new I.TextureDescriptor,a.internalFormat=m.PixelFormat.RGBA,a.wrapMode=m.TextureWrapMode.CLAMP_TO_EDGE,a.flipped=!0,a.preMultiplyAlpha=!z.isSVG(this._imageSources.overlay.src)||!b.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new r.Texture(b,a,this._imageSources.overlay),a.pixelFormat=a.internalFormat=m.PixelFormat.ALPHA,a.preMultiplyAlpha=!1,this._passParameters.mask=new r.Texture(b,a,this._imageSources.mask),a.pixelFormat=a.internalFormat=m.PixelFormat.RGBA,a.flipped=
!1,this._passParameters.input=new r.Texture(b,a))}};k.__decorate([l.property()],f.MagnifierRenderNode.prototype,"produces",void 0);k.__decorate([l.property()],f.MagnifierRenderNode.prototype,"consumes",void 0);k.__decorate([l.property()],f.MagnifierRenderNode.prototype,"_imageSources",void 0);k.__decorate([l.property()],f.MagnifierRenderNode.prototype,"_imageLoadTask",void 0);k.__decorate([l.property({constructOnly:!0})],f.MagnifierRenderNode.prototype,"techniques",void 0);f.MagnifierRenderNode=k.__decorate([A.subclass("esri.views.3d.webgl-engine.effects.magnifier.MagnifierRenderNode")],
f.MagnifierRenderNode);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../core/libs/gl-matrix-2/math/vec2 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../ViewingMode ../../webgl/formats ./CascadeCamera ./textureUtils ./Util ../../../webgl/enums ../../../webgl/Texture".split(" "),
function(G,na,S,aa,oa,H,B,d,n,M,ba,T,U,pa,V,qa,ca,q,W,da){function w(b,c){d.set(ea,b[c],b[c+3]);return ea}G.SnapshotSlot=void 0;(function(b){b[b.Highlight=0]="Highlight";b[b.ExcludeHighlight=1]="ExcludeHighlight"})(G.SnapshotSlot||(G.SnapshotSlot={}));class Q{constructor(){this.camera=new qa.CascadeCamera;this.lightMat=B.create()}}class ra{constructor(){this.maxNumCascadesLowQuality=this.maxNumCascadesHighQuality=4;this.textureSizeModHighQuality=1.3;this.textureSizeModLowQuality=.9;this.splitSchemeLambda=
0}}class sa{constructor(b,c){this._fbos=b;this._viewingMode=c;this._enabled=!1;this._snapshots=[];this._textureHeight=0;this._numCascades=1;this.settings=new ra;this._projectionView=B.create();this._projectionViewInverse=B.create();this._modelViewLight=B.create();this._cascadeDistances=[0,0,0,0,0];this._usedCascadeDistances=U.create();this._cascades=[new Q,new Q,new Q,new Q];this._lastOrigin=null;this._maxTextureWidth=Math.min(na("esri-mobile")?4096:16384,b.rctx.parameters.maxTextureSize)}dispose(){this.enabled=
!1;this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return T.set(this._usedCascadeDistances,this._cascadeDistances[0],1<this._numCascades?this._cascadeDistances[1]:Infinity,2<this._numCascades?this._cascadeDistances[2]:Infinity,3<this._numCascades?this._cascadeDistances[3]:Infinity)}disposeOffscreenBuffers(){this._handle=aa.releaseMaybe(this._handle);
this._discardSnapshots()}set maxCascades(b){this.settings.maxNumCascadesHighQuality=S.clamp(Math.floor(b),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(b){(this._enabled=b)||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let b=0;b<this._numCascades;++b)X[b]=this._cascades[b];X.length=this._numCascades;return X}start(b,c,e,g,t){q.assert(this.enabled);let {near:h,far:k}=
e;2>h&&(h=2);2>k&&(k=2);h>=k&&(h=2,k=4);const {near:f,far:r}={near:h,far:k};this._computeCascadeDistances(f,r,g);this._textureHeight=this._computeTextureHeight(b,t,g);this._setupMatrices(b,c);const {viewMatrix:D,projectionMatrix:u}=b;for(b=0;b<this._numCascades;++b)this._constructCascade(b,u,D,c);this._lastOrigin=null;this.clear()}finish(){q.assert(this.enabled);this._handle?.detachDepth()}getShadowMapMatrices(b){if(!this._lastOrigin||!M.exactEquals(b,this._lastOrigin)){this._lastOrigin=this._lastOrigin||
ba.create();M.copy(this._lastOrigin,b);for(let c=0;c<this._numCascades;++c){H.translate(fa,this._cascades[c].lightMat,b);for(let e=0;16>e;++e)ha[16*c+e]=fa[e]}}return ha}moveSnapshot(b){q.assert(this.enabled);this._handle?.detachDepth();this._snapshots[b]?.release();this._snapshots[b]=this._handle;this._handle=null;this.clear()}copySnapshot(b){var c=this._handle?.getTexture()?.descriptor;if(this.enabled&&c){this._snapshots[b]?.release();var {width:e,height:g}=c;this._snapshots[b]=this._fbos.acquire(e,
g,b===G.SnapshotSlot.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot",V.ColorFormat.RGBA4);c=this._fbos.rctx;this._bindFbo();b=c.bindTexture(this._snapshots[b]?.getTexture(),da.Texture.TEXTURE_UNIT_FOR_UPDATES);c.gl.copyTexSubImage2D(W.TextureType.TEXTURE_2D,0,0,0,0,0,e,g);c.bindTexture(b,da.Texture.TEXTURE_UNIT_FOR_UPDATES)}}getSnapshot(b){return this.enabled?this._snapshots[b]?.getTexture():null}clear(){const b=this._fbos.rctx;this._ensureFbo();this._bindFbo();b.setClearColor(1,
1,1,1);b.clear(W.ClearBufferBit.COLOR_BUFFER_BIT|W.ClearBufferBit.DEPTH_BUFFER_BIT)}_computeTextureHeight(b,c,e){b=ca.applyTextureResizeModulo(Math.floor(Math.min(window.devicePixelRatio,c)/b.pixelRatio*Math.max(b.fullWidth,b.fullHeight)*(e?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality)));return ca.applyTextureResizeFloorModulo(Math.min(this._maxTextureWidth,this._numCascades*b)/this._numCascades)}_ensureFbo(){if(this._handle?.fbo?.width!==this._textureWidth||this._handle?.fbo.height!==
this._textureHeight)this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",V.ColorFormat.RGBA4);this._handle?.acquireDepth(V.DepthFormat.DEPTH16_BUFFER)}_discardSnapshot(b){this._snapshots[b]=aa.releaseMaybe(this._snapshots[b])}_discardSnapshots(){for(let b=0;b<this._snapshots.length;++b)this._discardSnapshot(b);this._snapshots.length=0}_bindFbo(){const b=this._fbos.rctx;b.unbindTexture(this.depthTexture);b.bindFramebuffer(this._handle?.fbo)}_constructCascade(b,
c,e,g){const t=this._cascades[b];var h=-this._cascadeDistances[b],k=-this._cascadeDistances[b+1];h=(c[10]*h+c[14])/Math.abs(c[11]*h+c[15]);c=(c[10]*k+c[14])/Math.abs(c[11]*k+c[15]);q.assert(h<c);for(k=0;8>k;++k){T.set(ia,0===k%4||3===k%4?-1:1,0===k%4||1===k%4?-1:1,4>k?h:c,1);var f=A[k];T.transformMat4(f,ia,this._projectionViewInverse);f[0]/=f[3];f[1]/=f[3];f[2]/=f[3]}M.negate(Y,A[0]);t.camera.viewMatrix=H.translate(ta,this._modelViewLight,Y);for(h=0;8>h;++h)M.transformMat4(A[h],A[h],t.camera.viewMatrix);
h=A[0][2];c=A[0][2];for(k=1;8>k;++k)h=Math.min(h,A[k][2]),c=Math.max(c,A[k][2]);h-=200;c+=200;t.camera.near=-c;t.camera.far=-h;k=t.camera;f=1/A[0][3];var r=1/A[4][3];q.assert(f<r);f+=Math.sqrt(f*r);var D=Math.sin(S.acosClamped(e[2]*g[0]+e[6]*g[1]+e[10]*g[2]));e=A;var u=f/D;g=ja;var x=ka,l=ua;r=la;f=ma;d.set(y,0,0);for(var p=0;4>p;++p)d.add(y,y,e[p]);d.scale(y,y,.25);d.set(I,0,0);for(p=4;8>p;++p)d.add(I,I,e[p]);d.scale(I,I,.25);d.lerp(F[0],e[4],e[5],.5);d.lerp(F[1],e[5],e[6],.5);d.lerp(F[2],e[6],e[7],
.5);d.lerp(F[3],e[7],e[4],.5);p=0;var C=d.squaredDistance(F[0],y);for(var z=1;4>z;++z){var J=d.squaredDistance(F[z],y);J<C&&(C=J,p=z)}d.subtract(m,F[p],e[p+4]);p=m[0];m[0]=-m[1];m[1]=p;d.subtract(Z,I,y);0>d.dot(Z,m)&&d.negate(m,m);d.lerp(m,m,Z,D);d.normalize(m,m);D=p=d.dot(d.subtract(E,e[0],y),m);for(C=1;8>C;++C)z=d.dot(d.subtract(E,e[C],y),m),z<D?D=z:z>p&&(p=z);d.copy(g,y);d.scale(E,m,D-u);d.add(g,g,E);z=-1;J=1;u=C=0;for(let N=0;8>N;++N){d.subtract(O,e[N],g);d.normalize(O,O);const P=m[0]*O[1]-m[1]*
O[0];0<P?P>z&&(z=P,C=N):P<J&&(J=P,u=N)}q.verify(0<z,"leftArea");q.verify(0>J,"rightArea");d.scale(K,m,D);d.add(K,K,y);d.scale(L,m,p);d.add(L,L,y);R[0]=-m[1];R[1]=m[0];x=q.rayRay2D(g,e[u],L,d.add(E,L,R),1,x);l=q.rayRay2D(g,e[C],L,E,1,l);r=q.rayRay2D(g,e[C],K,d.add(E,K,R),1,r);e=q.rayRay2D(g,e[u],K,E,1,f);q.verify(x,"rayRay");q.verify(l,"rayRay");q.verify(r,"rayRay");q.verify(e,"rayRay");l=ja;e=ka;g=la;r=ma;f=k.projectionMatrix;d.subtract(v,g,r);d.scale(v,v,.5);a[0]=v[0];a[1]=v[1];a[2]=0;a[3]=v[1];
a[4]=-v[0];a[5]=0;a[6]=v[0]*v[0]+v[1]*v[1];a[7]=v[0]*v[1]-v[1]*v[0];a[8]=1;a[6]=-d.dot(w(a,0),l);a[7]=-d.dot(w(a,1),l);l=d.dot(w(a,0),g)+a[6];x=d.dot(w(a,1),g)+a[7];u=d.dot(w(a,0),r)+a[6];r=d.dot(w(a,1),r)+a[7];l=-(l+u)/(x+r);a[0]+=a[1]*l;a[3]+=a[4]*l;a[6]+=a[7]*l;l=1/(d.dot(w(a,0),g)+a[6]);x=1/(d.dot(w(a,1),g)+a[7]);a[0]*=l;a[3]*=l;a[6]*=l;a[1]*=x;a[4]*=x;a[7]*=x;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;l=d.dot(w(a,1),e)+a[7];x=d.dot(w(a,2),e)+a[8];u=d.dot(w(a,1),g)+a[7];r=d.dot(w(a,2),g)+a[8];l=-.5*
(l/x+u/r);a[1]+=a[2]*l;a[4]+=a[5]*l;a[7]+=a[8]*l;l=d.dot(w(a,1),e)+a[7];x=d.dot(w(a,2),e)+a[8];u=-x/l;a[1]*=u;a[4]*=u;a[7]*=u;f[0]=a[0];f[1]=a[1];f[2]=0;f[3]=a[2];f[4]=a[3];f[5]=a[4];f[6]=0;f[7]=a[5];f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=a[6];f[13]=a[7];f[14]=0;f[15]=a[8];k.projectionMatrix[10]=2/(h-c);k.projectionMatrix[14]=-(h+c)/(h-c);H.multiply(t.lightMat,t.camera.projectionMatrix,t.camera.viewMatrix);h=this._textureHeight;t.camera.viewport=[b*h,0,h,h]}_setupMatrices(b,c){H.multiply(this._projectionView,
b.projectionMatrix,b.viewMatrix);H.invert(this._projectionViewInverse,this._projectionView);b=this._viewingMode===pa.ViewingMode.Global?b.eye:M.set(Y,0,0,1);H.lookAt(this._modelViewLight,[0,0,0],[-c[0],-c[1],-c[2]],b)}_computeCascadeDistances(b,c,e){e=e?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(q.logWithBase(c/b,4)),e);e=(c-b)/this._numCascades;c=(c/b)**(1/this._numCascades);let g=b;for(let t=0;t<this._numCascades+1;++t)this._cascadeDistances[t]=
S.lerp(g,b,this.settings.splitSchemeLambda),g*=c,b+=e}get test(){}}const ta=B.create(),ia=U.create(),A=[];for(let b=0;8>b;++b)A.push(U.create());const ja=n.create(),ka=n.create(),ua=n.create(),la=n.create(),ma=n.create(),Y=ba.create(),X=[],fa=B.create(),ha=B.IDENTITY.concat(B.IDENTITY,B.IDENTITY,B.IDENTITY,B.IDENTITY),y=n.create(),I=n.create(),F=[n.create(),n.create(),n.create(),n.create()],m=n.create(),Z=n.create(),E=n.create(),O=n.create(),K=n.create(),L=n.create(),R=n.create(),ea=n.create(),v=
n.create(),a=oa.create();G.ShadowMap=sa;Object.defineProperty(G,Symbol.toStringTag,{value:"Module"})});
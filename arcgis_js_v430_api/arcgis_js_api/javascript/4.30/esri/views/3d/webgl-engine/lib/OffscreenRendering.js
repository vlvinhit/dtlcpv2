// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/maybe ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../webgl/formats ./rendererUtils ./TransparencyPassType ../../../webgl/enums ../../../webgl/FramebufferObject".split(" "),function(m,z,l,r,t,e,u,n,h,v){class w{constructor(a,b){this._fbos=a;this.compositingHelper=b;this._height=this._width=4;this._clearColor=t.create()}dispose(){this._color=l.releaseMaybe(this._color);this.releaseBuffers()}get framebuffer(){this.color.attachDepth(this.depth);
return this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(a,b,c){this._fbos.interactive=c===u.RendererTarget.Default;c=this._fbos.rctx;this._width=a.fullWidth;this._height=a.fullHeight;v.ensureAttachmentMaxSize(this,c.parameters.maxTextureSize);a=this._color;this._color=null;this.releaseBuffers();r.copy(this._clearColor,b);return a}releaseBuffers(){this._color?.detachDepth();this._depth=l.releaseMaybe(this._depth)}renderHUDVisibility(a,
b,c){if(a?.fbo?.width!==this._width||a?.fbo?.height!==this._height)a?.release(),a=this._fbos.acquire(this._width,this._height,"hud visibility",e.ColorFormat.RGBA4);a.attachDepth(c||this.depth);this._fbos.rctx.bindFramebuffer(a.fbo);this._fbos.rctx.clearFramebuffer(x);b();a.detachDepth();return a}compositeToHUDVisibility(a,b){this._fbos.rctx.bindFramebuffer(a.hudVisibility?.fbo);this.compositingHelper.compositeHUD(a,b)}renderOITPass(a,b,c){let d,f;const {_width:g,_height:k}=this;switch(b){case n.TransparencyPassType.ColorAlpha:d=
this._fbos.acquire(g,k,c?"oit hud color alpha":"oit color alpha",e.ColorFormat.RGBA16F);d.acquireColor(h.ColorAttachment.COLOR_ATTACHMENT1,e.ColorFormat.R16F);f=[0,0,0,1];break;case n.TransparencyPassType.FrontFace:d=this._fbos.acquire(g,k,c?"oit hud front":"oit front"),f=[0,0,0,0]}c?d.acquireDepth(e.DepthFormat.DEPTH16_BUFFER):d.attachDepth(this.depth);this._fbos.rctx.bindFramebuffer(d.fbo);this._fbos.rctx.clearFramebuffer(f,c,c);a();d.detachDepth();return d}compositeToFramebuffer(a,b,c,d){this.bindFbo();
this.compositingHelper.composite(a,b,c,d)}compositeOIT(a,b,c,d){d?(this._fbos.rctx.bindFramebuffer(d.fbo),this._fbos.rctx.setClearColor(0,0,0,1E-13),this._fbos.rctx.clear(h.ClearBufferBit.COLOR_BUFFER_BIT)):this.bindFbo();this.compositingHelper.compositeOIT(a,b.getTexture(),b.getTexture(h.ColorAttachment.COLOR_ATTACHMENT1),c.getTexture())}renderDepthDetached(a){this._bindTarget(this.color);a();this._bindTarget(this.color,this.depth)}renderToCachedFBO(a,b,c,d,f=e.ColorFormat.RGBA,g=e.DepthFormat.DEPTH16_BUFFER,
k=this._width,p=this._height,y=null){if(a?.fbo?.width!==k||a?.fbo?.height!==p)a=l.releaseMaybe(a);a=a??this._fbos.acquire(k,p,b,f);y?.forEach(q=>a.acquireColor(q.attachment,q.format));null!=g&&a.acquireDepth(g);this._fbos.rctx.bindFramebuffer(a.fbo);this._fbos.rctx.clearFramebuffer(d,!0,!0);c();return a}renderToTargets(a,b,c,d,f=!1,g=!1){this._bindTarget(b,c);this._fbos.rctx.clearFramebuffer(d,f,g);a();b.detachDepth()}bindFbo(){var a=null==this._color;this._bindTarget(this.color,this.depth);a&&(a=
this._fbos.rctx,a.setClearStencil(0),a.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),a.clear(h.ClearBufferBit.COLOR_BUFFER_BIT|h.ClearBufferBit.DEPTH_BUFFER_BIT|h.ClearBufferBit.STENCIL_BUFFER_BIT))}_bindTarget(a,b){a.attachDepth(b);this._fbos.rctx.bindFramebuffer(a.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){this._color||(this._color=this._fbos.acquire(this._width,this._height,
"composite-color"));return this._color}updateColor(a){const b=this._ensureColor();b.attachDepth(this.depth);this._color=a(b)}get depth(){this._depth||(this._depth=this._fbos.acquireDepth(e.DepthFormat.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth"));return this._depth}}const x=[0,1,0,1];m.OffscreenRendering=w;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
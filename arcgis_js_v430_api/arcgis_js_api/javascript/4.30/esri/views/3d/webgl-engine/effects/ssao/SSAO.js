// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/time ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../webgl/formats ../../../webgl/RenderNode ../../core/shaderLibrary/shading/ScreenSpaceConstants ./SSAOBlurTechnique ./SSAONoiseData ./SSAOParameters ./SSAOTechnique ../../lib/basicInterfaces ../../../../../chunks/SSAO.glsl ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(d,k,z,A,B,r,t,M,N,O,C,x,u,D,v,E,F,y,G,H,I,l,J,K){d.SSAO=class extends D{constructor(b){super(b);this.consumes={required:["normals"]};this.produces="ssao";this.isEnabled=()=>!1;this._enableTime=r.Milliseconds(0);this._passParameters=new y.SSAOPassParameters;this._drawParameters=new y.BlurDrawParameters}initialize(){const b=Uint8Array.from(atob(F.noiseData),e=>e.charCodeAt(0)),c=new K.TextureDescriptor;c.wrapMode=l.TextureWrapMode.CLAMP_TO_EDGE;c.pixelFormat=l.PixelFormat.RGB;c.wrapMode=l.TextureWrapMode.REPEAT;
c.hasMipmap=!0;c.width=32;c.height=32;this._passParameters.noiseTexture=new J.Texture(this.renderingContext,c,b);this._ssaoTechnique=this.techniques.acquire(G.SSAOTechnique);this._blurTechnique=this.techniques.acquire(E.SSAOBlurTechnique);this.addHandles(B.watch(()=>this.isEnabled(),()=>this._enableTime=r.Milliseconds(0)))}destroy(){this._passParameters.noiseTexture=A.disposeMaybe(this._passParameters.noiseTexture);this._blurTechnique.release();this._ssaoTechnique.release()}render(b){const c=this.bindParameters;
b=b.find(({name:L})=>"normals"===L);var e=b?.getTexture(),g=b?.getTexture(l.DepthStencilAttachment),f=this.fboCache;b=c.camera;const m=b.fullViewport[2],n=b.fullViewport[3],p=Math.round(m/2),q=Math.round(n/2);if(!this._ssaoTechnique.compiled||!this._blurTechnique.compiled)return this._enableTime=r.Milliseconds(performance.now()),this.requestRender(),f.acquire(p,q,"ssao",u.ColorFormat.RED);0===this._enableTime&&(this._enableTime=r.Milliseconds(performance.now()));const a=this.renderingContext;var h=
this.view.qualitySettings.fadeDuration,w=z.clamp((v.distanceFadeEnd-b.relativeElevation)/(v.distanceFadeEnd-v.distanceFadeStart),0,1);h=0<h?Math.min(h,performance.now()-this._enableTime)/h:1;w*=h;this._passParameters.normalTexture=e;this._passParameters.depthTexture=g;this._passParameters.projScale=1/b.computeScreenPixelSizeAtDist(1);this._passParameters.intensity=2/I.getRadius(b)**6*w;g=f.acquire(m,n,"ssao input",u.ColorFormat.RG);a.unbindTexture(g.fbo.colorTexture);a.bindFramebuffer(g.fbo);a.setViewport(0,
0,m,n);a.bindTechnique(this._ssaoTechnique,c,this._passParameters,this._drawParameters);a.screen.draw();e=f.acquire(p,q,"ssao blur",u.ColorFormat.RED);a.unbindTexture(e.fbo.colorTexture);a.bindFramebuffer(e.fbo);this._drawParameters.colorTexture=g.getTexture();x.set(this._drawParameters.blurSize,0,2/n);a.bindTechnique(this._blurTechnique,c,this._passParameters,this._drawParameters);a.setViewport(0,0,p,q);a.screen.draw();g.release();f=f.acquire(p,q,"ssao",u.ColorFormat.RED);a.unbindTexture(f.fbo.colorTexture);
a.bindFramebuffer(f.fbo);a.setViewport(0,0,m,n);a.setClearColor(1,1,1,0);a.clear(l.ClearBufferBit.COLOR_BUFFER_BIT);this._drawParameters.colorTexture=e.getTexture();x.set(this._drawParameters.blurSize,2/m,0);a.bindTechnique(this._blurTechnique,c,this._passParameters,this._drawParameters);a.setViewport(0,0,p,q);a.screen.draw();a.setViewport4fv(b.fullViewport);e.release();1>h&&this.requestRender(H.RenderRequestType.UPDATE);return f}};k.__decorate([t.property()],d.SSAO.prototype,"consumes",void 0);k.__decorate([t.property()],
d.SSAO.prototype,"produces",void 0);k.__decorate([t.property({constructOnly:!0})],d.SSAO.prototype,"techniques",void 0);k.__decorate([t.property({constructOnly:!0})],d.SSAO.prototype,"isEnabled",void 0);d.SSAO=k.__decorate([C.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],d.SSAO);d.blurSizePixels=2;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
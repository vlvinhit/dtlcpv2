// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/signal ../core/shaderLibrary/ShaderOutput ./RenderPlugin ../lib/basicInterfaces ../lib/depthRange ../lib/Material ../lib/RenderSlot".split(" "),function(g,v,m,h,n,k,f,p,l,q,r){class t{constructor(a){this._context=a;this._renderPlugins=new m;this._materialRenderers=new Map;this._slots=[];this._renderVersion=n.signal(0);for(a=0;a<r.RenderSlot.MAX_SLOTS;++a)this._slots[a]=[]}destroy(){this._renderPlugins.forEach(a=>
a.destroy());this._renderPlugins.clear();this._materialRenderers.clear()}get plugins(){return this._renderPlugins}add(a,b){const c=()=>{if(b?.aborted)throw a.uninitializeRenderContext(),h.createAbortError();this._renderPlugins.push(a);a.materialReference&&this._materialRenderers.set(a.materialReference,a);a.produces.forEach((e,u)=>{this._slots[u].push(a)});this._context.requestRender();this._renderVersion.value++},d=a.initializeRenderContext(this._context,b);if(h.isPromiseLike(d))return d.then(c);
c()}remove(a){null!=a.materialReference&&this._materialRenderers.delete(a.materialReference);if(null!=this._renderPlugins.removeUnordered(a)){for(let b=0;b<this._slots.length;++b)this._slots[b]=this._slots[b].filter(c=>c!==a);a.uninitializeRenderContext();this._context.requestRender();this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll(a=>{a.prepareRender&&a.prepareRender(this._context.renderContext)})}updateAnimation(a){let b=!1;this._renderPlugins.forAll(c=>{c.updateAnimation&&
(b=c.updateAnimation(a)||b)});return b}renderFeatureChanged(){this._renderPlugins.forAll(a=>{a.renderFeatureChanged&&a.renderFeatureChanged()})}prepare(...a){for(const b of a)this._context.renderContext.bindParameters.slot=b,this._slots[b].forEach(c=>{c.produces.get(b)?.(k.ShaderOutput.Color)&&(f.isPrepareRenderPlugin(c)&&c.prepareTechnique(this._context.renderContext),f.isPreparesRenderPlugin(c)&&c.prepareTechniques(this._context.renderContext))})}_getRenderables(){const a=this._context.renderContext.bindParameters.slot,
b=this._context.renderContext.output??k.ShaderOutput.Color,c=new Map;this._slots[a].forEach(d=>{if(d.produces.get(a)?.(b)&&(!d.isDecoration||this._context.renderContext.bindParameters.decorations!==p.Decorations.OFF))if(f.isPrepareRenderPlugin(d)){var e=d.prepareTechnique(this._context.renderContext);null!=e&&c.set(d,e)}else f.isPreparesRenderPlugin(d)?(e=d.prepareTechniques(this._context.renderContext),null!=e&&c.set(d,e)):c.set(d,null)});return c}render(a,...b){for(const c of b)this._context.renderContext.bindParameters.slot=
c,this._getRenderables().forEach((d,e)=>e.renderNode(this._context.renderContext,d,a))}queryDepthRange(a){const b=new l.DepthRange;this._renderPlugins.forAll(c=>{c=c.queryDepthRange?.(a);l.union(b,c)});return b}get updating(){return 0<=this._renderVersion.value&&this._renderPlugins.some(a=>a.running)}produces(a,...b){for(const c of b)if(this._slots[c].some(d=>(d=d.produces.get(c))?d(a):!1))return!0;return!1}consumes(a){return this._renderPlugins.some(b=>b.consumes().required.includes(a))}getMaterialRenderer(a){return this._materialRenderers.get(a)}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace(a=>
a.materialReference&&0===a.numGeometries?(this._materialRenderers.delete(a.materialReference),a.destroy(),!1):!0)}get hasDecorations(){return this._renderPlugins.some(a=>a.isDecoration)}get hasOccludees(){return this._renderPlugins.some(a=>a.hasOccludees)}get renderOccludedFlags(){return this._renderPlugins.reduce((a,b)=>a|b.renderOccludedFlags,q.RenderOccludedFlag.None)}get usedMemory(){return this._renderPlugins.reduce((a,b)=>null!==b.materialReference?a:a+(b.usedMemory??0),0)}get test(){}}g.RenderPluginManager=
t;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
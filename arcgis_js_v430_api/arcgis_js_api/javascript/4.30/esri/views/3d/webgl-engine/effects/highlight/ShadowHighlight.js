// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/colorUtils ../../../../../core/mathUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../ViewingMode ../../../webgl/RenderNode ./HighlightDefaults ./ShadowHighlightTechnique ../../lib/basicInterfaces".split(" "),
function(b,f,q,h,d,g,x,y,z,r,k,t,u,v,l,n,w){b.ShadowHighlight=class extends v{constructor(a){super(a);this.produces="composite-color";this.consumes={required:["composite-color","highlights"]};this._passParameters=new n.ShadowHighlightPassParameters;this._maxOpacity=1;this._shadowDifference=.2;this._technique=a.techniques.acquire(n.ShadowHighlightTechnique)}initialize(){this.addHandles([d.watch(()=>this.view.highlightOptions.shadowOpacity,a=>{this._passParameters.shadowOpacity=a??l.defaultShadowOpacity;
this._updateOccludedShadowOpacity();this._updateMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowDifference,a=>{this._shadowDifference=a??l.defaultShadowDifference;this._updateOccludedShadowOpacity();this._updateMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowColor,a=>{this._passParameters.shadowColor=q.unitRGBAFromColor(a??l.defaultShadowColor);this._updateMaxOpacity()},d.syncAndInitial)])}destroy(){this._technique.release()}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=
this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){this._maxOpacity=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity)*this._passParameters.shadowColor[3]}render(a){const c=a.find(({name:m})=>"composite-color"===m),e=this.bindParameters;if(!e.shadowHighlightsVisible||!e.depth||!this._ensureIfVisible(e.camera,e.lighting.mainLight.direction))return c;if(!this._technique.compiled)return this.requestRender(w.RenderRequestType.UPDATE),
c;this._passParameters.highlight=a.find(({name:m})=>"highlights"===m)?.getTexture();this._passParameters.origin=e.camera.center;a=this.renderingContext;a.bindFramebuffer(c.fbo);a.bindTechnique(this._technique,e,this._passParameters);a.screen.draw();return c}_ensureIfVisible(a,c){this._passParameters.opacityElevation=1-h.smoothstep(4E4,5E4,a.relativeElevation);a=this.viewingMode===u.ViewingMode.Global?k.normalize(p,a.center):k.set(p,0,0,1);c=k.dot(a,c);this._passParameters.dayNightTerminator=h.smoothstep(0,
1,h.clamp(30*c,0,1));return.001953125<=this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator}};f.__decorate([g.property()],b.ShadowHighlight.prototype,"produces",void 0);f.__decorate([g.property()],b.ShadowHighlight.prototype,"consumes",void 0);f.__decorate([g.property({constructOnly:!0})],b.ShadowHighlight.prototype,"viewingMode",void 0);f.__decorate([g.property({constructOnly:!0})],b.ShadowHighlight.prototype,"techniques",void 0);b.ShadowHighlight=f.__decorate([r.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],
b.ShadowHighlight);const p=t.create();Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/factories/vec3f64","../../../../../geometry/support/aaBoundingBox","../../lib/RayIntersections"],function(w,I,J,x,y){function K(a,b,c){let g=0,f=Infinity;for(let e=0;3>e;++e){var d=a[e];if(b[e]<d){if(1E-6>=c[e])return!1;g=Math.max(g,(d-b[e])/c[e])}else-1E-6>=c[e]&&(f=Math.min(f,(d-b[e])/c[e]));if(g>f)return!1;d=a[e+3];if(b[e]>d){if(-1E-6<=c[e])return!1;g=Math.max(g,(d-b[e])/c[e])}else 1E-6<=c[e]&&(f=Math.min(f,
(d-b[e])/c[e]));if(g>f)return!1}return!0}function L(a,b,c,g,f,d){let e=g;for(;c<e;){var h=a[c];b[6*h+f+3]<=d?++c:(--e,a[c]=a[e],a[e]=h)}h=c;for(e=g;h<e;)g=a[e-1],b[6*g+f]>=d?--e:(a[e-1]=a[h],a[h]=g,++h);return{next:c,mid:h}}function M(a,b,c,g){if(g<=c)return x.fromValues(NaN,NaN,NaN,NaN,NaN,NaN);var f=6*a[c];for(var d=0;3>d;++d)p[d]=b[f+0+d],q[d]=b[f+3+d];for(c+=1;c<g;++c)for(f=6*a[c],d=0;3>d;++d)p[d]=Math.min(p[d],b[f+0+d]),q[d]=Math.max(q[d],b[f+3+d]);return x.fromValues(p[0],p[1],p[2],q[0],q[1],
q[2])}function N(a){var b=a[3]-a[0];const c=a[4]-a[1],g=a[5]-a[2];b=b>c?b>g?0:c>g?1:2:c>g?1:g>b?2:0;return{axis:b,midValue:(a[b]+a[b+3])/2}}function O(a,b,c,g,f){c-=b;const d=new Float32Array(6*c);for(let h=0;h<c;++h){var e=3*(h+b);const n=a[e]*f,k=a[e+1]*f;e=a[e+2]*f;for(let l=0;3>l;++l){const r=g[n+l],m=g[k+l],t=g[e+l];d[6*h+l]=Math.min(r,m,t);d[6*h+3+l]=Math.max(r,m,t)}}return d}class z{constructor(a,b,c,g,f){this.aabb=a;this.axis=b;this.d=c;this.midStartIndex=g;this.rightStartIndex=f}}class u{constructor(a,
b,c,g){this.globalTriangleVertexIndices=a;this.firstTriangleIndex=b;this.positions=g;this._rayDirection=J.create();this._callback=A;this._intersectionOptions=B;this.bspNodeTree=[];const f=c-b,d=new (255>f?Uint8Array:65535>f?Uint16Array:Uint32Array)(f);this.triangleIndexMap=d;for(let k=0;k<f;++k)d[k]=k;const e=O(a,b,c,g.data,g.stride),h=I.clamp(Math.log2(f/40),2,10),n=(k,l,r)=>{var m=M(d,e,k,l);const t=l-k;if(40>=t)return k=new z(m,void 0,0,k,l),this.bspNodeTree.push(k),k;const {axis:C,midValue:D}=
N(m),v=L(d,e,k,l,C,D),H=(E,F)=>{if(!(r>h)){var G=F-E;if(!(40>G||G>=.8*t))return n(E,F,r+1)}};m=new z(m,C,D,v.next,v.mid);this.bspNodeTree.push(m);m.leftNode=H(k,v.next);m.rightNode=H(v.mid,l);return m};n(0,f,0)}intersectRayTriangleRange(a,b){if(!(a>=b)){var c=this.positions;y.intersectRayTriangles(this._rayFrom,this._rayDirection,a,b,this.globalTriangleVertexIndices,c.data,c.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex);u.numFacesTested+=
b-a}}intersectRay(a,b,c,g){u.numFacesTested=0;var f=b[0]-a[0];const d=b[1]-a[1];b=b[2]-a[2];1E-6>f*f+d*d+b*b||(this._rayFrom=a,a=this._rayDirection,a[0]=f,a[1]=d,a[2]=b,f=this.triangleIndexMap.length,this._callback=g,this._intersectionOptions=c,this.intersectRayBSP(this.bspNodeTree[0],0,f),this._callback=A,this._intersectionOptions=B)}intersectRayBSP(a,b,c){const g=this._rayFrom,f=this._rayDirection;if(K(a.aabb,g,f)){var d=a.axis,e=a.d;if(g[d]<e||0>f[d]){const h=a.midStartIndex;if(b<h){const n=a.leftNode;
void 0!==n?this.intersectRayBSP(n,b,h):this.intersectRayTriangleRange(b,h)}}this.intersectRayTriangleRange(a.midStartIndex,a.rightStartIndex);if(g[d]>e||0<f[d])b=a.rightStartIndex,b<c&&(a=a.rightNode,void 0!==a?this.intersectRayBSP(a,b,c):this.intersectRayTriangleRange(b,c))}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}u.numFacesTested=0;const p=[Infinity,Infinity,Infinity],q=[-Infinity,-Infinity,-Infinity],B=new y.MeshIntersectionOptions,A=()=>{};w.ComponentIntersectionData=
u;w.componentMinimalSizeForIntersectionData=200;Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
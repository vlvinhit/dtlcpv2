// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/tslib.es6 ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/colorUtils ../../../../core/has ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/signal ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/accessorSupport/interfaces ../../../../core/accessorSupport/tracking/Flags ../../../../core/Warning ../../../../core/Error ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../chunks/boundedPlane ../../webgl ../../support/debugFlags ../../terrain/TerrainRenderer ../../webgl/formats ../core/FBOCache ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDRenderStyle ../core/shaderLibrary/shading/ScreenSpaceConstants ../effects/RenderNodes ../effects/RenderPlugin ../effects/RenderPluginManager ../effects/blit/Blit ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderFeature ./RenderPluginInput ./RenderSlot ./ShadowAccumulator ./ShadowMap ./SliceHelper ./TransparencyPassType ./Viewshed ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../shaders/OITCompositingTechnique ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(ja,N,T,ka,la,ma,U,r,na,oa,x,V,W,Ka,La,Ma,Na,Oa,H,I,pa,ba,qa,A,ra,X,w,Y,sa,k,y,ta,ua,va,wa,xa,ya,B,za,ca,Aa,t,Ba,da,G,C,Ca,d,Da,Z,Ea,D,Fa,J,Ga,O,Ha,n,Ia,K){function Ja(a){return b=>a.immediate.schedule(b)}class Q{constructor(a,b,c,e,g,m){this._stage=a;this._techniques=c;this._rctx=e;this._compositingHelper=g;this._requestRender=m;this._pluginsHas={hudElements:!1,water:!1};this._hasOverlayWater=!1;this.renderOverlay=f=>{};this._inGlobeView=this._isRendering=!1;this._backgroundColor=ba.fromValues(0,
0,0,1);this._sliceHelper=new Ea;this._blit=null;this._state=V.signal(Ia.RenderState.IDLE);this._highQualityTransparencyEnabled=!0;this._terrainTransparency=X.TransparencyMode.Opaque;this._hasAnimations=this._ssrEnabled=!1;this._animationTimestep=new ya.AnimationTimeStep;this._loadEdgeViewTask=null;this._edgeViewCallbacks=[];this._reprojectionMatrixVersion=V.signal(0);this._renderHiddenTransparentEdges=()=>{};this._pluginInput=new Ca.RenderPluginInput;this._releaseNormals=f=>{f.some(({name:h})=>"normals"===
h)&&this._pluginInput.release("normals")};this._debugNeedsDepth=!1;this.fboCache=new Y.FBOCache(e);this._renderStateFeatures=V.signal(C.setupFeatureDefaults(!U("disable-feature:high-quality-idle"),a.view.qualityProfile));this._offscreen=new Ba.OffscreenRendering(this.fboCache,this._compositingHelper);this.performanceInfo=new n.RendererPerformanceInfo(this._rctx);this._shadowMap=new Z.ShadowMap(this.fboCache,a.viewingMode);this._viewshed=new Fa.Viewshed({fboCache:this.fboCache,view:a.view},(f,h,p)=>
{h.setGLViewport(this._rctx);const {camera:q,contentCamera:z}=f;this._ensureBindParametersCamera(h,h);this._renderAllGeometry(p);this._ensureBindParametersCamera(q,z);f.camera.setGLViewport(this._rctx)});this._shadowAccumulator=new Da.ShadowAccumulator(this.fboCache,c,a,f=>{const h=this.shadowsEnabled;this._shadowMap.enabled=!0;this._ensureBindParametersCamera(f.camera,f.contentCamera);this._plugins.prepareRender();this._shadowMap.enabled=h},(f,h,p)=>{f.shadowMap.start(f.camera,h,p,!0,this._stage.view.qualitySettings.maximumPixelRatio);
this._renderShadowCascades(k.ShaderOutput.Shadow,f.shadowMap);f.shadowMap.finish();f.camera.setGLViewport(this._rctx);this._ensureBindParametersCamera(f.camera,f.contentCamera)},m);this._renderContext=new da.RenderContext(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper);this._nodes=new ua.RenderNodes(this._renderContext);this._plugins=new wa.RenderPluginManager({renderContext:this._renderContext,techniques:c,materials:b,requestRender:m,controller:a,fbos:this.fboCache,isFeatureEnabled:f=>
this.isFeatureEnabled(f)});this.renderPassManager=new sa.RenderPassManager;this._plugins.add(this.renderPassManager);this._plugins.add(this._viewshed);this._handles=[x.watch(()=>this._stage.view.state.camera,()=>m(),x.syncAndInitial),x.watch(()=>ra.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,f=>{this._renderHiddenTransparentEdges=f?()=>this._renderEdges(J.Transparency.TRANSPARENT):()=>{};m()},x.initial),x.watch(()=>this._stage.view.environment.background?.color,f=>{f=f?ma.unitRGBAFromColor(f):
ba.ZEROS;pa.set(this._backgroundColor,f[0]*f[3],f[1]*f[3],f[2]*f[3],f[3]);m()},x.syncAndInitial),x.watch(()=>this._stage.view.state.camera.relativeElevation,f=>{this._inGlobeView=(f??Infinity)>=ta.distanceFadeEnd},x.syncAndInitial)]}destroy(){this._handles.forEach(a=>a.remove());this._gpuTimerHandle=r.removeMaybe(this._gpuTimerHandle);this._nodes.destroy();this._offscreen.dispose();this._shadowMap.dispose();this._shadowAccumulator.dispose();this._loadEdgeViewTask=r.abortMaybe(this._loadEdgeViewTask);
this._edgeView=r.destroyMaybe(this._edgeView);this.renderPassManager.dispose();this._releaseFBOs();this._disposeOffscreenBuffers();this.fboCache.destroy();this._plugins.destroy();za.BoundingInfo.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(a=null,b=!U("disable-feature:high-quality-idle")){this._renderStateFeatures.value=C.setupFeatureDefaults(b,a);this._plugins.renderFeatureChanged();this._requestRender()}isFeatureEnabled(a,b=this._state.value){return this._renderStateFeatures.value.get(b,
a)??!1}setFeatureEnabled(a,b,c){this._renderStateFeatures.mutate(e=>e.set(b,a,c));this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(C.RenderFeature.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(C.RenderFeature.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations||this._nodes.produces("magnifier-color")}get hasHighlights(){return this._plugins.produces(k.ShaderOutput.Highlight,
d.RenderSlot.OPAQUE_MATERIAL,d.RenderSlot.TRANSPARENT_MATERIAL,d.RenderSlot.DRAPED_MATERIAL)}get hasLaserlines(){return this._plugins.produces(this._renderContext.output,d.RenderSlot.LASERLINES,d.RenderSlot.LASERLINES_CONTRAST_CONTROL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(C.RenderFeature.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(C.RenderFeature.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||
this.isFeatureEnabled(C.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=r.releaseMaybe(this._bindParameters.ssr.lastFrameColor);this._bindParameters.multipassTerrain.depth=r.releaseMaybe(this._bindParameters.multipassTerrain.depth);this._bindParameters.multipassGeometry.depth=r.releaseMaybe(this._bindParameters.multipassGeometry.depth)}_disposeOffscreenBuffers(){this._offscreen.dispose();this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers();
this._viewshed.viewshedShadowMap.disposeOffscreenBuffers();this._bindParameters.depth=r.releaseMaybe(this._bindParameters.depth);this._bindParameters.hudVisibility=r.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){if(this._loadEdgeViewTask)return this._loadEdgeViewTask.promise;this._loadEdgeViewTask=la.createTask(async a=>{const {EdgeView:b}=
await new Promise((e,g)=>ja(["./edgeRendering/EdgeView"],e,g));oa.throwIfAborted(a);const c=this._edgeView=new b({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:Ja(this._stage.view.resourceController)});this._handles.push(x.watch(()=>c.updating,()=>this._requestRender(),x.sync));this._requestRender();this._edgeViewCallbacks.forEach(e=>e(c));this._edgeViewCallbacks.length=
0;return c});return this._loadEdgeViewTask.promise}withEdgeView(a){this.loadEdgeView();null==this._edgeView?this._edgeViewCallbacks.push(a):a(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return 0<=this._reprojectionMatrixVersion.value&&H.equals(this._bindParameters.ssr.reprojectionMatrix,I.IDENTITY)}set _reprojectionMatrix(a){ka.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(a){const {_shadowMap:b,
_bindParameters:c}=this;void 0!==a.qualitySettings?.reflections&&this._ssrEnabled!==a.qualitySettings.reflections&&(this._ssrEnabled=a.qualitySettings.reflections,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&b.maxCascades!==a.shadowMapMaxCascades&&(b.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(null!=a.environment){null!=a.environment.weather&&(this._bindParameters.weather=
a.environment.weather,this._bindParameters.weatherVisible=!!a.weatherVisible);const e="virtual"!==a.environment.lighting.type;c.enableFillLights!==e&&(c.enableFillLights=e,this._requestRender())}void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==a.highQualityTransparency&&(this._highQualityTransparencyEnabled=a.highQualityTransparency,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,this._requestRender());
void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane,this._requestRender());void 0!==a.terrainTransparency&&this._terrainTransparency!==a.terrainTransparency&&(this._terrainTransparency=a.terrainTransparency,this._requestRender());void 0!==a.shadowCast&&this._shadowAccumulator.setOptions(a.shadowCast)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&
this._hasOITSupport}modify(a,b){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:c,removes:e,updates:g}=a;if(0!==c.length||0!==e.length||0!==g.length){var m=!1;G.splitRenderGeometryChangeSetByMaterial(a).forEach((f,h)=>{if(!b.done){var p=this._plugins.getMaterialRenderer(h);null==p&&0<f.adds.length&&(h=new Ga.MergedRenderer({material:h}),h.initializeRenderContext(this._plugins._context),p=h,this._plugins.add(p));p&&(p.modify(f),0===p.numGeometries&&(m=!0));f.removes.forEach(q=>
a.removes.removeUnordered(q));f.adds.forEach(q=>a.adds.removeUnordered(q));f.updates.forEach(q=>a.updates.removeUnordered(q));b.madeProgress()}});m&&this._plugins.removeEmptyMaterialRenderers();this._updateHasFlags();this._requestRender()}}_updateHasFlags(){const a=this._pluginsHas;a.hudElements=this._plugins.produces(k.ShaderOutput.Color,d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,d.RenderSlot.HUD_MATERIAL,d.RenderSlot.LABEL_MATERIAL);a.water=this._plugins.produces(k.ShaderOutput.Normal,d.RenderSlot.DRAPED_WATER);
this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(a){const b=this._hasAnimations;this._hasAnimations=this._plugins.updateAnimation(a);this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations;this._hasAnimations!==b&&(this._gpuTimerHandle=b?r.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(a,
b,c=G.RendererTarget.Default,e=B.Decorations.ON){this._isRendering=!0;this.performanceInfo.startFrame();this.fboCache.frameStart();this._disposeBindBuffers();const g=this._offscreen,{camera:m,contentCamera:f,mode:h,alignPixelEnabled:p}=a;this._state.value=h;this._bindParameters.overlay=this.renderOverlay(b);this._bindParameters.overlay&&this.performanceInfo.advance(n.PerformanceCategory.OVERLAY);this._renderContext.time=b;this._bindParameters.transparencyPassType=D.TransparencyPassType.NONE;this._bindParameters.alignPixelEnabled=
p;this._bindParameters.decorations=e;this._bindParameters.mainColor=this._bindParameters.mainDepth=null;this._bindParameters.viewshedEnabled=this._viewshed.enabled;a=this._nodes.produces("magnifier-color");const q=this._nodes.produces("final-color"),z=qa.create(this._sliceHelper.plane);e===B.Decorations.OFF&&(this._sliceHelper.plane=null);m.setGLViewport(this._rctx);var l=g.initializeFrame(m,this._backgroundColor,c);this.hasReflections?this._bindParameters.ssr.lastFrameColor=l:l?.release();this._ensureBindParametersCamera(m,
f);this._plugins.prepareRender();this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&e===B.Decorations.ON;var u=this._plugins.produces(k.ShaderOutput.Color,d.RenderSlot.OPAQUE_TERRAIN)&&(this._terrainTransparency===X.TransparencyMode.Semitransparent||this._terrainTransparency===X.TransparencyMode.TransparentWithDraped);l=this._highQualityTransparency&&u;const L=this._plugins.produces(k.ShaderOutput.Color,...R);this._prepareShaders(l,L);this.performanceInfo.advance(n.PerformanceCategory.PREPARE);
var E=this._computeDepthRange(m);this._renderShadowMap(m,this._bindParameters.lighting.mainLight.direction,E);this._ensureBindParametersCamera(m,f);let S=this._renderNormals();this._pluginInput.set("normals",S);if(S){let F=null;this._needsDepth&&(F=S.getAttachment(K.DepthStencilAttachment),F?.retain());this._pluginInput.set("ssao",this._renderSSAO());this._renderNoSSAOGeometryDepth(F);S=null}else this._renderAllGeometryDepth();this._renderShadowAccumulation(E,m,f);this._ensureBindParametersSSR(b);
this._renderContext.output=k.ShaderOutput.Color;g.bindFbo();this._bindParameters.mainColor=g.colorTexture;this._bindParameters.mainDepth=g.depthTexture;const ea=this.plugins.produces(k.ShaderOutput.Color,...aa);ea&&this._renderOpaqueGeometry();this._offscreen.updateColor(F=>this._renderNodes(A.RenderCategory.OPAQUE,F,ea));this.fboCache.debugCallback?.("opaque-color",this._offscreen.color.fbo);this._renderPlugins(d.RenderSlot.OPAQUE_ENVIRONMENT,n.PerformanceCategory.OPAQUE_ENVIRONMENT);this._renderMultipassTerrainDepth(l);
this._setMultipassTerrain(l);this._renderEdges(J.Transparency.OPAQUE);g.bindFbo();this._renderPlugins(d.RenderSlot.VOXEL,n.PerformanceCategory.VOXEL);this._renderHiddenTransparentEdges();L&&(this._oitEnabled?this._renderOITPass(P.Geometry):this._renderTransparentMaterial());this._offscreen.updateColor(F=>this._renderNodes(A.RenderCategory.TRANSPARENT,F,L));this.fboCache.debugCallback?.("transparent-color",this._offscreen.color.fbo);this._renderMultipassGeometryDepth(l);this._renderHUDVisibility();
l||this._plugins.render(this._pluginInput,d.RenderSlot.LINE_CALLOUTS);b=c===G.RendererTarget.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges(J.Transparency.TRANSPARENT);if(u=u?this._renderTransparentTerrain():null)this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(l?this._renderLineCallouts(y.HUDRenderStyle.Occluded):g.compositeToHUDVisibility(this._bindParameters,u.getTexture()),this._renderHUD(y.HUDRenderStyle.Occluded,
g.color));this._setTerrainCulling(!1);u&&(g.compositeToFramebuffer(this._bindParameters,u.getTexture(),O.AlphaMode.PremultipliedAlpha,1),u.release(),l&&(this._renderEdges(J.Transparency.OPAQUE),L&&(this._oitEnabled?this._renderOITPass(P.Geometry):this._renderTransparentMaterial(),this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT)),this._renderEdges(J.Transparency.TRANSPARENT)));this._bindParameters.ssao=r.releaseMaybe(this._bindParameters.ssao);l&&this._renderLineCallouts(y.HUDRenderStyle.NotOccluded);
this._setMultipassEnabled(!1);this._renderTransparentEnvironment();this._renderViewshed();this._renderLaserlines();this._renderOccluded();this._pluginInput.set("highlights",this._renderHighlightPrepass());this._offscreen.updateColor(F=>this._renderNodes(A.RenderCategory.COMPOSITE,F));l=this._nodes.produces("aa-color");E=c===G.RendererTarget.Default&&!q&&!(a&&e===B.Decorations.ON&&c===G.RendererTarget.Default);u=this._pluginInput.get("composite-color");E=E?Y.defaultWebGLFBO:this.fboCache.acquire(u.fbo.width,
u.fbo.height,"aa-color");l=l?this._renderNodes(A.InternalRenderCategory.ANTIALIASING,E):this._blitToDefault(u,E,!1);this._pluginInput.set(A.InternalRenderCategory.ANTIALIASING,l);this._renderHUD(y.HUDRenderStyle.NotOccluded,l);l=this._renderNodes(A.InternalRenderCategory.HIGHLIGHTS,l);l=this._renderNodes(A.InternalRenderCategory.MAGNIFIER,l);a&&e===B.Decorations.ON&&c===G.RendererTarget.Default&&!q&&(l=this._blitToDefault(l));q?(l.attachDepth(g.depth),this._blitToDefault(this._renderNodes(A.RenderCategory.FINAL,
l)),l.detachDepth()):this._pluginInput.set(A.RenderCategory.FINAL,l);this._pluginInput.release("highlights");if(this.onPostRender)this.onPostRender();this._releaseFBOs();this._offscreen.releaseBuffers();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=z;this._isRendering=!1;this.fboCache.frameEnd();this.performanceInfo.finishFrame();c!==G.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers());return{screen:this._pluginInput.get("final-color"),
oid:b}}_prepareShaders(a,b){this._renderContext.output=k.ShaderOutput.Color;this._prepareOpaqueGeometry();this._setMultipassTerrain(a);this._plugins.prepare(d.RenderSlot.TRANSPARENT_TERRAIN);this._setMultipassTerrain(!1);a||this._plugins.prepare(d.RenderSlot.LINE_CALLOUTS);b&&this._prepareTransparencySlots();this._plugins.prepare(d.RenderSlot.VIEWSHED,d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,d.RenderSlot.TRANSPARENT_ENVIRONMENT,d.RenderSlot.LASERLINES);this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(U("enable-feature:objectAndLayerId-rendering")){var a=
this._renderContext.output,b=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");b.acquireDepth(w.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(b.fbo);this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0);this._renderAllGeometry(k.ShaderOutput.ObjectAndLayerIdColor);this._rctx.bindFramebuffer(b.fbo);this.fboCache.rctx.clearFramebuffer(void 0,!0,!0);this._bindParameters.hudRenderStyle=y.HUDRenderStyle.NotOccluded;this._plugins.render(this._pluginInput,d.RenderSlot.HUD_MATERIAL);
this._renderContext.output=a;this.performanceInfo.advance(n.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);return b}}finish(a){this._hasAnimations||this._animationTimestep.clear();var b=this.performanceInfo.gpuSamplingEnabled;if((a=a===B.RenderRequestType.BACKGROUND)||b){const c=a?this.performanceInfo.elapsedTime:0;b=b?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();this._animationTimestep.frame(Math.max(c,b),a)}}readDepthPixels(a,b){if(this._bindParameters.mainDepth){var {width:c,
height:e}=this._offscreen,g=this.fboCache.acquire(c,e,"linear-depth");this._rctx.bindFramebuffer(g.fbo);this._bindParameters.camera.setGLViewport(this._rctx);this._rctx.clearFramebuffer([0,0,0,0],!0,!0);this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,this._bindParameters.mainDepth);g.fbo?.readPixels(a[0],a[1],a[2],a[3],K.PixelFormat.RGBA,K.PixelType.UNSIGNED_BYTE,b);g.release()}}readHUDVisibility(a,b,c,e,g){this._bindParameters.hudVisibility?.fbo?.readPixels(a,b,c,e,K.PixelFormat.RGBA,
K.PixelType.UNSIGNED_BYTE,g)}readAccumulatedShadow(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])}_setMultipassTerrain(a){this._setMultipassEnabled(a);this._setTerrainCulling(a)}_setMultipassEnabled(a){this._bindParameters.multipassEnabled=a}_setTerrainCulling(a){this._bindParameters.multipassTerrain.cullAboveGround=a}_renderEdges(a){const b=this._edgeView;if(b?.shouldRender()){var {width:c,height:e,depth:g}=this._offscreen,m=this.fboCache.acquire(c,e,"edges");this._offscreen.renderToTargets(()=>
b.render(this._bindParameters,a),m,this._bindParameters.multipassGeometry.depth??g,fa);this._offscreen.compositeToFramebuffer(this._bindParameters,m.getTexture(),O.AlphaMode.Alpha,1);m.release();this.performanceInfo.advance(a===J.Transparency.OPAQUE?n.PerformanceCategory.OPAQUE_EDGES:n.PerformanceCategory.TRANSPARENT_EDGES)}}_renderShadowMap(a,b,c){const e=this._shadowMap;e.enabled&&(e.start(a,b,c,this.isFeatureEnabled(C.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),
this._needsShadowHighlight?(this._renderShadowCascades(k.ShaderOutput.ShadowHighlight,this._shadowMap),e.moveSnapshot(Z.SnapshotSlot.Highlight),this._renderShadowCascades(k.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),e.copySnapshot(Z.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(k.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(k.ShaderOutput.Shadow),e.finish(),a.setGLViewport(this._rctx),this.performanceInfo.advance(n.PerformanceCategory.SHADOW_MAP))}_renderShadowCascades(a,
b=this._shadowMap){for(const c of b.cascades)c.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(c.camera,c.camera),this._renderAllGeometry(a)}get _needsDepth(){return this._plugins.consumes(k.ShaderOutput.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugNeedsDepth}_renderNoSSAOGeometryDepth(a){if(this._needsDepth&&a){var {width:b,height:c}=this._offscreen,e=this.fboCache.acquire(b,c,"depth");e.attachDepth(a);a.release();this._rctx.bindFramebuffer(e.fbo);
this._rctx.clearFramebuffer(void 0,!1,!0);this._renderGeometryExcludedFromSSAO(k.ShaderOutput.Depth);r.releaseMaybe(this._bindParameters.depth);this._bindParameters.depth=e.obtainDepthTexture();e.release();this.performanceInfo.advance(n.PerformanceCategory.DEPTH)}else this._bindParameters.depth=r.releaseMaybe(this._bindParameters.depth)}_renderAllGeometryDepth(){if(this._needsDepth){var {width:a,height:b}=this._offscreen,c=this.fboCache.acquire(a,b,"depth").acquireDepth(w.DepthFormat.DEPTH_STENCIL_TEXTURE);
this._rctx.bindFramebuffer(c.fbo);this._rctx.clearFramebuffer(void 0,!0,!0);this._renderAllGeometry(k.ShaderOutput.Depth);r.releaseMaybe(this._bindParameters.depth);this._bindParameters.depth=c.obtainDepthTexture();c.release();this.performanceInfo.advance(n.PerformanceCategory.DEPTH)}else this._bindParameters.depth=r.releaseMaybe(this._bindParameters.depth)}_renderMultipassTerrainDepth(a){if(a){a=this._renderContext.output;this._renderContext.output=k.ShaderOutput.Depth;var {width:b,height:c}=this._offscreen,
e=this.fboCache.acquire(b,c,"terrain depth").acquireDepth(w.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(e.fbo);this._rctx.clearFramebuffer(void 0,!0,!0);this._renderTransparentTerrain();r.releaseMaybe(this._bindParameters.multipassTerrain.depth);this._bindParameters.multipassTerrain.depth=e.obtainDepthTexture();this._renderContext.output=a;e.release()}else this._bindParameters.multipassTerrain.depth=r.releaseMaybe(this._bindParameters.multipassTerrain.depth)}_renderMultipassGeometryDepth(a){if(a){a=
this._renderContext.output;var {width:b,height:c}=this._offscreen,e=this.fboCache.acquire(b,c,"geometry depth").acquireDepth(w.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(e.fbo);this._rctx.clearFramebuffer(void 0,!0,!0);this._renderOpaqueGeometryAndTransparentMaterial(k.ShaderOutput.Depth);this._renderContext.output=a;r.releaseMaybe(this._bindParameters.multipassGeometry.depth);this._bindParameters.multipassGeometry.depth=e.obtainDepthTexture();e.release()}else this._bindParameters.multipassGeometry.depth=
r.releaseMaybe(this._bindParameters.multipassGeometry.depth)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(a){if(!this._needsDepthRange)return ca.zero;const b=Aa.depthRangeFromScene(a,this._plugins.plugins,this._stage.layers);ca.union(b,this._plugins.queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b}_renderNormals(){var a=this._nodes.require("normals","final-color","composite-color","opaque-color","transparent-color");
a=(this.hasSSAO?1:0)+(this.hasLaserlines?1:0)+a;if(0!==a){var b=this._offscreen.renderToCachedFBO(null,"normals",()=>this._renderGeometryForSSAO(k.ShaderOutput.Normal),[0,0,0,0],w.ColorFormat.RGBA,w.DepthFormat.DEPTH_STENCIL_TEXTURE),c=this._nodes.optional("normals","final-color","composite-color","opaque-color","transparent-color")+(this._viewshedEnabled?1:0);b.retain(a+c-1);this.performanceInfo.advance(n.PerformanceCategory.NORMALS);return b}}_renderSSAO(){const a=this._pluginInput.get("normals");
if(this.hasSSAO&&a){var b=this._nodes.render("ssao",this._pluginInput);this._bindParameters.ssao=b;a.detachDepth();this._pluginInput.release("normals");this.performanceInfo.advance(n.PerformanceCategory.SSAO);return b}a?.detachDepth()}_renderAllGeometry(a){this._renderContext.output=a;this._plugins.prepare(d.RenderSlot.TRANSPARENT_TERRAIN);this._renderOpaqueGeometryAndTransparentMaterial(a);this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(a){this._renderContext.output=
a;this._plugins.prepare(d.RenderSlot.TRANSPARENT_MATERIAL,d.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH);this._renderOpaqueGeometry();this._renderTransparentMaterial()}_renderGeometryForSSAO(a){this._renderContext.output=a;this._plugins.render(this._pluginInput,d.RenderSlot.INTEGRATED_MESH,d.RenderSlot.OPAQUE_TERRAIN,d.RenderSlot.OPAQUE_MATERIAL,d.RenderSlot.TRANSPARENT_MATERIAL);this._renderTransparentTerrain()}_renderGeometryExcludedFromSSAO(a){this._renderContext.output=a;this._plugins.render(this._pluginInput,
d.RenderSlot.OPAQUE_NO_SSAO_DEPTH,d.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH)}_prepareOpaqueGeometry(){this._plugins.prepare(...aa,d.RenderSlot.OPAQUE_ENVIRONMENT)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...aa)}_renderTransparentMaterial(){this._plugins.render(this._pluginInput,...R)}_renderTransparentTerrain(){var a=this._renderContext.output;if(this._plugins.produces(a,d.RenderSlot.TRANSPARENT_TERRAIN)){var b=()=>this._plugins.render(this._pluginInput,d.RenderSlot.TRANSPARENT_TERRAIN);
if(a!==k.ShaderOutput.Color)b();else{var {width:c,height:e,depth:g}=this._offscreen;a=this.fboCache.acquire(c,e,"transparent terrain");this._offscreen.renderToTargets(b,a,g,[0,0,0,0]);return a}}}_renderHUDVisibility(){this._plugins.produces(this._renderContext.output,d.RenderSlot.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,()=>this._plugins.render(this._pluginInput,d.RenderSlot.OCCLUSION_PIXELS),this._bindParameters.multipassGeometry.depth),
this._offscreen.bindFbo(),this.performanceInfo.advance(n.PerformanceCategory.HUD_VISIBILITY)):this._bindParameters.hudVisibility=r.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(a){this._bindParameters.hudRenderStyle=a;if(a===y.HUDRenderStyle.Occluded){const {width:b,height:c,color:e}=this._offscreen;a=this.fboCache.acquireDepth(w.DepthFormat.DEPTH16_BUFFER,b,c,"line callouts");this._offscreen.renderToTargets(()=>this._plugins.render(this._pluginInput,d.RenderSlot.LINE_CALLOUTS),
e,a,void 0,!0,!0);a.release()}else this._plugins.render(this._pluginInput,d.RenderSlot.LINE_CALLOUTS)}_renderLaserlines(){if(this.hasLaserlines){this._plugins.render(this._pluginInput,d.RenderSlot.LASERLINES);if(this._plugins.produces(this._renderContext.output,d.RenderSlot.LASERLINES_CONTRAST_CONTROL)){const a=this._offscreen,{width:b,height:c,depth:e}=a,g=this.fboCache.acquire(b,c,"laser lines");a.renderToTargets(()=>this._plugins.render(this._pluginInput,d.RenderSlot.LASERLINES_CONTRAST_CONTROL),
g,e,fa);a.compositeToFramebuffer(this._bindParameters,g.getTexture(),O.AlphaMode.PremultipliedAlpha,1);g.release()}this._pluginInput.release("normals");this.performanceInfo.advance(n.PerformanceCategory.LASER_LINES)}}_renderHUD(a,b){if(this._pluginsHas.hudElements){if(this._oitEnabled){const c=this._renderOITPass(P.HUD,a);this._rctx.bindFramebuffer(b.fbo);this._compositingHelper.composite(this._bindParameters,c.getTexture(),O.AlphaMode.PremultipliedAlpha);c.release()}else if(a===y.HUDRenderStyle.Occluded){this._renderContext.output=
k.ShaderOutput.Color;const {width:c,height:e,color:g}=this._offscreen;b=this.fboCache.acquireDepth(w.DepthFormat.DEPTH16_BUFFER,c,e,"hud");this._offscreen.renderToTargets(()=>this._renderHUDElements(a),g,b,void 0,!0,!0);b.release()}else this._renderContext.output=k.ShaderOutput.Color,b.acquireDepth(w.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(b.fbo),this._renderHUDElements(a),b.detachDepth();this.performanceInfo.advance(a===y.HUDRenderStyle.Occluded?n.PerformanceCategory.HUD_OCCLUDED:
n.PerformanceCategory.HUD)}}_renderHUDElements(a){this._bindParameters.hudRenderStyle=a;this._plugins.prepare(d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,d.RenderSlot.HUD_MATERIAL,d.RenderSlot.LABEL_MATERIAL);this._plugins.render(this._pluginInput,d.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,d.RenderSlot.HUD_MATERIAL,d.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(k.ShaderOutput.ShadowHighlight,d.RenderSlot.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(this.hasHighlights){var a=
this._offscreen.renderToCachedFBO(null,"highlights",()=>{this._renderAllGeometry(k.ShaderOutput.Highlight);this._rctx.clear(K.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(y.HUDRenderStyle.Both)},[0,0,0,0],w.ColorFormat.RGBA4,w.DepthFormat.DEPTH_STENCIL_TEXTURE);a.detachDepth();return a}}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(a,b,c){this._needsShadowCast&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,
a,b,c)&&this.performanceInfo.advance(n.PerformanceCategory.ACCUMULATED_SHADOWS)}_prepareTransparencySlots(){this._renderContext.output=k.ShaderOutput.Color;this._bindParameters.transparencyPassType=D.TransparencyPassType.ColorAlpha;this._plugins.prepare(...R);this._bindParameters.transparencyPassType=D.TransparencyPassType.FrontFace;this._plugins.prepare(...R);this._bindParameters.transparencyPassType=D.TransparencyPassType.NONE;this._techniques.acquire(Ha.OITCompositingTechnique).release()}_renderOITPass(a,
b=y.HUDRenderStyle.Both){var c=a===P.HUD;a=c?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null;const e=c?()=>this._renderHUDElements(b):()=>this._renderTransparentMaterial(),g=this._renderContext.output;this._renderContext.output=k.ShaderOutput.Color;this._bindParameters.transparencyPassType=D.TransparencyPassType.ColorAlpha;const m=this._offscreen.renderOITPass(e,D.TransparencyPassType.ColorAlpha,c);this._bindParameters.transparencyPassType=D.TransparencyPassType.FrontFace;
c=this._offscreen.renderOITPass(e,D.TransparencyPassType.FrontFace,c);this._offscreen.compositeOIT(this._bindParameters,m,c,a);a?.detachDepth();c.release();m.release();this._bindParameters.transparencyPassType=D.TransparencyPassType.NONE;this._renderContext.output=g;return a}_renderOccluded(){let a=0;v.clear();this._plugins.plugins.forAll(h=>{h.materialReference&&h.queryRenderOccludedState(t.RenderOccludedFlag.OccludeAndTransparentStencil)&&(a|=t.RenderOccludedFlag.OccludeAndTransparentStencil,v.push(h))});
const b=this._offscreen,c=(h,p,q,z,l)=>{if(0!==(a&p)){var {width:u,height:L,depth:E}=b;p=this.fboCache.acquire(u,L,"tmp color");b.renderToTargets(q,p,E,[0,0,0,0],z,l);b.compositeToFramebuffer(this._bindParameters,p.getTexture(),O.AlphaMode.PremultipliedAlpha,h);p.release()}},e=(h,p)=>{this._bindParameters.slot=h;p.forAll(q=>{if(va.isPrepareRenderPlugin(q)){const z=q.prepareTechnique(this._renderContext);z&&q.renderNode(this._renderContext,z)}})};0!==v.length&&(e(d.RenderSlot.OCCLUDER_MATERIAL,v),
c(.5,t.RenderOccludedFlag.OccludeAndTransparentStencil,()=>e(d.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,v),!1,!1));const g=0<v.length;v.clear();this._plugins.plugins.forAll(h=>{if(h.materialReference){var p=h.queryRenderOccludedState(t.RenderOccludedFlag.OccludeAndTransparent),q=h.queryRenderOccludedState(t.RenderOccludedFlag.Transparent),z=h.queryRenderOccludedState(t.RenderOccludedFlag.Opaque);if(p||q||z)a|=p?t.RenderOccludedFlag.OccludeAndTransparent:q?t.RenderOccludedFlag.Transparent:t.RenderOccludedFlag.Opaque,
v.push(h)}});const m=this._plugins.renderOccludedFlags;if(a|=m){var f=h=>{this._renderContext.renderOccludedMask=h;m>t.RenderOccludedFlag.Occlude&&this._plugins.render(this._pluginInput,d.RenderSlot.OCCLUDED_TERRAIN);e(d.RenderSlot.OPAQUE_MATERIAL,v);e(d.RenderSlot.TRANSPARENT_MATERIAL,v);e(d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,v);this._renderContext.renderOccludedMask=da.defaultRenderOccludedMask};this._renderContext.output=k.ShaderOutput.Color;c(.5,t.RenderOccludedFlag.OccludeAndTransparent,
()=>f(t.RenderOccludedFlag.OccludeAndTransparent),!0,B.StencilBits.OutlineVisualElementMask);c(.5,t.RenderOccludedFlag.Transparent,()=>f(t.RenderOccludedFlag.Transparent),!0,B.StencilBits.OutlineVisualElementMask);c(1,t.RenderOccludedFlag.Opaque,()=>f(t.RenderOccludedFlag.Opaque),!0,B.StencilBits.OutlineVisualElementMask);(g||0<v.length)&&this.performanceInfo.advance(n.PerformanceCategory.OCCLUDED);v.clear()}}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters);this._offscreen.bindFbo();
this._plugins.render(this._pluginInput,d.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,d.RenderSlot.TRANSPARENT_ENVIRONMENT);this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT_ENVIRONMENT)}_renderViewshed(){this._viewshedEnabled&&(this._viewshed.renderHighQuality=this.isFeatureEnabled(C.RenderFeature.HighResolutionViewshed),this._plugins.render(this._pluginInput,d.RenderSlot.VIEWSHED),this._pluginInput.release("normals"),this.performanceInfo.advance(n.PerformanceCategory.VIEWSHED))}_renderPlugins(a,
b){this._plugins.produces(this._renderContext.output,a)&&(this._plugins.render(this._pluginInput,a),this.performanceInfo.advance(b))}_renderNodes(a,b,c=!1){if(!this._nodes.produces(a))return c&&this.performanceInfo.advance(a),b;b.setName(a);this._pluginInput.set(a,b);b=this._nodes.render(b,this._pluginInput,this._releaseNormals);this.performanceInfo.advance(a);return b}_blitToDefault(a,b=Y.defaultWebGLFBO,c=!0){this._blit||(this._blit=new xa.Blit(this._techniques));b=this._blit.render(this._rctx,
a,b,this._bindParameters,this._requestRender);this._pluginInput.set(a.name,b);c&&a.release();return b}_ensureBindParametersCamera(a,b){this._bindParameters.camera=a;this._bindParameters.contentCamera=b}_ensureBindParametersSSR(a){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=I.IDENTITY:(H.invert(ha,this._bindParameters.camera.viewMatrix),H.invert(ia,this._bindParameters.camera.projectionMatrix),
H.multiply(M,ha,ia),H.multiply(M,this._renderContext.lastFrameCamera.viewMatrix,M),H.multiply(M,this._renderContext.lastFrameCamera.projectionMatrix,M),this._reprojectionMatrix=M);const b=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<b?Math.min(b,a-this._ssrEnableTime)/b:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._reprojectionMatrix=I.IDENTITY,this._ssrEnableTime=null}addRenderNode(a){this._nodes.add(a);this._requestRender()}removeRenderNode(a){this._nodes.remove(a);
this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get _viewshedEnabled(){return this._viewshed.enabled&&this._plugins.produces(this._renderContext.output,d.RenderSlot.VIEWSHED)}get test(){}}T.__decorate([W.property({readOnly:!0})],Q.prototype,"fullResolutionAtmosphere",null);T.__decorate([W.property()],Q.prototype,"_edgeView",void 0);T.__decorate([W.property()],Q.prototype,"updating",null);var P;(function(a){a[a.Geometry=
0]="Geometry";a[a.HUD=1]="HUD"})(P||={});N.FramebufferId=void 0;(function(a){a[a.Color=0]="Color";a[a.LinearDepth=1]="LinearDepth";a[a.ShadowMap=2]="ShadowMap";a[a.HudVisibility=3]="HudVisibility";a[a.ViewshedShadowMap=4]="ViewshedShadowMap"})(N.FramebufferId||(N.FramebufferId={}));const fa=[0,0,0,0],aa=[d.RenderSlot.INTEGRATED_MESH,d.RenderSlot.OPAQUE_TERRAIN,d.RenderSlot.OPAQUE_MATERIAL,d.RenderSlot.OPAQUE_NO_SSAO_DEPTH],R=[d.RenderSlot.TRANSPARENT_MATERIAL,d.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH],
v=new na,ia=I.create(),ha=I.create(),M=I.create();N.Renderer=Q;Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/mathUtils","../../support/debugFlags","./FontMetrics","./TextHelperCanvas"],function(m,x,p,y,q){class z{constructor(a,c,b,d){this.text=a;this._alignment=c;this._parameters=b;this._maxSize=d;this._textWidths=[];this._lineWidths=[];this._metricsCached=this._renderPixelRatio=null;this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${a}`;this._lines=a.replaceAll(" ","\u00a0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let a=
this._metrics.firstLineAscent;for(let c=0;c<this._lines.length-1;c++)a+=this._lineSpacing;a+=this._metrics.lastLineDescent;return Math.ceil(a+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==
this._metricsCached){const c=q.getTextHelperCanvas(r,512,512).getContext("2d"),b=this._parameters.definition.pixelRatio;this._parameters.setFontProperties(c,this._fontSize*b);let d=2*this._haloSize;var a=this._parameters.definition.font;if("italic"===a.style||"oblique"===a.style||"bold"===a.weight||"bolder"===a.weight)d+=.3*c.measureText("A").width;this._textWidths.length=0;let e=this._lineWidths.length=0,f=0,g=0,h=0,k=0;this._lines.forEach((n,t)=>{n=c.measureText(n);const u=n.width/b,v=u+d;this._textWidths.push(u);
this._lineWidths.push(v);e=Math.max(e,v);h=Math.max(h,n.actualBoundingBoxAscent/b);k=Math.max(k,n.actualBoundingBoxDescent/b);0===t&&(f=n.actualBoundingBoxAscent/b);t===this._lines.length-1&&(g=n.actualBoundingBoxDescent/b)});a=y.getFontMetrics(this._parameters);const l=Math.max(k,a.maxDescent);this._metricsCached=new A(f,"underline"===this._parameters.definition.font.decoration?l:g,Math.max(h,a.maxAscent),l,e)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*
this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return.2*this._midLineHeight}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:
0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){null==this._renderPixelRatio&&(this._renderPixelRatio=Math.min(this._parameters.definition.pixelRatio,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight)));return this._renderPixelRatio}_getLineXOffset(a){switch(this._alignment){case m.TextRenderAlignment.Left:return this._horizontalPadding;
case m.TextRenderAlignment.Center:return(this.displayWidth-this._lineWidths[a])/2;case m.TextRenderAlignment.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[a]}}render(a,c,b){a.save();c/=this.renderPixelRatio;b/=this.renderPixelRatio;const d=c,e=b;var f=this._haloSize;const g=this._firstLineYOffset+this._metrics.firstLineAscent;c+=f;b+=g;const h=0<this._haloSize;h&&this._renderHalo(a,d,e,f,g);this._parameters.setFontProperties(a,this._renderedFontSize);for(f=0;f<this._lines.length;++f){const k=
this._lines[f],l=this._getLineXOffset(f);h&&(a.globalCompositeOperation="destination-out",a.fillStyle="rgb(0, 0, 0)",this._fillText(a,k,c+l,b),this._renderLineDecoration(a,c+l,b,this._textWidths[f]));a.globalCompositeOperation="source-over";a.fillStyle=this._parameters.textStyle;this._fillText(a,k,c+this._getLineXOffset(f),b);this._renderLineDecoration(a,c+l,b,this._textWidths[f]);b+=this._lineSpacing}if(p.debugFlags.TEXT_SHOW_BASELINE)for(a.strokeStyle="rgb(255, 0, 255, 0.5)",a.setLineDash([2,2]),
a.lineWidth=1,c=e+g,b=0;b<this._lines.length;++b)this._drawLine(a,[d,c],[d+this.displayWidth,c]),c+=this._lineSpacing;p.debugFlags.TEXT_SHOW_BORDER&&(a.strokeStyle="rgb(255, 0, 255, 0.5)",a.setLineDash([]),a.lineWidth=1,this._drawBox(a,[d,e],[this.displayWidth,this.displayHeight]));this._hasBackground&&(this._roundedRect(a,d,e,this._parameters.definition.background.borderRadius*this.renderPixelRatio),a.globalCompositeOperation="destination-over",a.fillStyle=this._parameters.backgroundStyle,a.fill());
a.restore()}_renderLineDecoration(a,c,b,d,e=!1){if("none"!==this._parameters.definition.font.decoration&&0!==d){var f=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case "underline":b+=2*f;break;case "line-through":b-=.33*this._midLineAscent}var g=e?this._haloSize:0;a.strokeStyle=e?this._parameters.haloStyle:this._parameters.textStyle;a.lineWidth=this._toRenderUnit(f+2*g);a.beginPath();a.moveTo(this._toRenderUnit(c-g),this._toRenderUnit(b));a.lineTo(this._toRenderUnit(c+
d+g),this._toRenderUnit(b));a.stroke()}}_roundedRect(a,c,b,d){c=this._toRenderUnit(c);b=this._toRenderUnit(b);const e=this.renderedWidth,f=this.renderedHeight;0===d?a.rect(c,b,e,f):(d=x.clamp(d,0,Math.floor(f/2)),a.beginPath(),a.moveTo(c,b+d),a.arcTo(c,b,c+d,b,d),a.lineTo(c+e-d,b),a.arcTo(c+e,b,c+e,b+d,d),a.lineTo(c+e,b+f-d),a.arcTo(c+e,b+f,c+e-d,b+f,d),a.lineTo(c+d,b+f),a.arcTo(c,b+f,c,b+f-d,d),a.closePath())}_renderHalo(a,c,b,d,e){const f=this.renderedWidth,g=this.renderedHeight,h=q.getTextHelperCanvas(r,
Math.max(f,512),Math.max(g,512)),k=h.getContext("2d");k.clearRect(0,0,f,g);this._parameters.setFontProperties(k,this._renderedFontSize);k.fillStyle=this._parameters.haloStyle;k.strokeStyle=this._parameters.haloStyle;var l=3>this._renderedHaloSize;k.lineJoin=l?"miter":"round";l?this._renderHaloEmulated(k,d,e):this._renderHaloNative(k,d,e);for(l=0;l<this._lines.length;++l){const n=this._getLineXOffset(l);this._renderLineDecoration(k,d+n,e,this._textWidths[l],!0);e+=this._lineSpacing}a.globalAlpha=this._parameters.definition.halo.color[3];
a.drawImage(h,0,0,f,g,this._toRenderUnit(c),this._toRenderUnit(b),f,g);a.globalAlpha=1}_renderHaloEmulated(a,c,b){for(let d=0;d<this._lines.length;++d){const e=this._lines[d],f=this._getLineXOffset(d);for(const [g,h]of w)this._fillText(a,e,c+f+this._haloSize*g,b+this._haloSize*h);b+=this._lineSpacing}}_renderHaloNative(a,c,b){const d=2*this._haloSize;for(let e=0;e<this._lines.length;++e){const f=this._lines[e],g=this._getLineXOffset(e);for(let h=0;5>h;h++)a.lineWidth=this._toRenderUnit((.6+.1*h)*
d),this._strokeText(a,f,c+g,b);b+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(a){return a*this.renderPixelRatio}_toRoundedRenderUnit(a){return Math.round(a*this.renderPixelRatio)}_fillText(a,c,b,d){a.fillText(c,this._toRenderUnit(b),this._toRenderUnit(d))}_strokeText(a,c,b,d){a.strokeText(c,this._toRenderUnit(b),this._toRenderUnit(d))}_drawLine(a,c,b){a.beginPath();a.moveTo(this._toRoundedRenderUnit(c[0])+.5,this._toRoundedRenderUnit(c[1])+.5);a.lineTo(this._toRoundedRenderUnit(b[0])+
.5,this._toRoundedRenderUnit(b[1])+.5);a.stroke()}_drawBox(a,c,b){var d=this._toRenderUnit(c[0]);c=this._toRenderUnit(c[1]);var e=this._toRenderUnit(b[0]);const f=this._toRenderUnit(b[1]);b=Math.floor(d)+.5;d=Math.ceil(d+e)-.5;e=Math.floor(c)+.5;c=Math.ceil(c+f)-.5;a.beginPath();a.moveTo(b,e);a.lineTo(d,e);a.lineTo(d,c);a.lineTo(b,c);a.lineTo(b,e);a.stroke()}}const w=[];for(let a=0;360>a;a+=22.5)w.push([Math.cos(Math.PI*a/180),Math.sin(Math.PI*a/180)]);m.TextRenderAlignment=void 0;(function(a){a[a.Left=
0]="Left";a[a.Center=1]="Center";a[a.Right=2]="Right"})(m.TextRenderAlignment||(m.TextRenderAlignment={}));const r={canvas:null};class A{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(a,c,b,d,e){this.firstLineAscent=a;this.lastLineDescent=c;this.maxLineAscent=b;this.maxLineDescent=d;this.displayWidth=e}}m.TextRenderer=z;m.textVerticalPaddingPx=
1;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
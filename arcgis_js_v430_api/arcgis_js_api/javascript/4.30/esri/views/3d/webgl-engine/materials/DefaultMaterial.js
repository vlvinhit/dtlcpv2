// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../ViewingMode ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/attributes/NormalAttribute.glsl ../core/shaderLibrary/shading/Normals.glsl ../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../lib/basicInterfaces ../lib/GLTextureMaterial ../lib/Material ../lib/OrderIndependentTransparency ../lib/RayIntersections ../lib/RenderSlot ../lib/VertexAttribute ../lib/verticalOffsetUtils ./DefaultBufferWriter ./internal/MaterialUtil ../shaders/DefaultMaterialTechnique ../shaders/DefaultMaterialTechniqueConfiguration ../shaders/RealisticTreeTechnique".split(" "),
function(p,E,c,h,w,F,e,G,q,r,H,I,J,K,L,t,g,M,N,O,x,P,Q){function R(a){const b=F.newLayout().vec3f(g.VertexAttribute.POSITION);a.normalType===G.NormalType.Compressed?b.vec2i16(g.VertexAttribute.NORMALCOMPRESSED,{glNormalized:!0}):b.vec3f(g.VertexAttribute.NORMAL);a.hasVertexTangents&&b.vec4f(g.VertexAttribute.TANGENT);(a.textureId||a.normalTextureId||a.metallicRoughnessTextureId||a.emissiveTextureId||a.occlusionTextureId)&&b.vec2f(g.VertexAttribute.UV0);a.hasVertexColors&&b.vec4u8(g.VertexAttribute.COLOR);
a.hasSymbolColors&&b.vec4u8(g.VertexAttribute.SYMBOLCOLOR);E("enable-feature:objectAndLayerId-rendering")&&b.vec4u8(g.VertexAttribute.OBJECTANDLAYERIDCOLOR);return b}class S extends J.Material{constructor(a){super(a,T);this.supportsEdges=!0;this.produces=new Map([[t.RenderSlot.OPAQUE_MATERIAL,b=>(e.is3DGeometryOutput(b)||e.isShadowRelatedOutput(b))&&!this.parameters.transparent],[t.RenderSlot.TRANSPARENT_MATERIAL,b=>(e.is3DGeometryOutput(b)||e.isShadowRelatedOutput(b))&&this.parameters.transparent&&
this.parameters.writeDepth],[t.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,b=>(e.is3DGeometryOutput(b)||e.isShadowRelatedOutput(b))&&this.parameters.transparent&&!this.parameters.writeDepth]]);this._configuration=new P.DefaultMaterialTechniqueConfiguration;this._vertexBufferLayout=R(this.parameters)}isVisibleForOutput(a){return a===e.ShaderOutput.Shadow||a===e.ShaderOutput.ShadowExcludeHighlight||a===e.ShaderOutput.ShadowHighlight?this.parameters.castShadows:!0}isVisible(){var a=this.parameters;
if(!super.isVisible()||0===a.layerOpacity)return!1;const {hasInstancedColor:b,hasVertexColors:d,hasSymbolColors:l,vvColor:m}=a,k="replace"===a.colorMixMode,f=0<a.opacity;a=a.externalColor&&0<a.externalColor[3];const n=b||m||l;return d&&n?k||f:d?k?a:f:n?k||f:k?a:f}getConfiguration(a,b){this._configuration.output=a;this._configuration.hasNormalTexture=!!this.parameters.normalTextureId;this._configuration.hasColorTexture=!!this.parameters.textureId;this._configuration.hasVertexTangents=this.parameters.hasVertexTangents;
this._configuration.instanced=this.parameters.isInstanced;this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision;this._configuration.vvSize=!!this.parameters.vvSize;this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset;this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight;this._configuration.alphaDiscardMode=
this.parameters.textureAlphaMode;this._configuration.normalType=this.parameters.normalType;this._configuration.transparent=this.parameters.transparent;this._configuration.writeDepth=this.parameters.writeDepth;null!=this.parameters.customDepthTest&&(this._configuration.customDepthTest=this.parameters.customDepthTest);this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.cullFace=this.parameters.hasSlicePlane?H.CullFaceOptions.None:this.parameters.cullFace;this._configuration.multipassEnabled=
b.multipassEnabled;this._configuration.cullAboveGround=b.multipassTerrain.cullAboveGround;this._configuration.hasModelTransformation=null!=this.parameters.modelTransformation;a===e.ShaderOutput.Color&&(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this._configuration.doubleSidedMode=this.parameters.treeRendering?q.NormalsDoubleSidedMode.WindingOrder:this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?
q.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?q.NormalsDoubleSidedMode.WindingOrder:q.NormalsDoubleSidedMode.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=this.parameters.receiveAmbientOcclusion&&null!=b.ssao,this._configuration.vvColor=!!this.parameters.vvColor,
this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?r.PBRMode.Schematic:r.PBRMode.Normal:r.PBRMode.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=
!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=b.transparencyPassType,this._configuration.enableOffset=b.camera.relativeElevation<K.OITPolygonOffsetLimit,this._configuration.snowCover=this.hasSnowCover(b),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=
!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix);return this._configuration}hasSnowCover(a){return null!=a.weather&&a.weatherVisible&&"snowy"===a.weather.type&&"enabled"===a.weather.snowCover}intersect(a,b,d,l,m,k){if(null!=this.parameters.verticalOffset){const n=d.camera;c.set(u,b[12],
b[13],b[14]);b=null;switch(d.viewingMode){case w.ViewingMode.Global:b=c.normalize(y,u);break;case w.ViewingMode.Local:b=c.copy(y,U)}let z=0;var f=c.subtract(V,u,n.eye);const A=c.length(f);f=c.scale(f,f,1/A);let B=null;this.parameters.screenSizePerspective&&(B=c.dot(b,f));z+=O.verticalOffsetAtDistance(n,A,this.parameters.verticalOffset,B??0,this.parameters.screenSizePerspective);c.scale(b,b,z);c.transformMat3(v,b,d.transform.inverseRotation);l=c.subtract(W,l,v);m=c.subtract(X,m,v)}L.intersectTriangleGeometry(a,
d,l,m,M.getVerticalOffsetObject3D(d.verticalOffset),k)}createGLMaterial(a){return new C(a)}createBufferWriter(){return new N.DefaultBufferWriter(this._vertexBufferLayout)}}class C extends I.GLTextureMaterial{constructor(a){super({...a,...a.material.parameters})}_updateShadowState(a){a.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:a.shadowMap.enabled})}_updateOccludeeState(a){a.hasOccludees!==this._material.parameters.hasOccludees&&
this._material.setParameters({hasOccludees:a.hasOccludees})}beginSlot(a){this._output===e.ShaderOutput.Color&&(this._updateShadowState(a),this._updateOccludeeState(a));const b=this._material.parameters;this.updateTexture(b.textureId);const d=a.camera.viewInverseTransposeMatrix;c.set(b.origin,d[3],d[7],d[11]);this._material.setParameters(this.textureBindParameters);return this.ensureTechnique(b.treeRendering?Q.RealisticTreeTechnique:x.DefaultMaterialTechnique,a)}}class D extends x.DefaultMaterialPassParameters{constructor(){super(...arguments);
this.hasVertexTangents=this.treeRendering=this.initTextureTransparent=!1}}const T=new D,W=h.create(),X=h.create(),U=h.fromValues(0,0,1),y=h.create(),v=h.create(),u=h.create(),V=h.create();p.DefaultGLMaterial=C;p.DefaultMaterial=S;p.DefaultMaterialParameters=D;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
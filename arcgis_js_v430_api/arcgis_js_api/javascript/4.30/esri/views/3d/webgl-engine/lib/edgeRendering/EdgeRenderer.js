// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f32 ../../../../../chunks/vec32 ../../../support/debugFlags ../../core/util/TwoVectorPosition ./EdgeShaderParameters ./EdgeShaderTechnique ./EdgeShaderTechniqueConfiguration ./interfaces ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/enums".split(" "),function(h,p,k,l,q,r,t,u,v,w,x,c,y,z){const A={type:y.EdgeType.Solid,
hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0};class m{constructor(b,a,d){this._rctx=b;this._techniques=a;this._configuration=new x.EdgeShaderTechniqueConfiguration;this.refCount=0;this._renderables=new Set;this._sortedRenderables={[c.Transparency.TRANSPARENT]:{[c.Transparency.TRANSPARENT]:new k,[c.Transparency.OPAQUE]:new k},[c.Transparency.OPAQUE]:{[c.Transparency.TRANSPARENT]:new k,[c.Transparency.OPAQUE]:new k}};this._renderablesDirty=!1;this._drawParameters=new v.EdgeDrawParameters;
this._settings={...A,...d};this.key=m.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);this.writerSettings={variants:this._settings.strokesTexture.variants,reducedPrecision:t.debugFlags.TESTS_DISABLE_OPTIMIZATIONS};this._configuration.legacy=this._settings.legacy;this._configuration.type=this._settings.type;this._configuration.silhouette=!1;this._configuration.hasSlicePlane=this._settings.hasSlicePlane;this._configuration.doublePrecisionRequiresObfuscation=b.driverTest.doublePrecisionRequiresObfuscation.result;
this._configuration.spherical=d.spherical}dispose(){this._technique=p.releaseMaybe(this._technique)}addRenderable(b){this._renderables.add(b);this._renderablesDirty=!0}removeRenderable(b){this._renderables.delete(b);this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(b,a){this._renderablesDirty&&this._sortRenderables();a=this._sortedRenderables[a];a[c.Transparency.TRANSPARENT].forAll(b);a[c.Transparency.OPAQUE].forAll(b)}updateTechnique(b,a){this._configuration.multipassEnabled=
!!b.multipassEnabled;this._configuration.cullAboveGround=!!b.multipassTerrain.cullAboveGround;this._configuration.silhouette=a;return this._technique=this._techniques.releaseAndAcquire(w.EdgeShaderTechnique,this._configuration,this._technique)}bindRegularEdges(b,a){this._lastOriginId=null;return this._rctx.bindTechnique(this.updateTechnique(a,!1),a,b)}bindSilhouetteEdges(b,a){this._lastOriginId=null;return this._rctx.bindTechnique(this.updateTechnique(a,!0),a,b)}renderRegularEdges(b,a,d,f,e){this._render(b,
a,a.regular.vao,d,f,e)}renderSilhouetteEdges(b,a,d,f,e){this._render(b,a,a.silhouette.vao,d,f,e)}_render(b,a,d,f,e,g){0<g&&(this._bindDraw(b,a,f,e),this._rctx.bindVAO(d),this._rctx.drawArraysInstanced(z.PrimitiveType.TRIANGLE_FAN,0,4,g))}_bindDraw(b,a,d,f){this._drawParameters.componentDataTexture=a.components.buffer.textureBuffer.texture;this._drawParameters.strokesTexture=this._settings.strokesTexture;var e=a.transform.origin;if(e){var g=e.origin.id;this._lastOriginId!==g&&(b.setUniformMatrix4fv("localView",
e.viewMatrix),this._lastOriginId=g);b.setUniformMatrix4fv("model",a.transform.modelMatrix);this._drawParameters.slicePlaneLocalOrigin=e.origin.vec3}else e=new u.TwoVectorPosition(a.transform.position),g=l.transpose(n,l.invert(n,a.transform.rotationScale)),this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=a.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=g,a=f.camera.viewInverseTransposeMatrix,
r.set(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11]);b.bindDraw(this._drawParameters,f,d)}_sortRenderables(){this._renderablesDirty=!1;this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.TRANSPARENT].clear();this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.OPAQUE].clear();this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.TRANSPARENT].clear();this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.OPAQUE].clear();this._renderables.forEach(a=>
{a.objectTransparency!==c.Transparency.INVISIBLE&&a.edgeTransparency!==c.Transparency.INVISIBLE&&this._sortedRenderables[a.objectTransparency][a.edgeTransparency].push(a)});const b=(a,d)=>a.transform.origin?d.transform.origin?a.transform.origin.origin.id<d.transform.origin.origin.id?-1:a.transform.origin.origin.id>d.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.TRANSPARENT].sort(b);this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.OPAQUE].sort(b);
this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.TRANSPARENT].sort(b);this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.OPAQUE].sort(b)}static getKey(b,a,d){return`edges-t:${b}:${a}:${d}`}}const n=q.create();h.EdgeRenderer=m;h.extensionLengthOffset=128;h.lineWidthFractionFactor=8;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../core/support/UpdatingHandles ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../Attribute ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(p,t,X,K,Ba,Y,L,M,N,u,Z,G,aa,H,x,C,ba,O,ca,da,ea,fa,ha,ia,ja,ka,la,ma,I,y,P,w,na,oa,Ca,pa,v,qa,z,Q,R){function S(a){a?.vao&&(a.vao.vertexBuffers.instances.dispose(),a.vao.disposeVAOOnly(),a.vao=null)}function ra(a){let b=null,c=null;for(const d of a.geometries)if(d.material.supportsEdges){if(!b)b=d.transformation;else if(!K.equals(b,d.transformation))return!1;if(!c&&null!=d.localOrigin)c=d;else if(null!=c?.localOrigin&&null!=d.localOrigin&&c.localOrigin.id!==d.localOrigin.id)return!1}return!0}
function J(a){const {meta:b,buffer:c}=a;a=new Uint8Array(4);for(let d=0;d<b.length;d++){const f=b[d].material,e=b[d].index,g=L.clamp(Math.round(f.size*w.lineWidthFractionFactor),0,255),h=L.clamp(f.extensionLength,-w.extensionLengthOffset,255-w.extensionLengthOffset)+w.extensionLengthOffset,k=255*f.opacity,l=f.color;c.textureBuffer.setData(e,0,255*l[0],255*l[1],255*l[2],255*l[3]);c.textureBuffer.setData(e,1,g,h,f.type,k);ea.encodeElevationOffset(b[d].verticalOffset,a);c.textureBuffer.setData(e,2,a[0],
a[1],a[2],a[3])}}function sa(a,b,c){const d=a.bindRegularEdges(c,b),f=b.camera.perScreenPixelRatio;a.forEachRenderable(e=>{if(null!=e.regular&&e.visible){var g=T(e.regular.lod.lengths,e.distanceToCamera,f);a.renderRegularEdges(d,e,c,b,g)}},c.transparency)}function ta(a,b,c){const d=a.bindSilhouetteEdges(c,b),f=b.camera.perScreenPixelRatio;a.forEachRenderable(e=>{if(null!=e.silhouette&&e.visible){var g=T(e.silhouette.lod.lengths,e.distanceToCamera,f);a.renderSilhouetteEdges(d,e,c,b,g)}},c.transparency)}
function T(a,b,c){b*=c;c=K.binaryIndexOf(a,b,!0);return-1===c?b<a[0]?a.length:0:a.length-c}p.EdgeView=class extends X{constructor(a){super(a);this._updatingHandles=new ba.UpdatingHandles;this._objectEntries=new Map;this._pendingDeletions=new Map;this._renderers=new Map;this._gpuMemoryUsage=0;this._workerAbort=new AbortController;this._tmpModelPosition=C.create();this._localOrigins=new ka.LocalOriginManager(new ia.GridLocalOriginFactory(a.renderSR));const b=y.VertexLayout.createBuffer(4);for(let c=
0;4>c;c++)b.sideness.set(c,0,0===c||3===c?0:1),b.sideness.set(c,1,0===c||1===c?0:1);this._verticesBufferObject=Q.BufferObject.createVertex(a.rctx,R.Usage.STATIC_DRAW,b.buffer)}initialize(){this._worker=new oa.EdgeWorkerHandle(this.schedule);this._componentColorManager=new qa.BufferManager(this.rctx,3)}destroy(){this.destroyed||(this._objectEntries.forEach(a=>this._discardObjectEntry(a)),this._objectEntries.clear(),this._pendingDeletions.forEach(a=>this._discardObjectEntry(a)),this._pendingDeletions.clear(),
this._strokesTexture=M.disposeMaybe(this._strokesTexture),this._componentColorManager=M.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject.dispose(),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",ua))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return 0<this._renderers.size}async addComponentObject(a,b,c,d,f,e,g){if(this.hasObject(a))return this._getObjectMemoryUsage(a);
let h;const k=new U(null,new Promise(l=>h=l),a.obb.center,a.obb.radius);this._objectEntries.set(a,k);a=await this._updatingHandles.addPromise(this._addComponentGeometry(a.transform,k,b,c,d,f,e,g));this.setNeedsRender();h();return a}async addOrUpdateObject3D(a,b,c,d){if(this.destroyed)Y.getLogger(this).warn("Attempt to add an object to a destroyed instance");else{var f=new AbortController,e,g=a.boundingVolumeWorldSpace.bounds;f=new U(f,new Promise(h=>e=h),O.getCenter(g),O.getRadius(g));(g=this._objectEntries.get(a))&&
(this._pendingDeletions.has(a)?this._discardObjectEntry(g):this._pendingDeletions.set(a,g));this._objectEntries.set(a,f);try{g=[];if(c.mergeGeometries&&1<a.geometries.length&&ra(a))g.push(this._addObjectMergedGeometries(a,f,b,c,d));else for(const h of a.geometries)h.material.supportsEdges&&g.push(this._addGeometry(a,f,h,b[0],c,d));await this._updatingHandles.addPromise(Promise.all(g));this._removePendingDeletion(a)}catch(h){N.isAbortError(h)?this._discardObjectEntry(f):this._removePendingDeletion(a)}finally{this.setNeedsRender(),
e()}}}removeObject(a){const b=this._objectEntries.get(a);this._objectEntries.delete(a);this._discardObjectEntry(b);this._removePendingDeletion(a)}_removePendingDeletion(a){const b=this._pendingDeletions.get(a);this._pendingDeletions.delete(a);this._discardObjectEntry(b)}async _getObjectEntry(a){a=this._objectEntries.get(a);if(!a)throw Error("no object");await a.loaded;return null==a.loaded?null:a}fastUpdateObject3DEdgesTransform(a){if(this.destroyed)return!1;var b=this._objectEntries.get(a);if(!b)return!1;
var {geometries:c}=a;({renderables:b}=b);if(0===c.length||0===b.length)return!0;if(1<b.length)return!1;[b]=b;var d=b.transform;if(!(d instanceof D))return!1;[c]=c;if(c.localOrigin!==d.origin.origin)return!1;d=H.create();a=this._computeModelTransformWithLocalOrigin(a,c,d);b.transform=new D(d,a);this.setNeedsRender();return!0}_discardObjectEntry(a){a&&(a.abort?.abort(),a.renderables.length&&(a.renderables.forEach(b=>this._removeRenderable(b)),this.setNeedsRender()),a.loaded=null)}hasObject(a){return this._objectEntries.has(a)}async updateAllComponentOpacities(a,
b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));if(null!=a){var c=Array.isArray(b)?d=>b[d]:()=>b;a.renderables.forEach(d=>{const f=d.components.meta.length;for(let e=0;e<f;e++){const g=c(e),h=d.components.meta[e],k=h.index;h.material.opacity=g;d.components.buffer.textureBuffer.setDataElement(k,1,3,255*g)}this._updateTransparency(d)});this.setNeedsRender()}}async _getObjectMemoryUsage(a){return(a=await this._getObjectEntry(a))?a.renderables.reduce((b,c)=>b+c.statistics.gpuMemoryUsage,
0):0}async updateAllComponentMaterials(a,b,c,d){const f=a instanceof la.Object3D,e=!!c.hasSlicePlane,g=v.determineRendererType(b),h=w.EdgeRenderer.getKey(g,e,f);a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(k=>{if(h!==k.rendererKey){var l=this._renderers.get(k.rendererKey);const m=this._acquireRenderer(g,e,f);l.removeRenderable(k);--l.refCount;k.rendererKey=h;m.addRenderable(k)}for(l=0;l<b.length;l++)k.components.meta[l].material=b[l];d&&J(k.components);
this._updateTransparency(k)}),this.setNeedsRender())}async updateAllVerticalOffsets(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&this._updateAllVerticalOffsets(a,b)}_updateAllVerticalOffsets(a,b){a.renderables.forEach(c=>{const d=c.components.meta;for(let f=0;f<d.length;f++)c.components.meta[f].verticalOffset=b?.[f]??0;J(c.components)});this.setNeedsRender()}async updateObjectVisibility(a,b){if(a=await this._updatingHandles.addPromise(this._getObjectEntry(a)))a.renderables.forEach(c=>
c.visible=b),this.setNeedsRender()}render(a,b){if(null!=this._componentColorManager){this._localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,d=C.create(),f=new fa.TwoVectorPosition,e=0,g=0;this._renderers.forEach(k=>{if(0===k.refCount)this._renderers.delete(k.key),k.dispose();else{var l=!0,m=!0;k.forEachRenderable(n=>{n.visible&&(e+=n.statistics.averageEdgeLength,g++,l&&n.regular&&(k.updateTechnique(a,!1),l=!1),m&&n.silhouette&&(k.updateTechnique(a,!0),
m=!1))},b)}});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==g){var h=new na.EdgePassParameters(40*e/g,b);x.set(d,c[3],c[7],c[11]);f.set(d);x.copy(h.transformWorldFromViewTH,f.high);x.copy(h.transformWorldFromViewTL,f.low);G.fromMat4(h.transformViewFromCameraRelativeRS,a.camera.viewMatrix);G.transpose(V,h.transformViewFromCameraRelativeRS);G.invert(h.transformNormalViewFromGlobal,V);h.transformProjFromView=a.camera.projectionMatrix;this._updateObjectCameraDistances(a);
this._renderers.forEach(k=>{sa(k,a,h);ta(k,a,h)})}}}_updateTransparency(a){const b=v.determineEdgeTransparency(a.components.meta),c=v.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=c,this._renderers.get(a.rendererKey).setRenderablesDirty()}_computeModelTransformWithLocalOrigin(a,b,c){a.getCombinedShaderTransformation(b,c);a=null!=b.localOrigin?this._localOrigins.register(b.localOrigin):this._localOrigins.acquire(x.set(this._tmpModelPosition,
c[12],c[13],c[14]));b.localOrigin=a.origin;ja.applyToModelMatrix(a.origin.vec3,c);return a}_createComponentBuffers(a){if(null==this._componentColorManager)return null;const b=[],c=this._componentColorManager.getBuffer(a.length);for(let d=0;d<a.length;d++){const f=a[d],e=c.acquireIndex();b.push({index:e,verticalOffset:0,material:f})}a=new va(c,b);J(a);return a}_extractEdges(a,b,c,d,f,e,g=e.length){128>g&&(f=!0);return this._worker.process({data:c,indices:e,indicesLength:g,writerSettings:b,skipDeduplicate:d},
a,f)}_createRenderable(a,b,c,d,f){var e=h=>new wa(new ma.VertexArrayObject(this.rctx,y.EdgeShaderAttributeLocations,{vertices:y.glVertexLayout,instances:h===z.EdgeSilhouette.REGULAR?P.RegularEdgeBufferWriter.glLayout:P.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:Q.BufferObject.createVertex(this.rctx,R.Usage.STATIC_DRAW,h===z.EdgeSilhouette.REGULAR?a.regular.instancesData.buffer:a.silhouette.instancesData.buffer)}),h===z.EdgeSilhouette.REGULAR?a.regular.lodInfo:
a.silhouette.lodInfo);const g=0<a.regular.lodInfo.lengths.length?e(z.EdgeSilhouette.REGULAR):null;e=0<a.silhouette.lodInfo.lengths.length?e(z.EdgeSilhouette.SILHOUETTE):null;return new E(g,e,{gpuMemoryUsage:(g?.vao.usedMemory??0)+(e?.vao.usedMemory??0),externalMemoryUsage:f,averageEdgeLength:a.averageEdgeLength},c,v.determineEdgeTransparency(b.meta),v.determineObjectTransparency(b.meta),b,d)}async _addGeometry(a,b,c,d,f,e){if(!(0>=c.edgeIndicesLength)){var g=c.attributes.get(I.VertexAttribute.POSITION),
h=H.create();a=this._computeModelTransformWithLocalOrigin(a,c,h);g=new W(g,h,a);return this._addPositionData(b,g,c.edgeIndicesLength,d,f,e)}}async _addPositionData(a,b,c,d,f,e=!1){if(null!=a.loaded){var g=this._createComponentBuffers([d]);if(null!=g){d=this._acquireRenderer(d.type,!!f.hasSlicePlane,!0);var {modelTransform:h,origin:k}=b;f=b.position.indices;b=b.position;var l=b.data.length/b.size,m=y.EdgeInputBufferLayout.createBuffer(l);for(let n=0;n<l;n++)m.position.set(n,0,b.data[n*b.size]),m.position.set(n,
1,b.data[n*b.size+1]),m.position.set(n,2,b.data[n*b.size+2]);v.fillComponentBufferIndices(g.meta,[0,m.componentIndex.count],m.componentIndex);c=await this._updatingHandles.addPromise(this._extractEdges(a.abort?.signal||this._workerAbort.signal,d.writerSettings,m,!1,e,f,c));null!=a.loaded&&(g=this._createRenderable(c,g,new D(h,k),d.key,!1),a.renderables.push(g),d.addRenderable(g),this._gpuMemoryUsage+=g.statistics.gpuMemoryUsage)}}}async _addComponentGeometry(a,b,c,d,f,e,g,h){if(null==b.loaded)return 0;
const k=this._createComponentBuffers(e);if(null==k)return 0;e=v.determineRendererType(e);g=this._acquireRenderer(e,g.hasSlicePlane||!1,!1);e=y.EdgeInputBufferLayout.createBuffer(c.length/3);ca.copy(e.position.typedBuffer,c,e.position.typedBufferStride,3);v.fillComponentBufferIndices(k.meta,f,e.componentIndex,d);c=await this._updatingHandles.addPromise(this._extractEdges(this._workerAbort.signal,g.writerSettings,e,!0,!1,d));if(null==b.loaded)return 0;a=this._createRenderable(c,k,a,g.key,!0);b.renderables.push(a);
g.addRenderable(a);this._updateAllVerticalOffsets(b,h);return a.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(a,b,c,d,f){const e=new Map;let g=0,h=0,k=null;var l=a.geometries.filter(r=>{if(0>=r.edgeIndicesLength||!r.material.supportsEdges)return!1;!k&&r.localOrigin&&(k=r);const q=r.attributes.get(I.VertexAttribute.POSITION);h+=q.data.length/q.size;g+=r.edgeIndicesLength;return!0});if(0!==l.length){var m=65536<=h?Uint32Array:Uint16Array,n=g?new m(g):null,A=[],xa=0;l.forEach(r=>{var q=
r.attributes.get(I.VertexAttribute.POSITION);const ya=q.indices;let F=e.get(q.data);if(null==F){F=A.length/3;for(let B=0;B<q.data.length;B+=q.size)A.push(q.data[B]),A.push(q.data[B+1]),A.push(q.data[B+2]);e.set(q.data,F)}for(q=0;q<r.edgeIndicesLength;q++)n[xa++]=F+ya[q]});m=k||a.geometries[0];l=H.create();m=this._computeModelTransformWithLocalOrigin(a,m,l);for(let r=0;r<a.geometries.length;r++)a.geometries[r].localOrigin=m.origin;a=new W(new ha.Attribute(A,n,3),l,m);await this._updatingHandles.addPromise(this._addPositionData(b,
a,n.length,c[0],d,f))}}_acquireRenderer(a,b,c){const d=w.EdgeRenderer.getKey(a,b,c);let f=this._renderers.get(d);null==this._strokesTexture&&(this._strokesTexture=pa.generateStrokesTexture(this.rctx));f||(f=new w.EdgeRenderer(this.rctx,this.techniques,{type:a,hasSlicePlane:b,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===da.ViewingMode.Global}),this._renderers.set(d,f));++f.refCount;return f}_removeRenderable(a){S(a.regular);S(a.silhouette);const b=this._renderers.get(a.rendererKey);
if(b){b.removeRenderable(a);--b.refCount;this._localOrigins.release(a.transform.origin);this._gpuMemoryUsage-=a.statistics.externalMemoryUsage?0:a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}}_updateObjectCameraDistances(a){const b=a.camera.eye,c=a.camera.viewForward,d=C.create();a=f=>{x.sub(d,f.center,b);const e=x.dot(d,c),g=f.radius,h=e<-g?Infinity:e<g?0:e-g;f.renderables.forEach(k=>k.distanceToCamera=h)};this._objectEntries.forEach(a);this._pendingDeletions.forEach(a)}get test(){}};
t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"rctx",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"renderSR",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"viewingMode",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"techniques",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"setNeedsRender",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,
"schedule",void 0);t.__decorate([u.property({readOnly:!0})],p.EdgeView.prototype,"_updatingHandles",void 0);t.__decorate([u.property({readOnly:!0})],p.EdgeView.prototype,"updating",null);p.EdgeView=t.__decorate([Z.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],p.EdgeView);class U{constructor(a,b,c,d){this.abort=a;this.radius=d;this.renderables=[];const f=a?N.onAbortOrThrow(a.signal,()=>a.abort()):null;this.loaded=b;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0);this.abort=
null;f?.remove()});this.center=C.clone(c)}}class va{constructor(a,b){this.buffer=a;this.meta=b}}class wa{constructor(a,b){this.vao=a;this.lod=b}}class D{constructor(a,b){this.modelMatrix=a;this.origin=b}}class E{constructor(a,b,c,d,f,e,g,h){this.regular=a;this.silhouette=b;this.statistics=c;this.transform=d;this.edgeTransparency=f;this.objectTransparency=e;this.components=g;this.rendererKey=h;this.distanceToCamera=0;this.visible=!0}}class za extends E{}class Aa extends E{}class W{constructor(a,b,
c){this.position=a;this.modelTransform=b;this.origin=c}}const V=aa.create(),ua=()=>Promise.reject();p.LegacyTransform=D;p.RegularRenderable=za;p.Renderable=E;p.SilhouetteRenderable=Aa;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
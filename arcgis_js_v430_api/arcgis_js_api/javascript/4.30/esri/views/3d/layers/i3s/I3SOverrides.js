// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../request ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/byteSizeEstimations ../../../../core/Collection ../../../../core/handleUtils ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/ReactiveSet ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/spatialReferenceUtils ../../../../intl/number ../../../../layers/support/featureQueryAll ../../../../rest/support/meshFeatureSet ../../../../support/featureFlags ../../../../support/requestUtils ../../../ViewingMode ../FeatureLayerView3D".split(" "),
function(m,n,J,K,L,z,A,B,M,V,u,C,D,E,F,p,N,O,P,G,H,r,Q,R,S){function y(a,b,c,d){return`Displaying the edits of a SceneLayer with a${d===t.Mode?a.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${a.wkid}) in ${c} viewing mode${d===t.SpatialReference?` with spatial reference (wkid:${b.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${d===t.Mode?"viewing mode":"view spatial reference"} to display edits.`}
m.I3SOverrides=class extends K{constructor(a){super(a);this._warnMaximumChangedObjectsExceeded=!1;this._maximumNumberOfEditOVerrides=5E4;this._original3DOFLDefinitionExpression=null;this._interactiveEditingSessions=new B;this.geometryOverrides=new B;this._clientGeometryCache=new Map;this._associatedLayerView=null;this._attributeChangedObjectIds=new E;this._geometryChangedObjectIds=new E;this._pendingFetchChangedObjectIds=null;this._pendingFetchAbortController=new AbortController;this._featureIdLocks=
new Map}initialize(){this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`);this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal);this._pendingFetchChangedObjectIds.finally(()=>{this._pendingFetchChangedObjectIds=this._pendingFetchAbortController=null});this.is3DOFL&&null!=this._associatedLayer&&(r.direct3DObjectFeatureLayerDisplayEnabled()?this._associatedLayer.load().then(a=>{this.destroyed||(this._original3DOFLDefinitionExpression=
a.definitionExpression,this.addHandles(F.watch(()=>this._definitionExpression,b=>a.definitionExpression=b,F.initial)),this._associatedLayerView=new S({layer:this._associatedLayer,view:this.view}))}):r.i3sPatchingEnabled())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&(r.direct3DObjectFeatureLayerDisplayEnabled()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):r.i3sPatchingEnabled());this._set("layer",null);this._memCache=
C.destroyMaybe(this._memCache);this._pendingFetchAbortController=C.abortMaybe(this._pendingFetchAbortController);this._pendingFetchChangedObjectIds=null;this._featureIdLocks.clear()}get is3DOFL(){return r.sceneLayerEditingEnabled()&&null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort((a,b)=>a-b):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return 0<this._geometryChangedObjectIds.size}get _definitionExpression(){const a=
this.sortedGeometryChangedObjectIds;return 0===a.length?"1 \x3d 0":`OBJECTID IN (${a.join(",")})`}get updating(){return this.is3DOFL?this._pendingFetchChangedObjectIds?!0:r.direct3DObjectFeatureLayerDisplayEnabled()?null==this._associatedLayerView||null!=this._associatedLayerView&&this._associatedLayerView.updating:!1:!1}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(a){return this._geometryChangedObjectIds.has(a)}featureHasAttributeChanges(a){return this._attributeChangedObjectIds.has(a)}createInteractiveEditSession(a){this._attributeChangedObjectIds.add(a);
const b=this._interactiveEditingSessions,c=new T(a,()=>{b.remove(c)});b.unshift(c);return c}async applyAttributeOverrides(a,b,c,d=[]){this._pendingFetchChangedObjectIds&&await D.whenOrAbort(this._pendingFetchChangedObjectIds,c);if(null!=b){var {attributeData:e,loadedAttributes:h}=b;if(null!=h&&null!=e&&0!==this._attributeChangedObjectIds.size){b=new Set;for(var f of h)b.add(f.index);for(const g of d)b.has(g.index)||(h.push(g),e[g.name]=Array(a.length));d=await this._lockFeatureIds(a);try{f={attributeData:e,
loadedAttributes:h};const g=this._getOverridesFromCache(a,f,this._attributeChangedObjectIds),{objectIds:k,fieldNames:q}=g;if(0!==k.length&&0!==q.length){var l=await this._queryAttributeOverridesFromAssociatedLayer(k,q,c);null!=l&&this._processOverridesFromAssociatedLayer(a,l,q,f)}}finally{d.remove()}}}}updateGeometry(a,b){this._geometryChangedObjectIds.add(a);const c=this._clientGeometryCache.get(a);null!=c&&(this.geometryOverrides.remove(c),this._clientGeometryCache.delete(a));null!=b&&(b={oid:a,
mesh:b},this.geometryOverrides.add(b),this._clientGeometryCache.set(a,b))}updateAttributeValue(a,b,c){this._attributeChangedObjectIds.add(a);this._cacheAttributeValue(a,b,c)}featureAdded(a){this.is3DOFL&&r.i3sPatchingEnabled()&&this._geometryChangedObjectIds.add(a);this._attributeChangedObjectIds.add(a)}_cacheAttributeValue(a,b,c){this._memCache.put(this._getAttributeCacheKey(a,b),c,this._memCacheAttributeValueSize(c))}_getOverridesFromCache(a,{loadedAttributes:b,attributeData:c},d){const e=new Set,
h=[];for(var f of b)h[f.index]=c[f.name];c=new Set;for(f=0;f<a.length;f++){const l=a[f];if(d.has(l))for(const g of b){const k=this._attributeFromCache(l,g.index);void 0!==k?h[g.index][f]=k:(e.add(l),c.add(g.name))}}return{objectIds:Array.from(e),fieldNames:Array.from(c)}}_attributeFromCache(a,b){const c=this._fromInteractiveEditingSession(a,b);if(void 0!==c)return c;a=this._getAttributeCacheKey(a,b);return this._memCache.get(a)}_fromInteractiveEditingSession(a,b){if(null!=this._interactiveEditingSessions)for(const c of this._interactiveEditingSessions){if(c.objectId!==
a)continue;const d=c.getAttribute(b);if(void 0!==d)return d}}_getAttributeCacheKey(a,b){return`${a}-${b}`}async _queryAttributeOverridesFromAssociatedLayer(a,b,c){if(0===a.length)return null;this._logWarningIfMaximumObjectsExceeded();const {associatedLayer:d}=this.layer;if(null==d)return null;const e=d.createQuery(),{objectIdField:h}=d;b=[h,...b];e.where="1\x3d1";e.returnGeometry=!1;e.outFields=b;e.cacheHint=!0;a=await this._executeBatchQuery(d,a,e,c);c=[];for(const f of a)if(f.ok)for(const l of f.value.features)c.push(l);
return c}async _queryGeometryOverridesFromAssociatedLayer(a,b){if(0===a.length||!this.is3DOFL||!r.i3sPatchingEnabled())return null;var c=this.layer.associatedLayer;const d=c.infoFor3D,{spatialReference:e}=c,{state:{viewingMode:h},spatialReference:f}=this.view;var l=h===R.ViewingMode.Global,g=e.isGeographic;if(l&&!g)return u.getLogger(this).warn("unsupported-pcs-edits-in-global-view",this.layer.title,y(e,f,this.view.viewingMode,t.Mode)),null;if(!l&&g)return u.getLogger(this).warn("unsupported-gcs-edits-in-local-view",
this.layer.title,y(e,f,this.view.viewingMode,t.Mode)),null;if(!(O.equals(e,f)||l&&f.isWebMercator&&e.isWGS84))return u.getLogger(this).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,y(e,f,this.view.viewingMode,t.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const {objectIdField:k,globalIdField:q}=c;l=[k,...(null!=q?[q]:[])];g=c.createQuery();g.where="1\x3d1";g.returnGeometry=!0;g.outFields=l;g.cacheHint=!0;g.returnZ=c.hasZ;g.returnM=c.hasM;b=await this._executeBatchQuery(c,
a,g,b);a=[];for(const v of b){if(!v.ok)continue;const {assetMaps:w,features:x,globalIdFieldName:U}=v.value;if(null!=w){b=H.assetMapFromAssetMapsJSON(d,w);for(const I of x)c=H.extractMesh(I,U,e,d,b),l=I,null==c?l.geometry=null:(l.geometry=c,a.push(l))}}return a}_logWarningIfMaximumObjectsExceeded(){if(this._warnMaximumChangedObjectsExceeded){this._warnMaximumChangedObjectsExceeded=!1;var a=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${P.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`,
b=this.layer.portalItem;a=b?.loaded?a+` (${b.portal.url}/home/item.html?id=${b.id}#settings)`:a+` (${this.layer.parsedUrl.path})`;u.getLogger(this).warn("#queryOverrides()",this.layer.title,`${a}.`)}}async _executeBatchQuery(a,b,c,d){if(0===b.length)return[];const e=G.getMaximumQuerySize(a);b=[...b].sort((h,f)=>h-f);b=L.splitIntoChunks(b,e).map(h=>{const f=c.clone();f.objectIds=h;return z.resultOrAbort(G.queryAllJSON(a,f,{signal:d}))});return Promise.all(b)}_processOverridesFromAssociatedLayer(a,
b,c,{loadedAttributes:d,attributeData:e}){var h=this._associatedLayer;if(null!=h){h=h.objectIdField;var f=c.map(k=>{k in e||(e[k]=Array(a.length));return e[k]}),l=new Map(d.map(k=>[k.name,k.index]));d=c.map(k=>l.get(k));var g=new Map(Array.from(a,(k,q)=>[k,q]));for(const k of b){b=k.attributes[h];for(let q=0;q<c.length;q++){const v=d[q],w=g.get(b),x=k.attributes[c[q]];f[q][w]=x;this._cacheAttributeValue(b,v,x)}}}}_memCacheAttributeValueSize(a){return"string"===typeof a?A.estimateStringByteSize(a):
A.estimateNumberByteSize()}async _fetchChangedObjectIds(a){var b=this.layer;await b.load({signal:a});this._geometryChangedObjectIds.clear();this._attributeChangedObjectIds.clear();({associatedLayer:b}=b);if(null!=b&&b.capabilities?.operations?.supportsChangeTracking){var c=this._getFetchChangedObjectIdsServerGen();if(null!=c){var d=b.layerId,e=this.is3DOFL;c={f:"json",returnIdsOnly:!0,layers:`[${d}]`,returnUpdates:!0,returnDeletes:e,returnInserts:e,layerServerGens:JSON.stringify([{id:d,serverGen:c}])};
e&&(d=b.infoFor3D,c.fieldsToCompare=JSON.stringify({fields:[...Object.values(d.transformFieldRoles),d.sourceHashField]}));c=await z.result(J(`${b.url}/extractChanges`,{method:"post",query:c,timeout:1E4,signal:a}));!c.ok&&Q.isTimeoutError(c.error)&&(d=this.layer.title,u.getLogger(this).warn("extractChanges:timeout",d,`${d} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`));
if(c.ok&&1===c.value.data?.edits?.length){d=c.value.data.edits[0];c=d?.objectIds;var h=c?.adds??[];const f=c?.updates??[],l=c?.deletes??[];c=[...h,...f,...l];e=e?[...h,...(d?.fieldUpdates??f),...l]:[];d=Math.min(this._maximumNumberOfEditOVerrides,c.length);d<c.length&&(this._warnMaximumChangedObjectsExceeded=!0);c=c.sort((g,k)=>g-k);for(h=0;h<d;++h)this._attributeChangedObjectIds.add(c[h]);for(const g of e)this._geometryChangedObjectIds.add(g);if(this.is3DOFL&&r.i3sPatchingEnabled()&&0<this._geometryChangedObjectIds.size&&
(a=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),a),null!=a))for(const g of a)null!=g.geometry&&this.updateGeometry(g.attributes[b.objectIdField],g.geometry)}}}}_getFetchChangedObjectIdsServerGen(){var a=this.layer;if(null!=a.serviceUpdateTimeStamp?.lastUpdate)return a.serviceUpdateTimeStamp.lastUpdate;a=a.associatedLayer;return null!=a?.serverGens?.minServerGen?a.serverGens.minServerGen:null}async _lockFeatureIds(a){const b=this._featureIdLocks;
for(var c=!0;c;){const e=[];for(const h of a){const f=b.get(h);f&&e.push(f)}0===e.length?c=!1:await Promise.all(e)}const d=D.createResolver();c=d.promise;for(const e of a)b.set(e,c);return M.makeHandle(()=>{for(const e of a)b.delete(e);d.resolve()})}get test(){}};n.__decorate([p.property({constructOnly:!0})],m.I3SOverrides.prototype,"view",void 0);n.__decorate([p.property({constructOnly:!0})],m.I3SOverrides.prototype,"layer",void 0);n.__decorate([p.property({readOnly:!0})],m.I3SOverrides.prototype,
"is3DOFL",null);n.__decorate([p.property()],m.I3SOverrides.prototype,"_interactiveEditingSessions",void 0);n.__decorate([p.property({readOnly:!0})],m.I3SOverrides.prototype,"sortedGeometryChangedObjectIds",null);n.__decorate([p.property({readOnly:!0})],m.I3SOverrides.prototype,"geometryOverrides",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"_clientGeometryCache",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"_associatedLayer",null);n.__decorate([p.property()],m.I3SOverrides.prototype,
"_associatedLayerView",void 0);n.__decorate([p.property({constructOnly:!0})],m.I3SOverrides.prototype,"memoryController",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"_attributeChangedObjectIds",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"_geometryChangedObjectIds",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"hasGeometryChanges",null);n.__decorate([p.property()],m.I3SOverrides.prototype,"_pendingFetchChangedObjectIds",void 0);n.__decorate([p.property()],
m.I3SOverrides.prototype,"_pendingFetchAbortController",void 0);n.__decorate([p.property()],m.I3SOverrides.prototype,"_definitionExpression",null);n.__decorate([p.property()],m.I3SOverrides.prototype,"updating",null);n.__decorate([p.property()],m.I3SOverrides.prototype,"isEmpty",null);m.I3SOverrides=n.__decorate([N.subclass("esri.views.3d.layers.i3s.I3SOverrides")],m.I3SOverrides);class T{constructor(a,b){this.objectId=a;this._remove=b;this._updates=new Map;this._isActive=!0}getAttribute(a){return this._updates.get(a)}setAttribute(a,
b){this.isActive&&this._updates.set(a,b)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}var t;(function(a){a[a.Mode=0]="Mode";a[a.SpatialReference=1]="SpatialReference"})(t||={});Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
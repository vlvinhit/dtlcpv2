// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/maybe ../../../../core/Promise ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/support/UpdatingHandles ../../../../layers/graphics/controllers/FeatureTileController3D ../../../../symbols/support/utils ./elevationAlignPointsInFeatures ./Graphics3DFeatureProcessor ./QueryEngine ./queryForSymbologySnapping ../support/HeatmapFeatureProcessor ../support/LayerViewPerformanceInfo ../../webgl-engine/lib/UpdatePolicy ../../../support/Scheduler".split(" "),
function(b,c,m,h,n,g,d,C,D,E,p,q,r,t,u,v,w,x,y,z,A,B){b.Graphics3DGraphicsPipeline=class extends n.EsriPromise{constructor(a){super(a);this._dataUpdatingState=f.NONE;this.controller=null;this.updatingHandles=new q.UpdatingHandles;this._controllerCreated=!1;this._pendingController=null}initialize(){this.addResolvingPromise(this._initializeController());this.updatingHandles.add(()=>this.layer.renderer,e=>this._recreateProcessor(e),g.initial);this.updatingHandles.add(()=>this.updatePolicy,e=>this.processor.preferredUpdatePolicy=
e);const a=()=>this.processor.featureStore;this.queryEngine=new w.QueryEngine({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return a()},hasZ:this.hasZ,hasM:this.hasM},priority:B.TaskPriority.FEATURE_QUERY_ENGINE})}destroy(){this.removeAllHandles();this.updatingHandles.destroy();this._destroyPendingController();this.controller=h.destroyMaybe(this.controller);this.processor=h.destroyMaybe(this.processor);this.queryEngine=
h.destroyMaybe(this.queryEngine);this.loadedGraphics=null}_destroyPendingController(){this._pendingController=h.destroyMaybe(this._pendingController)}get updating(){return this.updatingHandles.updating||!this._controllerCreated||this.controller?.updating||this.processor?.updating}get legendEnabled(){return this.processor.legendEnabled}get layer(){return this.layerView.layer}get view(){return this.layerView.view}get hasZ(){return this.layerView.hasZ}get hasM(){return this.layerView.hasM}get fullOpacity(){return this.layerView.fullOpacity}get suspended(){return this.layerView.suspended}get filter(){return"filter"in
this.layerView?this.layerView.filter:null}get slicePlaneEnabled(){return this.layerView.slicePlaneEnabled}get featureSpatialReference(){return"featureSpatialReference"in this.layerView?this.layerView.featureSpatialReference:null}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get hasAllFeatures(){return this.controller&&"hasAllFeatures"in this.controller?this.controller.hasAllFeatures:
!1}get hasAllFeaturesInView(){return this.controller&&"hasAllFeaturesInView"in this.controller?this.controller.hasAllFeaturesInView:!1}get hasFullGeometries(){return this.controller&&"hasFullGeometries"in this.controller?this.controller.hasFullGeometries:!1}get symbologySnappingSupported(){return this.layer?.renderer?.getSymbols()?.some(t.symbolHasExtrudeSymbolLayer)??!1}get updatePolicy(){return A.UpdatePolicy.SYNC}get scaleVisibilitySuspended(){return this.processor?.scaleVisibilitySuspended}get timeExtent(){return"timeExtent"in
this.layerView?this.layerView.timeExtent:null}get dataUpdating(){return this._dataUpdatingState!==f.NONE}get suspendInfo(){return this.processor?.suspendInfo??{}}forEachGraphic(a){this.loadedGraphics.forEach(a)}findGraphic(a){return this.loadedGraphics.find(a)}queryObjectIds(a,e){return this.layerView.queryObjectIds(a,e)}whenGraphicBounds(a,e){return this.processor?.whenGraphicBounds(a,e)}computeAttachmentOrigin(a,e){return this.processor?.computeAttachmentOrigin(a,e)}async elevationAlignPointsInFeatures(a,
e){const k=this.graphics3DProcessor;if(null==k)throw new m("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return u.elevationAlignPointsInFeatures(this.view,this.layer,l=>k.getGraphics3DGraphicByObjectId(l),a,e)}async queryForSymbologySnapping(a,e){return this.symbologySnappingSupported?x.queryForSymbologySnapping(this.graphics3DProcessor,a,e):{candidates:[],sourceCandidateIndices:[]}}highlight(a){return this.processor.highlight(a,this.layer.objectIdField)}maskOccludee(a){return this.processor.maskOccludee(a)}async _initializeController(){const a=
this.createController();this._pendingController=a;this._setupDataUpdating(a);await a.when();this._setControllerWhenInitialized(a)}_setupDataUpdating(a){"dataUpdating"in a&&this.addHandles([g.watch(()=>a.dataUpdating,e=>{e&&this._dataUpdatingState===f.NONE?this._dataUpdatingState=f.CONTROLLER:e||this._dataUpdatingState!==f.CONTROLLER||(this._dataUpdatingState=f.NONE)},g.sync),g.watch(()=>!!this.graphics3DProcessor?.dataUpdating,e=>{e&&this._dataUpdatingState===f.CONTROLLER?this._dataUpdatingState=
f.CORE:e||this._dataUpdatingState!==f.CORE||(this._dataUpdatingState=a.dataUpdating?f.CONTROLLER:f.NONE)},g.sync)])}async _setControllerWhenInitialized(a){try{await this.when()}catch(e){}this._controllerCreated=!0;!this.isResolved()||this.destroyed?this._destroyPendingController():(await g.whenOnce(()=>this.view?.basemapTerrain?.ready),this.beforeSetController(a),this._pendingController=null,this.controller=a,this.loadedGraphics=a.graphics)}_recreateProcessor(a){var e="heatmap"===a?.type;const k=
"heatmap"===this.processor?.type;a=this.processor;a&&e===k||(this.processor=e=e?new y.HeatmapFeatureProcessor({owner:this}):new v.Graphics3DFeatureProcessor({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:l=>this._updateClippingExtent(l)}),a?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(e.initializePromise))}_updateClippingExtent(a){this.clippingExtent=
a;if(!this.controller)return!1;switch(this.controller.type){case "stream":return!1;case "feature-tile-3d":return this.controller.extent=a,!0}}get performanceInfo(){const a=this.controller instanceof r.FeatureTileController3D?this.controller:null;return new z.LayerViewPerformanceInfo(this.processor.usedMemory,this.loadedGraphics?.length,a?.serviceDataCount??-1,a?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}};c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"updating",
null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"legendEnabled",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"layerView",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"layer",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"view",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"hasZ",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"hasM",null);
c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"fullOpacity",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"suspended",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"filter",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"slicePlaneEnabled",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"featureSpatialReference",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,
"loadedGraphics",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"graphics3DProcessor",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"heatmapProcessor",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"hasAllFeatures",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"hasAllFeaturesInView",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"hasFullGeometries",null);c.__decorate([d.property()],
b.Graphics3DGraphicsPipeline.prototype,"symbologySnappingSupported",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"updatePolicy",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"queryEngine",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"scaleVisibilitySuspended",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"timeExtent",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,
"_dataUpdatingState",void 0);c.__decorate([d.property({readOnly:!0})],b.Graphics3DGraphicsPipeline.prototype,"dataUpdating",null);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"controller",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"processor",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"updatingHandles",void 0);c.__decorate([d.property()],b.Graphics3DGraphicsPipeline.prototype,"_controllerCreated",void 0);b.Graphics3DGraphicsPipeline=
c.__decorate([p.subclass("esri.views.3d.layers.graphics.Graphics3DGraphicsPipeline")],b.Graphics3DGraphicsPipeline);var f;(function(a){a[a.NONE=0]="NONE";a[a.CONTROLLER=1]="CONTROLLER";a[a.CORE=2]="CORE"})(f||={});Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../ViewingMode ./I3SUtil ./Intersector ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/RayIntersections ../../webgl-engine/lib/verticalOffsetUtils".split(" "),function(v,z,A,B,C,w,D,E){function F(a,e,c,f=0){f=a[3]+f;const g=e[0]-a[0],k=e[1]-a[1];a=e[2]-a[2];e=c[0];const d=c[1];c=c[2];const l=e*g+d*k+c*a;return 0<=l*l-(e*e+d*d+c*c)*(g*g+k*k+a*a-f*f)}class G{constructor(a){this.type=w.IntersectorType.I3S;this._needVerticalOffset=
!1;this.layerUid=a.layerUid;this.sublayerUid=a.sublayerUid;this._collection=a.collection;this._traverseNodeHierarchy=a.traverseNodeHierarchy;this.slicePlaneEnabled=a.slicePlaneEnabled;this.isGround=a.isGround}updateElevationAlignState(a,e){this._needVerticalOffset=a&&e===z.ViewingMode.Global}intersect(a,e,c,f,g,k){g=k??!1;const d=a.results,l=a.options.store===w.StoreResults.ALL,r=a.ray.direction,m=a.tolerance;let x=b=>b,t=b=>b;const n=E.getVerticalOffsetI3S(a.verticalOffset??(this._needVerticalOffset?
0:null));null!=a.verticalOffset&&null!=n&&(x=b=>n.applyToMbs(b),t=b=>n.applyToObb(b));const H=new D.MeshIntersectionOptions(g,a.options.normalRequired);this._traverseNodeHierarchy((b,y)=>{if(0===b.childrenLoaded)return!1;const u=b.serviceObbInRenderSR?.isValid?b.serviceObbInRenderSR:null;if(u&&!t(u).intersectRay(c,r,m))return!1;!y||!u&&A.isValidMbs(b.serviceMbsInRenderSR)&&!F(x(b.serviceMbsInRenderSR),c,r,m)||null!=b.geometryObbInRenderSR&&!t(b.geometryObbInRenderSR).intersectRay(c,r,m)||this._collection.intersect(y,
c,f,m,n,H,(I,h,J,K)=>{if(!(0>h||null!=e&&!e(c,f,h))){var q=p=>{const L=new B.I3sTarget(this.layerUid,this.sublayerUid,b.index,I,K);p.set(this.type,L,h,J)};this.isGround&&(null==d.ground.dist||h<d.ground.dist)&&q(d.ground);if(!a.options.isFiltered&&((null==d.min.dist||h<d.min.dist)&&q(d.min),(null==d.max.dist||h>d.max.dist)&&q(d.max),l)){const p=C.newIntersectorResult(a.ray);q(p);a.results.all.push(p)}}});return!0})}}v.I3SIntersectionHandler=G;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../core/has ../../../../core/Logger ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/coordsUtils ./defaultSymbolComplexity ./elevationAlignmentUtils ./ElevationContext ./featureExpressionInfoUtils ./graphicUtils ./interfaces ./Loadable ../support/FastSymbolUpdates".split(" "),function(m,r,E,t,u,v,w,x,h,n,y,k,z,A,l){function p(a){const b={color:!1,opacity:!1,opacityAlwaysOpaque:!0,
size:!1};a&&"visualVariables"in a&&a.visualVariables&&a.visualVariables.forEach(c=>{switch(c.type){case "color":b.color=!0;if(c.stops)for(let d=0;d<c.stops.length;d++){const e=c.stops[d].color;e&&(b.opacity=!0,1>e.a&&(b.opacityAlwaysOpaque=!1))}break;case "opacity":b.opacity=!0;b.opacityAlwaysOpaque=!1;break;case "size":b.size=!0}});return b}const f=()=>t.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class B extends A.Loadable{constructor(a,b,c,d){super(c.schedule);this.symbol=
a;this.symbolLayer=b;this._context=c;this.ignoreDrivers=!1;this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};this._materials=[];this.usedMemory=0;this.logger=f();this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};this.skipHighSymbolLodsChanged=!0;this._renderPriority=d.renderPriority;this._renderPriorityStep=d.renderPriorityStep;this._elevationContext=new n.ElevationContext;this.complexity=this.computeComplexity();this.ignoreDrivers=d.ignoreDrivers;
this.ignoreDrivers||(this._drivenProperties=p(this._context.renderer));this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(a){if(this.ignoreDrivers)return!1;const b=this._drivenProperties;a=p(a);return a.color!==b.color||a.opacity!==b.opacity||a.opacityAlwaysOpaque!==b.opacityAlwaysOpaque||a.size!==b.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(a,
b,c,d){const e="polygons"in a?a.polygons:null,g=`${d} geometry failed to be created`;a.projectionSuccess?!this._logGeometryValidationWarnings(b,c,d)&&e&&0===e.length&&"rings"===c&&0<b.length&&2<b[0].length&&f().warnOncePerTick(`${g} (filled rings should use clockwise winding - try reversing the order of vertices)`):f().warnOncePerTick(`${g} (failed to project geometry to view spatial reference)`)}_logGeometryValidationWarnings(a,b,c){c=`${c} geometry failed to be created`;return!a.length||1===a.length&&
!a[0].length?(f().warnOncePerTick(`${c} (no ${b} were defined)`),!0):Array.isArray(a)&&Array.isArray(a[0])?!1:(f().warnOncePerTick(`${c} (${b} should be defined as a 2D array)`),!0)}_validateGeometry(a,b=null,c=null){if(null!=b&&!b.includes(a.type))return this.logger.warn("unsupported geometry type for "+c+` symbol: ${a.type}`),!1;switch(a.type){case "point":if(!isFinite(a.x)||!isFinite(a.y))return f().warn("point coordinate is not a valid number, graphic skipped"),!1;break;case "polygon":w.closeRings(a)&&
f().warnOncePerTick("Fixed a non-closed polygon ring.")}return!0}_defaultElevationInfoNoZ(){return C}_defaultElevationInfoZ(){return D}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):
this._elevationContext.reset()}getDefaultElevationInfo(a){return a.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(a,b=this.getDefaultElevationInfo(a)){return this._elevationContext.mode||b.mode}setElevationInfoOverride(a){this._elevationInfoOverride=a;this._updateElevationContext()}setGraphicElevationContext(a,b=new n.ElevationContext){var c=a.geometry;const d=this.getDefaultElevationInfo(c);b.unit=null!=this._elevationContext.unit?this._elevationContext.unit:
d.unit;b.mode=this.getGeometryElevationMode(c,d);b.offsetMeters=this._elevationContext.meterUnitOffset??d.offset??0;if(c=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===b.mode)b.mode="relative-to-ground",b.offsetMeters=0;b.updateFeatureExpressionInfoContext(c?y.zeroContext:this._elevationContext.featureExpressionInfoContext,a,this._context.layer);return b}prepareSymbolLayerPatch(a){}updateGeometry(a,b){return!1}updateTransform(a,b,c,d){return!1}onRemoveGraphic(a){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&
"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity??0;const a=this._context.layer.opacity;return null==a?1:a}_getCombinedOpacity(a,b=q){let c=1;this.draped||(c*=this._getLayerOpacity());if(this._drivenProperties.opacity)return c;null!=a?c*=a.a:b.hasIntrinsicColor||(c=0);return c}_getCombinedOpacityAndColor(a,b=q){b=this._getCombinedOpacity(a,b);if(this._drivenProperties.color)return k.mixinColorAndOpacity(null,b);a=null!=a?r.toUnitRGB(a):u.ONES;return k.mixinColorAndOpacity(a,
b)}_getVertexOpacityAndColor(a,b=null){a=k.mixinColorAndOpacity(this._drivenProperties.color?a.color:null,this._drivenProperties.opacity?a.opacity:null);b&&(a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return x.defaultSymbolLayerComplexity(this.symbol,this.symbolLayer)}globalPropertyChanged(a,b,c){switch(a){case "opacity":return this.layerOpacityChanged(b,c),!0;case "elevationInfo":return a=this._elevationContext.mode,this._updateElevationContext(),
this.layerElevationInfoChanged(b,c,a)===h.SymbolUpdateType.RECREATE?!1:!0;case "slicePlaneEnabled":return this.slicePlaneEnabledChanged(b,c);case "physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case "pixelRatio":return this.pixelRatioChanged;case "skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(a,b,c){let d=h.SymbolUpdateType.UPDATE;a.forEach(e=>{const g=b(e);null!=g?(this.setGraphicElevationContext(e.graphic,
g.elevationContext),g.needsElevationUpdates=c(g.elevationContext.mode)):d=h.SymbolUpdateType.RECREATE});return d}applyRendererDiff(a,b){return z.ApplyRendererDiffResult.RecreateSymbol}getFastUpdateAttrValues(a){if(!this._fastUpdates)return null;const b=this._fastUpdates.visualVariables,c=b.size?l.getAttributeValue(b.size.field,a):0,d=b.color?l.getAttributeValue(b.color.field,a):0;a=b.opacity?l.getAttributeValue(b.opacity.field,a):0;return v.fromValues(c,d,a,0)}get draped(){return this._draped}ensureDrapedStatus(a){if(null==
this._draped)return this._draped=a,!0;a!==this.draped&&f().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary.");return!1}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??
null})}}}const C={mode:"on-the-ground",offset:0,unit:"meters"},D={mode:"absolute-height",offset:0,unit:"meters"},q={hasIntrinsicColor:!1};m.Graphics3DSymbolLayer=B;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
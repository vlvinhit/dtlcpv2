// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/handleUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat2d ../../../../core/libs/gl-matrix-2/factories/mat2df64 ../../../../core/libs/gl-matrix-2/math/vec2 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../core/support/UpdatingHandles ../../../input/InputManager ../../../interactive/keybindings ../../../interactive/snapping/SnappingManagerPool".split(" "),
function(t,f,h,z,m,A,n,B,u,v,l,J,K,L,C,D,E,w,F,G,p,d,H){const x=Symbol(),y=Symbol();f.MediaLayerInteraction=class extends z{get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){return this.options?.tool??"transform"}get _toolType(){switch(this._preferredInteractionTool){case "transform":return"transform-3d";case "reshape":return"reshape-3d"}}get _validatedSelectedElement(){const a=this.selectedElement;if(!a)return null;const {layer:{source:b}}=this;return b?"hasElement"in
b?b.hasElement(a)?a:null:b===a?a:null:null}constructor(a){super(a);this.enabled=!1;this._updatingHandles=new G.UpdatingHandles;this._isOpacityToggled=!1;this._factor=1;this._createToolAbortController=this._object=this._tool=null;this._onPointerMove=B.debounce(async b=>{b=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(b));this.destroyed||(this.removeHandles(y),b&&b!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(m.makeHandle(()=>this.view.cursor=null),y)))});
this._tmpMat2=E.create();this._tmpVec2=F.create()}destroy(){this._createToolAbortController=n.abortMaybe(this._createToolAbortController)}initialize(){this.addHandles([m.destroyHandle(this._updatingHandles),this._updatingHandles.add(()=>this.enabled,a=>this._enableDisable(a),u.initial),this._updatingHandles.add(()=>this._preferredInteractionTool,a=>this._preferredInteractionToolChanged(a))])}_enableDisable(a){if(a){this._dynamicImports();var {view:b}=this;a=new d.KeyBindings;a.add(d.mediaKeys.undo,
()=>{this._object?.operations?.undo();this._object?.emit("modified-externally")});a.add(d.mediaKeys.redo,()=>{this._object?.operations?.redo();this._object?.emit("modified-externally")});a.addToggle(d.mediaKeys.preserveAspectRatio,c=>{"transform-3d"===this._tool?.type&&(this._tool.preserveAspectRatio="key-down"===c.type)});a.addToggle(d.mediaKeys.rotateIncrements,c=>{"transform-3d"===this._tool?.type&&(this._tool.snapRotation="key-down"===c.type)});a.add(d.mediaKeys.toggleOpacity,()=>{const c=this._object?.element;
c&&(c.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)});a.add(d.mediaKeys.moveUp,()=>this._move(0,this._factor));a.add(d.mediaKeys.moveDown,()=>this._move(0,-this._factor));a.add(d.mediaKeys.moveRight,()=>this._move(this._factor,0));a.add(d.mediaKeys.moveLeft,()=>this._move(-this._factor,0));a.addToggle(d.mediaKeys.factorModifier,c=>this._factor="key-down"===c.type?10:1);this._isOpacityToggled=!1;this.addHandles([a.register(b,p.ViewEventPriorities.TOOL),m.makeHandle(()=>
{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)}),b.on("immediate-click",c=>this._onClick(c),p.ViewEventPriorities.TOOL),b.on("pointer-move",c=>this._onPointerMove(c).catch(()=>{}),p.ViewEventPriorities.TOOL),this._updatingHandles.add(()=>this._validatedSelectedElement,(c,e)=>{e&&c!==e&&this._isOpacityToggled&&(e.opacity*=2,this._isOpacityToggled=!1);this._selectedElementChanged(c)},u.initial),m.makeHandle(()=>{b.cursor=null;this._removeTool()})],
x)}else this.removeHandles(x)}async _onClick(a){await this._updatingHandles.addPromise(a.async(async()=>{const b=await this._findElementAtScreenPoint(a);!this.destroyed&&(b&&a.stopPropagation(),this.selectedElement=b)&&(this.view.cursor=null)}))}async _selectedElementChanged(a){a?.georeference?this._object?.element!==a&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=n.abortMaybe(this._createToolAbortController);
this._removeTool();var a=this._validatedSelectedElement;if(a){var b=new AbortController;this._createToolAbortController=b;var {ManipulatedObject3DMediaElement:c,ExtentTransformTool:e,ReshapeTool3D:k}=await this._dynamicImports();if(!b.signal.aborted){var {view:g,layer:q,_toolType:r}=this;this._object=new c({view:g,layer:q,element:a,tool:this._preferredInteractionTool});switch(r){case "transform-3d":this._tool=new e({view:g,object:this._object});a=g.inputManager;a.isModifierKeyDown(d.mediaKeys.rotateIncrements.key)&&
(this._tool.snapRotation=!0);a.isModifierKeyDown(d.mediaKeys.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0);break;case "reshape-3d":a=H.acquire(g),this.addHandles(a,this._tool),{snappingManager:a}=a,this._tool=new k({view:g,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:a,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1})}this.addHandles([m.makeHandle(()=>{this._object=n.destroyMaybe(this._object);this._tool&&(g.tools.remove(this._tool),this._tool=
null)})],this._tool);g.addAndActivateTool(this._tool)}}}_preferredInteractionToolChanged(a){var {_tool:b}=this;b&&(this._toolType!==b.type?this._updatingHandles.addPromise(this._recreateTool()):({_object:b}=this,b&&(b.tool=a)))}async _dynamicImports(){const [{ManipulatedObject3DMediaElement:a},{ExtentTransformTool:b,ReshapeTool3D:c}]=await Promise.all([new Promise((e,k)=>t(["../../interactive/editingTools/ManipulatedObject3DMediaElement"],e,k)),new Promise((e,k)=>t(["../../interactive/editingTools"],
e,k))]);return{ManipulatedObject3DMediaElement:a,ExtentTransformTool:b,ReshapeTool3D:c}}async _findElementAtScreenPoint(a){a=(await this.view.hitTest(a,{include:[this.layer]})).results[0];return"media"===a?.type?a.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(a,b){const {view:c,_object:e}=this,k=e?.operations;if(k){var g=c.overlayPixelSizeInMapUnits(c.pointsOfInterest.focus.location)*v.getMetersPerUnitForSR(c.spatialReference)/v.getMetersPerUnitForSR(k.data.spatialReference),
{_tmpMat2:q,_tmpVec2:r}=this,I=D.fromRotation(q,A.deg2rad(360-this.view.camera.heading));a=w.set(r,g*a,g*b);w.transformMat2d(a,a,I);k.move(a[0],a[1],0);e.emit("modified-externally")}}};h.__decorate([l.property({constructOnly:!0})],f.MediaLayerInteraction.prototype,"view",void 0);h.__decorate([l.property({constructOnly:!0})],f.MediaLayerInteraction.prototype,"layer",void 0);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,"selectedElement",void 0);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,
"enabled",void 0);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,"options",void 0);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,"updating",null);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,"_preferredInteractionTool",null);h.__decorate([l.property()],f.MediaLayerInteraction.prototype,"_validatedSelectedElement",null);f.MediaLayerInteraction=h.__decorate([C.subclass("esri.views.3d.layers.support.MediaLayerInteraction")],f.MediaLayerInteraction);Object.defineProperty(f,
Symbol.toStringTag,{value:"Module"})});
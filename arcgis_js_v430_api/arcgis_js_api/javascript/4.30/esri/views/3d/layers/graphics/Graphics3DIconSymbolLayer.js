// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("require exports ../../../../Color ../../../../core/asyncUtils ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/string ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/projection/projectPointToVector ../../../../geometry/support/aaBoundingBox ../../../../support/arcadeOnDemand ../../../../symbols/cim/CIMSymbolHelper ../../../../symbols/cim/OverrideHelper ../../../../symbols/cim/utils ../../../../symbols/support/cimSymbolUtils ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/Symbol3DAnchorPosition2D ../../../../symbols/support/utils ../../../2d/arcade/callExpressionWithFeature ./constants ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./placementUtils ./pointUtils ../support/FastSymbolUpdates ../../support/engineContent/sdfPrimitives ../../terrain/OverlayRenderer ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(Q,H,R,B,C,S,T,v,q,r,U,V,w,t,W,X,Y,Z,D,x,aa,ba,ca,da,ea,fa,ha,ia,m,ja,ka,la,ma,E,F,n,y,z,na,I,oa,J,K){function G(a){return null==a?!1:"cross"===a||"x"===a}function L(a){a=V.dataComponents(a);return"application/json"===a?.mediaType?a.data:void 0}function M(a,b){return"relative"===a?w.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in F.namedAnchorToHUDMaterialAnchorPos?F.namedAnchorToHUDMaterialAnchorPos[a]:F.namedAnchorToHUDMaterialAnchorPos.center}function N({parameters:a},b){a=(a.width??1)/(a.height??
1);return 1<a?[b,Math.round(b/a)]:[Math.round(b*a),b]}const O=t.fromValues(0,0,1),P=z.defaultTexSize,p=z.defaultSymbolSizeRatio,pa=[p/2,p/2,1-p/2,1-p/2];class A extends la.Graphics3DSymbolLayer{getCachedSize(){return{size:this._getIconSize()}}constructor(a,b,c,d){super(a,b,c,d);this._cimSymbolMaterials=new Map;this._cimSymbolTextures=new Map;this._size=this._cimMaterialParametersInfo=null;this._symbolTextureRatio=1;this._outlineSize=0;this._patchTask=null;this._elevationOptions={supportsOffsetAdjustment:!0,
supportsOnTheGround:!0}}async doLoad(a){this._validateOrThrow();const b=this._prepareMaterialParameters();var c=this._getPrimitive();if(null!=c)this._prepareResourcesPrimitive(b,c);else{c=ea.getIconHref(this.symbolLayer);const d=L(c);null!=d?await this._prepareResourcesCIM(b,JSON.parse(d),a):await this._prepareResourcesHref(b,c,a)}}_validateOrThrow(){if(!this._drivenProperties.size){var a=ma.validateSymbolLayerSize(this._getIconSize());if(a)throw new C("graphics3diconsymbollayer:invalid-size",a);
}}_getIconSize(){var a=this.symbolLayer;a=Math.round(null!=a.size?r.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a}_generateTextureCIM(a){var b=this._cimData;b&&b.symbol||this.logger.error("Can't create texture, CIM data is undefined");if(b.primitiveOverrides){b=T.clone(b);var c=b.primitiveOverrides;x.OverrideHelper.evaluateOverrides(c,a,this._arcadeInfo.geometryType,null,null);x.OverrideHelper.applyOverrides(b.symbol,c)}c=U.numericHash(JSON.stringify(b));var d=this._cimSymbolTextures.get(c);
if(d)return d;d=this._context.sharedResources.cimSymbolRasterizer;const e=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;e&&x.OverrideHelper.applyDictionaryTextOverrides(b.symbol,a,e,null);a=null!=this._cimScaleFactorOrFunction?aa.evaluateValueOrFunction(this._cimScaleFactorOrFunction,a):1;1!==a&&b.symbol&&ba.scaleCIMSymbol(b.symbol,a,!0);a=D.CIMSymbolHelper.getEnvelope(b,null,d.resourceManager);a?.width&&a.height?(b=d.rasterize({type:"cim",
data:b},a.width,a.height,a.x+a.width/2,a.y+a.height/2,1,"esriGeometryPoint"),a=new da.Symbol3DAnchorPosition2D({x:-a.x/a.width-.5,y:(a.height+a.y)/a.height-.5}),this._cimMaterialParametersInfo.anchorPosition=M("relative",a),d=new J.Texture(b,{width:b?.width??1,height:b?.height??1,reloadable:!0})):d=new J.Texture(new ImageData(1,1),{width:1,height:1,reloadable:!0});this._cimSymbolTextures.set(c,d);this._context.stage.add(d);return d}_prepareMaterialParameters(){const a={anchorPosition:M(this.symbolLayer.anchor,
this.symbolLayer.anchorPosition)},b=this.symbol;if(b&&"point-3d"===b.type&&b.hasVisibleVerticalOffset()){const {screenLength:c,minWorldLength:d,maxWorldLength:e}=b.verticalOffset;a.verticalOffset={screenLength:r.pt2px(c),minWorldLength:d||0,maxWorldLength:null!=e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);a.occlusionTest=!S("enable-feature:non-occluded-hud");a.hasSlicePlane=this._context.slicePlaneEnabled;
return a}_prepareResourcesPrimitive(a,b){var c=this._getOutlineSize();if(G(b)&&0===c)throw Error("Nothing to render");this._outlineSize=c;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;null!=this._context.sharedResources.textures&&(this._textureHandle=c=this._context.sharedResources.textures.fromData(`${b}-icon`,()=>z.createTexture(b)),a.textureId=c.texture.id);a.textureIsSignedDistanceField=!0;a.sampleSignedDistanceFieldTexelCenter=z.requiresHalfTexelOffset(b);
a.distanceFieldBoundingBox=pa;c=this._getIconSize();this._size=[c,c];this._symbolTextureRatio=1/p;this._createMaterialAndAddToStage(a,this._context.stage)}async _prepareResourcesHref(a,b,c){this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=!1;const d=this._getIconSize(),e=d*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){c=
await B.result(this._context.sharedResources.textures.fromUrl(b,e,{signal:c}));if(!1===c.ok)throw q.throwIfAbortError(c.error),new C("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${b})`);this._textureHandle=c.value;b=c.value.texture;this._size=N(b,d);a.textureId=b.id}this._createMaterialAndAddToStage(a,this._context.stage)}async _prepareResourcesCIM(a,b,c){this._cimData=b;if(!this._context.sharedResources.cimSymbolRasterizer){var d=(await new Promise((f,
g)=>Q(["../../../../symbols/cim/CIMSymbolRasterizer"],f,g))).CIMSymbolRasterizer;q.throwIfAborted(c);this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new d(this._context.renderCoordsHelper.spatialReference))}var e=this._context.sharedResources.cimSymbolRasterizer;d=[];const h=b?.symbol;D.CIMSymbolHelper.fetchResources(h,e.resourceManager,d,c);D.CIMSymbolHelper.fetchFonts(h,e.resourceManager,d);e=this._context.layer.fields?this._context.layer.fields.map(f=>
f.toJSON()):[];this._arcadeInfo={spatialReference:this._context.renderCoordsHelper.spatialReference,fields:e,geometryType:"esriGeometryPoint"};b?.primitiveOverrides&&d.push(x.OverrideHelper.createRenderExpressions(b.primitiveOverrides,this._arcadeInfo));0<d.length&&(await Promise.all(d),q.throwIfAborted(c));if(this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression&&(b=this._context.renderer,b.scaleExpression)){const f=await Z.createRendererExpression(b.scaleExpression,
this._context.layer.spatialReference,e);this._cimScaleFactorOrFunction=(g,k,l)=>{g=fa(f,g,{$view:l},"esriGeometryPoint",k);return null!==g?g:1}}q.throwIfAborted(c);this._cimMaterialParametersInfo=a;this._cimMaterialParametersInfo.color=this._getFillColor();this._cimMaterialParametersInfo.outlineColor=[0,0,0,0];this._cimMaterialParametersInfo.outlineSize=0;this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource?.href?null:this.symbolLayer.resource?.primitive??
ca.defaultPrimitive}_getOutlineSize(){var a=0;a=this.symbolLayer;if(null!=a.outline?.size)return Math.max(r.pt2px(a.outline.size),0);a=this._getPrimitive();a=G(a)?1.5:0;return Math.max(a,0)}_getOutlineColor(){const a=this._getLayerOpacity(),b=this.symbolLayer?.outline?.color;if(null!=b){const c=R.toUnitRGB(b);return[c[0],c[1],c[2],b.a*a]}return[0,0,0,0]}_getFillColor(){if(G(this._getPrimitive()))return ha.transparentUnit;const a=null==this._getPrimitive();return this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color,
{hasIntrinsicColor:a})}_createMaterialAndAddToStage(a,b){if(this._cimData){this._fastUpdates=null;let c=a.textureId?this._cimSymbolMaterials.get(a.textureId):null;c||(c=new K.HUDMaterial(a),this._cimSymbolMaterials.set(a.textureId??0,c),b.add(c));return c}(this._fastUpdates=y.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()))&&(a={...a,...this._fastUpdates.materialParameters});this._materials[0]=new K.HUDMaterial(a);b.add(this._materials[0]);return this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&
(this._forEachMaterial(a=>{a.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy();this._patchTask=v.abortMaybe(this._patchTask);this._forEachMaterial(a=>this._context.stage.remove(a));this._materials.length=0;this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(a=>this._context.stage.remove(a));this._cimSymbolTextures.clear();this._textureHandle=
v.releaseMaybe(this._textureHandle)}_getScaleFactor(a,b){if(this._drivenProperties.size&&a.size){for(let c=0;3>c;c++){const d=a.size[c];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[c]=r.pt2px(d))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1}createGraphics3DGraphic(a){const b=a.graphic;if(!this._validateGeometry(b.geometry))return null;var c=[0,0];let d;if(this._cimData){if(!this._cimData.symbol)return null;
var e=this._generateTextureCIM(b);d=this._createMaterialAndAddToStage({textureId:e.id,...this._cimMaterialParametersInfo},this._context.stage);var h=window.devicePixelRatio||1;c=[e.parameters.width/h,e.parameters.height/h]}else c=this._size,d=this._materials[0];e=n.placePointOnGeometry(b.geometry);if(null==e)return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;var f=a.renderingInfo;h=this._getVertexOpacityAndColor(f);let g=1;this._fastUpdates?.visualVariables.size||
(g=this._getScaleFactor(f,c[0]>c[1]?c[0]:c[1]));g*=this._symbolTextureRatio;c=w.fromValues(c[0]*g,c[1]*g);f=this.setGraphicElevationContext(b);this.ensureDrapedStatus("on-the-ground"===f.mode)&&this._setDrapingDependentMaterialParameters();return this.draped?this._createAsOverlay(b,e,d,h,c,a.layer.uid):this._createAs3DShape(b,e,d,h,c,f,b.uid)}layerOpacityChanged(){const a=this._getFillColor(),b=this._getOutlineColor();this._forEachMaterial(c=>{c.setParameters({color:a});c.setParameters({outlineColor:b})})}updateGeometry(a,
b){if(this.draped||!this._validateGeometry(b))return!1;const {elevationContext:c,stageObject:d}=a;if(c.mode!==this.getGeometryElevationMode(b))return!1;b=n.placePointOnGeometry(b);if(!b)return!1;const e=n.updateStageObjectGeometry(d,this._context,b,c);if(null==e)return!1;const h=n.getLocalOriginForPoint(this._context,b);if(d.geometries[0].localOrigin!==h)return!1;a.alignedSampledElevation=e;n.extendPointGraphicElevationContext(a,b,this._context.elevationProvider);return!0}layerElevationInfoChanged(a,
b,c){const d=this._elevationContext.mode;c=m.elevationModeChangeUpdateType(A.elevationModeChangeTypes,c,d);if(c!==m.SymbolUpdateType.UPDATE)return c;const e=m.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)}slicePlaneEnabledChanged(){this.draped||this._forEachMaterial(a=>{a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(a,
b){for(const c in a.diff)switch(c){case "visualVariables":if(y.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))this._materials[0]?.setParameters(this._fastUpdates.materialParameters);else return E.ApplyRendererDiffResult.RecreateSymbol;break;default:return E.ApplyRendererDiffResult.RecreateSymbol}return E.ApplyRendererDiffResult.FastUpdate}prepareSymbolLayerPatch(a){this._patchTask?.abort();"partial"===a.diff.type&&this._preparePatchResource(a,a.diff.diff)}_preparePatchResource(a,
b){if(b.resource&&"partial"===b.resource.type&&(b=b.resource.diff,"complete"===b?.href?.type)){var c=b.href.newValue,{textures:d}=this._context.sharedResources;if(null!=c&&null!=d&&null==L(c)){var e=this._getIconSize(),h=e*this._context.graphicsCoreOwner.view.state.pixelRatio;a.symbolLayerStatePatches.push(()=>{this._patchTask=v.abortMaybe(this._patchTask);this._patchTask=B.createTask(f=>this._context.schedule(async(g,k)=>{g=await B.result(d.fromUrl(c,h,{signal:k}));q.throwIfAborted(k);(k=!g.ok)&&
q.throwIfAbortError(g.error);this._textureHandle=v.releaseMaybe(this._textureHandle);this._patchTask=null;if(k)this._forEachMaterial(u=>{u.visible=!1;u.setParameters({textureId:null})}),this.logger.error(new C("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${c})`));else{this._textureHandle=g.value;var l=g.value.texture;this._size=N(l,e);this._forEachMaterial(u=>{u.setParameters({textureId:l.id});u.visible=!0})}},f))});delete b.href}}}_defaultElevationInfoNoZ(){return qa}_createAs3DShape(a,
b,c,d,e,h,f){a=this.getFastUpdateAttrValues(a);const g=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerUid:this._context.layer.uid});d=I.createPointGeometry(c,O,null,d,e,ra,null,a,g);f=n.createStageObject(this._context,b,d,h,f);if(null==f)return null;const k=new ka.Graphics3DObject3DGraphicLayer(this,f.object,[d],null,null,ia.perObjectElevationAligner,h);k.alignedSampledElevation=f.sampledElevation;k.needsElevationUpdates=m.needsElevationUpdates2D(h.mode)||"absolute-height"===
h.mode;k.getScreenSize=this._createScreenSizeGetter(e,a);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),1,l);n.extendPointGraphicElevationContext(k,b,this._context.elevationProvider);return k}_createAsOverlay(a,b,c,d,e,h){c.renderPriority=this._renderPriority;const f=t.create();X.projectPointToVector(b,f,this._context.overlaySR);f[2]=na.drapedZ;b=this._context.clippingExtent;if(null!=b&&!Y.containsPoint(b,f))return null;b=this.getFastUpdateAttrValues(a);const g=
this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a.uid,layerUid:this._context.layer.uid});d=I.createPointGeometry(c,O,f,d,e,null,null,b,g);a=new oa.RenderGeometry(d,{layerUid:h,graphicUid:a.uid});const k=new ja.Graphics3DDrapedGraphicLayer(this,[a],null,this._context.drapeSourceRenderer);k.getScreenSize=this._createScreenSizeGetter(e,b);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),1,l);return k}_createScreenSizeGetter(a,b){const c=this._outlineSize+
2;if(this._fastUpdates&&b){const h=a[0]/this._symbolTextureRatio,f=a[1]/this._symbolTextureRatio;return(g=w.create())=>{const [k,l]=y.evaluateModelTransformScale(sa,this._fastUpdates.materialParameters,b);g[0]=k*h+c;g[1]=l*f+c;return g}}const d=a[0]/this._symbolTextureRatio+c,e=a[1]/this._symbolTextureRatio+c;return(h=w.create())=>{h[0]=d;h[1]=e;return h}}_fastVisualVariableConvertOptions(){var a=Math.max(this._size[0],this._size[1]);const b=t.fromValues(a,a,a),c=r.px2pt(1);a*=c;a=t.fromValues(a,
a,a);return new y.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},b,a,c)}_forEachMaterial(a){this._materials.forEach(a);this._cimSymbolMaterials.forEach(a)}test(){return{...super.test(),material:this._materials[0]}}}A.PRIMITIVE_SIZE=[P*p,P*p];A.elevationModeChangeTypes={definedChanged:m.SymbolUpdateType.UPDATE,staysOnTheGround:m.SymbolUpdateType.NONE,onTheGroundChanged:m.SymbolUpdateType.RECREATE};const qa={mode:"relative-to-ground",offset:0},ra=W.fromValues(0,0,0,1),sa=t.create();H.Graphics3DIconSymbolLayer=
A;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});
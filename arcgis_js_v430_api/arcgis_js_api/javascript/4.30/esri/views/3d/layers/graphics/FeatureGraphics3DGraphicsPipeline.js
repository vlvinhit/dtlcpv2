// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../layers/graphics/hydratedFeatures ../../../../layers/graphics/controllers/FeatureTileController3D ../FeatureLayerViewPerformanceInfo ./Graphics3DGraphicsPipeline ../support/FeatureTileFetcher3DLayerViewContext ../../support/EventedSet ../../webgl-engine/lib/UpdatePolicy".split(" "),
function(c,d,l,g,e,w,x,y,m,n,p,q,r,t,u,k){c.FeatureGraphics3DGraphicsPipeline=class extends r.Graphics3DGraphicsPipeline{constructor(a){super(a);this._processorTotal=this._controllerTotal=0;this._needsRefresh=!1;this.suspendResumeExtentMode="data"}initialize(){this.addHandles(g.watch(()=>({controller:this.controller,suspended:this.suspended}),({controller:a,suspended:b})=>{a&&!b&&this._needsRefresh&&(a.refetch(),this._needsRefresh=!1)}))}destroy(){this._fetcherContext=l.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??
this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(a){this._set("maximumNumberOfFeatures",a);this.controller&&(this.controller.maximumNumberOfFeatures=a)}get maximumNumberOfFeaturesExceeded(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):!1}get updatingProgressValue(){let a=0;if(this.controller?.updating){var b=this.controller.updatingRemaining,f=Math.max(this.controller.updatingTotal,this._controllerTotal);0<f&&(a=(f-b)/f,this._controllerTotal=
f)}b=0;if(this.processor?.updating){f=this.processor.updatingRemaining;const h=Math.max(f,this._processorTotal);0<h&&(b=(h-f)/h,this._processorTotal=h)}return.5*(a+b)}get updatePolicy(){if(!this.controller)return k.UpdatePolicy.ASYNC;switch(this.controller.mode){case "snapshot":const a=v.get(this.layer.geometryType);return null==a||this.controller.serviceDataCount>a?k.UpdatePolicy.ASYNC:k.UpdatePolicy.SYNC;case "tiles":return k.UpdatePolicy.ASYNC}}get usedMemory(){return(this.processor?.usedMemory??
0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const a=this.controller?.expectedFeatureDiff??0,b=this.processor?.loadedFeatures??0;return(this.processor?.unprocessedMemoryEstimate??0)+a*(this.processor?.usedMemoryPerFeature??0)*(0<b+a?b/(b+a):1)}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){var a=this.controller?.displayFeatureLimit;a=null!=a?a.averageSymbolComplexity:void 0;return new q.FeatureLayerViewPerformanceInfo(super.performanceInfo,
this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",null!=a?`f:${a.verticesPerFeature},v:${a.verticesPerCoordinate}`:"n/a")}async doRefresh(a){const {controller:b,processor:f,suspended:h}=this;a&&b&&(h?this._needsRefresh=!0:(b.refetch(),this._needsRefresh=!1));f.refreshFilter()}setVisibility(a,b){this.processor?.setObjectIdVisibility(a,b)}getMissingAttributesForFeature(a){return this.controller.getMissingAttributesForFeature(a)}getHydratedGeometry(a){var b=
this.graphics3DProcessor;if(null==b)return null;b=b.graphics3DGraphicsByObjectID;if(null==b)return null;a=b.get(a);return null==a?null:n.hydrateGeometry(a.graphic.geometry)}createController(){this._fetcherContext=new t.FeatureTileFetcher3DLayerViewContext({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const a=new p.FeatureTileController3D({layerView:this.layerView,context:this._fetcherContext,graphics:new u.EventedSet,extent:this.clippingExtent});this.updatingHandles.add(()=>a.serviceDataExtent,
b=>{this.processor&&(this.processor.dataExtent=b)},g.initial);this.addHandles(g.watch(()=>this.suspended&&this.layerView.updateSuspended,b=>{b?a.suspend():a.resume()},g.syncAndInitial));this.updatingHandles.add(()=>this.processor?.displayFeatureLimit,b=>a.displayFeatureLimit=b,g.initial);this.addHandles(g.when(()=>!this.updating,()=>{this._processorTotal=this._controllerTotal=0}));return a}beforeSetController(a){a.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,
graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}};d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"layerView",void 0);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"controller",void 0);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"_controllerTotal",void 0);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"_processorTotal",
void 0);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"_needsRefresh",void 0);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeatures",null);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"maximumNumberOfFeaturesExceeded",null);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"updatingProgressValue",null);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,
"updatePolicy",null);d.__decorate([e.property()],c.FeatureGraphics3DGraphicsPipeline.prototype,"suspendResumeExtentMode",void 0);c.FeatureGraphics3DGraphicsPipeline=d.__decorate([m.subclass("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],c.FeatureGraphics3DGraphicsPipeline);const v=new Map([["point",5E3],["polygon",500],["polyline",1E3]]);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
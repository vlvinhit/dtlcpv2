// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/mathUtils ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/aaBoundingRect ../../../../chunks/boundedPlane ../../../../geometry/support/ray ../../../../chunks/sphere ./deconflictorDebug ./enums ../../webgl/RenderCamera ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/ScaleInfo".split(" "),
function(h,y,K,D,E,F,ja,ka,la,L,M,N,O,q,n,t,G,P,m,z,Q,u,A,p,R,S,H,T,U){function*I(a){if(Map.prototype.entries){a=a.entries();for(let d=a.next();!d.done;d=a.next())yield d.value[1]}else yield*a.values()}function*V(a,d,b){d.clear();a.forEach((c,e)=>{const g=d.pushNew();g.id=e;g.visible=c.graphics3DGraphic.getVisibilityFlag(b,p.VisibilityFlag.DECONFLICTION);e=c.info?.[b];g.prio=c.graphics3DGraphic.deconflictionPriority;g.distance=e?e.distance:Number.MAX_VALUE});yield;const f=d.iterableSort((c,e)=>c.prio!==
e.prio?e.prio-c.prio:c.distance!==e.distance?c.distance-e.distance:c.visible!==e.visible?c.visible?-1:1:c.id-e.id);for(let c=f.next();!c.done;c=f.next())yield;d.forAll(c=>{const e=a.get(c.id);e&&(a.delete(c.id),a.set(c.id,e))});d.clear()}const k=n.create(),r=G.create(),v=G.create(),B=n.create(),W=N.create(),X=u.create(),C=Q.create(),Y=n.create(),Z=m.create();class aa{constructor(){this.aabr=m.create();this.distance=0;this.visible=this.culled=!1}}class ba{constructor(a,d){this.graphics3DGraphic=a;
this.slicePlaneEnabled=d;this.info={}}}h.State=void 0;(function(a){a[a.Idle=0]="Idle";a[a.Process=1]="Process";a[a.Sort=2]="Sort";a[a.Deconflict=3]="Deconflict";a[a.NumStates=4]="NumStates"})(h.State||(h.State={}));class J{constructor(){this.camera=new R;this.slicePlane=z.create();this.slicePlaneEnabled=!1}copyFrom(a){this.camera.copyFrom(a.camera);z.copy(a.slicePlane,this.slicePlane);this.slicePlaneEnabled=a.slicePlaneEnabled}}h.Deconflictor=class extends K{get dirty(){return this._dirty}get state(){return this._state}constructor(a){super(a);
this._dirty=!1;this._viewState=new J;this._state=h.State.Idle;this._active=new Map;this._visible=new Map;this._iterators=new ca;this._accBinsNumX=15;this._accBinsNumY=20;this._accBinsSizeY=this._accBinsSizeX=0;this._accBins=null;this.accNumTests=0}destroy(){this._active.clear();this._visible.clear();this._iterators=null}setDirty(){!this._dirty&&0<this._active.size&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==h.State.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;
const a=this._state/h.State.NumStates;return this._dirty?.5*a:a}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(a){switch(this._state){case h.State.Idle:this._startUpdate(),a.madeProgress();case h.State.Process:if(this._state=h.State.Process,!this._processActiveGraphics(a))break;case h.State.Sort:if(this._state=h.State.Sort,!this._sortVisibleGraphics(a))break;case h.State.Deconflict:if(this._state=h.State.Deconflict,!this._deconflictVisibleGraphics(a))break;default:A.drawAccelerationStruct(this,
this._visible),this._state=h.State.Idle,this.notifyChange("updating")}}modifyGraphics(a,d){d?a.forEach(b=>this.addToActiveGraphics(b)):a.forEach(b=>this.removeFromActiveGraphics(b));this.setDirty()}layerSupportsDeconfliction(a){if(null==a||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?.geometries.length??0)&&a?.geometries[0]?.material instanceof T.HUDMaterial?!0:!1}_startUpdate(){A.prepare(this.view);this._dirty=!1;this._viewState.copyFrom(this.viewState);const {fullWidth:a,fullHeight:d}=
this._viewState.camera;this._initBins(a,d);this._resetIterators()}addToActiveGraphics(a){a.info[this.visibilityGroup]=new aa;this._active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()}removeFromActiveGraphics(a){this._visible.delete(a.graphics3DGraphic.graphic.uid);const d=a.graphics3DGraphic;d.destroyed||d.setVisibilityFlag(this.visibilityGroup,p.VisibilityFlag.DECONFLICTION,!0);delete a.info[this.visibilityGroup];this._active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()}_processActiveGraphics(a){const d=
this._ensureActiveGraphicsIterator(),b=M.invertOrIdentity(W,this._viewState.camera.projectionMatrix),f="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&0<this._viewState.camera.relativeElevation?X:null;let c=0;null!=f&&(q.transformMat4(u.getCenter(f),n.ZEROS,this._viewState.camera.viewMatrix),f[3]=P.getReferenceEllipsoid(this.view.spatialReference).radius,c=u.distanceToSilhouette(f,n.ZEROS));for(;!a.done;){a.madeProgress();var e=d.next();if(!0===e.done)return this._resetActiveGraphicsIterator(),
!0;e=e.value;const g=e?.info[this.visibilityGroup];g&&(this._collectGraphics3DGraphics(e,b,f,c),g.culled?this._visible.delete(e.graphics3DGraphic.graphic.uid):this._visible.set(e.graphics3DGraphic.graphic.uid,e))}return!1}_sortVisibleGraphics(a){const d=this._ensureSortGraphicsIterator();for(;!a.done;){const b=d.next();a.madeProgress();if(!0===b.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(a){const d=this._ensureVisibleGraphicsIterator(),b=this.visibilityGroup===
p.VisibilityGroup.LABEL;for(;!a.done;){a.madeProgress();var f=d.next();if(!0===f.done)return this._resetVisibleGraphicsIterator(),!0;f=f.value;const e=f.info[this.visibilityGroup];if(!e||e.culled)this._setGraphicVisibility(f,!1);else{var c=f.graphics3DGraphic;c=!b||c.isVisible();e.visible=c&&!this._isConflicted(f);e.visible&&this._addToBins(f);this._setGraphicVisibility(f,e.visible);A.drawPoly(e,e.visible)}}return!1}_resetIterators(){this._iterators.active=null;this._iterators.visible=null;this._iterators.sort=
null}_ensureActiveGraphicsIterator(){this._iterators.active||(this._iterators.active=I(this._active));return this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){this._iterators.visible||(this._iterators.visible=I(this._visible));return this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){this._iterators.sort||(this._iterators.sort=V(this._visible,this._iterators.sortArray,this.visibilityGroup));
return this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(a,d,b,f){var c=a.graphics3DGraphic;if(!c.destroyed){var e=a.info[this.visibilityGroup];if(c.isVisible(p.VisibilityGroup.GRAPHIC,p.VisibilityFlag.DECONFLICTION)){var g=this.getGraphicsLayers(c);m.empty(e.aabr);c=null;for(const x of g)if(this.layerSupportsDeconfliction(x)){g=x.stageObject.geometries[0].material;if(null==c){c=da;this._getProjectionInfo(x,d,c);var l;if(!(l=c.isOutsideScreen||
this._isCulledBySlice(a,k))&&(l=null!=b)){l=c;var w=b,ea=f;q.copy(C.direction,l.positionView);q.set(C.origin,0,0,0);l=u.intersectRay(w,C,Y)?l.distanceWithoutPolygonOffset>ea:!1}if(l){e.culled=!0;return}}this._expandBoundingRect(e,x,g,c)}null==c?e.culled=!0:(e.distance=c.distance,e.culled=!1)}else e.culled=!0}}_getProjectionInfo(a,d,b){const f=this._viewState.camera;a=a.stageObject;var c=a.geometries[0];const e=c.material;var g=u.getCenter(a.boundingVolumeWorldSpace.bounds);q.transformMat4(k,g,f.viewMatrix);
g=c.attributes;c=g.get(H.VertexAttribute.NORMAL).data;g=g.get(H.VertexAttribute.CENTEROFFSETANDDISTANCE).data;e.applyShaderOffsetsView(k,c,a.transformation,g,f,b.scaleInfo,k);t.set(r,k[0],k[1],k[2],1);t.transformMat4(v,r,f.projectionMatrix);q.scale(b.positionNDC,v,1/v[3]);e.applyShaderOffsetsNDC(b.positionNDC,g,f,b.positionNDC,B);b.distanceWithoutPolygonOffset=f.depthNDCToWorld(B[2]);b.distance=B[2]===b.positionNDC[2]?b.distanceWithoutPolygonOffset:f.depthNDCToWorld(b.positionNDC[2]);t.set(v,b.positionNDC[0],
b.positionNDC[1],b.positionNDC[2],1);t.transformMat4(r,v,d);t.scale(r,r,1/r[3]);q.set(b.positionView,k[0],k[1],k[2])}_isCulledBySlice(a,d){return a.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&z.extrusionContainsPoint(this._viewState.slicePlane,d)}_expandBoundingRect(a,d,b,{positionNDC:f,scaleInfo:c}){const e=this._viewState.camera;d=d.getScreenSize(fa);S.applyPrecomputedScaleFactor(d,c.factor,d);d[0]*=e.pixelRatio;d[1]*=e.pixelRatio;b=m.offset(b.calculateRelativeScreenBounds(d,c.factorAlignment.scale,
Z),D.lerp(0,e.fullWidth,.5+.5*f[0]),D.lerp(0,e.fullHeight,.5+.5*f[1]));f=this.marginFactor;0!==f&&(f*=Math.min(m.width(b),m.height(b)),b[0]-=f,b[1]-=f,b[2]+=f,b[3]+=f);m.expand(a.aabr,b,a.aabr)}_isConflicted(a){const d=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];let b=!0;for(let f=Math.floor(a.aabr[0]/this._accBinsSizeX);f<=Math.floor(a.aabr[2]/this._accBinsSizeX);f++)if(!(0>f||f>=this._accBinsNumX))for(let c=Math.floor(a.aabr[1]/this._accBinsSizeY);c<=Math.floor(a.aabr[3]/this._accBinsSizeY);c++){if(0>
c||c>=this._accBinsNumY)continue;b=!1;const e=this._accBins[f][c];for(let g=0;g<e.length;g++){const l=e.data[g],w=l.info[this.visibilityGroup];if(w&&w.visible&&l.graphics3DGraphic.graphic.uid!==d&&(this.accNumTests++,m.intersects(w.aabr,a.aabr)))return!0}}return b}_initBins(a,d){if(null==this._accBins){this._accBins=[];for(var b=0;b<this._accBinsNumX;b++){this._accBins.push([]);var f=this._accBins[this._accBins.length-1];for(let c=0;c<this._accBinsNumY;c++)f.push(new E)}}else for(b=0;b<this._accBinsNumX;b++)for(f=
0;f<this._accBinsNumY;f++)this._accBins[b][f].clear();this._accBinsSizeX=a/this._accBinsNumX;this._accBinsSizeY=d/this._accBinsNumY;this.accNumTests=0}_addToBins(a){var d=a.info[this.visibilityGroup],b=Math.floor(d.aabr[0]/this._accBinsSizeX);const f=Math.floor(d.aabr[2]/this._accBinsSizeX),c=Math.floor(d.aabr[1]/this._accBinsSizeY);for(d=Math.floor(d.aabr[3]/this._accBinsSizeY);b<=f;b++)if(!(0>b||b>=this._accBinsNumX))for(let e=c;e<=d;e++)0>e||e>=this._accBinsNumY||this._accBins[b][e].push(a)}_setGraphicVisibility(a,
d){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(this.visibilityGroup,p.VisibilityFlag.DECONFLICTION,d),this.visibilityGroup===p.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(a,d))}};y.__decorate([F.property({constructOnly:!0})],h.Deconflictor.prototype,"view",void 0);y.__decorate([F.property({type:Boolean,readOnly:!0})],h.Deconflictor.prototype,"updating",null);h.Deconflictor=y.__decorate([L.subclass("esri.views.3d.layers.graphics.Deconflictor")],h.Deconflictor);class ha{constructor(){this.id=
0;this.visible=!1;this.distance=this.prio=0}}class ca{constructor(a=null,d=null,b=null){this.active=a;this.visible=d;this.sort=b;this.sortArray=new E({allocator:f=>f||new ha})}}const fa=O.create();class ia{constructor(){this.positionView=n.create();this.positionNDC=n.create();this.distanceWithoutPolygonOffset=this.distance=0;this.scaleInfo=new U.ScaleInfo}get isOutsideScreen(){const a=this.positionNDC;return-1>a[0]||-1>a[1]||-1>a[2]||1<=a[0]||1<=a[1]}}const da=new ia;h.DeconflictorGraphic=ba;h.DeconflictorViewState=
J;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
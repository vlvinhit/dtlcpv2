// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/support/UpdatingHandles ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ../graphics/QueryEngine ../../../support/Scheduler ../../../support/Yield".split(" "),
function(a,c,l,m,n,h,k,p,d,y,z,q,r,t,u,v,w,x){a.FeatureVisibilityFilter=class extends l{constructor(e){super(e);this._queryEngine=this._frameTask=this._updateTask=null;this._updateRequested=!0;this._updatingHandles=new r.UpdatingHandles;this._updateVisibility=async f=>{if(null==this._compositedFeatureFilter&&null==this._sceneFilter||0===this.context.getFeatureCount())return await this._frameTask.schedule(()=>this.clear(),f);try{const b=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,
this._sceneFilter,f);k.throwIfAborted(f);return await this._frameTask.schedule(()=>{this.context.updateFeatureVisibilities(g=>b.has(g))},f)}catch(b){return k.throwIfAbortError(b),n.getLogger(this).warn(`FeatureFilter query failed: ${b}`,{error:b}),await this._frameTask.schedule(()=>{this.context.setAllFeaturesVisibility(!0)},f)}}}initialize(){const e=w.TaskPriority.FILTER_VISIBILITY,{layer:f,view:b}=this._configuration,{featureStore:g}=this.context;this._queryEngine=new v.QueryEngine({context:{spatialReference:b.spatialReference,
layer:f,scheduler:b.resourceController.scheduler,featureStore:g,hasM:this._configuration.hasM??!1,hasZ:this._configuration.hasZ??!1},priority:e});this._frameTask=b.resourceController.scheduler.registerTask(e,this);this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),p.initial)}destroy(){this._updateRequested=!1;this._updatingHandles.destroy();this.clear();this._updateTask=h.abortMaybe(this._updateTask);this._frameTask=h.removeMaybe(this._frameTask);this._queryEngine=
h.destroyMaybe(this._queryEngine);this._set("context",null)}get updating(){return this.running||this._updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:
null}get _floorFilter(){return u.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const {_featureFilter:e,_timeExtent:f,_floorFilter:b}=this;if(null==f&&null==b)return e;const g=null!=e?e.clone():new t;null!=f&&(g.timeExtent=null!=g.timeExtent?g.timeExtent.intersection(f):f);null!=b&&(g.where=null==g.where||""===g.where?b:`(${g.where}) AND (${b})`);return g}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=
!0}clear(){this._queryEngine.clear();this.context.clearFeaturesVisibility()}runTask(e){this._updateRequested&&(this._updateTask=h.abortMaybe(this._updateTask),this._updateTask=m.createTask(this._updateVisibility),this._updateRequested=!1,e.madeProgress());this._frameTask.processQueue(e);if(!e.hasProgressed)return x.Yield}};c.__decorate([d.property({constructOnly:!0})],a.FeatureVisibilityFilter.prototype,"context",void 0);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"updating",null);
c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"running",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"defaultVisibility",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_featureFilter",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_sceneFilter",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_floorFilter",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_timeExtent",
null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_configuration",null);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_updateTask",void 0);c.__decorate([d.property()],a.FeatureVisibilityFilter.prototype,"_updateRequested",void 0);a.FeatureVisibilityFilter=c.__decorate([q.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],a.FeatureVisibilityFilter);
Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/devEnvironmentUtils ../../../../core/mathUtils ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec2 ../../../../chunks/vec33 ../../../../chunks/vec43 ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ProcessedObjectResource ./wosrLoader ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../webgl-engine/materials/pbrUtils".split(" "),
function(O,ca,W,X,da,ea,fa,ha,A,R,S,P,E,G,T,ia,ja,ka,la,ma,na,U,K,oa,Y,Z,L,F,pa,qa,M,V,H,Q){function aa(g){const b=g.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return b?{fileType:"gltf",url:b[1],specifiedLodIndex:null!=b[4]?Number(b[4]):null}:g.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:g,specifiedLodIndex:null}:{fileType:"unknown",url:g,specifiedLodIndex:null}}function ba(g,b,k,u){const B=g.model,x=[],f=new Map,v=new Map,a=B.lods.length,h=S.empty();B.lods.forEach((w,l)=>{const m=!0===
u.skipHighLods&&(1<a&&0===l||3<a&&1===l)||!1===u.skipHighLods&&null!=u.singleLodIndex&&l!==u.singleLodIndex;if(!m||0===l){var p=new oa.ProcessedObjectResource(w.name,w.lodThreshold,[0,0,0]);w.parts.forEach(c=>{const e=m?new V.DefaultMaterial({}):ra(B,c,p,b,k,f,v);var C=null!=e?e:new V.DefaultMaterial({});const q=c.attributes.position.count,t=na.convertPrimitiveToTriangles(c.indices||q,c.primitiveType);var n=P.newFloatArray(3*q);const {typedBuffer:z,typedBufferStride:y}=c.attributes.position;G.transformMat4(n,
z,c.transform,3,y);n=[[M.VertexAttribute.POSITION,new L.Attribute(n,t,3,!0)]];if(null!=c.attributes.normal){var d=P.newFloatArray(3*q);const {typedBuffer:r,typedBufferStride:N}=c.attributes.normal;X.normalFromMat4(I,c.transform);G.transformMat3(d,r,I,3,N);W.hasScaling(I)&&G.normalize(d,d);n.push([M.VertexAttribute.NORMAL,new L.Attribute(d,t,3,!0)])}if(null!=c.attributes.tangent){d=P.newFloatArray(4*q);const {typedBuffer:r,typedBufferStride:N}=c.attributes.tangent;X.fromMat4(I,c.transform);T.transformMat3(d,
r,I,4,N);W.hasScaling(I)&&G.normalize(d,d,4);n.push([M.VertexAttribute.TANGENT,new L.Attribute(d,t,4,!0)])}if(null!=c.attributes.texCoord0){d=P.newFloatArray(2*q);const {typedBuffer:r,typedBufferStride:N}=c.attributes.texCoord0;ia.normalizeIntegerBuffer(d,r,2,N);n.push([M.VertexAttribute.UV0,new L.Attribute(d,t,2,!0)])}d=c.attributes.color;if(null!=d){const r=new Uint8Array(4*q);4===d.elementCount?d instanceof E.BufferViewVec4f?T.scale(r,d,255):d instanceof E.BufferViewVec4u8?ka.copy(r,d):d instanceof
E.BufferViewVec4u16&&T.scale(r,d,1/256):(r.fill(255),d instanceof E.BufferViewVec3f?G.scale(r,d.typedBuffer,255,4,d.typedBufferStride):c.attributes.color instanceof E.BufferViewVec3u8?ja.copy(r,d.typedBuffer,4,c.attributes.color.typedBufferStride):c.attributes.color instanceof E.BufferViewVec3u16&&G.scale(r,d.typedBuffer,1/256,4,d.typedBufferStride));n.push([M.VertexAttribute.COLOR,new L.Attribute(r,t,4,!0)])}c={geometry:new pa.Geometry(C,n),vertexCount:q};const {geometry:J,vertexCount:D}=c;c=J.boundingInfo;
null!=c&&0===l&&(S.expandWithVec3(h,c.bbMin),S.expandWithVec3(h,c.bbMax));null!=e&&(p.stageResources.geometries.push(J),p.numberOfVertices+=D)});m||x.push(p)}});return{engineResources:x,referenceBoundingBox:h}}function ra(g,b,k,u,B,x,f){const v=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),a=g.materials.get(b.material);var h=null!=b.attributes.texCoord0;const w=null!=b.attributes.normal;
if(null==a)return null;a:{switch(a.alphaMode){case "BLEND":var l=F.AlphaDiscardMode.Blend;break a;case "MASK":l=F.AlphaDiscardMode.Mask;break a;case "OPAQUE":case null:case void 0:l=F.AlphaDiscardMode.Opaque;break a}l=void 0}if(!x.has(v)){if(h){var m=(y,d=!1)=>{if(null!=y&&!f.has(y)){const J=g.textures.get(y);if(null!=J){const D=J.data;f.set(y,new qa.Texture(U.isEncodedMeshTexture(D)?D.data:D,{...J.parameters,preMultiplyAlpha:U.isEncodedMeshTexture(D)?!1:d,encoding:U.isEncodedMeshTexture(D)&&null!=
D.encoding?D.encoding:void 0}))}}};m(a.textureColor,l!==F.AlphaDiscardMode.Opaque);m(a.textureNormal);m(a.textureOcclusion);m(a.textureEmissive);m(a.textureMetallicRoughness)}m=a.color[0]**(1/H.colorGamma);const p=a.color[1]**(1/H.colorGamma),c=a.color[2]**(1/H.colorGamma),e=a.emissiveFactor[0]**(1/H.colorGamma),C=a.emissiveFactor[1]**(1/H.colorGamma),q=a.emissiveFactor[2]**(1/H.colorGamma),t=null!=a.textureColor&&h?f.get(a.textureColor):null,n=Q.useSchematicPBR({normalTexture:a.textureNormal,metallicRoughnessTexture:a.textureMetallicRoughness,
metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion}),z=null!=a.normalTextureTransform?.scale?a.normalTextureTransform?.scale:ha.ONES;x.set(v,new V.DefaultMaterial({...u,transparent:l===F.AlphaDiscardMode.Blend,customDepthTest:F.DepthTestFunction.Lequal,textureAlphaMode:l,textureAlphaCutoff:a.alphaCutoff,diffuse:[m,p,c],ambient:[m,p,c],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",
cullFace:a.doubleSided?F.CullFaceOptions.None:F.CullFaceOptions.Back,hasVertexColors:!!b.attributes.color,hasVertexTangents:!!b.attributes.tangent,normalType:w?Z.NormalType.Attribute:Z.NormalType.ScreenDerivative,castShadows:!0,receiveShadows:a.receiveShadows,receiveAmbientOcclusion:a.receiveAmbientOcclustion,textureId:null!=t?t.id:void 0,colorMixMode:a.colorMixMode,normalTextureId:null!=a.textureNormal&&h?f.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:null!=t&&!!t.parameters.preMultiplyAlpha,
occlusionTextureId:null!=a.textureOcclusion&&h?f.get(a.textureOcclusion).id:void 0,emissiveTextureId:null!=a.textureEmissive&&h?f.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=a.textureMetallicRoughness&&h?f.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[e,C,q],mrrFactors:n?[...Q.defaultSchematicMRRFactors]:[a.metallicFactor,a.roughnessFactor,u.mrrFactors[2]],isSchematic:n,colorTextureTransformMatrix:K.getTransformMatrix(a.colorTextureTransform),normalTextureTransformMatrix:K.getTransformMatrix(a.normalTextureTransform),
scale:[z[0],z[1]],occlusionTextureTransformMatrix:K.getTransformMatrix(a.occlusionTextureTransform),emissiveTextureTransformMatrix:K.getTransformMatrix(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:K.getTransformMatrix(a.metallicRoughnessTextureTransform),...B}))}b=x.get(v);k.stageResources.materials.push(b);h&&(h=p=>{null!=p&&k.stageResources.textures.push(f.get(p))},h(a.textureColor),h(a.textureNormal),h(a.textureOcclusion),h(a.textureEmissive),h(a.textureMetallicRoughness));
return b}const I=da.create();O.fetch=async function(g,b){g=aa(ca.adjustStaticAGOUrl(g));if("wosr"===g.fileType){g=await (b.cache?b.cache.loadWOSR(g.url,b):Y.load(g.url,b));const {engineResources:w,referenceBoundingBox:l}=Y.processLoadResult(g,b);return{lods:w,referenceBoundingBox:l,isEsriSymbolResource:!1,isWosr:!0}}const k=await (b.cache?b.cache.loadGLTF(g.url,b,!!b.usePBR):ma.loadGLTF(new la.DefaultLoadingContext(b.streamDataRequester),g.url,b,b.usePBR)),u=k.model.meta?.ESRI_proxyEllipsoid,B=k.meta.isEsriSymbolResource&&
null!=u&&"EsriRealisticTreesStyle"===k.meta.ESRI_webstyle;if(B&&!k.customMeta.esriTreeRendering){k.customMeta.esriTreeRendering=!0;a:for(let w=0;w<k.model.lods.length;++w){var x=k.model.lods[w];for(var f of x.parts){x=f.attributes.normal;if(null==x)break a;const l=f.attributes.position,m=l.count,p=R.create(),c=R.create(),e=R.create(),C=new Uint8Array(4*m),q=new Float64Array(3*m),t=ea.invert(fa.create(),f.transform);let n=0,z=0;for(let y=0;y<m;y++){l.getVec(y,c);x.getVec(y,p);A.transformMat4(c,c,f.transform);
A.subtract(e,c,u.center);A.divide(e,e,u.radius);const d=e[2];var v=A.length(e);v=Math.min(.45+.55*v*v,1);A.divide(e,e,u.radius);null!==t&&A.transformMat4(e,e,t);A.normalize(e,e);w+1!==k.model.lods.length&&1<k.model.lods.length&&(-1<d?A.lerp(e,e,p,.2):A.lerp(e,e,p,Math.min(-4*d-3.8,1)));q[n]=e[0];q[n+1]=e[1];q[n+2]=e[2];n+=3;C[z]=255*v;C[z+1]=255*v;C[z+2]=255*v;C[z+3]=255;z+=4}f.attributes.normal=new E.BufferViewVec3f(q);f.attributes.color=new E.BufferViewVec4u8(C)}}}f=!!b.usePBR;f=k.meta.isEsriSymbolResource?
{usePBR:f,isSchematic:!1,treeRendering:B,mrrFactors:[...Q.defaultEsriSymbologyMRRFactors]}:{usePBR:f,isSchematic:!1,treeRendering:!1,mrrFactors:[...Q.defaultAdvancedMRRFactors]};const {engineResources:a,referenceBoundingBox:h}=ba(k,f,{...b.materialParameters,treeRendering:B},b.skipHighLods&&null==g.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:g.specifiedLodIndex});return{lods:a,referenceBoundingBox:h,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1}};O.gltfToEngineResources=
ba;O.parseUrl=aa;Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});
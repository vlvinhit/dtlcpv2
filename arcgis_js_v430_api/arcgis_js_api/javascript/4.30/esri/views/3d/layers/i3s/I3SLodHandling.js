// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define(["../../../../core/PooledArray","./I3SNode","../support/I3SLayerView"],function(v,r,t){class w{constructor(a){this._layerView=a;this._lodGlobalDirty=!1}startNodeLoading(a,b,c){this._maxLodLevel=c.maxLodLevel;this._index=b;this._removeNodes=a}shouldLoadNode(a){if(null==a)return!1;const b=this._index.nodeTraversalState(a);return this._isChosenMaxLOD(b)?!0:b.isChosen?this._childrenRequireLoading(a):!1}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&
!0===this._lodGlobalDirty}lodGlobalHandling(a){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var b=Math.max(0,Math.floor(10*(this._layerView.view.resourceController.memoryController.usedMemory-1)));d.clear();this._lodGlobalHandling(this._index.rootNode,b,!1,!!this._layerView.nodeCrossfadingEnabled);b=d.length;this._removeNodes(d,a);a=d.length<b;0!==d.length&&(this._lodGlobalDirty=!0);d.clear();return a}_lodGlobalHandling(a,b,c,e){if(null==a)return!1;const f=a.index,n=this._index,
k=this._layerView;var g=n.nodeTraversalState(a);g=this._isChosenMaxLOD(g);var h=a.resources.isEmpty;if(g&&h)return 0<a.childrenLoaded&&this._removeChildrenRecursive(a),!0;h=k.isNodeLoaded(f);if(e&&h&&g){var l=!c&&this.hasNoVisibleChildren(a);k.fadeNode(f,t.FadeDirection.FadeIn,!l)}l=h&&(!k.isNodeFullyFadedIn||k.isNodeFullyFadedIn(f));if(h&&(k.updateNodeState(f,g?r.NodeState.Leaf:r.NodeState.Hole),g))return l&&this._removeChildrenRecursive(a),l;var m=0<a.childCount;let p=m;if(m)for(m=0;m<a.childCount;m++){const q=
n.getChildIndex(f,m),u=n.getNode(q);null!=u?n.isGeometryVisible(q)&&!this._lodGlobalHandling(u,b,c||l,e)&&(p=!1):n.isNodeVisible(q)&&(p=!1)}(b=h&&!g&&(p||d.length<b))&&d.push(f);!e||b||!h||c||p||k.fadeNode(f,t.FadeDirection.FadeIn,!1);a=a.resources.isEmpty;return p||l&&!b||a}_removeChildrenRecursive(a){this._index.traverseDescendants(a,b=>{(this._layerView.isNodeLoaded(b.index)||this._layerView.isNodeReloading(b.index))&&d.push(b.index);return 0<b.childrenLoaded})}hasNoVisibleChildren(a){let b=!0;
this._index.traverseDescendants(a,c=>b&&this._index.isNodeVisible(c.index)?this._layerView.isNodeLoaded(c.index)?b=!1:0<c.childrenLoaded:!1);return b}_childrenRequireLoading(a){let b=!1,c=!0;this._index.traverseDescendants(a,e=>{if(!c||!this._index.isNodeVisible(e.index))return!1;const f=this._index.nodeTraversalState(e);this._isChosenMaxLOD(f)&&this._index.isGeometryVisible(e.index)&&(b=!0);return this._layerView.isNodeLoaded(e.index)?c=!1:0<e.childrenLoaded});return c&&b}_isChosenMaxLOD(a){return a.isChosen&&
(!a.nodeHasLOD||a.lodLevel===this._maxLodLevel)}}const d=new v({deallocator:null});return w});
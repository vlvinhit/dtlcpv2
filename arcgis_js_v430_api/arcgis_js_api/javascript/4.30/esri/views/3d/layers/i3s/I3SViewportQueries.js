// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/spatialReferenceEllipsoidUtils ../../../../geometry/projection/projectBoundingSphere ../../../../geometry/projection/projectors ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/spatialReferenceUtils ../../../../chunks/sphere ../../../../layers/graphics/dehydratedPoint ../../../ViewingMode ../graphics/elevationAlignmentUtils ../graphics/ElevationContext ../graphics/featureExpressionInfoUtils ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),
function(e,h,v,I,J,A,K,L,w,q,M,p,N,z,B,O,C,r,t,x){class P{get _frustumMbsCenter(){return this._frustumMbs}get _frustumMbsRadius(){return this._frustumMbs[3]}get _frustumPlanes(){return this._frustum}constructor(a,b,c,d,f,g,l,k,m={}){this._indexSR=a;this._renderCoordsHelper=b;this._clippingArea=f;this._elevationProvider=g;this._viewingMode=l;this._options=m;this._frustum=w.create();this._frustumMbs=I.create();this._useFrustumCulling=!1;this._poi=h.create();this._elevationContext=null;this.minDistance=
Infinity;this.maxDistance=0;this.maxLodLevel=2;this._tmpObb=new x.Obb;this._tmp1=h.create();this._tmp2=h.create();this._tmp3=h.create();this._tmp0=h.create();this._screenspaceErrorBias=m.screenspaceErrorBias||1;this._progressiveLoadFactor=m.progressiveLoadFactor||1;this.updateCamera(c,d);this._renderSR=b=this._renderCoordsHelper.spatialReference;this._renderSRSphericalPCPF=A.getSphericalPCPF(b);this._isGlobalMode=b===this._renderSRSphericalPCPF;this.updateElevationInfo(k);this._tmpPoint=N.makeDehydratedPoint(0,
0,0,a);this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(b.isWebMercator||M.isPlateCarree(b));this._indexSREllipsoidRadius=J.getReferenceEllipsoid(this._indexSR).radius;this._indexSRSphericalPCPF=A.getSphericalPCPF(a);this._projectorIndexSRToIndexSRSphericalPCPF=L.getProjector(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(a){null==a?this._elevationContext=null:(this._elevationContext=O.ElevationContext.fromElevationInfo(a),this._elevationContext.updateFeatureExpressionInfoContext(C.createContextWithoutExpressionSupport(C.extractExpressionInfo(a,
!1))))}updateCamera(a,b){if(this._useFrustumCulling=b){w.fromMatrix(a.viewMatrix,a.projectionMatrix,this._frustum,D);b=a.eye;const f=Q;e.normalize(f,a.viewForward);var c=R;e.sub(c,D[4],b);var d=e.dot(c,c);c=e.dot(f,c);d=.5*d/c;c=this._frustumMbs;e.scaleAndAdd(c,b,f,d);c[3]=1+d}this._screenSizeFactor=1/(a.perScreenPixelRatio/2);this._camPos=a.eye;this.minDistance=Infinity;this.maxDistance=0}setPointOfInterest(a){this._poi=a}updateScreenSpaceErrorBias(a){const b=this._screenspaceErrorBias;this._screenspaceErrorBias=
a;return b}updateClippingArea(a){this._clippingArea=a}expandElevationRange(a,b,c){if(null!=this._elevationContext&&(a=a.serviceMbsInIndexSR)){var d="relative-to-scene"===this._elevationContext.mode?"scene":"ground";this._elevationProvider.getSphereElevationBounds?(b=this._elevationProvider.getSphereElevationBounds(a,this._indexSR,d))&&c.expandElevationRange(b):((a=this._elevationProvider.getElevation(a[0],a[1],a[2],this._indexSR,d))&&c.expandElevationRangeValues(a,a),(b=b?null:this._elevationProvider.getRootElevationBounds?.())&&
c.expandElevationRange(b))}}getServiceMbsInRenderSR(a){const b=a.serviceMbsInRenderSR;if(t.isValidMbs(b))return b;a.serviceMbsInIndexSR&&v.copy(b,a.serviceMbsInIndexSR);const c=a.elevationRangeMin;if(this._elevationContext&&Number.isFinite(c)){let d=0,f=0;a=a.elevationRangeMax;switch(this._elevationContext.mode){case "relative-to-ground":case "relative-to-scene":d=this._elevationContext.geometryZWithOffset(b[2],this._renderCoordsHelper)+c-b[2];f=a-c;break;case "on-the-ground":d=c-b[2],f=a-c}b[2]+=
d+.5*f;b[3]+=.5*f}else this._elevationContext&&1E5>b[3]&&(this._tmpPoint.x=b[0],this._tmpPoint.y=b[1],this._tmpPoint.z=b[2],b[2]=B.evaluateElevationAlignmentAtPoint(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));K.projectBoundingSphere(b,this._indexSR,b,this._renderSR);return b}getAndUpdateVisibilityObbInRenderSR(a){var b=a.visibilityObbInRenderSR;if(b)return b;b=.01*this._indexSREllipsoidRadius;const {serviceMbsInIndexSR:c,serviceObbInIndexSR:d}=a;if(null==
d||!c||!d.isValid||this._isECEFOBBInLocalMode&&(d.halfSizeX>b||d.halfSizeY>b||d.halfSizeZ>b))return null;b=a.serviceObbInRenderSR;if(null==b)b=new x.Obb,a.serviceObbInRenderSR=b;else if(b.isValid)return b;var f=c[3],g=0;let l=0;var k=d.centerZ;const m=this._renderCoordsHelper,n=this._elevationContext;if(n&&a.elevationRangeValid)switch(f=a.elevationRangeMin,a=a.elevationRangeMax,n.mode){case "relative-to-ground":case "relative-to-scene":g=n.geometryZWithOffset(k,m)+f-k;l=a-f;break;case "on-the-ground":g=
f-k,l=a-f}else n&&1E5>f&&(g=this._tmpPoint,g.x=d.centerX,g.y=d.centerY,g.z=k,g=B.evaluateElevationAlignmentAtPoint(g,this._elevationProvider,n,m)-k);k=(a=0<l)?this._tmpObb:b;d.transform(k,this._indexSR,this._renderSR,g,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF);a&&x.computeOffsetObb(k,0,l,this._viewingMode,b);return b}getNodeObbInRenderSRIndependentOfElevationOffset(a){const b=a.visibilityObbInRenderSR??a.serviceObbInRenderSR??null;if(b?.isValid)return b;
a=a.serviceObbInIndexSR;if(!a)return null;a.transform(E,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF);return E}ensureElevationAgnosticBoundingVolume(a){-1===a.elevationAgnosticBoundingVolume[3]&&0<a.level&&(this._viewingMode===z.ViewingMode.Global?this._updateElevationAgnosticBoundingVolumeGlobal(a):this._updateElevationAgnosticBoundingVolumeLocal(a));return a.elevationAgnosticBoundingVolume}_updateElevationAgnosticBoundingVolumeGlobal(a){var b=
this.getNodeObbInRenderSRIndependentOfElevationOffset(a);const c=a.elevationAgnosticBoundingVolume;var d=-1;if(b){const g=y;b.getCenter(g);e.normalize(g,g);a=g;b.getCorners(u);for(var f of u){e.normalize(f,f);b=e.dot(f,g);if(0>=b){c[3]=-1;return}d=Math.max(d,Math.sqrt(1-b*b))}}else if(d=a.serviceMbsInRenderSR,t.isValidMbs(d)){f=e.copy(y,p.getCenter(d));d=d[3];b=e.len(f);if(b<d){c[3]=-1;return}d/=b;e.normalize(f,f);a=f}else{c[3]=-1;return}v.copyVec3(c,a);c[3]=d+.001}_updateElevationAgnosticBoundingVolumeLocal(a){const b=
a.elevationAgnosticBoundingVolume;var c=this.getNodeObbInRenderSRIndependentOfElevationOffset(a);if(c){a=c.getCenter(y);a[2]=0;v.copyVec3(b,a);a=0;const f=S;c.getCorners(u);for(var d of u)d[2]=0,c=e.sqrDist(f,d),a=Math.max(a,c);b[3]=Math.sqrt(a)}else d=a.serviceMbsInRenderSR,t.isValidMbs(d)&&(c=e.copy(y,p.getCenter(d)),c[2]=0,v.copyVec3(b,c),b[3]=d[3])}isNodeVisible(a){const b=this.getServiceMbsInRenderSR(a);return this._isMBSinClippingArea(b)?this._useFrustumCulling?(a=this.getAndUpdateVisibilityObbInRenderSR(a))?
a.doesIntersectFrustumConservativeApproximation(this._frustum):w.intersectsSphere(this._frustum,p.wrap(b)):!0:!1}isElevationAgnosticBoundingVolumeVisible(a){return this._useFrustumCulling&&-1!==a[3]?this._viewingMode===z.ViewingMode.Global?this._isConeVisibleInFrustum(a):this._isCylinderVisibleInFrustum(a):!0}_isConeVisibleInFrustum(a){if(!this._isConeVisibleInFrustumMbs(a))return!1;var b=a[3];if(-1===b||.9<b)return!0;var c=this._frustumPlanes,d=e.dot(a,this._frustumMbsCenter),f=this._frustumMbsRadius;
const g=d-f;d+=f;if(0>=g)return!0;f=e.scale(T,a,g);const l=e.scale(U,a,d);b/=Math.sqrt(1-b*b);for(const m of c){c=q.getNormal(m);var k=e.normalize(V,c);const n=e.dot(k,a);if(!(.01>Math.abs(1-n)||(c=W,e.scale(c,a,n),e.sub(c,c,k),e.normalize(c,c),k=X,e.scaleAndAdd(k,f,c,g*b),0>=q.signedDistance(m,k)||(e.scaleAndAdd(k,l,c,d*b),0>=q.signedDistance(m,k)))))return!1}return!0}_isConeVisibleInFrustumMbs(a){const b=a[3];if(.9<b)return!0;var c=this._frustumMbsRadius,d=this._frustumMbsCenter;const f=e.len(d);
if(f<=c)return!0;var g=e.dot(a,d);a=e.scale(F,a,g);if(e.dist(a,d)<c)return!0;d=g/f;if(0>=g)return-d<c;g=Math.sqrt(1-d*d);if(g<b)return!0;c/=f;return g*Math.sqrt(1-c*c)-c*d<b}isObbVisibleIndependentOfElevation(a,b){if(!this._useFrustumCulling||-1===a[3])return!0;var c=this._frustumMbsRadius,d=this._frustumMbsCenter,f=this._frustumPlanes;const g=u;b.getCorners(g);if(this._viewingMode===z.ViewingMode.Global){var l=e.dot(a,d),k=l-c;l+=c;if(0>=k)return!0;for(var m of f){f=!0;for(var n of g){c=e.dot(n,
a);d=G;e.scale(d,n,k/c);if(0>=q.signedDistance(m,d)){f=!1;break}d=G;e.scale(d,n,l/c);if(0>=q.signedDistance(m,d)){f=!1;break}}if(f)return!1}}else{a=d[2]-c;m=d[2]+c;for(k of f){n=!0;d=q.getNormal(k);f=d[0];c=d[1];d=d[2];b=k[3];for(l of g){const H=f*l[0]+c*l[1]+b;if(0>=H+d*a||0>=H+d*m){n=!1;break}}if(n)return!1}}return!0}_isCylinderVisibleInFrustum(a){const b=this._frustumMbsRadius,c=e.copy(F,this._frustumMbsCenter);c[2]=0;const d=a[3];return e.dist(c,a)<=d+b}isGeometryVisible(a){return this._useFrustumCulling?
a.geometryObbInRenderSR?.doesIntersectFrustumConservativeApproximation(this._frustum)??this.isNodeVisible(a):!0}_isMBSinClippingArea(a){return null==this._clippingArea?!0:t.intersectBoundingRectWithMbs(this._clippingArea,a)!==t.MbsIntersectResult.OUTSIDE}_screenSpaceDiameterMbs(a,b){var c=this.getServiceMbsInRenderSR(a);a=Math.sqrt(e.squaredDistance(p.getCenter(c),this._camPos));c=a-c[3];this._updateMinMaxDistance(a);return 0>c?.5*Number.MAX_VALUE:b/c*this._screenSizeFactor}calcCameraDistance(a){return this.calcCameraDistanceToCenter(a)-
this.getServiceMbsInRenderSR(a)[3]}calcCameraDistanceToCenter(a){a=this.getServiceMbsInRenderSR(a);a=e.distance(p.getCenter(a),this._camPos);this._updateMinMaxDistance(a);return a}calcAngleDependentLoD(a){a=this.getServiceMbsInRenderSR(a);const b=a[3];a=(Math.abs(a[0]*(a[0]-this._camPos[0])+a[1]*(a[1]-this._camPos[1])+a[2]*(a[2]-this._camPos[2]))/e.length(p.getCenter(a))+b)/e.distance(p.getCenter(a),this._camPos);return Math.min(1,a)}hasLOD(a){return a.lodMetric!==r.LodMetric.None}_getDistanceGlobeMode(a,
b){var c=e.length(p.getCenter(b));const d=e.length(a)-c;e.scale(this._tmp0,a,e.dot(a,p.getCenter(b))/e.squaredLength(a));var f=e.squaredDistance(p.getCenter(b),this._tmp0),g=b[3];if(f<=g*g)return Math.abs(d);b=e.scale(this._tmp0,p.getCenter(b),1/c);c=e.scale(this._tmp1,b,c-g*g/2/c);f=e.subtract(this._tmp2,a,c);f=e.subtract(this._tmp2,f,e.scale(this._tmp3,b,e.dot(b,f)));c=e.add(this._tmp2,c,e.scale(this._tmp2,f,g/e.length(f)));g=e.distance(a,c);2E5<=d&&(a=e.subtract(this._tmp1,a,c),a=e.dot(a,b)/e.length(a),
.08>a&&(a=1E-4),g/=a);return g}_getDistance(a,b){if(this._isGlobalMode)return this._getDistanceGlobeMode(a,b);{var c=a[0]-b[0];const d=a[1]-b[1];a=a[2]-b[2];c=c*c+d*d;b=b[3];c<=b*b?a=Math.abs(a):(b=Math.sqrt(c)-b,a=Math.sqrt(a*a+b*b))}return a}_updateMinMaxDistance(a){0<a?(this.minDistance=Math.min(this.minDistance,a),this.maxDistance=Math.max(this.maxDistance,a)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-a))}getLodLevel(a){if(a.lodMetric===r.LodMetric.None)return 0;if(0===a.childCount)return this.maxLodLevel;
if(this._useFrustumCulling&&1>this._progressiveLoadFactor){const b=this._screenspaceErrorBias;return this.evaluateLODmetric(a,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(a,b)?2:1:0}return this.evaluateLODmetric(a,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(a,b){switch(a.lodMetric){case r.LodMetric.ScreenSpaceRelative:const c=this.getServiceMbsInRenderSR(a),d=this._getDistance(this._camPos,c),f=2*d/this._screenSizeFactor;this._updateMinMaxDistance(d+
c[3]);return a.maxError*b<=f;case r.LodMetric.MaxScreenThreshold:return b=this._screenSpaceDiameterMbs(a,a.serviceMbsInIndexSR[3]*b),this._options.angleDependentLoD&&(b*=this.calcAngleDependentLoD(a)),b<a.maxError;case r.LodMetric.RemovedFeatureDiameter:return 10>this._screenSpaceDiameterMbs(a,a.maxError)*b;case r.LodMetric.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(a)>a.maxError*b}return!1}distToPOI(a){a=this.getServiceMbsInRenderSR(a);return e.distance(p.getCenter(a),this._poi)-
a[3]}distCameraToPOI(){return e.distance(this._camPos,this._poi)}}const Q=h.create(),D=w.createPoints(),R=h.create(),F=h.create(),T=h.create(),U=h.create(),V=h.create(),E=new x.Obb,y=h.create(),u=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create()],S=h.create(),W=h.create(),X=h.create(),G=h.create();return P});
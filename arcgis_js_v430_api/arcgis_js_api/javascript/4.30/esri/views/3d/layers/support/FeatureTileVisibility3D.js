// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/mathUtils ../../../../core/ObjectPool ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/spatialReferenceEllipsoidUtils ../../../../geometry/projection/projectBuffer ../../../../geometry/projection/projectVec3Array ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/ray ../../../ViewingMode ./FeatureTileDescriptor3D ../../state/Frustum ../../support/FrustumExtentIntersection".split(" "),
function(J,Y,Z,c,f,aa,ba,ca,da,l,z,ea,K,x,G,fa){function P(a){var b=G.Frustum.nearFarLineIndices;const d=a.mutablePoints;for(const h of b){const [k,e]=h;b=d[k];c.subtract(w,d[e],b);c.scale(w,w,.95);c.add(d[e],b,w)}a.updatePoints(d)}function B(a,b,d){c.cross(a,b,d);c.normalize(a,a);return a}function Q(a,b,d){c.sub(a,b,d);c.normalize(a,a);return a}function H(a,b){c.scale(a,a,b/c.len(a));return a}function L(a,b,d){for(const m of ha){a:{var h=a[m];var k=b,e=d;for(let g=0;g<e;++g)if(0>=z.signedDistance(h,
k[g])){h=!1;break a}h=!0}if(h)return!0}return!1}function ia(a,b,d){for(const h of b)if(c.dot(h,a)<d)return!1;return!0}function M(a,b,d,h){if(0===d.length||0===h.length)return!0;var k=ja;B(k,a,b);var e=h[0]<d[0];a=e?d:h;b=ka;e=e?h:d;d=Infinity;h=-Infinity;for(var m of e)e=c.dot(k,m),d=Math.min(d,e),h=Math.max(h,e);b[0]=d;b[1]=h;a:{m=b[0];b=b[1];d=Infinity;h=-Infinity;for(const g of a)if(a=c.dot(k,g),d=Math.min(d,a),h=Math.max(h,a),d<=b&&h>=m){k=!1;break a}k=!0}return k}class la{constructor(a,b){this._renderCoordsHelper=
a;this._getIsGroundOpaque=b;this._surfaceElevation=0;this._isGroundOpaque=!1;this._cache=new Map;this._frustumBoundingSphereCenter=f.create();this._frustumBoundingSphereRadius=0;this._frustum=new G.Frustum(a);this._extendedFrustum=new G.Frustum(a);this._intersector=new fa.FrustumExtentIntersection({renderCoordsHelper:a});this._renderSR=a.spatialReference;b=ba.getSphericalPCPF(this._renderSR);this._renderSREllipsoidRadius=aa.getReferenceEllipsoid(b).radius;this._renderCoordsHelper=a}begin(a,b){this._surfaceElevation=
b;this._aboveGround=a.aboveGround;this._isGroundOpaque=this._getIsGroundOpaque();this._frustum.update(a);P(this._frustum);this._updateExtendedFrustum(a);this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(a){const b=this._renderCoordsHelper.viewingMode===K.ViewingMode.Global&&2<=a.lij[0]&&6>a.lij[0],d=this._getOrCalculateSingleTileVisibility(a,!b);return d!==x.Visibility.INVISIBLE&&b?this._calculateAggregatedChildrenVisibility(a):d}_calculateAggregatedChildrenVisibility(a){let b=
x.Visibility.INVISIBLE;var d=this._cache.get(a.id);if(null!=d)return d;d=R.acquire();a.getChildren(d);for(const h of d){const k=this.calculate(h);if(k!==x.Visibility.INVISIBLE&&(b=k,k===x.Visibility.VISIBLE_ON_SURFACE))break}R.release(d);this._cache.set(a.id,b);return b}_getOrCalculateSingleTileVisibility(a,b){var d=this._cache.get(a.id);if(null!=d)return d;d=this._calculateSingleTileVisibility(a);b&&this._cache.set(a.id,d);return d}_calculateSingleTileVisibility(a){if(!this._aboveGround&&this._renderCoordsHelper.viewingMode===
K.ViewingMode.Global&&12>a.lij[0]){if(this._calculateSingleTileVisibilitySided(a,!1)===x.Visibility.INVISIBLE)return this._calculateSingleTileVisibilitySided(a,!0)}else return this._calculateSingleTileVisibilitySided(a,this._aboveGround)}_isTileVisibleInFrustum(a){return this._renderCoordsHelper.viewingMode===K.ViewingMode.Local?this._isTileVisibleInFrustumLocal(a):this._isTileVisibleInFrustumGlobal(a)}_updateFrustumBoundingSphere(){var a=this._frustum;const b=a.origin,d=ma;c.normalize(d,a.direction);
var h=na;c.sub(h,a.points[4],b);a=c.dot(h,h);h=c.dot(d,h);h=.5*a/h;c.scaleAndAdd(this._frustumBoundingSphereCenter,b,d,h);this._frustumBoundingSphereRadius=1+h}_isTileVisibleInFrustumLocal(a){var b=a.tilingScheme.spatialReference,d=a.extent,h=this._renderSR;a=oa;a[0]=d[0];a[1]=d[1];a[2]=0;a[3]=d[2];a[4]=d[3];a[5]=0;if(!ca.projectBuffer(a,b,0,a,h,0,2))return!1;b=S;c.set(b[0],a[0],a[1],0);c.set(b[1],a[3],a[1],0);c.set(b[2],a[3],a[4],0);c.set(b[3],a[0],a[4],0);var k=T;c.set(k,.5*(a[0]+a[3]),.5*(a[1]+
a[4]),.5*(a[2]+a[5]));a=pa;c.set(a,0,0,1);var e=.5*c.dist(b[0],b[2]);d=this._frustum;h=this._frustumBoundingSphereRadius;const m=this._frustumBoundingSphereCenter;var g=qa;c.sub(g,m,k);g=c.dot(a,g);const p=ra;c.scaleAndAdd(p,k,a,g);if(c.dist(p,m)>e+h)return!1;k=sa;e=Math.min(this._isGroundOpaque&&!this._aboveGround?430:Infinity,g+h);h=Math.max(this._isGroundOpaque&&this._aboveGround?-430:-Infinity,g-h);for(g=0;4>g;++g)c.scaleAndAdd(k[g],b[g],a,e),c.scaleAndAdd(k[g+4],b[g],a,h);return!L(d.planes,k,
8)}_isTileVisibleInFrustumGlobal(a){var b=a.tilingScheme.spatialReference,d=a.extent;const h=this._isGroundOpaque&&this._aboveGround,k=this._isGroundOpaque&&!this._aboveGround;if(4>a.lij[0])return!0;var e=S,m=.5*(d[0]+d[2]);c.set(e[0],d[0],d[1],0);c.set(e[1],d[2],d[1],0);c.set(e[2],d[2],d[3],0);c.set(e[3],d[0],d[3],0);c.set(e[4],m,d[1],0);c.set(e[5],m,d[3],0);if(!da.projectVec3Array(e,b,0,e,this._renderSR,0,6))return!1;var g=0<e[0][2],p=0>e[3][2];d=this._renderSREllipsoidRadius;if(g||p){var n=f.fromValues(0,
0,1),q=ta;B(q,n,e[0]);m=ua;B(m,n,e[1]);if(g){g=U;p=e[4];var y=V;B(y,p,n);B(g,y,p);n=e[0];c.cross(n,q,g);H(n,d);q=e[1];c.cross(q,m,g);H(q,d)}else p&&(g=U,p=e[5],y=V,B(y,p,n),B(g,p,y),n=e[3],c.cross(n,g,q),H(n,d),q=e[2],c.cross(q,g,m),H(q,d))}p=T;m=c.sub(va,e[3],e[0]);c.normalize(m,m);q=c.add(wa,e[0],e[3]);c.scale(q,q,.5);n=-c.dot(q,m);q=c.add(xa,e[0],e[1]);c.scale(q,q,.5);g=c.add(ya,e[2],e[3]);c.scale(g,g,.5);g=c.sub(za,g,q);c.normalize(g,g);m=-(n+c.dot(m,q))/c.dot(m,g);c.scaleAndAdd(p,q,g,m);H(p,
d);g=this._frustumBoundingSphereRadius;y=this._frustumBoundingSphereCenter;const C=this._frustum;q=C.planes;var u=Aa;c.normalize(u,p);n=c.dot(e[0],u)/c.len(e[0]);var v=C.origin;m=C.points;var A=!1;if(h){A=!0;var F=c.normalize(f.create(),v);for(var D=0;4>D;++D){var t=m[4+D];t=c.sub(f.create(),t,v);c.normalize(t,t);var E=c.cross(f.create(),F,t);c.normalize(E,E);t=c.cross(f.create(),t,E);c.normalize(t,t);if(c.dot(v,t)>d){A=!1;break}}if(A&&c.dot(v,u)<d*n-430)return!1;v=c.normalize(Ba,C.origin);if(0>c.dot(v,
u))return!1;v=c.normalize(Ca,C.direction);if(c.dot(v,u)>Da)return!1}F=Math.sqrt(1-n*n);if(.9<F)return!0;v=!1;t=c.dot(u,y);E=c.len(y);if(E<=g&&!q.some(I=>0<z.signedDistance(I,N)))if(h)v=!0;else return!0;D=t/E;if(!v&&0>=t&&-t>g)return!1;t=g/E;if(Math.sqrt(1-D*D)*Math.sqrt(1-t*t)-t*D>F)return!1;if(!A&&(e.some(I=>C.intersectsPoint(I))||C.intersectsPoint(p)))return!0;p=Ea;c.sub(p,y,N);p=c.dot(p,u);A=Fa;c.scale(A,u,p);y=c.dist(A,y);b=b.isWGS84;u=a.lij;a=b&&u[2]===2**u[0]-1;b=(u=b&&0===u[2])?Ga:a?Ha:Ia;
a=u?Ja:a?Ka:La;if(!v){u=Ma;v=Na;A=Oa;F=N;for(var r of b)if(b=e[r],Q(v,e[(r+1)%4],b),Q(A,F,b),B(u,A,v),ia(u,m,1))return!1}r=null;if(!h&&p<1.01*g){r=2.5*g;if(y>n*r+g)return!1;b=Pa;r/=n;for(n=0;4>n;++n)c.scale(b[n],e[n],r/d);c.set(b[4],0,0,0);r=b}else{r=(k?d+430:p+g)/n;b=h?d-430:(p-g)/n;n=Qa;for(g=0;4>g;++g)p=e[g],c.scale(n[g],p,b/d),c.scale(n[g+4],p,r/d);r=n}if(L(q,r,r.length))return!1;b=C.lines;e=Ra;d=Sa;for(const I of b){c.normalize(d,I.direction);for(const O of a){b=r[O];c.normalize(e,b);if(M(d,
e,r,m))return!1;q=(O+1)%4;if(h&&(c.sub(e,r[q],b),c.normalize(e,e),M(d,e,r,m))||k&&(c.sub(e,r[4+q],r[4+O]),c.normalize(e,e),M(d,e,r,m)))return!1}}return!0}_calculateSingleTileVisibilitySided(a,b){return this._isTileVisibleInFrustum(a)?(this._intersector.update(a.extent,a.tilingScheme.spatialReference,this._surfaceElevation,b),this._intersector.isVisibleInFrustum(this._frustum,this._renderSREllipsoidRadius,!0)?x.Visibility.VISIBLE_ON_SURFACE:x.Visibility.VISIBLE_WHEN_EXTENDED):x.Visibility.INVISIBLE}_updateExtendedFrustum(a){this._extendedFrustum.update(a);
P(this._extendedFrustum);var b=this._renderCoordsHelper.worldUpAtPosition(a.eye,w);this._aboveGround||c.negate(b,b);if(this._hasExtendedFrustum=Y.acosClamped(-c.dot(b,a.viewForward))>a.fovY/2){a=this._extendedFrustumParameters();b=this._extendedFrustum.mutablePoints;for(let d=0;4>d;d++){const h=a.pointIndices[d],k=b[h],e=this._renderCoordsHelper.getAltitude(k);if(a.needsAltitudeAdjustment(e)){this._renderCoordsHelper.worldUpAtPosition(k,w);switch(h){case l.PointIndex.FAR_BOTTOM_LEFT:case l.PointIndex.FAR_TOP_LEFT:case l.PointIndex.NEAR_BOTTOM_LEFT:case l.PointIndex.NEAR_TOP_LEFT:z.projectVector(this._extendedFrustum.planes[l.PlaneIndex.LEFT],
w,w);break;case l.PointIndex.FAR_BOTTOM_RIGHT:case l.PointIndex.FAR_TOP_RIGHT:case l.PointIndex.NEAR_BOTTOM_RIGHT:case l.PointIndex.NEAR_TOP_RIGHT:z.projectVector(this._extendedFrustum.planes[l.PlaneIndex.RIGHT],w,w)}c.scale(w,w,a.direction);this._renderCoordsHelper.intersectInfiniteManifold(ea.wrap(k,w),a.zWithMargin,k)}}this._extendedFrustum.updatePoints(b);z.fromPoints(b[l.PointIndex.NEAR_BOTTOM_LEFT],b[l.PointIndex.NEAR_BOTTOM_RIGHT],b[l.PointIndex.NEAR_TOP_RIGHT],W);z.fromPoints(b[l.PointIndex.NEAR_BOTTOM_RIGHT],
b[l.PointIndex.NEAR_TOP_RIGHT],b[l.PointIndex.NEAR_TOP_LEFT],X);0>c.dot(z.getNormal(W),z.getNormal(X))&&(a=this._extendedFrustum.mutablePoints,this._aboveGround?[a[l.PointIndex.NEAR_BOTTOM_LEFT],a[l.PointIndex.NEAR_BOTTOM_RIGHT]]=[a[l.PointIndex.NEAR_BOTTOM_RIGHT],a[l.PointIndex.NEAR_BOTTOM_LEFT]]:[a[l.PointIndex.NEAR_TOP_LEFT],a[l.PointIndex.NEAR_TOP_RIGHT]]=[a[l.PointIndex.NEAR_TOP_RIGHT],a[l.PointIndex.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(a))}}_extendedFrustumParameters(){return this._aboveGround?
this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const a=this._surfaceElevation-1;return{zWithMargin:a,pointIndices:G.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment(b){return b>a}}}_extendedFrustumParametersBelowSurface(){const a=this._surfaceElevation+1;return{zWithMargin:a,pointIndices:G.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment(b){return b<a}}}}const w=f.create(),W=
z.create(),X=z.create(),R=new Z(Array,a=>{4!==a.length&&(a[0]=new x.FeatureTileDescriptor3D,a[1]=new x.FeatureTileDescriptor3D,a[2]=new x.FeatureTileDescriptor3D,a[3]=new x.FeatureTileDescriptor3D)},a=>{a[0].release();a[1].release();a[2].release();a[3].release()}),ha=[l.PlaneIndex.LEFT,l.PlaneIndex.RIGHT,l.PlaneIndex.BOTTOM,l.PlaneIndex.TOP,l.PlaneIndex.FAR],sa=[f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create()],oa=[0,0,0,0,0,0],S=[f.create(),f.create(),f.create(),
f.create(),f.create(),f.create()],T=f.create(),pa=f.create(),U=f.create(),ta=f.create(),ua=f.create(),V=f.create(),Aa=f.create(),Fa=f.create(),ma=f.create(),na=f.create(),ra=f.create(),qa=f.create(),N=f.fromValues(0,0,0),Ea=f.create(),Qa=[f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create(),f.create()],Pa=[f.create(),f.create(),f.create(),f.create(),f.create()],va=f.create(),wa=f.create(),xa=f.create(),ya=f.create(),za=f.create(),Na=f.create(),Oa=f.create(),Ra=f.create(),Sa=
f.create(),ja=f.create(),Ia=[0,1,2,3],La=[0,1,2,3],Ha=[0,1,3],Ka=[0,1,3],Ga=[1,2,3],Ja=[1,2,3],Ma=f.create(),ka=[0,0],Ba=f.create(),Ca=f.create(),Da=Math.cos(.25*Math.PI);J.FeatureTileVisibility3D=la;J.globalTileLevelThreshold=4;J.isConvexHullOutsideOfFrustum=L;Object.defineProperty(J,Symbol.toStringTag,{value:"Module"})});
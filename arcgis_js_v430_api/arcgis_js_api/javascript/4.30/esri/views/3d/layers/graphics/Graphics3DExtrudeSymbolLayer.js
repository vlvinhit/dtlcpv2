// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/Error ../../../../core/lang ../../../../core/unitUtils ../../../../chunks/earcut ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ../../../../geometry/support/Indices ../../../../chunks/vec3 ../../../../layers/graphics/data/SnappingCandidate ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../support/renderInfoUtils/polygon ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/Normals ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ia,ib,Ea,X,Fa,Ga,Ha,Ia,ja,Y,z,B,Ja,U,S,Z,Ka,aa,La,Ma,ba,Na,Oa,ka,la,Pa,Qa,Ra,Sa,Ta,Ua,ca,da,Va,Wa,Xa,ma,Ya,K,na){function oa(a,b,c,e,g,d){const f=Z.getZeroIndexArray(b.length);b=[[K.VertexAttribute.POSITION,new ca.Attribute(e.positions,b,3,!0)],[K.VertexAttribute.NORMALCOMPRESSED,new ca.Attribute(e.normals,b,2,!0)],[K.VertexAttribute.COLOR,new ca.Attribute(g,f,4,!0)]];return new Wa.Geometry(a,b,e.elevation,Va.ContentObjectType.Mesh,d,c)}function Za(a,b,c,e,g,d,f,l,A,m,n,k,v){var w=e.index,
x=e.count,q=c.length/3,t=2*e.count;z.copy(H,k);k=0<n?1:-1;w*=3;let p=0,h=3*p,u=x,y=3*u;for(let C=0;C<x;++C){const r=a[w],D=a[w+1],L=a[w+2];v&&(H[0]=r,H[1]=D,H[2]=L,z.normalize(H,H));g[h+0]=r;g[h+1]=D;g[h+2]=L;const O=b[w+0],M=b[w+1],J=b[w+2];d[h+0]=O;d[h+1]=M;d[h+2]=J;f[h+0]=-k*H[0];f[h+1]=-k*H[1];f[h+2]=-k*H[2];l[p]=0;g[y+0]=r+n*H[0];g[y+1]=D+n*H[1];g[y+2]=L+n*H[2];d[y+0]=O;d[y+1]=M;d[y+2]=J;l[u]=n;h+=3;y+=3;w+=3;p+=1;u+=1}b=a=0;t*=3;v=0>n?pa:qa;k=0>n?qa:pa;for(w=0;w<q;++w)m[b]=c[a+v[0]],m[b+1]=
c[a+v[1]],m[b+2]=c[a+v[2]],A[t]=c[a+k[0]]+x,A[t+1]=c[a+k[1]]+x,A[t+2]=c[a+k[2]]+x,b+=3,t+=3,a+=3;c=0;m=2*e.count;x=0;q=e.pathLengths[0];ra(g,d,l,f,c,q,e.count,m,A,x,n);m+=4*q;x+=2*q;c+=q;for(q=1;q<e.pathLengths.length;++q)t=e.pathLengths[q],ra(g,d,l,f,c,t,e.count,m,A,x,n),m+=4*t,x+=2*t,c+=t}function V(a,b,c,e,g,d,f){e[d]=e[f];f*=3;d*=3;a[d]=a[f];a[d+1]=a[f+1];a[d+2]=a[f+2];b[d]=b[f];b[d+1]=b[f+1];b[d+2]=b[f+2];c[d]=g[0];c[d+1]=g[1];c[d+2]=g[2]}function ra(a,b,c,e,g,d,f,l,A,m,n){let k=g,v=g+1,w=g+
f,x=g+f+1,q=l,t=l+1,p=l+2*d;l=l+2*d+1;0>n&&(k=g+f+1,x=g);m*=3;for(let D=0;D<d;++D){D===d-1&&(v=g,0<n?x=g+f:k=g+f);var h=a,u=k,y=v,C=w,r=T;u*=3;y*=3;C*=3;z.set(ea,h[u++],h[u++],h[u++]);z.set(sa,h[y++],h[y++],h[y++]);z.set(ta,h[C++],h[C++],h[C++]);z.subtract(ua,sa,ea);z.subtract(va,ta,ea);z.cross(r,va,ua);z.normalize(r,r);V(a,b,e,c,T,q,k);V(a,b,e,c,T,t,v);V(a,b,e,c,T,p,w);V(a,b,e,c,T,l,x);A[m]=q;A[m+1]=p;A[m+2]=l;A[m+3]=q;A[m+4]=l;A[m+5]=t;m+=6;k++;v++;w++;x++;q+=2;t+=2;p+=2;l+=2}}function wa(a,b,c){var e=
a.getMutableAttribute(K.VertexAttribute.POSITION);const g=a.getMutableAttribute(K.VertexAttribute.NORMALCOMPRESSED).data,{topVertexStart:d,topVertexCount:f,topFaceStart:l,topFaceCount:A}=b;e=e.data;var m=a.attributes.get(K.VertexAttribute.POSITION).indices,n=l+A;a=d+f;b=S.newDoubleArray(3*f);for(var k=0;k<f;++k){var v=3*k;b[v+0]=0;b[v+1]=0;b[v+2]=0}k=$a;v=ab;const w=bb,x=cb,q=H;for(let u=l;u<n;++u){var t=3*u;for(var p=0;3>p;++p){var h=m[t+p];x[p]=h;h*=3;z.set(G,e[h+0],e[h+1],e[h+2]);z.transformMat4(k[p],
G,c)}z.sub(v,k[1],k[0]);z.sub(w,k[2],k[0]);z.cross(q,v,w);z.normalize(q,q);for(t=0;3>t;++t)p=3*(x[t]-d),b[p+0]+=q[0],b[p+1]+=q[1],b[p+2]+=q[2]}for(c=d;c<a;++c)n=3*(c-d),e=b[n+0],m=b[n+1],n=b[n+2],k=Math.sqrt(e*e+m*m+n*n),ma.compressNormal(g,c,e/k,m/k,n/k)}const db=["polygon","extent"];class eb extends Oa.Graphics3DSymbolLayer{constructor(a,b,c,e){super(a,b,c,e);this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){var a=ka.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new Ea("graphics3dextrudesymbollayer:invalid-size",
a);}var b=this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color);a=B.fromArray(b);b=b[3];const c=1>b||this.needsDrivenTransparentPass;a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:b,transparent:c,cullFace:c?da.CullFaceOptions.None:da.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:Ua.NormalType.Compressed};this._materials[I.Main]=
new na.DefaultMaterial(a);this._materials[I.Bottom]=new na.DefaultMaterial({...a,cullFace:da.CullFaceOptions.Back});this._context.stage.addMany(this._materials)}destroy(){super.destroy();this._context.stage.removeMany(this._materials);this._materials.length=0}createGraphics3DGraphic(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,db,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(a.renderingInfo,255),e=this.setGraphicElevationContext(b);return this._createAs3DShape(b,
a.renderingInfo,c,e,b.uid)}layerOpacityChanged(a,b){const c=this._getCombinedOpacity(this.symbolLayer?.material?.color),e=1>c||this.needsDrivenTransparentPass;this._materials[I.Main]?.setParameters({opacity:c,transparent:e});this._materials[I.Bottom]?.setParameters({opacity:c,transparent:e});const g=this._getLayerOpacity();a.forEach(d=>{d=b(d);null!=d&&d.layerOpacityChanged(g,this._context.isAsync)})}layerElevationInfoChanged(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,ba.needsElevationUpdates3D)}slicePlaneEnabledChanged(a,
b){this._materials[I.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});this._materials[I.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});a.forEach(c=>{c=b(c);null!=c&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0}physicalBasedRenderingChanged(){const a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};this._materials[I.Main]?.setParameters(a);this._materials[I.Bottom]?.setParameters(a);return!0}_getExtrusionSize(a){a=
a.size&&this._drivenProperties.size?La.getDriverAxisSizeValue(a.size,2)??0:this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters}applyRendererDiff(a,b){return this._drivenPropertiesChanged(b)?la.ApplyRendererDiffResult.RecreateSymbol:la.ApplyRendererDiffResult.RecreateGraphics}async queryForSnapping(a,b,c,e){b=this._getExtrusionSize(c)*this._context.renderCoordsHelper.unitInMeters/Fa.getMetersPerVerticalUnitForSR(b);const {objectId:g,target:d}=a;c=X.clone(d);c.z=(c.z??0)+b;
switch(a.type){case "edge":const {start:f,end:l}=a;a=X.clone(f);e=X.clone(l);a.z=(a.z??0)+b;e.z=(e.z??0)+b;return[aa.makeEdgeCandidate(g,c,Infinity,a,e)];case "vertex":return[aa.makeVertexCandidate(g,c,Infinity),aa.makeEdgeCandidate(g,d,Infinity,d,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(a,b,c,e,g){var d=Pa.geometryAsPolygon(a.geometry);if(null==d)return null;if(0===d.rings.length||!d.rings.some(r=>0<r.length))return this._logGeometryValidationWarnings(d.rings,
"rings","ExtrudeSymbol3DLayer"),null;a=Ta.geometryToRenderInfo(d,this._context.elevationProvider,this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(a,d.rings,"rings","ExtrudeSymbol3DLayer");var f=ka.computeCentroid(d);if(null==f)return null;var l=[];const A=[],m=U.create(),n=Y.create(),k=B.create(),v=this._context.renderCoordsHelper.viewingMode===Ma.ViewingMode.Global;v||this._context.renderCoordsHelper.worldUpAtPosition(null,k);Ja.computeTranslationToOriginAndRotation(d.spatialReference,
[f.x,f.y,0],n,this._context.renderCoordsHelper.spatialReference);d=Y.create();ja.invert(d,n);f=Ia.create();Ha.normalFromMat4(f,d);const {polygons:w,mapPositions:x,position:q}=a,t=new Map;f=this._materials[I.Main];for(const r of w){var p=r.count;if(this._context.clippingExtent&&(U.empty(m),U.expandWithBuffer(m,r.mapPositions),!U.intersectsClippingArea(m,this._context.clippingExtent)))continue;var h=Ga.earcut(r.mapPositions,r.holeIndices,3);if(0===h.length)continue;const D=h.length;var u=6*p,y=Z.newIndexArray(u+
D);const L=Z.newIndexArray(D);var C=S.newDoubleArray(3*u);const O=S.newDoubleArray(3*u),M=S.newDoubleArray(3*u);u=S.newDoubleArray(u);const J=this._getExtrusionSize(b);Za(q,x,h,r,C,M,O,u,y,L,J,k,v);Ka.transformMat4(C,C,d);h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid});C=new fb(C,M,ma.compressNormals(O),u);y=oa(f,y,y.length-L.length,C,c,h);p=new gb(p,p,2*r.count,D/3);wa(y,p,n);t.set(y,p);l.push(y,oa(this._materials[I.Bottom],L,0,C,c,h));A.push(C.heights)}if(0===
l.length)return null;b=new Ya.Object3D({geometries:l,layerUid:this._context.layer.uid,graphicUid:g,isElevationSource:!0});b.transformation=n;c=Qa.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});l=new Na.Graphics3DObject3DGraphicLayer(this,b,l,null,null,(r,D,L,O,M)=>{r=r.stageObject;const J=r.geometries,xa=J.length;D="absolute-height"!==D.mode;let ya=0;const fa=r.transformation,hb=ja.invertOrIdentity(Y.create(),fa);for(let N=0;N<xa;N+=2){const Q=J[N];if(!Xa.isGeometryWithMapPositions(Q))continue;
var E=Q.getMutableAttribute(K.VertexAttribute.POSITION).data;const za=A[N/2],P=new Sa.SamplePosition(Q.mapPositions),Aa=E.length/3;let Ba=!1,Ca=0,F=0;for(let Da=0;Da<Aa;Da++){R[0]=E[F];R[1]=E[F+1];R[2]=E[F+2];O(P,W);D&&(Ca+=W.sampledElevation);Ra.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(z.set(G,P.array[P.offset],P.array[P.offset+1],W.z+za[F/3]),null!=L&&M.toRenderCoords(G,L,G)):(z.set(G,E[F],E[F+1],E[F+2]),z.transformMat4(G,G,fa),M.setAltitude(G,W.z+za[F/3]));z.transformMat4(G,G,hb);E[F]=G[0];E[F+
1]=G[1];E[F+2]=G[2];const ha=.01/M.unitInMeters;if(Math.abs(R[0]-E[F])>=ha||Math.abs(R[1]-E[F+1])>=ha||Math.abs(R[2]-E[F+2])>=ha)Ba=!0;P.offset+=3;F+=3}Ba&&((E=t.get(Q))&&wa(Q,E,fa),r.geometryVertexAttributeUpdated(J[N],K.VertexAttribute.NORMALCOMPRESSED),Q.invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(J[N],K.VertexAttribute.POSITION),J[N+1].invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(J[N+1],K.VertexAttribute.POSITION));ya+=Ca/Aa}return ya/xa},e,null!=c?{baseMaterial:this._materials[I.Main],
edgeMaterials:[c],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null);l.alignedSampledElevation=a.sampledElevation;l.needsElevationUpdates=ba.needsElevationUpdates3D(e.mode);return l}}const T=B.create(),ea=B.create(),sa=B.create(),ta=B.create(),ua=B.create(),va=B.create(),R=B.create(),G=B.create(),H=B.create(),W=new ba.SampleElevationInfo,qa=[0,2,1],pa=[0,1,2],$a=[B.create(),B.create(),B.create()],ab=B.create(),bb=B.create(),cb=[0,0,0];var I;(function(a){a[a.Main=
0]="Main";a[a.Bottom=1]="Bottom"})(I||={});class fb{constructor(a,b,c,e){this.positions=a;this.elevation=b;this.normals=c;this.heights=e}}class gb{constructor(a,b,c,e){this.topVertexStart=a;this.topVertexCount=b;this.topFaceStart=c;this.topFaceCount=e}}ia.Graphics3DExtrudeSymbolLayer=eb;Object.defineProperty(ia,Symbol.toStringTag,{value:"Module"})});
// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../chunks/sphere ./elevationAlignmentUtils ./featureExpressionInfoUtils ./graphicUtils ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/edgeRendering/interfaces".split(" "),function(r,q,t,m,x,y,z,A,v,u){function w(a){return a.isVisible()?a.parameters.transparent?u.Transparency.TRANSPARENT:u.Transparency.OPAQUE:u.Transparency.INVISIBLE}class B{constructor(a,
b,d){this.baseMaterial=a;this.edgeMaterials=b;this.properties=d}}class C{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(a,b,d,e,c,g,h,f=null){this.graphics3DSymbolLayer=a;this.stageObject=b;this._uniqueGeometries=d;this._uniqueMaterials=e;this._sharedResource=c;this.elevationAligner=g;this.elevationContext=h;this._edgeState=f;this.type="object3d";this._stageLayer=null;this._addedToStage=this._visible=!1;this.alignedSampledElevation=0;this.useObjectOriginAsAttachmentOrigin=
this.needsElevationUpdates=!1}initialize(a){this._stageLayer=a;a=a.stage;a.addMany(this._uniqueMaterials);a.addMany(this._uniqueGeometries);a.add(this.stageObject)}destroy(){if(this._stageLayer){var a=this._stageLayer.stage;a.removeMany(this._uniqueMaterials);a.removeMany(this._uniqueGeometries);a.remove(this.stageObject);this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);a.renderer.edgeView?.removeObject(this.stageObject);this.stageObject.dispose();this._sharedResource?.release();
this._visible=!1;this._stageLayer=null}}layerOpacityChanged(a,b){const {stageObject:d,_edgeState:e,_stageLayer:c}=this;if(null!=e){var g=w(e.baseMaterial),h=!1;for(const f of e.edgeMaterials)f.objectTransparency!==g&&(f.objectTransparency=g,h=!0);h&&this.resetEdgeObject(b);c.stage.renderer.withEdgeView(f=>{f.updateAllComponentOpacities(d,[a])})}}slicePlaneEnabledChanged(a,b){const {stageObject:d,_edgeState:e,_stageLayer:c}=this;null!=e&&c.stage.renderer.withEdgeView(g=>{g.updateAllComponentMaterials(d,
e.edgeMaterials,{hasSlicePlane:a},!b);e.properties.hasSlicePlane=a})}setVisibility(a){const {_edgeState:b,stageObject:d,_stageLayer:e}=this;null!=e&&this.visible!==a&&(this._visible=a,(d.visible=a)&&!this._addedToStage&&(e.add(d),this._addedToStage=!0),null!=b&&e.stage.renderer.withEdgeView(c=>{c.hasObject(d)?c.updateObjectVisibility(d,a):a&&this._addOrUpdateEdgeObject(b,c,!1)}))}get visible(){return this._visible}alignWithElevation(a,b,d,e){null!=this.elevationAligner&&(null!=d&&z.setContextFeature(this.elevationContext.featureExpressionInfoContext,
d),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,a.spatialReference,(c,g)=>y.evaluateElevationInfoAtPoint(c,a,this.elevationContext,b,g),b),this.resetEdgeObject(e))}alignWithAbsoluteElevation(a,b,d){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(e,c)=>{c.sampledElevation=a;c.verticalDistanceToGround=0;c.z=a},b);this.resetEdgeObject(d)}getCenterObjectSpace(a=t.create()){return q.copy(a,x.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(a=
m.create()){const b=this.stageObject.boundingVolumeObjectSpace;m.setMin(a,b.min);m.setMax(a,b.max);return a}computeAttachmentOrigin(a){const b=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)a.render.origin[0]+=b[12],a.render.origin[1]+=b[13],a.render.origin[2]+=b[14],a.render.num++;else for(const d of this.stageObject.geometries)d.computeAttachmentOrigin(k)&&(q.transformMat4(k,k,b),q.add(a.render.origin,a.render.origin,k),a.render.num++)}async getProjectedBoundingBox(a,
b,d,e,c){c=this.getBoundingBoxObjectSpace(c);var g=D,h=m.isPoint(c)?1:g.length;for(var f=0;f<h;f++){const p=g[f];l[0]=c[p[0]];l[1]=c[p[1]];l[2]=c[p[2]];q.transformMat4(l,l,this.stageObject.transformation);n[3*f]=l[0];n[3*f+1]=l[1];n[3*f+2]=l[2]}if(!a(n,0,h))return null;m.empty(c);a=null;this.calculateRelativeScreenBounds&&(a=this.calculateRelativeScreenBounds());for(g=0;g<3*h;g+=3){for(f=0;3>f;f++)c[f]=Math.min(c[f],n[g+f]),c[f+3]=Math.max(c[f+3],n[g+f]);a&&d.push({location:n.slice(g,g+3),screenSpaceBoundingRect:a})}if(b?.service&&
"absolute-height"!==this.elevationContext.mode){m.center(c,k);d="relative-to-scene"===this.elevationContext.mode?"scene":"ground";h=0;if(b.useViewElevation)h=b.service.getElevation(k[0],k[1],d)??0;else try{const p=A.demResolutionForBoundingBox(c,b.service.spatialReference,b);h=await b.service.queryElevation(k[0],k[1],e,p,d)??0}catch(p){}m.offset(c,0,0,-this.alignedSampledElevation+h)}return c}addObjectState(a,b){a===v.Object3DState.Highlight&&b.addObject(this.stageObject,this.stageObject.highlight());
a===v.Object3DState.MaskOccludee&&b.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(a){a.removeObject(this.stageObject)}resetEdgeObject(a){const {_edgeState:b,stageObject:d,_stageLayer:e,_visible:c}=this;null!=b&&e.stage.renderer.withEdgeView(g=>{c?this._addOrUpdateEdgeObject(b,g,a):g.removeObject(d)})}_addOrUpdateEdgeObject(a,b,d){const e=w(a.baseMaterial);for(const c of a.edgeMaterials)c.objectTransparency=e;b.addOrUpdateObject3D(this.stageObject,a.edgeMaterials,a.properties,
!d).then(()=>this._stageLayer?.sync())}}const n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=t.create(),k=t.create(),D=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];r.Graphics3DObject3DGraphicLayer=C;r.Object3DEdgeState=B;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
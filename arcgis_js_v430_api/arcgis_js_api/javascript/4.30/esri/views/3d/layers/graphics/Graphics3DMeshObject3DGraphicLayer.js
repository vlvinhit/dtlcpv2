// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ./ElevationAligners ./elevationAlignmentUtils ./featureExpressionInfoUtils ./Graphics3DObject3DGraphicLayer ./meshAutoFastUpdateConstants".split(" "),function(n,g,h,w,x,y,z,A,B,C){class D extends B.Graphics3DObject3DGraphicLayer{constructor(){super(...arguments);this.fastTransformUpdatesAllowed=!1;this._originalGeometries=
[];this._fastTransformUpdatesEnabled=!1;this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy();this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(b,c){if(this.fastTransformUpdatesAllowed&&!this._fastTransformUpdatesEnabled){this._cancelAutoDisableFastUpdates();this._fastTransformUpdatesEnabled=!0;var {stageObject:e}=this,a=e.geometries.slice();e.removeAllGeometries();var d=g.getTranslation(l,e.transformation);
c=c.getOrigin(d);for(const f of a)d=b(f.material),d=f.instantiate({material:d}),d.localOrigin=c,e.addGeometry(d);this._originalGeometries=a}}autoDisableFastTransformUpdates(b){this._cancelAutoDisableFastUpdates();this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0;b()},C.meshAutoFastUpdateConstants.disableDelayMs)}updateAutoDisableFastTransformUpdates(b){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(b)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId);
this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(b){if(this._fastTransformUpdatesEnabled){this._cancelAutoDisableFastUpdates();this._fastTransformUpdatesEnabled=!1;var {stageObject:c}=this,e=c.geometries.map(a=>b(a.material));c.removeAllGeometries();for(let a=0;a<this._originalGeometries.length;a++){const d=this._originalGeometries[a],f=e[a];f.setParameters({modelTransformation:null});f===d.material?c.addGeometry(d):c.addGeometry(d.instantiate({material:f}))}this._originalGeometries.length=
0}}updateFastLocalOrigin(b,c,e){if(this._fastTransformUpdatesEnabled){var {stageObject:a}=this;if(0!==a.geometries.length){var d=a.geometries[0].localOrigin,f=g.getTranslation(l,b),k=e.getOrigin(f);if(k!==d){var m=c?.localMatrix??h.IDENTITY;a.shaderTransformation=null;a.transformation=b;a.geometries.forEach(p=>{p.transformation=m;p.localOrigin=k})}}}}updateTransform(b,c,e){const {stageObject:a}=this,d=c?.localMatrix??h.IDENTITY;if(this._fastTransformUpdatesEnabled){var f=a.geometries[0].transformation;
c=g.multiply(q,a.transformation,f);b=g.multiply(r,b,d);f=g.multiply(t,b,g.invert(t,f));a.shaderTransformation=f;this._setFastMaterialTransformation({matA:c,matB:b})}else a.shaderTransformation=null,a.transformation=b,a.geometries.forEach(k=>k.transformation=d);this._updateEdgeTransform(e)}alignWithElevation(b,c,e,a){if(this._fastTransformUpdatesEnabled){null!=e&&A.setContextFeature(this.elevationContext.featureExpressionInfoContext,e);var {stageObject:d}=this;if(d.geometries[0].material.parameters.modelTransformation){e=
g.multiply(q,d.transformation,d.geometries[0].transformation);var f=g.copy(E,d.effectiveTransformation);this.alignedSampledElevation=y.perObjectElevationAligner(this,this.elevationContext,b.spatialReference,(k,m)=>z.evaluateElevationInfoAtPoint(k,b,this.elevationContext,c,m),c,f);d.shaderTransformation=f;d=g.multiply(r,f,d.geometries[0].transformation);this._setFastMaterialTransformation({matA:e,matB:d});this._updateEdgeTransform(a)}}else super.alignWithElevation(b,c,e,a)}_setFastMaterialTransformation({matA:b,
matB:c}){const {stageObject:e}=this;if(0!==e.geometries.length){var a=g.fromTranslation(F,w.scale(l,e.geometries[0].localOrigin.vec3,-1));b=g.multiply(u,a,b);c=g.multiply(v,a,c);a=g.invert(u,b);c=g.multiply(v,c,a);for(const d of e.geometries)d.material.setParameters({modelTransformation:c})}}_updateEdgeTransform(b){const {stageObject:c,_stageLayer:e}=this;e.stage.renderer.withEdgeView(a=>{a.fastUpdateObject3DEdgesTransform(c)||this.resetEdgeObject(b)})}}const l=x.create(),q=h.create(),r=h.create(),
E=h.create(),t=h.create(),u=h.create(),v=h.create(),F=h.create();n.Graphics3DMeshObject3DGraphicLayer=D;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
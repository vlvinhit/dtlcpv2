// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../layers/graphics/dehydratedPoint ../../../../../support/elevationInfoUtils ../../SnappingVisualizer3D ../geometryUtils ../isSupportedObjectUtils ../manipulatedObjectUtils ../manipulatorUtils ../meshFastUpdateUtils ../tooltipUtils3D ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYObjectManipulation ./isSupportedObject ../../visualElements/OutlineVisualElement ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/tooltipCommonUtils ../../../../interactive/tooltip/infos/MovePointTooltipInfo ../../../../interactive/tooltip/infos/TranslateTooltipInfo ../../../../interactive/tooltip/infos/TranslateXYTooltipInfo ../../../../interactive/tooltip/infos/TranslateZTooltipInfo ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(l,m,J,K,L,M,z,v,w,p,pa,qa,N,O,P,Q,R,S,T,A,U,V,W,X,Y,n,Z,aa,ba,E,F,ca,da,G,ea,fa,ha,ia,ja,ka,la,ma,H,na){function B(a,b,c){if(null==b||"end"===b.action)a.distance=v.zeroMeters;else{var {mapStart:d,mapEnd:e}=b;b=c(d,e);a.distance=null!=b?b:v.zeroMeters}}class C{constructor(a){this.objects=a;this.type="move-start"}}class D{constructor(a,b,c){this.dx=a;this.dy=b;this.objects=c;this.type="move"}}class x{constructor(a){this.objects=a;this.type="move-stop"}}const q=Symbol("manipulators"),I=Symbol("tooltips");
l.MoveTool3D=class extends ca.InteractiveToolBase{constructor(a){super(a);this._infos=new Map;this.events=new L;this.objects=new K;this.enableZ=!0;this.sketchOptions=new G;this.type="move-3d";this._translateZTooltipInfo=this._translateXYTooltipInfo=this._translateTooltipInfo=this._latestTooltipInfo=null;this._updatingHandles=new O.UpdatingHandles;this._moveManipulation=null}initialize(){var {view:a}=this;this.tooltip=new ha.Tooltip({view:a});this.addHandles([this.objects.on("change",b=>{b.removed.forEach(c=>
this.removeHandles(c));this._updateObjectInfos(b);this._setupFastTransformUpdates(b.added);this._refreshManipulators()}),this.objects.on("change",()=>this._connectTooltips())]);a=this.objects.toArray();this._updateObjectInfos({added:a,removed:[]});this._setupFastTransformUpdates(a);this._refreshManipulators();this._connectTooltips();this.finishToolCreation()}destroy(){this.tooltip=z.destroyMaybe(this.tooltip);this._moveManipulation=z.destroyMaybe(this._moveManipulation);this._set("view",null);this._updatingHandles.destroy()}onInputEvent(a){if(!this.destroyed&&
!ia.enterInputModeIfAvailable(a,this.tooltip))return super.onInputEvent(a)}get updating(){return this._updatingHandles.updating}get _shouldShowMovePointTooltip(){var {objects:a}=this;if(1!==a.length)return!1;a=A.manipulatedObjectGeometry(a.at(0))?.type;return"point"===a||"mesh"===a}get activeTooltipInfo(){return this._shouldShowMovePointTooltip?this._movePointTooltipInfo:this._latestTooltipInfo}reset(){}_updateObjectInfos({added:a,removed:b}){for(const c of a)ba.isSupportedObject(c)===T.SupportedObjectResult.SUPPORTED&&
(a=new oa(c),this._infos.set(c,a));for(const c of b)this._infos.delete(c)}_setupFastTransformUpdates(a){for(const b of a)a=this._infos.get(b),this.addHandles(V.meshTransformFastUpdateHandles(a.object),b)}_refreshManipulators(){this.removeHandles(q);this._moveManipulation=z.destroyMaybe(this._moveManipulation);this.manipulators.removeAll();if(0!==this._infos.size){var a=Array.from(this._infos.values());this._createManipulators(a);this._createVisualElements(a);this._updateMoveManipulation(a)}}_createManipulators(a){for(const b of a){const c=
b.object;b.manipulationXY=new aa.MoveXYObjectManipulation({tool:this,view:this.view,object:c});b.manipulationXY.forEachManipulator(d=>{this.addHandles([d.events.on("immediate-click",e=>{this.events.emit("immediate-click",{...e,object:c});e.stopPropagation()}),d.events.on("grab-changed",({action:e})=>{"start"===e?this._showTooltip(n.ManipulationType.XY):this._hideTooltip()})],q)});this.addHandles(b.manipulationXY.createDragPipeline((d,e,f,k)=>this._buildDragEventPipeline(a,n.ManipulationType.XY,d,
e,f,k)),q)}this._createMoveManipulation(a)}_createMoveManipulation(a){const b=new n.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?n.MoveManipulation.radiusForSymbol(a[0].object.graphic?.symbol):Y.discRadius});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(f=>{this.addHandles(f.events.on("immediate-click",k=>{const h=this.objects.at(0);!b.zManipulation.hasManipulator(f)&&
1===this.objects.length&&h&&this.events.emit("immediate-click",{...k,object:h});k.stopPropagation()}),q)});var c=f=>k=>{this.addHandles([k.events.on("focus-changed",({action:h})=>{"focus"===h?this._showTooltip(f):this._hideTooltip()}),k.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=v.zeroMeters)})],q)};this._moveManipulation.xyManipulation.forEachManipulator(c(n.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(c(n.ManipulationType.XY_AXIS));
this._moveManipulation.zManipulation.forEachManipulator(c(n.ManipulationType.Z));c=()=>this._updateMoveManipulation(a);for(const f of a)this.addHandles([f.object.on("committed",c),w.watch(()=>f.object.visible,c)],q);const d=a[a.length-1];this.addHandles(d.object.on("committed",()=>this._updateMoveManipulationAngle(d)),q);({object:c}=d);const {operations:e}=c;e&&this.addHandles(b.createDragPipeline((f,k,h,r,t)=>this._buildDragEventPipeline(a,f,k,h,r,t),c.elevationInfo,e.data.spatialReference,c.graphic),
q);this._updateMoveManipulationAngle(d)}_createVisualElements(a){for(const b of a){const c=X.createVisualElements({view:this.view,object:b.object,forEachManipulator:d=>{b.manipulationXY?.forEachManipulator(d);this._moveManipulation?.forEachManipulator(d)},onManipulatorsChanged:()=>M.makeHandle()});null!=c&&(b.geometryRepresentation=c.visualElement,b.geometryRepresentation instanceof E.OutlineVisualElement&&this.addHandles([b.geometryRepresentation.events.on("attachment-origin-changed",()=>{b.object.isDraped||
this._updateMoveManipulation(a)}),w.watch(()=>b.object.isDraped,()=>this._updateMoveManipulation(a))],q),this.addHandles(c,q))}}_updateMoveManipulationAngle(a){this._moveManipulation&&(this._moveManipulation.angle=S.orientation(A.manipulatedObjectGeometry(a.object)))}_updateMoveManipulation(a){const b=P.makeDehydratedPoint(0,0,0,this.view.spatialReference);let c=0,d=!1;const e=this._moveManipulation;if(e){for(const f of a)if(f.object.visible&&(this.enableZ&&U.canMoveZOperations(f.object.operations,
f.object.elevationInfo)&&(d=!0),a=f.geometryRepresentation instanceof E.OutlineVisualElement&&!f.object.isDraped?f.geometryRepresentation.attachmentOrigin:f.object.origin,null!=a)){const {x:k,y:h,z:r}=a;b.x+=k;b.y+=h;if(r){let t;(t=b).z??(t.z=0);b.z+=r}c++}0<c?(b.x/=c,b.y/=c,b.z??(b.z=0),b.z/=c,e.location=b,e.xyManipulation.available=!0,e.xyAxisManipulation.available=!0,e.zManipulation.available=d):e.available=!1}}_buildDragEventPipeline(a,b,c,d,e,f){const k=[],h=[];let r=null,t=null;const y=()=>
{for(const g of k)g.dragging=!1;k.length=0;h.length=0;t=r=null;this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===a.length&&b===n.ManipulationType.XY){const g=a[0].object;({steps:d,cancel:e}=this._buildSnappingPipelineSteps(g,g.elevationInfo,d,e,f))}e=e.next(g=>t?.(g)).next(()=>{h.length&&this.events.emit("move-stop",new x(h));this.destroyed||y();return null});d=d.next(g=>{if("start"===g.action){k.length=0;h.length=0;for(const u of a)u.dragging||!u.manipulationXY?.hasManipulator(c)&&
u.manipulationXY?.grabbing||(k.push(u),h.push(u.object),u.dragging=!0);if(0!==h.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),r=F.dragManipulatedObjectMany(h),t=F.resetManipulatedObjectMany(h),this._emitRecordUndo(),this.events.emit("move-start",new C(h)),this.destroyed))return null}return 0!==h.length?g:null}).next(g=>r?.(g)).next(g=>{this._updateMoveTooltip(b,g);return g}).next(g=>{switch(g.action){case "start":case "update":if(g.translationX||g.translationY||g.translationZ){const u=
this.view.toScreen(g.mapStart);g=this.view.toScreen(g.mapEnd);this.events.emit("move",new D(g.x-u.x,g.y-u.y,h))}break;case "end":this.events.emit("move-stop",new x(h)),this.destroyed||y()}return null});return{steps:d,cancel:e}}_connectTooltips(){this.removeHandles(I);let a;if(this._shouldShowMovePointTooltip){const b=this.objects.at(0),{events:c}=this;this._movePointTooltipInfo??(this._movePointTooltipInfo=new ja.MovePointTooltipInfo({viewType:this.view.type,sketchOptions:this.sketchOptions}));const d=
{onMoveStart:()=>{this._emitRecordUndo();c.emit("move-start",new C([b]))},onMove:()=>c.emit("move",new D(0,0,[b])),onMoveStop:()=>c.emit("move-stop",new x([b]))};a=W.connectTooltipToManipulatedObject(this.tooltip,b,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this._movePointTooltipInfo,callbacks:d}))}else a=w.watch(()=>this.sketchOptions.tooltips.effectiveEnabled?this._latestTooltipInfo:null,b=>{this.tooltip.info=b},w.syncAndInitial);this.addHandles(a,I)}_showTooltip(a){this._shouldShowMovePointTooltip||
this._updateMoveTooltip(a)}_hideTooltip(){this._shouldShowMovePointTooltip||(this.tooltip?.clear(),this._latestTooltipInfo=null)}_updateMoveTooltip(a,b){if(!this._shouldShowMovePointTooltip){var {sketchOptions:c}=this;switch(a){case n.ManipulationType.XY:this._latestTooltipInfo=this._translateTooltipInfo??(this._translateTooltipInfo=new ka.TranslateTooltipInfo({sketchOptions:c}));B(this._latestTooltipInfo,b,(d,e)=>H.autoDistanceBetweenPoints2D(d,e));break;case n.ManipulationType.XY_AXIS:this._latestTooltipInfo=
this._translateXYTooltipInfo??(this._translateXYTooltipInfo=new la.TranslateXYTooltipInfo({sketchOptions:c}));B(this._latestTooltipInfo,b,(d,e)=>v.scale(H.autoDistanceBetweenPoints2D(d,e),Z.axisConstrainedDragSign(b)));break;case n.ManipulationType.Z:this._latestTooltipInfo=this._translateZTooltipInfo??(this._translateZTooltipInfo=new ma.TranslateZTooltipInfo({sketchOptions:c})),B(this._latestTooltipInfo,b,na.verticalSignedDistanceBetweenPoints)}this._latestTooltipInfo.sketchOptions=c}}_emitRecordUndo(){const a=
this.objects.toArray().map(b=>b.createUndoRecord?.()).filter(J.isSome);0<a.length&&this.events.emit("record-undo",{updates:a})}_buildSnappingPipelineSteps(a,b,c,d,e){const f=A.manipulatedObjectGeometry(a);if(null==f||"point"!==f.type&&"mesh"!==f.type)return{steps:c,cancel:d};const k=("point"===f.type?f:f.anchor).clone(),h=new ea.SnappingContext({elevationInfo:b,pointer:e,editGeometryOperations:da.EditGeometryOperations.fromGeometry(k,this.view.state.viewingMode),visualizer:new R.SnappingVisualizer3D,
excludeFeature:a.graphic}),{snappingStep:r,cancelSnapping:t}=fa.createSnapDragEventPipelineStep({snappingContext:h,snappingManager:this.snappingManager,updatingHandles:this._updatingHandles});d=d.next(t);c=c.next(y=>{k.z=Q.getConvertedElevation(this.view,k,a.elevationInfo,{mode:"absolute-height",offset:0});const g=h.coordinateHelper.pointToVector(k);return{...y,snapOrigin:g}}).next(...r);return{steps:c,cancel:d}}};m.__decorate([p.property({constructOnly:!0,nonNullable:!0})],l.MoveTool3D.prototype,
"view",void 0);m.__decorate([p.property()],l.MoveTool3D.prototype,"objects",void 0);m.__decorate([p.property({constructOnly:!0,nonNullable:!0})],l.MoveTool3D.prototype,"enableZ",void 0);m.__decorate([p.property({constructOnly:!0,type:G})],l.MoveTool3D.prototype,"sketchOptions",void 0);m.__decorate([p.property({constructOnly:!0})],l.MoveTool3D.prototype,"snappingManager",void 0);m.__decorate([p.property()],l.MoveTool3D.prototype,"type",void 0);m.__decorate([p.property()],l.MoveTool3D.prototype,"updating",
null);m.__decorate([p.property()],l.MoveTool3D.prototype,"_latestTooltipInfo",void 0);m.__decorate([p.property()],l.MoveTool3D.prototype,"_shouldShowMovePointTooltip",null);m.__decorate([p.property()],l.MoveTool3D.prototype,"activeTooltipInfo",null);l.MoveTool3D=m.__decorate([N.subclass("esri.views.3d.interactive.editingTools.move.MoveTool3D")],l.MoveTool3D);class oa{constructor(a){this.object=a;this.manipulationXY=this.geometryRepresentation=null;this.dragging=!1}}l.MoveEvent=D;l.MoveStartEvent=
C;l.MoveStopEvent=x;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
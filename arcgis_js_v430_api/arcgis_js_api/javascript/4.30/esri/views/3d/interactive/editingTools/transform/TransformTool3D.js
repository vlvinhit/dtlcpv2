// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/Evented ../../../../../core/handleUtils ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../geometry/Point ../../../../ViewingMode ../../Manipulator3D ../../manipulatorUtils ../../SnappingVisualizer3D ../manipulatedObjectUtils ../manipulatorUtils ../meshFastUpdateUtils ../tooltipUtils3D ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ./ScaleRotateMeshAdapter ./ScaleRotateObjectSymbol3DAdapter ./ScaleRotateTransform ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/tooltipCommonUtils ../../../../interactive/tooltip/infos/TransformMeshTooltipInfo ../../../../interactive/tooltip/infos/TransformPointTooltipInfo".split(" "),
function(d,e,z,A,B,ca,u,m,f,da,C,D,E,F,G,H,I,n,v,J,K,L,M,p,N,O,P,Q,R,S,w,T,U,V,W,X,Y){d.TransformTool3D=class extends R.InteractiveToolBase{constructor(a){super(a);this.events=new A;this.enableScaling=this.enableRotation=this.enableZ=!0;this.sketchOptions=new w;this.type="transform-3d";this._updatingHandles=new D.UpdatingHandles;this._scaleRotate=null}initialize(){const {events:a,object:c,view:h}=this;this.tooltip=new V.Tooltip({view:h});this._moveManipulation=new p.MoveManipulation({tool:this,view:h,
snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&v.canMoveZOperations(c.operations,c.elevationInfo),radius:p.MoveManipulation.radiusForSymbol(c.graphic?.symbol)});this._moveManipulation.forEachManipulator(b=>this.addHandles(b.events.on("immediate-click",g=>{a.emit("immediate-click",{...g,object:this.object});g.stopPropagation()})));const q=c.elevationInfo;this._moveManipulation.elevationInfo=q;this.addHandles(J.meshTransformFastUpdateHandles(c));this._moveManipulation.createManipulatedObjectDragPipeline((b,
g,k,l,r)=>{if(b===p.ManipulationType.XY){const {snappingStep:Z,cancelSnapping:aa}=U.createSnapDragEventPipelineStep({snappingContext:new T.SnappingContext({elevationInfo:q,pointer:r,editGeometryOperations:S.EditGeometryOperations.fromGeometry(new E({spatialReference:c.operations?.data.spatialReference}),h.state.viewingMode),visualizer:new I.SnappingVisualizer3D,excludeFeature:c.graphic}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});l=l.next(aa);k=k.next(Q.sceneSnappingAtProjectedLocation(this.view,
q)).next(...Z)}return{steps:k,cancel:l}},c,b=>{const {action:g,object:k,dxScreen:l,dyScreen:r}=b;b={object:k,dxScreen:l,dyScreen:r};switch(g){case "start":this._emitRecordUndo();a.emit("translate-start",b);break;case "update":a.emit("translate",b);break;case "end":a.emit("translate-stop",b)}});this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0;this._scaleRotateAdapter=this._createScaleRotateAdapter();this.addHandles(m.watch(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle()));
if(this.enableScaling||this.enableRotation)this._scaleRotate=new P.ScaleRotateTransform({tool:this,mode:this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate",adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions,tooltipEnabled:"mesh"!==n.manipulatedObjectGeometry(c)?.type}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()));this.addHandles([L.createVisualElements({view:this.view,object:c,forEachManipulator:b=>this._forEachManipulator(b),
onManipulatorsChanged:()=>B.makeHandle()}),c.on("committed",()=>this._onGeometryChanged()),this._hideManipulatorsForObjectState(),m.watch(()=>h.scale,()=>this._updateMoveAngle())].filter(z.isSome));this._onGeometryChanged();this._updateMoveAngle();this._forEachManipulator(b=>{b instanceof G.Manipulator3D&&this.addHandles(b.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))});const x=h?.type,{sketchOptions:y}=this;this._meshTooltipInfo=new X.TransformMeshTooltipInfo({viewType:x,sketchOptions:y});
this._pointTooltipInfo=new Y.TransformPointTooltipInfo({viewType:x,sketchOptions:y});const t={object:c,dxScreen:0,dyScreen:0},ba={onMoveStart:()=>{this._emitRecordUndo();a.emit("translate-start",{...t})},onMove:()=>a.emit("translate",{...t}),onMoveStop:()=>a.emit("translate-stop",{...t}),onRotateStart:b=>{this._emitRecordUndo();a.emit("rotate-start",{object:c,angle:b})},onRotate:b=>a.emit("rotate",{object:c,angle:b}),onRotateStop:b=>a.emit("rotate-stop",{object:c,angle:b}),onScaleStart:(b,g)=>{this._emitRecordUndo();
a.emit("scale-start",{object:c,xScale:b,yScale:g})},onScale:(b,g)=>a.emit("scale",{object:c,xScale:b,yScale:g}),onScaleStop:(b,g)=>a.emit("scale-stop",{object:c,xScale:b,yScale:g})};this.addHandles(K.connectTooltipToManipulatedObject(this.tooltip,this.object,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this.activeTooltipInfo,callbacks:ba})));this.finishToolCreation()}destroy(){this.tooltip.destroy();this._moveManipulation.destroy();this._scaleRotate=u.destroyMaybe(this._scaleRotate);this._scaleRotateAdapter=
u.destroyMaybe(this._scaleRotateAdapter);this._updatingHandles.destroy();this._set("view",null);this._set("object",null)}onInputEvent(a){if(!this.destroyed&&!W.enterInputModeIfAvailable(a,this.tooltip))return super.onInputEvent(a)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){const a=n.manipulatedObjectGeometry(this.object);return"mesh"===
a?.type?new N.ScaleRotateMeshAdapter({object:this.object,geometry:a,viewingMode:this.view.state.viewingMode}):new O.ScaleRotateObjectSymbol3DAdapter({graphic:this.object.graphic,sizeFilter:c=>this._enforceNonZeroSize(c),findLayerView:()=>this.view.allLayerViews.find(c=>c.layer===this.object.graphic?.layer),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(a){this._moveManipulation?.forEachManipulator(a);this._scaleRotate?.forEachManipulator(a)}_hideManipulatorsForObjectState(){return m.watch(()=>
this.object.visible,a=>{this._forEachManipulator(c=>c.available=a);this._moveManipulation.zManipulation.available=a&&this.enableZ&&v.canMoveZOperations(this.object.operations,this.object.elevationInfo)})}_emitRecordUndo(){this.events.emit("record-undo",{updates:[this.object.createUndoRecord()]})}set snapToScene(a){this._moveManipulation&&(this._moveManipulation.snapToScene=a);this._set("snapToScene",a)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}get activeTooltipInfo(){return null!=
this._scaleRotate?.tooltip?.info?null:"mesh"===n.manipulatedObjectGeometry(this.object)?.type?this._meshTooltipInfo:this._pointTooltipInfo}set location(a){this._moveManipulation.location=a;this._scaleRotate&&(this._scaleRotate.location=a)}set elevationAlignedLocation(a){this._moveManipulation.elevationAlignedLocation=a;this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=a)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=
this._scaleRotate.getScale())}_updateMoveAngle(){const {view:a}=this;this._moveManipulation.angle=a.state.viewingMode===F.ViewingMode.Local||a.scale<M.alignArrowsScaleThreshold?this._scaleRotateAdapter.angle:0}_onGeometryChanged(){H.placeAtObject(this,this.object)}_enforceNonZeroSize(a){return a||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){}};e.__decorate([f.property({constructOnly:!0,nonNullable:!0})],d.TransformTool3D.prototype,"view",void 0);
e.__decorate([f.property({constructOnly:!0,nonNullable:!0})],d.TransformTool3D.prototype,"object",void 0);e.__decorate([f.property({constructOnly:!0,nonNullable:!0})],d.TransformTool3D.prototype,"enableZ",void 0);e.__decorate([f.property()],d.TransformTool3D.prototype,"enableRotation",void 0);e.__decorate([f.property()],d.TransformTool3D.prototype,"enableScaling",void 0);e.__decorate([f.property({constructOnly:!0,type:w})],d.TransformTool3D.prototype,"sketchOptions",void 0);e.__decorate([f.property({value:!1})],
d.TransformTool3D.prototype,"snapToScene",null);e.__decorate([f.property({constructOnly:!0})],d.TransformTool3D.prototype,"snappingManager",void 0);e.__decorate([f.property({readOnly:!0})],d.TransformTool3D.prototype,"type",void 0);e.__decorate([f.property({readOnly:!0})],d.TransformTool3D.prototype,"updating",null);e.__decorate([f.property()],d.TransformTool3D.prototype,"activeTooltipInfo",null);d.TransformTool3D=e.__decorate([C.subclass("esri.views.3d.interactive.editingTools.transform.TransformTool3D")],
d.TransformTool3D);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
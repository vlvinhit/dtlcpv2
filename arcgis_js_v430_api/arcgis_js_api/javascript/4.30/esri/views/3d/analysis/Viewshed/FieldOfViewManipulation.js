// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../core/Handles ../../../../core/handleUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/boundedPlane ./viewshedToolConfig ./viewshedToolUtils ../../interactive/Manipulator3D ../../interactive/RenderObject ../../interactive/editingTools/ManipulatorType ../../interactive/editingTools/manipulations/Manipulation ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Material ../../webgl-engine/lib/Util ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/dragEventPipeline ../../../interactive/interfaces".split(" "),
function(r,G,H,I,n,J,x,k,y,z,v,K,t,w,L,A,B,M,N,O,P,Q,R,C){function D(a,b,c,f=[0,0,0],e=10){P.assert(1<e,"createArcPolylineGeometry() needs at least 2 for numVertices");var h=b-a;const [g,d,l]=f;if(0>=h||0>=c)return[v.fromValues(g,d,l+.001),v.fromValues(g,d,d+-.001)];f=[];h/=e;for(let p=0;p<e;p++){var q=a+p*h;p===e-1&&(q=b);q=v.fromValues(Math.cos(q)*c+g,d,Math.sin(q)*c+l);f.push(q)}return f}function S(a){switch(a){case "left":return 0;case "bottom":return 1;case "right":return 2;case "top":return 3}}
function E(a){return S(a)*T}function u(a){return"left"===a||"right"===a}function U(a,{observerRenderSpace:b,targetDirection:c,tiltedUpVector:f,rightVector:e}){a=u(a)?e:f;return K.fromValues(b,c,a)}class V extends M.Manipulation{constructor(a){super();this._handles=new H;this._interactive=!0;this._tool=a.tool;this._view=a.view;this._focusedArcMaterial=this._createArcMaterial(!0);this._unfocusedArcMaterial=this._createArcMaterial(!1);this._createManipulators();this.forEachManipulator(b=>this._tool.manipulators.add(b))}destroy(){this._handles=
J.destroyMaybe(this._handles);this.forEachManipulator(a=>{this._tool.manipulators.remove(a);a.destroy()});this._manipulators=this._view=this._tool=null}get interactive(){return this._interactive}set interactive(a){this._interactive!==a&&(this._interactive=a,this._updateManipulatorInteractivity())}createDragPipeline(a,b){const c=Object.values(this._manipulators);return I.handlesGroup(c.map(({manipulator:f,side:e})=>R.createManipulatorDragEventPipeline(f,(h,g,d,l,q)=>{l=U(e,b);(u(e)?b.horizontalFieldOfView:
b.verticalFieldOfView)/2;g=g.next(p=>({...p,manipulatorType:B.ManipulatorType.SCALE,side:e}));g=w.screenToCircleAngle(g,this._view,l);a(h,g,d)})))}updateManipulatorsTransform(a){this._forEachManipulatorInfo(b=>this._updateArcManipulatorTransform(b,a))}updateManipulatorVisuals(a){this._forEachManipulatorInfo(b=>this._updateArcManipulatorVisuals(b,a))}_updateArcManipulatorVisuals({manipulator:a,side:b},c){const f=[];if(null!=c){if("left"===b&&(c.horizontalFieldOfView<t.angleOpenThreshold||c.horizontalFieldOfView>
360-t.angleOpenThreshold)||"bottom"===b&&c.verticalFieldOfView<t.angleOpenThreshold){a.renderObjects=[];a.collisionType={type:"line",paths:[]};return}var e=this._unfocusedArcMaterial;const {horizontalFieldOfView:h,verticalFieldOfView:g}=c;c=u(b);b=n.deg2rad(n.clamp((c?g:h)/2,0,15));c=c?1:Math.max(Math.sin(n.deg2rad(90-g/2)),.1);b=D(-b/2,b/2,c,[-c,0,0]);e=[N.createPolylineGeometry(e,b),b];const [d,l]=e;f.push(new A.RenderObject(d,C.ManipulatorStateFlags.Unfocused),new A.RenderObject(d.instantiate({material:this._focusedArcMaterial}),
C.ManipulatorStateFlags.Focused));a.collisionType={type:"line",paths:[l]}}a.renderObjects=f;a.radius=10}_updateArcManipulatorTransform({manipulator:a,side:b},c){var f=c.horizontalFieldOfView,e=n.deg2rad(c.verticalFieldOfView/2),h=n.deg2rad(f/2);const g=u(b);a.location=c.observer;const d=y.create();k.multiply(d,k.fromYRotation(m,n.deg2rad(-90)),d);g||k.multiply(d,k.fromXRotation(m,e),d);var l=c.farDistanceRenderSpace;k.multiply(d,k.fromScaling(m,z.set(F,l,l,l)),d);k.multiply(d,k.fromZRotation(m,E(b)),
d);k.multiply(d,w.getViewshedRotationMatrix(c,m),d);l=z.sub(F,c.targetRenderSpace,c.observerRenderSpace);k.multiply(d,k.fromTranslation(m,l),d);g?(e=h,h=c.tiltedUpVector,0!==f&&360!==f&&(f=w.computeOffsetScale(c,this._view),e+=2*Math.tan(f/(2*c.farDistance)))):h=c.rightVector;b=k.fromRotation(m,e*("right"===b||"bottom"===b?-1:1),h);null!=b&&k.multiply(d,b,d);a.modelTransform=d}_updateManipulatorInteractivity(){const a=this.grabbing;this.forEachManipulator(b=>{b.interactive=!a&&this.interactive||b.grabbing})}_createManipulators(){var a=
this._createArcManipulator("left");const b=this._createArcManipulator("right"),c=this._createArcManipulator("top"),f=this._createArcManipulator("bottom");this._manipulators={left:a,right:b,top:c,bottom:f};a=[[f.manipulator,c.manipulator],[a.manipulator,b.manipulator]];a.push(...a.map(([e,h])=>[h,e]));this._handles.add(a.map(([e,h])=>e.events.on("focus-changed",g=>{h.hovering="focus"===g.action})))}_createArcManipulator(a){a={manipulator:new L.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,
worldSized:!0}),side:a};this._updateArcManipulatorVisuals(a);return a}_createArcMaterial(a){const b=new Q.RibbonLineMaterial({renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0,width:a?t.fovFocusedArcWidth:t.fovUnfocusedArcWidth});this._handles.add(x.watch(()=>G.toUnitRGBA(this._view.effectiveTheme.accentColor),c=>b.setParameters({color:c}),x.initial));return b}forEachManipulator(a){Object.values(this._manipulators).forEach(({manipulator:b})=>a(b,B.ManipulatorType.SCALE))}_forEachManipulatorInfo(a){Object.values(this._manipulators).forEach(b=>
a(b))}}const T=Math.PI/2,m=y.create(),F=v.create();r.FieldOfViewManipulation=V;r.createArcPolylineVertices=D;r.isSideHorizontal=u;r.sideToRad=E;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
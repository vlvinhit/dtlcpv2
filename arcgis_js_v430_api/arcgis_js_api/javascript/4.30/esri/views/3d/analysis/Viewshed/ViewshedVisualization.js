// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../Color ../../../../core/Accessor ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ./viewshedToolUtils ../../interactive/visualElements/LineVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/lineStippleUtils".split(" "),
function(q,x,n,C,z,r,w,u,H,I,D,y,A,f,e,E,t,F,G){function v(a,c,b,d,g,l,m=5){var h=e.create();f.sub(h,b,c);var k=f.len(h),p=e.create();f.sub(p,d,c);f.normalize(p,p);f.scale(p,p,k);d=f.angle(h,p);k=e.clone(l);"backward"===g&&(f.negate(k,k),d=-(2*Math.PI-d));g=[];m=Math.ceil(Math.abs(d)/z.deg2rad(m));l=A.create();y.fromRotation(l,d/m,k);d=e.create();f.copy(d,h);h=e.create();f.copy(h,b);for(b=0;b<m;b++)k=e.create(),f.copy(k,h),f.transformMat4(d,d,l),f.add(h,c,d),p=e.create(),f.copy(p,h),g.push([k,p]);
a.geometry=g}const B=new x([85,85,85,.5]);n=class extends n{constructor(a){super(a);this.visible=!0;this._viewshedCorners={topLeft:e.create(),topRight:e.create(),bottomLeft:e.create(),bottomRight:e.create(),center:e.create()};this._arcCenterPoints={top:e.create(),bottom:e.create(),left:e.create(),right:e.create()};this._parallelCenters={top:e.create(),bottom:e.create()}}initialize(){const a={view:this.view,isDecoration:!0,color:this._color,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent},
c={...a,width:2,stipplePattern:G.createStipplePatternSimple(2)};this._boundaryLinesVisualElement=new t.LineVisualElement(a);this._leftArcVisualElement=new t.LineVisualElement(a);this._rightArcVisualElement=new t.LineVisualElement(a);this._topArcVisualElement=new t.LineVisualElement(a);this._bottomArcVisualElement=new t.LineVisualElement(a);this._centralLongitude=new t.LineVisualElement(c);this._centralLatitude=new t.LineVisualElement(c);this.addHandles([w.watch(()=>{const b=this.viewshedComputedData;
if(!b?.isValid())return null;const d=this._offsetScale,g=this._viewshedCorners,l=this._arcCenterPoints,m=this._parallelCenters;b.cornerPoints(d,g);b.arcCentersPoints(d,l);b.parallelCenterPoints(m);return{viewshedComputedData:b,corners:g,arcCenters:l,parallelCenters:m}},b=>{null!=b?(this._forEachVisualElement(d=>d.attached=!0),this._updateVisualElements(b)):this._forEachVisualElement(d=>d.attached=!1)},{initial:!0,equals:C.equals}),w.watch(()=>({visible:this.visible,horFOV:this.viewshedComputedData?.horizontalFieldOfView}),
({visible:b,horFOV:d},g)=>{b!==g?.visible&&this._forEachVisualElement(l=>l.visible=b);b&&d!==g?.horFOV&&(this._boundaryLinesVisualElement.visible=360!==d)},w.initial),w.watch(()=>this._color,b=>this._forEachVisualElement(d=>d.color=b),w.initial)])}get _color(){var a=this.viewshedComputedData;if(null==a)return x.toUnitRGBA(B);const c=this.analysisViewData,b=a===c.selectedViewshedComputedData;a=a.viewshed===c.tool?.stagedViewshed;return x.toUnitRGBA((c.tool?.active||c.interactive)&&(b||a)?this.view.effectiveTheme.accentColor:
B)}get _offsetScale(){return E.computeOffsetScale(this.viewshedComputedData,this.view)}destroy(){this._boundaryLinesVisualElement=r.destroyMaybe(this._boundaryLinesVisualElement);this._leftArcVisualElement=r.destroyMaybe(this._leftArcVisualElement);this._rightArcVisualElement=r.destroyMaybe(this._rightArcVisualElement);this._topArcVisualElement=r.destroyMaybe(this._topArcVisualElement);this._bottomArcVisualElement=r.destroyMaybe(this._bottomArcVisualElement);this._centralLongitude=r.destroyMaybe(this._centralLongitude);
this._centralLatitude=r.destroyMaybe(this._centralLatitude)}_forEachVisualElement(a){[this._boundaryLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(a)}_updateVisualElements(a){const {viewshedComputedData:c,corners:b,arcCenters:d,parallelCenters:g}=a;this._updateBoundaryLines(b);this._updateBoundaryArcs(c,b,g);this._updateCentralHelperArcs(c,d)}_updateBoundaryLines(a){this._boundaryLinesVisualElement.geometry=
[[a.center,a.topLeft],[a.center,a.topRight],[a.center,a.bottomLeft],[a.center,a.bottomRight]]}_updateBoundaryArcs(a,c,b){const {observerRenderSpace:d,rightVector:g,horizontalFieldOfView:l,tiltedUpVector:m}=a;a=z.deg2rad(l);const h=e.create(),k=A.create();y.fromRotation(k,a/2,m);f.transformMat4(h,g,k);v(this._leftArcVisualElement,d,c.bottomLeft,c.topLeft,"forward",h);y.fromRotation(k,-a/2,m);f.set(h,0,0,0);f.transformMat4(h,g,k);v(this._rightArcVisualElement,d,c.bottomRight,c.topRight,"forward",h);
a=180<l?"backward":"forward";v(this._topArcVisualElement,b.top,c.topRight,c.topLeft,a,m);v(this._bottomArcVisualElement,b.bottom,c.bottomRight,c.bottomLeft,a,m)}_updateCentralHelperArcs(a,c){const b=a.observerRenderSpace;v(this._centralLatitude,b,c.right,c.left,180<=a.horizontalFieldOfView?"backward":"forward",a.tiltedUpVector);v(this._centralLongitude,b,c.top,c.bottom,"forward",a.leftVector)}};q.__decorate([u.property()],n.prototype,"view",void 0);q.__decorate([u.property()],n.prototype,"analysisViewData",
void 0);q.__decorate([u.property()],n.prototype,"viewshedComputedData",void 0);q.__decorate([u.property()],n.prototype,"visible",void 0);q.__decorate([u.property()],n.prototype,"_color",null);q.__decorate([u.property()],n.prototype,"_offsetScale",null);return n=q.__decorate([D.subclass("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],n)});
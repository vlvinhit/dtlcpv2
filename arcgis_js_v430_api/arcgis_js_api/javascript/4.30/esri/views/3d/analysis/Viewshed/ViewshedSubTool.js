// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Cyclical ../../../../core/handleUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection ../../../ViewingMode ./FieldOfViewManipulation ./ScaleOrientManipulation ./viewshedToolConfig ./viewshedToolManipulatorUtils ../../interactive/editingTools/settings ../../interactive/editingTools/manipulations/config ../../interactive/editingTools/manipulations/MoveManipulation ../../interactive/visualElements/ExtendedLineVisualElement ../../interactive/visualElements/LaserlineVisualElement ../../webgl-engine/lib/Material ../../../interactive/dragEventPipeline ../../../interactive/editGeometry/EditGeometryOperations".split(" "),
function(l,n,z,A,u,B,r,e,p,S,T,C,v,D,E,F,w,G,H,I,J,K,L,M,N,O,t,P){const x=Symbol("dragHandles"),y=Symbol("hideManipulators");l.ViewshedSubTool=class extends z{constructor(a){super(a);this._moveHelperVisualElement=this._scaleOrientManipulation=this._fieldOfViewManipulation=this._observerManipulator=this._moveManipulation=null;this._settings=new J.Settings({getTheme:()=>this.view.effectiveTheme});this._grabbing=!1;this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation();
this._fieldOfViewManipulation=new w.FieldOfViewManipulation({view:this.view,tool:this.parentTool});this._scaleOrientManipulation=new G.ScaleOrientManipulation({view:this.view,tool:this.parentTool});this._observerManipulator=new I.ViewshedObserverManipulator(this.view,this.parentTool);this._createMoveHelperVisuals();this.addHandles([e.watch(()=>{const {observer:a}=this;return{observer:a,array:a?.toArray()}},({observer:a})=>{null!=a&&(this._moveManipulation.location=a,this._observerManipulator.location=
a)},e.syncAndInitial),e.watch(()=>{const {viewshedComputedData:a}=this;return{viewshedComputedData:a,observer:a?.observer}},({viewshedComputedData:a,observer:b},d)=>{this._grabbing&&b!==d?.observer||(this.removeHandles(x),a?.isValid()&&this.addHandles([this._buildObserverDragPipeline(a),this._buildFOVDragPipeline(a),this._buildScaleOrientDragPipeline(a)].filter(A.isSome),x))},e.initial),e.watch(()=>{const a=this.viewshedComputedData;return a?.isValid()?{viewshedCompData:a,target:a.targetRenderSpace,
hFOV:a.horizontalFieldOfView,vFOV:a.verticalFieldOfView}:null},a=>{null!=a&&this._fieldOfViewManipulation.updateManipulatorsTransform(a.viewshedCompData)},e.initial),e.watch(()=>{const a=this.viewshedComputedData;return a?.isValid()?{viewshedCompData:a,hFOV:a.horizontalFieldOfView,vFOV:a.verticalFieldOfView,tilt:a.tilt}:null},a=>{null!=a&&this._fieldOfViewManipulation.updateManipulatorVisuals(a.viewshedCompData)},e.initial),e.watch(()=>this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??
!1)&&!this.parentTool.placingTarget,a=>this._updateManipulationAvailability(a),e.initial),e.watch(()=>{const a=this.viewshedComputedData;if(!a?.isValid())return null;const {observer:b,target:d,verticalFieldOfView:q,horizontalFieldOfView:h}=a;return{viewshedCompData:a,observer:b,target:d,verticalFieldOfView:q,horizontalFieldOfView:h}},a=>{null!=a&&this._scaleOrientManipulation.updateManipulators(a.viewshedCompData)},e.initial),e.watch(()=>this.viewshedComputedData?.observerRenderSpace,a=>{null!=a&&
this._updateMoveHelperVisualsLocation(a)},e.initial)]);this._forEachManipulator(a=>{this.addHandles([a.events.on("focus-changed",()=>this._updateManipulatorVisibility()),a.events.on("grab-changed",b=>{this._grabbing="start"===b.action})])})}destroy(){this._moveManipulation=r.destroyMaybe(this._moveManipulation);this._fieldOfViewManipulation=r.destroyMaybe(this._fieldOfViewManipulation);this._scaleOrientManipulation=r.destroyMaybe(this._scaleOrientManipulation);this.parentTool.manipulators.remove(this._observerManipulator);
this._observerManipulator=r.destroyMaybe(this._observerManipulator);this._destroyMoveHelperVisuals()}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(a){const b=this.viewshed;null!=b&&(b.observer=a)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(a){let b=!1;this._forEachManipulator(d=>
{b=b||d===a});return b}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new L.MoveManipulation({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:K.discRadiusSmall})}_buildObserverDragPipeline(a){const b=
a.observer;return null==b?null:this._moveManipulation.createDragPipeline((d,q,h,g,f)=>{g=g.next(t.resetProperties(this,["observer"]));const c=a.observer.clone();if(null==c)return{steps:h,cancel:g};const k=P.EditGeometryOperations.fromGeometry(c,F.viewingModeFromString(this.view.viewingMode));return{steps:h.next(t.dragManipulatedObject({operations:k})).next(m=>{this.observer=E.project(k.data.geometry,c.spatialReference);return m}),cancel:g}},{mode:"absolute-height",offset:0},b.spatialReference,void 0)}_buildFOVDragPipeline(a){let b=
0,d=0;return this._fieldOfViewManipulation.createDragPipeline((q,h,g)=>{if(null==a)return{steps:h,cancel:g};const f=a.viewshed;g=g.next(t.resetProperties(a,["horizontalFieldOfView","verticalFieldOfView"]));return{steps:h.next(c=>{"start"===c.action&&(b=a.horizontalFieldOfView,d=a.verticalFieldOfView);const k=c.deltaAngle;let m=0;switch(c.side){case "left":m=b/2-k;break;case "right":m=b/2+k;break;case "top":m=d+2*k;break;case "bottom":m=d-2*k}w.isSideHorizontal(c.side)?(m=u.cyclicalDegrees.normalize(m),
f.horizontalFieldOfView=2*(270<m?0:180<m?180:m)):f.verticalFieldOfView=m;return c}),cancel:g}},a)}_buildScaleOrientDragPipeline(a){let b=0,d=0;const q=(h,g)=>(f,c,k)=>{if(null==a)return{steps:c,cancel:k};f=a.viewshed;k=k.next(t.resetProperties(f,[h]));c=c.next(g(f,a));return{steps:c,cancel:k}};return B.handlesGroup([this._scaleOrientManipulation.createHeadingDragPipeline(q("heading",(h,g)=>f=>{"start"===f.action&&(d=a.heading);h.heading=u.cyclicalDegrees.normalize(d+f.deltaAngle);return f}),a),this._scaleOrientManipulation.createTiltDragPipeline(q("tilt",
(h,g)=>f=>{"start"===f.action&&(b=a.tilt);let c=b+f.deltaAngle;-90>c?c=180:270<c&&(c=0);h.tilt=Q.clamp(c);return f}),a),this._scaleOrientManipulation.createDistanceDragPipeline(q("farDistance",(h,g)=>f=>{var c=v.sub(R,f.renderEnd,g.observerRenderSpace);const k=v.len(c)*g.metersPerUnit;c=0>v.dot(c,g.targetDirection)?H.scaleOrientMinDistance:k;h.farDistance=c;return f}),a)])}_updateManipulationAvailability(a){this._moveManipulation.available=a;this._fieldOfViewManipulation.available=a;this._scaleOrientManipulation.available=
a;this._observerManipulator.available=a}_updateManipulatorVisibility(){const a=this._someManipulatorSelected()||this._someManipulatorHovering()&&null==this.view.activeTool;if(a)this.removeHandles(y);else{const b=[];this._forEachManipulator(d=>{b.push(d.disableDisplay())});this.addHandles(b,y)}this._updateMoveHelperVisualsVisibility(a)}_forEachManipulator(a){this._moveManipulation.forEachManipulator(a);this._fieldOfViewManipulation.forEachManipulator(a);this._scaleOrientManipulation.forEachManipulator(a);
a(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const a=new N.LaserlineVisualElement({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),b=new M.ExtendedLineVisualElement({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:O.RenderOccludedFlag.OccludeAndTransparent,
isDecoration:!0});this._moveHelperVisualElement={laserline:a,verticalLine:b};this.addHandles([e.watch(()=>this._settings.visualElements.zVerticalLine,d=>d.apply(b),e.syncAndInitial),e.watch(()=>this._settings.visualElements.heightPlane,d=>d.apply(a),e.syncAndInitial)])}_updateMoveHelperVisualsVisibility(a){a=this.analysisViewData.visible&&a;const b=this._moveHelperVisualElement;null!=b&&(b.verticalLine.visible=a,b.laserline.visible=a)}_updateMoveHelperVisualsLocation(a){const b=this._moveHelperVisualElement;
if(null!=b){var {laserline:d,verticalLine:q}=b;d.heightManifoldTarget=a;d.intersectsWorldUpAtLocation=a;null!=a&&q.setStartEndFromWorldDownAtLocation(a)}}_destroyMoveHelperVisuals(){const a=this._moveHelperVisualElement;null!=a&&(a.laserline.destroy(),a.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,
viewshedComputedData:this.viewshedComputedData}}};n.__decorate([p.property({constructOnly:!0})],l.ViewshedSubTool.prototype,"analysis",void 0);n.__decorate([p.property({constructOnly:!0})],l.ViewshedSubTool.prototype,"analysisViewData",void 0);n.__decorate([p.property({constructOnly:!0})],l.ViewshedSubTool.prototype,"parentTool",void 0);n.__decorate([p.property({constructOnly:!0,nonNullable:!0})],l.ViewshedSubTool.prototype,"view",void 0);n.__decorate([p.property()],l.ViewshedSubTool.prototype,"viewshed",
null);n.__decorate([p.property()],l.ViewshedSubTool.prototype,"_grabbing",void 0);n.__decorate([p.property()],l.ViewshedSubTool.prototype,"grabbing",null);n.__decorate([p.property()],l.ViewshedSubTool.prototype,"viewshedComputedData",void 0);n.__decorate([p.property()],l.ViewshedSubTool.prototype,"observer",null);l.ViewshedSubTool=n.__decorate([C.subclass("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],l.ViewshedSubTool);const R=D.create(),Q=new u.Cyclical(0,180);Object.defineProperty(l,Symbol.toStringTag,
{value:"Module"})});
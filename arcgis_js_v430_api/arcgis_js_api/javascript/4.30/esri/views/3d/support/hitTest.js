// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../Graphic ../../../core/iteratorUtils ../../../core/screenUtils ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/projection/projectVectorToVector ../../../layers/LayerConstants ../../../layers/support/layerUtils ./debugFlags ./ElevationProvider ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/intersectorUtilsConversions ../webgl-engine/lib/verticalOffsetUtils ../../../geometry/SpatialReference ../../../geometry/Point".split(" "),
function(k,R,I,J,A,K,B,L,C,M,N,D,t,O,u,x,E,P){function q(a,b,c){return b.getIntersectionPoint(m)?(c=F(a,m,c),b.intersector===t.IntersectorType.TERRAIN&&a.basemapTerrain&&(c.z=N.getElevationAtPoint(a.basemapTerrain,c)??0),c):null}function v(a){var b=a.sourceLayer,c=a.layer;if(b=b&&"objectIdField"in b?b:c&&"objectIdField"in c?c:b)if(c=b.objectIdField??L.fallbackObjectIDAttribute,c=a.attributes?.[c])return`o-${b.id}-${c}`;return`u-${a.uid}`}function G(a,b){b=v(b);return H(a,b)}function H(a,b){return null==
a||(null==a.include||a.include.has(b))&&(null==a.exclude||!a.exclude.has(b))}function F(a,b,c){let d=a.spatialReference||E.WGS84;B.projectVectorToVector(b,a.renderSpatialReference,m,d)?b=m:(d=E.WGS84,B.projectVectorToVector(b,a.renderSpatialReference,m,d)&&(b=m));c?(c.x=b[0],c.y=b[1],c.z=b[2],c.spatialReference=d):c=new P(b,d);return c}function y(a,b){const c=z(a,b.include,r.INCLUDE);a=z(a,b.exclude,r.EXCLUDE);return{include:c.layerUids,exclude:a.layerUids,graphics:{include:c.graphicUids,exclude:a.graphicUids},
mediaElements:{include:c.mediaElements,exclude:a.mediaElements}}}function z(a,b,c,d={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!b)return d;if(b instanceof I){var e=v(b);d.graphicUids||(d.graphicUids=new Set);d.graphicUids.add(e);c===r.INCLUDE&&(null!=a.graphicsView&&b.layer===a?n(d,a.graphicsView.processor.layer.id):b.layer&&n(d,b.layer.uid))}else if("layer"in b&&"element"in b)a=b.element,d.mediaElements||(d.mediaElements=new Set),d.mediaElements.add(a),c===r.INCLUDE&&n(d,b.layer.uid);
else if(J.isIterable(b))for(e of b)e===a.graphics&&null!=a.graphicsView?n(d,a.graphicsView.processor.layer.id):e===a.map.ground?n(d,x.terrainId):z(a,e,c,d);else"uid"in b&&n(d,b.uid);return d}function n(a,b){a.layerUids||(a.layerUids=new Set);a.layerUids.add(b)}const m=K.create();var r;(function(a){a[a.INCLUDE=0]="INCLUDE";a[a.EXCLUDE=1]="EXCLUDE"})(r||={});k.computeMapPointFromVec3d=F;k.externalToInternalIntersectOptions=y;k.getGraphicFilterUid=v;k.hitTest=async function(a,b,c,d){d=c?y(a,c):d;var e=
A.createScreenPointArray(b.x,b.y);d.requiresGroundFeedback=!0;d.enableDraped=!0;c=D.newIntersector(a.state.viewingMode);c.options.selectionMode=!0;c.options.store=t.StoreResults.ALL;a.sceneIntersectionHelper.intersectIntersectorScreen(e,c,d);e=c.results.all;var h=d.graphics;d=[];let l=null;for(let w=0;w<e.length;w++){var g=e[w],f=u.toOwner(g,a);if(null!=f&&(f===a.map.ground||"type"in f&&C.isIntegratedMeshLayer(f.type)))break;f=u.toHit(g,a);if(null!=f){if("graphic"===f.type){null==l&&w!==e.length-
1&&(l=new Set);if(null!=l){var p=v(f.graphic);if(l.has(p))continue;l.add(p)}if(!G(h,f.graphic))continue}p=q(a,g);g=g.distanceInRenderSpace;if("media"===f.type){const Q=f.element.toSource(p);d.push({...f,mapPoint:p,distance:g,sourcePoint:Q})}else d.push({...f,mapPoint:p,distance:g})}}e=c.results.ground;h=u.toOwner(e,a);h=null!=h&&"type"in h&&C.isIntegratedMeshLayer(h.type)?h:null;a={screenPoint:b,results:d,ground:{mapPoint:q(a,e),distance:O.isValidIntersectorResult(e)?e.distanceInRenderSpace:0,layer:h}};
M.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(a.intersector=c);return a};k.intersectResultToMapPoint=q;k.toMap=function(a,b,c,d){d=c?y(a,c):d;const e=!(!d.graphics?.include&&!d.graphics?.exclude),h=!(!d.mediaElements?.include&&!d.mediaElements?.exclude);b=A.screenPointObjectToArray(b);d.enableDraped=d.include&&!d.include.has(x.terrainId)||d.exclude?.has(x.terrainId);const l=a.sceneIntersectionHelper,g=D.newIntersector(a.state.viewingMode);g.options.selectionMode=!0;g.options.store=e||h?t.StoreResults.ALL:
t.StoreResults.MIN;g.options.hud=!c?.excludeHud;l.intersectIntersectorScreen(b,g,d);if(e||h){for(const f of g.results.all)if(c=u.toHit(f,a),null==c||e&&("graphic"!==c.type||G(d.graphics,c.graphic))||h&&("media"!==c.type||H(d.mediaElements,c.element)))return q(a,f);return null}return q(a,g.results.min)};Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});
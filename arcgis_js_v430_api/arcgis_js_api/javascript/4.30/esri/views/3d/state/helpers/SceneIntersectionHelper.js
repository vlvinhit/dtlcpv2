// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.30/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/PooledArray ../../../../core/screenUtils ../../../../core/unitUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../../support/elevationInfoUtils ../../../ViewingMode ../../support/hitTest ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtils".split(" "),
function(B,K,z,L,u,D,v,M,t,N,O,E,F,x,q,C){function G(a){A&&A.viewingMode===a||(A=x.newIntersector(a));return A}class P{constructor(a,b,c){this.viewingMode=a;this._forEachLayer=b;this._view=c;this._externalIntersectionHandlers=new K;this._tolerance=x.defaultTolerance;this._tmpRay=M.create();this._tmpRegion=v.create();this._validateHUDIntersector=x.newIntersector(this.viewingMode);this._validateHUDIntersector.options.hud=!1}intersectScreen(a,b,c){return this.intersectRay(this._getPickRay(a,this._tmpRay),
G(this.viewingMode),b,c)}intersectScreenFreePointFallback(a,b,c){return this.intersectRayFreePointFallback(this._getPickRay(a,this._tmpRay),b,c)}intersectRayFreePointFallback(a,b,c){return this.intersectRay(a,G(this.viewingMode),b,c)||this._intersectRayFreePointLocal(a,b)}intersectRay(a,b,c,k){b.options.selectionMode=!1;b.options.store=q.StoreResults.MIN;this.computeIntersection(a,b,k);return b.results.min?b.results.min.getIntersectionPoint(c):!1}getCenterRayWithSubpixelOffset(a,b,c=.5,k=.5){a.getRenderCenter(w,
c,k);w[0]+=.0466;w[1]-=.0123;return F.fromRenderAtEye(a,w,b)}intersectIntersectorScreen(a,b,c){this.computeIntersection(this._getPickRay(a,this._tmpRay),b,c)}intersectToolIntersectorScreen(a,b,c){a=this._getPickRay(a,this._tmpRay);this.intersectToolIntersectorRay(a,b,c)}intersectToolIntersectorRay(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const k=b.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||C.isValidIntersectorResult(k)&&k.intersector!==q.IntersectorType.TERRAIN||
(b.options.selectionMode=!1,this.computeIntersection(a,b,c))}setTolerance(a=x.defaultTolerance){this._tolerance=a}addIntersectionHandler(a){this._externalIntersectionHandlers.push(a);this._externalIntersectionHandlers.sort((b,c)=>b.type===q.IntersectorType.TERRAIN?1:c.type===q.IntersectorType.TERRAIN?-1:0)}removeIntersectionHandler(a){null!=this._externalIntersectionHandlers.removeUnordered(a)&&this._externalIntersectionHandlers.sort((b,c)=>b.type===q.IntersectorType.TERRAIN?1:c.type===q.IntersectorType.TERRAIN?
-1:0)}_getPickRay(a,b){return F.fromScreen(this._view.state.camera,a,b)}_intersectRayFreePointLocal(a,b){if(this.viewingMode!==O.ViewingMode.Local||null==a)return!1;u.add(b,a.origin,u.normalize(t.sv3d.get(),a.direction));return!1}intersectElevationFromScreen(a,b,c=0,k=null){return this._intersectElevation(this._getPickRay(a,this._tmpRay),b,c,k)}_intersectElevation(a,b,c=0,k=null){if(null==a)return null;var d=this._view,{renderCoordsHelper:l}=d,h=L.getMetersPerVerticalUnitForSR(d.spatialReference),
m=null!=b?b.mode:"absolute-height";b=N.getElevationOffsetInMeters(b)/h;const p=("on-the-ground"!==m?b+c:0)*h/l.unitInMeters;({camera:h}=d.state);if("absolute-height"===m)return c=l?.getAltitude(h.eye),m=u.dot(u.normalize(y,a.direction),l.worldUpAtPosition(h.eye,Q)),c<p&&0>m||c>=p&&0<m?null:l.intersectInfiniteManifold(a,p,y)?(d=E.computeMapPointFromVec3d(d,y),d.z??(d.z=0),d.z-=b,d):null;const n=z.castRenderScreenPointArray3(t.sv3d.get());h.projectToRenderScreen(a.origin,n);l=new H(null,this._forEachLayer);
({slicePlane:b}=d);const r=null!=b?C.sliceFilterPredicate(b):null,e=x.newIntersector(this.viewingMode);e.options.store=q.StoreResults.MIN;e.options.verticalOffset=p;e.options.normalRequired=!1;b=a.origin;a=u.add(t.sv3d.get(),b,a.direction);e.reset(b,a,h);e.point=n;const g=k?"type"in k&&"graphics"===k.type?f=>f.layerUid!==k.uid:f=>f.graphicUid!==k.uid:null;switch(m){case "relative-to-scene":e.intersect(l.layers,n,this._tolerance,null,f=>(!g||g(f))&&!!f.lastValidElevationBB);this._externalIntersectionHandlers.forAll(f=>
{f.type!==q.IntersectorType.I3S&&f.type!==q.IntersectorType.TERRAIN&&f.type!==q.IntersectorType.TILES3D||f.intersect(e,f.slicePlaneEnabled?r:null,e.rayBegin,e.rayEnd,n)});break;case "on-the-ground":case "relative-to-ground":this._externalIntersectionHandlers.forAll(f=>{f.isGround&&f.intersect(e,f.slicePlaneEnabled?r:null,e.rayBegin,e.rayEnd,n)})}return e.results.min.getIntersectionPoint(y)?(d=E.computeMapPointFromVec3d(d,y),d.z=c,d):null}computeIntersection(a,b,c,k){if(null!=a){var d=this._view.state.camera,
l=z.castRenderScreenPointArray3(t.sv3d.get());d.projectToRenderScreen(a.origin,l);var h=new H(c,this._forEachLayer);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var m=a.origin,p=u.add(t.sv3d.get(),a.origin,a.direction);b.reset(m,p,d);b.intersect(h.layers,l,this._tolerance);a=this._view.slicePlane;var n=null!=a?C.sliceFilterPredicate(a):null;b.intersect(h.sliceableLayers,l,this._tolerance,n);var r=c&&(c.requiresGroundFeedback||c.enableDraped);this._externalIntersectionHandlers.forAll(e=>
{var g=e.layerUid;const f=Array.isArray(g);g=f?g:[g];f&&(b.options.filteredLayerUids=[]);let I=!1;for(const J of g)h.filterLayerUid(J)?I=!0:f&&b.options.filteredLayerUids.push(J);b.options.isFiltered=!I;(e.isGround&&r||!b.options.isFiltered)&&e.intersect(b,e.slicePlaneEnabled?n:null,m,p,l,k)});a=t.sv3d.get();d=this._view.basemapTerrain;if(c&&c.enableDraped&&null!=d.spatialReference&&b.results.ground.getIntersectionPoint(a)){c=d.overlayManager.renderer;const e=this._view.renderCoordsHelper.spatialReference,
g=t.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(a,g,d.spatialReference);g[2]=this._view.elevationProvider?.getElevation(a[0],a[1],a[2],e,"ground")??0;c.intersect(b,g,b.results.ground,f=>h.filterRenderGeometry(f))}b.sortResults();this._processHUDResults(b)}}_processHUDResults(a){var b=a.results.hud;v.copy(this._tmpRegion,v.negativeInfinity);const c=this._view.state.camera,k=[],d=this._tmpRegion;var l=e=>{const g=new R(e);c.projectToRenderScreen(e.target.center,g.screenPoint);g.screenPoint[0]=
Math.floor(g.screenPoint[0]);g.screenPoint[1]=Math.floor(g.screenPoint[1]);k.push(g);v.expandPointInPlace(d,g.screenPoint)};a.sortResults(b.all);null!=b.min.dist&&l(b.min);for(var h of b.all)b.min.target.object!==h.target.object&&b.max.target.object!==h.target.object&&l(h);null!=b.max.dist&&b.max.target.object!==b.min.target.object&&l(b.max);if(k.length){d[0]===d[2]&&(d[2]+=1);d[1]===d[3]&&(d[3]+=1);b=c.fullWidth;l=c.fullHeight;var m=Math.max(0,d[0]-1),p=Math.max(0,d[1]-1);h=Math.min(v.width(d)+2,
b-m);var n=Math.min(v.height(d)+2,l-p);if(!(0>=h||0>=n)){var r=new Uint8Array(h*n*4);this._view._stage.renderer.readHUDVisibility(m,p,h,n,r);m=!0;p=null==a.results.max.dist;n=0;for(const e of k)for(const g of S){const f=4*(Math.min(e.screenPoint[0]+g[0],b)-d[0]+(Math.min(e.screenPoint[1]+g[1],l)-d[1])*h);if(!(0>f||f>=r.length)&&r[f]){m&&(a.results.min.copy(e.result),m=!1);p&&a.results.max.copy(e.result);a.options.store===q.StoreResults.ALL&&a.results.all.splice(n++,0,e.result);break}}}}}}const S=
(()=>{const a=[];for(let b=-1;1>=b;b++)for(let c=-1;1>=c;c++)a.push([c+1,b+1]);return a})();class R{constructor(a){this.result=a;this.screenPoint=z.createRenderScreenPointArray3()}}let A;class H{constructor(a,b){this.layers=[];this.sliceableLayers=[];this.include=a?.include;this.exclude=a?.exclude;b(c=>{c.pickable&&this.filterLayerUid(c.apiLayerUid)&&(c.sliceable?this.sliceableLayers:this.layers).push(c)})}filterLayerUid(a){const {include:b,exclude:c}=this;return null==a?null==b&&null==c:(null==b||
b.has(a))&&(null==c||!c.has(a))}filterRenderGeometry(a){return this.filterLayerUid(a.layerUid)}}const y=D.create(),Q=D.create(),w=z.createRenderScreenPointArray3();B.SceneIntersectionHelper=P;B.isIntersectionHandler=function(a){return"object"===typeof a&&"intersect"in a};Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
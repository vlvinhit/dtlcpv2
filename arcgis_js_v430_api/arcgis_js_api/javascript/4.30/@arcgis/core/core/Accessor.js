/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{h as e,clone as t,equals as s,equalsShallow as r}from"./lang.js";import i from"./Handles.js";import{L as n}from"../chunks/Logger.js";import{d as o}from"../chunks/maybe.js";import{L as a,subclass as c,d as l}from"./accessorSupport/decorators/subclass.js";import{v as u,property as h,g as d,s as f}from"./accessorSupport/decorators/property.js";import{a as _}from"../chunks/metadata.js";import{O as p}from"../chunks/ObservableBase.js";import{F as m,t as g,r as v,a as y,b as E,i as O}from"../chunks/tracking.js";import{m as w}from"../chunks/handleUtils.js";import{schedule as S}from"./scheduling.js";import{a as b}from"../chunks/utils.js";import"../config.js";import"../chunks/ensureType.js";import"./Error.js";import"./promiseUtils.js";const A=new WeakMap;function T(t,s,r={}){e("esri-deprecation-warnings")&&k(t,`Module: ${s}`,r)}function N(t,s,r={}){if(e("esri-deprecation-warnings")){const{moduleName:e}=r;k(t,"Function: "+(e?e+"::":"")+s+"()",r)}}function C(t,s,r={}){if(e("esri-deprecation-warnings")){const{moduleName:e}=r;k(t,"Property: "+(e?e+"::":"")+s,r)}}function I(t,s,r={}){e("esri-deprecation-warnings")&&k(t,`Multiple argument constructor: ${s}`,{warnOnce:!0,replacement:`new ${s}({ <your properties here> })`,...r})}function k(t,s,r={}){if(e("esri-deprecation-warnings")){const{replacement:e,version:i,see:n,warnOnce:o}=r;let a=s;e&&(a+=`\n\tüõ†Ô∏è Replacement: ${e}`),i&&(a+=`\n\t‚öôÔ∏è Version: ${i}`),n&&(a+=`\n\tüîó See ${n} for more details.`),function(e,t,s=!1){const r=`üõë DEPRECATED - ${t}`;if(!s)return void e.warn(r);let i=A.get(e);i||(i=new Set,A.set(e,i)),i.has(t)||(i.add(t),e.warn(r))}(t,a,o)}}class D{constructor(e,t,s,r=1,i=0){if(this._ctor=e,this._acquireFunction=t,this._releaseFunction=s,this.allocationSize=r,this._pool=new Array(i),this._initialSize=i,this._ctor)for(let e=0;e<i;e++)this._pool[e]=new this._ctor;this.allocationSize=Math.max(r,1)}destroy(){this.prune(0)}acquire(...e){let t;if(D.test.disabled)t=new this._ctor;else{if(0===this._pool.length){const e=this.allocationSize;for(let t=0;t<e;t++)this._pool[t]=new this._ctor}t=this._pool.pop()}return this._acquireFunction?this._acquireFunction(t,...e):function(e){return e?.acquire&&"function"==typeof e.acquire}(t)&&t.acquire(...e),t}release(e){e&&!D.test.disabled&&(this._releaseFunction?this._releaseFunction(e):function(e){return e?.release&&"function"==typeof e.release}(e)&&e.release(),this._pool.push(e))}prune(e=this._initialSize){if(!(e>=this._pool.length)){for(let t=e;t<this._pool.length;++t){const e=this._pool[t];this._dispose(e)}this._pool.length=e}}_dispose(e){e.dispose&&"function"==typeof e.dispose&&e.dispose()}}var R;D.test={disabled:!1},function(e){e[e.DEFAULTS=0]="DEFAULTS",e[e.COMPUTED=1]="COMPUTED",e[e.SERVICE=2]="SERVICE",e[e.PORTAL_ITEM=3]="PORTAL_ITEM",e[e.WEB_SCENE=4]="WEB_SCENE",e[e.WEB_MAP=5]="WEB_MAP",e[e.LINK_CHART=6]="LINK_CHART",e[e.USER=7]="USER"}(R||(R={}));const q=R.USER+1;function B(e){switch(e){case"defaults":return R.DEFAULTS;case"service":return R.SERVICE;case"portal-item":return R.PORTAL_ITEM;case"web-scene":return R.WEB_SCENE;case"web-map":return R.WEB_MAP;case"link-chart":return R.LINK_CHART;case"user":return R.USER;default:return null}}function U(e){switch(e){case R.DEFAULTS:return"defaults";case R.SERVICE:return"service";case R.PORTAL_ITEM:return"portal-item";case R.WEB_SCENE:return"web-scene";case R.WEB_MAP:return"web-map";case R.LINK_CHART:return"link-chart";case R.USER:return"user"}}function j(e){return U(e)}class z extends p{constructor(e,t){super(),this.propertyName=e,this.metadata=t,this._accessed=null,this._handles=null,this.flags=0,this.flags=m.Dirty|(t.nonNullable?m.NonNullable:0)|(t.hasOwnProperty("value")?m.HasDefaultValue:0)|(void 0===t.get?m.DepTrackingInitialized:0)|(void 0===t.dependsOn?m.AutoTracked:0)}destroy(){this.flags&m.Dirty&&this.onCommitted(),super.destroy(),this._accessed=null,this._clearObservationHandles()}getComputed(e){g(this);const t=e.store,s=this.propertyName,r=this.flags,i=t.get(s);if(r&m.Computing)return i;if(~r&m.Dirty&&t.has(s))return i;this.flags|=m.Computing;const n=e.host;let o;r&m.AutoTracked?o=v(this,this.metadata.get,n):(y(n,this),o=this.metadata.get.call(n)),t.set(s,o,R.COMPUTED);const a=t.get(s);return a===i?this.flags&=~m.Dirty:E(this.commit,this),this.flags&=~m.Computing,a}onObservableAccessed(e){e!==this&&(this._accessed??=new Set,this._accessed.add(e))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=m.DepTrackingInitialized,null!=this._accessed&&(this._handles??=[],this._accessed.forEach((e=>{this._handles.push(e.observe(this))})),this._accessed.clear())}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}commit(){this.flags&=~m.Dirty,this.onCommitted()}_clearObservationHandles(){const e=this._handles;if(null!==e){for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}onInvalidated(){~this.flags&m.Overridden&&(this.flags|=m.Dirty);const e=this._observers;if(e&&e.length>0)for(const t of e)t.onInvalidated()}onCommitted(){const e=this._observers;if(e&&e.length>0){const t=e.slice();for(const e of t)e.onCommitted()}}}class L{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const s=new L;return this._values.forEach(((r,i)=>{e&&e.has(i)||s.set(i,t(r))})),s}get(e){return this._values.get(e)}originOf(){return R.USER}keys(){return[...this._values.keys()]}set(e,t){this._values.set(e,t)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}}function M(e,t,s){return void 0!==e}function P(e,t,s,r){return!(void 0===e||null==s&&e.flags&m.NonNullable&&(r.lifecycle,a.INITIALIZING,1))}class V{constructor(e){this.host=e,this.propertiesByName=new Map,this.ctorArgs=null,this.lifecycle=a.INITIALIZING,this.store=new L,this._origin=R.USER;const t=this.host.constructor.__accessorMetadata__;for(const e in t){const s=new z(e,t[e]);this.propertiesByName.set(e,s)}this.metadata=t}initialize(){this.lifecycle=a.CONSTRUCTING}constructed(){this.lifecycle=a.CONSTRUCTED}destroy(){this.lifecycle=a.DESTROYED,this.propertiesByName.forEach((e=>e.destroy()))}get initialized(){return this.lifecycle!==a.INITIALIZING}get(e){const t=this.propertiesByName.get(e);if(t.metadata.get)return t.getComputed(this);g(t);const s=this.store;return s.has(e)?s.get(e):t.metadata.value}originOf(e){const t=this.store.originOf(e);if(void 0===t){const t=this.propertiesByName.get(e);if(void 0!==t&&t.flags&m.HasDefaultValue)return"defaults"}return U(t)}has(e){return this.propertiesByName.has(e)&&this.store.has(e)}keys(){return[...this.propertiesByName.keys()]}internalGet(e){const t=this.propertiesByName.get(e);if(M(t))return this.store.has(e)?this.store.get(e):t.metadata.value}internalSet(e,t){const s=this.propertiesByName.get(e);M(s)&&this._internalSet(s,t)}getDependsInfo(e,t,s){const r=this.propertiesByName.get(t);if(!M(r))return"";const i=new Set,n=v({onObservableAccessed:e=>i.add(e),onTrackingEnd:()=>{}},(()=>r.metadata.get?.call(e)));let o=`${s}${e.declaredClass.split(".").pop()}.${t}: ${n}\n`;if(0===i.size)return o;s+="  ";for(const e of i)e instanceof z&&(o+=`${s}${e.propertyName}: undefined\n`);return o}setAtOrigin(e,t,s){const r=this.propertiesByName.get(e);if(M(r))return this._setAtOrigin(r,t,s)}isOverridden(e){const t=this.propertiesByName.get(e);return void 0!==t&&!!(t.flags&m.Overridden)}clearOverride(e){const t=this.propertiesByName.get(e);t&&t.flags&m.Overridden&&(t.flags&=~m.Overridden,t.notifyChange())}override(e,t){const s=this.propertiesByName.get(e);if(!P(s,0,t,this))return;const r=s.metadata.cast;if(r){const e=this._cast(r,t),{valid:s,value:i}=e;if(H.release(e),!s)return;t=i}s.flags|=m.Overridden,this._internalSet(s,t)}set(e,t){const s=this.propertiesByName.get(e);if(!P(s,0,t,this))return;const r=s.metadata.cast;if(r){const e=this._cast(r,t),{valid:s,value:i}=e;if(H.release(e),!s)return;t=i}const i=s.metadata.set;i?i.call(this.host,t):this._internalSet(s,t)}setDefaultOrigin(e){this._origin=B(e)}getDefaultOrigin(){return U(this._origin)}notifyChange(e){const t=this.propertiesByName.get(e);void 0!==t&&t.notifyChange()}invalidate(e){const t=this.propertiesByName.get(e);void 0!==t&&t.invalidate()}commit(e){const t=this.propertiesByName.get(e);void 0!==t&&t.commit()}_internalSet(e,t){const s=this.lifecycle!==a.INITIALIZING?this._origin:R.DEFAULTS;this._setAtOrigin(e,t,s)}_setAtOrigin(e,t,r){const i=this.store,n=e.propertyName;i.has(n,r)&&s(t,i.get(n))&&~e.flags&m.Overridden&&r===i.originOf(n)||(e.invalidate(),i.set(n,t,r),e.commit(),O(this.host,e))}_cast(e,t){const s=H.acquire();return s.valid=!0,s.value=t,e&&(s.value=e.call(this.host,t,s)),s}}const H=new D(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});var F;function $(e){e.length=0}!function(e){e[e.Ignore=0]="Ignore",e[e.Destroy=1]="Destroy",e[e.ThrowError=2]="ThrowError"}(F||(F={}));class W{constructor(e=50,t=50){this._pool=new D(Array,void 0,$,t,e)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return x.acquire()}static release(e){return x.release(e)}static prune(){x.prune()}}const x=new W(100);class G extends D{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=null}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}function Y(e,t){for(const s of e.entries())if(t(s[0]))return!0;return!1}function K(e,t){if(!t)return e;for(const s of t)null!=s&&e.add(s);return e}function Z(e,t){return null!=t&&e.add(t),e}function J(e,t){const s=new Set;return K(s,e),K(s,t),s}function Q(e,t){const s=new Set;for(const r of t)e.has(r)&&s.add(r);return s}function X(e,t){if(!e||!t)return!1;if(e===t)return!0;for(const s of e)if(!t.has(s))return!1;return!0}function ee(e,t){if(null==e&&null==t)return!0;if(null==e||null==t||e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;return!0}function te(e,t){const s=new Set(e);for(const e of t)s.delete(e);return s}function se(e,t){return te(J(e,t),Q(e,t))}function re(e){let t;for(t of e);return t}let ie=0;const ne=0;function oe(){return++ie}class ae{constructor(e){this._accessed=new Set,this._handles=[],this._observerObject=new ce(e),le.register(this,new WeakRef(this._observerObject),this)}destroy(){le.unregister(this._observerObject),this._accessed.clear(),this._observerObject?.destroy(),this.clear()}onObservableAccessed(e){this._accessed.add(e)}onTrackingEnd(){const e=this._handles,t=this._observerObject;this._accessed.forEach((s=>{e.push(s.observe(t))})),this._accessed.clear()}clear(){const e=this._handles;for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}class ce{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(1===e)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=ue}}const le=new FinalizationRegistry((e=>{e.deref()?.destroy()}));function ue(){}let he=!1;const de=[];function fe(e,t){let s=new ae((function n(){if(!s||i)return;if(he)return void me(n);const o=r;s.clear(),he=!0,i=!0,r=v(s,e),i=!1,he=!1,t(r,o),ge()})),r=null,i=!1;return i=!0,r=v(s,e),i=!1,w((function(){s&&(s.destroy(),s=null,r=null)}))}function _e(e,t){let s=new ae((function(){t(r,i)})),r=null;function i(){return s?(s.clear(),r=v(s,e),r):null}return i(),w((function(){s&&(s.destroy(),s=null),r=null}))}function pe(e){let t=new ae((function r(){t&&!s&&(he?me(r):(t.clear(),he=!0,s=!0,v(t,e),s=!1,he=!1,ge()))})),s=!1;return s=!0,v(t,e),s=!1,w((function(){t&&(t.destroy(),t=null)}))}function me(e){de.includes(e)||de.unshift(e)}function ge(){for(;de.length;)de.pop()()}var ve;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(ve||(ve={}));class ye{constructor(){this.uid=oe(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,r,i,n){return this.pool.acquire(ve.Untracked,e,t,r,i,n,s)}static acquireTracked(e,t,s,r){return this.pool.acquire(ve.Tracked,e,t,s,null,null,r)}notify(e,t){this.type===ve.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t,void 0,void 0)}acquire(e,t,s,r,i,n,o){this.uid=oe(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=s,this.getValue=r,this.target=i,this.path=n,this.equals=o}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=oe(),this.removed=!0}}ye.pool=new G(ye);const Ee=new W,Oe=new Set;let we;function Se(e){Oe.delete(e),Oe.add(e),we||(we=S(Ae))}function be(e){if(e.removed)return;const t=e.oldValue,s=e.getValue();e.equals(t,s)||(e.oldValue=s,e.notify(s,t))}function Ae(){let e=10;for(;we&&e--;){we=null;const e=Te(),t=Ee.acquire();for(const s of e){const e=s.uid;be(s),e===s.uid&&s.removed&&t.push(s)}for(const e of Oe)e.removed&&(t.push(e),Oe.delete(e));for(const e of t)ye.pool.release(e);Ee.release(t),Ee.release(e),Ne.forEach((e=>e()))}}function Te(){const e=Ee.acquire();e.length=Oe.size;let t=0;for(const s of Oe)e[t]=s,++t;return Oe.clear(),e}const Ne=new Set;function Ce(e){return Ne.add(e),w((()=>Ne.delete(e)))}function Ie(e,t,s=!1,i=r){return s?function(e,t,s){let r=!1;return fe(e,((e,i)=>{r||(r=!0,s(i,e)||t(e,i),r=!1)}))}(e,t,i):function(e,t,s){let r,i,n=_e(e,((e,o)=>{r&&r.uid!==i?n.remove():(r||(r=ye.acquireTracked(e,t,o,s),i=r.uid),Se(r))}));return w((()=>{n.remove(),r&&(r.uid!==i||r.removed||(r.removed=!0,Se(r)),r=null),n=null}))}(e,t,i)}function ke(e){return Y(Oe,(t=>t.oldValue===e))}var De,Re;function qe(e){if(null==e)return{value:e};if(Array.isArray(e))return{type:[e[0]],value:null};switch(typeof e){case"object":return e.constructor?.__accessorMetadata__||e instanceof Date?{type:e.constructor,value:e}:e;case"boolean":return{type:Boolean,value:e};case"string":return{type:String,value:e};case"number":return{type:Number,value:e};case"function":return{type:e,value:null};default:return}}const Be=Symbol("Accessor-Handles"),Ue=Symbol("Accessor-Initialized");class je{static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:t,declaredClass:s,constructor:r}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const i=this;class n extends i{constructor(...e){super(...e),this.inherited=null,r&&r.apply(this,e)}}_(n.prototype);for(const t in e){const s=e[t];n.prototype[t]="function"==typeof s?function(...e){const r=this.inherited;let n;this.inherited=function(...e){if(i.prototype[t])return i.prototype[t].apply(this,e)};try{n=s.apply(this,e)}catch(e){throw this.inherited=r,e}return this.inherited=r,n}:e[t]}for(const e in t){const s=qe(t[e]);h(s)(n.prototype,e)}return c(s)(n)}constructor(...e){if(this[De]=null,this[Re]=!1,this.constructor===je)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");const t=new V(this);Object.defineProperty(this,"__accessor__",{enumerable:!1,value:t}),e.length>0&&(t.ctorArgs=this.normalizeCtorArgs?.apply(this,e)??e[0])}postscript(){const e=this.__accessor__,t=e.ctorArgs;e.initialize(),t&&(this.set(t),e.ctorArgs=null),e.constructed(),this.initialize(),this[Ue]=!0}initialize(){}[l](){this[Be]=o(this[Be])}destroy(){this.destroyed||(function(e){for(const t of Oe.values())t.target===e&&(t.removed=!0)}(this),this.__accessor__.destroy())}[Symbol.dispose](){this.destroy()}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[Ue]}get destroyed(){return this.__accessor__?.lifecycle===a.DESTROYED||!1}commitProperty(e){d(this,e)}get(e){return N(n.getLogger(this),"`Accessor.get` is deprecated in favor of using optional chaining",{version:"4.28",see:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining"}),d(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,t){return f(this,e,t),this}watch(e,t,r){return function(e,t,r,i=!1){return e.__accessor__&&e.__accessor__.lifecycle!==a.DESTROYED?i?function(e,t,r){const i=b(e,t,r,((e,t,r)=>{let n=!1;return fe((()=>u(e,t)),((o,c)=>{e.__accessor__.lifecycle!==a.DESTROYED?n||(n=!0,s(c,o)||r.call(e,o,c,t,e),n=!1):i.remove()}))}));return i}(e,t,r):function(e,t,s){let r=b(e,t,s,((e,t,s)=>{let i,n,o=_e((()=>u(e,t)),((o,c)=>{e.__accessor__?.lifecycle===a.DESTROYED||i&&i.uid!==n?r.remove():(i||(i=ye.acquireUntracked(o,s,c,e,t),n=i.uid),Se(i))}));return w((()=>{o.remove(),i&&(i.uid!==n||i.removed||(i.removed=!0,Se(i)),i=null),r=o=null}))}));return r}(e,t,r):w()}(this,e,t,r)}addHandles(e,t){if(this.destroyed){const t=Array.isArray(e)?e:[e];for(const e of t)e.remove()}else(this[Be]??=new i).add(e,t)}removeHandles(e){this[Be]?.remove(e)}removeAllHandles(){this[Be]?.removeAll()}removeHandlesReference(e){this[Be]?.removeReference(e)}hasHandles(e){return!0===this[Be]?.has(e)}_override(e,t){void 0===t?this.__accessor__.clearOverride(e):this.__accessor__.override(e,t)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_overrideIfSome(e,t){null==t?this.__accessor__.clearOverride(e):this.__accessor__.override(e,t)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,t){return this.__accessor__.internalSet(e,t),this}}De=Be,Re=Ue;export{W as A,R as O,G as R,ae as S,pe as a,k as b,I as c,C as d,je as default,Z as e,K as f,oe as g,T as h,D as i,U as j,N as k,Q as l,j as m,B as n,q as o,re as p,ee as q,X as r,Y as s,te as t,J as u,Ce as v,Ie as w,ke as x,se as y,ne as z};

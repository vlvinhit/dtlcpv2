/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../config.js";import{i as e}from"./lang.js";import n from"./Error.js";import{isSerializable as r}from"./JSONSupport.js";import{L as s}from"../chunks/Logger.js";import"../chunks/tslib.es6.js";import"./Accessor.js";import"./Handles.js";import"../chunks/maybe.js";import"./accessorSupport/decorators/subclass.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"./accessorSupport/decorators/property.js";import"../chunks/ObservableBase.js";import"./scheduling.js";import"./promiseUtils.js";const o=/^https:\/\/([a-z\d-]+)(\.maps([^.]*))?\.arcgis\.com/i,i={devext:{customBaseUrl:"mapsdevext.arcgis.com",portalHostname:"devext.arcgis.com"},qaext:{customBaseUrl:"mapsqa.arcgis.com",portalHostname:"qaext.arcgis.com"},www:{customBaseUrl:"maps.arcgis.com",portalHostname:"www.arcgis.com"}};function l(t){const e=t?.match(o);if(!e)return null;const[,n,r,s]=e;if(!n)return null;let l=null,u=null,c=null;const{devext:a,qaext:p,www:f}=i;if(r)if(l=n,s)switch(s.toLowerCase()){case"devext":({customBaseUrl:u,portalHostname:c}=a);break;case"qa":({customBaseUrl:u,portalHostname:c}=p);break;default:return null}else({customBaseUrl:u,portalHostname:c}=f);else switch(n.toLowerCase()){case"devext":({customBaseUrl:u,portalHostname:c}=a);break;case"qaext":({customBaseUrl:u,portalHostname:c}=p);break;case"www":({customBaseUrl:u,portalHostname:c}=f);break;default:return null}return{customBaseUrl:u,isPortal:!1,portalHostname:c,urlKey:l}}function u(t){return/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(t)}function c(t){const e=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,n=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,r=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return e.test(t)?t=t.replace(e,"https://www.arcgis.com"):n.test(t)?t=t.replace(n,"https://devext.arcgis.com"):r.test(t)&&(t=t.replace(r,"https://qaext.arcgis.com")),t}function a(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n.buffer}const p=t.request,f="esri/config: esriConfig.request.proxyUrl is not set.",h=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,m=/^\s*http:/i,d=/^\s*https:/i,g=/^\s*file:/i,y=/:\d+$/,x=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,w=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),$=new RegExp("^((([^[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^[:]*))(:([0-9]+))?$");class U{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let e=this.uri.match(w);this.scheme=e[2]||(e[1]?"":null),this.authority=e[4]||(e[3]?"":null),this.path=e[5],this.query=e[7]||(e[6]?"":null),this.fragment=e[9]||(e[8]?"":null),null!=this.authority&&(e=this.authority.match($),this.user=e[3]||null,this.password=e[4]||null,this.host=e[6]||e[7],this.port=e[9]||null)}toString(){return this.uri}}const b={},O=new U(t.applicationUrl);let j=O;const q=function(){const t=j.path,e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${j.scheme}://${j.host}${null!=j.port?`:${j.port}`:""}${e}`}();let C=q;const v=()=>j,R=()=>C,k={setAppUrl:t=>j=t,setAppBaseUrl:t=>C=t,restoreUrls:()=>{j=O,C=q}};function L(t){if(!t)return null;const e={path:null,query:null},n=new U(t),r=t.indexOf("?");return null===n.query?e.path=t:(e.path=t.substring(0,r),e.query=A(n.query)),n.fragment&&(e.hash=n.fragment,null===n.query&&(e.path=e.path.substring(0,e.path.length-(n.fragment.length+1)))),e}function A(t){const e=t.split("&"),n={};for(const t of e){if(!t)continue;const e=t.indexOf("=");let r,s;e<0?(r=decodeURIComponent(t),s=""):(r=decodeURIComponent(t.slice(0,e)),s=decodeURIComponent(t.slice(e+1)));let o=n[r];"string"==typeof o&&(o=n[r]=[o]),Array.isArray(o)?o.push(s):n[r]=s}return n}function B(t,e){return t?e&&"function"==typeof e?Object.keys(t).map((n=>encodeURIComponent(n)+"="+encodeURIComponent(e(n,t[n])))).join("&"):Object.keys(t).map((n=>{const s=t[n];if(null==s)return"";const o=encodeURIComponent(n)+"=",i=e?.[n];return i?o+encodeURIComponent(i(s)):Array.isArray(s)?s.map((t=>r(t)?o+encodeURIComponent(JSON.stringify(t)):o+encodeURIComponent(t))).join("&"):r(s)?o+encodeURIComponent(JSON.stringify(s)):o+encodeURIComponent(s)})).filter((t=>t)).join("&"):""}function H(t=!1){let e,r=p.proxyUrl;if("string"==typeof t){e=ht(t);const n=T(t);n&&(r=n.proxyUrl)}else e=!!t;if(!r)throw s.getLogger("esri.core.urlUtils").warn(f),new n("urlUtils:proxy-not-set",f);return e&&gt()&&(r=dt(r)),L(r)}function I(t){const e=T(t);let n,r;if(e){const t=P(e.proxyUrl);n=t.path,r=t.query?A(t.query):null}if(n){const e=L(t);t=n+"?"+e.path;const s=B({...r,...e.query});s&&(t=`${t}?${s}`)}return t}const S={path:"",query:""};function P(t){const e=t.indexOf("?");return-1!==e?(S.path=t.slice(0,e),S.query=t.slice(e+1)):(S.path=t,S.query=null),S}function z(t){return(t=yt(t=$t(t=P(t).path),!0)).toLowerCase()}function E(t){const e={proxyUrl:t.proxyUrl,urlPrefix:z(t.urlPrefix)},n=p.proxyRules,r=e.urlPrefix;let s=n.length;for(let t=0;t<n.length;t++){const e=n[t].urlPrefix;if(0===r.indexOf(e)){if(r.length===e.length)return-1;s=t;break}0===e.indexOf(r)&&(s=t+1)}return n.splice(s,0,e),s}function T(t){const e=p.proxyRules,n=z(t);for(let t=0;t<e.length;t++)if(0===n.indexOf(e[t].urlPrefix))return e[t]}function W(t,e){if(!t||!e)return!1;t=D(t),e=D(e);const n=l(t),r=l(e);return null!=n&&null!=r?n.portalHostname===r.portalHostname:null==n&&null==r&&K(t,e,!0)}function J(t,e){if(!t||!e)return!1;t=D(t),e=D(e);const n=l(t),r=l(e);return null!=n&&null!=r&&n.portalHostname===r.portalHostname}function N(t,e){return t=D(t),e=D(e),yt(t)===yt(e)}function D(t){const e=(t=G(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function F(t,e=p.interceptors){const n=e=>null==e||e instanceof RegExp&&e.test(t)||"string"==typeof e&&t.startsWith(e);if(e)for(const t of e)if(Array.isArray(t.urls)){if(t.urls.some(n))return t}else if(n(t.urls))return t;return null}function K(t,e,n=!1){if(!t||!e)return!1;const r=Ot(t),s=Ot(e);return!(!n&&r.scheme!==s.scheme)&&null!=r.host&&null!=s.host&&r.host.toLowerCase()===s.host.toLowerCase()&&r.port===s.port}function M(t){if("string"==typeof t){if(!Y(t))return!0;t=Ot(t)}if(K(t,j))return!0;const e=p.trustedServers||[];for(let r=0;r<e.length;r++){const s=(n=e[r],b[n]||(ft(n)||pt(n)?b[n]=[new U(Q(n))]:b[n]=[new U(`http://${n}`),new U(`https://${n}`)]),b[n]);for(let e=0;e<s.length;e++)if(K(t,s[e]))return!0}var n;return!1}function Q(t,e=C,n){return pt(t)?n?.preserveProtocolRelative?t:"http"===j.scheme&&j.authority===X(t).slice(2)?`http:${t}`:`https:${t}`:ft(t)?t:V("/"===t[0]?function(t){const e=t.indexOf("//"),n=t.indexOf("/",e+2);return-1===n?t:t.slice(0,n)}(e):e,t)}function _(t,e=C,n){if(null==t||!Y(t))return t;const r=G(t),s=r.toLowerCase(),o=G(e).toLowerCase().replace(/\/+$/,""),i=n?G(n).toLowerCase().replace(/\/+$/,""):null;if(i&&0!==o.indexOf(i))return t;const l=(t,e,n)=>-1===(n=t.indexOf(e,n))?t.length:n;let u=l(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,u+1)===o.slice(0,u)+"/"&&(c=u+1,u!==s.length);)u=l(s,"/",u+1);if(-1===c)return t;if(i&&c<i.length)return t;t=r.slice(c);const a=o.slice(c-1).replaceAll(/[^/]+/g,"").length;if(a>0)for(let e=0;e<a;e++)t=`../${t}`;else t=`./${t}`;return t}function G(t){return function(t){const e=p.httpsDomains;if(!function(t){return null!=t&&m.test(t)||"http"===j.scheme&&pt(t)}(t))return t;const n=t.indexOf("/",7);let r;if(r=-1===n?t:t.slice(0,n),r=r.toLowerCase().slice(7),y.test(r)){if(!r.endsWith(":80"))return t;r=r.slice(0,-3),t=t.replace(":80","")}return"http"!==j.scheme||r!==j.authority||x.test(t)?((gt()&&r===j.authority||e&&e.some((t=>r===t||r.endsWith(`.${t}`)))||gt()&&!T(t))&&(t=dt(t)),t):t}(t=function(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}(t=function(t){if(/^https?:\/\//i.test(t)){const e=P(t);t=(t=e.path.replaceAll(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}(t=Q(t=t.trim()))))}function V(...t){const n=t.filter(e);if(!n?.length)return;const r=[];if(Y(n[0])){const t=n[0],e=t.indexOf("//");-1!==e&&(r.push(t.slice(0,e+1)),null!=(s=n[0])&&g.test(s)&&(r[0]+="/"),n[0]=t.slice(e+2))}else"/"===n[0][0]&&r.push("");var s;const o=n.reduce(((t,e)=>e?t.concat(e.split("/")):t),[]);for(let t=0;t<o.length;t++){const e=o[t];".."===e&&r.length>0&&".."!==r[r.length-1]?r.pop():(!e&&t===o.length-1||e&&("."!==e||0===r.length))&&r.push(e)}return r.join("/")}function X(t,e=!1){if(null==t||Z(t)||tt(t))return null;let n=t.indexOf("://");if(-1===n&&pt(t))n=2;else{if(-1===n)return null;n+=3}const r=t.indexOf("/",n);return-1!==r&&(t=t.slice(0,r)),e&&(t=yt(t,!0)),t}function Y(t){return pt(t)||ft(t)}function Z(t){return null!=t&&"blob:"===t.slice(0,5)}function tt(t){return null!=t&&"data:"===t.slice(0,5)}function et(t){const e=st(t);return e?.isBase64?a(e.data):null}function nt(t){return function(t){const e=new Uint8Array(t);let n="";for(let t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return btoa(n)}(t).replaceAll("+","-").replaceAll("/","_").replace(/=+$/,"")}const rt=/^data:(.*?)(;base64)?,(.*)$/;function st(t){const e=t.match(rt);if(!e)return null;const[,n,r,s]=e;return{mediaType:n,isBase64:!!r,data:s}}function ot(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}async function it(t){return(await fetch(t)).blob()}function lt(t){const e=et(t);if(!e)return null;const n=st(t);return new Blob([e],{type:n.mediaType})}function ut(t,e){!function(t,e){const n=lt(t);if(!n)return!1;at(n,e)}(t,e)}function ct(t,e){at(t,e)}function at(t,e){if(!t)return!1;const n=document.createElement("a");if(!("download"in n))return!1;const r=URL.createObjectURL(t);return n.download=e,n.href=r,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),!0}function pt(t){return null!=t&&"/"===t[0]&&"/"===t[1]}function ft(t){return null!=t&&h.test(t)}function ht(t){return null!=t&&d.test(t)||"https"===j.scheme&&pt(t)}function mt(t){return pt(t)?`http:${t}`:t.replace(d,"http:")}function dt(t){return pt(t)?`https:${t}`:t.replace(m,"https:")}function gt(){return"https"===j.scheme}function yt(t,e=!1){return pt(t)?t.slice(2):(t=t.replace(h,""),e&&t.length>1&&"/"===t[0]&&"/"===t[1]&&(t=t.slice(2)),t)}function xt(t){let e=0;if(Y(t)){const n=t.indexOf("//");-1!==n&&(e=n+2)}const n=t.lastIndexOf("/");return n<e?t:t.slice(0,n+1)}function wt(t,e){if(!t)return"";const n=L(t).path.replace(/\/+$/,""),r=n.substring(n.lastIndexOf("/")+1);if(!e?.length)return r;const s=new RegExp(`\\.(${e.join("|")})$`,"i");return r.replace(s,"")}function $t(t){return t.endsWith("/")?t:`${t}/`}function Ut(t){return t.replace(/\/+$/,"")}function bt(t,e,n){if(!(e&&n&&t&&Y(t)))return t;const r=t.indexOf("//"),s=t.indexOf("/",r+2),o=t.indexOf(":",r+2),i=Math.min(s<0?t.length:s,o<0?t.length:o);return t.slice(r+2,i).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,r+2)}${n}${t.slice(i)}`}function Ot(t){return"string"==typeof t?new U(Q(t)):(t.scheme||(t.scheme=j.scheme),t)}function jt(t){return Ht.test(t)}function qt(t,e){const n=L(t),r=Object.keys(n.query||{});return r.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),n.path}function Ct(t,e,n){const r=L(t),s=r.query||{};return s[e]=String(n),`${r.path}?${B(s)}`}function vt(t,e){if(!e)return t;const n=L(t),r=n.query||{};for(const[t,n]of Object.entries(e))null!=n&&(r[t]=n);const s=B(r);return s?`${n.path}?${s}`:n.path}function Rt(t,e){const{path:n,query:r}=L(t);if(!r)return t;delete r[e];const s=B(r);return s?`${n}?${s}`:n}function kt(t){if(null==t)return null;const e=t.match(Bt);return e?e[2]:null}function Lt(t){if(null==t)return null;const e=t.match(Bt);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}}async function At(t){return"string"==typeof t?st(t)??{data:t}:new Promise(((e,n)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=()=>e(st(r.result)),r.onerror=t=>n(t)}))}const Bt=/([^.]*)\.([^/]*)$/,Ht=/(^data:image\/svg|\.svg$)/i;export{U as Url,I as addProxy,E as addProxyRule,Ct as addQueryParameter,vt as addQueryParameters,a as b,nt as base64UrlEncode,it as blobUrlToBlob,bt as changeDomain,st as dataComponents,et as dataToArrayBuffer,lt as dataToBlob,ct as downloadBlobAsFile,ut as downloadDataAsFile,$t as ensureTrailingSlash,R as getAppBaseUrl,v as getAppUrl,wt as getFilename,F as getInterceptor,X as getOrigin,kt as getPathExtension,T as getProxyRule,H as getProxyUrl,ft as hasProtocol,J as hasSameCanonicalArcGISOnlinePortal,W as hasSameCanonicalPortal,K as hasSameOrigin,N as hasSamePortal,u as i,Y as isAbsolute,gt as isAppHTTPS,Z as isBlobProtocol,tt as isDataProtocol,ht as isHTTPSProtocol,pt as isProtocolRelative,jt as isSVG,M as isTrustedServer,V as join,Q as makeAbsolute,ot as makeData,_ as makeRelative,c as n,G as normalize,B as objectToQuery,l as p,At as parseData,A as queryToObject,o as r,xt as removeFile,Rt as removeQueryParameter,qt as removeQueryParameters,Ut as removeTrailingSlash,Lt as splitPathExtension,k as test,mt as toHTTP,dt as toHTTPS,b as trustedServersUrlCache,L as urlToObject};

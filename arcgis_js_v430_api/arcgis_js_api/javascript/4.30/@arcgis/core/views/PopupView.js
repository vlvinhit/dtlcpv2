/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{c as p}from"../chunks/asyncUtils.js";import{b as s}from"../core/Accessor.js";import t from"../core/Error.js";import{h as o}from"../core/lang.js";import{L as i}from"../chunks/Logger.js";import{throwIfAborted as r,wrapAbortWithTimeout as n,allSettledValues as a,createResolver as u}from"../core/promiseUtils.js";import{watch as c,initial as h,whenOnce as l}from"../core/reactiveUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{V as w}from"../chunks/InputManager.js";import"../chunks/maybe.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../config.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/ensureType.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/Queue.js";import"../core/signal.js";function y(e){return null!=e&&"open"in e&&"declaredClass"in e}function f(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const g=u=>{let g=class extends u{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([c((()=>[this.ui,this.popup]),(([e,p],s)=>{const t="popup";if(s){const[e,p]=s;e&&y(p)&&(p.view=null,f(p)&&e.remove(p,t))}e&&y(p)&&(p.view=this,f(p)&&e.add(p,{key:t,position:"manual",internal:!0}))}),h),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(y(this.popup)?this.popup.viewModel.handleViewClick(e):e.async((async()=>{await this.setupPopup(),y(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)})))}),w.WIDGET)]),l((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{import("../widgets/Popup.js")}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(y(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void i.getLogger(this).error(new t("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),y(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,p){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,p),p)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!y(this.popup))return this._popupSetupTask=p((async e=>{const{default:p}=await import("../widgets/Popup.js");if(r(e),!this.popup||y(this.popup))return;const s=this.popup;delete s.open,delete s.close,this.popup=new p(s)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:p},s){const t=[],i=[];let r=!1;const u=n(s,o("popup-view-fetch-timeout")??v),c=e=>{const p=i.at(-1);return p&&p.layerView===e&&!r?p:(e=>{const p=new P(e);return i.push(p),t.push(p.promise),p})(e)};for(const e of p)"graphic"in e?(c(e.layerView).graphics.push(e.graphic),r=!1):(t.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,u)),r=!0);i.map((e=>e.resolve(u)));const h=a(t).then((e=>e.filter((e=>!!e)).flat()));return{pendingFeatures:t,allGraphicsPromise:h,location:e}}async _getPopupHits(e,p){const{hits:s,location:t}=await this.popupHitTest(e);r(p);const o=[];for(const e of s)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,p)){const p=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;o.push({graphic:e.graphic,layerView:p})}}else this._isValidPopupLocationLayerView(e.layerView)&&o.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:o,location:t}}_isValidPopupGraphic(e,p){return e&&!!e.getEffectivePopupTemplate(p?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return e([d({cast(e){return!e||y(e)||"object"==typeof e&&(e.open=e=>(s(i.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(e)),e.close=()=>(s(i.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),e}})],g.prototype,"popup",void 0),e([d()],g.prototype,"popupEnabled",void 0),g=e([m("esri.views.PopupView")],g),g};class P{constructor(e){this.layerView=e,this._resolver=u(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:p,graphics:s,_resolver:t}=this;if(!p)return t.resolve(s),t.promise;let o;return p.fetchPopupFeaturesFromGraphics(s,e).catch((e=>(o=e,null))).then((e=>{e?t.resolve(e):t.reject(o)})),t.promise}}const v=5e3;export{g as PopupView};

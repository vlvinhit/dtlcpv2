/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import{d as i,a as s}from"../../../chunks/maybe.js";import{watch as o,initial as r,mapCollection as n,syncAndInitial as a,sync as l}from"../../../core/reactiveUtils.js";import{property as p}from"../../../core/accessorSupport/decorators/property.js";import{equals as c,i as h}from"../../../core/lang.js";import"../../../chunks/Logger.js";import{subclass as u}from"../../../core/accessorSupport/decorators/subclass.js";import{A as d}from"../../../chunks/AnalysisView3D.js";import{d as m,h as v}from"../../../chunks/handleUtils.js";import f from"../../../Color.js";import{r as w,d as _,c as y}from"../../../chunks/mathUtils.js";import{f as b,E as g,F as j,y as V,z as M,c as k,m as S,B as D}from"../../../chunks/mat4.js";import{c as C}from"../../../chunks/mat4f64.js";import{e as O,p as T,h as E,s as P,x as R,f as A,n as H,b as U,q as F,u as L,i as x,j as I,m as z,d as B}from"../../../chunks/vec3.js";import{c as G,e as W,f as q,d as N}from"../../../chunks/vec3f64.js";import{distance as K}from"../../../geometry/geometryEngine.js";import{c as Q,r as J,n as Z}from"../../../chunks/plane.js";import{b as X,a as Y,R as $,M as ee,c as te}from"../../../chunks/RenderObject.js";import{a as ie,d as se}from"../../../chunks/dragEventPipeline3D.js";import{L as oe}from"../../../chunks/LineVisualElement.js";import{R as re}from"../../../chunks/Material.js";import{c as ne}from"../../../chunks/lineStippleUtils.js";import"../../../geometry.js";import ae from"../../../geometry/Point.js";import le from"../../../analysis/Viewshed.js";import{c as pe,C as ce}from"../../../chunks/Cyclical.js";import{project as he}from"../../../geometry/projection.js";import{v as ue}from"../../../chunks/ViewingMode.js";import de from"../../../core/Handles.js";import{f as me}from"../../../chunks/boundedPlane.js";import{m as ve,o as fe}from"../../../chunks/sliceToolConfig.js";import{M as we,a as _e,b as ye,d as be}from"../../../chunks/MoveManipulation.js";import{c as ge,i as je,g as Ve,d as Me}from"../../../chunks/GeometryUtil.js";import{a as ke}from"../../../chunks/Util.js";import{R as Se}from"../../../chunks/RibbonLineMaterial.js";import{c as De,e as Ce,r as Oe,d as Te}from"../../../chunks/InteractiveToolBase.js";import{a as Ee}from"../../../chunks/interfaces.js";import{e as Pe}from"../../../chunks/ray.js";import{C as Re}from"../../../chunks/basicInterfaces.js";import{C as Ae}from"../../../chunks/ColorMaterial.js";import"../../../chunks/tracking.js";import"../../../core/Error.js";import{S as He}from"../../../chunks/settings.js";import{a as Ue}from"../../../chunks/ExtendedLineVisualElement.js";import{L as Fe}from"../../../chunks/LaserlineVisualElement.js";import{E as Le}from"../../../chunks/EditGeometryOperations.js";import{A as xe}from"../../../chunks/AnalysisToolBase.js";import{s as Ie}from"../../../chunks/keybindings.js";import{n as ze}from"../../../chunks/ToolIntersector.js";import{a as Be}from"../../../chunks/screenUtils2.js";import{V as Ge}from"../../../chunks/Viewshed.js";import{c as We,r as qe,a as Ne}from"../../../chunks/analysisViewUtils.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/ObservableBase.js";import"../../../core/scheduling.js";import"../../../core/promiseUtils.js";import"../../../config.js";import"../../../chunks/asyncUtils.js";import"../../../core/Collection.js";import"../../../core/Evented.js";import"../../../chunks/ensureType.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../core/Promise.js";import"../../../chunks/colorUtils.js";import"../../../chunks/common.js";import"../../../chunks/geometryEngineBase.js";import"../../../chunks/_commonjsHelpers.js";import"../../../chunks/hydrated.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../core/JSONSupport.js";import"../../../chunks/reader.js";import"../../../geometry/SpatialReference.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/writer.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/extentUtils.js";import"../../../chunks/aaBoundingRect.js";import"../../../geometry/Polyline.js";import"../../../chunks/mat3f64.js";import"../../../chunks/quatf64.js";import"../../../chunks/vec2f64.js";import"../../../chunks/vec4f64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/compilerUtils.js";import"../../../chunks/screenUtils.js";import"../../../chunks/mat3.js";import"../../../chunks/vec2.js";import"../../../chunks/computeTranslationToOriginAndRotation.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../chunks/lineSegment.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../core/Clonable.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../intl.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/timeZoneUtils.js";import"../../../chunks/datetime.js";import"../../../chunks/number.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../symbols.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils4.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils5.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../chunks/persistableUrlUtils.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/dehydratedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/ElevationProvider.js";import"../../../chunks/ray2.js";import"../webgl/RenderCamera.js";import"../../../chunks/vec4.js";import"../../../chunks/frustum.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/graphicUtils.js";import"../../../chunks/BufferView.js";import"../../../chunks/InterleavedLayout.js";import"../../../chunks/types.js";import"../../../chunks/Matrix4PassUniform.js";import"../../../chunks/interfaces3.js";import"../../../chunks/BindType.js";import"../../../chunks/StencilUtils.js";import"../../../chunks/Indices.js";import"../../../chunks/triangle.js";import"../../../chunks/VertexAttribute.js";import"../../../chunks/doublePrecisionUtils.js";import"../../../chunks/ShaderTechniqueConfiguration.js";import"../../../chunks/debugFlags2.js";import"../../../chunks/requestImageUtils.js";import"../../../chunks/enums.js";import"../../../chunks/Texture.js";import"../../../chunks/GLObjectType.js";import"../../../chunks/renderState.js";import"../../../chunks/RayIntersections.js";import"../../../chunks/OutputHighlight.glsl.js";import"../../../chunks/VertexPosition.glsl.js";import"../../../chunks/Matrix3DrawUniform.js";import"../../../chunks/Intersector2.js";import"../../../chunks/verticalOffsetUtils.js";import"../../../chunks/sphere.js";import"../../../chunks/orientedBoundingBox.js";import"../../../chunks/quat.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../chunks/Attribute.js";import"../../../chunks/Object3DVisualElement.js";import"../../../chunks/VisualElement.js";import"../../../chunks/line.js";import"../../../chunks/DoubleArray.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/vec3f32.js";import"../../../chunks/Octree.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../geometry/support/MeshLocalVertexSpace.js";import"../../../chunks/TriangleMaterial.js";import"../../../chunks/vec4f32.js";import"../../../chunks/EngineVisualElement.js";import"../../../chunks/RenderGeometry.js";import"../../../chunks/IntegerPassUniform.js";import"../../../chunks/NormalAttribute.glsl.js";import"../../../chunks/axisAngleDegrees.js";import"../../../chunks/weather.js";import"../environment/CloudyWeather.js";import"../environment/FoggyWeather.js";import"../environment/RainyWeather.js";import"../environment/SnowyWeather.js";import"../environment/SunnyWeather.js";import"../../../chunks/Scheduler.js";import"../../../core/signal.js";import"../../../chunks/debugFlags.js";import"../../../chunks/ScreenSpacePass.glsl.js";import"../../../chunks/Float4DrawUniform.js";import"../../../chunks/NestedMap.js";import"../../../chunks/VertexArrayObject2.js";import"../../../chunks/VertexArrayObject.js";import"../../../chunks/Intersector.js";import"../../../chunks/glUtil.js";import"../../../chunks/VertexElementDescriptor.js";import"../../../chunks/MemCache.js";import"../../../chunks/BufferObject.js";import"../../../chunks/CameraSpace.glsl.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/InputManager.js";import"../../../chunks/Queue.js";import"../../../chunks/Matrix4sPassUniform.js";function Ke({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const o=X(e,t,i,s);return o[12]=0,o[13]=0,o[14]=0,o}function Qe(e,t,i){const s=G(),o=O(G(),i.basis1,i.basis2);return e.next(ie(t,i.plane)).next((e=>{"start"===e.action&&T(s,e.renderStart);const t=w(Y(s,e.renderEnd,i.origin,o));return{...e,deltaAngle:t}}))}function Je(e,t){if(null==e)return 0;const{observer:i,target:s}=e,o=t.camera.position,r=K(o,i)>K(o,s)?i:s;return t.pixelSizeAt(r)}const Ze=new f([85,85,85,.5]);let Xe=class extends t{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:G(),topRight:G(),bottomLeft:G(),bottomRight:G(),center:G()},this._arcCenterPoints={top:G(),bottom:G(),left:G(),right:G()},this._parallelCenters={top:G(),bottom:G()}}initialize(){const e={view:this.view,isDecoration:!0,color:this._color,renderOccluded:re.OccludeAndTransparent},t={...e,width:2,stipplePattern:ne(2)};this._boundaryLinesVisualElement=new oe(e),this._leftArcVisualElement=new oe(e),this._rightArcVisualElement=new oe(e),this._topArcVisualElement=new oe(e),this._bottomArcVisualElement=new oe(e),this._centralLongitude=new oe(t),this._centralLatitude=new oe(t),this.addHandles([o((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const t=this._offsetScale,i=this._viewshedCorners,s=this._arcCenterPoints,o=this._parallelCenters;return e.cornerPoints(t,i),e.arcCentersPoints(t,s),e.parallelCenterPoints(o),{viewshedComputedData:e,corners:i,arcCenters:s,parallelCenters:o}}),(e=>{null!=e?(this._forEachVisualElement((e=>e.attached=!0)),this._updateVisualElements(e)):this._forEachVisualElement((e=>e.attached=!1))}),{initial:!0,equals:c}),o((()=>({visible:this.visible,horFOV:this.viewshedComputedData?.horizontalFieldOfView})),(({visible:e,horFOV:t},i)=>{e!==i?.visible&&this._forEachVisualElement((t=>t.visible=e)),e&&t!==i?.horFOV&&(this._boundaryLinesVisualElement.visible=360!==t)}),r),o((()=>this._color),(e=>this._forEachVisualElement((t=>t.color=e))),r)])}get _color(){const e=this.viewshedComputedData;if(null==e)return f.toUnitRGBA(Ze);const t=this.analysisViewData,i=t.tool?.active||t.interactive,s=e===t.selectedViewshedComputedData,o=e.viewshed===t.tool?.stagedViewshed,r=i&&(s||o)?this.view.effectiveTheme.accentColor:Ze;return f.toUnitRGBA(r)}get _offsetScale(){return Je(this.viewshedComputedData,this.view)}destroy(){this._boundaryLinesVisualElement=i(this._boundaryLinesVisualElement),this._leftArcVisualElement=i(this._leftArcVisualElement),this._rightArcVisualElement=i(this._rightArcVisualElement),this._topArcVisualElement=i(this._topArcVisualElement),this._bottomArcVisualElement=i(this._bottomArcVisualElement),this._centralLongitude=i(this._centralLongitude),this._centralLatitude=i(this._centralLatitude)}_forEachVisualElement(e){[this._boundaryLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:o}=e;this._updateBoundaryLines(i),this._updateBoundaryArcs(t,i,o),this._updateCentralHelperArcs(t,s)}_updateBoundaryLines(e){this._boundaryLinesVisualElement.geometry=[[e.center,e.topLeft],[e.center,e.topRight],[e.center,e.bottomLeft],[e.center,e.bottomRight]]}_updateBoundaryArcs(e,t,i){const{observerRenderSpace:s,rightVector:o,horizontalFieldOfView:r,tiltedUpVector:n}=e,a=_(r),l=G(),p=C();b(p,a/2,n),E(l,o,p),Ye(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),b(p,-a/2,n),P(l,0,0,0),E(l,o,p),Ye(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const c=r>180?"backward":"forward";Ye(this._topArcVisualElement,i.top,t.topRight,t.topLeft,c,n),Ye(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,c,n)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";Ye(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),Ye(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}};function Ye(e,t,i,s,o,r,n=5){const a=G();R(a,i,t);const l=A(a),p=G();R(p,s,t),H(p,p),U(p,p,l);let c=F(a,p);const h=W(r);"backward"===o&&(L(h,h),c=-(2*Math.PI-c));const u=[],d=Math.ceil(Math.abs(c)/_(n)),m=C();b(m,c/d,h);const v=G();T(v,a);const f=G();T(f,i);for(let e=0;e<d;e++){const e=G();T(e,f),E(v,v,m),x(f,t,v);const i=G();T(i,f),u.push([e,i])}e.geometry=u}e([p()],Xe.prototype,"view",void 0),e([p()],Xe.prototype,"analysisViewData",void 0),e([p()],Xe.prototype,"viewshedComputedData",void 0),e([p()],Xe.prototype,"visible",void 0),e([p()],Xe.prototype,"_color",null),e([p()],Xe.prototype,"_offsetScale",null),Xe=e([u("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],Xe);const $e=Xe;let et=class extends t{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=n((()=>this.analysisViewData.viewshedComputedDataHandles),(({viewshedComputedData:t})=>{const i=new $e({view:this.view,viewshedComputedData:t,analysisViewData:e});return{visualization:i,remove:()=>i.destroy()}}));this._viewshedVisualizations=t,this.addHandles([m(t),o((()=>this.visible),(e=>this._viewshedVisualizations.forEach((({visualization:t})=>t.visible=e))))])}};var tt;e([p({constructOnly:!0})],et.prototype,"analysisViewData",void 0),e([p({constructOnly:!0,nonNullable:!0})],et.prototype,"view",void 0),e([p({constructOnly:!0})],et.prototype,"isDecoration",void 0),e([p()],et.prototype,"visible",null),et=e([u("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],et);let it=tt=class extends t{constructor(e){super(e)}get observer(){return this.viewshed.observer??new ae}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,G())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){const{leftVector:e,northVector:t,upVector:i}=this,s=this.observerRenderSpace,o=this.farDistanceRenderSpace,r=G();return U(r,t,o),ot(r,-_(this.heading),i,r),ot(r,-_(this.tiltParallelToSurface),e,r),x(r,s,r),r}get targetDirection(){const e=R(G(),this.targetRenderSpace,this.observerRenderSpace);return H(e,e)}get tiltedUpVector(){const e=ot(this.upVector,-_(this.tiltParallelToSurface),this.leftVector,G());return H(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,C())}get upVector(){const e=this._basis;return q(e[8],e[9],e[10])}get northVector(){const e=this._basis;return q(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=ot(this.northVector,-_(this.heading),e,G());return O(t,e,t)}get rightVector(){return L(G(),this.leftVector)}clone(){return new tt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:o}=this,r=R(lt,o,s);return ot(r,-_(t),this.leftVector,r),ot(r,-_(e),this.tiltedUpVector,r),x(i,r,s)}cornerPoints(e,t){const i=this.observerRenderSpace,s=this.horizontalFieldOfView/2,o=this.verticalFieldOfView/2,r=this.pointOnSphere(-s,o,ft),n=this.pointOnSphere(s,o,wt),a=this.pointOnSphere(-s,-o,_t),l=this.pointOnSphere(s,-o,yt),p=R(ut,r,i),c=R(dt,n,i),h=R(mt,a,i),u=R(vt,l,i),{horizontalFieldOfView:d}=this,m=ct;st(p,c,r,a,i,e,d,t.topLeft,t.bottomLeft,m);const v=ht;st(u,h,n,l,i,e,d,t.topRight,t.bottomRight,v),U(t.center,x(t.center,v,m),.5)}arcCentersPoints(e,t){const i=this.horizontalFieldOfView/2,s=this.verticalFieldOfView/2,o=this.pointOnSphere(0,s,t.top),r=this.pointOnSphere(0,-s,t.bottom),n=this.pointOnSphere(-i,0,t.left),a=this.pointOnSphere(i,0,t.right),{observerRenderSpace:l}=this;at(o,l,e),at(r,l,e),at(n,l,e),at(a,l,e)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(_(this.verticalFieldOfView/2)),s=U(lt,this.tiltedUpVector,i);x(e.top,t,s),R(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=lt;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new ae(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=N(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}};function st(e,t,i,s,o,r,n,a,l,p){const c=rt(e,t,r,pt);x(p,o,c),nt(i,e,c,r,n,a),nt(s,e,c,r,n,l)}function ot(e,t,i,s){return b(bt,t,i),E(s,e,bt)}function rt(e,t,i,s){const o=O(s,e,t);return H(o,o),U(o,o,i),o}function nt(e,t,i,s,o,r){const n=H(lt,t);return U(n,n,s),x(r,e,n),0!==o&&360!==o&&x(r,r,i),r}function at(e,t,i){const s=R(lt,e,t);H(s,s),U(s,s,i),x(e,e,s)}e([p()],it.prototype,"renderCoordsHelper",void 0),e([p()],it.prototype,"viewshed",void 0),e([p()],it.prototype,"observer",null),e([p()],it.prototype,"farDistance",null),e([p()],it.prototype,"farDistanceRenderSpace",null),e([p()],it.prototype,"heading",null),e([p()],it.prototype,"tilt",null),e([p()],it.prototype,"tiltParallelToSurface",null),e([p()],it.prototype,"horizontalFieldOfView",null),e([p()],it.prototype,"verticalFieldOfView",null),e([p()],it.prototype,"observerRenderSpace",null),e([p()],it.prototype,"target",null),e([p()],it.prototype,"targetRenderSpace",null),e([p()],it.prototype,"targetDirection",null),e([p()],it.prototype,"tiltedUpVector",null),e([p()],it.prototype,"_basis",null),e([p()],it.prototype,"upVector",null),e([p()],it.prototype,"northVector",null),e([p()],it.prototype,"leftVector",null),e([p()],it.prototype,"rightVector",null),e([p()],it.prototype,"isValid",null),e([p()],it.prototype,"metersPerUnit",null),it=tt=e([u("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],it);const lt=G(),pt=G(),ct=G(),ht=G(),ut=G(),dt=G(),mt=G(),vt=G(),ft=G(),wt=G(),_t=G(),yt=G(),bt=C(),gt=ve,jt=fe*gt,Vt=.0025,Mt=Math.sin(_(2)),kt=fe/1.5;class St extends we{constructor(e){super(),this._handles=new de,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=i(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createDragPipeline(e,t){const i=Object.values(this._manipulators);return v(i.map((({manipulator:i,side:s})=>De(i,((i,o,r,n,a)=>{const l=function(e,{observerRenderSpace:t,targetDirection:i,tiltedUpVector:s,rightVector:o}){const r=Ct(e)?o:s;return me(t,i,r)}(s,t);Ct(s)?t.horizontalFieldOfView:t.verticalFieldOfView;const p=Qe(o.next((e=>({...e,manipulatorType:_e.SCALE,side:s}))),this._view,l);e(i,p,r)})))))}updateManipulatorsTransform(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e)))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(null!=i){if("left"===t&&(i.horizontalFieldOfView<1||i.horizontalFieldOfView>359)||"bottom"===t&&i.verticalFieldOfView<1)return e.renderObjects=[],void(e.collisionType={type:"line",paths:[]});const[o,r]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:o}=t,r=Ct(e),n=_(y((r?o:s)/2,0,15)),a=r?1:Math.max(Math.sin(_(90-o/2)),.1),l=Dt(-n/2,n/2,a,[-a,0,0]);return[ge(i,l),l]}(t,i,this._unfocusedArcMaterial);s.push(new $(o,Ee.Unfocused),new $(o.instantiate({material:this._focusedArcMaterial}),Ee.Focused)),e.collisionType={type:"line",paths:[r]}}e.renderObjects=s,e.radius=10}_updateArcManipulatorTransform({manipulator:e,side:t},i){const s=i.horizontalFieldOfView,o=_(i.verticalFieldOfView/2),r=_(s/2),n=Ct(t);e.location=i.observer;const a=C(),l=e=>{S(a,e,a)};l(g(Tt,_(-90))),n||l(j(Tt,o));const p=i.farDistanceRenderSpace;l(V(Tt,P(Et,p,p,p))),l(M(Tt,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*Ot}(t))),l(Ke(i,Tt));const c=R(Et,i.targetRenderSpace,i.observerRenderSpace);let h,u;if(l(k(Tt,c)),n){if(h=r,u=i.tiltedUpVector,0!==s&&360!==s){const e=Je(i,this._view);h+=2*Math.tan(e/(2*i.farDistance))}}else u=i.rightVector,h=o;h*="right"===t||"bottom"===t?-1:1;const d=b(Tt,h,u);null!=d&&l(d),e.modelTransform=a}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this.interactive||t.grabbing}))}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s};const o=[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]];o.push(...o.map((([e,t])=>[t,e]))),this._handles.add(o.map((([e,t])=>e.events.on("focus-changed",(e=>{const i="focus"===e.action;t.hovering=i})))))}_createArcManipulator(e){const t={manipulator:new ee({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),side:e};return this._updateArcManipulatorVisuals(t),t}_createArcMaterial(e){const t=e?jt:gt,i=new Se({renderOccluded:re.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add(o((()=>f.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),r)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((({manipulator:t})=>e(t,_e.SCALE)))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}}function Dt(e,t,i,s=[0,0,0],o=10){ke(o>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e,[n,a,l]=s;if(r<=0||i<=0){const e=.001;return[q(n,a,l+e),q(n,a,a+-e)]}const p=[],c=r/o;for(let s=0;s<o;s++){let r=e+s*c;s===o-1&&(r=t);const h=Math.cos(r)*i,u=Math.sin(r)*i,d=q(h+n,a,u+l);p.push(d)}return p}function Ct(e){return"left"===e||"right"===e}const Ot=Math.PI/2,Tt=C(),Et=G();class Pt extends ee{constructor(e,t,i,s){super({view:e,autoScaleRenderObjects:!1,worldSized:!0,radius:5}),this._handles=new de,this._setupManipulatorVisual(t,i,s)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e,t,i){const s=this._createMaterial(),o=_(t),r=e?1:Math.sin(o),n=e?Dt(0,o,r,[-r,0,0]):[q(0,0,0),q(0,0,r)],a=je(s,n,i,16,!1),l=je(s,n,i*fe,16,!1),p=Rt(!1,s,i),c=Rt(!0,s,i),h=C();k(h,n[n.length-1]),D(h,h,j(Ht,Math.PI/2)),D(h,h,g(Ht,Math.PI/2)),e&&D(h,h,j(Ht,-o)),p.transformation=h,c.transformation=h,this.renderObjects=[new $(a,Ee.Unfocused),new $(l,Ee.Focused),new $(p,Ee.Unfocused),new $(c,Ee.Focused)];const u=q(0,At(!0),0),d=E(u,u,h),m=[...n,d];this.collisionType={type:"line",paths:[m]}}_createMaterial(){const e=new Ae({cullFace:Re.Back,renderOccluded:re.OccludeAndTransparent,isDecoration:!0,writeLinearDepth:!0});return this._handles.add(o((()=>f.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),r)),e}}function Rt(e,t,i){const s=At(e);let o=2*i;e&&(o*=fe);const r=s/2;return Ve(t,s,r,r,o,0)}function At(e){let t=Mt;return e&&(t*=kt),t}const Ht=C();class Ut extends we{constructor(e){super(),this._handles=new de,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._manipulatorHeading=new Pt(this._view,!0,5,Vt),this._manipulatorTilt=new Pt(this._view,!0,5,Vt),this._manipulatorDistance=new Pt(this._view,!1,5,Vt),this.forEachManipulator((e=>{this._tool.manipulators.add(e),this._handles.add(e.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createHeadingDragPipeline(e,t){return De(this._manipulatorHeading,((i,s,o,r,n)=>{const{_view:a}=this,l=Math.sin(_(t.tiltParallelToSurface))*t.farDistanceRenderSpace,p=x(It,t.observerRenderSpace,U(zt,t.upVector,l)),c=O(zt,t.northVector,t.upVector),h=Qe(s,a,me(p,t.northVector,c)).next((e=>({...e,manipulatorType:_e.ROTATE})));e(i,h,o)}))}createTiltDragPipeline(e,t){return De(this._manipulatorTilt,((i,s,o,r,n)=>{const a=me(t.observerRenderSpace,t.targetDirection,t.tiltedUpVector),l=Qe(s,this._view,a).next((e=>({...e,manipulatorType:_e.ROTATE})));e(i,l,o)}))}createDistanceDragPipeline(e,t){return De(this._manipulatorDistance,((i,s,o,r,n)=>{const a=Pe(t.observerRenderSpace,t.targetDirection),l=s.next(Ce(this._view,i.location)).next(se(this._view,a)).next((e=>({...e,manipulatorType:_e.SCALE})));e(i,l,o)}))}updateManipulators(e){const{target:t}=e;this._manipulatorHeading.location=t,this._manipulatorTilt.location=t,this._manipulatorDistance.location=t;const i=C(),s=e=>{S(i,e,i)},o=function(e){const{verticalFieldOfView:t,horizontalFieldOfView:i}=e,s=t>180,o=i>180,r=e.farDistanceRenderSpace;if(s&&o)return Math.max(1,r);e.arcCentersPoints(r,Ft);const{left:n,right:a,top:l,bottom:p}=Ft,c=1.9*(s?I(n,a):o?I(p,n):Math.sqrt(Math.min(z(p,l),z(n,a))));return Math.max(1,Math.min(r,c))}(e);s(V(Lt,P(It,o,o,o))),s(Ke(e,Lt));const r=Vt*fe*o,n=U(It,e.targetDirection,r);s(k(Lt,n));const a=M(Lt,-Bt);D(a,a,g(xt,-Bt)),this._manipulatorHeading.modelTransform=D(C(),i,a);const l=g(Lt,Bt);D(l,l,M(xt,Math.PI)),this._manipulatorTilt.modelTransform=S(C(),i,l),this._manipulatorDistance.modelTransform=i}_updateManipulatorInteractivity(){const e=!this.grabbing;this.forEachManipulator((t=>{t.interactive=e&&this._interactive||t.grabbing}))}forEachManipulator(e){e(this._manipulatorHeading,_e.ROTATE),e(this._manipulatorTilt,_e.ROTATE),e(this._manipulatorDistance,_e.SCALE)}}const Ft={top:G(),bottom:G(),left:G(),right:G()},Lt=C(),xt=C(),It=G(),zt=G(),Bt=Math.PI/2;class Gt extends ee{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:5,interactive:!1}),this._handles=new de;const i=te(this._color);this.renderObjects=[new $(Me(i,5,32,32))],t.manipulators.add(this),this._handles.add([o((()=>this._color),(e=>{i.setParameters({color:e})}),r)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return f.toUnitRGBA(this.view.effectiveTheme.accentColor)}}e([p()],Gt.prototype,"_color",null);const Wt=Symbol("dragHandles"),qt=Symbol("hideManipulators");let Nt=class extends t{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._moveHelperVisualElement=null,this._settings=new He({getTheme:()=>this.view.effectiveTheme}),this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new St({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ut({view:this.view,tool:this.parentTool}),this._observerManipulator=new Gt(this.view,this.parentTool),this._createMoveHelperVisuals(),this.addHandles([o((()=>{const{observer:e}=this;return{observer:e,array:e?.toArray()}}),(({observer:e})=>{null!=e&&(this._moveManipulation.location=e,this._observerManipulator.location=e)}),a),o((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:t},i)=>{this._grabbing&&t!==i?.observer||(this.removeHandles(Wt),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(h),Wt))}),r),o((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),r),o((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),r),o((()=>this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1)&&!this.parentTool.placingTarget),(e=>this._updateManipulationAvailability(e)),r),o((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:o}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),r),o((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&this._updateMoveHelperVisualsLocation(e)}),r)]),this._forEachManipulator((e=>{this.addHandles([e.events.on("focus-changed",(()=>this._updateManipulatorVisibility())),e.events.on("grab-changed",(e=>{this._grabbing="start"===e.action}))])}))}destroy(){this._moveManipulation=i(this._moveManipulation),this._fieldOfViewManipulation=i(this._fieldOfViewManipulation),this._scaleOrientManipulation=i(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=i(this._observerManipulator),this._destroyMoveHelperVisuals()}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new ye({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:be})}_buildObserverDragPipeline(e){const t=e.observer;return null==t?null:this._moveManipulation.createDragPipeline(((t,i,s,o,r)=>{o=o.next(Oe(this,["observer"]));const n=e.observer.clone();if(null==n)return{steps:s,cancel:o};const a=Le.fromGeometry(n,ue(this.view.viewingMode));return{steps:s.next(Te({operations:a})).next((e=>(this.observer=he(a.data.geometry,n.spatialReference),e))),cancel:o}}),{mode:"absolute-height",offset:0},t.spatialReference,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((s,o,r)=>{if(null==e)return{steps:o,cancel:r};const n=e.viewshed;r=r.next(Oe(e,["horizontalFieldOfView","verticalFieldOfView"]));const a=o.next((s=>{"start"===s.action&&(t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const o=s.deltaAngle;let r=0;switch(s.side){case"left":r=t/2-o;break;case"right":r=t/2+o;break;case"top":r=i+2*o;break;case"bottom":r=i-2*o}return Ct(s.side)?(r=pe.normalize(r),r=r>270?0:r>180?180:r,n.horizontalFieldOfView=2*r):n.verticalFieldOfView=r,s}));return{steps:a,cancel:r}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,o,r)=>{if(null==e)return{steps:o,cancel:r};const n=e.viewshed;return r=r.next(Oe(n,[t])),{steps:o=o.next(i(n,e)),cancel:r}};return v([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=pe.normalize(i+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((i,s)=>s=>{"start"===s.action&&(t=e.tilt);let o=t+s.deltaAngle;return o<-90?o=180:o>270&&(o=0),i.tilt=Qt.clamp(o),s})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,t)=>i=>{const s=R(Kt,i.renderEnd,t.observerRenderSpace),o=A(s)*t.metersPerUnit,r=B(s,t.targetDirection)<0?1:o;return e.farDistance=r,i})),e)])}_updateManipulationAvailability(e){this._moveManipulation.available=e,this._fieldOfViewManipulation.available=e,this._scaleOrientManipulation.available=e,this._observerManipulator.available=e}_updateManipulatorVisibility(){const e=this._someManipulatorSelected()||this._someManipulatorHovering()&&null==this.view.activeTool;if(e)this.removeHandles(qt);else{const e=[],t=t=>{e.push(t.disableDisplay())};this._forEachManipulator(t),this.addHandles(e,qt)}this._updateMoveHelperVisualsVisibility(e)}_forEachManipulator(e){this._moveManipulation.forEachManipulator(e),this._fieldOfViewManipulation.forEachManipulator(e),this._scaleOrientManipulation.forEachManipulator(e),e(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const e=new Fe({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),t=new Ue({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:re.OccludeAndTransparent,isDecoration:!0});this._moveHelperVisualElement={laserline:e,verticalLine:t},this.addHandles([o((()=>this._settings.visualElements.zVerticalLine),(e=>e.apply(t)),a),o((()=>this._settings.visualElements.heightPlane),(t=>t.apply(e)),a)])}_updateMoveHelperVisualsVisibility(e){e=this.analysisViewData.visible&&e;const t=this._moveHelperVisualElement;null!=t&&(t.verticalLine.visible=e,t.laserline.visible=e)}_updateMoveHelperVisualsLocation(e){const t=this._moveHelperVisualElement;if(null==t)return;const{laserline:i,verticalLine:s}=t;i.heightManifoldTarget=e,i.intersectsWorldUpAtLocation=e,null!=e&&s.setStartEndFromWorldDownAtLocation(e)}_destroyMoveHelperVisuals(){const e=this._moveHelperVisualElement;null!=e&&(e.laserline.destroy(),e.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,viewshedComputedData:this.viewshedComputedData}}};e([p({constructOnly:!0})],Nt.prototype,"analysis",void 0),e([p({constructOnly:!0})],Nt.prototype,"analysisViewData",void 0),e([p({constructOnly:!0})],Nt.prototype,"parentTool",void 0),e([p({constructOnly:!0,nonNullable:!0})],Nt.prototype,"view",void 0),e([p()],Nt.prototype,"viewshed",null),e([p()],Nt.prototype,"_grabbing",void 0),e([p()],Nt.prototype,"grabbing",null),e([p()],Nt.prototype,"viewshedComputedData",void 0),e([p()],Nt.prototype,"observer",null),Nt=e([u("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],Nt);const Kt=G(),Qt=new ce(0,180);var Jt;let Zt=Jt=class extends xe{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creating=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool=null}initialize(){this._intersector=ze(this.view.state.viewingMode);const e=this.analysisViewData.viewshedComputedDataHandles;this.addHandles([o((()=>e.some((e=>e.viewshedComputedData.isValid()))),(e=>{e&&this.finishToolCreation()}),a),o((()=>this._stagedViewshed),(e=>{this._stagedViewshedComputedData=null!=e?this.analysisViewData.viewshedComputedDataHandles.find((t=>t.viewshedComputedData.viewshed===e))?.viewshedComputedData:null}),a),o((()=>this.firstGrabbedManipulator),(e=>{null!=e&&this._selectManipulator(e)}),l),o((()=>this.analysisViewData.visible),(e=>{e||this._selectManipulator(null)})),o((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&this._selectManipulator(null)}))]),this.subToolHandles=n((()=>e),(({viewshedComputedData:e})=>{const t=new Nt({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this._selectedManipulatorSubTool===t&&this._selectManipulator(null),t.destroy()}}}))}destroy(){this.subToolHandles=i(this.subToolHandles)}onDeactivate(){this.removeStaged()}get cursor(){return this.creating?"crosshair":null}_selectManipulator(e){const t=this._selectedManipulator;null!=t&&(t.selected=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool?.onManipulatorSelectionChanged(),this._selectedManipulatorSubTool=null),null!=e&&(e.selected=!0,this._selectedManipulator=e,this._selectedManipulatorSubTool=this.subToolHandles.find((t=>t.subTool.hasManipulator(e)))?.subTool,this._selectedManipulatorSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this._selectedManipulatorSubTool?.viewshed}set selectedViewshed(e){this.selectViewshed(e)}get selectedViewshedComputedData(){return this._selectedManipulatorSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:e})=>e.grabbing))}get creating(){return this._creating&&this.active}get placingTarget(){return null!=this._stagedViewshed}createViewsheds(){this._creating=!0}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-click":this._clickDeselectHandler();break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":Ie.cancel===e.key?this._cancelKeyHandler(e):Ie.delete.includes(e.key)&&this._deleteKeyHandler()}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}_clickDeselectHandler(){this.hasFocusedManipulators||this._selectManipulator(null)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._stagedViewshed,i=this._intersectScreen(e,si);if(null!=i){if(null==t){i.mapPoint.z=(i.mapPoint.z??0)+2;const e=new le({observer:i.mapPoint.clone()});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._updateStagedViewshed(i.scenePoint)}else{this._updateStagedViewshed(i.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,this.selectViewshed(e)}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._selectManipulator(null),this._creating=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating||null==this._stagedViewshed)return;const t=this._intersectScreen(e,si);null!=t&&this._updateStagedViewshed(t.scenePoint)}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._selectManipulator(null),void e.stopPropagation();this._creating=!1}else if(!this.grabbing)return this.selectViewshed(null),void e.stopPropagation()}_deleteKeyHandler(){this.creating&&this.removeStaged(),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:o,farDistance:r}=function(e,t,i){const s=t.observerRenderSpace,o=R(Xt,i,s),r=A(o)*t.metersPerUnit,n=e.renderCoordsHelper.basisMatrixAtPosition(s,ti),a=P(Yt,n[8],n[9],n[10]),l=J(s,a,ii),p=Z(l,i,$t),c=R(p,p,s),h=w(F(o,c))*(B(a,o)<0?-1:1)+90,u=P(ei,n[4],n[5],n[6]),d=w(F(u,c)),m=P(ei,n[0],n[1],n[2]);return{heading:B(c,m)<0?360-d:d,tilt:h,farDistance:r}}(this.view,i,e);t.farDistance=r,t.tilt=o,t.heading=s}removeStaged(){return null!=this._stagedViewshed&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}selectViewshed(e){if(null!=e)for(const e of this.view.tools.items)e!==this&&e instanceof Jt&&e.selectViewshed(null);const t=this.subToolHandles.find((t=>t.subTool.viewshed===e))?.subTool;this._selectManipulator(t?.discManipulator)}_intersectScreen(e,t){const i=Be(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,o=t.scenePoint;if(!s.getIntersectionPoint(o))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(o,r),null==r?null:t}get test(){return{subTools:this.subToolHandles.map((e=>e.subTool.test)),selectedSubTool:this._selectedManipulatorSubTool?.test,stagedViewshed:this._stagedViewshed}}};e([p({constructOnly:!0})],Zt.prototype,"view",void 0),e([p()],Zt.prototype,"analysisViewData",void 0),e([p()],Zt.prototype,"removeIncompleteOnCancel",void 0),e([p()],Zt.prototype,"automaticManipulatorSelection",void 0),e([p({constructOnly:!0})],Zt.prototype,"analysis",void 0),e([p()],Zt.prototype,"subToolHandles",void 0),e([p()],Zt.prototype,"_stagedViewshed",void 0),e([p()],Zt.prototype,"_stagedViewshedComputedData",void 0),e([p()],Zt.prototype,"_creating",void 0),e([p({readOnly:!0})],Zt.prototype,"cursor",null),e([p()],Zt.prototype,"_selectedManipulator",void 0),e([p()],Zt.prototype,"_selectedManipulatorSubTool",void 0),e([p()],Zt.prototype,"selectedViewshed",null),e([p()],Zt.prototype,"selectedViewshedComputedData",null),e([p()],Zt.prototype,"grabbing",null),e([p()],Zt.prototype,"creating",null),e([p()],Zt.prototype,"placingTarget",null),Zt=Jt=e([u("esri.views.3d.analysis.Viewshed.ViewshedTool")],Zt);const Xt=G(),Yt=G(),$t=G(),ei=G(),ti=C(),ii=Q(),si={mapPoint:new ae,scenePoint:G()},oi=Zt;let ri=class extends(d(t)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this.viewshedComputedDataHandles=null,this._placementTask=null}get selectedViewshed(){return this.tool?.selectedViewshed}set selectedViewshed(e){const{tool:t}=this;null!=t&&(t.selectedViewshed=e)}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){this._initializeUpdateHandle(),this.viewshedComputedDataHandles=n((()=>this.analysis.viewsheds),(e=>{const t=new it({renderCoordsHelper:this.view.renderCoordsHelper,viewshed:e}),i=Symbol();return this.addHandles(o((()=>t.isValid()),((e,i)=>{this.visible&&(e?this._addViewshedsToRenderer(t):i&&this._removeViewshedsFromRenderer(t))}),r)),{viewshedComputedData:t,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(t),t.destroy()}}})),this._analysisVisualization=new et({view:this.view,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([o((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles.map((e=>e.viewshedComputedData)).filter((e=>e.isValid()));e?this._addViewshedsToRenderer(t):this._removeViewshedsFromRenderer(t)})),o((()=>this.view.renderCoordsHelper),(e=>{this.viewshedComputedDataHandles.forEach((({viewshedComputedData:t})=>t.renderCoordsHelper=e))})),We(this,oi)])}destroy(){this._placementTask=s(this._placementTask),qe(this),this._analysisVisualization=i(this._analysisVisualization),this._removeViewshedsFromRenderer(this.viewshedComputedDataHandles.map((e=>e.viewshedComputedData)))}async createViewsheds(e){return this._placementTask=s(this._placementTask),this._placementTask=Ne(this,e),null!=this.tool&&this.tool.createViewsheds(),await this._placementTask.promise}_initializeUpdateHandle(){const e=this.view._stage.renderer.plugins.plugins.find((e=>e instanceof Ge));e&&(this._updateHandleInRenderer=e.updateViewsheds.bind(e))}_addViewshedsToRenderer(e){this._updateHandleInRenderer({adds:e})}_removeViewshedsFromRenderer(e){this._updateHandleInRenderer({removes:e})}};e([p({readOnly:!0})],ri.prototype,"type",void 0),e([p({constructOnly:!0,nonNullable:!0})],ri.prototype,"analysis",void 0),e([p()],ri.prototype,"tool",void 0),e([p()],ri.prototype,"selectedViewshed",null),e([p()],ri.prototype,"selectedViewshedComputedData",null),e([p()],ri.prototype,"viewshedComputedDataHandles",void 0),e([p()],ri.prototype,"_analysisVisualization",void 0),e([p()],ri.prototype,"_placementTask",void 0),ri=e([u("esri.views.3d.analysis.ViewshedAnalysisView3D")],ri);const ni=ri;export{ni as default};

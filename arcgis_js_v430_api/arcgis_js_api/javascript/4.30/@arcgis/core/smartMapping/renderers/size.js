/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/Logger.js";import i from"../../core/Error.js";import{p as s,t as r}from"../../chunks/screenUtils.js";import{b as t}from"../../chunks/ensureType.js";import{f as o}from"../../chunks/messages.js";import{s as n}from"../../chunks/substitute.js";import a from"../../renderers/support/AuthoringInfo.js";import l,{A as p}from"../../renderers/support/AuthoringInfoVisualVariable.js";import{setLabelsForClassBreaks as m}from"../../renderers/support/utils.js";import u,{S as c,c as d}from"../../renderers/visualVariables/SizeVariable.js";import{T as y}from"../../chunks/sizeVariableUtils.js";import{a as h}from"../../chunks/ageUnit.js";import{d as f,e as b,o as j,a as v,f as w,i as z,u as g,v as S,n as k,q as x,p as T,r as V,b as E,g as U}from"../../chunks/utils18.js";import{e as I}from"../../chunks/extentUtils.js";import{s as O}from"../../chunks/spatialStatistics.js";import{v as F}from"../../chunks/binningUtils.js";import{b as D,f as R,c as B,g as M}from"../../chunks/layerUtils3.js";import C from"../heuristics/sizeRange.js";import{c as q,u as L,a as P,g as A}from"../../chunks/referenceSizeUtils.js";import{getAgeExpressions as G,verifyDates as Q,supportedAgeUnits as N}from"../statistics/support/ageUtils.js";import{d as W,b as H,i as J}from"../../chunks/utils2.js";import{cloneScheme as Z,getSchemes as $}from"../symbology/size.js";import{k as _}from"../../chunks/utils11.js";import"../../chunks/tslib.es6.js";import"../../symbols.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../core/lang.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/tracking.js";import"../../config.js";import"../../symbols/CIMSymbol.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../chunks/assets.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../geometry/Polyline.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../core/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../core/reactiveUtils.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/layerUtils2.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/OverrideHelper.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/utils7.js";import"../../chunks/quantizationUtils.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/numberUtils.js";import"../../chunks/colorRampUtils2.js";import"../../chunks/utils14.js";import"../../chunks/timeUtils.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/_commonjsHelpers.js";import"../../symbols/support/cimSymbolUtils.js";import"../statistics/summaryStatisticsForAge.js";import"../statistics/summaryStatistics.js";import"../../chunks/utils12.js";import"../../chunks/utils10.js";import"../../chunks/generateRendererUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/executeQuery.js";import"../../chunks/infoFor3D.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/executeQueryJSON.js";import"../../chunks/utils8.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils9.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/Query.js";import"../../TimeExtent.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../chunks/executeQueryPBF.js";import"../../chunks/featureConversionUtils.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../statistics/support/predominanceUtils.js";import"../../chunks/statsWorker.js";import"../../chunks/utils15.js";import"../../chunks/PointSizeSplatAlgorithm.js";import"../../chunks/scaleUtils.js";import"../statistics/classBreaks.js";import"../../views/support/colorUtils.js";import"../heuristics/scaleRange.js";import"../../chunks/enums2.js";import"../../chunks/symbologyUtils.js";import"../../chunks/utils19.js";const K=.1,X=.25,Y=.1,ee=.1;function ie(e){let i=0;for(const s of e)i+=s;return i/e.length}function se(e,i){const s=i??ie(e),r=e.reduce(((e,i)=>e+(i-s)**2),0);return Math.sqrt(r/e.length)}async function re(e){const r=await async function(e){const{view:s}=e;if(!(e&&s&&e.layer))throw new i("reference-size:missing-parameters","'view' and 'layer' parameters are required");e.forBinning&&F(e,"reference-size");const{layer:r,...t}=e,o=e.forBinning?D:R,n=B(r,o,e.forBinning);if(!n)throw new i("reference-size:invalid-parameters","'reference-size' must be one of these types: "+M(o).join(", "));const a={layerAdapter:n,...t,view:s};await s.when();const l=null!=a.signal?{signal:a.signal}:null;if(await n.load(l),!e.forBinning&&"polygon"!==n.geometryType)throw new i("reference-size:not-supported",`reference-size is not supported for geometryType: ${n.geometryType}`);return a}(e),t=await r.layerAdapter.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...r},"json");if(!t?.length)throw new i("reference-size:insufficient-info","No features are available to calculate statistics");return async function(e,r){const{view:t}=r;if(r.forBinning){const r=e[Math.floor(e.length/2)].geometry,o=I(r);if(!o)throw new i("reference-size:insufficient-info","Extent is invalid");const n=Math.abs(o.xmax-o.xmin),a=Math.abs(o.ymax-o.ymin),l=Math.min(n,a);return{size:s(l/t.resolution),isGrid:!0}}const{isGrid:o,avgSize:n}=await async function(e,s){const r=await O({features:e,geometryType:s});if(!(r&&"avgSize"in r&&r.avgSize))throw new i("reference-size:insufficient-info","average polygon size is invalid");const t=r.avgSize,o=[],n=[];for(const i of e){const e=I(i.geometry);if(!e){o.push(0),n.push(0);continue}const s=Math.abs(e.xmax-e.xmin),r=Math.abs(e.ymax-e.ymin);o.push(s/r),n.push(Math.sqrt(s*r))}const a=Number(ie(o).toFixed(2)),l=Number(se(o,a).toFixed(2)),p=se(n),m=Number((p/t).toFixed(2));return{isGrid:l<=Y&&a>=1-X&&a<=1+X&&m<=ee,avgSize:t}}(e,r.layerAdapter.geometryType);return{size:s((o?n*(1-K):.75*n)/t.resolution),isGrid:o}}(t,r)}const te=2**53-1;async function oe(e){const i=e.layer;if(("polygon"===i.geometryType||e.forBinning)&&e.view&&e.field&&!e.valueExpression&&(!e.theme||"reference-size"===e.theme)){try{e.referenceSizeResult=e.referenceSizeResult??await re({layer:i,view:e.view,forBinning:e.forBinning,signal:e.signal})}catch{}!e.theme&&e.referenceSizeResult?.isGrid&&(e.theme="reference-size"),e.referenceSizeOptions?.symbolStyle||(e.referenceSizeOptions?e.referenceSizeOptions.symbolStyle="circle":e.referenceSizeOptions={symbolStyle:"circle"})}}function ne(e){const i={...e},s=!!i.symbolType?.includes("3d-volumetric"),r=i;return r.worldScale=s,s&&(r.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,r}async function ae(e){let i=e.sizeScheme,s=null,r=null;const t=await E(e.basemap,e.view);if(s=null!=t.basemapId?t.basemapId:null,r=null!=t.basemapTheme?t.basemapTheme:null,i)return{scheme:Z(i),basemapId:s,basemapTheme:r};const o=$({basemapTheme:r,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});return o&&(i=o.primaryScheme,s=o.basemapId,r=o.basemapTheme),{scheme:i,basemapId:s,basemapTheme:r}}function le(e,i){switch(i){case"point":case"multipoint":{const i=e;return[d(i.minSize),d(i.maxSize)]}case"polyline":{const i=e;return[d(i.minWidth),d(i.maxWidth)]}case"polygon":{const i=e;return[d(i.marker.minSize),d(i.marker.maxSize)]}}}async function pe(i,s,r,t,n){const a=await o("esri/smartMapping/t9n/smartMapping"),l=n.layer,p=n.field,m=l.geometryType,u=n.defaultSymbolEnabled,c=Z(i.sizeScheme),d="polygon"===m,y=d?c.marker:c,h=d?c.background:null,f=d?"point":m,b=s?.opacity,j=i.isGrid,v="reference-size"===n.theme,w=v?[]:i.visualVariables.map((e=>e.clone()));s?.visualVariables?.length&&w.push(...s.visualVariables.map((e=>e.clone())));const z=v?q({view:n.view,field:p,normalizationField:t,sizeStops:A(i.visualVariables[0]),sizeByScaleEnabled:j||!!n.sizeOptimizationEnabled}):null;return{renderer:new e({backgroundFillSymbol:!j&&h?k(m,{type:n.symbolType,color:h.color,outline:x(h,m,b)}):null,classBreakInfos:[{minValue:-te,maxValue:te,symbol:z?P({type:n.referenceSizeOptions?.symbolStyle||"circle",color:y.color,primitiveOverrides:z}):k(f,{type:n.symbolType,color:y.color,size:T(y,f),outline:x(y,f,b)})}],defaultLabel:u?a.other:null,defaultSymbol:u&&!v?k(f,{type:n.symbolType,color:y.noDataColor,size:T(y,f,!0),outline:x(y,f,b)}):null,field:p,normalizationField:t,normalizationType:r,valueExpression:n.valueExpression,valueExpressionTitle:n.valueExpressionTitle,visualVariables:w,authoringInfo:i.authoringInfo?.clone()}),visualVariables:i.visualVariables.map((e=>e.clone())),statistics:i.statistics,defaultValuesUsed:i.defaultValuesUsed,isGrid:j,sizeScheme:Z(i.sizeScheme),basemapId:i.basemapId,basemapTheme:i.basemapTheme}}async function me(e){const s=await async function(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new i("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if("reference-size"===e.theme&&!e.view&&!e.field)throw new i("size-visual-variable:missing-parameters","'view' and 'field' are required when 'theme' is 'reference-size'");if("reference-size"===e.theme&&e.valueExpression)throw new i("size-visual-variable:missing-parameters","'valueExpression' is not supported when 'theme' is 'reference-size'");e.forBinning&&F(e,"size-visual-variable");const s={...e},r=e.forBinning?D:R,t=B(s.layer,r,e.forBinning);if(!t)throw new i("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+M(r).join(", "));s.layer=t,"height"===s.axis&&(s.sizeOptimizationEnabled=!1);const o=null!=s.signal?{signal:s.signal}:null;await t.load(o);const n=t.geometryType;if("mesh"===n)throw new i("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(s.worldScale){if("polyline"===n||"polygon"===n)throw new i("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!s.view||"3d"!==s.view.type)throw new i("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}if("reference-size"===s.theme&&!e.forBinning&&"polygon"!==n)throw new i("size-visual-variable:invalid-parameters","Reference size is only supported for polygon layers");const a=await W({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),l=S(t,a,"size-visual-variable:invalid-parameters");if(l)throw l;return await oe(s),s}(e),{view:r,field:o,valueExpression:n,minValue:m,maxValue:d,layer:h,normalizationField:j,signal:v,statistics:w}=s,z=j?"field":void 0,[g,k]=await Promise.all([w??f({layer:h,field:o,valueExpression:n,sqlExpression:s.sqlExpression,sqlWhere:s.sqlWhere,normalizationType:z,normalizationField:j,minValue:m,maxValue:d,view:r,signal:v}),s.sizeOptimizationEnabled?C({view:r,layer:h,signal:v}).catch(b):null]);return async function(e,s,r,o){const{theme:n,field:m,normalizationField:d,minValue:h,maxValue:f,axis:b}=e,j=e.layer.geometryType,v=await ae({basemap:e.basemap,geometryType:j,sizeScheme:e.sizeScheme,worldScale:e.worldScale,view:e.view}),w=v.scheme;if(!w)throw new i("size-visual-variable:insufficient-info","Unable to find size scheme");const z=await async function(e,i,s,r,t){return"reference-size"===s&&i?[1,i.size]:e?[e.minSize,e.maxSize]:le(r,t)}(r,o,n,w,j),{minDataValue:g,maxDataValue:S,defaultValuesUsed:k}=function(e,i){if("reference-size"===i.theme&&null!=e.min&&null!=e.max&&null!=e.avg&&null!=e.stddev){const i=100,s=0,r=0,t=1,o=e.avg,n=e.min,a=e.max,l=e.stddev,p=0!==o?l/o:0,m=n>r&&n<t&&a<2*t&&p<.5,u=n>s&&n<i&&a<2*i&&p<.5;return{minDataValue:m?r:u?s:n,maxDataValue:m?t:u?i:o+2*l,defaultValuesUsed:!1}}const{theme:s,field:r}=i,t=i.layer,o=r&&"function"!=typeof r?t.getField(r):null,n=J(o);return U(e,s,n,"above"===s||"below"===s)}(s,e),x=[],T="height"===b,E=T?b:void 0,I=z[0];let O=z[1];if(T&&"number"==typeof I&&"number"==typeof O){const e=V({minSize:I,maxSize:O},E);x.push(new u({axis:"width-and-depth",minSize:e.minSize})),O=e.maxSize}const F=new u({field:m??void 0,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,valueUnit:"unknown",normalizationField:d,axis:E,minSize:I,maxSize:O,minDataValue:g,maxDataValue:S,legendOptions:t(c,e.legendOptions)});!function(e,i){e.transformationType===y.ClampedLinear&&"below"===i&&e.flipSizes()}(F,n),x.unshift(F);const D=new l("reference-size"===n?{type:"size",field:e.field,normalizationField:e.normalizationField,sizeStops:A(F).map((({label:e,size:i,value:s})=>new p({label:e,size:i,value:s}))),theme:n,referenceSizeScale:o?.isGrid||e.sizeOptimizationEnabled?e?.view?.scale:void 0,referenceSizeSymbolStyle:e.referenceSizeOptions?.symbolStyle,minSliderValue:null!=h?h:s.min,maxSliderValue:null!=f?f:s.max}:{type:"size",theme:n,minSliderValue:null!=h?h:s.min,maxSliderValue:null!=f?f:s.max}),R=new a({visualVariables:[D]});return{basemapId:v.basemapId,basemapTheme:v.basemapTheme,visualVariables:x,statistics:s,isGrid:o?.isGrid,defaultValuesUsed:k,sizeScheme:Z(w),authoringInfo:R}}(s,g,k,s.referenceSizeResult)}async function ue(e){const s=await async function(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new i("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&F(e,"size-continuous-renderer");const s={...e};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled??=!0;const r=e.forBinning?D:R,t=B(s.layer,r,e.forBinning);if(!t)throw new i("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+M(r).join(", "));s.layer=t;const o=null!=s.signal?{signal:s.signal}:null;await t.load(o);const n=t.geometryType,a=s.symbolType.includes("3d");if(s.outlineOptimizationEnabled="reference-size"!==s.theme&&"polygon"===n&&s.outlineOptimizationEnabled,"mesh"===n)throw new i("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a&&("polyline"===n||"polygon"===n))throw new i("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.includes("3d-volumetric")&&(!s.view||"3d"!==s.view.type))throw new i("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if("reference-size"===s.theme&&!e.forBinning&&"polygon"!==n)throw new i("size-continuous-renderer:invalid-parameters","Reference size is only supported for polygon layers");const l=await W({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),p=S(t,l,"size-continuous-renderer:invalid-parameters");if(p)throw p;return await oe(s),s}(e),r={layer:s.layer,view:s.view,signal:s.signal},[t,o]=await Promise.all([me(ne(s)),s.outlineOptimizationEnabled?j(r).catch(b):null]),n=s.normalizationField;return pe(t,o,n?"field":void 0,n,s)}async function ce(e){const{forBinning:s,layer:r,referenceSizeOptions:t,renderer:o,sizeScheme:n,sizeStops:l,typeScheme:m,view:u}=function(e){if(!e||!(e.layer&&e.view&&e.sizeStops))throw new i("update-renderer-with-reference-size:missing-parameters","'layer', 'view and 'sizeStops' parameters are required");const s=e.layer;let r=e.renderer;if(!r)if(e.forBinning){if(!("featureReduction"in s&&s.featureReduction&&"renderer"in s.featureReduction&&s.featureReduction.renderer)||"class-breaks"!==s.featureReduction.renderer.type&&"unique-value"!==s.featureReduction.renderer.type)throw new i("update-renderer-with-reference-size:invalid-parameters","Feature reduction renderer is not supported");r=s.featureReduction.renderer}else{if(!("renderer"in s)||!s.renderer||"class-breaks"!==s.renderer.type&&"unique-value"!==s.renderer.type)throw new i("update-renderer-with-reference-size:invalid-parameters","Renderer is not supported");r=s.renderer}const t=r.authoringInfo;if(!t||!t?.visualVariables?.some((e=>"reference-size"===e.theme)))throw new i("update-renderer-with-reference-size:invalid-parameters","'renderer.authoringInfo.visualVariables' should have an authoringInfoVisualVariable with 'theme' set to 'reference-size'");return{...e,renderer:r}}(e),{isGrid:c}=await re({view:u,layer:r,forBinning:s}),d=o.clone();d.authoringInfo??=new a;const y=d.authoringInfo.visualVariables.find((e=>"reference-size"===e.theme)),h=e.field??y?.field,f=e.normalizationField??y?.normalizationField;if(!h)throw new i("update-renderer-with-reference-size:invalid-parameters","'field' parameter or authoring info with 'field' is required.");const b=q({view:u,field:h,normalizationField:f,sizeStops:l,sizeByScaleEnabled:c||!!e.sizeOptimizationEnabled}),j=t?.symbolStyle||y?.referenceSizeSymbolStyle||"circle";if("class-breaks"===d.type){const e="polygon"===("geometryType"in r?r.geometryType:null)&&n&&"marker"in n?n.marker:null;d.classBreakInfos.forEach((i=>{const s=e?.color??_(i.symbol,1);"cim"===i.symbol.type?L(i.symbol,{type:j,color:s,primitiveOverrides:b}):s&&(i.symbol=P({type:j,color:s,primitiveOverrides:b}))}))}else if("unique-value"===d.type){const e=d.uniqueValueGroups,i="polygon"===("geometryType"in r?r.geometryType:null)&&m&&"colors"in m?m.colors:null,s=i?v(i,d.uniqueValueInfos?.length??0):null;let t=0;if(e){for(const i of e)for(const e of i.classes??[]){const i=s?s[t]:_(e.symbol,1);"cim"===e.symbol?.type?L(e.symbol,{type:j,color:i,primitiveOverrides:b}):i&&(e.symbol=P({type:j,color:i,primitiveOverrides:b})),t++}d.uniqueValueGroups=e}}return y&&(y.field=h,y.normalizationField=f,y.sizeStops=l.map((({label:e,size:i,value:s})=>new p({label:e,size:i,value:s}))),y.referenceSizeScale=c||e.sizeOptimizationEnabled?u.scale:void 0,y.referenceSizeSymbolStyle=j),d}async function de(s){const t=await async function(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new i("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new i("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&F(e,"size-class-breaks-renderer");const s={...e};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled??=!0,s.classificationMethod??="equal-interval",s.normalizationType=H(s);const r=e.forBinning?D:R,t=B(s.layer,r,e.forBinning);if(!t)throw new i("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+M(r).join(", "));if(s.layer=t,!(null!=s.minValue&&null!=s.maxValue||null==s.minValue&&null==s.maxValue))throw new i("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const o=null!=s.signal?{signal:s.signal}:null;await t.load(o);const n=t.geometryType,a=s.symbolType.includes("3d");if(s.outlineOptimizationEnabled="polygon"===n&&s.outlineOptimizationEnabled,"mesh"===n)throw new i("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a&&("polyline"===n||"polygon"===n))throw new i("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.includes("3d-volumetric")&&(!s.view||"3d"!==s.view.type))throw new i("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const l=await W({field:s.field,normalizationField:s.normalizationField}),p=S(t,l,"size-class-breaks-renderer:invalid-parameters");if(p)throw p;return s}(s),n=await w(function(e){const i={...e};delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;const s=i;return s.analyzeData=!(null!=i.minValue&&null!=i.maxValue),s}(t),t.outlineOptimizationEnabled);return async function(i,s){const t=await o("esri/smartMapping/t9n/smartMapping"),n=i.layer,l=i.defaultSymbolEnabled,p=n.geometryType,u="polygon"===p,c=i.symbolType?.includes("3d-volumetric"),d=await ae({basemap:i.basemap,geometryType:p,sizeScheme:i.sizeScheme,worldScale:c,view:i.view}),y=d.scheme,{result:h,outlineResult:f}=s,b=h?.classBreakInfos??[],j=i.classificationMethod,v=i.normalizationType,w=u?y.marker:y,z=u?y.background:null,g=u?"point":p,S=le(w,g),E=c?V({minSize:S[0],maxSize:S[1]},"height"):null,U=function(e,i){const s=r(e.minSize),t=(r(e.maxSize)-s)/(i>=4?i-1:i),o=[];for(let e=0;e<i;e++)o.push(s+t*e);return o}({minSize:S[0],maxSize:E?E.maxSize:S[1]},b.length),I=f?.opacity,O=new e({backgroundFillSymbol:z&&k(p,{type:i.symbolType,color:z.color,outline:x(z,p,I)}),classBreakInfos:b.map(((e,s)=>({minValue:e.minValue,maxValue:e.maxValue,symbol:k(g,{type:i.symbolType,color:w.color,size:U[s],widthAndDepth:E?.minSize,outline:x(w,g,I)}),label:e.label}))),defaultLabel:l?t.other:null,defaultSymbol:l?k(g,{type:i.symbolType,color:w.noDataColor,size:T(w,g,!0),widthAndDepth:E?.minSize,outline:x(w,g,I)}):null,field:i.field,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle,normalizationType:v,normalizationField:i.normalizationField,normalizationTotal:"percent-of-total"===v?h?.normalizationTotal:void 0,legendOptions:i.legendOptions,authoringInfo:new a({type:"class-breaks-size",classificationMethod:j,standardDeviationInterval:i.standardDeviationInterval})});return"standard-deviation"!==j&&m({classBreakInfos:O.classBreakInfos,classificationMethod:j,normalizationType:v,round:!0}),f?.visualVariables?.length&&(O.visualVariables=f.visualVariables.map((e=>e.clone()))),{renderer:O,sizeScheme:Z(y),classBreaksResult:h,defaultValuesUsed:!!s.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}}(t,n)}async function ye(e){const s=await async function(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new i("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");const s={...e};s.symbolType??="2d",s.defaultSymbolEnabled??=!0;const r=B(s.layer,R);if(!r)throw new i("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+M(R).join(", "));s.layer=r;const t=null!=s.signal?{signal:s.signal}:null;await r.load(t);const o=r.geometryType,n=s.symbolType.includes("3d");if(s.outlineOptimizationEnabled="polygon"===o&&s.outlineOptimizationEnabled,"mesh"===o)throw new i("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(n&&("polyline"===o||"polygon"===o))throw new i("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.includes("3d-volumetric")&&(!s.view||"3d"!==s.view.type))throw new i("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const a=Q(r,s.startTime,s.endTime,"size-age-renderer:invalid-parameters");if(a)throw a;if(s.unit&&!N.includes(s.unit))throw new i("size-age-renderer:invalid-unit",`Supported units are: ${N.join(", ")}`);return s}(e),{defaultSymbolEnabled:r,view:t,startTime:a,endTime:l,symbolType:p,minValue:m,maxValue:u,signal:c}=s,d=s.layer,y={layer:s.layer,view:s.view,signal:c},[f,v]=await Promise.all([s.unit?{unit:s.unit,statistics:null,valueExpression:null}:await h({view:t,layer:d,startTime:a,endTime:l,minValue:m,maxValue:u,signal:c}),s.outlineOptimizationEnabled?j(y).catch(b):null]),{unit:w,statistics:S}=f,k=G({layer:d,startTime:a,endTime:l,unit:w}).valueExpression,x=await o("esri/smartMapping/t9n/smartMapping"),T=n(x[`ageInfo_${w}`],{unit:w,startTime:z(a,w,d,t),endTime:z(l,w,d,t)}),V=await me(ne({layer:d,basemap:s.basemap,valueExpression:k,symbolType:p,statistics:S,legendOptions:{title:T},theme:s.theme,sizeScheme:s.sizeScheme,sizeOptimizationEnabled:s.sizeOptimizationEnabled,view:s.view,minValue:m,maxValue:u,signal:c})),E={layer:d,valueExpression:k,defaultSymbolEnabled:r,symbolType:p},U=await pe(V,v,null,null,E),I=U.renderer.authoringInfo?.visualVariables;return I?.forEach((e=>g(e,a,l,w))),{...U,unit:w}}export{ye as createAgeRenderer,de as createClassBreaksRenderer,ue as createContinuousRenderer,me as createVisualVariables,ce as updateRendererWithReferenceSize};

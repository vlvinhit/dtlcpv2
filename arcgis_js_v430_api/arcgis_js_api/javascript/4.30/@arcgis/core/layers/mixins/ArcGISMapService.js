/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import s from"../../request.js";import{g as t}from"../../chunks/ensureType.js";import{throwIfAborted as r}from"../../core/promiseUtils.js";import{join as o}from"../../core/urlUtils.js";import{V as i}from"../../chunks/Version.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{r as a}from"../../chunks/reader.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{O as l}from"../../core/Accessor.js";import c from"../../geometry/Extent.js";import m from"../../geometry/SpatialReference.js";import{p as u}from"../../chunks/arcgisLayerUrl.js";import{i as h,p as y}from"../../chunks/commonProperties2.js";import{i as d}from"../../chunks/portalItemUtils.js";import"../../config.js";import"../../kernel.js";import"../../core/Error.js";import"../../chunks/handleUtils.js";import"../../chunks/maybe.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../geometry/Geometry.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/layerContainerType.js";import"../../chunks/ElevationInfo.js";import"../support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/opacityUtils.js";import"../../geometry/projection.js";import"../../chunks/SimpleObservable.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";const j=j=>{let f=class extends j{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=void 0,this._allLayersAndTablesMap=null}readCapabilities(e,s){const t=s.capabilities&&s.capabilities.split(",").map((e=>e.toLowerCase().trim()));if(!t)return{operations:{supportsExportMap:!1,supportsExportTiles:!1,supportsIdentify:!1,supportsQuery:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const r=this.type,o="tile"!==r&&!!s.supportsDynamicLayers,p=t.includes("query"),a=t.includes("map"),n=!!s.exportTilesAllowed,l=t.includes("tilemap"),c=t.includes("data"),m="tile"!==r&&(!s.tileInfo||o),u="tile"!==r&&(!s.tileInfo||o),h="tile"!==r,y=s.cimVersion&&i.parse(s.cimVersion),d=y?.since(1,4)??!1,j=y?.since(2,0)??!1;return{operations:{supportsExportMap:a,supportsExportTiles:n,supportsIdentify:p,supportsQuery:c,supportsTileMap:l},exportMap:a?{supportsArcadeExpressionForLabeling:d,supportsSublayersChanges:h,supportsDynamicLayers:o,supportsSublayerVisibility:m,supportsSublayerDefinitionExpression:u,supportsCIMSymbols:j}:null,exportTiles:n?{maxExportTilesCount:+s.maxExportTilesCount}:null}}readVersion(e,s){let t=s.currentVersion;return t||(t=s.hasOwnProperty("capabilities")||s.hasOwnProperty("tables")?10:s.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),t}async fetchRelatedService(e){const s=this.portalItem;if(!s||!d(s))return null;this._relatedFeatureServicePromise||(this._relatedFeatureServicePromise=s.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},e).then((e=>e.find((e=>"Feature Service"===e.type))??null),(()=>null)));const t=await this._relatedFeatureServicePromise;return r(e),t?{itemId:t.id,url:t.url}:null}async fetchSublayerInfo(e,t){const{source:r}=e;if(this?.portalItem&&"tile"===this.type&&"map-layer"===r?.type&&d(this.portalItem)&&e.originIdOf("url")<l.SERVICE){const s=await this.fetchRelatedService(t);s&&(e.url=o(s.url,r.mapLayerId.toString()),e.layerItemId=s.itemId)}const{url:i}=e;let p;if("data-layer"===r.type)p=(await s(i,{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey},...t})).data;else if(i&&e.originIdOf("url")>l.SERVICE)try{const e=await this._fetchAllLayersAndTablesFromService(i),s=u(i)?.sublayer??r.mapLayerId;p=e.get(s)}catch{}else{let s=e.id;"map-layer"===r?.type&&(s=r.mapLayerId);try{p=(await this.fetchAllLayersAndTables(t)).get(s)}catch{}}return p}async fetchAllLayersAndTables(e){return this._fetchAllLayersAndTablesFromService(this.parsedUrl?.path,e)}async _fetchAllLayersAndTablesFromService(e,i){await this.load(i),this._allLayersAndTablesMap||=new Map;const p=u(e),a=t(this._allLayersAndTablesMap,p?.url.path,(()=>s(o(p?.url.path,"/layers"),{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey}}).then((e=>{const s=new Map,{layers:t,tables:r}=e.data,o=[...t??[],...r??[]];for(const e of o)s.set(e.id,e);return{result:s}}),(e=>({error:e}))))),n=await a;if(r(i),"result"in n)return n.result;throw n.error}};return e([p({readOnly:!0})],f.prototype,"capabilities",void 0),e([a("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],f.prototype,"readCapabilities",null),e([p({json:{read:{source:"copyrightText"}}})],f.prototype,"copyright",void 0),e([p({type:c})],f.prototype,"fullExtent",void 0),e([p(h)],f.prototype,"id",void 0),e([p({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],f.prototype,"legendEnabled",void 0),e([p(y)],f.prototype,"popupEnabled",void 0),e([p({type:m})],f.prototype,"spatialReference",void 0),e([p({readOnly:!0})],f.prototype,"version",void 0),e([a("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],f.prototype,"readVersion",null),f=e([n("esri.layers.mixins.ArcGISMapService")],f),f};export{j as ArcGISMapService};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import r from"../core/Collection.js";import t from"../core/Error.js";import{L as s}from"../chunks/Logger.js";import{M as o}from"../chunks/MultiOriginJSONSupport.js";import{debounce as i}from"../core/promiseUtils.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import{cast as p}from"../core/accessorSupport/decorators/cast.js";import"../core/lang.js";import{r as c}from"../chunks/reader.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{w as a}from"../chunks/writer.js";import{O as u}from"../core/Accessor.js";import l from"./Layer.js";import{BlendLayer as j}from"./mixins/BlendLayer.js";import{OperationalLayer as h}from"./mixins/OperationalLayer.js";import{PortalLayer as d}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as y}from"./mixins/ScaleRangeLayer.js";import f from"./support/ControlPointsGeoreference.js";import g from"./support/ImageElement.js";import k from"./support/LocalMediaElementSource.js";import{i as S}from"./support/MediaElementBase.js";import v from"./support/VideoElement.js";import{S as w}from"../chunks/interfaces2.js";import"../core/Evented.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../config.js";import"../chunks/maybe.js";import"../chunks/ensureType.js";import"../chunks/utils.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/JSONSupport.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/utils3.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../chunks/layerContainerType.js";import"../chunks/commonProperties2.js";import"../chunks/persistableUrlUtils.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../chunks/opacityUtils.js";import"../chunks/asyncUtils.js";import"../chunks/layerUtils2.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../core/Clonable.js";import"../chunks/perspectiveUtils.js";import"../chunks/mat3.js";import"../chunks/mat3f64.js";import"../chunks/vec2.js";import"../chunks/vec2f64.js";import"../chunks/GeoreferenceBase.js";import"../chunks/imageUtils.js";import"../chunks/uuid.js";import"../chunks/resourceExtension.js";import"../chunks/collectionUtils.js";import"../core/reactiveUtils.js";import"../chunks/BoundsStore.js";import"../chunks/PooledRBush.js";import"../chunks/quickselect.js";import"../chunks/MediaElementView.js";import"../chunks/normalizeUtilsSync.js";import"../chunks/normalizeUtilsCommon.js";import"./support/CornersGeoreference.js";import"./support/ExtentAndRotationGeoreference.js";function U(e){return"object"==typeof e&&null!=e&&"type"in e}function b(e){return U(e)&&"image"===e.type}let E=class extends(j(y(h(d(o(l)))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this._debouncedSaveOperations=i((async(e,r,t)=>{const{save:s,saveAs:o}=await import("../chunks/mediaLayerUtils.js");switch(e){case w.SAVE:return s(this,r);case w.SAVE_AS:return o(this,t,r)}})),this.source=new k}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:["Media Layer"]},e);let s=this.source;if(!s)throw new t("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer.");const o=this._getSourceOverride(s,this.georeference);o&&(this.setAtOrigin("source",o,"web-map"),this.setAtOrigin("source",o,"web-scene"),s=o);const i=U(s)?new k({elements:new r([s])}):s;this._set("effectiveSource",i),this.spatialReference&&(i.spatialReference=this.spatialReference),await i.load(e),this.spatialReference=i.spatialReference}destroy(){this.effectiveSource?.destroy(),this.effectiveSource!==this.source&&this.source?.destroy()}readGeoreference(e,r){return e&&"itemId"in r&&r.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("source",e):s.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new k({elements:new r(e)}):e instanceof r?new k({elements:e}):e:null}readSource(e,r,t){if("itemId"in r&&r.itemId)return;const s=this._createSource(r);return s?.read(r,t),s}writeSource(e,r,s,o){if(e&&e instanceof k){const r=e.elements.length;if(1!==r)return void(o?.messages&&o.messages.push(new t("media-layer:unsupported-source",`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${r}.`)));e=e.elements.at(0)}b(e)?e.write(r,o):o?.messages&&(e?o.messages.push(new t("media-layer:unsupported-source","only media elements of type 'ImageElement' can be persisted")):o.messages.push(new t("media-layer:unsupported-source","the media layer is missing a source")))}async save(e){return this._debouncedSaveOperations(w.SAVE,e)}async saveAs(e,r){return this._debouncedSaveOperations(w.SAVE_AS,r,e)}_createSource(e){if("mediaType"in e)switch(e.mediaType){case"image":return new g;case"video":return new v}return null}_getSourceOverride(e,r){if(U(e)&&this.originIdOf("source")===u.PORTAL_ITEM&&r&&(this.originIdOf("georeference")===u.WEB_MAP||this.originIdOf("georeference")===u.WEB_SCENE)){const t=e.toJSON(),s=this._createSource(t);return s.read({...t},{origin:"portal-item"}),s.read({georeference:r},{origin:"web-map"}),s.read({georeference:r},{origin:"web-scene"}),s}return null}};e([n({readOnly:!0})],E.prototype,"effectiveSource",void 0),e([n({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],E.prototype,"georeference",void 0),e([c("web-document","georeference")],E.prototype,"readGeoreference",null),e([n({type:String})],E.prototype,"copyright",void 0),e([n({readOnly:!0})],E.prototype,"fullExtent",null),e([n({type:["MediaLayer"]})],E.prototype,"operationalLayerType",void 0),e([n({type:["show","hide"]})],E.prototype,"listMode",void 0),e([n({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:["image"]},georeference:{type:f}},overridePolicy(e,r,t){return{enabled:!0,allowNull:!1,ignoreOrigin:S(this,t?.origin)&&b(e)&&!!e.georeference&&e.originIdOf("georeference")>u.PORTAL_ITEM}}}}})],E.prototype,"source",null),e([p("source")],E.prototype,"castSource",null),e([c("source",["url"])],E.prototype,"readSource",null),e([a("source")],E.prototype,"writeSource",null),e([n()],E.prototype,"spatialReference",void 0),e([n({readOnly:!0})],E.prototype,"type",void 0),E=e([m("esri.layers.MediaLayer")],E);const O=E;export{O as default};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import{m as r}from"../../chunks/handleUtils.js";import{L as s}from"../../chunks/LRUCache.js";import{s as o,g as i,I as n}from"../../chunks/ensureType.js";import{M as a}from"../../chunks/MultiOriginJSONSupport.js";import{R as p}from"../../chunks/ReactiveMap.js";import{watch as l}from"../../core/reactiveUtils.js";import{signal as c}from"../../core/signal.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import h from"../Layer.js";import{BlendLayer as d}from"../mixins/BlendLayer.js";import{ScaleRangeLayer as y}from"../mixins/ScaleRangeLayer.js";import{o as j}from"../../chunks/commonProperties2.js";import{O as g}from"../../chunks/OrderByInfo.js";import{g as f}from"../../chunks/utils10.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/MemCache.js";import"../../core/JSONSupport.js";import"../../chunks/asyncUtils.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/colorUtils.js";import"../../chunks/utils3.js";import"../../chunks/screenUtils.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/layerContainerType.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/ElevationInfo.js";import"../support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/generateRendererUtils.js";import"../../chunks/enumeration.js";let k=class extends(y(d(a(h)))){constructor(e){super(e),this._layerCache=new s(20,(e=>e.destroy())),this._oidToReference=new p,this._layerToReference=new Map,this.layers=new t,this.maximumVisibleSublayers=10,this.opacity=1,this.parent=null,this.persistenceEnabled=!0,this.title="Layers in view",this.type="catalog-dynamic-group",this.visible=!0}initialize(){this.addHandles([this.layers.on("after-add",(({item:e})=>{e.parent=this})),this.layers.on("after-remove",(({item:e})=>{e.parent=null})),l((()=>this._orderBy),(()=>{this._updateLayerSortValues(),this._sortAllLayers()}))])}load(e){return this.addResolvingPromise(this.parent.load()),Promise.resolve(this)}destroy(){this._layerCache.destroy(),this._oidToReference.clear(),this._layerToReference.clear()}get _orderBy(){return this.parent?this.parent.orderBy?.find((e=>!e.valueExpression&&e.field))??new g({field:this.parent.objectIdField}):null}get _referenceComparator(){const e=this._orderBy;if(!this.parent||!e)return()=>0;const t=this.parent.fieldsIndex.get(e.field),r=f(t?.toJSON().type,"descending"===e.order),s=f("esriFieldTypeOID","descending"===e.order);return(e,t)=>r(t.sortValue,e.sortValue)||s(t.objectId,e.objectId)}get fullExtent(){return this.parent?.fullExtent??null}get updating(){return o(this._oidToReference,(e=>null!=e.pending))}acquireLayer(e){if(this.destroyed)return r();const t=this._getLayerReference(e);return t.count++,r((()=>{t.count--,t.count||this._destroyLayerReference(t)}))}_getLayerReference(e){const t=e.getObjectId();return i(this._oidToReference,t,(()=>{const t=e.getObjectId(),r=`${t}`,s=e.getAttribute(this.parent.itemSourceField),o=new b(e,t,s),i=this._layerCache.pop(r);return i?(this._addLayer(o,i),o):(o.pending=this.parent.createLayerFromFootprint(e).then((e=>{o.count?this._addLayer(o,e):(this.destroyed||this._layerCache.get(r)||this._layerCache.put(r,e),o.layer=null)})).catch((()=>{})).finally((()=>{o.pending=null})),o)}))}_destroyLayerReference(e){e.layer&&(this._layerToReference.delete(e.layer),this.layers.remove(e.layer),this.destroyed?e.layer.destroy():this._layerCache.put(`${e.objectId}`,e.layer),e.layer=null),this._oidToReference.delete(e.objectId)}_addLayer(e,t){e.layer=t,t.persistenceEnabled=!1,this._layerToReference.set(t,e),this._updateLayerSortValue(e),this.layers.add(t),this._sortAllLayers()}_updateLayerSortValues(){for(const e of this._layerToReference.values())this._updateLayerSortValue(e)}_updateLayerSortValue(e){this._orderBy&&(e.sortValue=e.footprint.getAttribute(this._orderBy.field))}_sortAllLayers(){this.layers.sort(((e,t)=>this._referenceComparator(this._layerToReference.get(e),this._layerToReference.get(t))))}};e([m()],k.prototype,"_orderBy",null),e([m({readOnly:!0})],k.prototype,"_referenceComparator",null),e([m({type:["show","hide","hide-children"],json:{write:!0}})],k.prototype,"listMode",void 0),e([m({readOnly:!0})],k.prototype,"fullExtent",null),e([m({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],k.prototype,"id",void 0),e([m({readOnly:!0})],k.prototype,"layers",void 0),e([m({type:n,range:{min:0,max:50},json:{write:!0,default:10}})],k.prototype,"maximumVisibleSublayers",void 0),e([m(j)],k.prototype,"opacity",void 0),e([m({clonable:!1})],k.prototype,"parent",void 0),e([m({type:String,nonNullable:!0,json:{write:{ignoreOrigin:!0,isRequired:!0}}})],k.prototype,"title",void 0),e([m({json:{read:!1}})],k.prototype,"type",void 0),e([m({readOnly:!0})],k.prototype,"updating",null),e([m({type:Boolean,json:{name:"visibility",write:!0}})],k.prototype,"visible",void 0),k=e([u("esri.layers.catalog.CatalogDynamicGroupLayer")],k);const _=k;class b{constructor(e,t,r){this.footprint=e,this.objectId=t,this.itemSource=r,this.count=0,this.layer=null,this.sortValue=void 0,this._pending=c(null)}get pending(){return this._pending.value}set pending(e){this._pending.value=e}}export{_ as default};

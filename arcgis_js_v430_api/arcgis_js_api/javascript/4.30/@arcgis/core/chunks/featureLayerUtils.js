/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import{symbolTypesRenderer as e}from"../symbols.js";import{a as r}from"./asyncUtils.js";import n from"../core/Error.js";import{J as a}from"./jsonMap.js";import{parseWhereClause as o}from"../core/sql.js";import{c as s}from"../core/accessorSupport/decorators/subclass.js";import{q as i}from"./featureQueryAll.js";import{f as u}from"./layerUtils2.js";import l from"../renderers/SimpleRenderer.js";import c from"../renderers/UniqueValueRenderer.js";import p from"../rest/support/AttachmentQuery.js";import d from"../rest/support/Query.js";import f from"../rest/support/RelationshipQuery.js";const y=new a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function m(t,e,r,a){const o=await G(t);if(await h(t,e,a),!o.addAttachment)throw new n(a,"Layer source does not support addAttachment capability");return o.addAttachment(e,r)}function h(t,e,r){const{attributes:a}=e,{objectIdField:o}=t;return t.capabilities?.data?.supportsAttachment?e?a?o&&a[o]?Promise.resolve():Promise.reject(new n(r,`feature is missing the identifying attribute ${o}`)):Promise.reject(new n(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new n(r,"A feature is required to add/delete/update attachments")):Promise.reject(new n(r,"this layer doesn't support attachments"))}async function w(t,e,r,a,o){const s=await G(t);if(await h(t,e,o),!s.updateAttachment)throw new n(o,"Layer source does not support updateAttachment capability");return s.updateAttachment(e,r,a)}async function b(t,e,r){const{applyEdits:n}=await import("./editingSupport.js"),a=await t.load();let o=r;return"feature"===a.type&&a.infoFor3D&&null!=e.deleteFeatures&&null!=a.globalIdField&&(o={...o,globalIdToObjectId:await J(a,e.deleteFeatures,a.globalIdField)}),n(a,a.source,e,r)}async function g(t,e,r){const{uploadAssets:n}=await import("./editingSupport.js"),a=await t.load();return n(a,a.source,e,r)}async function j(t,e,r,a){const o=await G(t);if(await h(t,e,a),!o.deleteAttachments)throw new n(a,"Layer source does not support deleteAttachments capability");return o.deleteAttachments(e,r)}async function I(t,e,r){const a=(await t.load({signal:e?.signal})).source;if(!a.fetchRecomputedExtents)throw new n(r,"Layer source does not support fetchUpdates capability");return a.fetchRecomputedExtents(e)}async function q(t,e,r,a){e=p.from(e),await t.load();const o=t.source,s=t.capabilities;if(!s?.data?.supportsAttachment)throw new n(a,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:l,num:c,size:d,start:f,where:y}=e;if(!s?.operations?.supportsQueryAttachments&&(i?.length>0||l?.length>0||d?.length>0||c||f||y))throw new n(a,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(u?.length||l?.length||y))throw new n(a,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!o.queryAttachments)throw new n(a,"Layer source does not support queryAttachments capability",e);return o.queryAttachments(e)}async function F(t,e,r,a){const o=await G(t);if(!o.queryObjectIds)throw new n(a,"Layer source does not support queryObjectIds capability");return o.queryObjectIds(d.from(e)??t.createQuery(),r)}async function A(t,e,r,a){const o=await G(t);if(!o.queryFeatureCount)throw new n(a,"Layer source does not support queryFeatureCount capability");return o.queryFeatureCount(d.from(e)??t.createQuery(),r)}async function O(t,e,r,a){const o=await G(t);if(!o.queryExtent)throw new n(a,"Layer source does not support queryExtent capability");return o.queryExtent(d.from(e)??t.createQuery(),r)}async function S(t,e,r,a){const o=await G(t);if(!o.queryRelatedFeatures)throw new n(a,"Layer source does not support queryRelatedFeatures capability");return o.queryRelatedFeatures(f.from(e),r)}async function P(t,e,r,a){const o=await G(t);if(!o.queryRelatedFeaturesCount)throw new n(a,"Layer source does not support queryRelatedFeaturesCount capability");return o.queryRelatedFeaturesCount(f.from(e),r)}async function E(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:n}=await e.refresh();if(null!=n&&(t.sourceJSON={...t.sourceJSON,...n},t.read(n,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await o(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function x(t){const e=new d,r=t.capabilities?.data,n=t.capabilities?.query;e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:a,timeExtent:o}=t;return e.timeExtent=null!=a&&null!=o?o.offset(-a.value,a.unit):o||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function R(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeGlobalID"===t.type)return t.name}function M(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeOID"===t.type)return t.name}function C(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}function L(t,e){const{subtypes:r,subtypeField:n}=t;if(!e||!r?.length||!n)return null;const a=e.attributes[n];return null==a?null:r.find((t=>t.code===a))}async function G(t){return(await t.load()).source}async function Q(e,r){if(!t)return;if(t.findCredential(e))return;let n;try{const a=await u(e,r);a&&(n=await t.checkSignInStatus(`${a}/sharing`))}catch(t){}if(n)try{const n=null!=r?r.signal:null;await t.getCredential(e,{signal:n})}catch(t){}}async function v(t,e,r){const n=t.parsedUrl?.path;n&&t.authenticationTriggerEvent===e&&await Q(n,r)}function T(t){return!k(t)&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const D=s({types:e});function U(t,e){if(t.defaultSymbol)return t.types?.length?new c({defaultSymbol:D(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map((t=>({id:t.id,symbol:D(t.symbol,t,e)})))}):new l({symbol:D(t.defaultSymbol,t,e)})}function V(t){let e=t.sourceJSON?.cacheMaxAge;if(!e)return!1;const r=t.editingInfo?.lastEditDate?.getTime();return null==r||(e*=1e3,Date.now()-r<e)}async function J(t,e,n){if(null==e)return null;const a=[],{objectIdField:o}=t;if(e.forEach((t=>{let e=null;if("attributes"in t){const{attributes:r}=t;e={globalId:r[n],objectId:null!=r[o]&&-1!==r[o]?r[o]:null}}else e={globalId:t.globalId,objectId:null!=t.objectId&&-1!==t.objectId?t.objectId:null};null!=e.globalId&&(null!=e.objectId&&-1!==e.objectId||a.push(e.globalId))})),0===a.length)return null;const s=t.createQuery();s.where=a.map((t=>`${n}='${t}'`)).join(" OR "),s.returnGeometry=!1,s.outFields=[o,n],s.cacheHint=!1;const u=await r(i(t,s));if(!u.ok)return null;const l=new Map,c=u.value.features;for(const t of c){const e=t.attributes[n],r=t.attributes[o];null!=e&&null!=r&&-1!==r&&l.set(e,r)}return l}function N(t,e,r){if(!e||!r||!t)return null;const n=r.getAttribute(e);return null==n?null:t.find((t=>{const{id:e}=t;return null!=e&&e.toString()===n.toString()}))??null}function k(t){return t.sourceJSON?.isMultiServicesView||function(t){return!!t.sourceJSON?.capabilities?.toLowerCase().split(",").map((t=>t.trim())).includes("map")}(t)}export{J as A,b as a,T as b,U as c,m as d,v as e,x as f,N as g,E as h,j as i,I as j,F as k,A as l,O as m,S as n,P as o,Q as p,q,R as r,M as s,g as t,w as u,L as v,y as w,V as x,k as y,C as z};

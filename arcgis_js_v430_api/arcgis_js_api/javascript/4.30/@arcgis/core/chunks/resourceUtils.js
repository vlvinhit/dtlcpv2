/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../request.js";import r from"../core/Error.js";import{join as t,getPathExtension as s}from"../core/urlUtils.js";import"../config.js";import"../core/lang.js";import"../kernel.js";import"../core/promiseUtils.js";import"./handleUtils.js";import"./Logger.js";import"./maybe.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";async function o(e,r={},s){await e.load(s);const o=t(e.itemUrl,"resources"),{start:a=1,num:n=10,sortOrder:c="asc",sortField:i="resource"}=r,p={query:{start:a,num:n,sortOrder:c,sortField:i,token:e.apiKey},signal:s?.signal},l=await e.portal.request(o,p);return{total:l.total,nextStart:l.nextStart,resources:l.resources.map((({created:r,size:t,resource:s})=>({created:new Date(r),size:t,resource:e.resourceFromPath(s)})))}}async function a(e,s,o,a){const n=new Map;for(const{resource:e,content:t,compress:a,access:c}of s){if(!e.hasPath())throw new r(`portal-item-resource-${o}:invalid-path`,"Resource does not have a valid path");const[s,p]=i(e.path),l=`${s}/${a??""}/${c??""}`;n.has(l)||n.set(l,{prefix:s,compress:a,access:c,files:[]}),n.get(l).files.push({fileName:p,content:t})}await e.load(a);const c=t(e.userItemUrl,"add"===o?"addResources":"updateResources");for(const{prefix:r,compress:t,access:s,files:o}of n.values()){const n=25;for(let i=0;i<o.length;i+=n){const p=o.slice(i,i+n),l=new FormData;r&&"."!==r&&l.append("resourcesPrefix",r),t&&l.append("compress","true"),s&&l.append("access",s);let u=0;for(const{fileName:e,content:r}of p)l.append("file"+ ++u,r,e);l.append("f","json"),await e.portal.request(c,{method:"post",body:l,signal:a?.signal})}}}async function n(e,s,o){if(!s.hasPath())throw new r("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(o);const a=t(e.userItemUrl,"removeResources");await e.portal.request(a,{method:"post",query:{resource:s.path},signal:o?.signal}),s.portalItem=null}async function c(e,r){await e.load(r);const s=t(e.userItemUrl,"removeResources");return e.portal.request(s,{method:"post",query:{deleteAll:!0},signal:r?.signal})}function i(e){const r=e.lastIndexOf("/");return-1===r?[".",e]:[e.slice(0,r),e.slice(r+1)]}function p(e){const[r,t]=function(e){const r=s(e);return null==r?[e,""]:[e.slice(0,e.length-r.length-1),`.${r}`]}(e),[o,a]=i(r);return[o,a,t]}async function l(r){return"blob"===r.type?r.blob:"json"===r.type?new Blob([r.jsonString],{type:"application/json"}):(await e(r.url,{responseType:"blob"})).data}function u(e,r){if(!e.hasPath())return null;const[s,,o]=p(e.path);return e.portalItem.resourceFromPath(t(s,r+o))}export{a as addOrUpdateResources,l as contentToBlob,o as fetchResources,u as getSiblingOfSameTypeI,c as removeAllResources,n as removeResource,p as splitPrefixFileNameAndExtension};

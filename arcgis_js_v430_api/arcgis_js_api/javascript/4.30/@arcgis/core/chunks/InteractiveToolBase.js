/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{i as t,clone as e}from"../core/lang.js";import{c as a}from"./mathUtils.js";import{c as n}from"./screenUtils.js";import{project as i}from"../geometry/projection.js";import{a as r}from"./meshVertexSpaceUtils.js";import{a as o,c as s}from"./hydratedFeatures.js";import{i as l}from"./elevationInfoUtils.js";import{E as c}from"./EditGeometryOperations.js";import{_ as u}from"./tslib.es6.js";import p from"../core/Accessor.js";import"./Logger.js";import{createResolver as h}from"../core/promiseUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{E as f}from"./interfaces.js";import E from"../core/Collection.js";function y(t,e){return t.events.on("drag",function(t,e){let a=null,n=null;return i=>{if("cancel"===i.action)return void(null!=n&&(n.execute({action:"cancel"}),a=null,n=null));const r={action:i.action,screenStart:i.start,screenEnd:i.screenPoint};"start"===i.action&&null==a&&(a=new F,n=new F,e(t,a,n,i.pointerType,r)),null!=a&&a.execute(r),"end"===i.action&&null!=a&&(a=null,n=null)}}(t,e))}function v(t,e){const a=[t.x,t.y,t.z??0],n=e,i=[Math.cos(n),Math.sin(n)],r=Math.sqrt(i[0]*i[0]+i[1]*i[1]);if(0===r)return null;i[0]/=r,i[1]/=r;const o=t=>{const e=(t.x-a[0])*i[0]+(t.y-a[1])*i[1];t.x=a[0]+e*i[0],t.y=a[1]+e*i[1]};return t=>(o(t.mapStart),o(t.mapEnd),{...t,axis:i})}function b(t){let e=null;return a=>{if("start"===a.action&&(e=function(t,e){const a=t.operations;if(!a)return null;const n=a.data.geometry,s=o(e);if(n.spatialReference.equals(s))return g(t,a,(()=>{}));if("mesh"!==n.type){const e=_(n,s);if(null==e)return null;const r=n.spatialReference;return g(t,c.fromGeometry(e,a.viewingMode),(()=>{const t=i(n,r);a.trySetGeometry(t)}))}if(r(n)){const e=_(n.origin,s);if(!e)return null;const r=n.spatialReference,o=c.fromGeometry(e,a.viewingMode);return g(t,a,(()=>{const t=i(o.data.geometry,r),e=t.x-n.origin.x,s=t.y-n.origin.y,l=(t.z??0)-(n.origin.z??0);a.move(e,s,l)}))}return null}(t,a.mapStart.spatialReference)),null==e)return null;const n=a.mapEnd.x-a.mapStart.x,s=a.mapEnd.y-a.mapStart.y,l=(a.mapEnd.z??0)-(a.mapStart.z??0);return e.move(n,s,l,a.action),{...a,translationX:n,translationY:s,translationZ:l}}}function _(t,e){return null==t?null:t.spatialReference.equals(e)?t.clone():i(t,e)}function g(t,e,a){let n=0,i=0,r=0;return{move:(o,s,l,c)=>{"start"===c&&(n=0,i=0,r=0);const u=o-n,p=s-i,h=l-r;e.move(u,p,h),n+=u,i+=p,r+=h,a(),"end"===c&&t.endInteraction?.()}}}function M(t,e=null,a){let n=null;const r=null==e||t.spatialReference?.equals(e)?t=>t:t=>null!=t?i(t,e):t,o={exclude:[],...a};return e=>{if("start"===e.action&&(n=r(t.toMap(e.screenStart,o))),null==n)return null;const a=r(t.toMap(e.screenEnd,o));return null!=a?{...e,mapStart:n,mapEnd:a}:null}}function S(e){const a=e.map((t=>b(t))).filter(t);return t=>{const e=t.mapEnd.x-t.mapStart.x,n=t.mapEnd.y-t.mapStart.y,i=t.mapEnd.z-t.mapStart.z;return a.forEach((e=>e(t))),{...t,translationX:e,translationY:n,translationZ:i}}}function x(t,a){const n=new Map;for(const i of a)n.set(i,e(t[i]));return e=>(n.forEach(((e,a)=>{t[a]=e})),e)}function w(t){const e=t.operations?.createResetState();return t=>(e?.remove(),t)}function A(t){const e=t.map((t=>w(t))).filter((t=>null!=t));return t=>(e.forEach((e=>e(t))),t)}function R(){let t=0,e=0,a=0;return n=>{"start"===n.action&&(t=n.mapStart.x,e=n.mapStart.y,a=n.mapStart.z);const i=n.mapEnd.x-t,r=n.mapEnd.y-e,o=n.mapEnd.z-a;return t=n.mapEnd.x,e=n.mapEnd.y,a=n.mapEnd.z,{...n,mapDeltaX:i,mapDeltaY:r,mapDeltaZ:o,mapDeltaSpatialReference:n.mapStart.spatialReference}}}function j(){let t=0,e=0;return a=>{"start"===a.action&&(t=a.screenStart.x,e=a.screenStart.y);const n=a.screenEnd.x-t,i=a.screenEnd.y-e;return t=a.screenEnd.x,e=a.screenEnd.y,{...a,screenDeltaX:n,screenDeltaY:i}}}function T(t,e){let i=null,r=0,o=0;return s=>{if("start"===s.action&&(i=t.toScreen?.(e),null!=i&&(i.x<0||i.x>t.width||i.y<0||i.y>t.height?i=null:(r=s.screenStart.x-i.x,o=s.screenStart.y-i.y))),null==i)return null;const l=a(s.screenEnd.x-r,0,t.width),c=a(s.screenEnd.y-o,0,t.height),u=n(l,c);return s.screenStart=i,s.screenEnd=u,s}}const z=()=>{};class F{constructor(){this.execute=z}next(t,e=new F){return null!=t&&(this.execute=a=>{const n=t(a);null!=n&&e.execute(n)}),e}}function C(t,e,a=[]){if("2d"===t.type)return t=>t;let n=null;return i=>{"start"===i.action&&(n=t.toMap(i.screenStart,{exclude:a}),null!=n&&(n.z=l(n,t,e)));const r=t.toMap(i.screenEnd,{exclude:a});null!=r&&(r.z=l(r,t,e));const o=null!=n&&null!=r?{sceneStart:n,sceneEnd:r}:null;return{...i,scenePoints:o}}}function I(t,e,a){const n=e.elevationProvider.getElevation(t.x,t.y,t.z??0,t.spatialReference,"scene")??0,i=s(t);return i.z=n,i.hasZ=!0,i.z=l(i,e,a),i}function G(t,e){if("2d"===t.type)return t=>t;let a=null;return n=>{"start"===n.action&&(a=I(n.mapStart,t,e));const i=I(n.mapEnd,t,e),r=null!=a&&null!=i?{sceneStart:a,sceneEnd:i}:null;return{...n,scenePoints:r}}}var U;!function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"}(U||(U={}));class D{constructor(){this._isToolEditable=!0,this._manipulators=new E,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=U.WhenToolEditable){this.addMany([t],e)}addMany(t,e=U.WhenToolEditable){for(const a of t){const t={manipulator:a,visibilityPredicate:e,attached:!1};this._manipulators.add(t),this._attached&&this._updateManipulatorAttachment(t)}}remove(t){for(let e=0;e<this._manipulators.length;e++)if(this._manipulators.at(e).manipulator===t){const t=this._manipulators.splice(e,1)[0];this._detachManipulator(t);break}}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach((({manipulator:t})=>t.destroy())),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(t,e){let a=null,n=Number.MAX_VALUE;return this._manipulators.forEach((({manipulator:i,attached:r})=>{if(!r||!i.interactive)return;const o=i.intersectionDistance(t,e);null!=o&&o<n&&(n=o,a=i)})),a}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===U.Always||(this._isToolEditable?t.visibilityPredicate===U.WhenToolEditable:t.visibilityPredicate===U.WhenToolNotEditable)}}let O=class extends p{constructor(t){super(t),this.manipulators=new D,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[f.MANAGER,!0],[f.USER,!0]]),this._creationFinishedResolver=h()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(f.USER)}set editable(t){this.setEditableFlag(f.USER,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){null!=this.view&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===f.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(f.USER)&&this.getEditableFlag(f.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};u([d({constructOnly:!0})],O.prototype,"view",void 0),u([d({readOnly:!0})],O.prototype,"active",null),u([d({value:!0})],O.prototype,"visible",null),u([d({value:!0})],O.prototype,"editable",null),u([d({readOnly:!0})],O.prototype,"manipulators",void 0),u([d({readOnly:!0})],O.prototype,"updating",null),u([d()],O.prototype,"cursor",null),u([d({readOnly:!0})],O.prototype,"automaticManipulatorSelection",void 0),u([d()],O.prototype,"hasFocusedManipulators",null),u([d()],O.prototype,"hasGrabbedManipulators",void 0),u([d()],O.prototype,"hasHoveredManipulators",void 0),u([d()],O.prototype,"firstGrabbedManipulator",void 0),u([d({readOnly:!0})],O.prototype,"created",void 0),u([d({readOnly:!0})],O.prototype,"removeIncompleteOnCancel",void 0),O=u([m("esri.views.interactive.InteractiveToolBase")],O);export{F as E,O as I,D as M,C as a,w as b,y as c,b as d,T as e,v as f,j as g,R as h,S as i,A as j,G as k,x as r,M as s};

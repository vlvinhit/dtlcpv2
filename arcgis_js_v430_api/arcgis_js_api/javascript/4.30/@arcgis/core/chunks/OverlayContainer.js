/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{c as t,m as s,d as e,e as r,r as a}from"./mat3.js";import{c as o}from"./mat3f32.js";import{f as i}from"./vec2f32.js";import{f as n}from"./vec3f32.js";import{normalizeMapX as c}from"../geometry/support/normalizeUtils.js";import{j as l}from"./unitUtils.js";import{g as p}from"./viewpointUtils.js";import{W as d,b as h}from"./WGLContainer.js";import{W as m}from"./Container.js";class f extends d{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=o()}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const s of this.children)s.beforeRender(t)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"overlay",brushes:[h.overlay],target:()=>this.children,drawPhase:m.MAP});return[...super.prepareRenderPasses(t),s]}_updateMatrices(o){const{state:l}=o,{id:p,size:d,pixelRatio:h,resolution:m,rotation:f,viewpoint:M,displayMat3:u}=l;if(this._viewStateId===p)return;const v=Math.PI/180*f,_=h*d[0],g=h*d[1];this._localOrigin=M.targetGeometry.clone();const{x:y,y:j}=this._localOrigin,w=c(y,l.spatialReference);this._localOrigin.x=w,this._localOrigin.y=j;const O=m*_,R=m*g,b=t(this._dvsMat3);s(b,b,u),e(b,b,i(_/2,g/2)),r(b,b,n(_/O,-g/R,1)),a(b,b,-v),this._viewStateId=p}_updateOverlays(t,s){const{state:e}=t,{rotation:r,spatialReference:a,worldScreenWidth:o,size:i,viewpoint:n}=e,c=this._localOrigin;let d,h=0;const m=l(a);if(m&&a.isWrappable){const t=i[0],s=i[1],c=180/Math.PI*r,l=Math.abs(Math.cos(c)),f=Math.abs(Math.sin(c)),M=Math.round(t*l+s*f),[u,v]=m.valid,_=p(a),{x:g,y}=n.targetGeometry,j=[g,y],w=[0,0];e.toScreen(w,j);const O=[0,0];let R;R=M>o?.5*o:.5*M;const b=Math.floor((g+.5*_)/_),x=u+b*_,P=v+b*_,W=[w[0]+R,0];e.toMap(O,W),O[0]>P&&(h=_),W[0]=w[0]-R,e.toMap(O,W),O[0]<x&&(h=-_),d={worldWidth:_,xBounds:[u,v]}}for(const t of s)t.updateDrawCoords(c,h,a,d)}}export{f as O};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../request.js";import{v as t,w as r,h as o,x as n,y as a}from"../core/lang.js";import s from"../core/Error.js";import{i}from"./mat4.js";import{c as l}from"./mat4f64.js";import{s as c,h as u,p as f}from"./vec3.js";import{e as p,c as d}from"./vec3f64.js";import{canProjectWithoutEngine as m}from"../geometry/projection.js";import{g as h}from"./spatialReferenceEllipsoidUtils.js";import{p as y}from"./projectVectorToVector.js";import{c as g,e as w,l as b,m as S}from"./aaBoundingRect.js";import{g as T}from"./sphere.js";import I from"../rest/support/Query.js";import{r as v}from"./I3SBinaryReader.js";import{r as E}from"./unitUtils.js";import{c as M}from"./computeTranslationToOriginAndRotation.js";import{c as R,a as x}from"./edgeUtils.js";import{p as j,C}from"./DecodeSymbolColor.glsl.js";import{O as N,a as U}from"./orientedBoundingBox.js";import k from"../geometry/SpatialReference.js";function D(e,t,r,o,n){const a="east-north-up"===r?p(e):function(e,t,r){const o=d(),n=e[3],a=2**(Math.ceil(Math.log(n)*Math.LOG2E/q)*q+O);if(r.isGeographic){const t=a/E(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;o[0]=l,o[1]=s}else{const t=Math.round(e[0]/a),r=Math.round(e[1]/a);o[0]=t*a,o[1]=r*a}const s=e[2]+t,i=Math.round(s/a);return o[2]=i*a,o}(e,t,o),s=l();return M(o,a,s,n),s}const O=1,q=5-O;function W(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function _(e){if(o("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function F(e,t,r,o){r.traverse(t,(t=>{const r=t.serviceMbsInIndexSR;return(null!=r&&B(e,r))!==P.OUTSIDE&&(o(t),!0)}))}function L(e,t,r){let o=0,n=0;for(let a=0;a<t.length&&o<e.length;a++)e[o]===t[a]&&(r(a)&&(e[n]=e[o],n++),o++);e.length=n}function A(e,t,r){let o=0,a=0;for(;o<r.length;)n(e,r[o])>=0===t&&(r[a]=r[o],a++),o++;r.length=a}const K=g();function G(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return K[0]=(e[0]-t.position[0])/t.rotationScale[0],K[1]=(e[1]-t.position[1])/t.rotationScale[4],K[2]=(e[2]-t.position[0])/t.rotationScale[0],K[3]=(e[3]-t.position[1])/t.rotationScale[4],K}var P;function B(e,t){const r=t[0],o=t[1],n=t[3],a=e[0]-r,s=r-e[2],i=e[1]-o,l=o-e[3],c=Math.max(a,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>n*n?P.OUTSIDE:f>0?P.INTERSECTS_CENTER_OUTSIDE:-Math.max(a,s,i,l)>n?P.INSIDE:P.INTERSECTS_CENTER_INSIDE}function z(e,t,r){const o=[],n=r?.missingFields,a=r?.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const n of t)if(e===n.name.toLowerCase()){o.push(n.name),s=!0,a&&a.push(r);break}!s&&n&&n.push(r)}return o}async function $(e,t,r,o,n,a){if(0===t.length)return[];const i=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,o,n){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const a=t.map((e=>e.attributes[r])),s=[],i=z(o,e.fields,{originalFields:s}),l=await V(e,a,i,n);for(let e=0;e<t.length;e++){const r=t[e],o=l[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<s.length;e++)n[s[e]]=o[i[e]];r.attributes=n}return t}(e.associatedLayer,t,r,o,a)}catch(t){if(e.associatedLayer.loaded)throw t}if(i){const l=function(e,t,r){const o=new Map,n=[],a=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<a.length;t++){const s=a[t],i=s.featureIds.indexOf(e);if(i>=0){let e=o.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},n.push(e),o.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)a[e]=a[e-1];a[0]=s;break}}}return n}(t,r,n);if(null==l)throw new s("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const c=e.parsedUrl.path,u=await Promise.all(l.map((t=>function(e,t,r,o,n,a,s,i){return Q(e,t,r.resources.attributes,o,n,a,s,i)}(c,i,t.node,t.indices,o,e.apiKey,e.customParameters,a).then((e=>{for(let r=0;r<t.graphics.length;r++){const o=t.graphics[r],n=e[r];if(o.attributes)for(const e in o.attributes)e in n||(n[e]=o.attributes[e]);o.attributes=n}return t.graphics})))));return u.flat()}throw new s("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function V(e,t,r,o){const n=e.capabilities.query.maxRecordCount;if(null!=n&&t.length>n){const s=a(t,n);return Promise.all(s.map((t=>V(e,t,r,o)))).then((e=>e.flat()))}const i=new I({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(i,o).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new s("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}async function Q(t,r,o,n,a,s,i,l){const c=[];for(const e of r)if(e&&a.includes(e.name)){const r=`${t}/nodes/${o}/attributes/${e.key}/0`;c.push({url:r,storageInfo:e})}const u=await Promise.allSettled(c.map((t=>e(t.url,{responseType:"array-buffer",query:{...i,token:s},signal:l?.signal}).then((e=>v(t.storageInfo,e.data)))))),f=[];for(const e of n){const t={};for(let r=0;r<u.length;r++){const o=u[r];if("fulfilled"===o.status){const n=o.value;t[c[r].storageInfo.name]=J(n,e)}}f.push(t)}return f}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(P||(P={}));const Z=-32768,H=-(2**31);function J(e,o){if(!e)return null;const n=e[o];return t(e)?n===Z?null:n:r(e)?n===H?null:n:n!=n?null:n}function X(e){const t=e.store,r=t.indexCRS||t.geographicCRS,o=void 0===r?t.indexWKT:void 0;if(o){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(o!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new k(W(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function Y(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,o=void 0===r?t.vertexWKT:void 0;if(o){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(o!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const n=r?new k(W(r)):e.spatialReference;return n.equals(e.spatialReference)?e.spatialReference:n}function ee(e,t){return null==t?"@null":t===h(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function te(e,t,r){if(!m(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function re(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new s("layerview:recycle-failed")}function oe(e,t,r){const o=X(e),n=Y(e);te(o,t,r),te(n,t,r)}function ne(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new s("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function ae(e,t){oe(e,t.spatialReference,t.viewingMode)}function se(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function ie(e,t){te(e.spatialReference,t.spatialReference,t.viewingMode)}function le(e){return"mesh-3d"===e.type}function ce(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!le(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1}const ue=R({color:[0,0,0,0],opacity:0});class fe{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function pe(e){const t=new fe;let r=!1,o=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,a=n.edges;if(null!=e&&!r){const o=e.color,a=j(e.colorMixMode);t.material=null!=o?{color:[o.r/255,o.g/255,o.b/255],alpha:o.a,colorMixMode:a}:{color:[1,1,1],alpha:1,colorMixMode:C.Multiply},t.castShadows=n.castShadows,r=!0}null==a||o||(t.edgeMaterial=x(a,{}),o=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:C.Multiply}),t}function de(e,t){return(0|e)+(0|t)|0}function me(e,t,r,o,n,a,s){if(!a||0===a.length||null==t||!e.serviceMbsInIndexSR)return null;const l=D(e.serviceMbsInIndexSR,n,"none",r,t);i(ve,l);let p=null,d=1/0,m=-1/0;if(a.forEach((a=>(a=>{if("replace"!==a.type)return;const i=a.geometry;if(!i?.hasZ)return;w(we);const l=i.spatialReference||o,h=i.rings.reduce(((e,r)=>r.reduce(((e,r)=>(c(Te,r[0],r[1],r[2]),y(Te,l,Te,t),u(Te,Te,ve),b(we,Te),Math.min(Te[2],e))),e)),1/0);(()=>{if(!p)if(p=ge,w(be),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(Se,r,t,n,s),Se.getCorners(p);for(const e of p)u(e,e,ve),b(be,e)}else{const o=e.serviceMbsInIndexSR;if(!o)return;const a=o[3];y(T(o),r,Te,t),u(Te,Te,ve),Te[2]+=n;for(let e=0;e<8;++e){const t=1&e?a:-a,r=2&e?a:-a,o=4&e?a:-a,n=p[e];f(n,[Te[0]+t,Te[1]+r,Te[2]+o]),b(be,n)}}})(),S(be,we)&&(d=Math.min(d,h),m=Math.max(m,h))})(a))),d===1/0)return null;for(let e=0;e<8;++e)h=Ie.data,g=3*e,I=p[e],u(Te,I,l),h[g]=Te[0],h[g+1]=Te[1],h[g+2]=Te[2],g+=24,I[2]=d,u(Te,I,l),h[g]=Te[0],h[g+1]=Te[1],h[g+2]=Te[2],g+=24,I[2]=m,u(Te,I,l),h[g]=Te[0],h[g+1]=Te[1],h[g+2]=Te[2];var h,g,I;return U(Ie)}function he(e){return e[3]>=0}function ye(e){null!=e&&(e[3]=-1)}const ge=[d(),d(),d(),d(),d(),d(),d(),d()],we=g(),be=g(),Se=new N,Te=d(),Ie={data:new Array(72),size:3,exclusive:!0,stride:3},ve=l();export{ue as A,G as B,P as M,L as a,J as b,re as c,oe as d,_ as e,z as f,X as g,te as h,ye as i,se as j,ie as k,de as l,he as m,B as n,A as o,Y as p,Q as q,F as r,ce as s,ne as t,ae as u,ee as v,$ as w,me as x,D as y,pe as z};

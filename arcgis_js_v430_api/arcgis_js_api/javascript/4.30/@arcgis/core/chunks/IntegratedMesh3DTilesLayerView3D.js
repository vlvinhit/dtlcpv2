/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import{h as s}from"../core/lang.js";import{L as r}from"./Logger.js";import{d as i}from"./maybe.js";import{watch as o,initial as a}from"../core/reactiveUtils.js";import{schedule as n}from"../core/scheduling.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{f as l,i as c}from"./mat3.js";import{c as j,I as u}from"./mat3f64.js";import{w as d,x as h}from"./mat4.js";import{c as y}from"./mat4f64.js";import{f as g}from"./quatf64.js";import{i as b,r as f}from"./vec3.js";import{d as w,c as v}from"./vec3f64.js";import{f as U}from"./vec4f64.js";import{S as C}from"./unitUtils.js";import{c as M}from"./computeTranslationToOriginAndRotation.js";import{L as _,l as S,O as T,T as x}from"./Transform.js";import{p as P}from"./projectVectorToVector.js";import{d as E,o as O,s as I,B as V,n as L,r as D,c as R,C as A,t as F,p as B}from"./BufferView.js";import{a as H,b as G,c as k,d as N,e as W,i as z,w as q,f as Q,g as $,h as J,j as Z}from"./ILyr3DWasmPerSceneView.js";import{p as K}from"./elevationInfoUtils.js";import{V as X}from"./ViewingMode.js";import{L as Y}from"./LayerViewPerformanceInfo.js";import{a as ee}from"./RenderGeometry.js";import{L as te}from"./LayerView3D.js";import{a as se,g as re,r as ie}from"../widgets/Attribution/AttributionViewModel.js";import{A as oe,C as ae,T as ne}from"./basicInterfaces.js";import{P as me,T as pe}from"./enums.js";import le from"../Graphic.js";import{T as ce}from"./intersectorUtilsConversions.js";import{I as je,S as ue,c as de}from"./Intersector2.js";import{M as he,a as ye}from"./RayIntersections.js";import{E as ge}from"./ElevationRange.js";import{O as be,a as fe}from"./orientedBoundingBox.js";import{c as we,d as ve,e as Ue}from"../views/SceneView.js";import{R as Ce}from"./RenderTexture.js";import{T as Me}from"./IntegerPassUniform.js";import{A as _e}from"./Attribute.js";import{c as Se}from"./Normals.js";import{T as Te}from"./StencilUtils.js";import{V as xe}from"./VertexAttribute.js";import Pe from"../views/layers/LayerView.js";import{b as Ee}from"./layerViewUtils.js";import"../config.js";import"./asyncUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./ObservableBase.js";import"./tracking.js";import"../core/promiseUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./ensureType.js";import"./shared.js";import"./SimpleObservable.js";import"./common.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./mathUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./aaBoundingRect.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./sphere.js";import"./vec4.js";import"./Axis.js";import"./ray.js";import"./plane.js";import"./vec2f64.js";import"./mathUtils2.js";import"./ElevationUpdateEvent.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../Color.js";import"./colorUtils.js";import"./screenUtils.js";import"./enumeration.js";import"./materialUtils.js";import"./opacityUtils.js";import"./ElevationContext.js";import"./ElevationProvider.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./hydratedFeatures.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./dehydratedPoint.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./graphicUtils.js";import"../geometry/projection.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./aaBoundingBox.js";import"./Material.js";import"./interfaces3.js";import"./vec2f32.js";import"./InterleavedLayout.js";import"./types.js";import"./Util.js";import"./Matrix4PassUniform.js";import"./BindType.js";import"./vec2.js";import"./HUDMaterial.js";import"./debugFlags2.js";import"./VerticalOffset.glsl.js";import"./GLTextureMaterial.js";import"./ScreenSpacePass.glsl.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Texture.js";import"./GLObjectType.js";import"./OutputHighlight.glsl.js";import"./VertexPosition.glsl.js";import"./Matrix3DrawUniform.js";import"./renderState.js";import"./ShaderTechniqueConfiguration.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./edgeUtils.js";import"./compilerUtils.js";import"./floatRGBA.js";import"./DecodeSymbolColor.glsl.js";import"./Float4DrawUniform.js";import"./NormalAttribute.glsl.js";import"./earcut.js";import"./_commonjsHelpers.js";import"./DoubleArray.js";import"./Indices.js";import"./vec32.js";import"./SnappingCandidate.js";import"./visualVariableUtils.js";import"./sizeVariableUtils.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./triangle.js";import"./lineSegment.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./frustum.js";import"./objectResourceUtils.js";import"./devEnvironmentUtils.js";import"./vec42.js";import"./DefaultMaterial_COLOR_GAMMA.js";import"./Version.js";import"./quat.js";import"./resourceUtils3.js";import"./NestedMap.js";import"./requestImageUtils.js";import"./verticalOffsetUtils.js";import"./Matrix4sPassUniform.js";import"../views/3d/webgl/RenderNode.js";import"./CameraSpace.glsl.js";import"./projectPointToVector.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./fontUtils.js";import"./GeometryUtils.js";import"./enums2.js";import"./utils7.js";import"./definitions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"./defaultsJSON.js";import"./OverrideHelper.js";import"./colorUtils2.js";import"../symbols/support/cimSymbolUtils.js";import"./utils11.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./LRUCache.js";import"./MemCache.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./line.js";import"./line2.js";import"./lineStippleUtils.js";import"./projectVectorToPoint.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./imageUtils.js";import"../geometry/support/MeshTextureTransform.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"./MeshVertexAttributes.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./projection.js";import"./spatialReferenceEllipsoidUtils.js";import"./interfaces6.js";import"./DefaultLayouts.js";import"./styleUtils.js";import"./webStyleSymbolUtils.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./glUtil.js";import"./VertexElementDescriptor.js";import"../views/3d/webgl/RenderCamera.js";import"./BufferObject.js";import"./Intersector3.js";import"./Scheduler.js";import"../core/signal.js";import"./debugFlags.js";import"./ColorMaterial.js";import"./TriangleMaterial.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./Intersector.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./arcgisLayerUrl.js";import"./boundedPlane.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"../Viewpoint.js";import"./domUtils.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"./GraphicsCollection.js";import"./RenderCoordsHelper.js";import"./scaleUtils.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./CollectionFlattener.js";import"./editableLayers.js";import"../layers/catalog/catalogUtils.js";import"./basemapUtils.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../TimeExtent.js";import"./timeUtils.js";import"../support/TablesMixin.js";import"./UpdatingHandles.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./ReactiveMap.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./selectionUtils.js";import"../views/Theme.js";import"./InputManager.js";import"./ViewEvents.js";import"./IViewEvents.js";import"./interfaces.js";import"./screenUtils2.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"./a11yUtils.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./projectionUtils.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./widgetUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./earthUtils.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"./TileKey.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./quantityUtils.js";import"./Program.js";import"./ShadowCastVisualizeTechniqueConfiguration.js";import"./euclideanLengthMeasurementUtils.js";import"./WebGLRequirements.js";import"./capabilities2.js";import"./contextUtils.js";import"./ray2.js";import"./viewpointUtils2.js";import"./ZoomMomentumEstimator.js";import"./labelFormatUtils.js";import"./labelUtils.js";import"./FeatureTileDescriptor3D.js";import"./hitTest.js";import"./LayerConstants.js";import"./geometryServiceUtils.js";import"./project.js";import"./utils8.js";import"./utils9.js";import"../rest/support/ProjectParameters.js";import"./hitTestSelectUtils.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"./ByteSizeUnit.js";import"../views/3d/support/LayerPerformanceInfo.js";import"./ElevationQueryTileCache.js";import"./RenderableTile.js";import"./mat3f32.js";import"./enums3.js";import"./TileStrategy.js";import"./TileKey2.js";import"./QueueProcessor.js";import"./config.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./StyleDefinition.js";import"./ElevationSamplerData.js";import"./resources.js";import"./edgeProcessing.js";import"./Viewshed.js";import"../views/3d/webgl.js";import"../views/3d/webgl/ManagedFBO.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./doublePrecisionUtils.js";import"./screenshotUtils.js";import"../views/ui/DefaultUI.js";import"../views/ui/UI.js";import"./themeUtils.js";import"../widgets/Attribution.js";import"../widgets/Widget.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"./globalCss.js";import"./accessibleHandler.js";import"./messageBundle.js";import"./jsxFactory.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils20.js";import"../widgets/support/GoTo.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";class Oe extends Y{constructor(e,t,s,r,i,o,a){super(e,0,0,0,t),this.nodesCached=s,this.vboMB=r,this.textureMB=i,this.vboMBCached=o,this.textureMBCached=a}}const Ie={[H.Points]:null,[H.Lines]:null,[H.LineStrip]:null,[H.Triangles]:me.TRIANGLES,[H.TriangleStrip]:me.TRIANGLE_STRIP,[H.NotSet]:null},Ve={[G.Opaque]:oe.Opaque,[G.Mask]:oe.Mask,[G.Blend]:oe.Blend},Le={[k.Back]:ae.Back,[k.Front]:ae.Front,[k.None]:ae.None,[k.NotSet]:ae.Back},De={[N.WrapYBit]:{s:pe.CLAMP_TO_EDGE,t:pe.REPEAT},[N.WrapXBit]:{s:pe.REPEAT,t:pe.CLAMP_TO_EDGE},[N.WrapXy]:{s:pe.REPEAT,t:pe.REPEAT},[N.None]:{s:pe.CLAMP_TO_EDGE,t:pe.CLAMP_TO_EDGE},[N.NotSet]:{s:pe.CLAMP_TO_EDGE,t:pe.CLAMP_TO_EDGE}},Re={[W.U8]:1,[W.I8]:1,[W.U16]:2,[W.I16]:2,[W.U32]:4,[W.I32]:4,[W.F32]:4,[W.F64]:8,[W.Utf8String]:1,[W.NotSet]:1};class Ae{constructor(e){this.layerUid=[],this.type=je.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,t,s,r,i,o){const a=e.results,n=e.options.store===ue.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const m=this.layerView.view._stage.renderView.componentObjectCollection,p=new he(o??!1,e.options.normalRequired);this.layerView.objects.forEach((i=>{i.visible&&i.intersectionGeometry&&m.intersect(i,s,r,e.tolerance,null,p,((i,o,m,p)=>{if(o>=0){if(null!=t&&!t(s,r,o))return;const i=e=>{const t=new ce(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,o,m)};if(this.isGround&&(null==a.ground.dist||o<a.ground.dist)&&i(a.ground),e.options.isFiltered)return;if((null==a.min.dist||o<a.min.dist)&&i(a.min),(null==a.max.dist||o>a.max.dist)&&i(a.max),n){const t=de(e.ray);i(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new le({layer:e,sourceLayer:e,attributes:t})}}var Fe;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(Fe||(Fe={}));class Be{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function He(e){return Math.round(e/1048.576)/1e3}let Ge=class extends(te(Pe)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ee.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(Fe.Error),this._dbg(Fe.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new t("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=se(this).then((e=>{this._intersectionHandler=new Ae(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._elevationProvider=new _({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=t,this.addHandles([o((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))]),this._suspendedHandle=o((()=>this.suspended),(e=>{const t=re(this.view);t&&t.setEnabled(this,!e)}),a)})).catch((e=>{if(ie(this),this._wasmLayerId=-1,e===z)throw new t("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===q)throw new t("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})}));this.addResolvingPromise(e)}destroy(){this._dbg(Fe.VerboseAPI,"Tiles3DLayerView3D destroy() called"),ie(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=i(this._memCache),this._updatingHandles=i(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=n((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((t=>{const s=this._collection.getMaterial(t);s.commonMaterialParameters.hasSlicePlane=e,s.commonMaterialParameters.cullFace=e?ae.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){const t=re(this.view);t&&t.setLayerOffset(this,K(e))}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible&&(e+=t.totalMemory())})),e}get unloadedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible||(e+=t.totalMemory())})),e}get visibleAtCurrentScale(){return Ee(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let e=0,t=0,s=0,r=0,i=0,o=0;return this._lyrHandleToObjects.forEach((a=>{a.isVisible?(e+=a.texMemoryUsage,t+=a.vboMemoryUsage,i++):(s+=a.texMemoryUsage,r+=a.vboMemoryUsage,o++)})),new Oe(this.usedMemory,i,o,He(t),He(e),He(r),He(s))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===X.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return K(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new ge(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=re(this.view);return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const r=w(t.desc.origin),i=new Array,o=new Map,a=new Be;a.handle=e.handle,this._lyrHandleToObjects.set(e.handle,a);const n=this.view.basemapTerrain.spatialReference;let m,p;if("global"===this.view.viewingMode){const e=y();M(C,r,e,n),m=l(j(),e),p=c(j(),m)}else m=u,p=u;const _=y();d(_,_,r);const E=h(v(),_);let O=null;const I=v();if(t.desc.obb){const e=t.desc.obb.quaternion;O=new be(t.desc.obb.center,t.desc.obb.halfSize,g(e[0],e[1],e[2],e[3]))}for(let e=0;e<t.desc.prims.length;e++){const l=t.desc.prims[e];if(this._dbg(Fe.VerboseAPI,JSON.stringify(l)),l.ptype===H.Lines)continue;if(null==Ie[l.ptype]||null==t.data){this._dbg(Fe.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+l.ptype+"). Skipping primitive.");continue}const c=t.desc?.materials&&null!=l.materialId?t.desc.materials[l.materialId]:null,j=null!=c?c.lightingModel:Q.Unlit,d=!s("disable-feature:im-shading"),{positionView:h,positionAttr:y,normalsView:g,normalsAttr:w,colorAttr:C,texCoord0Attr:M,indicesView:_}=this.getBufferViews(l,t.data.buffer,m,d);if(null==y||null==h||null==_)continue;const V={colors:null!=C,textureCoordinates:null!=M?Me.Default:Me.None,hasNormals:null!=g,needsNormals:d},L=y.data.length/y.size,D=(e,t)=>!e||e.data.length/e.size===L||(this._dbg(Fe.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!D(M,"numTexcoord")||!D(C,"numColors")||!D(w,"normals"))continue;const R=we(V);if(null!=O?O=O.clone():(O=fe(y),b(I,O.center,r),O.center=I),m!==u)for(let e=0;e<h.count;e++)h.getVec(e,I),f(I,I,m),h.setVec(e,I);const A=R.createBuffer(y.data.length),F=new Map([[xe.POSITION,y]]);null!=M&&F.set(xe.UV0,M),null!=C&&F.set(xe.COLOR,C),null!=w&&F.set(xe.NORMALCOMPRESSED,w),F.forEach(((e,t)=>{null!=e&&ye(t,e,null,null,A,0)}));const B=new Uint32Array([0,_.typedBuffer.length]),G={vertices:{data:A.buffer,count:A.byteLength/R.stride,layoutParameters:V},positionData:{positions:h.typedBuffer,indices:_.typedBuffer},indices:_.typedBuffer,componentOffsets:B};a.cpuMemoryUsage+=h.count,a.cpuMemoryUsage+=_.count;const k=this.view.renderSpatialReference,N=v(),W=[1,1,1];S(E,k,W,n)||this._dbg(Fe.Error,"Unsupported coordinate system for IM overlay"),P(E,k,N,n);const z=this._collection.createObject(new T(U(N[0],N[1],W[0],W[1]),new x(E,p),O,G));c&&this._collection.updateMaterial(z,(e=>{e.baseColor=c.baseColorFactor,e.usePBR=j===Q.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(c.baseColorTex,t,o),e.usePBR&&(e.mrrFactors=[c.metallicFactor,c.roughnessFactor,0],e.emissiveFactor=c.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(c.metalTex,t,o),e.emissionTexture=this._getTexture(c.emissiveTex,t,o),e.occlusionTexture=this._getTexture(c.occlusionTex,t,o),e.normalTexture=this._getTexture(c.normalTex,t,o)),e.objectOpacity=0,e.alphaDiscardMode=oe.Mask;const s=[];e.baseColorTexture&&s.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&s.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&s.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&s.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&s.push(e.normalTexture.loadPromise);const r=Promise.all(s);i.push(r),r.then((()=>{e.alphaDiscardMode=Ve[c.alphaMode],e.objectOpacity=1,a.texMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(a.texMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=c.isDoubleSided,e.commonMaterialParameters.cullFace=c.faceCulling?Le[c.faceCulling]:ae.Back,this._initialCullFace.set(z,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=ve.All,e.textureAlphaCutoff=c.alphaCutoff??.1,e.alphaDiscardMode=Ve[c.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=Ue(this.view.spatialReference)})),a.components.push(z),a.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(z)}if(await Promise.all(i),o.forEach((e=>{a.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${a.handle}`,a,a.totalMemory()),{memUsageBytes:a.totalMemory()}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.remove(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t,s){if(this._memCache){for(let r=0;r<s;++r){const s=e[r],i=t[r];if(!i)continue;const o=this._lyrHandleToObjects.get(s);o&&(this._visibleGeometryChanged(),o.isVisible=i,o.components.forEach((e=>{this._collection.setObjectVisibility(e,i),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${s}`))}for(let r=0;r<s;++r){const s=e[r],i=t[r];if(i)continue;const o=this._lyrHandleToObjects.get(s);o&&(this._visibleGeometryChanged(),o.isVisible=i,o.components.forEach((e=>{this._collection.setObjectVisibility(e,i),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${s}`,o,o.totalMemory()))}}}_getTexture(e,t,s){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const i=t.desc.images[e?.imageId];if(r=s.get(i),!r&&i){const o=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,a=o>1,n=De[e.wrapMode??N.None];let m=i.alpha?4:3;const p=new Uint8Array(t.data.buffer,i.data.byteOffset,i.data.byteCount);let l=null,c=null,j=null;switch(i.format){case $.Raw:i.pixelFormat===J.R8?(l=p.buffer,m=1,c=""):i.pixelFormat===J.Rgb8?(l=p.buffer,m=3,c=""):i.pixelFormat===J.Rgba8&&(l=p.buffer,m=4,c="");break;case $.Dxt1:l=p.buffer,m=3,c=ne.DDS_ENCODING;break;case $.Dxt5:l=p.buffer,m=4,c=ne.DDS_ENCODING;break;case $.Png:c="image/png",j=document.createElement("img");break;case $.Jpeg:c="image/jpeg",j=document.createElement("img");break;case $.Etc2:c="image/ktx",j=document.createElement("img");break;case $.Astc:this._dbg(Fe.Error,"Astc texture not supported");break;case $.Pvrtc:this._dbg(Fe.Error,"Pvrtc texture not supported")}if(j&&c){const e=new Blob([p],{type:c});j.src=URL.createObjectURL(e),l=j}l&&null!=c&&(r=new Te(l,{mipmap:a,maxAnisotropy:o,encoding:c,wrap:n,components:m,noUnpackFlip:!0,width:i.mip0Width,height:i.mip0Height}),this._stage.add(r),s.set(i,r))}}return r?new Ce(this.view._stage.renderView.textures,r.id):null}getBufferViews(e,t,s,r){let i,o,a,n,m,p,l,c=null;for(let l=0;l<e.atrbs.length;l++){const j=e.atrbs[l],u=j.view,d=void 0,h=u.byteOffset+u.byteCount,y=u.byteCount/Re[u.type],g=[...Array(y).keys()].map((e=>e));try{switch(j.sem){case Z.Position:3!==u.ncomp||u.type!==W.F32?this._dbg(Fe.Error,"[Unsupported Feature] Unsupported view for Position ("+u+")"):(i=new V(t,u.byteOffset,d,h),o=new _e(i.typedBuffer,g,3));break;case Z.Normal:if(3!==u.ncomp||u.type!==W.F32)this._dbg(Fe.Error,"[Unsupported Feature] Unsupported view for Normal ("+u+")");else if(r){const e=new V(t,u.byteOffset,d,h),r=Se(e.typedBuffer,s);m=new A(r),p=new _e(m.typedBuffer,g,2)}break;case Z.TexCoord:2!==u.ncomp||u.type!==W.F32?this._dbg(Fe.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+u+")"):void 0===n&&(n=new _e(new R(t,u.byteOffset,d,h).typedBuffer,g,2));break;case Z.Color:4===u.ncomp?(u.type===W.F32&&(c=new E(t,u.byteOffset,d,h)),u.type===W.U8&&(c=new O(t,u.byteOffset,d,h)),u.type===W.U16&&(c=new I(t,u.byteOffset,d,h))):3===u.ncomp&&(u.type===W.F32&&(c=new V(t,u.byteOffset,d,h)),u.type===W.U8&&(c=new L(t,u.byteOffset,d,h)),u.type===W.U16&&(c=new D(t,u.byteOffset,d,h))),null==c?this._dbg(Fe.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+u+")"):a=new _e(c.typedBuffer,g,u.ncomp);break;case Z.FeatureIndex:break;default:this._dbg(Fe.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+j.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(Fe.VerboseAPI,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}}if(e.index){const s=e.index.view,r=void 0,i=s.byteOffset+s.byteCount;switch(e.index.view.type){case W.U16:l=new B(t,s.byteOffset,r,i);break;case W.U32:l=new F(t,s.byteOffset,r,i);break;case W.U8:default:this._dbg(Fe.Error,"[Unsupported Feature] index type not supported ("+s.type+").")}}if(null==l&&null!=i){const e=i.count;if(e<65535){const t=new Uint16Array(e);l=new B(t)}else{const t=new Uint32Array(e);l=new F(t)}for(let t=0;t<e;t++)l.set(t,t)}return{positionView:i,positionAttr:o,colorAttr:a,texCoord0Attr:n,indicesView:l,normalsView:m,normalsAttr:p}}_onRemoveFromCache(e){const t=re(this.view);t&&t.onRenderableEvicted(this,e.handle,e.totalMemory()),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===Fe.Error?r.getLogger(this).error(t):r.getLogger(this).warn(t))}};e([m()],Ge.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),e([m()],Ge.prototype,"layer",void 0),e([m({readOnly:!0})],Ge.prototype,"visibleAtCurrentScale",null),e([m()],Ge.prototype,"elevationOffset",null),Ge=e([p("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],Ge);const ke=Ge;export{ke as default};

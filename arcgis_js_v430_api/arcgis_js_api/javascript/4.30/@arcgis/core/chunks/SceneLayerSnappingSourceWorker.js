/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{throwIfAborted as s}from"../core/promiseUtils.js";import"./Logger.js";import"../core/lang.js";import"../core/Error.js";import{subclass as e}from"../core/accessorSupport/decorators/subclass.js";import{o,j as i,i as r}from"./vec3.js";import{c as n,e as c}from"./vec3f64.js";import{c as m,f as p,b as a}from"./lineSegment.js";import{b as d,g as u,d as h}from"./sphere.js";import{O as j}from"./Octree.js";import{d as l}from"./edgeProcessing.js";import"./handleUtils.js";import"./maybe.js";import"../config.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./common.js";import"./mathUtils.js";import"./ray.js";import"../core/scheduling.js";import"./plane.js";import"./mat3f64.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./vec4f64.js";import"./mathUtils2.js";import"./mat4.js";import"./vec4.js";import"./Axis.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"./frustum.js";import"./Util.js";import"./deduplicate.js";import"./Indices.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./vec2.js";import"./types.js";import"./VertexAttribute.js";import"./glUtil.js";import"./enums.js";import"./VertexElementDescriptor.js";import"./Normals.js";function g(t,s,e){const n=d(),c=u(n);return o(c,c,t,.5),o(c,c,s,.5),n[3]=i(c,t),r(c,c,e),n}let f=class{constructor(){this._idToComponent=new Map,this._components=new j((t=>t.bounds)),this._edges=new j((t=>t.bounds)),this._tmpLineSegment=m(),this._tmpP1=n(),this._tmpP2=n(),this._tmpP3=n(),this.remoteClient=null}async fetchCandidates(t,e){await Promise.resolve(),s(e),await this._ensureEdgeLocations(t,e);const o=[];return this._edges.forEachNeighbor((s=>(this._addCandidates(t,s,o),o.length<1e3)),t.bounds),{result:{candidates:o}}}async _ensureEdgeLocations(t,s){const e=[];if(this._components.forEachNeighbor((t=>{if(null==t.info){const{id:s,uid:o}=t;e.push({id:s,uid:o})}return!0}),t.bounds),!e.length)return;const o={components:e},i=await this.remoteClient.invoke("fetchAllEdgeLocations",o,s??{});for(const t of i.components)this._setFetchEdgeLocations(t)}async add(t){const s=new v(t.id,t.bounds);return this._idToComponent.set(s.id,s),this._components.add([s]),{result:{}}}async remove(t){const s=this._idToComponent.get(t.id);if(s){const t=[];this._edges.forEachNeighbor((e=>(e.component===s&&t.push(e),!0)),s.bounds),this._edges.remove(t),this._components.remove([s]),this._idToComponent.delete(s.id)}return{result:{}}}_setFetchEdgeLocations(t){const s=this._idToComponent.get(t.id);if(null==s||t.uid!==s.uid)return;const e=l.createView(t.locations),o=new Array(e.count),i=n(),r=n();for(let n=0;n<e.count;n++){e.position0.getVec(n,i),e.position1.getVec(n,r);const c=g(i,r,t.origin),m=new y(s,n,c);o[n]=m}this._edges.add(o);const{objectIds:c,origin:m}=t;s.info={locations:e,objectIds:c,origin:m}}_addCandidates(t,s,e){const{info:o}=s.component,{origin:i,objectIds:n}=o,c=o.locations,m=c.position0.getVec(s.index,this._tmpP1),p=c.position1.getVec(s.index,this._tmpP2);r(m,m,i),r(p,p,i);const a=n[c.componentIndex.get(s.index)];this._addEdgeCandidate(t,a,m,p,e),b(t,a,m,e),b(t,a,p,e)}_addEdgeCandidate(t,s,e,o,r){if(!t.returnEdge)return;const n=u(t.bounds),m=p(e,o,this._tmpLineSegment),d=a(m,n,this._tmpP3);h(t.bounds,d)&&r.push({type:"edge",objectId:s,target:c(d),distance:i(n,d),start:c(e),end:c(o)})}};f=t([e("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],f);const _=f;function b(t,s,e,o){if(!t.returnVertex||!h(t.bounds,e))return;const r=u(t.bounds);o.push({type:"vertex",objectId:s,target:c(e),distance:i(r,e)})}class v{constructor(t,s){this.id=t,this.bounds=s,this.info=null,this.uid=++v.uid}}v.uid=0;class y{constructor(t,s,e){this.component=t,this.index=s,this.bounds=e}}export{_ as default};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../Viewpoint.js";import e from"../core/Collection.js";import{d as n}from"./mathUtils.js";import{k as r,j as a,g as o,f as i}from"./unitUtils.js";import{t as s}from"./common.js";import{f as c,r as u,s as f,t as l,a as m,b as y,i as p}from"./mat2d.js";import{c as g}from"./mat2df64.js";import{n as x,e as h,g as b,s as w,i as d,j,d as G,l as R,k as A,b as k,t as S,m as v}from"./vec2.js";import{c as M,f as z}from"./vec2f64.js";import F from"../geometry/Extent.js";import N from"../geometry/Geometry.js";import q from"../geometry/Point.js";import{isLoaded as I,canProjectWithoutEngine as V,load as C,project as L}from"../geometry/projection.js";import P from"../geometry/SpatialReference.js";import{getClosestDenormalizedXToReference as E,getDenormalizedExtent as U}from"../geometry/support/normalizeUtils.js";const O=96,Q=39.37,T=180/Math.PI;function B(t){return t.wkid?t:t.spatialReference||P.WGS84}function D(t,e){return e.type?b(t,e.x,e.y):v(t,e)}function W(t){return o(t)}function H(t,e,r=0){let a=t.width,o=t.height;if(0!==r){const e=n(r),i=Math.abs(Math.cos(e)),s=Math.abs(Math.sin(e));a=t.width*i+t.height*s,o=t.width*s+t.height*i}const i=Math.max(1,e[0]),s=Math.max(1,e[1]);return Math.max(a/i,o/s)*ot(t.spatialReference)}async function J(t,n,r,a){let o,i;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(e.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const e=t.every((t=>"attributes"in t)),o=t.some((t=>!t.geometry));let i=t;if(e&&o&&n&&n.allLayerViews){const e=new Map;for(const n of t){const t=n.layer,r=e.get(t)||[],a=n.attributes[t.objectIdField];null!=a&&r.push(a),e.set(t,r)}const r=[];e.forEach(((t,e)=>{const a=n.allLayerViews.find((t=>t.layer.id===e.id));if(a&&"queryFeatures"in a){const n=e.createQuery();n.objectIds=t,n.returnGeometry=!0,r.push(a.queryFeatures(n))}}));const a=await Promise.all(r),o=[];for(const t of a)if(t&&t.features&&t.features.length)for(const e of t.features)null!=e.geometry&&o.push(e.geometry);i=o}for(const t of i)a=await J(t,n,r,a);return a}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])o=new q(t);else if(t instanceof N)o=t;else if("geometry"in t)if(t.geometry)o=t.geometry;else if(t.layer){const e=t.layer,r=n.allLayerViews.find((t=>t.layer.id===e.id));if(r&&"queryFeatures"in r){const n=e.createQuery();n.objectIds=[t.attributes[e.objectIdField]],n.returnGeometry=!0;const a=await r.queryFeatures(n);o=a?.features?.[0]?.geometry}}if(null==o)return null;switch(o.type){case"point":i=new F({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":i=U(o);break;default:i=o.extent}if(!i)return null;I()||V(i.spatialReference,r)||await C();const s=L(i,r);if(!s)return null;if(a){const t=s.center,e=t.clone();e.x=E(t.x,a.center.x,r),e.x!==t.x&&s.centerAt(e),a=a.union(s)}else a=s;return a}function K(t,e){return i(B(t),e)?t:L(t,e)}async function X(e,n){if(!e||!n)return new t({targetGeometry:new q,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:s,size:c}=n,u=[o?c[0]-o.left-o.right:c[0],o?c[1]-o.top-o.bottom:c[1]];let f=null;e instanceof t?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);let l=null;f?.targetGeometry?l=f.targetGeometry:e instanceof F?l=e:e instanceof N?l=await J(e,n,r):e&&(l=await J(e.center,n,r)||await J(e.target,n,r)||await J(e,n,r)),!l&&s?.targetGeometry?l=s.targetGeometry:!l&&n.extent&&(l=n.extent),r||(r=B(n.spatialReference||n.extent||l)),I()||i(l.spatialReference,r)||V(l.spatialReference,r)||await C();const m=K(l,r),y="center"in m?m.center:m;!1!==n.pickClosestTarget&&"point"===y.type&&"point"===s.targetGeometry?.type&&(y.x=E(y.x,s.targetGeometry.x,y.spatialReference));let p=0;f?p=f.rotation:e.hasOwnProperty("rotation")?p=e.rotation:s&&(p=s.rotation);let g=0;g=null!=f?.targetGeometry&&"point"===f.targetGeometry.type?f.scale:"scale"in e&&e.scale?e.scale:"zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs?a.zoomToScale(e.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?s.scale:H(K(l.extent,r),u,p);const x=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&null!=t.layer?.minScale&&null!=t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,n=0;for(const r of t){const t=r.layer;t?.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,n=t.maxScale>n?t.maxScale:n)}return e&&n?{min:e,max:n}:null}}}(e.target??e);x&&(x.min&&x.min<g?g=x.min:x.max&&x.max>g&&(g=x.max));let h=new t({targetGeometry:y,scale:g,rotation:p});return a&&(h=a.fit(h),a.constrainByGeometry(h),a.rotationEnabled||(h.rotation=s.rotation)),h}function Y(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function Z(t,e,n){return n?b(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):h(t,e,.5)}const $=function(){const t=M();return function(e,n,r){const a=n.targetGeometry;D(t,a);const o=.5*nt(n);return e.xmin=t[0]-o*r[0],e.ymin=t[1]-o*r[1],e.xmax=t[0]+o*r[0],e.ymax=t[1]+o*r[1],e.spatialReference=a.spatialReference,e}}();function _(t,e,n,r,a){return yt(t,e,n.center),t.scale=H(n,r),a?.constraints?.constrain(t),t}const tt=function(){const t=M();return function(e,n,r){return A(e,function(t,e){return h(t,e,.5)}(e,n),Z(t,n,r))}}(),et=function(){const t=g(),e=M();return function(n,r,a,o){const i=nt(r),s=at(r);return b(e,i,i),y(t,e),u(t,t,s),l(t,t,tt(e,a,o)),l(t,t,[0,o.top-o.bottom]),b(n,t[4],t[5])}}();function nt(t){return t.scale*rt(t.targetGeometry?.spatialReference)}function rt(t){return null!=t&&r(t)?1/(W(t)*Q*O):1}function at(t){return s(t.rotation)||0}function ot(t){return r(t)?W(t)*Q*O:1}const it=function(){const t=M(),e=M(),n=M();return function(r,a,o,i,s,m){return x(t,a),h(e,o,.5*m),b(n,1/i*m,-1/i*m),c(r,e),s&&u(r,r,s),f(r,r,n),l(r,r,t),r}}(),st=function(){const t=M();return function(e,n,r,a){const o=nt(n),i=at(n);return D(t,n.targetGeometry),it(e,t,r,o,i,a)}}(),ct=function(){const t=M();return function(e,n,r,a){const o=nt(n);return D(t,n.targetGeometry),it(e,t,r,o,0,a)}}();function ut(t){const e=a(t);return e?e.valid[1]-e.valid[0]:0}function ft(t,e){return Math.round(ut(t)/e)}const lt=function(){const t=M(),e=M(),n=[0,0,0];return function(r,a,o){w(t,r,a),d(t,t),w(e,r,o),d(e,e),j(n,t,e);let i=Math.acos(G(t,e)/(R(t)*R(e)))*T;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),mt=function(){const t=M();return function(e,n,r,a){const o=e.targetGeometry;return Y(e,n),et(t,n,r,a),o.x+=t[0],o.y+=t[1],e}}(),yt=function(t,e,n){Y(t,e);const r=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t},pt=function(){const t=M();return function(e,n,r,a,o){o||(o="center"),A(t,r,a),h(t,t,.5);const i=t[0],s=t[1];switch(o){case"center":b(t,0,0);break;case"left":b(t,-i,0);break;case"top":b(t,0,s);break;case"right":b(t,i,0);break;case"bottom":b(t,0,-s);break;case"top-left":b(t,-i,s);break;case"bottom-left":b(t,-i,-s);break;case"top-right":b(t,i,s);break;case"bottom-right":b(t,i,-s)}return Rt(e,n,t),e}}();function gt(t,e,n){return Y(t,e),t.rotation+=n,t}function xt(t,e,n){return Y(t,e),t.rotation=n,t}const ht=function(){const t=M();return function(e,n,r,a,o){return Y(e,n),isNaN(r)||0===r||(jt(t,a,n,o),e.scale=n.scale*r,Gt(t,t,e,o),Rt(e,e,b(t,t[0]-a[0],a[1]-t[1]))),e}}();function bt(t,e,n){return Y(t,e),t.scale=n,t}const wt=function(){const t=M();return function(e,n,r,a,o,i){return Y(e,n),isNaN(r)||0===r||(jt(t,o,n,i),e.scale=n.scale*r,e.rotation+=a,Gt(t,t,e,i),Rt(e,e,b(t,t[0]-o[0],o[1]-t[1]))),e}}(),dt=function(){const t=M(),e=M();return function(n,r,a,o,i,s,c){return tt(e,s,c),k(t,i,e),o?wt(n,r,a,o,t,s):ht(n,r,a,t,s)}}(),jt=function(){const t=g();return function(e,n,r,a){return S(e,n,function(t,e,n,r){return st(t,e,n,1),p(t,t)}(t,r,a))}}(),Gt=function(){const t=g();return function(e,n,r,a){return S(e,n,st(t,r,a,1))}}(),Rt=function(){const t=M(),e=g();return function(n,r,a){Y(n,r);const o=nt(r),i=n.targetGeometry;return m(e,at(r)),f(e,e,z(o,o)),S(t,a,e),i.x+=t[0],i.y+=t[1],n}}();export{it as a,nt as b,Y as c,$ as d,st as e,ct as f,ut as g,ft as h,mt as i,yt as j,bt as k,H as l,lt as m,pt as n,tt as o,wt as p,Z as q,xt as r,_ as s,Rt as t,gt as u,dt as v,ot as w,rt as x,X as y};

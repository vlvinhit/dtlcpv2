/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../core/Handles.js";import{m as a,h as e}from"./handleUtils.js";import{h as i}from"../core/lang.js";import{watch as s,initial as n,when as r}from"../core/reactiveUtils.js";import{M as o,R as l,c}from"./RenderObject.js";import u from"../Color.js";import h from"../core/Evented.js";import{d as p,r as d}from"./maybe.js";import{c as _,z as m,m as M,f,y as g,w as v,h as w}from"./mat4.js";import{c as y}from"./mat4f64.js";import{s as A,G as x,c as T,n as E,d as S,e as b,b as D}from"./vec3.js";import{f as j,c as P}from"./vec3f64.js";import{s as I,a as O}from"./plane.js";import{b as R,c as L}from"./dragEventPipeline3D.js";import{d as X,b as z,c as U,e as Y,f as C,g as F,E as N}from"./InteractiveToolBase.js";import{C as Z}from"./basicInterfaces.js";import{g as H,t as B,h as q,i as G,e as k}from"./GeometryUtil.js";import{R as V}from"./Material.js";import{C as W}from"./ColorMaterial.js";import{a as J}from"./interfaces.js";import{i as K}from"./elevationInfoUtils.js";import{n as Q}from"./colorUtils2.js";import{c as $}from"./mathUtils.js";import{S as tt}from"./settings.js";var at;!function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"}(at||(at={}));class et{constructor(){this._available=!0}set location(t){this._forEachManipulator3D((a=>a.location=t))}set elevationAlignedLocation(t){this._forEachManipulator3D((a=>a.elevationAlignedLocation=t))}set elevationInfo(t){this._forEachManipulator3D((a=>a.elevationInfo=t))}get renderLocation(){let t;return this._forEachManipulator3D((a=>{t||(t=a.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D((a=>a.available=t))}get hovering(){return this.someManipulator((t=>t.hovering))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}get selected(){return this.someManipulator((t=>t.selected))}hasManipulator(t){return this.someManipulator((a=>a===t))}someManipulator(t){let a=!1;return this.forEachManipulator((e=>{!a&&t(e)&&(a=!0)})),a}_forEachManipulator3D(t){this.forEachManipulator(((a,e)=>{a instanceof o&&t(a,e)}))}}const it=128,st=70,nt=Math.ceil(st/3*2),rt=160,ot=.5,lt=24,ct=9,ut=190,ht=213,pt=60,dt=23,_t=5*Math.PI/12,mt=1*Math.PI/3,Mt=10,ft=.2,gt=30,vt=53,wt=.2,yt=.3,At=200,xt=3,Tt=1e6;function Et(t,a,e){const i=(e,i)=>{a({action:e,object:t,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY})};return e(((a,e,s)=>(e.next((t=>("start"===t.action&&i("start",t),t))).next(X(t)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&i("update",t);break;case"end":i("end",t)}return t})),{steps:e,cancel:s=s.next(z(t)).next((t=>(i("end",{screenDeltaX:0,screenDeltaY:0}),t)))})))}function St(t){if(null==t?.axis)return 1;const{mapStart:a,mapEnd:e,axis:i}=t,s=[e.x-a.x,e.y-a.y];return s[0]*i[0]+s[1]*i[1]>0?1:-1}class bt extends et{constructor(a){super(),this._handles=new t,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=st,this._updateAfterDrag=!1,this.events=new h,this._tool=a.tool,this._view=a.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),null!=a.radius&&(this._radius=a.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=p(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:a}of this._arrowManipulatorInfos)t(a,at.TRANSLATE_XY)}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.operations.data.spatialReference,n=e.graphic;return Et(e,i,(a=>this.createDragPipeline(((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s))),e.elevationInfo,s,n)))}createDragPipeline(t,a,i,s){return e(this._arrowManipulatorInfos.map((({manipulator:e},n)=>U(e,((e,r,o,l,c)=>{const u=r.next((t=>({...t,manipulatorType:at.TRANSLATE_XY}))).next(Y(this._view,e.elevationAlignedLocation)).next(R(this._view,e.elevationAlignedLocation,a,i,s)).next(C(e.location,this.angle+(n+1)*Math.PI*.5)).next(F());t(e,u,o,l,c)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:a},e){const i=this._radius/st,s=54*i,n=s*Math.sqrt(3)/2,r=H(this._opaqueMaterial,n,s/2,s/2,.02);B(r,_(O.get(),A(I.get(),0,-n/3,0))),t.renderObjects=[new l(r,J.Focused),new l(r.instantiate({material:this._transparentMaterial}),J.Unfocused)],t.radius=n/3*2*1.2;const o=m(O.get(),e*Math.PI/2),c=_(O.get(),A(I.get(),0,100*i,0));M(a,o,c)}_createManipulators(){for(let t=0;t<4;t++){const a=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(a)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,a=f(O.get(),t,j(0,0,1));if(null==a)return;const e=g(O.get(),A(I.get(),this.displayScale,this.displayScale,this.displayScale)),i=M(O.get(),e,a);for(const t of this._arrowManipulatorInfos){const a=M(O.get(),i,t.transform);t.manipulator.modelTransform=a}}_createArrowManipulator(t){const a=new o({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)}}),e={manipulator:a,transform:y()};return this._updateArrowManipulator(e,t),this._handles.add(a.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),e}_createMaterial(t=1){const a=new W({cullFace:Z.Back,renderOccluded:V.Transparent,isDecoration:!0});return this._handles.add(s((()=>u.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>{e[3]*=t,a.setParameters({color:e})}),n)),a}get test(){}}class Dt{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const a=this._lastDragEvent.mapEnd,e=this._snap(this._lastDragEvent.screenEnd);if(null!=e){const i={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:!0===t?e:a,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(i)}}this._enabled=t}_snap(t){const a=null!=this._view?this._view.toMap(t,{exclude:[]}):null;return null!=a&&null!=this._view&&(a.z=K(a,this._view,this._elevationInfo)),a}createDragEventPipelineStep(t,a){this._view=t,this._elevationInfo=a,this._lastDragEvent=null;const e=new N;return this._next=e,[t=>{if(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const a=this._snap(t.screenEnd);return null!=a?{action:t.action,mapStart:t.mapStart,mapEnd:a,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}},e]}}class jt extends et{constructor(a){super(),this._handles=new t,this._snapToScene=new Dt,this._scale=1,this._radius=st,this._view=a.view,this._tool=a.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),null!=a.snapToScene&&(this.snapToScene=a.snapToScene),null!=a.radius&&(this._radius=a.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles=p(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,at.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.graphic,n=e.elevationInfo,r=e.operations.data.spatialReference;return Et(e,i,(a=>this.createDragPipeline(((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s))),n,r,s)))}createDragPipeline(t,a,e,i){const s=this._view;return U(this._manipulator,((n,r,o,l,c)=>{const u=r.next(Y(s,n.elevationAlignedLocation)).next(R(s,n.elevationAlignedLocation,a,e,i)).next(...this._snapToScene.createDragEventPipelineStep(s,a)).next((t=>({...t,manipulatorType:at.TRANSLATE_XY}))).next(F());t(n,u,o,l,c)}))}_updateManipulatorTransform(){const t=g(O.get(),A(I.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new o({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:j(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=q(this._discMaterial,.02,1,128,j(0,0,1),j(0,0,0));t.transformation=g(y(),j(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new l(t,J.Focused),new l(t.instantiate({material:this._discMaterialTransparent}),J.Unfocused)],this._manipulator.radius=this._radius/st*80}_createMaterial(t=1){const a=new W({cullFace:Z.Back,renderOccluded:V.Transparent,isDecoration:!0});return this._handles.add(s((()=>u.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>{e[3]*=t,a.setParameters({color:e})}),n)),a}get test(){}}class Pt extends et{constructor(t){super(),this._radius=st,this.events=new h,this._tool=t.tool,this._view=t.view;const a=new tt({getTheme:()=>this._view.effectiveTheme});this._settings=a,null!=t.radius&&(this._radius=t.radius);const e=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:c(It(e,1,.25),V.Occlude),materialFocused:c(It(e,1,0),V.Occlude),materialOccludedUnfocused:c(It(e,.7,0),a.zManipulator.renderOccluded),materialOccludedFocused:c(It(e,.85,0),a.zManipulator.renderOccluded)},this._themeHandle=s((()=>this._view.effectiveTheme.accentColor),(t=>{const a=It(t,1,.25),e=It(t,1,0),i=It(t,.7,0),s=It(t,.85,0),{materialUnfocused:n,materialFocused:r,materialOccludedUnfocused:o,materialOccludedFocused:l}=this._materials;n.setParameters({color:a}),r.setParameters({color:e}),o.setParameters({color:i}),l.setParameters({color:s})})),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._themeHandle=d(this._themeHandle),this._manipulator.applyObjectTransform=Xt,this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,at.TRANSLATE_Z)}createManipulatedObjectDragPipeline(t,e,i){if(!e.operations)return a();const s=e.operations.data.spatialReference;return Et(e,i,(a=>this.createDragPipeline(((e,i,s,n,r)=>(({steps:i,cancel:s}=t(e,i,s,n,r)),a(e,i,s))),s)))}createDragPipeline(t,a){const e=this._view;return U(this._manipulator,((i,s,n,r,o)=>{const l=s.next((t=>({...t,manipulatorType:at.TRANSLATE_Z}))).next(L(e,i.renderLocation,a)).next(F());t(i,l,n,r,o)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,a=this._radius/st,e=t.zManipulator.height*a,i=t.zManipulator.coneHeight*a,s=t.zManipulator.coneWidth*a,n=t.zManipulator.width*a,r=[j(0,0,0),j(0,0,e)],o=[j(0,0,0),j(0,0,e+i)],c=(t=>{const a=y();return v(a,a,[0,0,e]),w(a,a,Math.PI/2),a})(),{materialUnfocused:u,materialFocused:h,materialOccludedUnfocused:p,materialOccludedFocused:d}=this._materials,_=G(u,r,n/2,16,!1),m=k(u,i,s/2,16,!1);m.transformation=c,this._manipulator.renderObjects=[new l(m,J.Unfocused),new l(_,J.Unfocused),new l(m.instantiate({material:h}),J.Focused),new l(_.instantiate({material:h}),J.Focused),new l(m.instantiate({material:p}),J.Unfocused),new l(_.instantiate({material:p}),J.Unfocused),new l(m.instantiate({material:d}),J.Focused),new l(_.instantiate({material:d}),J.Focused)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[o]}}_createManipulator(){const t=this._view,a=new o({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});a.applyObjectTransform=a=>{const e=t.state.camera,i=Ot;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const s=x(e.eye,i),n=e.computeRenderPixelSizeAtDist(s),r=T(Rt,i,e.eye);E(r,r);const o=Lt;t.renderCoordsHelper.worldUpAtPosition(Ot,o);const l=Math.abs(S(r,o)),c=b(Rt,r,o),u=b(Rt,c,o),h=$(l,.01,1),p=1-Math.sqrt(1-h*h)/h/e.fullWidth,d=this._settings,_=this._radius/st,m=d.zManipulator.width*_;D(u,E(u,u),(1/p-1)*s+n*m),a[12]-=Rt[0],a[13]-=Rt[1],a[14]-=Rt[2]},this._manipulator=a,this._updateManipulator()}get test(){}}function It(t,a,e){const i=Q(t,e);return i.a*=a,u.toUnitRGBA(i)}const Ot=P(),Rt=P(),Lt=P(),Xt=()=>{};class zt extends et{constructor(a){super(),this._handles=new t,this._interactive=!0;const{tool:e,view:i,snapToScene:s,radius:n}=a;this._view=i,this.xyManipulation=new jt({tool:e,view:i,snapToScene:s,radius:n}),this.xyAxisManipulation=new bt({tool:e,view:i,radius:n}),this.zManipulation=new Pt({tool:e,view:i,radius:n}),this.xyManipulation.available=a.xyAvailable,this.xyAxisManipulation.available=a.xyAxisAvailable,this.zManipulation.available=a.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((t=>this._handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(t,a,i){return e([this.xyManipulation.createManipulatedObjectDragPipeline(((a,e,i,s,n)=>t(Yt.XY,a,e,i,s,n)),a,i),this.xyAxisManipulation.createManipulatedObjectDragPipeline(((a,e,i,s,n)=>t(Yt.XY_AXIS,a,e,i,s,n)),a,i),this.zManipulation.createManipulatedObjectDragPipeline(((a,e,i,s,n)=>t(Yt.Z,a,e,i,s,n)),a,i)])}createDragPipeline(t,a,i,s){return e([this.xyManipulation.createDragPipeline(((a,e,i,s,n)=>t(Yt.XY,a,e,i,s,n)),a,i,s),this.xyAxisManipulation.createDragPipeline(((a,e,i,s,n)=>t(Yt.XY_AXIS,a,e,i,s,n)),a,i,s),this.zManipulation.createDragPipeline(((a,e,i,s,n)=>t(Yt.Z,a,e,i,s,n)),i)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((a=>t(a,at.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((a=>t(a,at.TRANSLATE_XY))),this.zManipulation.forEachManipulator((a=>t(a,at.TRANSLATE_Z)))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,a=this.xyManipulation;if(i("esri-mobile"))return;const e=[];a.forEachManipulator((t=>e.push(t))),t.forEachManipulator((t=>e.push(t)));const s=()=>{const a=[];this._xyAxisVisible||t.forEachManipulator((t=>a.push(t.disableDisplay()))),this._handles.remove(Ut),this._handles.add(a,Ut)};for(const t of e)this._handles.add(t.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(r((()=>this._view.inputManager?.latestPointerType),s)),s()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((a=>{a.interactive=!t&&this._interactive||a.grabbing}))}static radiusForSymbol(t){const a=null!=t&&"point-3d"===t.type&&t.symbolLayers;return a&&a.some((t=>"icon"===t.type))?nt:st}}const Ut="disable-xy-axis-display";var Yt;!function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"}(Yt||(Yt={}));export{Tt as A,et as M,at as a,zt as b,Et as c,nt as d,Yt as e,st as f,St as g,ft as h,lt as i,yt as j,rt as k,ut as l,gt as m,vt as n,ht as o,ct as p,Mt as q,At as r,wt as s,it as t,ot as u,dt as v,pt as w,_t as x,mt as y,xt as z};

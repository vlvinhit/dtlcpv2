/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{L as n}from"./Logger.js";import{e as t}from"./mathUtils.js";import{R as r,l as e}from"./unitUtils.js";import{n as o}from"./mat3.js";import{c as i}from"./mat3f64.js";import{e as a,m as l,s,i as c}from"./mat4.js";import{c as u,I as f}from"./mat4f64.js";import{u as p,c as m,h as g}from"./vec3.js";import{c as A}from"./vec3f64.js";import{g as v}from"./spatialReferenceEllipsoidUtils.js";import{c as R}from"./computeTranslationToOriginAndRotation.js";import{p as x}from"./projectPointToVector.js";import{v as h}from"./meshVertexSpaceUtils.js";import{b as w,a as y,t as j}from"./vec32.js";import{logProjectionError as E,transformNormal as S,transformTangent as T,projectFromPCPF as F,projectNormalFromPCPF as U,projectTangentFromPCPF as O,projectToPCPF as d,projectNormalToPCPF as C,projectTangentToPCPF as b}from"./projection.js";const G=()=>n.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function N(n,t,{vertexSpace:r,spatialReference:e}){if("georeferenced"===r.type){const o=n;if(!x(t,o,e))return!1;const{origin:i}=r;return m(n,o,i),!0}const o=v(e),i=n;if(!x(t,i,o))return!1;const{origin:a}=r,l=H;if(!R(e,a,l,o))return!1;const s=c(H,l);return null!=s&&(g(n,i,s),!0)}function M(n,r,e){const{vertexSpace:o,transform:i,vertexAttributes:s}=n,u=I(n.spatialReference,e,J.SOURCE|J.TARGET);if(h(o,r)&&(!i||a(i.localMatrix,f))&&t(u,1)){const{position:n,normal:t,tangent:r}=s,o=e?.allowBufferReuse;return{position:o?n:n.slice(),normal:o?t:t?.slice(),tangent:o?r:r?.slice()}}switch(n.vertexSpace.type){case"local":return"local"===r.type?function({vertexAttributes:n,spatialReference:t,transform:r},{origin:e},o,i){const a=v(t);if(!R(t,e,k,a))return E(G(),t,a),null;if(r&&l(k,k,r.localMatrix),!R(t,o,q,a))return E(G(),a,t),null;c(q,q);const s=l(k,q,k);return V(s,t,i,J.SOURCE|J.TARGET),B(n,s)}(n,n.vertexSpace,r.origin,e):function({spatialReference:n,vertexAttributes:t,transform:r},{origin:e},o,i){const a=v(n);if(!R(n,e,k,a))return E(G(),n,a),null;r&&l(k,k,r.localMatrix),V(k,n,i,J.SOURCE);const s=new Float64Array(t.position.length),c=function(n,t,r,e){y(e,n,k);const o=new Float64Array(n.length);return F(e,o,r)?o:(E(G(),v(r),r),null)}(t.position,0,n,s);if(!c)return null;const u=function(n,t,r,e,o){if(null==r)return null;const i=new Float32Array(r.length);return S(r,i,e),U(i,n,t,o,i)?i:(E(G(),v(o),o),null)}(c,s,t.normal,k,n);if(t.normal&&!u)return null;const f=function(n,t,r,e,o){if(null==r)return null;const i=new Float32Array(r.length);return T(r,i,e),O(i,n,t,o,i)?i:(E(G(),v(o),o),null)}(c,s,t.tangent,k,n);if(t.tangent&&!f)return null;if(o){const n=p(D,o);w(c,c,n)}return{position:c,normal:u,tangent:f}}(n,n.vertexSpace,r.origin,e);case"georeferenced":return"local"===r.type?L(n,n.vertexSpace,r.origin,e):function({vertexAttributes:n,transform:t,spatialReference:r},{origin:e},o,i){const{position:a,normal:l,tangent:s}=t?B(n,t.localMatrix):n,c=new Float64Array(a.length);let u=a;if(e&&(u=w(c,u,e)),o){const n=p(D,o);u=w(c,u,n)}I(r,i,J.NONE);const f=i?.allowBufferReuse;return{position:u!==n.position||f?u:u.slice(),normal:l!==n.normal||f?l:l?.slice(),tangent:s!==n.tangent||f?s:s?.slice()}}(n,n.vertexSpace,r.origin,e)}}function L({vertexAttributes:n,spatialReference:t,transform:r},{origin:e},i,a){const l=v(t);if(!R(t,i,k,l))return E(G(),t,l),null;const u=1/I(t,a,J.TARGET);s(k,k,[u,u,u]);const f=c(q,k),{position:p,normal:m,tangent:g}=function(n,t,r){if(!t)return n;if(!r){const{position:r,normal:e,tangent:o}=n;return{position:w(new Float64Array(r.length),r,t),tangent:o,normal:e}}const e=B(n,r.localMatrix);return w(e.position,e.position,t),e}(n,e,r),A=new Float64Array(p.length),x=function(n,t,r,e){const o=d(n,t,e);if(!o)return E(G(),t,v(t)),null;const i=new Float64Array(o.length);return y(i,o,r),i}(p,t,f,A);if(!x)return null;const h=o(z,f),S=function(n,t,r,e,o,i){if(null==n)return null;const a=i??new Float32Array(n.length);return C(n,t,r,e,a)?(j(a,a,o),a):(E(G(),e,v(e)),null)}(m,p,A,t,h,m!==n.normal?m:void 0);if(!S&&m)return null;const T=function(n,t,r,e,o,i){if(null==n)return null;const a=i??new Float32Array(n.length);return b(n,t,r,e,a)?(j(a,a,o,4),a):(E(G(),e,v(e)),null)}(g,p,A,t,h,g!==n.tangent?g:void 0);return!T&&g?null:{position:x,normal:S,tangent:T}}function B(n,t){const r=new Float64Array(n.position.length);y(r,n.position,t);const e=n.normal?new Float32Array(n.normal.length):null,o=n.tangent?new Float32Array(n.tangent.length):null;return e&&n.normal&&S(n.normal,e,t),o&&n.tangent&&T(n.tangent,o,t),{position:r,normal:e,tangent:o}}function V(n,t,r,e){const o=I(t,r,e);1!==o&&s(n,n,[o,o,o])}function I(n,t,r){const e=!!(r&J.SOURCE),o=!!(r&J.TARGET),i=t?.sourceUnit,a=t?.targetUnit;if(!i&&!a)return 1;let l=P(i,n);!e&&i&&1!==l&&(G().warn("source unit conversion not supported"),l=1);let s=1/P(a,n);return!o&&a&&1!==s&&(G().warn("target unit conversion not supported"),s=1),l*s}function P(n,t){if(null==n)return 1;const o=r(t);return 1/e(o,"meters",n)}const k=u(),q=u(),z=i(),D=A(),H=u();var J;!function(n){n[n.NONE=0]="NONE",n[n.SOURCE=1]="SOURCE",n[n.TARGET=2]="TARGET"}(J||(J={}));export{M as c,P as g,N as p};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{h as e}from"./mathUtils.js";import t from"../geometry/SpatialReference.js";import{t as r}from"./DoubleArray.js";import o from"../geometry/support/MeshGeoreferencedVertexSpace.js";import n from"../geometry/support/MeshLocalVertexSpace.js";import{t as s,n as i}from"./vec32.js";import{g as a}from"./assets.js";import{a as f}from"./I3SNode.js";var c,l;function u(e){return a(`esri/libs/i3s/${e}`)}let m,d,y;function p(e){if(!y)return;const t=e.modifications,r=y._malloc(8*t.length),o=new Float64Array(y.HEAPU8.buffer,r,t.length);for(let e=0;e<t.length;++e)o[e]=t[e];y.setModifications(e.context,r,t.length,e.isGeodetic),y._free(r)}function h(e,t,r){const{context:o,globalTrafo:n,mbs:s,obbData:i,elevationOffset:a,geometryBuffer:f,geometryDescriptor:l,indexToVertexProjector:u,vertexToRenderProjector:m}=t,d=e._malloc(f.byteLength),y=e._malloc(33*Float64Array.BYTES_PER_ELEMENT),p=new Uint8Array(e.HEAPU8.buffer,d,f.byteLength);p.set(new Uint8Array(f));const h=new Float64Array(e.HEAPU8.buffer,y,33);E(h,[NaN,NaN,NaN]);let b=h.byteOffset+3*h.BYTES_PER_ELEMENT,g=new Float64Array(h.buffer,b);E(g,n),b+=16*h.BYTES_PER_ELEMENT,g=new Float64Array(h.buffer,b),E(g,s),b+=4*h.BYTES_PER_ELEMENT,i&&(g=new Float64Array(h.buffer,b),E(g,i));const w=l,j={isDraco:!1,isLegacy:!1,color:t.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:t.needNormals&&t.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:t.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:t.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:w.featureIndex},I=e.process(o,!!t.obbData,d,p.byteLength,w,j,y,a,u,m,t.normalReferenceFrame);if(e._free(y),e._free(d),I.error.length>0)throw new Error(`i3s.wasm: ${I.error}`);if(I.discarded)return null;const A=I.componentOffsets.length>0?I.componentOffsets.slice():null,S=I.featureIds.length>0?I.featureIds.slice():null,L=I.anchorIds.length>0?Array.from(I.anchorIds):null,_=I.anchors.length>0?Array.from(I.anchors):null,M=I.interleavedVertedData.slice().buffer,O=I.indicesType===c.Int16?new Uint16Array(I.indices.buffer,I.indices.byteOffset,I.indices.byteLength/2).slice():new Uint32Array(I.indices.buffer,I.indices.byteOffset,I.indices.byteLength/4).slice(),F=I.positions.slice(),N=I.positionIndicesType===c.Int16?new Uint16Array(I.positionIndices.buffer,I.positionIndices.byteOffset,I.positionIndices.byteLength/2).slice():new Uint32Array(I.positionIndices.buffer,I.positionIndices.byteOffset,I.positionIndices.byteLength/4).slice(),P={layout:t.layouts[0],interleavedVertexData:M,indices:O,hasColors:I.hasColors,hasModifications:I.hasModifications,positionData:{data:F,indices:N}};return S&&r.push(S.buffer),A&&r.push(A.buffer),r.push(M),r.push(O.buffer),r.push(F.buffer),r.push(N.buffer),{componentOffsets:A,featureIds:S,anchorIds:L,anchors:_,transformedGeometry:P,obb:I.obb,globalTrafo:n}}function b(e){return 0===e?f.Unmodified:1===e?f.PotentiallyModified:2===e?f.Culled:f.Unknown}function g(e){if(!y)return;const{context:t,buffer:r}=e,o=y._malloc(r.byteLength),n=r.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(y.HEAPU8.buffer,o,n),i=new Float64Array(r);s.set(i),y.filterOBBs(t,o,n),i.set(s),y._free(o)}function w(e){y&&0===y.destroy(e)&&(y=null)}function E(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function j(){y||await I()}function I(){return y?Promise.resolve(y):(d||(d=(m||(m=new Promise((e=>import("./i3s.js").then((e=>e.i)).then((({default:t})=>{const r=t({locateFile:u,onRuntimeInitialized:()=>e(r)});delete r.then})))).catch((e=>{throw e}))),m).then((e=>(y=e,d=null,y)))),d)}!function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(c||(c={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(l||(l={}));const A={transform:(e,t)=>y&&h(y,e,t),destroy:w},S=Object.freeze(Object.defineProperty({__proto__:null,destroyContext:function(e){w(e)},dracoDecompressPointCloudData:async function(e){y=await I();const t=[e.geometryBuffer],{geometryBuffer:r}=e,o=r.byteLength,n=y._malloc(o),s=new Uint8Array(y.HEAPU8.buffer,n,o);s.set(new Uint8Array(r));const i=y.dracoDecompressPointCloudData(n,s.byteLength);if(y._free(n),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);const a=i.featureIds?.length>0?i.featureIds.slice():null,f=i.positions.slice();return a&&t.push(a.buffer),t.push(f.buffer),{result:{positions:f,featureIds:a},transferList:t}},filterObbsForModifications:async function(e){await I(),g(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}},filterObbsForModificationsSync:g,initialize:j,interpretObbModificationResults:b,process:async function(e){y=await I();const t=[e.geometryBuffer];return{result:h(y,e,t),transferList:t}},project:async function(e){const{localMatrix:s,origin:i,positions:a,vertexSpace:f,localMode:c}=e,l=t.fromJSON(e.inSpatialReference),u=t.fromJSON(e.outSpatialReference);let m;const[{projectBuffer:d},{initializeProjection:y}]=await Promise.all([import("./projectBuffer.js").then((e=>e.m)),import("../geometry/projection.js").then((e=>e.a))]);await y(l,u);const p=[0,0,0];if(!d(i,l,0,p,u,0,1))throw new Error("Failed to project");if("georeferenced"===f.type&&null==f.origin){if(m=new Float64Array(a.length),!d(a,l,0,m,u,0,m.length/3))throw new Error("Failed to project")}else{const e="georeferenced"===f.type?o.fromJSON(f):n.fromJSON(f),{project:t}=await import("./projection.js"),i=t({positions:a,transform:s?{localMatrix:s}:void 0,vertexSpace:e,inSpatialReference:l,outSpatialReference:u,localMode:c});if(!i)throw new Error("Failed to project");m=r(i)}const h=m.length,[b,g,w]=p;for(let e=0;e<h;e+=3)m[e]-=b,m[e+1]-=g,m[e+2]-=w;return{result:{projected:m,original:a,projectedOrigin:p},transferList:[m.buffer,a.buffer]}},setLegacySchema:async function(e){y=await I(),y.setLegacySchema(e.context,e.jsonSchema)},setModifications:async function(e){await I(),p(e)},setModificationsSync:p,test:A,transformNormals:async function({normalMatrix:t,normals:r}){const o=new Float32Array(r.length);return s(o,r,t),e(t)&&i(o,o),{result:{transformed:o,original:r},transferList:[o.buffer,r.buffer]}}},Symbol.toStringTag,{value:"Module"}));export{l as M,S,b as a,g as f,j as i,p as s};

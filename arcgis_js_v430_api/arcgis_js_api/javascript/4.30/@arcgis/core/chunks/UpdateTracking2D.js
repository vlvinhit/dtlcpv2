/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t,b as e}from"./tslib.es6.js";import{h as r}from"../core/lang.js";import{L as n,n as i}from"./Logger.js";import s from"../core/Error.js";import{B as o}from"./BindType.js";import{a}from"./Util.js";import{g as u}from"../config.js";import"./Texture.js";import"./enums.js";import{P as c}from"./Program.js";import"./GLObjectType.js";import{l}from"./dataViewUtils.js";import{h as p}from"./highlightReasons.js";import d from"../core/Accessor.js";import{R as h}from"./ReactiveMap.js";import{watch as y}from"../core/reactiveUtils.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{U as g}from"./UpdatingHandles.js";var v,b;!function(t){t[t.Fill=0]="Fill",t[t.PatternFill=1]="PatternFill",t[t.ComplexFill=2]="ComplexFill",t[t.OutlineFill=3]="OutlineFill",t[t.PatternOutlineFill=4]="PatternOutlineFill",t[t.ComplexOutlineFill=5]="ComplexOutlineFill",t[t.Marker=6]="Marker",t[t.PieChart=7]="PieChart",t[t.Line=8]="Line",t[t.TexturedLine=9]="TexturedLine",t[t.Text=10]="Text",t[t.Label=11]="Label",t[t.Heatmap=12]="Heatmap",t[t.DotDensity=13]="DotDensity",t[t.Test=14]="Test"}(v||(v={})),function(t){t[t.Geographic=0]="Geographic",t[t.Arithmatic=1]="Arithmatic"}(b||(b={}));const w=3.14159265359/180,x=3.14159265359/128,_=1,S=1.1,I=1,T=24,$=8,V=1e-5,F=.05,N=1e-30,C=4,P=0,O=2,M=2,D=3,z=0,k=3;class A{constructor(){this._includedModules=new Map}include(t,e){this._includedModules.has(t)?this._includedModules.get(t):(this._includedModules.set(t,e),t(this.builder,e))}}class U extends A{constructor(){super(...arguments),this.vertex=new j,this.fragment=new j,this.attributes=new K,this.varyings=new L,this.extensions=new B,this.constants=new H}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const r=this.extensions.generateSource(t),n=this.attributes.generateSource(t),i=this.varyings.generateSource(t),s="vertex"===t?this.vertex:this.fragment,o=s.uniforms.generateSource(),a=s.code.generateSource(),u="vertex"===t?G:function(t=!0){return`#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n${t?"out vec4 fragColor;":""}\n`}(e),c=this.constants.generateSource().concat(s.constants.generateSource());return`${e?"#version 300 es":""}\n${r.join("\n")}\n${u}\n${c.join("\n")}\n${o.join("\n")}\n${n.join("\n")}\n${i.join("\n")}\n${a.join("\n")}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const r=t.bind[o.Pass];r&&e.set(t.name,r)})),this.fragment.uniforms.entries.forEach((t=>{const r=t.bind[o.Pass];r&&e.set(t.name,r)}));const r=Array.from(e.values()),n=r.length;return(e,i)=>{for(let s=0;s<n;++s)r[s](t,e,i)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const r=t.bind[o.Draw];r&&e.set(t.name,r)})),this.fragment.uniforms.entries.forEach((t=>{const r=t.bind[o.Draw];r&&e.set(t.name,r)}));const r=Array.from(e.values()),n=r.length;return(e,i,s)=>{for(let o=0;o<n;++o)r[o](t,e,i,s)}}}class E{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(t){if(null!=t){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new s(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else n.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder").error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((t=>null!=t.arraySize?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`))}get entries(){return Array.from(this._entries.values())}}class R{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class j extends A{constructor(){super(...arguments),this.uniforms=new E,this.code=new R,this.constants=new H}get builder(){return this}}class K{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return"fragment"===t?[]:this._entries.map((t=>`in ${t[1]} ${t[0]};`))}}class L{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&a(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach(((r,n)=>e.push("vertex"===t?`out ${r} ${n};`:`in ${r} ${n};`))),e}}class B{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e="vertex"===t?B.ALLOWLIST_VERTEX:B.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((t=>e.includes(t))).map((t=>`#extension ${t} : enable`))}}B.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],B.ALLOWLIST_VERTEX=[];class H{constructor(){this._entries=new Set}add(t,e,r){let n="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":n=H._numberToFloatStr(r);break;case"int":n=H._numberToIntStr(r);break;case"bool":n=r.toString();break;case"vec2":n=`vec2(${H._numberToFloatStr(r[0])},                            ${H._numberToFloatStr(r[1])})`;break;case"vec3":n=`vec3(${H._numberToFloatStr(r[0])},                            ${H._numberToFloatStr(r[1])},                            ${H._numberToFloatStr(r[2])})`;break;case"vec4":n=`vec4(${H._numberToFloatStr(r[0])},                            ${H._numberToFloatStr(r[1])},                            ${H._numberToFloatStr(r[2])},                            ${H._numberToFloatStr(r[3])})`;break;case"ivec2":n=`ivec2(${H._numberToIntStr(r[0])},                             ${H._numberToIntStr(r[1])})`;break;case"ivec3":n=`ivec3(${H._numberToIntStr(r[0])},                             ${H._numberToIntStr(r[1])},                             ${H._numberToIntStr(r[2])})`;break;case"ivec4":n=`ivec4(${H._numberToIntStr(r[0])},                             ${H._numberToIntStr(r[1])},                             ${H._numberToIntStr(r[2])},                             ${H._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${e}(${Array.prototype.map.call(r,(t=>H._numberToFloatStr(t))).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${n};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}const G="precision highp float;\nprecision highp sampler2D;";function W(t,e){const r=[];for(r.push(e);r.length;){const e=r.pop();if("object"==typeof e&&!t.has(e.uid)){t.add(e.uid);for(const t of e.children)r.push(t)}}}class q{constructor(){this.uid=q.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=t.split(" ").map(((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t)).join(""),this._debugName=t,this.isImplicit&&this.children[0]instanceof q&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}}function Z(t){return"object"==typeof t?t.clone():t}q.NodeCount=0;class X extends q{constructor(){super(...arguments),this.shaderType="primitive-node"}}class J extends q{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new J(Z(this.child));return this.cloneInto(t),t}}class Q extends q{constructor(t,e,r){super(),this.property=t,this.target=e,this.returnType=r,this.shaderType="property-access-node"}get children(){const t=[this.target];return"string"!=typeof this.property&&t.push(this.property),t}clone(){const t=new Q(this.property,Z(this.target),this.returnType);return this.cloneInto(t),t}}class Y extends q{constructor(t,e,r){super(),this.condition=t,this.ifTrue=e,this.ifFalse=r,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=Z(this.ifTrue),e=this.ifFalse?Z(this.ifFalse):null,r=new Y(this.condition,t,e);return this.cloneInto(r),r}}class tt extends q{constructor(t,e,r,n){super(),this.captureList=t,this.returnType=e,this.generator=n,this.shaderType="block-node",r&&(this.subgraph=new J(r))}get children(){return Object.keys(this.captureList).map((t=>this.captureList[t])).concat(this.subgraph??[])}clone(){const t={};for(const e in this.captureList)t[e]=Z(this.captureList[e]);const e=new tt(t,this.returnType,this.subgraph?Z(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}}class et extends q{constructor(t,e,r,n,i,s=!1){super(),this.token=t,this._children=e,this.isInfix=r,this.isPropertyAccess=n,this.returnType=i,this.isTernary=s,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new et(this.token,this._children.map(Z),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}}var rt,nt,it,st,ot,at,ut,ct,lt,pt,dt,ht,yt,ft;function mt(t){return new Proxy(t,{get(e,r){if("constructor"===r)return new Proxy(e.constructor,{construct:(t,e,r)=>mt(new t(...e))});if(r in e)return e[r];if("string"==typeof r){const e=function(t){const e=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const r of e)if(r.includes(t))return r.map((t=>jt[t]));throw new Error("Unable to find type family")}(t.type);return Wt(t,r,e[r.length-1])}}})}function gt(t){return new Proxy(t,{construct:(t,e,r)=>mt(new t(...e))})}class vt extends Error{}let bt=rt=class extends X{constructor(t,e){super(),this.elementType=t,this.size=e,this.children=[],this.type="array"}clone(){const t=new rt(this.elementType,this.size);return super.cloneInto(t),t}get(t){if("number"==typeof t){const e=new Dt(t);return e.isImplicit=!0,Wt(this,e,this.elementType.constructor)}return Wt(this,t,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(t,e,r){return function(t,e,r=0,n=t.size){const i=new Dt(r).setMutable().setDebugName("FindIndexIterator"),s=e(t.get(i)).setDebugName("FindIndexPredicate"),o=Yt({iter:i},Dt,s,(({out:t,iter:e,subgraph:r})=>`\n${t} = -1;\n\nfor (; ${e} < ${n}; ${e}++) {\n\n${r.body}\n\n  if (${r.varName}) {\n    ${t} = ${e};\n    break;\n  }\n\n}\n`)).setDebugName("FindIndexBlock");return o}(this,t,e,r)}glslFindIndex(t,e,r){return function(t,e,r=0,n=t.size){const i=Yt({array:t},Dt,null,(({out:t,array:i})=>`\n${t} = -1;\nfor (int i = ${r}; i < ${n}; i++) {\n  bool condition;\n  ${e({array:i,i:"i",out:"condition"})}\n  if (condition) {\n    ${t} = i;\n    break;\n  }\n}\n`)).setDebugName("GlslFindIndexBlock");return i}(this,t,e,r)}static ofType(t,e){const r={construct:(r,n)=>new rt(new t,e)};return new Proxy(rt,r)}};bt.type="array",bt=rt=t([function(t){return new Proxy(t,{construct:(t,e,r)=>{return n=new t(...e),new Proxy(n,{get(t,e){if(e in t)return t[e];if("string"==typeof e){const t=parseInt(e,10);if(!isNaN(t))return Wt(n,`[${t}]`,n.elementType.constructor)}}});var n}})}],bt);class wt extends X{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new wt;return t.children=this.children.map(Z),super.cloneInto(t),t}}wt.type="sampler2D";class xt extends X{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new xt(Z(this.children[0]));return super.cloneInto(t),t}multiply(t){return re(this,"number"==typeof t?Ot(t,xt):t)}divide(t){return ne(this,"number"==typeof t?Ot(t,xt):t)}add(t){return ie(this,"number"==typeof t?Ot(t,xt):t)}subtract(t){return se(this,"number"==typeof t?Ot(t,xt):t)}}xt.type="float";let _t=nt=class extends X{constructor(t,e){super(),this.type="vec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new nt(Z(this.children[0]),Z(this.children[1]));return super.cloneInto(t),t}get 0(){return Wt(this,"[0]",xt)}get 1(){return Wt(this,"[1]",xt)}get 2(){throw new vt}get 3(){throw new vt}multiply(t){return re(this,"number"==typeof t?Ot(t,xt):t)}divide(t){return ne(this,"number"==typeof t?Ot(t,xt):t)}add(t){return ie(this,"number"==typeof t?Ot(t,xt):t)}subtract(t){return se(this,"number"==typeof t?Ot(t,xt):t)}};_t.type="vec2",_t=nt=t([gt],_t);let St=it=class extends X{constructor(t,e,r){super(),this.type="vec3",this.children=[t,e,r].filter((t=>null!=t))}get 0(){return Wt(this,"[0]",xt)}get 1(){return Wt(this,"[1]",xt)}get 2(){return Wt(this,"[2]",xt)}get 3(){throw new vt}clone(){const t=new it(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]));return super.cloneInto(t),t}multiply(t){return re(this,"number"==typeof t?Ot(t,xt):t)}divide(t){return ne(this,"number"==typeof t?Ot(t,xt):t)}add(t){return ie(this,"number"==typeof t?Ot(t,xt):t)}subtract(t){return se(this,"number"==typeof t?Ot(t,xt):t)}};St.type="vec3",St=it=t([gt],St);let It=st=class extends X{constructor(t,e,r,n){super(),this.type="vec4",this.children=[t,e,r,n].filter((t=>null!=t))}clone(){const t=new st(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]));return super.cloneInto(t),t}get 0(){return Wt(this,"[0]",xt)}get 1(){return Wt(this,"[1]",xt)}get 2(){return Wt(this,"[2]",xt)}get 3(){return Wt(this,"[3]",xt)}multiply(t){return re(this,"number"==typeof t?Ot(t,xt):t)}divide(t){return ne(this,"number"==typeof t?Ot(t,xt):t)}add(t){return ie(this,"number"==typeof t?Ot(t,xt):t)}subtract(t){return se(this,"number"==typeof t?Ot(t,xt):t)}};It.type="vec4",It=st=t([gt],It);let Tt=ot=class extends X{constructor(t){super(),this.type="uint",this.children=[t]}clone(){const t=new ot(Z(this.children[0]));return super.cloneInto(t),t}};Tt.type="uint",Tt=ot=t([gt],Tt);let $t=at=class extends X{constructor(t,e){super(),this.type="uvec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new at(Z(this.children[0]),Z(this.children[1]));return super.cloneInto(t),t}};$t.type="uvec2",$t=at=t([gt],$t);let Vt=ut=class extends X{constructor(t,e,r){super(),this.type="uvec3",this.children=[t,e,r].filter((t=>null!=t))}clone(){const t=new ut(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]));return super.cloneInto(t),t}};Vt.type="uvec3",Vt=ut=t([gt],Vt);let Ft=ct=class extends X{constructor(t,e,r,n){super(),this.type="uvec4",this.children=[t,e,r,n].filter((t=>null!=t))}clone(){const t=new ct(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]));return super.cloneInto(t),t}};Ft.type="uvec4",Ft=ct=t([gt],Ft);class Nt extends X{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return ye(this,t)}or(t){return he(this,t)}clone(){const t=new Nt(Z(this.children[0]));return super.cloneInto(t),t}}Nt.type="bool";let Ct=lt=class extends X{constructor(t,e){super(),this.type="bvec2",this.children=[t,e].filter((t=>null!=t))}all(){return me(this)}any(){return ge(this)}clone(){const t=new lt(Z(this.children[0]),Z(this.children[1]));return super.cloneInto(t),t}};Ct.type="bvec2",Ct=lt=t([gt],Ct);let Pt=pt=class extends X{constructor(t,e,r){super(),this.type="bvec3",this.children=[t,e,r].filter((t=>null!=t))}all(){return me(this)}any(){return ge(this)}clone(){const t=new pt(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]));return super.cloneInto(t),t}};function Ot(t,e){return"number"==typeof t?new e(t):t}Pt.type="bvec3",Pt=pt=t([gt],Pt);let Mt=dt=class extends X{constructor(t,e,r,n){super(),this.type="bvec4",this.children=[t,e,r,n].filter((t=>null!=t))}all(){return me(this)}any(){return ge(this)}clone(){const t=new dt(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]));return super.cloneInto(t),t}};Mt.type="bvec4",Mt=dt=t([gt],Mt);class Dt extends X{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return re(this,Ot(t,Dt))}add(t){return ie(this,Ot(t,Dt))}subtract(t){return se(this,Ot(t,Dt))}divide(t){return ne(this,Ot(t,Dt))}clone(){const t=new Dt(Z(this.children[0]));return super.cloneInto(t),t}}Dt.type="int";let zt=ht=class extends X{constructor(t,e){super(),this.type="ivec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new ht(Z(this.children[0]),Z(this.children[1]));return super.cloneInto(t),t}};zt.type="ivec2",zt=ht=t([gt],zt);let kt=yt=class extends X{constructor(t,e,r){super(),this.type="ivec3",this.children=[t,e,r].filter((t=>null!=t))}clone(){const t=new yt(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]));return super.cloneInto(t),t}};kt.type="ivec3",kt=yt=t([gt],kt);let At=ft=class extends X{constructor(t,e,r,n){super(),this.type="ivec4",this.children=[t,e,r,n].filter((t=>null!=t))}clone(){const t=new ft(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]));return super.cloneInto(t),t}};At.type="ivec4",At=ft=t([gt],At);class Ut extends X{constructor(t,e,r,n){super(),this.type="mat2",this.children=[t,e,r,n]}clone(){const t=new Ut(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]));return super.cloneInto(t),t}}Ut.type="mat2";class Et extends X{static identity(){return new Et(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=Ne(t),r=be(t);return new Et(r,e,0,Qt(e),r,0,0,0,1)}constructor(t,e,r,n,i,s,o,a,u){super(),this.type="mat3",this.children=[t,e,r,n,i,s,o,a,u]}add(t){return ie(this,t)}multiply(t){return re(this,t)}clone(){const t=new Et(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]),Z(this.children[4]),Z(this.children[5]),Z(this.children[6]),Z(this.children[7]),Z(this.children[8]));return super.cloneInto(t),t}}Et.type="mat3";class Rt extends X{static identity(){return new Rt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,r,n,i,s,o,a,u,c,l,p,d,h,y,f){super(),this.type="mat4",this.children=[t,e,r,n,i,s,o,a,u,c,l,p,d,h,y,f]}static fromColumns(t,e,r,n){return new Rt(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,r.x,r.y,r.z,r.w,n.x,n.y,n.z,n.w)}multiply(t){return re(this,t)}clone(){const t=new Rt(Z(this.children[0]),Z(this.children[1]),Z(this.children[2]),Z(this.children[3]),Z(this.children[4]),Z(this.children[5]),Z(this.children[6]),Z(this.children[7]),Z(this.children[8]),Z(this.children[9]),Z(this.children[10]),Z(this.children[11]),Z(this.children[12]),Z(this.children[13]),Z(this.children[14]),Z(this.children[15]));return super.cloneInto(t),t}}Rt.type="mat4";const jt={float:xt,vec2:_t,vec3:St,vec4:It,int:Dt,ivec2:zt,ivec3:kt,ivec4:At,uint:Tt,uvec2:$t,uvec3:Vt,uvec4:Ft,bool:Nt,bvec2:Ct,bvec3:Pt,bvec4:Mt},Kt=(...t)=>new Dt(...t),Lt=(...t)=>new xt(...t),Bt=(...t)=>new _t(...t),Ht=(...t)=>new It(...t),Gt=(...t)=>new Et(...t);function Wt(t,e,r){const n=new r(new Q(e,t,r));return n.isImplicit=!0,n}function qt(t,e,r,n=null){if(n){const i=new n,s=new n(new et(t,[e,r],!0,!1,i));return s.isImplicit=!0,s}if("float"===e.type||"int"===e.type){const n=new r.constructor(new et(t,[e,r],!0,!1,r.constructor));return n.isImplicit=!0,n}if(("mat2"===e.type||"mat3"===e.type||"mat4"===e.type)&&"float"!==r.type){const n=new r.constructor(new et(t,[e,r],!0,!1,r.constructor));return n.isImplicit=!0,n}const i=new e.constructor(new et(t,[e,r],!0,!1,e.constructor));return i.isImplicit=!0,i}function Zt(t,e,r=e.constructor){const n=new r(new et(t,[e],!1,!1,r));return n.isImplicit=!0,n}function Xt(t,e,r,n=e.constructor){const i=new n(new et(t,[e,r],!1,!1,n));return i.isImplicit=!0,i}function Jt(t,e,r,n,i=e.constructor){const s=new i(new et(t,[e,r,n],!1,!1,i));return s.isImplicit=!0,s}function Qt(t){return re(t,Lt(-1))}function Yt(t,e,r,n){return new e(new tt(t,e,r,n))}function te(t,e,r){const n="function"==typeof e?e():e,i="function"==typeof r?r():r,s=new n.constructor(new Y(t,n,i));return s.isImplicit=!0,s}function ee(...t){const e=t.map((([t,e])=>"function"==typeof e?[t,e()]:[t,e])),r=e[0][1].constructor,n=e.findIndex((t=>!0===t[0]));if(-1===n)throw new Error("A cond must have a fallthrough case with `true`/; ");const i=e.slice(0,n),s=e[n][1],o=new r(i.reduceRight(((t,e)=>te(e[0],e[1],t)),s));return o.isImplicit=!0,o}function re(t,e){return qt("*",t,e)}function ne(t,e){return qt("/",t,e)}function ie(t,e){return qt("+",t,e)}function se(t,e){return qt("-",t,e)}function oe(t,e){return qt(">>",t,e)}function ae(t,e){return qt("&",t,e)}function ue(t,e){return qt("==",t,e,Nt)}function ce(t,e){return qt("<",t,e,Nt)}function le(t,e){return qt("<=",t,e,Nt)}function pe(t,e){return qt(">",t,e,Nt)}function de(t,e){return qt(">=",t,e,Nt)}function he(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>qt("||",t,e,Nt)),t[0])}function ye(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>qt("&&",t,e,Nt)),t[0])}function fe(t){return Zt("abs",t)}function me(t){return Zt("all",t,Nt)}function ge(t){return Zt("any",t,Nt)}function ve(t,e,r){return Jt("clamp",t,e,r,t.constructor)}function be(t){return Zt("cos",t)}function we(t,e){return Xt("distance",t,e,xt)}function xe(t,e){return Xt("dot",t,e,xt)}function _e(t){return Zt("floor",t)}function Se(t){return Zt("fract",t)}function Ie(t){return Zt("length",t,xt)}function Te(t,e){return Xt("max",t,e)}function $e(t,e){return Xt("min",t,e)}function Ve(t,e,r){return Jt("mix",t,e,r)}function Fe(t,e){return Xt("mod",t,e)}function Ne(t){return Zt("sin",t)}function Ce(t,e,r){return Jt("smoothstep",t,e,r)}function Pe(t,e){return Xt("step",t,e,e.constructor)}function Oe(t,e){return Xt("texture2D",t,e,It)}function Me(t,e,r){const n=e.split("\n");for(const e of n)if(e.trim().length){{let e="";null!=r&&(e+=`/*id:${r??"000"}*/   `),t.body+=e.padEnd(14)}t.body+=" ".repeat(t.indent)+e+"\n"}}class De{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let r="";return"boolean"!=typeof e&&"number"!=typeof e&&e.debugInfo.name&&(r=`${e.debugInfo.name}_`),`${r}v${t.varCount++}`}_write(t,e,r=!1){if("number"==typeof e)return e.toString();if("boolean"==typeof e)return e.toString();let n=t.getEmit(e);if(n)return n;switch(e.shaderType){case"scope-node":n=this._writeScopeNode(t,e);break;case"primitive-node":n=this._writePrimitiveNode(t,e,r);break;case"function-node":n=this._writeFunctionNode(t,e);break;case"property-access-node":n=this._writePropertyAccessNode(t,e);break;case"text-node":n=e.text;break;case"block-node":n=this._writeBlockNode(t,e);break;case"condition-node":n=this._writeConditionNode(t,e)}return t.setEmit(e,n),n}_writeScopeNode(t,e){const r=new e.child.constructor;r.setDebugName(e.debugInfo.name);const n=this._write(t,r,!0);return Me(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2,Me(t,`${n} = ${this._write(t,e.child)};`),t.indent-=2,Me(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),n}_writeConditionNode(t,e){const r=new e.ifTrue.constructor,n=this._write(t,r,!0);Me(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const i=t.createSubgraphContext(),s=this._write(i,e.ifTrue);if(t.body+=i.body,s&&Me(t,`${n} = ${s};`),t.indent-=2,Me(t,"}"),e.ifFalse){Me(t,"else {"),t.indent+=2;const r=t.createSubgraphContext(),i=this._write(r,e.ifFalse);t.body+=r.body,i&&Me(t,`${n} = ${i};`),t.indent-=2,Me(t,"}")}return n}_writeBlockNode(t,e){const{captureList:r,generator:n,returnType:i}=e,s={};for(const e in r){if(!r[e])continue;const n=this._write(t,r[e]);s[e]=n}const o=new i,a=this._write(t,o,!0);if(s.out=a,e.subgraph){const r=t.createSubgraphContext(),n=this._write(r,e.subgraph.child),i=r.body;s.subgraph={varName:n,body:i}}const u=n(s);return Me(t,"{\n"),t.indent+=2,Me(t,u),t.indent-=2,Me(t,"}\n"),a}_writePropertyAccessNode(t,e){const r=this._write(t,e.target);return"string"==typeof e.property&&e.property.includes("[")?`${r}${e.property}`:"string"!=typeof e.property?`${r}[${this._write(t,e.property)}]`:`${r}.${e.property}`}_writeFunctionNode(t,e){const r=e.returnType.type;if(e.isInfix){const[n,i]=e.children.map((e=>this._write(t,e))),s=this._createVarName(t,e);return Me(t,`${r.padEnd(5)} ${s} = ${n} ${e.token} ${i};`,e.uid),s}const n=e.children.map((e=>this._write(t,e))).join(", "),i=this._createVarName(t,e);return Me(t,`${r.padEnd(5)} ${i} = ${e.token}(${n});`,e.uid),i}_writePrimitiveNode(t,e,r=!1){const n=t.getInput(e);if(n)return n.isUsed=!0,n.variableName;const i=1===e.children.length&&e.children[0]?.type===e.type;if(e.isImplicit||i)return this._write(t,e.children[0]);const s=this._createVarName(t,e);if(r)return Me(t,`${e.type.padEnd(5)} ${s};`,e.uid),s;const o=!e.debugInfo.name&&!e.isMutable;if(o&&"float"===e.type&&"number"==typeof e.children[0])return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(o&&"int"===e.type&&"number"==typeof e.children[0]&&Number.isInteger(e.children[0]))return e.children[0].toString();const a=e.children.map((e=>this._write(t,e))).join(", ");return"array"===e.type?(Me(t,`${e.type.padEnd(5)} ${s} = [${a}];`,e.uid),s):o?`${e.type}(${a})`:(Me(t,`${e.type.padEnd(5)} ${s} = ${e.type}(${a});`,e.uid),s)}}class ze{constructor(t,e,r){this.variableName=t,this.variableInputType=e,this.node=r,this.type="shader-input",this.isUsed=!1}clone(){return new ze(this.variableName,this.variableInputType,Z(this.node))}}class ke{constructor(t,e,r){this.outVariableName=t,this.outVariableType=e,this.node=r,this.type="shader-output"}clone(){const t=new ke(this.outVariableName,this.outVariableType,Z(this.node));return t.variableName=this.variableName,t}}class Ae{static createVertex(t,e,r,n,i,s){const o=[];for(const e in t){const n=t[e],i=r.get(e);i?o.push(new ze(i,"builtin",n)):o.push(new ze("a_"+e,"attribute",n))}for(const t of n){const e=t.uniformHydrated;o.push(new ze(t.uniformName,"uniform",e))}const a=[];for(const t in e){const r=e[t];"glPosition"===t?a.push(new ke("gl_Position","builtin",r)):"glPointSize"===t?a.push(new ke("gl_PointSize","builtin",r)):a.push(new ke("v_"+t,"varying",r))}return new Ae(o,a,i,s)}static createFragment(t,e,r,n,i,s){const o=[],a=Array.from(i.rootOutputNodes());for(const e in t){const n=t[e],i=r.get(e);if(i){o.push(new ze(i,"builtin",n));continue}const s=a.find((t=>t.node===n));s&&o.push(new ze(s.outVariableName,s.outVariableType,n))}for(const t of n){const e=t.uniformHydrated;o.push(new ze(t.uniformName,"uniform",e))}const u=[];for(const t in e){const n=e[t],i=r.get(t);if("discard"===t)u.push(new ke(null,"discard",n));else{if(!i)throw new Error(`Member ${t} in shader fragment output shoule be tagged as builtin`);u.push(new ke(i,"builtin",n))}}return new Ae(o,u,s)}constructor(t,e,r,n){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const e of t)this._inputShaderTypesByNodeUid.set(e.node.uid,e);this._outputShaderTypes=e,this._transformFeedbackBindings=r,this._transformFeedbackNames=new Set(r.map((t=>"v_"+t.propertyKey))),this._usedInFragmentShader=n}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&"builtin"!==t.outVariableType&&!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();"number"!=typeof e&&"boolean"!=typeof e&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())"number"!=typeof t&&"boolean"!=typeof t&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new Ae([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const r="builtin"===e.outVariableType;this.shouldPruneOutputNode(e)||(r?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())"discard"===e.outVariableType?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const r of this.inputs())r.isUsed&&"builtin"!==r.variableInputType&&("array"===r.node.type?t[e].code.add(`${r.variableInputType.padEnd(10)} ${r.node.elementType.type.padEnd(9)} ${r.variableName}[${r.node.size}];`):t[e].code.add(`${r.variableInputType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.variableName};`))}}function Ue(t,e,r){const i=e.length;if(i!==r){const o=new s("Invalid Uniform",`Invalid length, expected ${r} but got ${i}`,{uniformName:t,values:e});n.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram").errorOnce(o)}}class Ee{constructor(t,e,r,n,i,s){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=r,this._locationInfo=n,this._uniformBindings=i,this._transformFeedbackBindings=s}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const e=new Map;for(const[t,r]of this._locations)e.set(t,r);const r=[];for(const t of this._transformFeedbackBindings??[]){const{index:e,propertyKey:n}=t;r[e]=`v_${n}`}this._program=new c(t,this.vertexShader,this.fragmentShader,e,new Map,r)}const r=this._program;t.useProgram(r);for(const n of this._uniformBindings){const{shaderModulePath:i,uniformName:s,uniformType:o,uniformArrayLength:a}=n,c=u(i,e);if(null==c){if("sampler2D"===o)continue;throw new Error(`Failed to find uniform value for ${i}`)}switch("array"===o?n.uniformArrayElementType:o){case"sampler2D":{const{unit:e,texture:n}=c;if(r.setUniform1i(s,e),"type"in n)t.bindTexture(n,e);else{const r=l(t,n.descriptor,n.data);t.bindTexture(r,e)}break}case"int":if(!a){r.setUniform1i(s,c);break}Ue(n.uniformName,c,a),r.setUniform1iv(s,c);break;case"float":if(!a){r.setUniform1f(s,c);break}Ue(n.uniformName,c,a),r.setUniform1fv(s,c);break;case"vec2":if(!a){r.setUniform2f(s,c[0],c[1]);break}Ue(n.uniformName,c,a),r.setUniform2fv(s,c.flat());break;case"vec3":if(!a){r.setUniform3f(s,c[0],c[1],c[2]);break}Ue(n.uniformName,c,a),r.setUniform3fv(s,c.flat());break;case"vec4":if(!a){r.setUniform4f(s,c[0],c[1],c[2],c[3]);break}Ue(n.uniformName,c,a),r.setUniform4fv(s,c.flat());break;case"mat3":r.setUniformMatrix3fv(s,c.flat());break;case"mat4":r.setUniformMatrix4fv(s,c.flat());break;default:throw new Error(`Unable to set uniform for type ${o}`)}}}}function Re(t){return new t}function je(t,e,r){const n=t.constructor[e]??[];t.constructor.hasOwnProperty(e)||Object.defineProperty(t.constructor,e,{value:n.slice()}),t.constructor[e].push(r)}function Ke(t,e){return(r,n)=>{je(r,"locations",{typeCtor:e,propertyKey:n,parameterIndex:null,index:t})}}const Le=t=>(e,r,n)=>{je(e,"inputs",{inputCtor:t,propertyKey:r,parameterIndex:n})},Be=t=>(e,r)=>{je(e,"uniforms",{typeCtor:t,propertyKey:r})},He=t=>(e,r)=>{je(e,"options",{typeCtor:t,propertyKey:r})},Ge=(t,e)=>{je(t,"defines",{propertyKey:e})},We=(t,e)=>(r,n)=>{r.constructor.builtins.push({builtin:t,propertyKey:n,typeCtor:e})};class qe{}qe.builtins=[],t([We("gl_VertexID",Dt)],qe.prototype,"glVertexID",void 0);class Ze{}class Xe{}Xe.builtins=[],t([We("gl_FragCoord",It)],Xe.prototype,"glFragCoord",void 0),t([We("gl_PointCoord",_t)],Xe.prototype,"glPointCoord",void 0);class Je{}t([(t,e)=>{je(t,"builtins",{builtin:"gl_FragColor",propertyKey:e})}],Je.prototype,"glFragColor",void 0);class Qe{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}}class Ye{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=this._shaderModuleClass.inputs.findLast((t=>"vertex"===t.propertyKey&&0===t.parameterIndex));if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return this._shaderModuleClass.inputs.findLast((t=>"vertex"===t.propertyKey&&1===t.parameterIndex))}get fragmentInput(){const t=this._shaderModuleClass.inputs.findLast((t=>"fragment"===t.propertyKey));if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){const t=new Map,e=new Set;for(const r of this.locations)e.has(r.index)?n.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${r.propertyKey} to ${r.index}. Index already in use`,{locationsMap:t}):(t.set(r.propertyKey,r.index),e.add(r.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map((([t,e])=>`${t}.${e}`)).join("."),r=i(e),n=this.computeAttributes;this._locationInfo={hash:r,locations:t,computeAttributeMap:n}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,r,n){try{const{vertex:i,fragment:s,uniformBindings:o}=this._generateShaders(t,e,r,n);return new Ee(i,s,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(t){return new Ee("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find((e=>e.propertyKey===t));if(e)return{type:"option",className:e.typeCtor};const r=this._uniforms.find((e=>e.propertyKey===t));if(!r)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:r.typeCtor}}getShaderKey(t,e,r,n){const i=Object.keys(t).map((e=>`${e}.${t[e]}`)).join("."),s=Object.keys(r).map((t=>`${t}.${r[t]}`)).join("."),o=Object.keys(n).map((t=>`${t}.${n[t]}`)).join("."),a=Object.keys(e).filter((t=>this.optionPropertyKeys.has(t)&&e[t])).join(".");return`${this.constructor.name}.${i}.${s}.${o}.${a}`}_generateShaders(t,e,r,n){const i=[];this._setDefines(r),this._setOptionalUniforms(i,e),this._setRequiredUniforms(i);const s=this._hydrateVertexInput(n),o=this._injectPackPrecisionFactor(s,t),a=this._hydrateComputeInput(),u=a&&this._injectComputePackPrecisionFactor(a,t),c=this.vertex(o,u),l=this._hydrateFragmentInput(c),p=this.fragment(l),d=new Set;for(const t in p)W(d,p[t]);const h=this._getVertexInputBuiltins(),y=Ae.createVertex({...s,...a},c,h,i,this.transformFeedbackBindings,d);(new De).write(y);const f=this._getFragmentInputBuiltins(p);f.set("glPointCoord","gl_PointCoord");const m=Ae.createFragment(l,p,f,i,y,this.transformFeedbackBindings);(new De).write(m);const g=this._createShaderBuilder(y,m),v=g.generate("vertex",!1),b=g.generate("fragment",!1);return this.logShader&&(console.log(v),console.log(b)),{vertex:v,fragment:b,uniformBindings:i}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const r of this._options)e[r.propertyKey]?this[r.propertyKey]=this._hydrateUniformGroup(t,r):this[r.propertyKey]=null}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const r=new(0,e.typeCtor);for(const n of r._uniforms??[]){const i=Re(n.typeCtor),s=`u_${e.propertyKey}_${n.propertyKey}`,o=i.type,a=[e.propertyKey,n.propertyKey].join(".");if("type"in n.typeCtor&&"array"===n.typeCtor.type){const e=i;t.push({shaderModulePath:a,uniformName:s,uniformType:o,uniformArrayLength:e.size,uniformArrayElementType:e.elementType.type,uniformHydrated:i})}else t.push({shaderModulePath:a,uniformName:s,uniformType:o,uniformHydrated:i});r[n.propertyKey]=i}return r}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,r=e.locations.reduce(((e,r)=>!1===t[r.propertyKey]?e:{...e,[r.propertyKey]:Re(r.typeCtor)}),{});for(const{propertyKey:t,typeCtor:n}of e.builtins){const e=Re(n);r[t]=e}return r}_hydrateComputeInput(){return null==this.computeInput?null:this.computeInput.inputCtor.locations.reduce(((t,e)=>({...t,[e.propertyKey]:Re(e.typeCtor)})),{})}_injectPackPrecisionFactor(t,e){const r={};for(const n in t){const i=t[n],s=e[n];if(s){if("float"!==i.type&&"vec2"!==i.type&&"vec3"!==i.type&&"vec4"!==i.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);r[n]=i.divide(new xt(s))}else r[n]=i}return r}_injectComputePackPrecisionFactor(t,e){const r={},n=new Map;for(const t in this.computeAttributes)for(const e of this.computeAttributes[t]??[])n.set(e,t);for(const i in t){const s=t[i],o=n.get(i);if(!o)continue;const a=e[o];if(a){if("float"!==s.type&&"vec2"!==s.type&&"vec3"!==s.type&&"vec4"!==s.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${s.type}`);r[i]=s.divide(new xt(a))}else r[i]=s}return r}_hydrateFragmentInput(t){const e={};for(const r in t)e[r]=t[r];for(const{propertyKey:t,typeCtor:r}of Xe.builtins){const n=Re(r);e[t]=n}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:r,propertyKey:n}of t.builtins)e.set(n,r);return e}_getFragmentInputBuiltins(t){const e=t.constructor,r=new Map;for(const t of e.builtins??[])r.set(t.propertyKey,t.builtin);return r}_createShaderBuilder(t,e){const r=new U;return this._insertDebugInfo(r),t.insertVertexShader(r),e.insertFragmentShader(r),r}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}}function tr(t){const e=Lt(12.9898),r=Lt(78.233),n=Lt(43758.5453);return Se(Ne(Fe(xe(t,Bt(e,r)),Lt(3.14))).multiply(n))}function er(t){return ue(t,Lt(N))}function rr(t,e){const r=Lt(2**e);return Fe(_e(t.divide(r)),Lt(2))}function nr(t,e){return pe(rr(t,e),Lt(.5))}function ir(t,e){return rr(t,e+p.length)}function sr(t){return xe(t,Ht(255/256,255/65536,255/16777216,255/4294967296))}function or(t){return Te(Te(Te(t.x,t.y),t.z),t.w)}class ar extends Qe{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=Oe(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=function(t){const e=rr(t.z,7),r=Lt(1).subtract(e),n=t.xyz.subtract(((...t)=>new St(...t))(0,0,Lt(128)));return r.multiply(t).add(e.multiply(n))}(t),r=this.size,n=Kt(e.x),i=Kt(e.y).multiply(Kt(256)),s=Kt(e.z).multiply(Kt(256)).multiply(Kt(256)),o=Lt(n.add(i).add(s)),a=Fe(o,r),u=o.subtract(a).divide(r);this._uv=new _t(a,u).add(.5).divide(r)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return Oe(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return Oe(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return Oe(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return Oe(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return Oe(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return Oe(this.gpgpu,e).setDebugName("storage4")}getFilterFlags(t){return r("webgl-ignores-sampler-precision")?Zt("ceil",this.getFilterData(t).x.multiply(Lt(255))):this.getFilterData(t).x.multiply(Lt(255))}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}}t([Be(wt)],ar.prototype,"filterFlags",void 0),t([Be(wt)],ar.prototype,"animation",void 0),t([Be(wt)],ar.prototype,"gpgpu",void 0),t([Be(wt)],ar.prototype,"visualVariableData",void 0),t([Be(wt)],ar.prototype,"dataDriven0",void 0),t([Be(wt)],ar.prototype,"dataDriven1",void 0),t([Be(wt)],ar.prototype,"dataDriven2",void 0),t([Be(xt)],ar.prototype,"size",void 0);class ur extends Qe{}t([Be(xt)],ur.prototype,"activeReasons",void 0),t([Be(xt)],ur.prototype,"highlightAll",void 0);class cr extends Qe{}t([Be(_t)],cr.prototype,"position",void 0),t([Be(xt)],cr.prototype,"distance",void 0),t([Be(xt)],cr.prototype,"smallSymbolDistance",void 0),t([Be(xt)],cr.prototype,"smallSymbolSizeThreshold",void 0);class lr extends Qe{}t([Be(Et)],lr.prototype,"displayViewScreenMat3",void 0),t([Be(Et)],lr.prototype,"displayViewMat3",void 0),t([Be(Et)],lr.prototype,"displayMat3",void 0),t([Be(Et)],lr.prototype,"viewMat3",void 0),t([Be(Et)],lr.prototype,"tileMat3",void 0),t([Be(xt)],lr.prototype,"displayZoomFactor",void 0),t([Be(xt)],lr.prototype,"requiredZoomFactor",void 0),t([Be(_t)],lr.prototype,"tileOffset",void 0),t([Be(xt)],lr.prototype,"currentScale",void 0),t([Be(xt)],lr.prototype,"currentZoom",void 0),t([Be(xt)],lr.prototype,"metersPerSRUnit",void 0),t([Be(xt)],lr.prototype,"rotation",void 0),t([Be(xt)],lr.prototype,"pixelRatio",void 0);class pr extends qe{}t([Ke(0,St)],pr.prototype,"id",void 0),t([Ke(1,xt)],pr.prototype,"bitset",void 0),t([Ke(2,_t)],pr.prototype,"pos",void 0);class dr extends Ze{}t([Ke(14,_t)],dr.prototype,"nextPos1",void 0),t([Ke(15,_t)],dr.prototype,"nextPos2",void 0);class hr extends Xe{}class yr extends Ye{clip(t,e){let r=new xt(0);const n=this.storage.getFilterFlags(t);if(r=r.add(Lt(2).multiply(Lt(1).subtract(ir(n,0)))),this.inside?r=r.add(Lt(2).multiply(Lt(1).subtract(ir(n,1)))):this.outside?r=r.add(Lt(2).multiply(ir(n,1))):this.highlight&&(r=r.add(Lt(2).multiply(Lt(1).subtract(this._checkHighlight(n))))),null!=e){const t=new xt(1).subtract(Pe(e.x,this.view.currentZoom)),n=Pe(e.y,this.view.currentZoom);r=r.add(new xt(2).multiply(t.add(n)))}return r}getFragmentOutput(t,e,r=new xt(1/255)){const n=new Je;return n.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,r)??t,n}_maybeHighlight(t,e){return this.highlight?new It(t.rgb,Pe(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let r=1;r<p.length;r++)e=e.add(this._checkHighlightBit(t,r));return Pe(new xt(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return function(t,e){return rr(t,e)}(t,e).multiply(rr(this.highlight.activeReasons,e))}maybeRunHittest(t,e,r){if(null==this.hittestRequest)return null;let n=te(pe(this.hittest(t,e,r),this.hittestRequest.distance),new xt(2),new xt(0));const i=this.storage.getAttributeDataCoords(t.id).multiply(2).subtract(1);n=n.add(this.clip(t.id,t.zoomRange));const s=new It(new xt(1/255),0,0,0);return{glPointSize:new xt(1),glPosition:new It(i,n,1),color:s}}_maybeWriteHittest(t){return null!=this.hittestRequest?t.color:null}}function fr(t,e,r){const n=r.subtract(e),i=ve((s=t.subtract(e),o=n,xe(s,Zt("normalize",o))).divide(Ie(n)),new xt(0),new xt(1));var s,o;return we(t,e.add(i.multiply(r.subtract(e))))}function mr(t){const e=fe(t);return Pe(e.x.add(e.y).add(e.z),new xt(1.05))}function gr(t,e,r,n){const i=new Et(r.x.multiply(n.y).subtract(n.x.multiply(r.y)),n.x.multiply(e.y).subtract(e.x.multiply(n.y)),e.x.multiply(r.y).subtract(r.x.multiply(e.y)),r.y.subtract(n.y),n.y.subtract(e.y),e.y.subtract(r.y),n.x.subtract(r.x),e.x.subtract(n.x),r.x.subtract(e.x)),s=e.x.multiply(r.y.subtract(n.y)),o=r.x.multiply(n.y.subtract(e.y)),a=n.x.multiply(e.y.subtract(r.y)),u=s.add(o).add(a);return new xt(1).divide(u).multiply(i.multiply(new St(1,t)))}function vr(t,e,r,n){return ue(mr(gr(t,e,r,n)),new xt(1))}function br(t,e,r,n){const i=function(t,e){return t.x.multiply(e.y).subtract(e.x.multiply(t.y))}(r.subtract(e),n.subtract(e)),s=ye(ce(i,new xt(F)),pe(i,new xt(-F)));return ee([ye((o=s,"bool"===o.type?Zt("!",o):Zt("not",o)),vr(t.xy,e,r,n)),new xt(-1)],[!0,()=>{const i=fr(t,e,r),s=fr(t,r,n),o=fr(t,n,e);return $e($e(i,s),o)}]);var o}function wr(t){return t.distance.add(1)}function xr(t,e,r){const{viewMat3:n,tileMat3:i}=t.view,s=n.multiply(i),o=s.multiply(new St(e.pos,1)),a=s.multiply(new St(r.nextPos1,1)),u=s.multiply(new St(r.nextPos2,1));return br(t.hittestRequest.position,o.xy,a.xy,u.xy)}function _r(t,e,r){return we(t,r).subtract(e)}t([Ge],yr.prototype,"inside",void 0),t([Ge],yr.prototype,"outside",void 0),t([He(ur)],yr.prototype,"highlight",void 0),t([Be(ar)],yr.prototype,"storage",void 0),t([Be(lr)],yr.prototype,"view",void 0),t([He(cr)],yr.prototype,"hittestRequest",void 0);class Sr extends Qe{getColor(t,e,r){return ee([he(er(t),r),e],[le(t,this.values.first()),this.colors.first()],[de(t,this.values.last()),this.colors.last()],[!0,()=>{const e=this.values.findIndex((e=>pe(e,t))),r=this.values.get(e),n=e.subtract(1),i=this.values.get(n),s=t.subtract(i).divide(r.subtract(i));return Ve(this.colors.get(n),this.colors.get(e),s)}])}}t([Be(bt.ofType(It,8))],Sr.prototype,"colors",void 0),t([Be(bt.ofType(xt,8))],Sr.prototype,"values",void 0);class Ir extends Qe{getOpacity(t){return ee([er(t),new xt(1)],[le(t,this.opacityValues.first()),this.opacities.first()],[de(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex((e=>pe(e,t))),r=this.opacityValues.get(e),n=e.subtract(1),i=this.opacityValues.get(n),s=t.subtract(i).divide(r.subtract(i));return Ve(this.opacities.get(n),this.opacities.get(e),s)}])}}function Tr(t){return null!=t.visualVariableSizeMinMaxValue||null!=t.visualVariableSizeScaleStops||null!=t.visualVariableSizeStops||null!=t.visualVariableSizeUnitValue}function $r(t,e,r){if(Tr(t)){const n=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(n,r)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(n,r)??t.visualVariableSizeUnitValue?.getSize(n,r)}return r}function Vr(t,e,r,n=new Nt(!1)){if(null==t.visualVariableColor)return r;const i=t.storage.getColorValue(e);return t.visualVariableColor.getColor(i,r,n)}function Fr(t,e){if(null==t.visualVariableOpacity)return new xt(1);const r=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(r)}function Nr(t,e){if(null==t.visualVariableRotation)return Et.identity();const r=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(r)}t([Be(bt.ofType(xt,8))],Ir.prototype,"opacities",void 0),t([Be(bt.ofType(xt,8))],Ir.prototype,"opacityValues",void 0);class Cr extends pr{}t([Ke(3,It)],Cr.prototype,"color",void 0),t([Ke(4,_t)],Cr.prototype,"zoomRange",void 0);class Pr extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const r=Fr(this,t.id),n=Vr(this,t.id,t.color).multiply(r),i=this.view.displayViewScreenMat3.multiply(new St(t.pos.xy,1)),s=this.clip(t.id,t.zoomRange);return{glPosition:new It(i.xy,s,1),color:n,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new xt(0))}hittest(t,e){return xr(this,t,e)}}t([He(Sr)],Pr.prototype,"visualVariableColor",void 0),t([He(Ir)],Pr.prototype,"visualVariableOpacity",void 0),t([e(0,Le(Cr)),e(1,Le(dr))],Pr.prototype,"vertex",null),t([e(0,Le(hr))],Pr.prototype,"fragment",null);class Or extends Qe{getPatternOffsetAtTileOrigin(t,e=new xt(0),r=new xt(1)){const n=new _t(16777216).divide(t);let i=t.multiply(Se(this.maxIntsToLocalOrigin.multiply(n))).add(this.tileOffsetFromLocalOrigin).subtract(new xt(.5).multiply(t));return i=new _t(i.x.multiply(r).subtract(i.y.multiply(e)),i.x.multiply(e).add(i.y.multiply(r))),Fe(i,t)}}t([Be(_t)],Or.prototype,"tileOffsetFromLocalOrigin",void 0),t([Be(_t)],Or.prototype,"maxIntsToLocalOrigin",void 0);class Mr extends Qe{}t([Be(_t)],Mr.prototype,"size",void 0),t([Be(wt)],Mr.prototype,"texture",void 0);class Dr extends Cr{}function zr(t,e){const r=t.view.requiredZoomFactor,n=new _t(e.width,e.height),i=n.multiply(e.scale).multiply(r),s=e.angle.multiply(x),o=Ne(s),a=be(s),u=function(t,e,r,n,i){const s=ue(rr(i,2),Lt(1)),o=sr(new It(t,0));return te(s,Gt(n.divide(e.x),r.divide(e.y),0,Qt(r.divide(e.x)),n.divide(e.y),0,tr(Bt(o,0)),tr(Bt(0,o)),1),Gt(n.divide(e.x),r.divide(e.y),0,Qt(r.divide(e.x)),n.divide(e.y),0,0,0,1))}(e.id,i,o,a,e.bitset),c=t.localTileOffset.getPatternOffsetAtTileOrigin(n,o,a),l=r.multiply(e.scale).multiply(e.offset.subtract(c)).divide(i),p=new St(e.pos,1),d=u.multiply(p).xy.subtract(l),h=e.tlbr.divide(t.mosaicInfo.size.xyxy);let y=rr(e.bitset,4);return null!=t.visualVariableColor&&(y=te(er(t.storage.getColorValue(e.id)),new xt(0),y)),{tileTextureCoord:d,tlbr:h,sampleAlphaOnly:y}}function kr(t,e){const r=Fe(e.tileTextureCoord,new xt(1)),n=Ve(e.tlbr.xy,e.tlbr.zw,r);let i=Oe(t.mosaicInfo.texture,n);return i=te(pe(e.sampleAlphaOnly,new xt(.5)),i.aaaa,i),e.color.multiply(i)}t([Ke(5,It)],Dr.prototype,"tlbr",void 0),t([Ke(6,xt)],Dr.prototype,"width",void 0),t([Ke(7,xt)],Dr.prototype,"height",void 0),t([Ke(8,_t)],Dr.prototype,"offset",void 0),t([Ke(9,_t)],Dr.prototype,"scale",void 0),t([Ke(10,xt)],Dr.prototype,"angle",void 0);class Ar extends Pr{vertex(t,e){return{...super.vertex(t,e),...zr(this,t)}}fragment(t){const e=kr(this,t);return this.getFragmentOutput(e,t,new xt(0))}}t([Be(Mr)],Ar.prototype,"mosaicInfo",void 0),t([Be(Or)],Ar.prototype,"localTileOffset",void 0),t([e(0,Le(Dr)),e(1,Le(dr))],Ar.prototype,"vertex",null),t([e(0,Le(class extends hr{}))],Ar.prototype,"fragment",null);class Ur extends Qe{getSize(t,e){const r=this.minMaxValueAndSize.xy,n=this.minMaxValueAndSize.zw;return te(er(t),e,(()=>{const e=ve(t.subtract(r.x).divide(r.y.subtract(r.x)),new xt(0),new xt(1));return n.x.add(e.multiply(n.y.subtract(n.x)))}))}}t([Be(It)],Ur.prototype,"minMaxValueAndSize",void 0);class Er extends Qe{getSizeForViewScale(t){return ee([le(t,this.values.first()),this.sizes.first()],[de(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>pe(e,t))),r=this.values.get(e),n=e.subtract(1),i=this.values.get(n),s=t.subtract(i).divide(r.subtract(i));return Ve(this.sizes.get(n),this.sizes.get(e),s)}])}}t([Be(bt.ofType(xt,8))],Er.prototype,"sizes",void 0),t([Be(bt.ofType(xt,8))],Er.prototype,"values",void 0);class Rr extends Qe{getSize(t,e){const r=ee([er(t),e],[le(t,this.values.first()),this.sizes.first()],[de(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>pe(e,t))),r=this.values.get(e),n=e.subtract(1),i=this.values.get(n),s=t.subtract(i).divide(r.subtract(i));return Ve(this.sizes.get(n),this.sizes.get(e),s)}]);return te(er(r),e,r)}}t([Be(bt.ofType(xt,8))],Rr.prototype,"sizes",void 0),t([Be(bt.ofType(xt,8))],Rr.prototype,"values",void 0);class jr extends Qe{getSize(t,e){return te(er(t),e,t.multiply(this.unitValueToPixelsRatio))}}t([Be(xt)],jr.prototype,"unitValueToPixelsRatio",void 0);class Kr extends pr{}t([Ke(3,It)],Kr.prototype,"color",void 0),t([Ke(4,_t)],Kr.prototype,"offset",void 0),t([Ke(5,_t)],Kr.prototype,"normal",void 0),t([Ke(6,xt)],Kr.prototype,"halfWidth",void 0),t([Ke(7,xt)],Kr.prototype,"referenceHalfWidth",void 0),t([Ke(8,_t)],Kr.prototype,"zoomRange",void 0);class Lr extends hr{}class Br extends Qe{}function Hr(t){return Te(new xt(S).multiply(Pe(t,new xt(I))),new xt(1))}function Gr(t,e){const{halfWidth:r,normal:n}=t,i=Hr(r),s=Ie(n).multiply(r);return ve(i.multiply(r.subtract(s)).divide(e.add(i).subtract(new xt(1))),new xt(0),new xt(1))}function Wr(t,e){const{id:r,offset:n,pos:i,normal:s,zoomRange:o}=e,{displayViewScreenMat3:a,displayViewMat3:u}=t.view,c=Vr(t,r,e.color),l=Fr(t,r),p=function(t,e){const{id:r,halfWidth:n,referenceHalfWidth:i}=e;if(Tr(t)){const e=$r(t,r,new xt(2).multiply(i));return new xt(.5).multiply(n.divide(Te(i,new xt(V)))).multiply(e)}return n}(t,e),d=new xt(.5).multiply(t.antialiasingControls.antialiasing),h=Te(p.add(d),new xt(.45)).add(new xt(.1).multiply(d)),y=Hr(h).multiply(h).multiply(n),f=u.multiply(new St(y,new xt(0))),m=a.multiply(new St(i,new xt(1))).add(f),g=new xt(2).multiply(Pe(p,new xt(0))).add(t.clip(r,o)),v=new It(m.xy,g,1);return{color:c,opacity:l,halfWidth:h,normal:s,scaledOffset:y,scaledHalfWidth:p,glPosition:new It(v.xy,g,1)}}function qr(t,e){const{opacity:r,color:n}=t,i=Gr(t,e);return r.multiply(n).multiply(i)}t([Be(xt)],Br.prototype,"antialiasing",void 0),t([Be(xt)],Br.prototype,"blur",void 0);class Zr extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const r=Wr(this,t);return{...r,...this.maybeRunHittest(t,e,r.halfWidth)}}fragment(t){const e=qr(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,r){const{viewMat3:n,tileMat3:i}=this.view,s=n.multiply(i),o=s.multiply(new St(t.pos,1)),a=s.multiply(new St(e.nextPos1,1)),u=s.multiply(new St(e.nextPos2,1)),{distance:c,smallSymbolDistance:l,smallSymbolSizeThreshold:p}=this.hittestRequest,d=Pe(r,p.multiply(.5)).multiply(c.subtract(l)),h=this.hittestRequest.position;return $e(fr(h,o.xy,a.xy),fr(h,o.xy,u.xy)).subtract(r).add(d)}}t([Be(Br)],Zr.prototype,"antialiasingControls",void 0),t([He(Sr)],Zr.prototype,"visualVariableColor",void 0),t([He(Ir)],Zr.prototype,"visualVariableOpacity",void 0),t([He(Ur)],Zr.prototype,"visualVariableSizeMinMaxValue",void 0),t([He(Er)],Zr.prototype,"visualVariableSizeScaleStops",void 0),t([He(Rr)],Zr.prototype,"visualVariableSizeStops",void 0),t([He(jr)],Zr.prototype,"visualVariableSizeUnitValue",void 0),t([e(0,Le(Kr)),e(1,Le(dr))],Zr.prototype,"vertex",null),t([e(0,Le(Lr))],Zr.prototype,"fragment",null);class Xr extends pr{}t([Ke(3,_t)],Xr.prototype,"offset",void 0),t([Ke(4,It)],Xr.prototype,"color",void 0),t([Ke(5,_t)],Xr.prototype,"normal",void 0),t([Ke(6,xt)],Xr.prototype,"halfWidth",void 0),t([Ke(7,xt)],Xr.prototype,"referenceHalfWidth",void 0),t([Ke(8,_t)],Xr.prototype,"zoomRange",void 0);class Jr extends Lr{}function Qr(t,e,r){const{id:n,bitset:i}=e,s=rr(i,0),o=pe(s,new xt(.5)),a=Wr(t,e),u=te(o,a.halfWidth,new xt(0)),c=Fr(t,n),l=Vr(t,n,e.color),p=te(o,e.color,l.multiply(c)),d=t.view.displayViewScreenMat3.multiply(new St(e.pos.xy,1)),h=t.clip(e.id),y=new It(d.xy,h,1),f=te(o,a.glPosition,y),m=r&&t.maybeRunHittest(e,r,o);return{isOutline:s,color:p,opacity:new xt(1),halfWidth:u,normal:a.normal,glPosition:f,...m}}class Yr extends yr{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}t([Be(Br)],Yr.prototype,"antialiasingControls",void 0),t([He(Sr)],Yr.prototype,"visualVariableColor",void 0),t([He(Ir)],Yr.prototype,"visualVariableOpacity",void 0),t([He(Ur)],Yr.prototype,"visualVariableSizeMinMaxValue",void 0),t([He(Er)],Yr.prototype,"visualVariableSizeScaleStops",void 0),t([He(Rr)],Yr.prototype,"visualVariableSizeStops",void 0),t([He(jr)],Yr.prototype,"visualVariableSizeUnitValue",void 0);class tn extends Yr{vertex(t,e){return Qr(this,t,e)}fragment(t){const{color:e,isOutline:r}=t,n=pe(r,new xt(.5)),i=te(n,qr(t,this.antialiasingControls.blur),e),s=te(n,new xt(1/255),new xt(0));return this.getFragmentOutput(i,t,s)}hittest(t,e,r){return te(r,wr(this.hittestRequest),xr(this,t,e))}}t([e(0,Le(Xr)),e(1,Le(dr))],tn.prototype,"vertex",null),t([e(0,Le(Jr))],tn.prototype,"fragment",null);class en extends Cr{}function rn(t,e){const r=e.tlbr.xy,n=e.tlbr.zw,i=n.x.subtract(r.x),s=r.y.subtract(n.y),o=new _t(i,s).multiply(e.inverseRasterizationScale),a=o.multiply(t.view.requiredZoomFactor),u=function(t){const e=new xt(1),r=new xt(0);return new Et(e.divide(t.x),r.divide(t.y),0,Qt(r.divide(t.x)),e.divide(t.y),0,0,0,1)}(a),c=t.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new St(e.pos,1);return{tileTextureCoord:u.multiply(l).xy.subtract(c),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function nn(t,e){const r=Fe(t.tileTextureCoord,new xt(1)),n=Ve(t.tlbr.xy,t.tlbr.zw,r),i=Oe(e.texture,n);return t.color.multiply(i)}t([Ke(5,It)],en.prototype,"tlbr",void 0),t([Ke(6,xt)],en.prototype,"inverseRasterizationScale",void 0);class sn extends Pr{vertex(t,e){return{...super.vertex(t,e),...rn(this,t)}}fragment(t){const e=nn(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new xt(0))}}t([Be(Mr)],sn.prototype,"mosaicInfo",void 0),t([Be(Or)],sn.prototype,"localTileOffset",void 0),t([e(0,Le(en)),e(1,Le(dr))],sn.prototype,"vertex",null),t([e(0,Le(class extends hr{}))],sn.prototype,"fragment",null);class on extends Xr{}t([Ke(9,It)],on.prototype,"tlbr",void 0),t([Ke(10,xt)],on.prototype,"inverseRasterizationScale",void 0);class an extends Jr{}class un extends tn{vertex(t,e){return{...Qr(this,t,e),...rn(this,t)}}fragment(t){const{isOutline:e}=t,r=pe(e,new xt(.5)),n=te(r,qr(t,this.antialiasingControls.blur),nn(t,this.mosaicInfo)),i=te(r,new xt(1/255),new xt(0));return this.getFragmentOutput(n,t,i)}}t([Be(Mr)],un.prototype,"mosaicInfo",void 0),t([Be(Or)],un.prototype,"localTileOffset",void 0),t([e(0,Le(on)),e(1,Le(dr))],un.prototype,"vertex",null),t([e(0,Le(an))],un.prototype,"fragment",null);const cn=16,ln=1/16,pn=128;class dn extends pr{}t([Ke(3,It)],dn.prototype,"color",void 0),t([Ke(4,It)],dn.prototype,"tlbr",void 0),t([Ke(5,xt)],dn.prototype,"angle",void 0),t([Ke(6,xt)],dn.prototype,"aux1",void 0),t([Ke(7,xt)],dn.prototype,"aux2",void 0),t([Ke(8,_t)],dn.prototype,"aux3",void 0),t([Ke(9,_t)],dn.prototype,"aux4",void 0),t([Ke(10,_t)],dn.prototype,"zoomRange",void 0);class hn extends Yr{vertex(t,e){const{aux1:r,aux2:n,aux3:i,aux4:s}=t,o={...t,width:r,height:n,offset:i,scale:s.multiply(ln)},a=Qr(this,{...t,halfWidth:r,referenceHalfWidth:n,offset:i,normal:s.subtract(128).multiply(ln)}),u=zr(this,o),c=pe(a.isOutline,new xt(.5));return{...a,...u,...this.maybeRunHittest(t,e,c)}}fragment(t){const{isOutline:e}=t,r=pe(e,new xt(.5)),n=te(r,qr(t,this.antialiasingControls.blur),kr(this,t)),i=te(r,new xt(1/255),new xt(0));return this.getFragmentOutput(n,t,i)}hittest(t,e,r){return te(r,wr(this.hittestRequest),xr(this,t,e))}}t([Be(Mr)],hn.prototype,"mosaicInfo",void 0),t([Be(Or)],hn.prototype,"localTileOffset",void 0),t([e(0,Le(dn)),e(1,Le(dr))],hn.prototype,"vertex",null),t([e(0,Le(class extends an{}))],hn.prototype,"fragment",null);const yn=8388607,fn=t=>t&yn;function mn(t,e){return((e?8388608:0)|t)>>>0}const gn={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4}};let vn=class extends d{constructor(t){super(t),this.debugName="",this._updatingHandles=new g,this._idToUpdatingState=new h}get updating(){const t=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((t=>t));if(r("esri-2d-log-updating")){const e=Array.from(this._idToUpdatingState.entries()).map((([t,e])=>`-> ${t}: ${e}`)).join("\n");console.log(`${this.debugName}: Updating: ${t}\n-> Handles: ${this._updatingHandles.updating}\n${e}`)}return t}addUpdateTracking(t,e){const r=y((()=>e.updating),(e=>this._idToUpdatingState.set(t,e)),{sync:!0});this.addHandles(r)}addPromise(t){return this._updatingHandles.addPromise(t)}};t([f({constructOnly:!0})],vn.prototype,"debugName",void 0),t([f({readOnly:!0})],vn.prototype,"updating",null),vn=t([m("esri.views.2d.layers.support.UpdateTracking2D")],vn);export{er as $,_t as A,lr as B,hr as C,bt as D,Ge as E,xt as F,Ye as G,pr as H,yr as I,Rt as J,xe as K,or as L,gn as M,wr as N,Pr as O,Ar as P,hn as Q,tn as R,wt as S,v as T,vn as U,qe as V,sn as W,un as X,_r as Y,Xe as Z,te as _,C as a,ue as a0,b as a1,w as a2,Ne as a3,be as a4,He as a5,Ze as a6,fe as a7,$e as a8,_e as a9,Gr as aA,dr as aB,nr as aC,Fr as aD,Vr as aE,x as aF,ce as aG,_ as aH,we as aI,gr as aJ,Qt as aK,mr as aL,Ee as aM,rr as aa,T as ab,$r as ac,Nr as ad,he as ae,pe as af,Nt as ag,$ as ah,br as ai,Dt as aj,oe as ak,ae as al,Sr as am,Ir as an,Ur as ao,Er as ap,Rr as aq,jr as ar,Mr as as,Zr as at,Kr as au,Se as av,Ve as aw,sr as ax,ve as ay,Wr as az,O as b,mn as c,yn as d,P as e,z as f,fn as g,k as h,M as i,D as j,Qe as k,Ke as l,Et as m,N as n,St as o,cn as p,Te as q,Pe as r,pn as s,Oe as t,Be as u,It as v,Ie as w,Ce as x,Le as y,Je as z};

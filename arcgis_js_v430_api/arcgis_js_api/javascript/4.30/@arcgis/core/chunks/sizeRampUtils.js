/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import o from"../Color.js";import{isSymbol3D as s}from"../symbols.js";import{r as t,n as e,p as r}from"./numberUtils.js";import{u as i}from"./referenceSizeUtils.js";import{applyCIMSymbolColor as l}from"../symbols/support/cimSymbolUtils.js";import{i as m,g as p}from"./utils11.js";import{getReferenceSizeAuthoringInfoVisualVariable as a,getSymbolForFlowRenderer as n,createStopLabel as y}from"./utils14.js";import"./widgetUtils.js";import{i as j}from"./themeUtils.js";import c from"../symbols/SimpleMarkerSymbol.js";import u from"../symbols/SimpleLineSymbol.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../core/Error.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./assets.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/visualVariables/support/SizeStop.js";import"./enums2.js";import"./utils7.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./LRUCache.js";import"./MemCache.js";import"./timeUtils.js";import"./utils2.js";import"./basemapUtils.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"./layerUtils2.js";const b=30,f=12,S=24,g=[255,255,255],d=[200,200,200],h=[128,128,128],U=20,D=5;async function w(o,e,r,i,l,j,b){const f=e.legendOptions,g=f?.customValues,d=b||await async function(o,t){if("flow"===o.type)return n(o,t);if("pie-chart"===o.type)return new c({color:null,outline:o.outline?.width?o.outline:new u});let e=null,r=null;if("simple"===o.type)e=o.symbol;else if("class-breaks"===o.type){const s=o.classBreakInfos;e=s&&s[0]&&s[0].symbol,r=s.length>1}else if("unique-value"===o.type){const s=o.uniqueValueInfos;e=s?.[0]?.symbol,r=null!=s&&s.length>1}return!e||function(o){return!!o&&(s(o)?!!o.symbolLayers&&o.symbolLayers.some((o=>o&&"fill"===o.type)):o.type.includes("fill"))}(e)?null:(e=e.clone(),(t||r)&&(e.type.includes("3d")?v(e):z(e)),e)}(o,r),h=e.stops,U=!!d,D=!!g,w=null!=e.minSize&&null!=e.maxSize,M=h&&h.length>1,C=!!e.target;if(!U||!D&&!(w||M&&!C))return;const V=m(d);let I=!1,E=null,B=null;E=V&&!M?t([e.minDataValue,e.maxDataValue]):g??await async function(o,s,e,r){const i=(await import("./visualVariableUtils.js")).getSizeRangeAtScale(o,e,r),l=i&&P(i);if(!i||!l)return;let m=l.map((s=>function(o,s,t){const e=t.minSize,r=t.maxSize,i=s.minDataValue,l=s.maxDataValue;let m;return m=o<=e?i:o>=r?l:(o-e)/(r-e)*(l-i)+i,m}(s,o,i)));m=t(m);for(let t=1;t<m.length-1;t++){const i=await k(o,s,m[t],m[t-1],e,r);i&&(m[t]=i[0],l[t]=i[1])}return m}(e,d,i,l?.type);const R=o?.authoringInfo,O="univariate-color-size"===R?.type,T=O&&"above-and-below"===R?.univariateTheme,q=!!a(o);if(!E&&M&&(E=h.map((o=>o.value)),I=h.some((o=>!!o.label)),"flow"===o.type&&(E=t(E)),I&&(B=h.map((o=>o.label)))),V&&null!=E&&E?.length>2&&!T&&(E=[E[0],E[E.length-1]]),!E)return null;O&&5!==E?.length&&(E=P({minSize:E[0],maxSize:E[E.length-1]}));const F=V?function(o,s){const t=o?.authoringInfo,e="univariate-color-size"===t?.type;let r=[12,30];if(e){const o=s[0],t=s[s.length-1],e=12,i=30;r=s.map((s=>e+(s-o)/(t-o)*(i-e)))}return e&&"below"===t?.univariateTheme&&r.reverse(),r}(o,E):null,A=p(d),H=I?null:function(o,s){const t=o.length-1;return o.map(((o,e)=>y(o,e,t,s)))}(E,j),G=await Promise.all(E.map((async(t,p)=>{const a=V?F[p]:await x(e,d,t,i,l?.type),n=!q||"class-breaks"!==o.type&&"unique-value"!==o.type?function(o,t){const e=o.clone();if(s(e))m(e)||e.symbolLayers.forEach((o=>{"fill"!==o.type&&(o.size=t)}));else if("esri.symbols.SimpleMarkerSymbol"===e.declaredClass)e.size=t;else if("esri.symbols.PictureMarkerSymbol"===e.declaredClass){const o=e.width,s=e.height;e.height=t,e.width=t*(o/s)}else"esri.symbols.SimpleLineSymbol"!==e.declaredClass?function(o){return"esri.symbols.TextSymbol"===o.declaredClass}(e)&&e.font&&(e.font.size=t):e.width=t;return e}(T&&"class-breaks"===o.type?function(o,s){const t=o.classBreakInfos,e=t.length,r=e<2||!(s>=2)?t[0].symbol.clone():t[e-1].symbol.clone();return o.visualVariables.some((o=>"color"===o.type))&&(r.type.includes("3d")?v(r):z(r)),r}(o,p):d,a):L(o,a,e.maxSize,r)??d;return{value:t,symbol:n,label:I?B[p]:H[p],size:q?S:a,outlineSize:A}})));return G.reverse()}function L(s,t,e,r){const l="class-breaks"===s.type,m=l?s.classBreakInfos?.[0]?.symbol?.clone():s.uniqueValueInfos?.[0]?.symbol?.clone();return m&&"type"in m&&"cim"===m.type?(i(m,{color:r??(l?null:new o(d)),innerDotSize:t*(S/e)||1,outerRingSize:S}),m):null}function v(o){"line-3d"===o.type?o.symbolLayers.forEach((o=>{o.material={color:h}})):o.symbolLayers.forEach((o=>{"icon"!==o.type||o.resource?.href?o.material={color:d}:(o.material={color:g},o.outline={color:h,size:1.5})}))}function z(s){const t=j();if("cim"===s.type)l(s,new o(d));else if(s.type.includes("line"))s.color=h;else if(s.color=t?h:g,"simple-marker"===s.type)if(s.outline){const o=s.outline?.color?.toHex();"#ffffff"===o&&(s.outline.color=h)}else s.outline={color:h,width:1.5}}function P(o){const s=o.minSize,t=o.maxSize,e=D,r=(t-s)/(e-1),i=[];for(let o=0;o<e;o++)i.push(s+r*o);return i}async function k(o,s,i,l,m,p){const a=await x(o,s,i,m,p),n=await x(o,s,l,m,p),y=e(i),j=y.fractional,c=U;let u=y.integer,b=null,f=null;i>0&&i<1&&(b=10**j,u=e(i*=b).integer);for(let e=u-1;e>=0;e--){const l=10**e;let y=Math.floor(i/l)*l,j=Math.ceil(i/l)*l;null!=b&&(y/=b,j/=b);let u=(y+j)/2;[,u]=t([y,u,j],{indexes:[1]});const S=await x(o,s,y,m,p),g=await x(o,s,j,m,p),d=await x(o,s,u,m,p),h=r(a,S,n,null),U=r(a,g,n,null),D=r(a,d,n,null);let w=h.previous<=c,L=U.previous<=c;if(w&&L&&(h.previous<=U.previous?(w=!0,L=!1):(L=!0,w=!1)),w?f=[y,S]:L?f=[j,g]:D.previous<=c&&(f=[u,d]),f)break}return f}async function x(o,s,t,e,r){const{getSize:i}=await import("./visualVariableUtils.js");return i(o,t,{scale:e,view:r,shape:"simple-marker"===s.type?s.style:null})}export{w as getRampStops,L as getReferenceSizeSymbol,b as realWorldMaxSize,f as realWorldMinSize};

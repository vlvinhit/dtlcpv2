/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{C as e}from"./CIMSymbolHelper.js";import{F as t}from"./utils7.js";import{i,T as s,U as a,E as o,w as r,V as n}from"./definitions.js";import{W as l,c as u,g as c,i as p,h as d,j as f,k as h,l as m,m as y,n as v,V as b}from"./Container.js";import{l as g,u as x,V as w,k as S,G as V,m as z,o as _,t as M,q as P,F as T,r as A,v as C,w as I,x as R,y as F,z as O,A as D,S as E,B as L,C as B,D as k,E as U,H as N,I as H,J as j,K as G,L as q,N as $,T as W,O as Z,P as K,Q as X,R as Y,W as Q,X as J,Y as ee,Z as te,_ as ie,$ as se,a0 as ae,a1 as oe,a2 as re,a3 as ne,a4 as le,a5 as ue,a6 as ce,a7 as pe,a8 as de,a9 as fe,aa as he,ab as me,ac as ye,ad as ve,ae as be,af as ge,ag as xe,ah as we,ai as Se,aj as Ve,ak as ze,al as _e,f as Me,h as Pe,am as Te,an as Ae,ao as Ce,ap as Ie,aq as Re,ar as Fe,as as Oe,at as De,au as Ee,av as Le,aw as Be,ax as ke,ay as Ue,az as Ne,aA as He,i as je,j as Ge,a as qe,aB as $e,aC as We,aD as Ze,aE as Ke,aF as Xe,aG as Ye,aH as Qe,aI as Je,aJ as et,aK as tt,aL as it,M as st,aM as at,U as ot}from"./UpdateTracking2D.js";import{_ as rt,b as nt}from"./tslib.es6.js";import{R as lt,i as ut}from"../core/lang.js";import{D as ct,U as pt,c as dt,T as ft,n as ht,P as mt,b as yt,i as vt,j as bt,k as gt}from"./enums.js";import{B as xt}from"./BufferObject.js";import{V as wt}from"./VertexArrayObject.js";import{V as St}from"./VertexElementDescriptor.js";import{v as Vt}from"./dataViewUtils.js";import{R as zt,a as _t,F as Mt}from"./Program.js";import{a as Pt,T as Tt}from"./Texture.js";import{L as At,n as Ct}from"./Logger.js";import{f as It}from"./maybe.js";import{l as Rt}from"./heatmapTextureUtils.js";import{d as Ft}from"./constants.js";import{r as Ot}from"./WGLContainer.js";import{t as Dt,a as Et}from"./screenUtils.js";import{g as Lt}from"./unitUtils.js";import{m as Bt}from"./lengthUtils.js";import kt from"../core/Error.js";import{g as Ut}from"./capabilities2.js";import{ignoreAbortErrors as Nt}from"../core/promiseUtils.js";import{Q as Ht}from"./QueueProcessor.js";class jt{constructor(){this.drawPhase=l.MAP|l.HITTEST|l.HIGHLIGHT|l.DEBUG}startup(){}shutdown(e){}}class Gt extends jt{constructor(){super(...arguments),this.overrideStencilRef=null,this.symbologyPlane=u.FILL,this.postProcessingEnabled=!1}postProcess(e,t){}}class qt extends w{}rt([g(0,D)],qt.prototype,"pos",void 0);class $t extends S{}rt([x(T)],$t.prototype,"dotSize",void 0);class Wt extends S{}rt([x(E)],Wt.prototype,"locations",void 0),rt([x(T)],Wt.prototype,"pixelRatio",void 0),rt([x(T)],Wt.prototype,"tileZoomFactor",void 0);class Zt extends V{vertex(e){const t=new z(1,0,0,0,-1,0,0,1,1).multiply(new _(e.pos.xy.divide(i),1)),s=M(this.draw.locations,t.xy),a=P(this.instance.dotSize.divide(2),new T(1));let o=new T(0);o=o.add(A(s.a,new T(1e-6)).multiply(2));let r=a.add(this.instance.dotSize);const n=this.view.displayViewScreenMat3.multiply(new _(e.pos.add(.5),1)),l=new C(n.xy,o,1),u=this.instance.dotSize.divide(r),c=new T(-1).divide(a.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:l,glPointSize:r,color:s,ratio:u,invEdgeRatio:c}}fragment(e){const t=I(e.glPointCoord.subtract(.5)).multiply(2),i=R(new T(0),new T(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new O;return s.glFragColor=e.color.multiply(i),s}}rt([x($t)],Zt.prototype,"instance",void 0),rt([x(Wt)],Zt.prototype,"draw",void 0),rt([x(L)],Zt.prototype,"view",void 0),rt([nt(0,F(qt))],Zt.prototype,"vertex",null),rt([nt(0,F(class extends B{}))],Zt.prototype,"fragment",null);class Kt extends N{}rt([g(3,T)],Kt.prototype,"inverseArea",void 0);class Xt extends S{}rt([x(k.ofType(C,2))],Xt.prototype,"isActive",void 0),rt([x(k.ofType(C,8))],Xt.prototype,"colors",void 0),rt([x(T)],Xt.prototype,"dotValue",void 0);class Yt extends S{}rt([x(E)],Yt.prototype,"dotTexture0",void 0),rt([x(E)],Yt.prototype,"dotTexture1",void 0),rt([x(T)],Yt.prototype,"tileZoomFactor",void 0),rt([x(T)],Yt.prototype,"pixelRatio",void 0),rt([x(T)],Yt.prototype,"tileDotsOverArea",void 0);class Qt extends H{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new z(2/i,0,0,0,-2/i,0,-1,1,1).multiply(new _(e.pos,1)),s=this.clip(e.id),a=new C(t.xy,s,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),r=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),n=this.draw.tileZoomFactor.multiply(i).divide(this.draw.pixelRatio),l=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),u=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),c=e.pos.add(.5).divide(n);return{glPosition:a,color:new C(0,0,0,0),textureCoords:c,thresholds0:l,thresholds1:u}}fragment(e){const t=new O,i=M(this.draw.dotTexture0,e.textureCoords),s=M(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(s);let r;const n=j.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),l=j.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=A(new T(0),a),t=A(new T(0),o),i=G(e,a).add(G(t,o)),s=A(i,new T(0)),u=new T(1).subtract(s),c=i.add(s),p=a.multiply(e).divide(c),d=o.multiply(t).divide(c),f=n.multiply(p).add(l.multiply(d));r=u.multiply(f)}else{const e=P(q(a),q(o)),t=A(e,new T(0)),i=new T(1).subtract(t),s=A(e,a),u=A(e,o),c=n.multiply(s).add(l.multiply(u));r=i.multiply(c)}return t.glFragColor=r,t}hittest(e){return $(this.hittestRequest)}}rt([U],Qt.prototype,"blending",void 0),rt([x(Xt)],Qt.prototype,"instance",void 0),rt([x(Yt)],Qt.prototype,"draw",void 0),rt([nt(0,F(Kt))],Qt.prototype,"vertex",null),rt([nt(0,F(B))],Qt.prototype,"fragment",null);const Jt={[ct.BYTE]:1,[ct.UNSIGNED_BYTE]:1,[ct.SHORT]:2,[ct.UNSIGNED_SHORT]:2,[ct.HALF_FLOAT]:2,[ct.INT]:4,[ct.UNSIGNED_INT]:4,[ct.FLOAT]:4};class ei{constructor(e,t){this._boundPart=null;const i=[];for(const s of t.vertex){const t=xt.createVertex(e,pt.STATIC_DRAW,s);i.push(t)}const s=[];for(const i of t.index||[]){const t=xt.createIndex(e,pt.STATIC_DRAW,i);s.push(t)}this.groups=[];for(const a of t.groups){let o;if(null!=a.index){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:e}=t.index[a.index];2===e?o=ct.UNSIGNED_SHORT:4===e&&(o=ct.UNSIGNED_INT)}const r=null!=a.index?s[a.index]:null,n=new Map,l={},u={};for(const e of a.attributes){const{name:t,count:s,type:a,offset:o,normalized:r,divisor:c,stride:p,vertex:d,location:f}=e,h=`vertex-buffer-${d}`;let m=l[h];m||(m=l[h]=[]);const y=new St(t,s,a,o,p,r,c);m.push(y),n.set(t,f),u[h]=i[d]}const c=new wt(e,n,l,u,r);this.groups.push({...a,vertexArray:c,locations:n,layout:l,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:i}=this.parts[this._boundPart],{vertexArray:s}=this.groups[i];e.bindVAO(s)}draw(e){if(null==this._boundPart)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:s}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[s];a?e.drawElements(o,i,a,t*Jt[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}}class ti extends ei{static create(e,t){const i=[];let{stride:s,hash:a}=t.layout;if(null==s){s=0;for(const{count:e,type:i,offset:a}of t.layout.attributes){if(null!=a)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");s+=e*Jt[i]}}let o=0,r=0;for(const{count:e,name:a,offset:n,type:l,normalized:u}of t.layout.attributes){null!=n&&(r=n);const t={name:a,location:o,vertex:0,count:e,type:l,offset:r,stride:s,divisor:0,normalized:null!=u&&u};i.push(t),o++,r+=e*Jt[l]}const n={attributes:i,primitive:t.primitive};null!=t.index&&(n.index=0);let{count:l}=t;if(null==l&&(l=t.index?t.index.length:t.vertex.byteLength/s,Math.floor(l)!==l))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${s}.`);const u={start:0,count:l,group:0,primitive:t.primitive},c={vertex:[t.vertex],parts:[u],groups:[n]};return null!=t.index&&(c.index=[t.index]),null==a&&(a=Vt(i)),new ti(e,c,{hash:a,attributes:i,stride:s})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}}class ii{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=i,s=i,a=new Pt(t,s);a.samplingMode=dt.NEAREST,a.wrapMode=ft.CLAMP_TO_EDGE;const o=new zt(e,new _t(ht.DEPTH_STENCIL,t,s));this._dotFBO=new Mt(e,a,o)}return this._dotFBO}getDotDensityMesh(e){if(null==this._dotMesh){const t=i,s=t*t,a=2,o=new Int16Array(s*a);for(let e=0;e<t;e++)for(let i=0;i<t;i++)o[a*(i+e*t)]=i,o[a*(i+e*t)+1]=e;const r=[{count:2,type:ct.UNSIGNED_SHORT,name:"a_position",offset:0}],n={hash:Vt(r),attributes:r,stride:4};this._dotMesh=ti.create(e,{primitive:mt.POINTS,vertex:o,count:s,layout:n})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const s=new lt(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let e=0;e<s.length;e++)s[e]=i.getFloat();const a=new Pt;return a.dataType=yt.FLOAT,a.samplingMode=dt.NEAREST,a.width=t,a.height=t,new Tt(e,a,s)}}function si(e){const t=1/e;return{antialiasing:t,blur:0+t}}class ai{destroy(){this._accumulateFramebuffer=It(this._accumulateFramebuffer),this._resolveGradientTexture=It(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=Rt(e,At.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"));this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==yt.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(null==this._accumulateFramebuffer){const{dataType:s,samplingMode:a,pixelFormat:o,internalFormat:r}=this.loadQualityProfile(e),n=new Pt(t,i);n.pixelFormat=o,n.internalFormat=r,n.dataType=s,n.samplingMode=a,n.wrapMode=ft.CLAMP_TO_EDGE;const l=new _t(ht.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Mt(e,n,l)}else{const{width:e,height:s}=this._accumulateFramebuffer;e===t&&s===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(null==this._resolveGradientTexture){const t=new Pt;t.wrapMode=ft.CLAMP_TO_EDGE,this._resolveGradientTexture=new Tt(e,t)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}}function oi(e){return e?.25:1}class ri extends N{}rt([g(5,D)],ri.prototype,"offset",void 0);class ni extends S{}rt([x(T)],ni.prototype,"radius",void 0),rt([x(T)],ni.prototype,"isFieldActive",void 0);class li extends H{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new T(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new _(e.pos,1)).add(this.view.displayViewMat3.multiply(new _(s,0)).multiply(t)),r=this.clip(e.id);return{glPosition:new C(o.xy,r,1),offset:s,fieldValue:a,color:new C(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=I(t),a=A(s,new T(1)),o=new T(1).subtract(s.multiply(s)),r=o.multiply(o),n=a.multiply(r).multiply(i).multiply(new T(oi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new C(n),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,s=t.multiply(i).multiply(new _(e.pos,1));return ee(s.xy,this.kernelControls.radius,this.hittestRequest.position)}}rt([U],li.prototype,"usesHalfFloatPrecision",void 0),rt([x(ni)],li.prototype,"kernelControls",void 0),rt([nt(0,F(ri))],li.prototype,"vertex",null),rt([nt(0,F(class extends B{}))],li.prototype,"fragment",null);class ui extends w{}rt([g(0,D)],ui.prototype,"pos",void 0);class ci extends S{}rt([x(E)],ci.prototype,"texture",void 0),rt([x(D)],ci.prototype,"minAndInvRange",void 0),rt([x(T)],ci.prototype,"normalization",void 0);class pi extends S{}rt([x(E)],pi.prototype,"texture",void 0);class di extends V{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new C(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=M(t.texture,e.uv).r.multiply(new T(oi(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const a=M(i.texture,new D(s,.5)),o=new O;return o.glFragColor=new C(a.rgb.multiply(a.a),a.a),o}}function fi(e){return e.key.level+1}rt([U],di.prototype,"usesHalfFloatPrecision",void 0),rt([x(ci)],di.prototype,"accumulatedDensity",void 0),rt([x(pi)],di.prototype,"gradient",void 0),rt([nt(0,F(ui))],di.prototype,"vertex",null),rt([nt(0,F(class extends te{}))],di.prototype,"fragment",null);const hi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:fi,compare:bt.GEQUAL,mask:255,op:{fail:gt.KEEP,zFail:gt.KEEP,zPass:gt.REPLACE}}}},mi={...hi,stencil:!1},yi={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function vi(e,t){const{referenceScale:i,radius:s}=e.uniforms;return s*(0!==i?i/t.scale:1)}class bi extends S{getVVRotationMat4(e){return ie(se(e),j.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(re),i=ne(t),s=le(t);return new j(s,i,0,0,i.multiply(new T(-1)),s,0,0,0,0,1,0,0,0,0,1)}))}getVVRotationMat3(e){return ie(se(e),z.identity(),(()=>{const t=this._getNormalizedAngle(e).multiply(re),i=ne(t),s=le(t);return new z(s,i,0,i.multiply(new T(-1)),s,0,0,0,1)}))}_getNormalizedAngle(e){const t=ae(this.rotationType,new T(oe.Arithmatic));return ie(t,new T(90).subtract(e),e)}}rt([x(T)],bi.prototype,"rotationType",void 0);const gi=360/254;class xi extends N{}rt([g(3,C)],xi.prototype,"color",void 0),rt([g(4,D)],xi.prototype,"offset",void 0),rt([g(5,D)],xi.prototype,"textureUV",void 0),rt([g(6,T)],xi.prototype,"fontSize",void 0),rt([g(7,T)],xi.prototype,"referenceSize",void 0),rt([g(8,T)],xi.prototype,"haloFontSize",void 0),rt([g(9,C)],xi.prototype,"haloColor",void 0),rt([g(10,D)],xi.prototype,"zoomRange",void 0),rt([g(11,T)],xi.prototype,"clipAngle",void 0),rt([g(12,C)],xi.prototype,"referenceSymbol",void 0);class wi extends ce{}rt([g(13,D)],wi.prototype,"offsetNextVertex1",void 0),rt([g(14,D)],wi.prototype,"offsetNextVertex2",void 0);class Si extends H{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const s=t.multiply(gi),a=pe(this.view.rotation.subtract(s)),r=de(new T(360).subtract(a),a);let n=new T(0);const l=fe(this.view.currentZoom.multiply(o)).divide(o),u=e.x,c=e.y,p=new T(1).subtract(A(u,l)).multiply(2),d=A(new T(90),r).multiply(2),f=new T(2).multiply(new T(1).subtract(A(l,c)));return n=n.add(i.multiply(p)),n=n.add(i.multiply(d)),n=n.add(f),n}vertex(e,t){const i=he(e.bitset,Me),s=new T(1).subtract(i);let a=e.fontSize,o=a.divide(me);const n=this.isHaloPass?e.haloColor:this._getVertexColor(e),l=this.isLabel?this.storage.getAnimationValue(e.id):new T(1),u=this.isLabel?n.multiply(l):n,c=this.view.displayViewScreenMat3.multiply(new _(e.pos,1));let p=e.offset,d=new T(1),f=z.identity(),h=new D(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,i=t.xy,s=t.z,a=this._unpackDirection(t.w),o=ye(this,e.id,s).divide(2),n=a.multiply(o.add(r));h=i.add(n),p=p.add(h)}else d=ye(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(d),o=o.multiply(d),p=p.multiply(d),f=ve(this,e.id),p=f.multiply(new _(p,0)).xy;const m=he(e.bitset,Pe),y=this._getViewRotationMatrix(m).multiply(new _(p,0));let v=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,m):this.clip(e.id,e.zoomRange);v=this.isBackgroundPass?v.add(s.multiply(2)):v.add(i.multiply(2));const b=this.isLabel?be(ge(v,new T(1)),ae(l,new T(0))):new xe(!1),g=new C(c.xy.add(y.xy),v,1),x=e.textureUV.divide(this.mosaicInfo.size);let w=new T(0);return this.isHaloPass&&(w=e.haloFontSize.divide(o).divide(we)),{glPosition:g,color:u,size:o,textureUV:x,antialiasingWidth:new T(.105*me).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:w,...this.maybeRunHittest(e,t,{vvSizeAdjustment:d,vvRotation:f,labelOffset:h,labelClipped:b})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new T(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new T(2/8),i=new T(1).subtract(t),s=M(this.mosaicInfo.texture,e.textureUV).a;let a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));const o=e.antialiasingWidth,r=R(a.subtract(o),a.add(o),s);return this.getFragmentOutput(e.color.multiply(r),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s,labelOffset:a,labelClipped:o}){let r,n,l;this.isLabel?(r=new _(e.offset.add(a),0),n=new _(t.offsetNextVertex1.add(a),0),l=new _(t.offsetNextVertex2.add(a),0)):(r=s.multiply(new _(e.offset.multiply(i),0)),n=s.multiply(new _(t.offsetNextVertex1.multiply(i),0)),l=s.multiply(new _(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:u,tileMat3:c}=this.view,p=u.multiply(c).multiply(new _(e.pos,1)),d=p.add(c.multiply(r)).xy,f=p.add(c.multiply(n)).xy,h=p.add(c.multiply(l)).xy,m=Se(this.hittestRequest.position,d.xy,f.xy,h.xy);return this.isLabel?ie(o,$(this.hittestRequest),m):m}_unpackDirection(e){const t=new Ve(e),i=ze(t,new Ve(2)),s=_e(t,new Ve(3));return new D(new T(i).subtract(1),new T(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new xe(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}}rt([ue(Te)],Si.prototype,"visualVariableColor",void 0),rt([ue(Ae)],Si.prototype,"visualVariableOpacity",void 0),rt([ue(bi)],Si.prototype,"visualVariableRotation",void 0),rt([ue(Ce)],Si.prototype,"visualVariableSizeMinMaxValue",void 0),rt([ue(Ie)],Si.prototype,"visualVariableSizeScaleStops",void 0),rt([ue(Re)],Si.prototype,"visualVariableSizeStops",void 0),rt([ue(Fe)],Si.prototype,"visualVariableSizeUnitValue",void 0),rt([x(Oe)],Si.prototype,"mosaicInfo",void 0),rt([U],Si.prototype,"isHaloPass",void 0),rt([U],Si.prototype,"isBackgroundPass",void 0),rt([U],Si.prototype,"isLabel",void 0),rt([nt(0,F(xi)),nt(1,F(wi))],Si.prototype,"vertex",null),rt([nt(0,F(class extends B{}))],Si.prototype,"fragment",null);class Vi extends Ee{}rt([g(9,T)],Vi.prototype,"accumulatedDistance",void 0),rt([g(10,D)],Vi.prototype,"segmentDirection",void 0),rt([g(11,C)],Vi.prototype,"tlbr",void 0);class zi extends De{_getLineWidthRatio(e,t){const i=new T(Ft),s=he(e.bitset,je);return s.multiply(P(t,new T(.25))).add(new T(1).subtract(s)).divide(i)}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:s,patternSize:a,accumulatedDistance:o,lineWidthRatio:r}=e,n=a.x.multiply(new T(2)).multiply(r),l=Le(o.divide(n)),u=new T(.25).multiply(i.y).add(new T(.5)),c=Be(s.xy,s.zw,new D(l,u)),p=ke(M(this.mosaicInfo.texture,c)).subtract(new T(.5)).multiply(t),d=Ue(new T(.5).subtract(p),new T(0),new T(1));return new C(d)}_getPatternColor(e){const{halfWidth:t,normal:i,color:s,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:r,tlbr:n}=e,l=o.y.multiply(new T(2).multiply(t).divide(o.x)),u=Le(a.divide(l)),c=new T(.5).multiply(i.y).add(new T(.5)),p=Be(n.xy,n.zw,new D(c,u));let d=M(this.mosaicInfo.texture,p);return null!=this.visualVariableColor&&(d=ie(ge(r,new T(.5)),new C(s.a),s)),d}vertex(e,t){const{segmentDirection:i,tlbr:s,bitset:a}=e,o=Ne(this,e),r=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(G(i,o.scaledOffset)),n=new D(s.z.subtract(s.x),s.w.subtract(s.y)),l=s.divide(this.mosaicInfo.size.xyxy),u=he(a,Ge),c=he(a,qe),p=ie(ge(u,new T(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new T(1));return{...o,tlbr:l,patternSize:n,accumulatedDistance:r,isSDF:u,sampleAlphaOnly:c,lineWidthRatio:p,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:s}=e,a=He(e,this.antialiasingControls.blur),o=ie(ge(s,new T(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),r=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(r,e)}}rt([x(Oe)],zi.prototype,"mosaicInfo",void 0),rt([nt(0,F(Vi)),nt(1,F($e))],zi.prototype,"vertex",null);class _i extends N{}rt([g(3,C)],_i.prototype,"color",void 0),rt([g(4,C)],_i.prototype,"outlineColor",void 0),rt([g(5,D)],_i.prototype,"offset",void 0),rt([g(6,D)],_i.prototype,"textureUV",void 0),rt([g(7,C)],_i.prototype,"sizing",void 0),rt([g(8,T)],_i.prototype,"placementAngle",void 0),rt([g(9,T)],_i.prototype,"sizeRatio",void 0),rt([g(10,D)],_i.prototype,"zoomRange",void 0);class Mi extends ce{}function Pi(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function Ti(e){return e.multiply(e).divide(128)}rt([g(12,D)],Mi.prototype,"offsetNextVertex1",void 0),rt([g(13,D)],Mi.prototype,"offsetNextVertex2",void 0),rt([g(14,D)],Mi.prototype,"textureUVNextVertex1",void 0),rt([g(15,D)],Mi.prototype,"textureUVNextVertex2",void 0);class Ai extends H{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Ti(e.sizing.x),s=Ti(e.sizing.y),a=Ti(e.sizing.z),o=e.placementAngle,r=he(e.bitset,st.bitset.isSDF),n=he(e.bitset,st.bitset.isMapAligned),l=he(e.bitset,st.bitset.scaleSymbolsProportionally),u=We(e.bitset,st.bitset.colorLocked),c=Ze(this,e.id),p=Ke(this,e.id,e.color,u).multiply(c),d=this.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),f=ye(this,e.id,a).divide(a),h=i.multiply(f),m=e.offset.xy.multiply(f);let y=s.multiply(l.multiply(f.subtract(1)).add(1));y=de(y,P(h.subtract(.99),new T(0)));const v=P(y,new T(1)),b=de(y,new T(1)),g=z.fromRotation(o.multiply(Xe)),x=ve(this,e.id),w=this._getViewRotationMatrix(n).multiply(x).multiply(g).multiply(new _(m.xy,0)),S=this.clip(e.id,e.zoomRange),V=new C(d.xy.add(w.xy),S,1),M=e.textureUV.divide(this.mosaicInfo.size),A=e.outlineColor.multiply(b),I=he(e.bitset,st.bitset.overrideOutlineColor),R=e.sizeRatio.multiply(h).multiply(.5);return{glPosition:V,color:p,textureUV:M,outlineColor:A,outlineSize:v,distanceToPx:R,isSDF:r,overrideOutlineColor:I,...this.maybeRunHittest(e,t,{pos:e.pos,size:h,sizeCorrection:f,isMapAligned:n,outlineSize:v,distanceToPx:R,isSDF:r})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return ie(Ye(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new T(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,s=new T(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getColor(e,t){return ie(ae(t.isSDF,new T(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return M(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=M(this.mosaicInfo.texture,e),s=new T(.5).subtract(ke(i)).multiply(t.distanceToPx).multiply(Qe),a=Ue(new T(.5).subtract(s),new T(0),new T(1)),o=t.color.multiply(a);let r=t.outlineSize;this.highlight&&(r=P(r,t.overrideOutlineColor.multiply(4)));const n=r.multiply(.5),l=pe(s).subtract(n),u=Ue(new T(.5).subtract(l),new T(0),new T(1)),c=Be(t.outlineColor,t.color,t.overrideOutlineColor).multiply(u);return new T(1).subtract(c.a).multiply(o).add(c)}_hittestSmallMarker(e,t,i){const{position:s,distance:a,smallSymbolDistance:o}=this.hittestRequest,r=a.subtract(o),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new _(i.pos,1)).xy,c=i.size.multiply(.5);return Je(u,s).subtract(c).add(r)}_hittestMarker(e,t,i){const{pos:s,sizeCorrection:a,isMapAligned:o}=i,r=new _(e.offset.multiply(a),0),n=new _(t.offsetNextVertex1.multiply(a),0),l=new _(t.offsetNextVertex2.multiply(a),0),{viewMat3:u,tileMat3:c}=this.view,p=u.multiply(c).multiply(new _(s,1)),d=this._getViewScreenMatrix(o),f=p.add(d.multiply(r)).xy,h=p.add(d.multiply(n)).xy,m=p.add(d.multiply(l)).xy,y=this.hittestRequest.position,v=this.hittestRequest.distance,b=Se(y,s,h,m);return ie(ge(b,v),b,this._hittestSamples(f,h,m,e,t,i))}_hittestSamples(e,t,i,s,a,o){const{outlineSize:r,isSDF:n,distanceToPx:l}=o,u=this.hittestRequest.position,c=this.hittestRequest.distance,p=et(u.add(new D(tt(c),tt(c))),e,t,i),d=et(u.add(new D(0,tt(c))),e,t,i),f=et(u.add(new D(c,tt(c))),e,t,i),h=et(u.add(new D(tt(c),0)),e,t,i),m=et(u,e,t,i),y=et(u.add(new D(c,0)),e,t,i),v=et(u.add(new D(tt(c),c)),e,t,i),b=et(u.add(new D(0,c)),e,t,i),g=et(u.add(new D(c,c)),e,t,i),x=s.textureUV.divide(this.mosaicInfo.size),w=a.textureUVNextVertex1.divide(this.mosaicInfo.size),S=a.textureUVNextVertex2.divide(this.mosaicInfo.size),V={color:new C(1),outlineColor:new C(1),overrideOutlineColor:new T(1),outlineSize:r,distanceToPx:l,isSDF:n};let z=new T(0);return z=z.add(it(p).multiply(this._getColor(Pi(p,x,w,S),V).a)),z=z.add(it(d).multiply(this._getColor(Pi(d,x,w,S),V).a)),z=z.add(it(f).multiply(this._getColor(Pi(f,x,w,S),V).a)),z=z.add(it(h).multiply(this._getColor(Pi(h,x,w,S),V).a)),z=z.add(it(m).multiply(this._getColor(Pi(m,x,w,S),V).a)),z=z.add(it(y).multiply(this._getColor(Pi(y,x,w,S),V).a)),z=z.add(it(v).multiply(this._getColor(Pi(v,x,w,S),V).a)),z=z.add(it(b).multiply(this._getColor(Pi(b,x,w,S),V).a)),z=z.add(it(g).multiply(this._getColor(Pi(g,x,w,S),V).a)),A(z,new T(.05)).multiply($(this.hittestRequest))}}rt([ue(Te)],Ai.prototype,"visualVariableColor",void 0),rt([ue(Ae)],Ai.prototype,"visualVariableOpacity",void 0),rt([ue(bi)],Ai.prototype,"visualVariableRotation",void 0),rt([ue(Ce)],Ai.prototype,"visualVariableSizeMinMaxValue",void 0),rt([ue(Ie)],Ai.prototype,"visualVariableSizeScaleStops",void 0),rt([ue(Re)],Ai.prototype,"visualVariableSizeStops",void 0),rt([ue(Fe)],Ai.prototype,"visualVariableSizeUnitValue",void 0),rt([x(Oe)],Ai.prototype,"mosaicInfo",void 0),rt([nt(0,F(_i)),nt(1,F(Mi))],Ai.prototype,"vertex",null),rt([nt(0,F(class extends B{}))],Ai.prototype,"fragment",null);class Ci{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((([e,t])=>`${e}.${t}`)).join("."),i=Ct(t);this._locationInfo={hash:i,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map((t=>`${t}.${e[t]}`)).join(".")}.${Object.keys(i).filter((e=>i[e])).map((e=>`${e}_${i[e].toString()}`)).join(".")}.${Object.keys(t).filter((e=>this.optionPropertyKeys.has(e))).join(".")}`}getProgram(e,t,i,s){let a="",o="";for(const e in i)if(i[e]){const t="boolean"==typeof i[e]?`#define ${e}\n`:`#define ${e} ${i[e]}\n`;a+=t,o+=t}return a+=this.vertexShader,o+=this.fragmentShader,new at(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const e in this.required){const i=this.required[e];t.push({uniformHydrated:null,shaderModulePath:e,uniformName:e,uniformType:i.type,uniformArrayElementType:Ii(i),uniformArrayLength:Ri(i)})}for(const i in e){const s=this.options[i];if(e[i])for(const e in s){const a=s[e];t.push({uniformHydrated:null,shaderModulePath:`${i}.${e}`,uniformName:e,uniformType:a.type,uniformArrayElementType:Ii(a),uniformArrayLength:Ri(a)})}}return t}}const Ii=e=>"array"===e.type?e.elementType?.type:void 0,Ri=e=>"array"===e.type?e.size:void 0,Fi={hittestDist:T,hittestPos:D},Oi={filterFlags:E,animation:E,visualVariableData:E,dataDriven0:E,dataDriven1:E,dataDriven2:E,gpgpu:E,size:T},Di={displayViewScreenMat3:z,displayViewMat3:z,displayMat3:z,viewMat3:z,tileMat3:z,displayZoomFactor:T,requiredZoomFactor:T,tileOffset:D,currentScale:T,currentZoom:T,metersPerSRUnit:T};class Ei extends Ci{constructor(){super(...arguments),this.vertexShader=Ot("materials/pie/pie.vert"),this.fragmentShader=Ot("materials/pie/pie.frag"),this.required={...Oi,...Di,outlineWidth:T,colors:k,defaultColor:C,othersColor:C,outlineColor:C,donutRatio:T,sectorThreshold:T},this.options={hittestUniforms:Fi,visualVariableSizeMinMaxValue:{minMaxValueAndSize:C},visualVariableSizeScaleStops:{sizes:{...k.ofType(T,8),type:"array",elementType:T,size:8},values:{...k.ofType(T,8),type:"array",elementType:T,size:8}},visualVariableSizeStops:{sizes:{...k.ofType(T,8),type:"array",elementType:T,size:8},values:{...k.ofType(T,8),type:"array",elementType:T,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:T},visualVariableOpacity:{opacities:{...k.ofType(T,8),type:"array",elementType:T,size:8},opacityValues:{...k.ofType(T,8),type:"array",elementType:T,size:8}}},this.locations={pos:{index:0,type:D},id:{index:1,type:_},bitset:{index:2,type:T},offset:{index:3,type:D},texCoords:{index:4,type:D},size:{index:5,type:D},referenceSize:{index:6,type:T},zoomRange:{index:7,type:D}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...k.ofType(C,e),type:"array",elementType:C,size:e}}}const Li={fill:new class extends Gt{constructor(){super(...arguments),this.type=W.Fill,this.shaders={geometry:new Z}}render(e,t){const{painter:i}=e,s=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,s.uniforms),...d(e,t.target)},defines:f(e),optionalAttributes:s.optionalAttributes,useComputeBuffer:p(e)}),i.setPipelineState(h(e)),i.submitDraw(e,t)}},patternFill:new class extends Gt{constructor(){super(...arguments),this.type=W.PatternFill,this.shaders={geometry:new Q}}render(e,t){const{context:i,painter:s}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,a.uniforms),...d(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:v(t.target)},defines:{...f(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},complexFill:new class extends Gt{constructor(){super(...arguments),this.type=W.ComplexFill,this.shaders={geometry:new K}}render(e,t){const{context:i,painter:s}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,a.uniforms),...d(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:v(t.target)},defines:{...f(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},outlineFill:new class extends Gt{constructor(){super(...arguments),this.type=W.OutlineFill,this.shaders={geometry:new Y}}render(e,t){const{painter:i,pixelRatio:s}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,a.uniforms),...d(e,t.target),antialiasingControls:si(s)},defines:{...f(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:p(e)}),i.setPipelineState(h(e)),i.submitDraw(e,t)}},patternOutlineFill:new class extends Gt{constructor(){super(...arguments),this.type=W.PatternOutlineFill,this.shaders={geometry:new J}}render(e,t){const{context:i,painter:s,pixelRatio:a}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,o.uniforms),...d(e,t.target),antialiasingControls:si(a),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:v(t.target)},defines:{...f(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},complexOutlineFill:new class extends Gt{constructor(){super(...arguments),this.type=W.ComplexOutlineFill,this.shaders={geometry:new X}}render(e,t){const{context:i,painter:s,pixelRatio:a}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,o.uniforms),...d(e,t.target),antialiasingControls:si(a),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:v(t.target)},defines:{...f(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},marker:new class extends Gt{constructor(){super(...arguments),this.type=W.Marker,this.shaders={geometry:new Ai},this.symbologyPlane=u.MARKER}render(e,t){const{context:i,painter:s}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,a.uniforms),...d(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...f(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},pieChart:new class extends Gt{constructor(){super(...arguments),this.type=W.PieChart,this.shaders={geometry:new Ei},this.symbologyPlane=u.MARKER}render(e,t){const{painter:i}=e,{instance:s,target:a}=t,o=this.shaders.geometry,r=s.getInput(),n=r.uniforms.numberOfFields,l=p(e),u=d(e,a),c=f(e);o.setNumberOfFields(n),i.setShader({shader:o,uniforms:{...y(e,t.target,r.uniforms.shader),...u.storage,...u.view,hittestUniforms:u.hittestRequest?{hittestDist:u.hittestRequest?.distance,hittestPos:u.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!r.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!r.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!r.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!r.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!r.uniforms.shader.visualVariableOpacity,HITTEST:l,highlight:u.highlight?1:0,...c,numberOfFields:n},optionalAttributes:{},useComputeBuffer:l}),i.setPipelineState(h(e)),i.submitDraw(e,t)}},line:new class extends Gt{constructor(){super(...arguments),this.type=W.Line,this.shaders={geometry:new De},this.symbologyPlane=u.LINE}render(e,t){const{painter:i,pixelRatio:s}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,a.uniforms),...d(e,t.target),antialiasingControls:si(s)},defines:{...f(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:p(e)}),i.setPipelineState(h(e)),i.submitDraw(e,t)}},texturedLine:new class extends Gt{constructor(){super(...arguments),this.type=W.TexturedLine,this.shaders={geometry:new zi},this.symbologyPlane=u.LINE}render(e,t){const{context:i,painter:s,pixelRatio:a}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...y(e,t.target,o.uniforms),...d(e,t.target),antialiasingControls:si(a),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...f(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:p(e)}),s.setPipelineState(h(e)),s.submitDraw(e,t)}},text:new class extends Gt{constructor(){super(...arguments),this.type=W.Text,this.shaders={geometry:new Si},this.symbologyPlane=u.TEXT}render(e,t){const{context:i,painter:s}=e,a=f(e),o=t.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...y(e,t.target,o.uniforms),...d(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:o.optionalAttributes,useComputeBuffer:p(e)};s.setShader(r),s.setPipelineState(h(e)),s.submitDraw(e,t),s.setShader({...r,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),s.submitDraw(e,t),s.setShader({...r,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),s.submitDraw(e,t)}},label:new class extends Gt{constructor(){super(...arguments),this.type=W.Label,this.shaders={geometry:new Si},this.drawPhase=l.LABEL|l.LABEL_ALPHA|l.HITTEST,this.symbologyPlane=u.TEXT}render(e,t){const{context:i,painter:s}=e,a=f(e),o={...h(e)},r=t.instance.getInput(),n={shader:this.shaders.geometry,uniforms:{...y(e,t.target,r.uniforms),...d(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:p(e)};s.setShader(n),s.setPipelineState(o),s.submitDraw(e,t),s.setShader({...n,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(o),s.submitDraw(e,t),s.setShader({...n,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(o),s.submitDraw(e,t)}},heatmap:new class extends Gt{constructor(){super(...arguments),this.type=W.Heatmap,this.shaders={accumulate:new li,resolve:new di},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=fi}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:a}=e,o=t.instance.getInput(),{isFieldActive:r}=o.uniforms,n=this._getOrCreateResourcesRecord(i),l=n.loadQualityProfile(i);if(c(e))return;p(e)||this._bind(e,n,o),s.setShader({shader:this.shaders.accumulate,uniforms:{...d(e,t.target),kernelControls:{radius:vi(o,a),isFieldActive:r?1:0}},defines:{...f(e),...l.defines},optionalAttributes:{},useComputeBuffer:p(e)});const u=p(e)?mi:hi;s.setPipelineState(u),s.submitDraw(e,t)}postProcess(e,t){if(p(e)||c(e))return;const{context:i,painter:s}=e,a=this._resources.get(i);if(null==this._prevFBO||null==this._prevViewport||!a?.initialized)return;const{defines:o}=a.loadQualityProfile(i),{minDensity:r,maxDensity:n,radius:l}=t.getInput().uniforms,u=a.accumulateFramebuffer,d=a.resolveGradientTexture;s.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:u.colorTexture},minAndInvRange:[r,1/(n-r)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:d}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(u.colorTexture,8),i.bindTexture(d,9),s.setPipelineState(yi),s.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ai,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:a,pixelRatio:o}=e,r=s.getBoundFramebufferObject(),n=s.getViewport();this._prevFBO=r,this._prevViewport=n;const{gradient:l,gradientHash:u}=i.uniforms;t.ensureResolveGradientTexture(s,u,l);const{width:c,height:p}=n,d=function(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}(vi(i,a),o),f=c*d,h=p*d,m=t.ensureAccumulateFBO(s,f,h);s.blitFramebuffer(r,m,0,0,r.width,r.height,0,0,m.width,m.height,vt.STENCIL_BUFFER_BIT,dt.NEAREST),s.bindFramebuffer(m),s.setViewport(0,0,m.width,m.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(vt.COLOR_BUFFER_BIT),this._isBound=!0}},dotDensity:new class extends Gt{constructor(){super(...arguments),this.type=W.DotDensity,this.shaders={polygon:new Qt,point:new Zt,fill:new Z},this._resources=new Map}render(e,t){c(e)||p(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...d(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...f(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:p(e)}),i.setPipelineState(h(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:o,painter:r,requiredLevel:n}=e,l=t.instance.getInput().uniforms,u=this._getOrCreateResourcesRecord(o),c=u.getDotDensityTextures(o,i,l.seed),p=1/2**(n-t.target.key.level),y=i,v=y*window.devicePixelRatio*y*window.devicePixelRatio,b=1/p*(1/p),g=l.dotScale?e.state.scale/l.dotScale:1,x=l.dotValue*g*b;r.setShader({shader:this.shaders.polygon,uniforms:{...d(e,t.target),instance:{isActive:l.isActive,colors:l.colors,dotValue:Math.max(1,x)},draw:{dotTexture0:{unit:s,texture:c[0]},dotTexture1:{unit:a,texture:c[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:v/(i*window.devicePixelRatio*i*window.devicePixelRatio)}},defines:{...f(e),blending:l.blending},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(h(e));const w=o.getViewport();o.setViewport(0,0,i,i);const S=o.getBoundFramebufferObject(),V=u.getFBO(o);o.bindFramebuffer(V),o.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(o),o.clear(vt.COLOR_BUFFER_BIT),r.submitDraw(e,t),o.bindFramebuffer(S),o.setViewport(w.x,w.y,w.width,w.height);const z=u.getFBO(o).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:m(e,t.target),instance:{dotSize:l.dotSize},draw:{locations:{unit:s,texture:z},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...f(e)},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(o,u.getDotDensityMesh(o))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new ii,this._resources.set(e,t)),t}}};function Bi(){for(const e in Li)Li[e].startup()}function ki(e){for(const t in Li)Li[t].shutdown(e)}function Ui(e,t){const i=e.slice(0,t),s=t-i.length;for(let e=0;e<s;e++){const e=i[i.length-1];i.push(e)}return i}function Ni(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a}=e;return[t*(a/255),i*(a/255),s*(a/255),a]}const Hi=8,ji=Hi-2,Gi=()=>At.getLogger("esri.views.2d.layers.features.support.rendererUtils");function qi(e){return e.map((e=>function(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}(e)?function(e){return e.stops=(t=e.type,(i=e.stops??[]).length<=Hi?i:(Gi().warn(`Found ${i.length} Visual Variable stops, but MapView only supports ${Hi}. Displayed stops will be simplified.`),i.length>2*Hi?function(e,t){const[i,...s]=t,a=s.pop(),o=s[0].value,r=s[s.length-1].value,n=(r-o)/ji,l=[];for(let i=o;i<r;i+=n){let a=0;for(;i>=s[a].value;)a++;const o=s[a],r=t[a-1],n=i-r.value,u=o.value===r.value?1:n/(o.value-r.value);if("color"===e){const e=s[a],o=t[a-1],r=e.color.clone();r.r=$i(o.color.r,r.r,u),r.g=$i(o.color.g,r.g,u),r.b=$i(o.color.b,r.b,u),r.a=$i(o.color.a,r.a,u),l.push({value:i,color:r,label:e.label})}else if("size"===e){const e=s[a],o=t[a-1],r=Dt(e.size),n=$i(Dt(o.size),r,u);l.push({value:i,size:n,label:e.label})}else{const e=s[a],o=$i(t[a-1].opacity,e.opacity,u);l.push({value:i,opacity:o,label:e.label})}}return[i,...l,a]}(t,i):function(e){const[t,...i]=e,s=i.pop();for(;i.length>ji;){let e=0,t=0;for(let s=1;s<i.length;s++){const a=i[s-1],o=i[s],r=Math.abs(o.value-a.value);r>t&&(t=r,e=s)}i.splice(e,1)}return[t,...i,s]}(i))),e;var t,i}(e.clone()):e))}function $i(e,t,i){return(1-i)*e+i*t}function Wi(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!function(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=Ut();return e&&t||i}()){const e=Ut(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((t=>!e[t])).join(", ");return Gi().errorOnce(new kt("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const Zi=1.25,Ki=128,Xi=128;function Yi(e){if(!e.stops?.length)return null;const t=Ui(e.stops.sort(((e,t)=>e.value-t.value)),8),i=t.map((({value:e})=>e)),s=t.map((({color:e})=>Ni(e)));return{values:i,colors:s}}function Qi(e){if(!e.stops?.length)return null;const t=Ui(e.stops.sort(((e,t)=>e.value-t.value)),8);return{opacityValues:t.map((({value:e})=>e)),opacities:t.map((({opacity:e})=>e))}}function Ji(e){return{rotationType:"geographic"===e.rotationType?oe.Geographic:oe.Arithmatic}}function es(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(t,i)=>{const s=t.statisticsByLevel.get(i.key.level),a=Ui(e.stops.map((t=>({value:t.useMaxValue?s?.get(e.field)?.maxValue??0:t.useMinValue?s?.get(e.field)?.minValue??0:t.value,size:t.size?Et(t.size):n}))).sort(((e,t)=>e.value-t.value)),8);return{values:a.map((({value:e})=>e)),sizes:a.map((({size:e})=>e))}};const t=Ui(e.stops.sort(((e,t)=>e.value-t.value)),8);return{values:t.map((({value:e})=>e)),sizes:t.map((({size:e})=>Et(e)))}}function ts(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:Lt(i.spatialReference)/Bt[e.valueUnit??"meters"]/i.resolution}}}function is(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function ss(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:a}=e;if("object"==typeof s&&"object"==typeof a)return(e,o)=>{const r=e.state.scale,n=Et(is(r,s.stops)),l=Et(is(r,a.stops));return{minMaxValueAndSize:[t,i,n,l]}};if("object"==typeof s||"object"==typeof a)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,Et(s),Et(a)]}}const as={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function os(e,t=Xi,i=Zi){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?Ki:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return Ki;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return Ki;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?2*Ki:0}function rs(e){const t={...as};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const s of qi(e.visualVariables))switch(s.type){case"color":t.visualVariableColor=Yi(s);break;case"opacity":t.visualVariableOpacity=Qi(s);break;case"rotation":t.visualVariableRotation=Ji(s);break;case"size":switch("number"==typeof(i=s).minDataValue&&"number"==typeof i.maxDataValue&&null!=i.minSize&&null!=i.maxSize?"min-max":"$view.scale"===i?.valueExpression&&Array.isArray(i.stops)?"scale-stops":null==i.field&&"$view.scale"===i?.valueExpression||!(Array.isArray(i.stops)||"levels"in i&&i.levels)?null!=i.field||"$view.scale"!==i?.valueExpression?"unit-value":null:"field-stops"){case"field-stops":t.visualVariableSizeStops=es(s);break;case"scale-stops":"outline"===s.target?t.visualVariableSizeOutlineScaleStops=es(s):t.visualVariableSizeScaleStops=es(s);break;case"min-max":t.visualVariableSizeMinMaxValue=ss(s);break;case"unit-value":t.visualVariableSizeUnitValue=ts(s)}}var i;return t}function ns(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function ls(e){return!!e.visualVariableRotation}function us(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function cs(e){if(null==e)return null;if(Array.isArray(e)){const[t,i,s,a]=e;return[t,i,s,255*a]}return"string"==typeof e?e:{...e,defaultValue:cs(e?.defaultValue)}}async function ps(t,i){const{cimResourceManager:s,cimAnalyzer:a,scaleExpression:o}=i.schemaOptions;await Promise.all(e.fetchResources(t.symbol,s,[]));const r=a.analyzeSymbolReference(t,!1),n={scaleInfo:us(t),scaleExpression:o},l=[];for(const e of r)switch(e.type){case"marker":l.push(...ds(e,i,n));break;case"fill":l.push(...ms(e,i,n));break;case"line":l.push(...vs(e,i,n));break;case"text":l.push(...ws(e,i,n))}return l}function ds(e,t,i){const{uniforms:s,schemaOptions:a}=t,{store:o}=a,r=e.isOutline?{...as,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};return fs(o.ensureInstance(Li.marker,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s,i)}function fs(e,i,s,{scaleInfo:a,scaleExpression:o}){const r=ns(s);return[e.createMeshInfo({size:i.size,scaleX:i.scaleX,anchorX:i.anchorPoint.x,anchorY:i.anchorPoint.y,angle:i.rotation,color:cs(i.color)??[0,0,0,0],colorLocked:i.colorLocked,frameHeight:i.frameHeight,widthRatio:i.widthRatio,scaleInfo:a,offsetX:i.offsetX,offsetY:i.offsetY,outlineColor:cs(i.outlineColor)??[0,0,0,0],outlineSize:i.outlineWidth,referenceSize:i.referenceSize||t.CIMVectorMarker.size,rotateClockwise:i.rotateClockwise,scaleFactor:o??1,sizeRatio:i.sizeRatio,alignment:i.alignment,isAbsoluteAnchorPoint:i.isAbsoluteAnchorPoint,scaleSymbolsProportionally:i.scaleSymbolsProportionally,sprite:i.spriteRasterizationParam,hasSizeVV:r,placement:i.markerPlacement,effects:i.effects?{type:"cim-effect-infos",effectInfos:i.effects}:null,transforms:i.transform,minPixelBuffer:os(s)})]}function hs(e,t,{scaleInfo:i}){return[e.createMeshInfo({color:cs(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function ms(e,t,i){if(!e.spriteRasterizationParam)return function(e,t,i){const{uniforms:s,schemaOptions:a}=t,{store:o}=a;return hs(o.ensureInstance(Li.fill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}(e,t,i);const{uniforms:s,schemaOptions:a}=t,{store:o}=a;return ys(o.ensureInstance(Li.complexFill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,null!=s.visualVariableColor,i)}function ys(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const a=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),o=t.sampleAlphaOnly&&!a,r=t.spriteRasterizationParam;return[e.createMeshInfo({color:cs(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:"CIMHatchFill"===r.resource.type,sprite:r,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function vs(e,t,i){const{uniforms:s,schemaOptions:a}=t,{store:o}=a,r=e.isOutline?{...as,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},n={uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}},l=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?xs(o.ensureInstance(Li.texturedLine,n),e,l,i):gs(o.ensureInstance(Li.line,n),e,l,i)}function bs(e,t,{scaleInfo:i}){return{color:cs(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function gs(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const a=bs(t,i,s);return[e.createMeshInfo(a)]}function xs(e,t,i,s){const{spriteRasterizationParam:a,scaleDash:o,sampleAlphaOnly:r}=t;if(!a)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...bs(t,i,s),shouldScaleDash:o??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==a.resource.type,sprite:a})]}function ws(e,t,i){const{uniforms:s,schemaOptions:a}=t,{store:o}=a;return Ss(o.ensureInstance(Li.text,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),e,s,i)}function Ss(e,t,i,{scaleInfo:s,scaleExpression:a}){return[e.createMeshInfo({boxBackgroundColor:cs(t.backgroundColor),boxBorderLineColor:cs(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:cs(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:cs(t.outlineColor)??[0,0,0,0],haloFontSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:a??1,minPixelBuffer:os(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1})]}function Vs(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:Ut().maxTextureSize},bindings:_s(e)}}function zs(e){switch(e){case"opacity":return b.OPACITY;case"color":return b.COLOR;case"rotation":return b.ROTATION;case"size":return b.SIZE;default:return null}}function _s(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Ms(e);case"dot-density":return function(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}(e);case"pie-chart":return function(e){const t=Ms(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}(e);case"heatmap":return function({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}(e)}}function Ms(e){return"visualVariables"in e&&e.visualVariables?.length?qi(e.visualVariables).map((e=>function(e){switch(e.type){case"size":return function(e){return"$view.scale"===e.valueExpression?null:{binding:zs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}(e);case"color":case"opacity":return function(e){return{binding:zs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}(e);case"rotation":return function(e){return{binding:zs(e.type),expression:e.valueExpression,field:e.field}}(e)}}(e))).filter(ut):[]}class Ps{constructor(e){this.updateTracking=new ot({debugName:"FeatureCommandQueue"}),this._queueProcessor=new Ht({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return Nt(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":if(i?.type===e.type)return;return t.push(e);case"edit-by-id":case"edit-by-feature":return t.push(e)}}}export{Ps as F,Li as T,xs as a,gs as b,Ss as c,hs as d,ys as e,fs as f,us as g,Vs as h,ps as i,rs as j,os as k,ns as l,ls as m,as as n,Wi as o,Ni as p,Ms as q,ki as r,Bi as s};

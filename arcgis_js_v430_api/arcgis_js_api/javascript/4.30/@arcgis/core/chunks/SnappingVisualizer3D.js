/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../Color.js";import{m as t}from"./colorUtils2.js";import"../core/lang.js";import{d as r}from"./handleUtils.js";import{g as i,p as o,n as s,c as n,i as a,a as c}from"./vec3.js";import{c as l,f as d}from"./vec3f64.js";import{p}from"./projectVectorToVector.js";import{o as u,a as m}from"./elevationInfoUtils.js";import{a as h,E as f}from"./ExtendedLineVisualElement.js";import{watch as g}from"../core/reactiveUtils.js";import{e as _,b as j}from"./screenUtils.js";import{i as O,s as D,e as R,g as v,b as w}from"./vec2.js";import{c as y}from"./vec2f64.js";import{e as b,c as E}from"./vec4.js";import{f as x}from"./vec4f32.js";import{m as A}from"./dehydratedPoint.js";import{E as G}from"./EngineVisualElement.js";import{R as S,d as C,b as P}from"./RenderGeometry.js";import{c as V}from"./GeometryUtil.js";import{R as T}from"./Material.js";import{V as H}from"./VertexAttribute.js";import{R as z}from"./RibbonLineMaterial.js";import{P as F}from"./PointVisualElement.js";import{R as I}from"./RightAngleQuadVisualElement.js";import{t as U,i as L,w as M}from"./normalizedPoint.js";import{d as N}from"./Settings2.js";import{L as q,a as W}from"./RightAngleSnappingHint.js";import{L as B}from"./snappingUtils.js";import{S as k}from"./SnappingVisualizer.js";import{v as Q}from"./viewUtils.js";class X extends G{constructor(e){super(e),this._location=l(),this._direction=d(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=x(1,0,1,1),this._renderOccluded=T.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:K,recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:Y,recreateGeometry:e=>this._recreateDrapedGeometry(e)}}get location(){return this._location}set location(e){i(this._location,e)||(o(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){i(this._direction,e)||(o(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){s(this._direction,n(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){b(e,this._color)||(E(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new z(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,r){const[i,o]=Z(e);t.addGeometry(i),t.addGeometry(o),r.push(i),r.push(o),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new z(this.materialParameters),t=g((()=>this.view.state.contentPixelRatio),(()=>{this.drapedResources.recreateGeometry()}));return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=Z(e);return this._updateVerticesDraped(t),t.map((e=>new S(e)))}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,ie),a($,this.location,this.direction),t.projectToScreen($,oe),O(oe,D(oe,oe,ie)),this._updateVertexAttributesObject3D(t,e,0,ie,oe,1),this._updateVertexAttributesObject3D(t,e,1,ie,oe,-1)}_updateVertexAttributesObject3D(e,t,r,i,o,s){const n=t.geometries[r],a=n.getMutableAttribute(H.POSITION)?.data;if(!a)return;const{start:c,end:l}=J(o,i,s,this.offset,this.width,this.length);e.unprojectFromScreen(_(c),$),a[0]=$[0],a[1]=$[1],a[2]=$[2],e.unprojectFromScreen(_(l),$),a[3]=$[0],a[4]=$[1],a[5]=$[2],t.geometryVertexAttributeUpdated(n,H.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:i,width:o,length:s,offset:n}=this,a=se;a.spatialReference=t.renderer.spatialReference,a.x=i[0],a.y=i[1];const c=this.view.overlayPixelSizeInMapUnits(a)*r,l=o*c,d=s*c,p=n*c;this._updateVertexAttributesDraped(e[0],l,d,p,-1),this._updateVertexAttributesDraped(e[1],l,d,p,1)}_updateVertexAttributesDraped(e,t,r,i,o){const s=e.getMutableAttribute(H.POSITION)?.data;if(!s)return;const{location:n,direction:a}=this,{start:c,end:l}=J(a,n,o,i,t,r);s[0]=c[0],s[1]=c[1],s[2]=C,s[3]=l[0],s[4]=l[1],s[5]=C,e.invalidateBoundingInfo()}}function Z(e){return[V(e,[l(),l()]),V(e,[l(),l()])]}function J(e,t,r,i,o,s){const n=R(ee,v(ee,e[1]*r,e[0]*-r),i+o/2),a=w(te,w(te,w(te,t,R(te,e,s/2)),n),n);return{start:a,end:w(re,a,R(re,e,-s))}}function K(e){e.geometries.length=0}function Y(e){e.pixelRatioHandle.remove(),e.geometries=[]}const $=l(),ee=y(),te=y(),re=y(),ie=j(),oe=j(),se=A(0,0,void 0,null);class ne extends k{sortUniqueHints(e){return e.sort(((e,t)=>(t instanceof q?t.length:0)-(e instanceof q?e.length:0)))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:o}=t,s=ae(t);return r(new F({view:o,primitive:"circle",geometry:U(e.intersectionPoint,i),elevationInfo:e.isDraped?u:m,size:20,outlineSize:2,color:s.intersectionPointColor,outlineColor:s.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:o}=t,s=ae(t),n=ce(e.point,e.domain,t);return r(new F({view:i,primitive:"circle",geometry:U(n,o),elevationInfo:le(e),size:20,outlineSize:2,color:s.pointColor,outlineColor:s.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:o}=t,s=ae(t),n=ce(e.lineStart,e.domain,t),a=ce(e.lineEnd,e.domain,t);return r(function(e,t,r,i,o,s,n,a=!1,c=!0,l=!0){const d=de(t,i,o,s,a),p=de(r,i,o,s,a),u=new h({view:s,extensionType:f.FADED,start:d,end:p,isDraped:a,color:n.lineColor,renderOccluded:a?T.OccludeAndTransparent:T.Opaque,renderGroup:P.SnappingHint,isDecoration:!0});switch(e){case B.TARGET:u.width=N.lineHintWidthTarget,u.fadedExtensions={start:0,end:N.lineHintFadedExtensions};break;case B.REFERENCE_EXTENSION:u.width=N.lineHintWidthReference,u.fadedExtensions={start:0,end:0};break;case B.REFERENCE:u.width=N.lineHintWidthReference,u.fadedExtensions={start:c?N.lineHintFadedExtensions:0,end:l?N.lineHintFadedExtensions:0}}return u.attached=!0,u}(e.type,n,a,o,le(e),i,s,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:o}=t,s=ae(t),{isDraped:n}=e,a=le(e),l=ce(e.lineStart,e.domain,t),d=ce(e.lineEnd,e.domain,t),p=de(l,o,a,i,n),u=de(d,o,a,i,n),m=c(u,p,u,.5),h=new X({view:i,attached:!1,offset:N.parallelLineHintOffset,length:N.parallelLineHintLength,width:N.parallelLineHintWidth,color:s.parallelSignColor,location:m,renderOccluded:n?T.OccludeAndTransparent:T.Opaque,isDraped:n,renderGroup:P.SnappingHint,isDecoration:!0});return h.setDirectionFromPoints(p,m),h.attached=!0,r(h)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:o}=t,s=ae(t),n=le(e),{isDraped:a}=e,c=ce(e.previousVertex,e.domain,t),l=ce(e.centerVertex,e.domain,t),d=ce(e.nextVertex,e.domain,t),p=de(c,o,n,i,a),u=de(l,o,n,i,a),m=de(d,o,n,i,a);return r(new I({view:i,attached:!0,color:a?s.rightAngleColorDraped:s.rightAngleColor,renderOccluded:a?T.OccludeAndTransparent:T.Transparent,outlineRenderOccluded:a?T.OccludeAndTransparent:T.Opaque,outlineColor:s.rightAngleOutlineColor,outlineSize:N.rightAngleHintOutlineSize,size:N.rightAngleHintSize,isDraped:a,geometry:{previous:p,center:u,next:m},renderGroup:P.SnappingHint,isDecoration:!0}))}}function ae(r){const{effectiveTheme:i}=r.view,o=e.toUnitRGBA(i.accentColor),s=[0,0,0,0];return{intersectionPointColor:s,intersectionPointOutlineColor:o,pointColor:s,pointOutlineColor:o,lineColor:o,lineOutlineColor:void 0,parallelSignColor:o,rightAngleColor:o,rightAngleColorDraped:e.toUnitRGBA(t(i.accentColor,.5)),rightAngleOutlineColor:o}}function ce(e,t,{selfSnappingZ:r,view:i,spatialReference:o}){return t&W.SELF&&L(e)&&null!=r?M(e,r,i,o):e}function le(e){return e.isDraped?u:m}function de(e,t,r,i,o){const s=l();if(o){const r=i.basemapTerrain.overlayManager.renderer.spatialReference;p(e,t,s,r)}else Q(e,t,r,i,s);return s}export{ne as S};

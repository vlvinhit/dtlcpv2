/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{r as e,L as t}from"./Logger.js";import{c as n,f as r}from"./date.js";import{f as i,c as a}from"./number.js";import{featureHasFields as o,isTimeOnlyField as l,l as s,isRasterPixelValueField as u}from"../layers/support/fieldUtils.js";import{g as f}from"./layerUtils2.js";import{i as c,f as d}from"./utils2.js";import{g as p}from"./timeZoneUtils.js";const y=()=>t.getLogger("esri.widgets.Feature.support.featureUtils"),m=/href=(""|'')/gi,g=/(\{([^{\r\n]+)\})/g,h=/'/g,b=/^\s*expression\//i,I=/(\n)/gi,T=/[\u00A0-\u9999<>&]/gim,w=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,F=/^(?:mailto:|tel:)/,N="relationships/",Z=n("short-date-short-time");function j(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function L({type:e,value:t,event:n}){try{return"function"==typeof t?t(n):t}catch(r){return void y().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function v(e=""){if(e)return!F.test(e.trim().toLowerCase())}function E(e){return!!e&&b.test(e)}function x(e,t){const n=function(e,t){if(!t||!E(t)||!e)return;const n=t.replace(b,"").toLowerCase();return e.find((({name:e})=>e.toLowerCase()===n))}(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function q(e,t){const n=C(t,e);return n?n.name:e}function A(e,t){return e&&e.map((e=>q(e,t)))}function C(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function U(e){return`${e}`.trim()}function M({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:a}){return r?R({formattedAttributes:t,template:k(r,{...t,...i,...e},n),fieldInfoMap:a}):""}function R({formattedAttributes:t,template:n,fieldInfoMap:r}){return U((i=e(e(n,(e=>function(e,t){const n=t.get(e.toLowerCase());return`{${n?.fieldName||e}}`}(e,r))),t),i.replaceAll(m,"")));var i}function $(e,t){return e.replaceAll(g,((e,n,r)=>{const i=C(t,r);return i?`{${i.name}}`:n}))}function k(t,n,r){const i=$(t,r);return i?i.replaceAll(w,((t,r,i)=>function(t,n,r){const i=(n=U(n))&&"{"!==n[0];return e(t,function(e,t=!1){const n={...e};return Object.keys(n).forEach((e=>function(e,t,n=!1){const r=t[e];if("string"==typeof r){const i="%27",a=(n?encodeURIComponent(r):r).replaceAll(h,i);t[e]=a}}(e,n,t))),n}(r,i||!1))}(t,r||i,n))):i}function D(e){return function(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type||"sublayer"===e.type)&&"when"in e}(e)&&function(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}(e)}function z(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&D(e.sourceLayer)}function O(e,t,n,r){return e.trim().split(t).map((e=>i(Number(e),a(r)))).join(n)}function G(e,t){if(e?.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function S(e,t,n,i){const{creatorField:a,creationDateField:o,editorField:l,editDateField:s}=e;if(!t)return;const u=p(i&&"preferredTimeZone"in i?i.preferredTimeZone:null,!(!i||!("datesInUnknownTimezone"in i)||!i.datesInUnknownTimezone),n,Z,"date"),f={...Z,...u},c=t[s];if("number"==typeof c){const e=t[l];return{type:"edit",date:r(c,f),user:e}}const d=t[o];if("number"==typeof d){const e=t[a];return{type:"create",date:r(d,f),user:e}}return null}function P(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const e=q(r.fieldName,t);r.fieldName=e,n.set(e.toLowerCase(),r)}return n}function Q(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)?(r.forEach((e=>{if("fields"===e.type){const n=e?.fieldInfos;n&&t.push(...n)}})),t):t}function _(e){return e.replaceAll(T,(e=>`&#${e.charCodeAt(0)};`))}function H(e){return"string"==typeof e?e.replaceAll(I,'<br class="esri-text-new-line" />'):e}function B(e){const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:o,layer:s,graphic:f,timeZone:p}=e;if(null==t)return"";const y=function({fieldName:e,value:t,graphic:n,layer:r}){if(W(e))return null;if(!r||"function"!=typeof r.getFieldDomain)return null;const i=n&&r.getFieldDomain(e,{feature:n});return i&&"coded-value"===i.type?i.getName(t):null}({fieldName:n,value:t,graphic:f,layer:s});if(y)return y;const m=function({fieldName:e,graphic:t,layer:n}){if(W(e))return null;if(!n||"function"!=typeof n.getFeatureType)return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const i=n.getFeatureType(t);return i?i.name:null}({fieldName:n,graphic:f,layer:s});if(m)return m;if(o.get(n.toLowerCase()))return function(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:o,layer:l,timeZone:s}=t,f=G(n,r),c=C(l,r);if(f&&!u(r)){const t=c?.type,n=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return d(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}})}const p=f?.format;return"string"==typeof e&&u(r)&&p?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?O(e,",",", ",t):e.includes(";")?O(e,";","; ",t):e.includes(" ")?O(e," "," ",t):i(Number(e),a(t))}(e,p):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,p),"string"==typeof e||null==e||null==p?H(e):i(e,o?{...a(p),minimumFractionDigits:0,maximumFractionDigits:20}:a(p)))}(t,{fieldInfos:r||Array.from(o.values()),fieldName:n,layer:s,timeZone:p});const g=s?.fieldsIndex?.get(n);return g&&(c(g)||l(g))?d(t,{fieldType:g.type,timeZoneOptions:{layerTimeZone:s&&"preferredTimeZone"in s?s.preferredTimeZone:null,viewTimeZone:p,datesInUnknownTimezone:!(!s||!("datesInUnknownTimezone"in s)||!s.datesInUnknownTimezone)}}):H(t)}function J({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:i,relatedInfos:a,timeZone:o}){const l={};return a?.forEach((t=>function({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}){e&&t&&(t.relatedFeatures?.forEach((o=>X({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}))),t.relatedStatsFeatures?.forEach((o=>X({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}))))}({attributes:l,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:n,timeZone:o}))),t&&Object.keys(t).forEach((a=>{const s=t[a];l[a]=B({fieldName:a,fieldInfos:e,fieldInfoMap:i,layer:n,value:s,graphic:r,timeZone:o})})),l}async function K(e,t){const{layer:n,graphic:r,outFields:i,objectIds:a,returnGeometry:o,spatialReference:l}=e,s=a[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:n,graphic:r,objectId:s,requiredFields:i};return y().warn(e,t),null}if(!f(n)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:n,graphic:r,requiredFields:i,returnGeometry:o};return y().warn(e,t),null}const u=n.createQuery();return u.objectIds=a,u.outFields=i?.length?i:[n.objectIdField],u.returnGeometry=!!o,u.returnZ=!!o,u.returnM=!!o,u.outSpatialReference=l,(await n.queryFeatures(u,t)).features[0]}async function V({graphic:e,popupTemplate:t,layer:n,spatialReference:r},i){if(!n||!t)return;if("function"==typeof n.load&&await n.load(i),!e.attributes)return;const a=n.objectIdField,l=e.attributes[a];if(null==l)return;const u=[l],f=await t.getRequiredFields(n.fieldsIndex),c=o(f,e),d=c?[]:f.includes(a)?f:[...f,a],p=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await s(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}(t);if(c&&!p)return;const y=await K({layer:n,graphic:e,outFields:d,objectIds:u,returnGeometry:p,spatialReference:r},i);y&&(y.geometry&&(e.geometry=y.geometry),y.attributes&&(e.attributes={...e.attributes,...y.attributes}))}function W(e=""){return!!e&&e.includes(N)}function X({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:a,timeZone:o}){e&&t&&n&&Object.keys(t.attributes).forEach((l=>{const s=(u={layerId:n.relation.id.toString(),fieldName:l})?`${N}${u.layerId}/${u.fieldName}`:"";var u;const f=t.attributes[l];e[s]=B({fieldName:s,fieldInfos:r,fieldInfoMap:i,layer:a,value:f,graphic:t,timeZone:o})}))}const Y=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},ee=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=n.where?n.where:null,a=null!=n.geometry?n.geometry:null;Y(r)||Y(i)||"extent"===a?.type||"tile"===n.resultType||(n.cacheHint=!0)},te=({query:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},ne=({queryPayload:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function re(e,t,n){return e&&t&&n?"sublayer"===t.type?ae({layers:t.layer?.sublayers,map:e,relatedLayer:t,relationship:n})||ae({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:n}):ae({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||ae({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function ie(e,t){return e?.allTables.find((e=>"feature"===e.type&&e.layerId===t.id&&e.url===t.layer?.url))}function ae({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:i}){if(!i)return null;for(const a of i){if("map-image"===a.type){const n=ae({layers:a.sublayers,map:e,relatedLayer:r,relationship:t})||ae({layers:a.subtables,map:e,relatedLayer:r,relationship:t});if(n)return n;continue}if(!D(a))continue;if("sublayer"===r.type){if(a!==r&&a.id===n)return a.isTable?ie(e,a):a;continue}const i="scene"===r.type&&r.associatedLayer?r.associatedLayer.url:r.url;if(!i)return null;if("sublayer"!==a.type){if(a!==r&&a.url===i&&a.layerId===n)return a}else if(a!==r&&a.layer?.url===i&&a.id===n)return a.isTable?ie(e,a):a}return null}function oe(e){const t=e.getObjectId();return null!=t?`oid:${t}`:`uid:${e.uid}`}export{j as a,q as b,z as c,L as d,x as e,re as f,oe as g,W as h,D as i,$ as j,R as k,A as l,E as m,G as n,H as o,_ as p,P as q,Q as r,M as s,K as t,S as u,V as v,J as w,te as x,ne as y,v as z};

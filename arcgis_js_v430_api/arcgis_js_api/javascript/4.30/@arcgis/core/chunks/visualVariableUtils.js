/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../Color.js";import t from"../Graphic.js";import{n as o}from"./compilerUtils.js";import{L as s}from"./Logger.js";import{m as r}from"./lengthUtils.js";import{T as i,I as a,i as n,a as l}from"./sizeVariableUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"../core/lang.js";import"../config.js";import"./tslib.es6.js";import"../geometry.js";import"../geometry/Extent.js";import"../core/accessorSupport/decorators/property.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";const p=()=>s.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),m=e=>p().warn(`The visualVariable should be an instance of esri.renderers.visualVariables.${e}`),c=()=>p().error("Use of arcade expressions requires an arcade context"),u=new t,j=Math.PI,b=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function d(t,o,s){const r="visualVariables"in t&&t.visualVariables?t.visualVariables.find((e=>"color"===e.type)):t;if(!r)return;if("esri.renderers.visualVariables.ColorVariable"!==r.declaredClass)return void m("ColorVariable");const i="number"==typeof o,a=i?null:o,n=a?.attributes;let l=i?o:null;const p=r.field,{ipData:u,hasExpression:j}=r.cache;let b=r.cache.compiledFunc;if(!p&&!j){const e=r.stops;return e&&e[0]&&e[0].color}if("number"!=typeof l)if(j){if(null==s?.arcade)return void c();const e={viewingMode:s.viewingMode,scale:s.scale,spatialReference:s.spatialReference},t=s.arcade.arcadeUtils,o=t.getViewInfo(e),i=t.createExecContext(a,o,s.timeZone);if(!b){const e=t.createSyntaxTree(r.valueExpression);b=t.createFunction(e),r.cache.compiledFunc=b}l=t.executeFunction(b,i)}else n&&(l=n[p]);const d=r.normalizationField,y=null!=n&&null!=d?parseFloat(n[d]):void 0;if(null!=l&&(!d||i||!isNaN(y)&&0!==y)){isNaN(y)||i||(l/=y);const t=D(l,u);if(t){const o=t[0],i=t[1],a=o===i?r.stops[o].color:e.blendColors(r.stops[o].color,r.stops[i].color,t[2],null!=s?s.color:void 0);return new e(a)}}}function y(e,t,o){const s="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!s)return;if("esri.renderers.visualVariables.OpacityVariable"!==s.declaredClass)return void m("OpacityVariable");const r="number"==typeof t,i=r?null:t,a=i?.attributes;let n=r?t:null;const l=s.field,{ipData:p,hasExpression:u}=s.cache;let j=s.cache.compiledFunc;if(!l&&!u){const e=s.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof n)if(u){if(null==o?.arcade)return void c();const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,r=t.getViewInfo(e),a=t.createExecContext(i,r,o.timeZone);if(!j){const e=t.createSyntaxTree(s.valueExpression);j=t.createFunction(e),s.cache.compiledFunc=j}n=t.executeFunction(j,a)}else a&&(n=a[l]);const b=s.normalizationField,d=null!=a&&null!=b?parseFloat(a[b]):void 0;if(null!=n&&(!b||r||!isNaN(d)&&0!==d)){isNaN(d)||r||(n/=d);const e=D(n,p);if(e){const t=e[0],o=e[1];if(t===o)return s.stops[t].opacity;{const r=s.stops[t].opacity;return r+(s.stops[o].opacity-r)*e[2]}}}}function f(e,t,o){const s="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!s)return;if("esri.renderers.visualVariables.RotationVariable"!==s.declaredClass)return void m("RotationVariable");const r=s.axis||"heading",i="heading"===r&&"arithmetic"===s.rotationType?90:0,a="heading"===r&&"arithmetic"===s.rotationType?-1:1,n="number"==typeof t?null:t,l=n?.attributes,p=s.field,{hasExpression:u}=s.cache;let j=s.cache.compiledFunc,b=0;if(!p&&!u)return b;if(u){if(null==o?.arcade)return void c();const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,r=t.getViewInfo(e),i=t.createExecContext(n,r,o.timeZone);if(!j){const e=t.createSyntaxTree(s.valueExpression);j=t.createFunction(e),s.cache.compiledFunc=j}b=t.executeFunction(j,i)}else l&&(b=l[p]||0);return b="number"!=typeof b||isNaN(b)?null:i+a*b,b}function h(e,t,o){const s="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!s)return;if("esri.renderers.visualVariables.SizeVariable"!==s.declaredClass)return void m("SizeVariable");const r=function(e,t,o){const s="number"==typeof t,r=s?null:t,i=r?.attributes;let l=s?t:null;const{isScaleDriven:p}=e.cache;let m=e.cache.compiledFunc;if(p){const t=null!=o?o.scale:void 0,s=null!=o?o.view:void 0;l=null==t||"3d"===s?function(e){let t=null,o=null;const s=e.stops;return s?(t=s[0].value,o=s[s.length-1].value):(t=e.minDataValue||0,o=e.maxDataValue||0),(t+o)/2}(e):t}else if(!s)switch(e.inputValueType){case a.Expression:{if(null==o?.arcade)return void c();const t={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},s=o.arcade.arcadeUtils,i=s.getViewInfo(t),a=s.createExecContext(r,i,o.timeZone);if(!m){const t=s.createSyntaxTree(e.valueExpression);m=s.createFunction(t),e.cache.compiledFunc=m}l=s.executeFunction(m,a);break}case a.Field:i&&(l=i[e.field]);break;case a.Unknown:l=null}if(!n(l))return null;if(s||!e.normalizationField)return l;const u=i?parseFloat(i[e.normalizationField]):null;return n(u)&&0!==u?l/u:null}(s,t,o),i=g(r,s,t,o,s.cache.ipData);return null==i||isNaN(i)?0:i}function v(e,t,o){return null==e?null:l(e)?h(e,t,o):n(e)?e:null}function S(e,t,o){return n(o)&&e>o?o:n(t)&&e<t?t:e}function g(e,t,o,s,a){switch(t.transformationType){case i.Additive:return function(e,t,o,s){return e+((v(t.minSize,o,s)||t.minDataValue)??0)}(e,t,o,s);case i.Constant:return function(e,t,o){const s=e.stops;let r=s?.length&&s[0].size;return null==r&&(r=e.minSize),v(r,t,o)}(t,o,s);case i.ClampedLinear:return function(e,t,o,s){const r=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),i=v(t.minSize,o,s),a=v(t.maxSize,o,s),n=null!=s?s.shape:void 0;if(e<=t.minDataValue)return i;if(e>=t.maxDataValue)return a;if(null==i||null==a)return null;if("area"===t.scaleBy&&n){const e="circle"===n,t=e?j*(i/2)**2:i*i,o=t+r*((e?j*(a/2)**2:a*a)-t);return e?2*Math.sqrt(o/j):Math.sqrt(o)}return i+r*(a-i)}(e,t,o,s);case i.Proportional:return function(e,t,o,s){const r=null!=s?s.shape:void 0,i=e/t.minDataValue,a=v(t.minSize,o,s),n=v(t.maxSize,o,s);let l=null;return l="circle"===r?2*Math.sqrt(i*(a/2)**2):"square"===r||"diamond"===r||"image"===r?Math.sqrt(i*a**2):i*a,S(l,a,n)}(e,t,o,s);case i.Stops:return function(e,t,o,s,r){const[i,a,n]=D(e,r);if(i===a)return v(t.stops?.[i].size,o,s);{const e=v(t.stops?.[i].size,o,s);return e+(v(t.stops?.[a].size,o,s)-e)*n}}(e,t,o,s,a);case i.RealWorldSize:return function(e,t,o,s){const i=(s?.resolution??1)*r[t.valueUnit],a=v(t.minSize,o,s),n=v(t.maxSize,o,s),{valueRepresentation:l}=t;let p=null;return p="area"===l?2*Math.sqrt(e/j)/i:"radius"===l||"distance"===l?2*e/i:e/i,S(p,a,n)}(e,t,o,s);case i.Identity:return e;case i.Unknown:return null}}function x(e,t,o){const{isScaleDriven:s}=e.cache;if(!(s&&"3d"===o||t))return null;const r={scale:t,view:o};let i=v(e.minSize,u,r),a=v(e.maxSize,u,r);if(null!=i||null!=a){if(i>a){const e=a;a=i,i=e}return{minSize:i,maxSize:a}}}function V(e,t,o){if(!e.visualVariables)return;const s=[],r=[],i=[],a=[],n=[];for(const t of e.visualVariables)switch(t.type){case"color":r.push(t);break;case"opacity":i.push(t);break;case"rotation":n.push(t);break;case"size":a.push(t)}return r.forEach((e=>{const r=d(e,t,o);s.push({variable:e,value:r})})),i.forEach((e=>{const r=y(e,t,o);s.push({variable:e,value:r})})),n.forEach((e=>{const r=f(e,t,o);s.push({variable:e,value:r})})),a.forEach((e=>{const r=h(e,t,o);s.push({variable:e,value:r})})),s.filter((e=>null!=e.value))}function D(e,t){if(!t)return;let o=0,s=t.length-1;return t.some(((t,r)=>e<t?(s=r,!0):(o=r,!1))),[o,s,(e-t[o])/(t[s]-t[o])]}function U(e,t,s){const r=["proportional","proportional","proportional"];for(const i of e){const e=i.useSymbolValue?"symbol-value":h(i,t,s);switch(i.axis){case"width":r[0]=e;break;case"depth":r[1]=e;break;case"height":r[2]=e;break;case"width-and-depth":r[0]=e,r[1]=e;break;case"all":case void 0:case null:r[0]=e,r[1]=e,r[2]=e;break;default:o(i.axis)}}return r}export{U as getAllSizes,d as getColor,y as getOpacity,f as getRotationAngle,h as getSize,g as getSizeForValue,v as getSizeFromNumberOrVariable,x as getSizeRangeAtScale,V as getVisualVariableValues,b as viewScaleRE};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{u as t}from"./originUtils.js";import r from"../portal/Portal.js";import a from"../portal/PortalItem.js";import{c as o}from"./jsonContext.js";import{b as i,t as s}from"./portalItemUtils.js";import{v as n}from"./saveAPIKeyUtils.js";import{e as l}from"./saveUtils.js";async function p(t){const{layer:r,errorNamePrefix:a,validateLayer:o}=t;await r.load(),function(t,r,a){const o=a(t);if(!o.isValid)throw new e(`${r}:invalid-parameters`,o.errorMessage,{layer:t})}(r,a,o)}function m(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function c(t){const{item:r,errorNamePrefix:a,layer:o,validateItem:i}=t;if(n(r),function(t){const{item:r,itemType:a,additionalItemType:o,errorNamePrefix:i,layer:s}=t,n=[a];if(o&&n.push(o),!n.includes(r.type)){const t=n.map((e=>`'${e}'`)).join(", ");throw new e(`${i}:portal-item-wrong-type`,`Portal item type should be one of: "${t}"`,{item:r,layer:s})}}(t),i){const t=i(r);if(!t.isValid)throw new e(`${a}:invalid-parameters`,t.errorMessage,{layer:o})}}function f(e){return o(e,"portal-item")}async function u(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),l(t,{errorName:"layer-write:unsupported"},r),a}function d(e){i(e,s.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function y(r,a){const{layer:o,createItemData:i,createJSONContext:s,setItemProperties:n,saveResources:l,supplementalUnsupportedErrors:y}=r;await p(r),function(t){const{layer:r,errorNamePrefix:a}=t,{portalItem:o}=r;if(!o)throw new e(`${a}:portal-item-not-set`,m(r,"requires the portalItem property to be set"));if(!o.loaded)throw new e(`${a}:portal-item-not-loaded`,m(r,"cannot be saved to a portal item that does not exist or is inaccessible"));c({...t,item:o})}(r);const w=o.portalItem,I=s?s(w):f(w),v=await u(o,I,{...a,supplementalUnsupportedErrors:y}),P=await i({layer:o,layerJSON:v},w);return await(n?.(o,w)),d(w),await w.update({data:P}),t(I),await(l?.(w,I)),w}async function w(e,o){const{layer:i,createItemData:s,createJSONContext:n,setItemProperties:l,saveResources:m,supplementalUnsupportedErrors:y}=e;await p(e);const w=function(e){const{newItem:t,itemType:o}=e;let i=a.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=o,i.portal??=r.getDefault(),c({...e,item:i}),i}(e),I=n?n(w):f(w),v=await u(i,I,{...o,supplementalUnsupportedErrors:y}),P=await s({layer:i,layerJSON:v},w);return await l(i,w),d(w),await async function(e,t,r){const a=e.portal;await a.signIn(),await(a.user?.addItem({item:e,data:t,folder:r?.folder}))}(w,P,o),i.portalItem=w,t(I),await(m?.(w,I)),w}export{w as a,y as s};

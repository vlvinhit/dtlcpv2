/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{A as e}from"./TimeOnly.js";import{p as t,P as r,Q as s,x as i,D as o,A as n,E as a,s as l,C as m,a4 as p,_ as u,O as c,a5 as f,R as d,W as y,t as j,w as h,a1 as g,u as b,o as I,z as w,I as F,a6 as D,a7 as S,a8 as T,a9 as x,aa as E}from"./arcadeUtils.js";import{c as C,a as L,F as U,b as A,O as P,d as v,T as N,e as R,f as M,g as $,h as k,S as O,i as Z,j as V,A as z,k as B}from"./featureSetUtils.js";import{I as G}from"./ImmutableArray.js";import{g as H}from"./portalUtils.js";import{E as Q,i as W}from"./SpatialFilter.js";import{isPromiseLike as q}from"../core/promiseUtils.js";import{WhereClause as _}from"../core/sql/WhereClause.js";import K from"../layers/FeatureLayer.js";import J from"../layers/support/Field.js";import Y from"../portal/Portal.js";import"./Logger.js";import"../config.js";import"../core/lang.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./locale.js";import"./handleUtils.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./utils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./number2.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"../layers/support/FieldsIndex.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./timeZoneUtils.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./hash.js";import"./uuid.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./MD5.js";import"./executeQuery.js";import"./infoFor3D.js";import"./DataLayerSource.js";import"./executeQueryJSON.js";import"./utils8.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils9.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./executeQueryPBF.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./executeForIds.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../layers/support/FeatureType.js";import"../layers/support/FeatureTemplate.js";import"../layers/Layer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../geometry/geometryEngineAsync.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"./_commonjsHelpers.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"./compilerUtils.js";import"./lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./defaults.js";import"./defaultsJSON.js";import"../renderers/DictionaryRenderer.js";import"./LRUCache.js";import"./MemCache.js";import"./Version.js";import"./OverrideHelper.js";import"./colorUtils2.js";import"./vec4.js";import"./vec4f64.js";import"./utils7.js";import"./quantizationUtils.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"./layerContainerType.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DatePickerInput.js";import"../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/inputs/TimePickerInput.js";import"../form/elements/RelationshipElement.js";import"../form/elements/TextElement.js";import"./formUtils.js";import"./editsZScale.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"../layers/mixins/CustomParametersMixin.js";import"./EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"./commonProperties2.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"./featureLayerUtils.js";import"./featureQueryAll.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./serviceCapabilitiesUtils.js";import"../layers/support/Subtype.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"./clusterUtils.js";import"../layers/mixins/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"./OrderByInfo.js";import"../layers/mixins/PortalLayer.js";import"./portalItemUtils.js";import"../geometry/projection.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"./fieldProperties.js";import"./labelingInfo.js";import"./versionUtils.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./interfaces2.js";async function X(e,t,r){const s=e.getVariables();if(s.length>0){const i=[];for(let e=0;e<s.length;e++){const o={name:s[e]};i.push(await t.evaluateIdentifier(r,o))}const o={};for(let e=0;e<s.length;e++)o[s[e]]=i[e];return e.parameters=o,e}return e}function ee(e,t,r=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return r}function te(e){if(null===e)return null;const t={type:ee(e,"type",""),name:ee(e,"name","")};if("range"===t.type)t.range=ee(e,"range",[]);else{t.codedValues=[];for(const r of ee(e,"codedValues",[]))t.codedValues.push({name:ee(r,"name",""),code:ee(r,"code",null)})}return t}function re(e){if(null===e)return null;const t={},r=ee(e,"wkt");null!==r&&(t.wkt=r);const s=ee(e,"wkid");return null!==s&&(t.wkid=s),t}function se(e){if(null===e)return null;const t={hasZ:ee(e,"hasz",!1),hasM:ee(e,"hasm",!1)},r=ee(e,"spatialreference");null!=r&&(t.spatialReference=re(r));const s=ee(e,"x",null);if(null!==s)return t.x=s,t.y=ee(e,"y",null),t.hasZ&&(t.z=ee(e,"z",null)),t.hasM&&(t.m=ee(e,"m",null)),t;const i=ee(e,"rings",null);if(null!==i)return t.rings=i,t;const o=ee(e,"paths",null);if(null!==o)return t.paths=o,t;const n=ee(e,"points",null);if(null!==n)return t.points=n,t;for(const r of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=ee(e,r,null);null!==s&&(t[r]=s)}return t}function ie(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}function oe(oe){"async"===oe.mode&&(oe.functions.timezone=function(c,f){return oe.standardFunctionAsync(c,f,(async(d,y,j)=>{if(t(j,1,2,c,f),r(j[0]))return"Unknown";if(s(j[0]))return"Unknown";if(i(j[0])){if(await j[0].load(),1===j.length||null===j[1])return j[0].datesInUnknownTimezone?ie("unknown"):ie(j[0].dateFieldsTimeZone);if(!(j[1]instanceof o)||!1===j[1].hasField("type"))throw new n(c,a.InvalidParameter,f);const e=j[1].field("type");if(!1===l(e))throw new n(c,a.InvalidParameter,f);switch(m(e).toLowerCase()){case"preferredtimezone":return ie(j[0].preferredTimeZone);case"editfieldsinfo":return ie(j[0].editFieldsInfo?.timeZone??null);case"timeinfo":return ie(j[0].timeInfo?.timeZone??null);case"field":if(j[1].hasField("fieldname")&&l(j[1].field("fieldname")))return ie(j[0].fieldTimeZone(m(j[1].field("fieldname"))))}throw new n(c,a.InvalidParameter,f)}const h=p(j[0],u(c));if(null===h)return null;const g=h.timeZone;return"system"===g?e.systemTimeZoneCanonicalName:"utc"===g.toLowerCase()?"UTC":"unknown"===g.toLowerCase()?"Unknown":g}))},oe.functions.sqltimestamp=function(e,r){return oe.standardFunctionAsync(e,r,(async(o,l,p)=>{t(p,1,3,e,r);const u=p[0];if(c(u)){if(1===p.length)return u.toSQLWithKeyword();if(2===p.length)return u.changeTimeZone(m(p[1])).toSQLWithKeyword();throw new n(e,a.InvalidParameter,r)}if(s(u))return u.toSQLWithKeyword();if(i(u)){if(3!==p.length)throw new n(e,a.InvalidParameter,r);await u.load();const t=m(p[1]);if(s(p[2]))return p[2].toSQLWithKeyword();if(!1===c(p[2]))throw new n(e,a.InvalidParameter,r);const i=u.fieldTimeZone(t);return null===i?p[2].toSQLWithKeyword():p[2].changeTimeZone(i).toSQLWithKeyword()}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"sqltimestamp",min:2,max:4}),oe.functions.featuresetbyid=function(e,r){return oe.standardFunctionAsync(e,r,((s,i,o)=>{if(t(o,2,4,e,r),f(o[0])){const t=m(o[1]);let s=d(o[2],null);const i=y(d(o[3],!0));if(null===s&&(s=["*"]),!1===j(s))throw new n(e,a.InvalidParameter,r);return o[0].featureSetById(t,i,s)}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"featuresetbyid",min:2,max:4}),oe.functions.getfeatureset=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,i,o)=>{if(t(o,1,2,e,r),h(o[0])){let t=d(o[1],"datasource");return null===t&&(t="datasource"),t=m(t).toLowerCase(),C(o[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference??null)}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"getfeatureset",min:1,max:2}),oe.functions.featuresetbyportalitem=function(e,r){return oe.standardFunctionAsync(e,r,((s,i,o)=>{if(t(o,2,5,e,r),null===o[0])throw new n(e,a.PortalRequired,r);if(o[0]instanceof g){const t=m(o[1]),s=m(o[2]);let i=d(o[3],null);const l=y(d(o[4],!0));if(null===i&&(i=["*"]),!1===j(i))throw new n(e,a.InvalidParameter,r);let p;return p=e.services?.portal?e.services.portal:Y.getDefault(),p=H(o[0],p),L(t,s,e.spatialReference??null,i,l,p,e.lrucache,e.interceptor)}if(!1===l(o[0]))throw new n(e,a.PortalRequired,r);const p=m(o[0]),u=m(o[1]);let c=d(o[2],null);const f=y(d(o[3],!0));if(null===c&&(c=["*"]),!1===j(c))throw new n(e,a.InvalidParameter,r);return L(p,u,e.spatialReference??null,c,f,e.services?.portal??Y.getDefault(),e.lrucache,e.interceptor)}))},oe.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),oe.functions.featuresetbyname=function(e,r){return oe.standardFunctionAsync(e,r,((s,i,o)=>{if(t(o,2,4,e,r),f(o[0])){const t=m(o[1]);let s=d(o[2],null);const i=y(d(o[3],!0));if(null===s&&(s=["*"]),!1===j(s))throw new n(e,a.InvalidParameter,r);return o[0].featureSetByName(t,i,s)}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"featuresetbyname",min:2,max:4}),oe.functions.featureset=function(e,r){return oe.standardFunction(e,r,((s,i,m)=>{t(m,1,1,e,r);const p={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(l(m[0])){const e=JSON.parse(m[0]);void 0!==e.layerDefinition?(p.layerDefinition=e.layerDefinition,p.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(p.layerDefinition.spatialReference=e.layerDefinition.spatialReference)):(p.featureSet.features=e.features,p.featureSet.geometryType=e.geometryType,p.layerDefinition.geometryType=p.featureSet.geometryType,p.layerDefinition.objectIdField=e.objectIdFieldName??"",p.layerDefinition.typeIdField=e.typeIdFieldName,p.layerDefinition.globalIdField=e.globalIdFieldName,p.layerDefinition.fields=e.fields,e.spatialReference&&(p.layerDefinition.spatialReference=e.spatialReference))}else{if(!(m[0]instanceof o))throw new n(e,a.InvalidParameter,r);{const t=JSON.parse(m[0].castToText(!0)),s=ee(t,"layerdefinition");if(null!==s){p.layerDefinition.geometryType=ee(s,"geometrytype",""),p.featureSet.geometryType=p.layerDefinition.geometryType,p.layerDefinition.globalIdField=ee(s,"globalidfield",""),p.layerDefinition.objectIdField=ee(s,"objectidfield",""),p.layerDefinition.typeIdField=ee(s,"typeidfield",""),p.layerDefinition.hasZ=!0===ee(s,"hasz",!1),p.layerDefinition.hasM=!0===ee(s,"hasm",!1);const e=ee(s,"spatialreference");e&&(p.layerDefinition.spatialReference=re(e));const r=[];for(const e of ee(s,"fields",[])){const t={name:ee(e,"name",""),alias:ee(e,"alias",""),type:ee(e,"type",""),nullable:ee(e,"nullable",!0),editable:ee(e,"editable",!0),length:ee(e,"length",null),domain:te(ee(e,"domain"))};r.push(t)}p.layerDefinition.fields=r;const i=ee(t,"featureset");if(i){const e={};for(const t of r)e[t.name.toLowerCase()]=t.name;for(const t of ee(i,"features",[])){const r={},s=ee(t,"attributes",{});for(const t in s)r[e[t.toLowerCase()]]=s[t];p.featureSet.features.push({attributes:r,geometry:se(ee(t,"geometry"))})}}}else{p.layerDefinition.hasZ=!0===ee(t,"hasz",!1),p.layerDefinition.hasM=!0===ee(t,"hasm",!1),p.layerDefinition.geometryType=ee(t,"geometrytype",""),p.featureSet.geometryType=p.layerDefinition.geometryType,p.layerDefinition.objectIdField=ee(t,"objectidfieldname",""),p.layerDefinition.typeIdField=ee(t,"typeidfieldname","");const s=ee(t,"spatialreference");s&&(p.layerDefinition.spatialReference=re(s));const i=[],o=ee(t,"fields",null);if(!j(o))throw new n(e,a.InvalidParameter,r);for(const e of o){const t={name:ee(e,"name",""),alias:ee(e,"alias",""),type:ee(e,"type",""),nullable:ee(e,"nullable",!0),editable:ee(e,"editable",!0),length:ee(e,"length",null),domain:te(ee(e,"domain"))};i.push(t)}p.layerDefinition.fields=i;const l={};for(const e of i)l[e.name.toLowerCase()]=e.name;let m=ee(t,"features",null);if(j(m))for(const e of m){const t={},r=ee(e,"attributes",{});for(const e in r)t[l[e.toLowerCase()]]=r[e];p.featureSet.features.push({attributes:t,geometry:se(ee(e,"geometry",null))})}else m=null,p.featureSet.features=m}}}if(0==(!!(u=p).layerDefinition&&!!u.featureSet&&!1!==function(e,t){for(const t of["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(u.layerDefinition.geometryType)&&!1!==j(u.layerDefinition.fields)&&!1!==j(u.featureSet.features)))throw new n(e,a.InvalidParameter,r);var u;return p.layerDefinition.geometryType||(p.layerDefinition.geometryType="esriGeometryNull"),U.create(p,e.spatialReference)}))},oe.signatures.push({name:"featureset",min:1,max:1}),oe.functions.filter=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,l)=>{if(t(l,2,2,e,r),j(l[0])||b(l[0])){const t=[];let s,i=l[0];if(i instanceof G&&(i=i.toArray()),!I(l[1]))throw new n(e,a.InvalidParameter,r);s=l[1].createFunction(e);for(const e of i){const r=s(e);q(r)?!0===await r&&t.push(e):!0===r&&t.push(e)}return t}if(i(l[0])){const t=await l[0].load(),r=_.create(l[1],t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC),s=r.getVariables();if(s.length>0){const t=[];for(let r=0;r<s.length;r++){const i={name:s[r]};t.push(await oe.evaluateIdentifier(e,i))}const i={};for(let e=0;e<s.length;e++)i[s[e]]=t[e];return r.parameters=i,new A({parentfeatureset:l[0],whereclause:r})}return new A({parentfeatureset:l[0],whereclause:r})}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"filter",min:2,max:2}),oe.functions.orderby=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,l)=>{if(t(l,2,2,e,r),i(l[0])){const e=new P(l[1]);return new v({parentfeatureset:l[0],orderbyclause:e})}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"orderby",min:2,max:2}),oe.functions.top=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,l)=>{if(t(l,2,2,e,r),i(l[0]))return new N({parentfeatureset:l[0],topnum:l[1]});if(j(l[0]))return w(l[1])>=l[0].length?l[0].slice(0):l[0].slice(0,w(l[1]));if(b(l[0]))return w(l[1])>=l[0].length()?l[0].slice(0):l[0].slice(0,w(l[1]));throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"top",min:2,max:2}),oe.functions.first=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,n)=>{if(t(n,1,1,e,r),i(n[0])){const t=await n[0].first(s.abortSignal);if(null!==t){const r=F.createFromGraphicLikeObject(t.geometry,t.attributes,n[0],e.timeZone);return r._underlyingGraphic=t,r}return t}return j(n[0])?0===n[0].length?null:n[0][0]:b(n[0])?0===n[0].length()?null:n[0].get(0):null}))},oe.signatures.push({name:"first",min:1,max:1}),oe.functions.attachments=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,l,m)=>{t(m,1,2,e,r);const p={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(m.length>1)if(m[1]instanceof o){if(m[1].hasField("minsize")&&(p.minsize=w(m[1].field("minsize"))),m[1].hasField("metadata")&&(p.returnMetadata=y(m[1].field("metadata"))),m[1].hasField("maxsize")&&(p.maxsize=w(m[1].field("maxsize"))),m[1].hasField("types")){const e=D(m[1].field("types"),!1);e.length>0&&(p.types=e)}}else if(null!==m[1])throw new n(e,a.InvalidParameter,r);if(h(m[0])){let t=m[0]._layer;return t instanceof K&&(t=R(t,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===t||!1===i(t)?[]:(await t.load(),t.queryAttachments(m[0].field(t.objectIdField),p.minsize,p.maxsize,p.types,p.returnMetadata))}if(null===m[0])return[];throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"attachments",min:1,max:2}),oe.functions.featuresetbyrelationshipname=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,l)=>{t(l,2,4,e,r);const p=l[0],u=m(l[1]);let c=d(l[2],null);const f=y(d(l[3],!0));if(null===c&&(c=["*"]),!1===j(c))throw new n(e,a.InvalidParameter,r);if(null===l[0])return null;if(!h(l[0]))throw new n(e,a.InvalidParameter,r);let g=p._layer;if(g instanceof K&&(g=R(g,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===g)return null;if(!1===i(g))return null;g=await g.load();const b=g.relationshipMetaData().filter((e=>e.name===u));if(0===b.length)return null;if(void 0!==b[0].relationshipTableId&&null!==b[0].relationshipTableId&&b[0].relationshipTableId>-1)return M(g,b[0],p.field(g.objectIdField),g.spatialReference,c,f,e.lrucache,e.interceptor);let I=g.serviceUrl();if(!I)return null;I="/"===I.charAt(I.length-1)?I+b[0].relatedTableId.toString():I+"/"+b[0].relatedTableId.toString();const w=await $(I,g.spatialReference,c,f,e.lrucache,e.interceptor);await w.load();let F=w.relationshipMetaData();if(F=F.filter((e=>e.id===b[0].id)),!1===p.hasField(b[0].keyField)||null===p.field(b[0].keyField)){const e=await g.getFeatureByObjectId(p.field(g.objectIdField),[b[0].keyField]);if(e){const t=_.create(F[0].keyField+"= @id",w.getFieldsIndex(),w.dateFieldsTimeZoneDefaultUTC);return t.parameters={id:e.attributes[b[0].keyField]},w.filter(t)}return new Q({parentfeatureset:w})}const D=_.create(F[0].keyField+"= @id",w.getFieldsIndex(),w.dateFieldsTimeZoneDefaultUTC);return D.parameters={id:p.field(b[0].keyField)},w.filter(D)}))},oe.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),oe.functions.featuresetbyassociation=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,p)=>{t(p,2,3,e,r);const u=p[0],c=m(d(p[1],"")).toLowerCase(),f=l(p[2])?m(p[2]):null;if(null===p[0])return null;if(!h(p[0]))throw new n(e,a.InvalidParameter,r);let y=u._layer;if(y instanceof K&&(y=R(y,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===y)return null;if(!1===i(y))return null;await y.load();const j=y.serviceUrl(),g=await k(j,e.spatialReference);let b=null,I=null,w=!1;if(null!==f&&""!==f&&void 0!==f){for(const e of g.terminals)e.terminalName===f&&(I=e.terminalId);null===I&&(w=!0)}const F=g.associations.getFieldsIndex(),D=F.get("TOGLOBALID").name,x=F.get("FROMGLOBALID").name,E=F.get("TOTERMINALID").name,C=F.get("FROMTERMINALID").name,L=F.get("FROMNETWORKSOURCEID").name,U=F.get("TONETWORKSOURCEID").name,A=F.get("ASSOCIATIONTYPE").name,P=F.get("ISCONTENTVISIBLE").name,v=F.get("OBJECTID").name;for(const e of y.fields)if("global-id"===e.type){b=u.field(e.name);break}let N=null,M=new O(new J({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC)),$=new O(new J({name:"side",alias:"side",type:"string"}),_.create("''",g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC));const G="globalid",H="globalId",Q={};for(const e in g.lkp)Q[e]=g.lkp[e].sourceId;const W=new Z(new J({name:"classname",alias:"classname",type:"string"}),null,Q);let q="";switch(c){case"midspan":{q=`((${D}='${b}') OR ( ${x}='${b}')) AND (${A} IN (5))`,W.codefield=_.create(`CASE WHEN (${D}='${b}') THEN ${L} ELSE ${U} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC);const e=T(z.findField(g.associations.fields,x));e.name=G,e.alias=G,N=new O(e,_.create(`CASE WHEN (${x}='${b}') THEN ${D} ELSE ${x} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC)),M=g.unVersion>=4?new B(z.findField(g.associations.fields,F.get("PERCENTALONG").name)):new O(new J({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{q=`((${D}='${b}') OR ( ${x}='${b}')) AND (${A} IN (4,6))`,W.codefield=_.create(`CASE WHEN (${D}='${b}') THEN ${L} ELSE ${U} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC);const e=T(z.findField(g.associations.fields,x));e.name=G,e.alias=G,N=new O(e,_.create(`CASE WHEN (${x}='${b}') THEN ${D} ELSE ${x} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC)),$=new O(new J({name:"side",alias:"side",type:"string"}),_.create(`CASE WHEN (${A}=4) THEN 'from' ELSE 'to' END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let e=`${D}='@T'`,t=`${x}='@T'`;null!==I&&(e+=` AND ${E}=@A`,t+=` AND ${C}=@A`),q="(("+e+") OR ("+t+"))",q=S(q,"@T",b??""),e=S(e,"@T",b??""),null!==I&&(e=S(e,"@A",I.toString()),q=S(q,"@A",I.toString())),W.codefield=_.create("CASE WHEN "+e+` THEN ${L} ELSE ${U} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC);const r=T(z.findField(g.associations.fields,x));r.name=G,r.alias=G,N=new O(r,_.create("CASE WHEN "+e+` THEN ${x} ELSE ${D} END`,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":q=`${D}='${b}' AND ${A} = 2`,null!==I&&(q+=` AND ${E} = `+I.toString()),W.codefield=L,q="( "+q+" )",N=new V(z.findField(g.associations.fields,x),G,G);break;case"content":q=`(${x}='${b}' AND ${A} = 2)`,null!==I&&(q+=` AND ${C} = `+I.toString()),W.codefield=U,q="( "+q+" )",N=new V(z.findField(g.associations.fields,D),G,G);break;case"structure":q=`(${D}='${b}' AND ${A} = 3)`,null!==I&&(q+=` AND ${E} = `+I.toString()),W.codefield=L,q="( "+q+" )",N=new V(z.findField(g.associations.fields,x),G,H);break;case"attached":q=`(${x}='${b}' AND ${A} = 3)`,null!==I&&(q+=` AND ${C} = `+I.toString()),W.codefield=U,q="( "+q+" )",N=new V(z.findField(g.associations.fields,D),G,H);break;default:throw new n(e,a.InvalidParameter,r)}return w&&(q="1 <> 1"),new z({parentfeatureset:g.associations,adaptedFields:[new B(z.findField(g.associations.fields,v)),new B(z.findField(g.associations.fields,P)),N,$,W,M],extraFilter:q?_.create(q,g.associations.getFieldsIndex(),g.associations.dateFieldsTimeZoneDefaultUTC):null})}))},oe.signatures.push({name:"featuresetbyassociation",min:2,max:6}),oe.functions.groupby=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,p,u)=>{if(t(u,3,3,e,r),!i(u[0]))throw new n(e,a.InvalidParameter,r);const c=await u[0].load(),f=[],d=[];let y=!1,h=[];if(l(u[1]))h.push(u[1]);else if(u[1]instanceof o)h.push(u[1]);else if(j(u[1]))h=u[1];else{if(!b(u[1]))throw new n(e,a.InvalidParameter,r);h=u[1].toArray()}for(const t of h)if(l(t)){const e=_.create(m(t),c.getFieldsIndex(),c.dateFieldsTimeZoneDefaultUTC),r=!0===W(e)?m(t):"%%%%FIELDNAME";f.push({name:r,expression:e}),"%%%%FIELDNAME"===r&&(y=!0)}else{if(!(t instanceof o))throw new n(e,a.InvalidParameter,r);{const s=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",i=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===s&&(y=!0),!s)throw new n(e,a.InvalidParameter,r);f.push({name:s,expression:_.create(i||s,c.getFieldsIndex(),c.dateFieldsTimeZoneDefaultUTC)})}}if(h=[],l(u[2]))h.push(u[2]);else if(j(u[2]))h=u[2];else if(b(u[2]))h=u[2].toArray();else{if(!(u[2]instanceof o))throw new n(e,a.InvalidParameter,r);h.push(u[2])}for(const t of h){if(!(t instanceof o))throw new n(e,a.InvalidParameter,r);{const s=t.hasField("name")?t.field("name"):"",i=t.hasField("statistic")?t.field("statistic"):"",o=t.hasField("expression")?t.field("expression"):"";if(!s||!i||!o)throw new n(e,a.InvalidParameter,r);d.push({name:s,statistic:i.toLowerCase(),expression:_.create(o,c.getFieldsIndex(),c.dateFieldsTimeZoneDefaultUTC)})}}if(y){const e={};for(const t of c.fields)e[t.name.toLowerCase()]=1;for(const t of f)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of d)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of f)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of f)await X(t.expression,oe,e);for(const t of d)await X(t.expression,oe,e);return u[0].groupby(f,d)}))},oe.signatures.push({name:"groupby",min:3,max:3}),oe.functions.distinct=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,p,u)=>{if(i(u[0])){t(u,2,2,e,r);const s=await u[0].load(),i=[];let p=[];if(l(u[1]))p.push(u[1]);else if(u[1]instanceof o)p.push(u[1]);else if(j(u[1]))p=u[1];else{if(!b(u[1]))throw new n(e,a.InvalidParameter,r);p=u[1].toArray()}let c=!1;for(const t of p)if(l(t)){const e=_.create(m(t),s.getFieldsIndex(),s.dateFieldsTimeZoneDefaultUTC),r=!0===W(e)?m(t):"%%%%FIELDNAME";i.push({name:r,expression:e}),"%%%%FIELDNAME"===r&&(c=!0)}else{if(!(t instanceof o))throw new n(e,a.InvalidParameter,r);{const o=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",l=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===o&&(c=!0),!o)throw new n(e,a.InvalidParameter,r);i.push({name:o,expression:_.create(l||o,s.getFieldsIndex(),s.dateFieldsTimeZoneDefaultUTC)})}}if(c){const e={};for(const t of s.fields)e[t.name.toLowerCase()]=1;for(const t of i)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of i)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of i)await X(t.expression,oe,e);return u[0].groupby(i,[])}return function(e){if(1===e.length){if(j(e[0]))return E("distinct",e[0],-1);if(b(e[0]))return E("distinct",e[0].toArray(),-1)}return E("distinct",e,-1)}(u)}))},oe.functions.getfeaturesetinfo=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,n,a)=>{if(t(a,1,1,e,r),!i(a[0]))return null;const l=await a[0].getFeatureSetInfo();return l?o.convertObjectToArcadeDictionary({layerId:l.layerId,layerName:l.layerName,itemId:l.itemId,serviceLayerUrl:l.serviceLayerUrl,webMapLayerId:l.webMapLayerId??null,webMapLayerTitle:l.webMapLayerTitle??null,className:null,objectClassId:null},u(e),!1,!1):null}))},oe.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),oe.functions.filterbysubtypecode=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,o,l)=>{if(t(l,2,2,e,r),i(l[0])){const t=await l[0].load(),s=l[1];if(!x(s))throw new n(e,a.InvalidParameter,r);if(t.subtypeField){const e=_.create(`${t.subtypeField}= ${l[1]}`,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC);return new A({parentfeatureset:l[0],whereclause:e})}if(null===t.typeIdField||""===t.typeIdField)throw new n(e,a.FeatureSetDoesNotHaveSubtypes,r);const i=_.create(`${t.typeIdField}= ${l[1]}`,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC);return new A({parentfeatureset:l[0],whereclause:i})}throw new n(e,a.InvalidParameter,r)}))},oe.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{oe as registerFunctions};

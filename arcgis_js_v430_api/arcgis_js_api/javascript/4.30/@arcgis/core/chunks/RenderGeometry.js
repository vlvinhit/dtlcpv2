/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{h as r,c as s,N as i}from"../core/lang.js";import{s as a}from"./ensureType.js";import{c as o,f as n,d}from"./maybe.js";import{M as c,P as l}from"../core/scheduling.js";import{watch as h,syncAndInitial as u,on as m}from"../core/reactiveUtils.js";import f,{g as p,s as g}from"../core/Accessor.js";import{property as _}from"../core/accessorSupport/decorators/property.js";import{L as y}from"./Logger.js";import{subclass as v}from"../core/accessorSupport/decorators/subclass.js";import{A as C,w,m as x,i as R,v as S,t as b,G as M,c as D,d as T}from"./mat4.js";import{l as O,n as E,b as A,c as I,p as P,g as F,u as H,h as N,s as L}from"./vec3.js";import{f as j,c as G}from"./vec3f64.js";import{V}from"./ViewingMode.js";import{d as z}from"./debugFlags2.js";import{c as W,B as U,h as B,C as k,w as q,o as Z}from"./aaBoundingRect.js";import{C as Q,l as Y,h as K,i as X,m as $,e as J,d as ee,P as te,S as re,D as se,k as ie,I as ae,A as oe}from"./IntegerPassUniform.js";import{S as ne,a as de,c as ce,U as le,F as he}from"./Matrix4PassUniform.js";import ue,{C as me,s as fe}from"../views/3d/webgl/RenderCamera.js";import{c as pe,f as ge}from"./vec4f64.js";import{g as _e,N as ye}from"./interfaces3.js";import{H as ve,b as Ce,g as we,S as xe,G as Re,u as Se,h as be,a4 as Me,B as De,E as Te,j as Oe,P as Ee,R as Ae}from"./StencilUtils.js";import{c as Ie,l as Pe,a as Fe,n as He}from"./mathUtils.js";import{h as Ne}from"./unitUtils.js";import{I as Le,c as je}from"./mat4f64.js";import{d as Ge,h as Ve,a as ze}from"./axisAngleDegrees.js";import{b as We,c as Ue}from"./weather.js";import{R as Be,T as ke,n as qe}from"./Scheduler.js";import{B as Ze,S as Qe}from"./ScreenSpacePass.glsl.js";import{B as Ye}from"./BindType.js";import{F as Ke}from"./Float4DrawUniform.js";import{N as Xe}from"./NestedMap.js";import{S as $e,p as Je}from"./ShaderTechniqueConfiguration.js";import{H as et,V as tt,b as rt,S as st}from"./VertexArrayObject2.js";import{a as it,l as at,v as ot,b as nt,s as dt}from"./Util.js";import{p as ct}from"./projectBuffer.js";import{A as lt}from"./Attribute.js";import{C as ht,R as ut,D as mt}from"./Material.js";import{R as ft,W as pt,O as gt,U as _t}from"./RibbonLineMaterial.js";import{V as yt}from"./VertexAttribute.js";import{c as vt}from"./vec2f64.js";import{D as Ct,R as wt}from"./basicInterfaces.js";import{c as xt}from"./mat3f64.js";import{g as Rt,b as St,e as bt,h as Mt,p as Dt,s as Tt,d as Ot,n as Et,i as At,m as It}from"./vec2.js";import{s as Pt,t as Ft}from"./vec4.js";import{o as Ht,i as Nt,U as Lt,g as jt,c as Gt}from"./enums.js";import{T as Vt,a as zt}from"./Texture.js";import{g as Wt,N as Ut,b as Bt}from"./sphere.js";import{O as kt}from"./Intersector.js";import{S as qt,c as Zt,I as Qt}from"./Intersector2.js";import{g as Yt}from"./glUtil.js";import{R as Kt,N as Xt}from"./MemCache.js";import{B as $t}from"./BufferObject.js";import{m as Jt,b as er,a as tr,s as rr}from"./renderState.js";import{d as sr}from"./mathUtils2.js";var ir,ar,or,nr,dr,cr,lr,hr,ur,mr,fr,pr,gr,_r;!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(ir||(ir={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(ar||(ar={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(or||(or={})),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(nr||(nr={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(dr||(dr={})),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(cr||(cr={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(lr||(lr={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(hr||(hr={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(ur||(ur={}));class yr{constructor(e,t){this.vec3=e,this.id=t}}function vr(e,t,r,s){return new yr(j(e,t,r),s)}class Cr{constructor(){this._extent=W(),this.resolution=0,this.renderLocalOrigin=vr(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new wr}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];U(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];U(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,B(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class wr{constructor(){this.extents=[W(),W(),W()],this.numViews=0}}!function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(mr||(mr={}));class xr{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=o(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,r){this._handle&&this._handle.fbo?.width===t&&this._handle.fbo?.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(t,r,this._name,this._format)),e.unbindTexture(this._handle?.fbo?.colorTexture),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}}class Rr{constructor(e,t,r,s,i=Q.RGBA_MIPMAP){this.output=r,this.content=s,this.fbo=new xr(e,i,t)}get valid(){return this.fbo.valid}}class Sr{constructor(e){this.targets=[new Rr(e,"overlay color",ne.Color,mr.Color),new Rr(e,"overlay IM color",ne.Color,mr.ColorNoRasterImage),new Rr(e,"overlay highlight",ne.Highlight,mr.Highlight,Q.RGBA4),new Rr(e,"overlay water",ne.Normal,mr.WaterNormal),new Rr(e,"overlay occluded",ne.Color,mr.Occluded)],r("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new Rr(e,"overlay oid",ne.ObjectAndLayerIdColor,mr.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,r)=>t.valid?e|=1<<r:e),0)}}class br extends Y{constructor(){super(...arguments),this.slicePlaneLocalOrigin=G(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}}!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"}(fr||(fr={}));class Mr extends br{constructor(){super(...arguments),this.identifier=fr.Material,this.output=ne.Color,this.transparent=!1}}class Dr extends br{constructor(){super(...arguments),this.identifier=fr.ShadowMap}}class Tr extends br{constructor(){super(...arguments),this.identifier=fr.Highlight}}class Or extends br{constructor(){super(...arguments),this.identifier=fr.ViewshedShadowMap}}function Er(e){e.fragment.code.add(_e`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function Ar(e){e.fragment.code.add(_e`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function Ir(e){e.fragment.code.add(_e`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}function Pr(e,t){const r=e.fragment;r.include(ve),r.uniforms.add(new Ce("nearFar",((e,t)=>t.camera.nearFar))),r.uniforms.add(new we("depthMap",((e,t)=>t.depth?.attachment))),r.uniforms.add(new de("proj",((e,t)=>t.camera.projectionMatrix))),r.uniforms.add(new ce("invResolutionHeight",((e,t)=>1/t.camera.height))),r.uniforms.add(new de("reprojectionMatrix",((e,t)=>t.ssr.reprojectionMatrix))),r.code.add(_e`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function Fr(e){return null!=e?.cubeMap}!function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"}(pr||(pr={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(gr||(gr={}));class Hr{constructor(){this.readChannels=gr.RG,this.renderingStage=pr.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=G(),this.parallax=new Nr,this.parallaxNew=new Nr,this.pointOnGround=G(),this.fadeMode=_r.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const t=this.parallax,r=O(e.eye);if(t.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-Ne.radius*Ne.radius,0))/r,Ve(Lr,t.anchorPointClouds,jr),C(t.transform,Le,jr[3],ze(jr)),this.fadeMode===_r.CROSS_FADE){const e=this.parallaxNew;Ve(Lr,e.anchorPointClouds,jr),C(e.transform,Le,jr[3],ze(jr))}}updateFading(e,t,r,s){this.isFading&&this._advanceFading(r,s),this._evaluateFading(e,t,r)}_evaluateFading(e,t,r){const s=e.relativeElevation,i=this._calculateDistanceToAnchorPoint(e);var a;if((s>1.7*We||s<-We||i>Ur)&&this.opacity>0)this._setFade(_r.HIDE,r);else if(!this.isFading)if((s>We||s<-.35*We||i>Wr)&&this.opacity>0)this._setFade(_r.FADE_OUT,r);else if(s<=We&&s>=-.35*We&&t===Be.IDLE&&null!=(a=this.data)&&!a.running){if(0===this.opacity)return void this._setFade(_r.FADE_IN,r);(i>zr||this.renderingStage===pr.FADING)&&this._setFade(_r.CROSS_FADE,r)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(e,t){if(this.fadeFactor<1)return this.fadeFactor=t?Ie((e-this.startTime)/(Vr*t),0,1):1,this.fadeMode===_r.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===_r.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===_r.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===_r.FADE_OUT&&(this.opacity=0),this.fadeMode===_r.FADE_IN&&(this.opacity=1),this.fadeMode===_r.CROSS_FADE&&(this.opacity=1),this.fadeMode=_r.NONE}_switchReadChannels(){const e=this.fadeMode===_r.CROSS_FADE&&1===this.fadeFactor,t=this.fadeMode===_r.FADE_IN&&0===this.fadeFactor;this.renderingStage===pr.FADING&&(e||t)&&(this.readChannels=1-this.readChannels,this.renderingStage=pr.FINISHED)}_calculateDistanceToAnchorPoint(e){return E(this.pointOnGround,e.eye),A(this.pointOnGround,this.pointOnGround,Ne.radius),O(I(Gr,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===_r.CROSS_FADE&&(0===this.fadeFactor&&P(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&P(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===_r.FADE_IN&&0===this.fadeFactor&&P(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,t){switch(e){case _r.HIDE:this.opacity=0;break;case _r.FADE_OUT:this.opacity=1;break;case _r.FADE_IN:this.opacity=0;break;case _r.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=t}get isFading(){return this.fadeMode===_r.FADE_OUT||this.fadeMode===_r.FADE_IN||this.fadeMode===_r.CROSS_FADE}}!function(e){e[e.NONE=0]="NONE",e[e.HIDE=1]="HIDE",e[e.FADE_OUT=2]="FADE_OUT",e[e.FADE_IN=3]="FADE_IN",e[e.CROSS_FADE=4]="CROSS_FADE"}(_r||(_r={}));class Nr{constructor(){this.anchorPointClouds=G(),this.radiusCurvatureCorrectionFactor=0,this.transform=je()}}const Lr=j(0,0,1),jr=Ge(),Gr=G(),Vr=1.25,zr=34e3,Wr=64e3,Ur=2e5;class Br extends le{constructor(e,t){super(e,"samplerCube",Ye.Pass,((r,s,i)=>r.bindTexture(e,t(s,i))))}}function kr(e){const t=e.fragment;t.uniforms.add(new de("rotationMatrixClouds",((e,t)=>t.cloudsFade.parallax.transform)),new de("rotationMatrixCloudsCrossFade",((e,t)=>t.cloudsFade.parallaxNew.transform)),new he("anchorPosition",((e,t)=>t.cloudsFade.parallax.anchorPointClouds)),new he("anchorPositionCrossFade",((e,t)=>t.cloudsFade.parallaxNew.anchorPointClouds)),new ce("cloudsHeight",(()=>Ue)),new ce("radiusCurvatureCorrectionFactor",((e,t)=>t.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new ce("totalFadeInOut",((e,t)=>1-t.cloudsFade.opacity)),new ce("crossFadeAnchorFactor",((e,t)=>Ie(t.cloudsFade.fadeFactor,0,1))),new Br("cubeMap",((e,t)=>t.cloudsFade.data?.cubeMap?.colorTexture??null)),new Ze("crossFade",((e,t)=>t.cloudsFade.fadeMode===_r.CROSS_FADE)),new Ze("readChannelsRG",((e,t)=>t.cloudsFade.readChannels===gr.RG)),new Ze("fadeTextureChannels",((e,t)=>t.cloudsFade.renderingStage===pr.FADING))),t.constants.add("planetRadius","float",Ne.radius),t.code.add(_e`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(_e`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(_e`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),K(t),X(t),t.code.add(_e`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(_e`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),t.code.add(_e`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(_e`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(_e`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function qr(e,t){e.include($,t),e.include(Ir),e.include(Ar),t.hasCloudsReflections&&e.include(kr,t),t.hasScreenSpaceReflections&&e.include(Pr,t);const r=e.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",J).add("ssrHeightFadeEnd","float",ee).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(_e`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new ce("lightingSpecularStrength",((e,t)=>t.lighting.mainLight.specularStrength)),new ce("lightingEnvironmentStrength",((e,t)=>t.lighting.mainLight.environmentStrength))),r.code.add(_e`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&r.code.add(_e`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?(r.uniforms.add(new de("view",((e,t)=>t.camera.viewMatrix)),new we("lastFrameColorTexture",((e,t)=>t.ssr.lastFrameColor?.getTexture())),new ce("fadeFactorSSR",((e,t)=>t.ssr.fadeFactor))),r.code.add(_e`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(_e`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?r.code.add(_e`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(_e`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(_e`return waterRenderedColor;
}`)}var Zr;function Qr(e,t){const{vertex:r,fragment:s}=e;r.uniforms.add(new Ke("overlayTexOffset",((e,t)=>function(e,t){const r=t.overlay?.overlays[cr.INNER]?.extent;k(r)&&(Jr[0]=e.toMapSpace[0]/q(r)-r[0]/q(r),Jr[1]=e.toMapSpace[1]/Z(r)-r[1]/Z(r));const s=t.overlay?.overlays[cr.OUTER]?.extent;return k(s)&&(Jr[2]=e.toMapSpace[0]/q(s)-s[0]/q(s),Jr[3]=e.toMapSpace[1]/Z(s)-s[1]/Z(s)),Jr}(e,t))),new Ke("overlayTexScale",((e,t)=>function(e,t){const r=t.overlay?.overlays[cr.INNER]?.extent;k(r)&&(Jr[0]=e.toMapSpace[2]/q(r),Jr[1]=e.toMapSpace[3]/Z(r));const s=t.overlay?.overlays[cr.OUTER]?.extent;return k(s)&&(Jr[2]=e.toMapSpace[2]/q(s),Jr[3]=e.toMapSpace[3]/Z(s)),Jr}(e,t)))),s.constants.add("overlayOpacity","float",1),s.uniforms.add(new we("ovColorTex",((e,t)=>$r(e,t)))),Xr(e,t)}function Yr(e,t){const{vertex:r,fragment:s}=e;r.uniforms.add(new Kr("overlayTexOffset"),new Kr("overlayTexScale")),s.uniforms.add(new ce("overlayOpacity",(e=>e.overlayOpacity)),new we("ovColorTex",((e,t)=>t.overlay?.getTexture(e.overlayContent)))),Xr(e,t)}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(Zr||(Zr={}));class Kr extends le{constructor(e){super(e,"vec4")}}function Xr(e,t){t.pbrMode!==te.Water&&t.pbrMode!==te.WaterOnIntegratedMesh&&t.pbrMode!==te.TerrainWithWater||e.include(qr,t);const{vertex:r,fragment:s}=e;e.varyings.add("vtcOverlay","vec4"),r.code.add(_e`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),s.code.add(_e`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),s.code.add(_e`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),s.code.add(_e`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.pbrMode!==te.Water&&t.pbrMode!==te.WaterOnIntegratedMesh&&t.pbrMode!==te.TerrainWithWater||(K(s),X(s),s.code.add(_e`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function $r(e,t){return e.identifier===fr.Material&&e.output===ne.Color?t.overlay?.getTexture(mr.ColorNoRasterImage):e.identifier===fr.Material&&e.output===ne.ObjectAndLayerIdColor?t.overlay?.getTexture(mr.ObjectAndLayerIdColor):e.identifier===fr.Highlight?t.overlay?.getTexture(mr.Highlight):null}const Jr=pe();class es extends ye{constructor(){super(...arguments),this.color=j(1,1,1)}}const ts=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:es,build:function(){const e=new xe;return e.include(Qe),e.fragment.uniforms.add(new we("tex",(e=>e.texture)),new he("uColor",(e=>e.color))),e.fragment.code.add(_e`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);
}`),e}},Symbol.toStringTag,{value:"Module"}));class rs{constructor(e){this._context=e,this._perConstructorInstances=new Xe,this._frameCounter=0,this._keepAliveFrameCount=is}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=as){const r=t.key;let s=this._perConstructorInstances.get(e,r);if(null==s){const i=new e(this._context,t,(()=>this.release(i)));s=new ss(i),this._perConstructorInstances.set(e,r,s)}return++s.refCount,s.technique}releaseAndAcquire(e,t,r){if(null!=r){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==is&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,r))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{e.push((async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,r))})),await Promise.all(e)}}class ss{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const is=-1,as=new $e;class os{constructor(e,t,r,s){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Xe}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const s=e.produces.get(t);if(!s?.(r))return null;let i=this._id2glMaterialRef.get(r,e.id);if(null==i){const t=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:r});i=new ns(t),this._id2glMaterialRef.set(r,e.id,i)}return i.ref(),i.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||(n(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&y.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class ns{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,it(this._refCnt>=0)}get referenced(){return this._refCnt>0}}class ds{constructor(e){this._originSR=e,this._rootOriginId="root/"+p(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=vr(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const r=this._gridSize,s=Math.round(e[0]/r),i=Math.round(e[1]/r),a=Math.round(e[2]/r),o=`${s}/${i}/${a}`;let n=this._origins.get(o);const d=.5*r;if(I(cs,e,t.vec3),cs[0]=Math.abs(cs[0]),cs[1]=Math.abs(cs[1]),cs[2]=Math.abs(cs[2]),cs[0]<d&&cs[1]<d&&cs[2]<d){if(n){const t=Math.max(...cs);if(I(cs,e,n.vec3),cs[0]=Math.abs(cs[0]),cs[1]=Math.abs(cs[1]),cs[2]=Math.abs(cs[2]),Math.max(...cs)<t)return n}return t}return n||(n=vr(s*r,i*r,a*r,o),this._origins.set(o,n)),n}_drawOriginBox(e,t=ge(1,1,0,1)){const r=window.view,s=r._stage,i=t.toString();if(!this._objects.has(i)){this._material=new ft({width:2,color:t}),s.add(this._material);const e=new pt(s,{pickable:!1}),r=new gt({castShadow:!1});s.add(r),e.add(r),this._objects.set(i,r)}const a=this._objects.get(i),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],n=o.length,d=new Array(3*n),c=new Array,l=.5*this._gridSize;for(let t=0;t<n;t++)d[3*t]=e[0]+(1&o[t]?l:-l),d[3*t+1]=e[1]+(2&o[t]?l:-l),d[3*t+2]=e[2]+(4&o[t]?l:-l),t>0&&c.push(t-1,t);ct(d,this._originSR,0,d,r.renderSpatialReference,0,n);const h=new Re(this._material,[[yt.POSITION,new lt(d,c,3,!0)]],null,ht.Line);s.add(h),a.addGeometry(h)}get test(){}}const cs=G();function ls(e){e.include(ve),e.uniforms.add(new we("geometryDepthTexture",((e,t)=>t.multipassGeometry.depth?.attachment))),e.code.add(_e`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}class hs{}class us{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=Se.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=be.NONE,this.alignPixelEnabled=!1,this.decorations=Ct.ON,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new ue,this._inverseViewport=vt(),this.oldLighting=new re,this.newLighting=new re,this._fadedLighting=new re,this._lighting=this.newLighting,this.ssr=new ms,this.multipassEnabled=!1,this.multipassTerrain=new Me,this.multipassGeometry=new hs,this.hudRenderStyle=et.Occluded,this.cloudsFade=new Hr,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:r}=this;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(t,r,e),this._lighting=this._fadedLighting)}}class ms{constructor(){this.fadeFactor=1,this.reprojectionMatrix=je()}}class fs{constructor(e,t,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new ue,this.output=ne.Color,this.renderOccludedMask=gs,this.bindParameters=new us(t,null!=r?r.plane:null),this.bindParameters.alignPixelEnabled=!0}}class ps extends fs{constructor(e,t,r,s){super(e,r,s),this.offscreenRenderingHelper=t,this.sliceHelper=s,this.time=c(0)}}const gs=ut.Occlude|ut.OccludeAndTransparent|ut.OccludeAndTransparentStencil;let _s=class extends ue{constructor(){super(...arguments),this._projectionMatrix=je()}get projectionMatrix(){return this._projectionMatrix}};var ys;e([_()],_s.prototype,"_projectionMatrix",void 0),e([_({readOnly:!0})],_s.prototype,"projectionMatrix",null),_s=e([v("esri.views.3d.webgl-engine.lib.CascadeCamera")],_s),function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"}(ys||(ys={}));class vs{constructor(){this.camera=new _s,this.lightMat=je()}}class Cs{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class ws{constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Cs,this._projectionView=je(),this._projectionViewInverse=je(),this._modelViewLight=je(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=pe(),this._cascades=[new vs,new vs,new vs,new vs],this._lastOrigin=null,this._maxTextureWidth=Math.min(r("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Pt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=o(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Ie(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)As[e]=this._cascades[e];return As.length=this._numCascades,As}start(e,t,r,s,i){it(this.enabled);const{near:a,far:o}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(a,o,s),this._textureHeight=this._computeTextureHeight(e,i,s),this._setupMatrices(e,t);const{viewMatrix:n,projectionMatrix:d}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,d,n,t);this._lastOrigin=null,this.clear()}finish(){it(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!F(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||G(),P(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){w(Is,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Ps[16*t+e]=Is[e]}}return Ps}moveSnapshot(e){it(this.enabled),this._handle?.detachDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){const t=this._handle?.getTexture()?.descriptor;if(!this.enabled||!t)return;this._snapshots[e]?.release();const{width:r,height:s}=t,i=e===ys.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(r,s,i,Q.RGBA4);const a=this._fbos.rctx;this._bindFbo();const o=a.bindTexture(this._snapshots[e]?.getTexture(),Vt.TEXTURE_UNIT_FOR_UPDATES);a.gl.copyTexSubImage2D(Ht.TEXTURE_2D,0,0,0,0,0,r,s),a.bindTexture(o,Vt.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(Nt.COLOR_BUFFER_BIT|Nt.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,r){const s=Math.min(window.devicePixelRatio,t)/e.pixelRatio,i=r?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,a=De(Math.floor(Math.max(e.fullWidth,e.fullHeight)*s*i)),o=Math.min(this._maxTextureWidth,this._numCascades*a);return Te(o/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",Q.RGBA4)),this._handle?.acquireDepth(se.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=o(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,s){const i=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],n=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),d=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);it(n<d);for(let e=0;e<8;++e){Pt(Rs,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?n:d,1);const t=Ss[e];Ft(t,Rs,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}H(Es,Ss[0]),i.camera.viewMatrix=w(xs,this._modelViewLight,Es);for(let e=0;e<8;++e)N(Ss[e],Ss[e],i.camera.viewMatrix);let c=Ss[0][2],l=Ss[0][2];for(let e=1;e<8;++e)c=Math.min(c,Ss[e][2]),l=Math.max(l,Ss[e][2]);c-=200,l+=200,i.camera.near=-l,i.camera.far=-c,function(e,t,r,s,i){const a=1/Ss[0][3],o=1/Ss[4][3];it(a<o);let n=a+Math.sqrt(a*o);const d=Math.sin(Fe(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));n/=d,function(e,t,r,s,i,a,o,n){Rt(Fs,0,0);for(let t=0;t<4;++t)St(Fs,Fs,e[t]);bt(Fs,Fs,.25),Rt(Hs,0,0);for(let t=4;t<8;++t)St(Hs,Hs,e[t]);bt(Hs,Hs,.25),Mt(Ns[0],e[4],e[5],.5),Mt(Ns[1],e[5],e[6],.5),Mt(Ns[2],e[6],e[7],.5),Mt(Ns[3],e[7],e[4],.5);let d=0,c=Dt(Ns[0],Fs);for(let e=1;e<4;++e){const t=Dt(Ns[e],Fs);t<c&&(c=t,d=e)}Tt(Ls,Ns[d],e[d+4]);const l=Ls[0];let h,u;Ls[0]=-Ls[1],Ls[1]=l,Tt(js,Hs,Fs),Ot(js,Ls)<0&&Et(Ls,Ls),Mt(Ls,Ls,js,r),At(Ls,Ls),h=u=Ot(Tt(Gs,e[0],Fs),Ls);for(let t=1;t<8;++t){const r=Ot(Tt(Gs,e[t],Fs),Ls);r<h?h=r:r>u&&(u=r)}It(s,Fs),bt(Gs,Ls,h-t),St(s,s,Gs);let m=-1,f=1,p=0,g=0;for(let t=0;t<8;++t){Tt(Vs,e[t],s),At(Vs,Vs);const r=Ls[0]*Vs[1]-Ls[1]*Vs[0];r>0?r>m&&(m=r,p=t):r<f&&(f=r,g=t)}ot(m>0,"leftArea"),ot(f<0,"rightArea"),bt(zs,Ls,h),St(zs,zs,Fs),bt(Ws,Ls,u),St(Ws,Ws,Fs),Us[0]=-Ls[1],Us[1]=Ls[0];const _=nt(s,e[g],Ws,St(Gs,Ws,Us),1,i),y=nt(s,e[p],Ws,Gs,1,a),v=nt(s,e[p],zs,St(Gs,zs,Us),1,o),C=nt(s,e[g],zs,Gs,1,n);ot(_,"rayRay"),ot(y,"rayRay"),ot(v,"rayRay"),ot(C,"rayRay")}(Ss,n,d,bs,Ms,Ds,Ts,Os),function(e,t,r,s,i){Tt(Zs,r,s),bt(Zs,Zs,.5),Qs[0]=Zs[0],Qs[1]=Zs[1],Qs[2]=0,Qs[3]=Zs[1],Qs[4]=-Zs[0],Qs[5]=0,Qs[6]=Zs[0]*Zs[0]+Zs[1]*Zs[1],Qs[7]=Zs[0]*Zs[1]-Zs[1]*Zs[0],Qs[8]=1,Qs[Bs(0,2)]=-Ot(qs(Qs,0),e),Qs[Bs(1,2)]=-Ot(qs(Qs,1),e);let a=Ot(qs(Qs,0),r)+Qs[Bs(0,2)],o=Ot(qs(Qs,1),r)+Qs[Bs(1,2)],n=Ot(qs(Qs,0),s)+Qs[Bs(0,2)],d=Ot(qs(Qs,1),s)+Qs[Bs(1,2)];a=-(a+n)/(o+d),Qs[Bs(0,0)]+=Qs[Bs(1,0)]*a,Qs[Bs(0,1)]+=Qs[Bs(1,1)]*a,Qs[Bs(0,2)]+=Qs[Bs(1,2)]*a,a=1/(Ot(qs(Qs,0),r)+Qs[Bs(0,2)]),o=1/(Ot(qs(Qs,1),r)+Qs[Bs(1,2)]),Qs[Bs(0,0)]*=a,Qs[Bs(0,1)]*=a,Qs[Bs(0,2)]*=a,Qs[Bs(1,0)]*=o,Qs[Bs(1,1)]*=o,Qs[Bs(1,2)]*=o,Qs[Bs(2,0)]=Qs[Bs(1,0)],Qs[Bs(2,1)]=Qs[Bs(1,1)],Qs[Bs(2,2)]=Qs[Bs(1,2)],Qs[Bs(1,2)]+=1,a=Ot(qs(Qs,1),t)+Qs[Bs(1,2)],o=Ot(qs(Qs,2),t)+Qs[Bs(2,2)],n=Ot(qs(Qs,1),r)+Qs[Bs(1,2)],d=Ot(qs(Qs,2),r)+Qs[Bs(2,2)],a=-.5*(a/o+n/d),Qs[Bs(1,0)]+=Qs[Bs(2,0)]*a,Qs[Bs(1,1)]+=Qs[Bs(2,1)]*a,Qs[Bs(1,2)]+=Qs[Bs(2,2)]*a,a=Ot(qs(Qs,1),t)+Qs[Bs(1,2)],o=Ot(qs(Qs,2),t)+Qs[Bs(2,2)],n=-o/a,Qs[Bs(1,0)]*=n,Qs[Bs(1,1)]*=n,Qs[Bs(1,2)]*=n,i[0]=Qs[0],i[1]=Qs[1],i[2]=0,i[3]=Qs[2],i[4]=Qs[3],i[5]=Qs[4],i[6]=0,i[7]=Qs[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Qs[6],i[13]=Qs[7],i[14]=0,i[15]=Qs[8]}(bs,Ms,Ts,Os,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}(r,s,c,l,i.camera),x(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const h=this._textureHeight;i.camera.viewport=[e*h,0,h,h]}_setupMatrices(e,t){x(this._projectionView,e.projectionMatrix,e.viewMatrix),R(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===V.Global?e.eye:L(Es,0,0,1);S(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,r){const s=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(at(t/e,4)),s);const i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let o=e,n=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=Pe(o,n,this.settings.splitSchemeLambda),o*=a,n+=i}get test(){}}const xs=je(),Rs=pe(),Ss=[];for(let e=0;e<8;++e)Ss.push(pe());const bs=vt(),Ms=vt(),Ds=vt(),Ts=vt(),Os=vt(),Es=G(),As=[],Is=je(),Ps=Le.concat(Le,Le,Le,Le),Fs=vt(),Hs=vt(),Ns=[vt(),vt(),vt(),vt()],Ls=vt(),js=vt(),Gs=vt(),Vs=vt(),zs=vt(),Ws=vt(),Us=vt();function Bs(e,t){return 3*t+e}const ks=vt();function qs(e,t){return Rt(ks,e[t],e[t+3]),ks}const Zs=vt(),Qs=xt();class Ys{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,r){const s=this._material.produces.get(t);if(!s?.(r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const i=this._map.get(r);if(null!=i){if(i.ensureResources(e)===wt.LOADED)return i;this._repository.requestRender()}return null}}class Ks extends ie{constructor(e=G()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class Xs{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function $s(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;){r=!1;for(let s=0;s<e.length;++s){const i=e.data[s],a=t.get(i.to);if(!a)return;i.to=a.to,t.delete(a.from),e.removeUnordered(a),r=!0}}}class Js extends Xs{constructor(e,t,r){super(t,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class ei{constructor(){this.first=0,this.count=0}}class ti{constructor(){this._numElements=0,this._instances=new Map,this.holes=new l({allocator:e=>e||new Xs,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=ri(),this.drawCommandsHighlight=ri(),this.drawCommandsOccludees=ri(),this.drawCommandsShadowHighlightRest=ri()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=t,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),r=this.holes.front();return null!=this.vao&&1===this.holes.length&&r.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=r.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(si(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),si(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function ri(){return new l({allocator:e=>e||new ei,deallocator:e=>e})}function si(e,t){const r=e.back();if(null==r){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(i=t,(s=r).first+s.count>=i.from){const e=t.from-r.first+t.numElements;r.count=e}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}var s,i}class ii{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}class ai{constructor(e,t){this._cache=e(t,((e,t,r)=>{switch(t){case Kt.ALL:return e.forEach((e=>e.dispose())),0;case Kt.SOME:{const t=e.shift();return t&&(r-=Math.round(t.usedMemory),t.dispose()),r}}}))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const r=t.pop();if(t.length>0){if(r){const s=this._cache.getSize(e)-Math.round(r.usedMemory);this._cache.updateSize(e,t,s)}}else this._cache.pop(e);return r}put(e,t,r=Xt){const s=this._cache.peek(e);if(!s)return void this._cache.put(e,[t],t.usedMemory,r);s.push(t);const i=this._cache.getSize(e)+Math.round(t.usedMemory);this._cache.updateSize(e,s,i)}}class oi{constructor(e,t,r){this._rctx=e,this._locations=t,this._layout=r,this._cache=new ai(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let r=this._cache.pop(t);return r||(r=new tt(this._rctx,this._locations,{geometry:this._layout},{geometry:$t.createVertex(this._rctx,Lt.STATIC_DRAW)}),r.vertexBuffers.geometry.setSize(e),r)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e)}}let ni=class extends rt{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=n(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=n(this._vaoCache)}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==ne.Highlight&&t!==ne.ShadowHighlight||this._hasHighlights))&&e(t)))}))}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new Ys(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new oi(r,this.material.vertexAttributeLocations,Yt(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const r=t.vertexBufferLayout.stride/4;for(const s of e){const e=s.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),a=i?.findBuffer(e.id);if(null==a)return;const o=a.instances.get(e.id);if(s.updateType&(dr.GEOMETRY|dr.TRANSFORMATION)){const s=Ci(t.elementCount(o.geometry.geometry)*r),i=t.vertexBufferLayout.createView(s.buffer);this._writeGeometry(e,i,0),a.vao.vertexBuffers.geometry.setSubData(s,o.from*r,0,o.numElements*r)}s.updateType&(dr.HIGHLIGHT|dr.OCCLUDEE|dr.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new Xe;for(const t of e){const e=t.localOrigin;if(null==e)continue;let s=r.get(e.id,null);null==s&&(s=new di(e.vec3),r.set(e.id,null,s)),s.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const s=this._dataByOrigin.get(t.id),i=s?.findBuffer(e.id);if(null==i)continue;let a=r.get(t.id,i);null==a&&(a=new di(t.vec3),r.set(t.id,i,a)),a.changes.push(e)}return r}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:r,_dataByOrigin:i}=this,a=r.vertexBufferLayout.stride/4,o=this._computeDeltas(e,t);o.forEach(((e,t)=>{const n=e.get(null),d=null!=n?n.changes:[];o.delete(t,null);let c=i.get(t);if(e.forEach(((e,n)=>{if(o.delete(t,n),null==n)return void it(!1,"No VAO for removed geometries");if(n.instances.size===e.changes.length)return this._vaoCache.deleteVao(n.vao),s(c.buffers,n),void(0===c.buffers.length&&0===d.length&&i.delete(t));const l=n.numElements,h=n.vao.byteSize/4,u=d.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),m=e.changes.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),f=Math.min((l+u-m)*a,yi),p=f>h;f>fi&&f<h/2?(e.changes.forEach((({id:e})=>n.deleteInstance(e))),n.instances.forEach((({geometry:e})=>d.push(e))),this._vaoCache.deleteVao(n.vao),s(c.buffers,n)):p?this._applyAndRebuild(n,d,e):this._applyRemoves(n,e)})),d.length>0)for(null==c&&(c=new ii(n.origin),i.set(t,c)),c.buffers.forEach((e=>this._applyAdds(e,d)));d.length>0;)c.buffers.push(this._applyAndRebuild(new ti,d,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,a(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(null!=r)for(const t of r.changes)e.deleteInstance(t.id);const s=this._bufferWriter,i=s.vertexBufferLayout.stride,a=i/4,o=Math.floor(yi/a);let n=e.numElements;for(;t.length>0;){const r=t.pop(),i=s.elementCount(r.geometry);if(n+i>o&&n>0){t.push(r);break}n+=i;const a=new Js(r,0,0);it(null==e.instances.get(r.id)),e.addInstance(r.id,a)}const d=n*a,c=Ci(d),l=s.vertexBufferLayout.createView(c.buffer);let h=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,l,h);const i=h;h+=s.elementCount(t.geometry.geometry),e.updateInstance(r,i,h),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(wi(d)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,h*a),e.holes.clear();const u=e.holes.pushNew();return u.from=h,u.to=Math.floor(e.vao.byteSize/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const r of t.changes){const t=r.id,s=e.instances.get(t);if(!s)continue;e.deleteInstance(t);const i=mi.back();if(i){if(i.to===s.from){i.to=s.to;continue}if(i.from===s.to){i.from=s.from;continue}}const a=mi.pushNew();a.from=s.from,a.to=s.to}$s(mi);const r=this._bufferWriter.vertexBufferLayout.stride/4,s=mi.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,i=Ci(s);i.fill(0,0,s);const a=e.vao.vertexBuffers.geometry;mi.forAll((e=>a.setSubData(i,e.from*r,0,e.numElements*r))),e.holes.pushArray(mi.data,mi.length),mi.forAll(((e,t)=>mi.data[t]=null)),mi.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,a=e.numElements,o=t.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),n=Math.min((a+o)*s,yi),d=4*n;if(e.vao.byteSize<wi(yi-fi)&&d>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);$s(e.holes);const c=new Array;for(const s of t){const t=r.elementCount(s.geometry),i=ci(e.holes,t);c.push(i)}const l=e.vao.vertexBuffers.geometry;let h=0,u=0,m=0;const f=Ci(n),p=r.vertexBufferLayout.createView(f.buffer);t.forEach(((t,i)=>{const a=c[i];if(null==a)return;if(m!==a){const e=m-u;e>0&&l.setSubData(f,u*s,0,e*s),u=a,h=0}const o=r.elementCount(t.geometry);this._writeGeometry(t,p,h),h+=o,m=a+o;const n=new Js(t,a,a+o);it(null==e.instances.get(t.id)),e.addInstance(t.id,n),e.drawCommandsDirty=!0}));const g=m-u;g>0&&l.setSubData(f,u*s,0,g*s),i(t,((e,t)=>null==c[t]))}_writeGeometry(e,t,r){if(null===this._bufferWriter)return;const s=e.localOrigin.vec3;dt(li,-s[0],-s[1],-s[2]);const i=x(hi,li,e.transformation);R(ui,i),b(ui,ui),this._bufferWriter.write(i,ui,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e,s=this.material.produces.get(r.slot);if(!s?.(t))return null;const i=t===ne.Highlight||t===ne.ShadowHighlight;if(i&&!this._hasHighlights)return null;const a=t===ne.ShadowExcludeHighlight,o=!(i||a);for(const s of this._dataByOrigin.values())for(const n of s.buffers){if(i&&!n.hasHighlights)continue;const s=(i?n.drawCommandsHighlight:a&&n.needsMultipleCommands()?n.drawCommandsShadowHighlightRest:n.drawCommandsDefault)||null,d=o&&n.drawCommandsOccludees||null;if(s?.length||d?.length){const s=this._glMaterials.load(e.rctx,r.slot,t),i=null!=s?s.beginSlot(r):null;if(null!=i)return i}}return null}renderNode(e,t){const{output:r,bindParameters:s}=e,i=r===ne.Highlight||r===ne.ShadowHighlight,a=r===ne.ShadowExcludeHighlight,o=!(i||a),n=s.slot===Se.OCCLUDER_MATERIAL,d=s.slot===Se.TRANSPARENT_OCCLUDER_MATERIAL,c=e.rctx;c.runAppleAmdDriverHelper(),c.bindTechnique(t,s,this.material.parameters);for(const e of this._dataByOrigin.values())for(const r of e.buffers){if(i&&!r.hasHighlights)continue;const l=(i?r.drawCommandsHighlight:a&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null,h=o&&r.drawCommandsOccludees||null;(l?.length||h?.length)&&(t.program.bindDraw(new Ks(e.origin),s,this.material.parameters),t.ensureAttributeLocations(r.vao),c.bindVAO(r.vao),l?.length&&(c.setPipelineState(t.getPipeline(!1,n,d)),l.forAll((e=>c.drawArrays(t.primitiveType,e.first,e.count)))),h?.length&&(c.setPipelineState(t.getPipeline(!0,n,d)),h.forAll((e=>c.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){}};e([_({constructOnly:!0})],ni.prototype,"material",void 0),ni=e([v("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],ni);class di{constructor(e){this.origin=e,this.changes=new Array}}function ci(e,t){let r;if(!e.some((e=>!(e.numElements<t||(r=e,0)))))return null;const s=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),s}const li=je(),hi=je(),ui=je(),mi=new l({allocator:e=>e||new Xs,deallocator:null}),fi=65536,pi=4*fi,gi=1024,_i=16777216,yi=_i/4;let vi=new Float32Array(fi);function Ci(e){return vi.length<e&&(vi=new Float32Array(e)),vi}function wi(e){const t=4*e;return t<=gi?gi:t<pi?He(t):Math.max(Math.min(Math.ceil(1.5*t/pi)*pi,_i),t)}let xi=class extends f{constructor(e){super(e),this._pending=new Ri,this._changes=new me,this._materialRenderers=new Map,this._sortedMaterialRenderers=new l,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach((e=>e.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return a(this._materialRenderers,(e=>0!==e.numGeometries&&!e.queryRenderOccludedState(ut.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}getMaterialRenderer(e){return this._materialRenderers.get(e)}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=fe(this._changes);let t=!1;return e.forEach(((e,r)=>{let s=this.getMaterialRenderer(r);if(!s&&e.adds.length>0){const e=new ni({material:r});e.initializeRenderContext(this.rendererContext.pluginContext,this._materials),s=e,this._materialRenderers.set(r,s),t=!0}s&&(s.modify(e),0===s.numGeometries&&(this._materialRenderers.delete(r),s.destroy(),t=!0))})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=a(this._materialRenderers,(e=>{const t=e.produces.get(Se.DRAPED_MATERIAL);return!!t&&t(ne.Highlight)})),this._hasWater=a(this._materialRenderers,(e=>{const t=e.produces.get(Se.DRAPED_WATER);return!!t&&t(ne.Normal)})),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const r=this._validateRenderGeometries(e);for(const e of r)this._geometries.set(e.id,e);const s=this._pending.empty;for(const e of r)this._pending.adds.add(e);s&&this.notifyChange("updating"),t===nr.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,s=this._pending.adds;for(const t of e)s.has(t)?(this._pending.removed.add(t),s.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===nr.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(r),e.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case dr.TRANSFORMATION:case dr.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case dr.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const r=t.prepareTechnique(e);null!=r&&t.renderNode(e,r)}))}intersect(e,t,r,s,i){return this._geometries.forEach((a=>{if(s&&!s(a))return;this._intersectRenderGeometry(a,r,t,0,e,i);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,t,o.range,e,i),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,t,-o.range,e,i)),i++})),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;for(const t of this._materialRenderers.values())t.drapedPriority=e++,this._sortedMaterialRenderers.push(t);this._sortedMaterialRenderers.sort(((e,t)=>t.materialReference?.renderPriority===e.materialReference?.renderPriority?e.drapedPriority-t.drapedPriority:(t.materialReference?.renderPriority||0)-(e.materialReference?.renderPriority||0)))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,r,s,i,a){if(!e.visible)return;let o=0;s+=e.transformation[12],o=e.transformation[13],Si[0]=r[0]-s,Si[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,i,Si,((r,s,o)=>{!function(e,t,r,s,i,a,o){const n=new kt(a,o,t),d=t=>{t.set(Qt.OVERLAY,n,e.dist,e.normal,e.transformation,r,s)};if((null==i.results.min.drapedLayerOrder||r>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&d(i.results.min),i.options.store!==qt.MIN&&(null==i.results.max.drapedLayerOrder||r<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&d(i.results.max),i.options.store===qt.ALL){const e=Zt(i.ray);d(e),i.results.all.push(e)}}(t,o,a,e.material.renderPriority,i,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(Wt(e.boundingSphere))),e}get test(){}};e([_()],xi.prototype,"drapeSource",void 0),e([_()],xi.prototype,"updating",null),e([_()],xi.prototype,"rctx",null),e([_({constructOnly:!0})],xi.prototype,"rendererContext",void 0),e([_()],xi.prototype,"_materials",null),e([_()],xi.prototype,"_localOriginFactory",null),e([_({readOnly:!0})],xi.prototype,"isEmpty",null),e([_()],xi.prototype,"_materialRenderers",void 0),e([_()],xi.prototype,"_geometries",void 0),xi=e([v("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],xi);class Ri{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Si=vt();class bi extends Oe{initializeProgram(e){return new Ee(e.rctx,bi.shader.get().build(),mt)}initializePipeline(){return this.configuration.hasAlpha?Jt({blending:er(jt.SRC_ALPHA,jt.ONE,jt.ONE_MINUS_SRC_ALPHA,jt.ONE_MINUS_SRC_ALPHA),colorWrite:tr}):Jt({colorWrite:tr})}}bi.shader=new Ae(ts,(()=>Promise.resolve().then((()=>ts))));class Mi extends $e{constructor(){super(...arguments),this.hasAlpha=!1}}e([Je()],Mi.prototype,"hasAlpha",void 0);class Di extends ye{constructor(){super(...arguments),this.overlayIndex=cr.INNER,this.opacity=1}}const Ti=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Di,build:function(){const e=new xe;return e.include(Qe),e.fragment.uniforms.add(new we("tex",(e=>e.texture))),e.fragment.uniforms.add(new ae("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new ce("opacity",(e=>e.opacity))),e.fragment.code.add(_e`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}},Symbol.toStringTag,{value:"Module"}));class Oi extends Oe{initializeProgram(e){return new Ee(e.rctx,Oi.shader.get().build(),mt)}initializePipeline(){return Jt({blending:rr(jt.ONE,jt.ONE_MINUS_SRC_ALPHA),colorWrite:tr})}}Oi.shader=new Ae(Ti,(()=>Promise.resolve().then((()=>Ti))));let Ei=class extends st{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Di,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new l,this._passParameters=new es,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new ue,this.worldToPCSRatio=1,this.events=new t,this.longitudeCyclical=null,this.produces=new Map([[Se.DRAPED_MATERIAL,e=>e!==ne.Highlight||this.hasHighlights],[Se.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextures:r,stippleTextures:s,markerTextures:i}=t;this._techniques=new rs({rctx:this._rctx,viewingMode:V.Local,stippleTextures:s,markerTextures:i,waterTextures:r}),this._renderContext=new fs(this._rctx,new ws(e,this.view.state.viewingMode),null),this.addHandles([h((()=>r.updating),(()=>this.events.emit("content-changed")),u),h((()=>this.spatialReference),(e=>this._localOriginFactory=new ds(e)),u),m((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materials=new os(t.textures,this._techniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=Se.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=be.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new oe(j(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(ke.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=o(this._debugTextureTechnique),this._passParameters.texture=n(this._passParameters.texture),this._techniques=d(this._techniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||a(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,xi)}createDrapeSourceRenderer(e,t,r){const s=this._renderers.get(e);null!=s&&s.destroy();const i=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(h((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&g(e,(e=>e.drapeTargetType===or.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=g(e,(e=>e.drapeSourceType===ir.Features)),this._hasDrapedRasterSource=g(e,(e=>e.drapeSourceType===ir.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new Sr(this.view._stage.renderer.fboCache),this._overlays=[new Cr,new Cr]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=n(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(null!=e)return e===mr.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(mr.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&i.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=a(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(qe,(e=>e.updatePolicy===_t.SYNC))}get isEmpty(){return!z.OVERLAY_DRAW_DEBUG_TEXTURE&&!a(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Fi;const t=this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)));return this._renderContext.renderOccludedMask=e,t}renders(e){return z.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==mr.Occluded||this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext)))}get mode(){return this.isEmpty?Zr.Disabled:this._renderTargets?.getTexture(mr.WaterNormal)?Zr.EnabledWithWater:this._renderTargets?.getTexture(mr.Color)?Zr.Enabled:Zr.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets){if(t.content===mr.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(cr.INNER,t,e),s=this._drawTarget(cr.OUTER,t,e);(r||s)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,r){const s=this._overlays[e],i=s.canvasGeometries;if(0===i.numViews)return!1;const{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;const n=t.output;if(this.isEmpty||n===ne.Highlight&&!this.hasHighlights||n===ne.Normal&&!this.hasWater||!s.hasSomeSizedView())return!1;const d=this._rctx;if(this._camera.pixelRatio=s.pixelRatio*o,this._renderContext.output=n,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===ne.Normal?Se.DRAPED_WATER:Se.DRAPED_MATERIAL,t.content===mr.Occluded&&(this._renderContext.renderOccludedMask=Fi),!this.renders(t.content))return this._renderContext.renderOccludedMask=gs,!1;const c=s.resolution;this._rctx.setViewport(e===cr.INNER?0:c,0,c,c);const l=2*s.resolution,h=s.resolution,u=t.fbo;if(u.bind(d,l,h),e===cr.INNER&&(d.setClearColor(0,0,0,0),d.clear(Nt.COLOR_BUFFER_BIT)),z.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==mr.Occluded)for(let t=0;t<i.numViews;t++)this._setViewParameters(i.extents[t],s),this._ensureDebugPatternResources(s.resolution,Ii[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll((({drapeSource:r,renderer:a})=>{if(t.content===mr.ColorNoRasterImage&&r.drapeSourceType===ir.RasterImage)return;const{fullOpacity:o}=r,c=null!=o&&o<1&&n===ne.Color?this.bindTemporaryFramebuffer(l,h):null;for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],s),a.render(this._renderContext);if(c){u.bind(d,l,h),this._overlayParameters.texture=c.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniques.acquire(Oi);this._rctx.bindTechnique(t,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),t.release(),c.release()}})),d.bindFramebuffer(null),this._renderContext.renderOccludedMask=gs,!0}bindTemporaryFramebuffer(e,t){const r=this.view._stage.renderer.fboCache,s=r.acquire(e,t,"overlay tmp");return r.rctx.unbindTexture(s.fbo?.colorTexture),r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(Nt.COLOR_BUFFER_BIT),s}async reloadShaders(){await this._techniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,s){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,r,s,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach(((r,s)=>{const i=e.indexOf(s.layer),a=i>=0,o=s.renderGroup??(a?ar.MapLayer:ar.ViewLayer),n=t*o+(a?i:0);this._sortedRenderers.push(new Ai(s,r,n))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],M(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),D(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=a(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,t){if(L(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let s=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){const a=Math.floor(i/10),o=Math.floor(t/10);a<2||o<2||10*a>e-20||10*o>e-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&a&&1&o?1&i^1&t?0:255:1&a^1&o?0:128)}const i=new zt(e);i.samplingMode=Gt.NEAREST,this._passParameters.texture=new Vt(this._rctx,i,r);const a=new Mi;a.hasAlpha=!0,this._debugTextureTechnique=this._techniques.acquire(bi,a)}get test(){}};e([_()],Ei.prototype,"hasHighlights",void 0),e([_()],Ei.prototype,"_sortedDrapeSourceRenderersDirty",void 0),e([_()],Ei.prototype,"_techniques",void 0),e([_({constructOnly:!0})],Ei.prototype,"view",void 0),e([_()],Ei.prototype,"worldToPCSRatio",void 0),e([_()],Ei.prototype,"spatialReference",void 0),e([_({type:Boolean,readOnly:!0})],Ei.prototype,"updating",null),e([_()],Ei.prototype,"isEmpty",null),e([_({readOnly:!0})],Ei.prototype,"rendersOccludedDraped",null),Ei=e([v("esri.views.3d.terrain.OverlayRenderer")],Ei);class Ai{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const Ii=[[1,.5,.5],[.5,.5,1]],Pi=-2,Fi=ut.OccludeAndTransparent;class Hi{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=je(),this._shaderTransformation=null,this._boundingSphere=null,this.id=p(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,null!=t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){T(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=je(),x(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=Bt(),N(Wt(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*sr(this.shaderTransformation)),this._boundingSphere):Ut}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{ps as A,us as B,kr as C,ir as D,ni as E,Er as F,ds as G,Tr as H,gs as I,bi as J,Mi as K,hr as L,ai as M,rs as N,cr as O,lr as P,os as Q,Hi as R,xi as S,ur as T,Or as V,qr as W,or as a,ar as b,nr as c,Pi as d,dr as e,Ys as f,Ir as g,gr as h,_r as i,pr as j,Fr as k,Ei as l,ls as m,vr as n,Zr as o,Yr as p,mr as q,Ks as r,Fi as s,Qr as t,$r as u,fr as v,ys as w,Mr as x,Dr as y,ws as z};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{c as s}from"./asyncUtils.js";import"../core/lang.js";import{L as i}from"./Logger.js";import{a as n,r as a}from"./maybe.js";import{throwIfAborted as r,isAbortError as o,isAborted as l}from"../core/promiseUtils.js";import{watch as h,syncAndInitial as c,sync as w,whenOnce as y,when as p}from"../core/reactiveUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";var v;!function(t){t[t.PENDING=0]="PENDING",t[t.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",t[t.RUNNING=2]="RUNNING"}(v||(v={}));let _=class extends e{constructor(t={}){super(t),this.view=null,this.analysisView=null,this._reconnectViewTask=null,this._forceInteractiveHandle=null,this._parentChangeFromReconnect=!1,this._startUserOperation=null;const e=t?.analysis;null!=e?this.analysis=e:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0)),null!=t?.visible&&(this.visible=t.visible)}normalizeCtorArgs(t){const{analysis:e,...s}=t;return s}initialize(){this.addHandles([h((()=>({readyAndNotSupported:null!=this.view&&this.view.ready&&!this.supported})),(({readyAndNotSupported:t})=>{t&&i.getLogger(this).errorOnce(this.unsupportedErrorMessage)}),c),h((()=>this.analysis?.parent),(t=>{this._parentChangeFromReconnect||t===this.view||this._set("isAnalysisOwner",!1);const e=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,e&&this._scheduleViewReconnect()}),w),h((()=>({view:this.view,ready:null!=this.view&&this.view.ready,supported:this.supported})),(({view:t},e)=>{const s=e?.view;t!==s&&(this._startUserOperation=n(this._startUserOperation),this._disconnectFromView(s)),this._scheduleViewReconnect()}),c)])}destroy(){this._reconnectViewTask=n(this._reconnectViewTask),this._startUserOperation=n(this._startUserOperation),null!=this.analysisView&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),this._set("view",null),null!=this.analysis&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}get supported(){return null==this.view||this.view.type===this.supportedViewType}set visible(t){this._set("visible",t),null!=this.analysisView&&(this.analysisView.visible=t)}get active(){return null!=this.tool&&this.tool.active}get disabled(){return null==this.view||!this.view.ready||!this.supported}set analysis(t){t!==this._get("analysis")&&(this._startUserOperation=n(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(t),this._scheduleViewReconnect())}get ready(){return null!=this.analysisView&&!this.connectingToView}get connectingToView(){return null!=this._reconnectViewTask}get isAnalysisOwner(){return this._get("isAnalysisOwner")}get tool(){return null!=this.analysisView?this.analysisView.tool:null}clear(){this._startUserOperation=n(this._startUserOperation),this._resetInteractiveCreationState(),null!=this.tool&&null!=this.view&&this.view.activeTool===this.tool&&(this.view.activeTool=null)}async start(){if(!this.visible)return void i.getLogger(this).warn("Cannot start analysis when not visible");this.clear();const t={task:null,abort:null,state:v.PENDING},e=s((async e=>{if(t.state=v.WAIT_FOR_VIEW_READY,await y((()=>this.ready),e),t.state=v.RUNNING,null==this.analysisView||null==this.view)return;const s=this.analysisView.tool;null!=s&&(this.view.activeTool=s,p((()=>s.created),(()=>{s.active&&null!=this.view&&(this.view.activeTool=null)}),{initial:!0,once:!0}))}));return t.task=e,t.abort=()=>e.abort(),this._startUserOperation=t,e.promise}onConnectToAnalysisView(t){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=n(this._reconnectViewTask);const t=s((async e=>{try{await this._reconnectView(e)}catch(t){if(r(e),!o(t))return void i.getLogger(this).warn("Failed to use analysis in view model",t);throw t}finally{t===this._reconnectViewTask&&(this._reconnectViewTask=null)}}));this._reconnectViewTask=t}async _reconnectView(t){const{view:e}=this,s=null!=e&&e.ready&&this.supported,n=this.analysis;if(this._startUserOperation=V(this._startUserOperation),this._disconnectFromView(e),s&&null!=e&&null!=n){if(this.isAnalysisOwner){if(null!=n.parent)return void i.getLogger(this).errorOnce("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,e.analyses.add(n)}this.analysisView=await e.whenAnalysisView(n),l(t)?this._startUserOperation=V(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractiveForViewModel(),this.addHandles(this._forceInteractiveHandle),this.onConnectToAnalysisView(this.analysisView))}}_disconnectFromView(t){null!=t&&this.isAnalysisOwner&&t.analyses.includes(this.analysis)&&(this._parentChangeFromReconnect=!0,this.analysis.clear(),t.analyses.remove(this.analysis)),this.onDisconnectFromAnalysisView(),this._forceInteractiveHandle=a(this._forceInteractiveHandle),this.analysisView=null}_setExternalAnalysis(t){null==this.analysisView||this.isAnalysisOwner||(this.analysisView.visible=void 0,this._forceInteractiveHandle=a(this._forceInteractiveHandle)),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",t),this._parentChangeFromReconnect=!1}_resetInteractiveCreationState(){this.analysis.clear(),null!=this.tool&&this.tool.resetCreated()}get testInfo(){}};function V(t){return null!=t&&t.state>=v.RUNNING?(t.abort(),null):t}t([u()],_.prototype,"supported",null),t([u()],_.prototype,"view",void 0),t([u({type:Boolean,value:!0})],_.prototype,"visible",null),t([u()],_.prototype,"active",null),t([u()],_.prototype,"disabled",null),t([u({nonNullable:!0})],_.prototype,"analysis",null),t([u()],_.prototype,"analysisView",void 0),t([u()],_.prototype,"ready",null),t([u()],_.prototype,"connectingToView",null),t([u({readOnly:!0})],_.prototype,"isAnalysisOwner",null),t([u()],_.prototype,"_reconnectViewTask",void 0),t([u()],_.prototype,"_forceInteractiveHandle",void 0),t([u()],_.prototype,"tool",null),_=t([d("esri.widgets.support.AnalysisViewModel")],_);export{_ as A};

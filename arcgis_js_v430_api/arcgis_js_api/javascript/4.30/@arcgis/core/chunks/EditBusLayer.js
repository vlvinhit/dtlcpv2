/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{clone as s}from"../core/lang.js";import{createResolver as i}from"../core/promiseUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import o from"../request.js";import{b as d}from"./uuid.js";const a=d(),l=new Map,c=new Map,u=new Map;async function h(e,t,s){if(!e||!s)return!1;if(!t)return!0;const i=new URL(e).host;let r=l.get(i);if(!r){const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");r=(await o(t,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return r===t}async function m(e,t,s=!1){if(!e||!t)return!0;const i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=c.get(i)?.entries();if(r)for(const[e,n]of r)if(n.name===t){const t=!n.stack?.hasForwardEdits();if(!t&&s){const[{deleteForwardEdits:t},{default:s}]=await Promise.all([import("./deleteForwardEdits.js"),import("./DeleteForwardEditsParameters.js")]),r=await t(i,e,new s({sessionId:a,moment:n.moment}));return r.success&&n.stack?.clearForwardEdits(),r.success}return t}return!0}function p(e,t){if(!e)return!1;const s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=c.get(s)?.entries();if(i)for(const[e,s]of i)if(s.name===t)return"edit"===s.lockType;return!1}const f=new t.EventEmitter;function b(e){return f.on("apply-edits",new WeakRef(e))}function F(e){return f.on("update-moment",new WeakRef(e))}function g(e,t,s=null,r=!1){const n=i();return r=null==t||r,f.emit("apply-edits",{serviceUrl:e,layerId:t,gdbVersion:s,mayReceiveServiceEdits:r,result:n.promise}),n}function M(e,t,s=null,i){f.emit("update-moment",{serviceUrl:e,layerId:t,gdbVersion:s,moment:i})}const y=Symbol();function I(e){return null!=e&&"object"==typeof e&&y in e}function j(e){return null!=e&&"object"==typeof e&&"gdbVersion"in e}function v(e,t,s){const i=new URL(e).host,r=l.get(i),n=e=>!e||e===r;return n(t)&&n(s)||t===s}const w=t=>{var i;let o=class extends t{constructor(...e){super(...e),this[i]=!0,this._applyEditsHandler=e=>{const{serviceUrl:t,layerId:i,gdbVersion:r,mayReceiveServiceEdits:n,result:o}=e,d=t===this.url,a=null!=i&&null!=this.layerId&&i===this.layerId,l=j(this),c=j(this)&&v(t,r,this.gdbVersion);if(!d||l&&!c||!a&&!n)return;const u=o.then((e=>{if(this.lastEditsEventDate=new Date,a&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",s(e)),e;const i=e.editedFeatures?.find((({layerId:e})=>e===this.layerId));if(i){const{adds:t,updates:r,deletes:n}=i.editedFeatures,o={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:t?t.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],deletedFeatures:n?n.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],updatedFeatures:r?r.map((({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],editedFeatures:s(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s(e.historicMoment)};return this.emit("edits",o),o}const n={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:s(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s(e.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,r,n.historicMoment)&&this.emit("edits",n),n})).then((e=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,r,e.historicMoment)&&(this.historicMoment=e.historicMoment),e)));this.emit("apply-edits",{result:u})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:s,moment:i}=e,r=t===this.url,n=j(this),o=j(this)&&v(t,s,this.gdbVersion),d=j(this)&&!v(t,this.gdbVersion,null);r&&n&&o&&d&&"historicMoment"in this&&this.historicMoment!==i&&(this.historicMoment=i)},this.when().then((()=>{this.addHandles(b(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(F(this._updateMomentHandler))}),(()=>{}))}_shouldUpdateHistoricMoment(e,t,s){return"historicMoment"in this&&this.historicMoment!==s&&p(e,t)}};return i=y,e([r()],o.prototype,"lastEditsEventDate",void 0),o=e([n("esri.layers.mixins.EditBusLayer")],o),o};export{w as E,p as a,h as b,a as c,I as d,g as e,F as f,c as g,u as h,m as i,l as j,M as k,b as o,v};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import t from"../Color.js";import{f as o}from"./colorUtils2.js";import s from"../core/Error.js";import{l as e}from"./fontUtils.js";import{a as i}from"./screenUtils.js";import{d as r,e as l,h as m,j as a}from"./utils11.js";import{S as p,a as n,r as c,s as y}from"../symbols/support/symbolUtils.js";import{b as j}from"../symbols/Font.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./vec4.js";import"./vec4f64.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./assets.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"./_commonjsHelpers.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./LRUCache.js";import"./MemCache.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./webStyleSymbolUtils.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./defaults.js";import"./defaultsJSON.js";import"./styleUtils.js";const u="picture-fill",h="picture-marker",b="simple-fill",d="simple-line",f="simple-marker",g="text",S="Aa",w=p.size,L=p.maxSize,v=p.maxOutlineSize,M=p.lineWidth,x=225,U=document.createElement("canvas");function k(t,o){const s=U.getContext("2d"),e=[];o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" ");const{width:i,actualBoundingBoxLeft:r,actualBoundingBoxRight:l,actualBoundingBoxAscent:m,actualBoundingBoxDescent:a}=s.measureText(t);return{width:Math.ceil(Math.max(i,r+l)),height:Math.ceil(m+a),x:Math.floor(r),y:Math.floor((m-a)/2)}}function D(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?i(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?i(o.height):null}}function z(t,o){return t>o?"dark":"light"}function C(t,o){const s="number"==typeof o?.size?o?.size:null,e=null!=s?i(s):null,r=null!=o?.maxSize?i(o.maxSize):null,p=null!=o?.rotation?o.rotation:"angle"in t?t.angle:null,n=l(t);let c=m(t);"dark"!==B(t,245)||o?.ignoreWhiteSymbols||(c={width:.75,...c,color:"#bdc3c7"});const j={shape:null,fill:n,stroke:c,offset:[0,0]};c?.width&&(c.width=Math.min(c.width,v));const x=c?.width||0;let U=null!=o?.size&&(null==o?.scale||o?.scale),z=0,C=0,P=!1;switch(t.type){case f:{const s=t.style,{width:l,height:m}=D(o),a=l===m&&null!=l?l:null!=e?e:Math.min(i(t.size),r||L);switch(z=a,C=a,s){case"circle":j.shape={type:"circle",cx:0,cy:0,r:.5*a},U||(z+=x,C+=x);break;case"cross":j.shape={type:"path",path:[{command:"M",values:[0,.5*C]},{command:"L",values:[z,.5*C]},{command:"M",values:[.5*z,0]},{command:"L",values:[.5*z,C]}]};break;case"diamond":j.shape={type:"path",path:[{command:"M",values:[0,.5*C]},{command:"L",values:[.5*z,0]},{command:"L",values:[z,.5*C]},{command:"L",values:[.5*z,C]},{command:"Z",values:[]}]},U||(z+=x,C+=x);break;case"square":j.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"Z",values:[]}]},U||(z+=x,C+=x),p&&(P=!0);break;case"triangle":j.shape={type:"path",path:[{command:"M",values:[.5*z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"Z",values:[]}]},U||(z+=x,C+=x),p&&(P=!0);break;case"x":j.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,C]},{command:"M",values:[z,0]},{command:"L",values:[0,C]}]},p&&(P=!0);break;case"path":j.shape={type:"path",path:t.path||""},U||(z+=x,C+=x),p&&(P=!0),U=!0}break}case d:{const{width:t,height:s}=D(o),i=a(c).reduce(((t,o)=>t+o),0),r=i&&Math.ceil(M/i),l=s??e??x,m=t??(i*r||M);c&&(c.width=l),z=m,C=l,U=!0,j.shape={type:"path",path:[{command:"M",values:[l/2,C/2]},{command:"L",values:[z-l/2,C/2]}]};break}case u:case b:{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:s,height:i}=D(o);z=!t&&s!==i||null==s?null!=e?e:w:s,C=!t&&s!==i||null==i?z:i,U||(z+=x,C+=x),U=!0,j.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[z,0]},{command:"L",values:[z,C]},{command:"L",values:[0,C]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:y.fill[0];break}case h:{const s=Math.min(i(t.width),r||L),l=Math.min(i(t.height),r||L),{width:m,height:a}=D(o),n=m===a&&null!=m?m:null!=e?e:Math.max(s,l),c=s/l;z=c<=1?Math.ceil(n*c):n,C=c<=1?n:Math.ceil(n/c),j.shape={type:"image",x:-Math.round(z/2),y:-Math.round(C/2),width:z,height:C,src:t.url||""},p&&(P=!0);break}case g:{const s=t,l=o?.overrideText||s.text||S,m=s.font,{width:a,height:p}=D(o),n=null!=p?p:null!=e?e:Math.min(i(m.size),r||L),{width:c,height:y}=k(l,{weight:m.weight,size:n,family:m.family}),u=/[\uE600-\uE6FF]/.test(l);z=a??(u?n:c),C=u?n:y;let h=.5*(u?n:y);u&&(h+=5),j.shape={type:"text",text:l,x:s.xoffset||0,y:s.yoffset||h,align:"middle",alignBaseline:s.verticalAlignment,decoration:m&&m.decoration,rotated:s.rotated,kerning:s.kerning},j.font=m&&{size:n,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:j,size:[z,C],renderOptions:{node:o?.node,scale:U,opacity:o?.opacity,rotation:p,useRotationSize:P,effectView:o?.effectView,ariaLabel:o?.ariaLabel}}}async function P(t,o){const{shapeDescriptor:l,size:m,renderOptions:a}=C(t,o);if(!l.shape)throw new s("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const s=o.fill,e=t.color;if("pattern"===s?.type&&e&&t.type!==u){const t=await r(s.src,e.toCss(!0));s.src=t,o.fill=s}}(t,l),await async function(t,o,s,i){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await e(t.font)}catch{}const{width:r,height:l}=D(i);if(!/[\uE600-\uE6FF]/.test(o.shape.text)){const{width:e,height:m,x:a,y:p}=k(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family});s[0]=r??e,s[1]=l??m,o.shape.x=a,o.shape.y=p;const n=null!=i?.rotation?i.rotation:"angle"in t?t.angle:null;if(n){const t=n*(Math.PI/180),o=Math.abs(Math.sin(t)),e=Math.abs(Math.cos(t));s[1]=s[0]*o+s[1]*e}}}(t,l,m,o);const p=[[l]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig?.applyColorModulation){const t=.6*m[0];p.unshift([{...l,offset:[-t,0],fill:n(l.fill,-.3)}]),p.push([{...l,offset:[t,0],fill:n(l.fill,.3)}]),m[0]+=2*t,a.scale=!1}return"text"===t.type&&function(t,o,s,e,r){if(null!=t.haloColor&&null!=t.haloSize){r.masking??=s.map((()=>[]));const l=i(t.haloSize);e[0]+=l,e[1]+=l,s.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),r.masking.unshift([{shape:{type:"rect",x:0,y:0,width:e[0]+2*j,height:e[1]+2*j},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(e[0]+=2*j,e[1]+=2*j,s.unshift([{shape:{type:"rect",x:0,y:0,width:e[0],height:e[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:i(t.borderLineSize)}}]),r.masking?.unshift([]))}(t,l,p,m,a),c(p,m,a)}function B(s,e=x){const i=l(s),r=m(s),a=!i||"type"in i?null:new t(i),p=r?.color?new t(r?.color):null,n=a?z(o(a),e):null,c=p?z(o(p),e):null;return c?n?n===c?n:e>=x?"light":"dark":c:n}export{B as getContrastingBackgroundTheme,C as getRenderSymbolParameters,P as previewSymbol2D};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{n as e}from"./InterleavedLayout.js";import{V as s}from"./VertexAttribute.js";import{g as n}from"./glUtil.js";import{R as o}from"../core/lang.js";import{i as r,n as a,j as i,s as c,p as l,d as f,y as u,e as d,c as p}from"./vec3.js";import{c as g}from"./vec3f64.js";import{a as h}from"./Normals.js";import{a as m,d as N}from"./mathUtils.js";import{P as I}from"../core/scheduling.js";const O=e().vec3f(s.POSITION).u16(s.COMPONENTINDEX).freeze(),S=e().vec2u8(s.SIDENESS).freeze(),A=n(S),E=e().vec3f(s.POSITION0).vec3f(s.POSITION1).vec2i16(s.NORMALCOMPRESSED).u16(s.COMPONENTINDEX).u8(s.VARIANTOFFSET,{glNormalized:!0}).u8(s.VARIANTSTROKE).u8(s.VARIANTEXTENSION,{glNormalized:!0}).freeze(),w=e().vec3f(s.POSITION0).vec3f(s.POSITION1).vec2i16(s.NORMALCOMPRESSED).vec2i16(s.NORMAL2COMPRESSED).u16(s.COMPONENTINDEX).u8(s.VARIANTOFFSET,{glNormalized:!0}).u8(s.VARIANTSTROKE).u8(s.VARIANTEXTENSION,{glNormalized:!0}).freeze(),T=new Map([[s.POSITION0,0],[s.POSITION1,1],[s.COMPONENTINDEX,2],[s.VARIANTOFFSET,3],[s.VARIANTSTROKE,4],[s.VARIANTEXTENSION,5],[s.NORMALCOMPRESSED,6],[s.NORMAL2COMPRESSED,7],[s.SIDENESS,8]]);function v(t,e,s){const n=e/3,o=new Uint32Array(s+1),r=new Uint32Array(s+1),a=(t,e)=>{t<e?o[t+1]++:r[e+1]++};for(let e=0;e<n;e++){const s=t[3*e],n=t[3*e+1],o=t[3*e+2];a(s,n),a(n,o),a(o,s)}let i=0,c=0;for(let t=0;t<s;t++){const e=o[t+1],s=r[t+1];o[t+1]=i,r[t+1]=c,i+=e,c+=s}const l=new Uint32Array(6*n),f=o[s],u=(t,e,s)=>{if(t<e){const n=o[t+1]++;l[2*n]=e,l[2*n+1]=s}else{const n=r[e+1]++;l[2*f+2*n]=t,l[2*f+2*n+1]=s}};for(let e=0;e<n;e++){const s=t[3*e],n=t[3*e+1],o=t[3*e+2];u(s,n,e),u(n,o,e),u(o,s,e)}const d=(t,e)=>{const s=2*t,n=e-t;for(let t=1;t<n;t++){const e=l[s+2*t],n=l[s+2*t+1];let o=t-1;for(;o>=0&&l[s+2*o]>e;o--)l[s+2*o+2]=l[s+2*o],l[s+2*o+3]=l[s+2*o+1];l[s+2*o+2]=e,l[s+2*o+3]=n}};for(let t=0;t<s;t++)d(o[t],o[t+1]),d(f+r[t],f+r[t+1]);const p=new Int32Array(3*n),g=(e,s)=>e===t[3*s]?0:e===t[3*s+1]?1:e===t[3*s+2]?2:-1,h=(t,e)=>{const s=g(t,e);p[3*e+s]=-1},m=(t,e,s,n)=>{const o=g(t,e);p[3*e+o]=n;const r=g(s,n);p[3*n+r]=e};for(let t=0;t<s;t++){let e=o[t];const s=o[t+1];let n=r[t];const a=r[t+1];for(;e<s&&n<a;){const s=l[2*e],o=l[2*f+2*n];s===o?(m(t,l[2*e+1],o,l[2*f+2*n+1]),e++,n++):s<o?(h(t,l[2*e+1]),e++):(h(o,l[2*f+2*n+1]),n++)}for(;e<s;)h(t,l[2*e+1]),e++;for(;n<a;)h(l[2*f+2*n],l[2*f+2*n+1]),n++}return p}class R{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?D:V}write(t,e,s){b.seed=this._edgeHashFunction(s);const n=b.getIntRange(0,255),o=b.getIntRange(0,this.settings.variants-1),r=b.getFloat();var a;const i=255*(.5*(a=-(1-Math.min(r/.7,1))+Math.max(0,r-.7)/(1-.7),Math.abs(a)**1.2*Math.sign(a))+.5);t.position0.setVec(e,s.position0),t.position1.setVec(e,s.position1),t.componentIndex.set(e,s.componentIndex),t.variantOffset.set(e,n),t.variantStroke.set(e,o),t.variantExtension.set(e,i)}}const y=new Float32Array(6),M=new Uint32Array(y.buffer),P=new Uint32Array(1);function V(t){return y[0]=t.position0[0],y[1]=t.position0[1],y[2]=t.position0[2],y[3]=t.position1[0],y[4]=t.position1[1],y[5]=t.position1[2],P[0]=31*(31*(31*(31*(31*(166811+M[0])+M[1])+M[2])+M[3])+M[4])+M[5],P[0]}function D(t){const e=y;e[0]=C(t.position0[0]),e[1]=C(t.position0[1]),e[2]=C(t.position0[2]),e[3]=C(t.position1[0]),e[4]=C(t.position1[1]),e[5]=C(t.position1[2]),P[0]=5381;for(let t=0;t<M.length;t++)P[0]=31*P[0]+M[t];return P[0]}const L=1e4;function C(t){return Math.round(t*L)/L}class x{constructor(){this._commonWriter=new R}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return E.createBuffer(t)}write(t,e,s){this._commonWriter.write(t,e,s),r(j,s.faceNormal0,s.faceNormal1),a(j,j);const{typedBuffer:n,typedBufferStride:o}=t.normalCompressed;h(n,e,j[0],j[1],j[2],o)}}x.Layout=E,x.glLayout=n(E,1);class F{constructor(){this._commonWriter=new R}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return w.createBuffer(t)}write(t,e,s){this._commonWriter.write(t,e,s);{const{typedBuffer:n,typedBufferStride:o}=t.normalCompressed;h(n,e,s.faceNormal0[0],s.faceNormal0[1],s.faceNormal0[2],o)}{const{typedBuffer:n,typedBufferStride:o}=t.normal2Compressed;h(n,e,s.faceNormal1[0],s.faceNormal1[1],s.faceNormal1[2],o)}}}F.Layout=w,F.glLayout=n(w,1);const j=g(),b=new o,z=-1;function B(t,e,s){const n=t.vertices.position,o=t.vertices.componentIndex,r=K.position0,g=K.position1,h=K.faceNormal0,N=K.faceNormal1,{edges:I,normals:O}=function(t){const e=t.faces.length/3,s=t.faces,n=t.neighbors,o=t.vertices.position;U.length=W.length=0;for(let t=0;t<e;t++){const e=3*t,r=n[e],i=n[e+1],c=n[e+2],l=s[e],f=s[e+1],u=s[e+2];o.getVec(l,q),o.getVec(f,G),o.getVec(u,J),p(G,G,q),p(J,J,q),d(q,G,J),a(q,q),W.pushArray(q),(r===z||l<f)&&(U.push(l),U.push(f),U.push(t),U.push(r)),(i===z||f<u)&&(U.push(f),U.push(u),U.push(t),U.push(i)),(c===z||u<l)&&(U.push(u),U.push(l),U.push(t),U.push(c))}return{edges:U,normals:W}}(t),S=I.length/4,A=e.allocate(S);let E=0;const w=S,T=s?.allocate(w);let v=0,R=0,y=0;_.length=0;for(let t=0;t<S;++t){const e=4*t;n.getVec(I.data[e],r),n.getVec(I.data[e+1],g);const s=_.pushNew();s.index=4*t,s.length=i(r,g)}_.sort(((t,e)=>e.length-t.length));const M=new Array,P=new Array;_.forAll((({length:t,index:a})=>{const i=I.data[a],p=I.data[a+1],S=I.data[a+2],w=I.data[a+3],V=w===z;if(n.getVec(i,r),n.getVec(p,g),V){const t=3*S;c(h,O.data[t],O.data[t+1],O.data[t+2]),l(N,h),K.componentIndex=o.get(i),K.cosAngle=f(h,N)}else{let t=3*S;if(c(h,O.data[t],O.data[t+1],O.data[t+2]),t=3*w,c(N,O.data[t],O.data[t+1],O.data[t+2]),K.componentIndex=o.get(i),K.cosAngle=f(h,N),D=Y,K.cosAngle>D)return;K.cosAngle<-.9999&&l(N,h)}var D,L;R+=t,y++,V||(L=$,K.cosAngle<L)?(e.write(A,E++,K),M.push(t)):function(t,e){const s=m(t.cosAngle);return u(H,t.position1,t.position0),s*(f(d(k,t.faceNormal0,t.faceNormal1),H)>0?-1:1)>e}(K,Q)&&(T&&s&&s.write(T,v++,K),P.push(t))}));const V=new Float32Array(M.reverse()),D=new Float32Array(P.reverse()),L=T&&s?{instancesData:T.slice(0,v),lodInfo:{lengths:D}}:void 0;return{regular:{instancesData:A.slice(0,E),lodInfo:{lengths:V}},silhouette:L,averageEdgeLength:R/y}}class X{constructor(){this.index=0,this.length=0}}const _=new I({allocator:t=>t||new X,deallocator:null}),U=new I({deallocator:null}),W=new I({deallocator:null}),K=new class{constructor(){this.position0=g(),this.position1=g(),this.faceNormal0=g(),this.faceNormal1=g(),this.componentIndex=0,this.cosAngle=0}},k=g(),H=g(),q=g(),G=g(),J=g(),Q=N(4),Y=Math.cos(Q),Z=N(35),$=Math.cos(Z);function tt(t){const e=et(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return nt.updateSettings(t.writerSettings),ot.updateSettings(t.writerSettings),B(e,nt,ot)}function et(e,s,n,o){if(s){const t=v(n,o,e.count);return new st(n,o,t,e)}const r=t(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:o}),a=v(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:O.createView(r.buffer)}}class st{constructor(t,e,s,n){this.faces=t,this.facesLength=e,this.neighbors=s,this.vertices=n}}const nt=new x,ot=new F,rt=e().vec3f(s.POSITION0).vec3f(s.POSITION1),at=e().vec3f(s.POSITION0).vec3f(s.POSITION1).u16(s.COMPONENTINDEX);export{O as E,x as R,F as S,S as V,et as a,B as b,rt as c,at as d,tt as e,T as f,A as g};

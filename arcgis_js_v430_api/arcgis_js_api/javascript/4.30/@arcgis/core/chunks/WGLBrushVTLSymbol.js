/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{i as t}from"./mathUtils.js";import{c as e}from"./mat3f32.js";import{f as a}from"./vec4f32.js";import{q as i,r as n,u as r}from"./definitions.js";import{B as s}from"./BufferObject.js";import{c as o,j as l,P as c,U as f,D as u}from"./enums.js";import{V as d}from"./VertexArrayObject.js";import{T as p,R as m,a as g}from"./StyleDefinition.js";import{c as y,f as _}from"./vec2f32.js";import{f as M}from"./config.js";class h{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(t,e){}draw(t,e,a){}drawMany(t,e,a){for(const i of e)i.visible&&this.draw(t,i,a)}}class U extends h{constructor(){super(...arguments),this._color=a(1,0,0,1),this._patternMatrix=e(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(e,a){const{context:r,painter:s,requestRender:f,allowDelayedRender:u}=e;this._loadWGLResources(e);const d=e.displayLevel,p=e.styleLayer,m=p.backgroundMaterial,g=s.vectorTilesMaterialManager,y=p.getPaintValue("background-color",d),_=p.getPaintValue("background-opacity",d),M=p.getPaintValue("background-pattern",d),h=void 0!==M,U=1|window.devicePixelRatio,E=e.spriteMosaic;let P,v;const x=U>n?2:1,I=this._programOptions;I.pattern=h;const S=g.getMaterialProgram(r,m,I);if(!u||null==f||S.compiled){if(r.bindVAO(this._vao),r.useProgram(S),h){const t=E.getMosaicItemPosition(M,!0);if(null!=t){const{tl:e,br:a,page:n}=t;P=a[0]-e[0],v=a[1]-e[1];const s=E.getPageSize(n);null!=s&&(E.bind(r,o.LINEAR,n,i),S.setUniform4f("u_tlbr",e[0],e[1],a[0],a[1]),S.setUniform2fv("u_mosaicSize",s),S.setUniform1i("u_texture",i))}S.setUniform1f("u_opacity",_)}else{const t=y[3]*_;this._color[0]=t*y[0],this._color[1]=t*y[1],this._color[2]=t*y[2],this._color[3]=t,S.setUniform4fv("u_color",this._color)}S.setUniform1f("u_depth",p.z||0);for(const e of a){if(S.setUniform1f("u_coord_range",e.rangeX),S.setUniformMatrix3fv("u_dvsMat3",e.transforms.displayViewScreenMat3),h){const a=Math.max(2**(Math.round(d)-e.key.level),1),i=x*e.width*a,n=i/t(P),r=i/t(v);this._patternMatrix[0]=n,this._patternMatrix[4]=r,S.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}r.setStencilFunction(l.EQUAL,0,255),r.drawArrays(c.TRIANGLE_STRIP,0,4)}}else f()}_loadWGLResources(t){if(this._vao)return;const{context:e,styleLayer:a}=t,i=a.backgroundMaterial,n=new Int8Array([0,0,1,0,0,1,1,1]),r=s.createVertex(e,f.STATIC_DRAW,n),o=new d(e,i.getAttributeLocations(),i.getLayoutInfo(),{geometry:r});this._vao=o}}class E extends h{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(t,e){const{context:a,displayLevel:i,requiredLevel:n,state:r,painter:s,spriteMosaic:o,styleLayerUID:f,requestRender:d,allowDelayedRender:m}=t;if(!e.some((t=>t.layerData.get(f)?.circleIndexCount??!1)))return;const g=t.styleLayer,y=g.circleMaterial,_=s.vectorTilesMaterialManager,M=g.getPaintValue("circle-translate",i),h=g.getPaintValue("circle-translate-anchor",i),U=this._programOptions,E=_.getMaterialProgram(a,y,U);if(m&&null!=d&&!E.compiled)return void d();a.useProgram(E),E.setUniformMatrix3fv("u_displayMat3",h===p.VIEWPORT?r.displayMat3:r.displayViewMat3),E.setUniform2fv("u_circleTranslation",M),E.setUniform1f("u_depth",g.z),E.setUniform1f("u_antialiasingWidth",1.2);let P=-1;for(const t of e){if(!t.layerData.has(f))continue;t.key.level!==P&&(P=t.key.level,y.setDataUniforms(E,i,g,P,o));const e=t.layerData.get(f);if(!e.circleIndexCount)continue;e.prepareForRendering(a);const r=e.vao;null!=r&&(a.bindVAO(r),E.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),n!==t.key.level?a.setStencilFunction(l.EQUAL,t.stencilRef,255):a.setStencilFunction(l.GREATER,255,255),a.drawElements(c.TRIANGLES,e.circleIndexCount,u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.circleIndexStart),t.triangleCount+=e.circleIndexCount/3)}}}const P=1/65536;class v extends h{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(t,e){const{displayLevel:a,renderPass:i,spriteMosaic:n,styleLayerUID:r}=t;let s=!1;for(const t of e)if(t.layerData.has(r)){const e=t.layerData.get(r);if(e.fillIndexCount>0||e.outlineIndexCount>0){s=!0;break}}if(!s)return;const o=t.styleLayer,l=o.getPaintProperty("fill-pattern"),c=void 0!==l,f=c&&l.isDataDriven;let u;if(c&&!f){const t=l.getValue(a);u=n.getMosaicItemPosition(t,!0)}const d=!c&&o.getPaintValue("fill-antialias",a);let p=!0,m=1;if(!c){const t=o.getPaintProperty("fill-color"),e=o.getPaintProperty("fill-opacity");if(!t?.isDataDriven&&!e?.isDataDriven){const t=o.getPaintValue("fill-color",a);m=o.getPaintValue("fill-opacity",a)*t[3],m>=1&&(p=!1)}}if(p&&"opaque"===i)return;const g=o.getPaintValue("fill-translate",a),y=o.getPaintValue("fill-translate-anchor",a);(p||"translucent"!==i)&&this._drawFill(t,r,o,e,g,y,c,u,f);const _=!o.hasDataDrivenOutlineColor&&o.outlineUsesFillColor&&m<1;d&&"opaque"!==i&&!_&&this._drawOutline(t,r,o,e,g,y)}_drawFill(t,e,a,r,s,f,d,m,g){if(d&&!g&&null==m)return;const{context:y,displayLevel:_,state:M,painter:h,pixelRatio:U,spriteMosaic:E,requestRender:v,allowDelayedRender:x}=t,I=a.fillMaterial,S=h.vectorTilesMaterialManager,R=U>n?2:1,T=this._fillProgramOptions;T.pattern=d;const D=S.getMaterialProgram(y,I,T);if(x&&null!=v&&!D.compiled)return void v();if(y.useProgram(D),null!=m){const{page:t}=m,e=E.getPageSize(t);null!=e&&(E.bind(y,o.LINEAR,t,i),D.setUniform2fv("u_mosaicSize",e),D.setUniform1i("u_texture",i))}D.setUniformMatrix3fv("u_displayMat3",f===p.VIEWPORT?M.displayMat3:M.displayViewMat3),D.setUniform2fv("u_fillTranslation",s),D.setUniform1f("u_depth",a.z+P);let V=-1;for(const t of r){if(!t.layerData.has(e))continue;t.key.level!==V&&(V=t.key.level,I.setDataUniforms(D,_,a,V,E));const n=t.layerData.get(e);if(!n.fillIndexCount)continue;n.prepareForRendering(y);const r=n.fillVAO;if(null!=r){if(y.bindVAO(r),D.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),y.setStencilFunction(l.EQUAL,t.stencilRef,255),d){const e=Math.max(2**(Math.round(_)-t.key.level),1),a=t.rangeX/(R*t.width*e);D.setUniform1f("u_patternFactor",a)}if(g){const t=n.patternMap;if(!t)continue;for(const[e,a]of t){const t=E.getPageSize(e);null!=t&&(E.bind(y,o.LINEAR,e,i),D.setUniform2fv("u_mosaicSize",t),D.setUniform1i("u_texture",i),y.drawElements(c.TRIANGLES,a[1],u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else y.drawElements(c.TRIANGLES,n.fillIndexCount,u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.fillIndexStart);t.triangleCount+=n.fillIndexCount/3}}}_drawOutline(t,e,a,i,n,r){const{context:s,displayLevel:o,state:f,painter:d,pixelRatio:m,spriteMosaic:g,requestRender:y,allowDelayedRender:_}=t,M=a.outlineMaterial,h=d.vectorTilesMaterialManager,U=.75/m,E=this._outlineProgramOptions,v=h.getMaterialProgram(s,M,E);if(_&&null!=y&&!v.compiled)return void y();s.useProgram(v),v.setUniformMatrix3fv("u_displayMat3",r===p.VIEWPORT?f.displayMat3:f.displayViewMat3),v.setUniform2fv("u_fillTranslation",n),v.setUniform1f("u_depth",a.z+P),v.setUniform1f("u_outline_width",U);let x=-1;for(const t of i){if(!t.layerData.has(e))continue;t.key.level!==x&&(x=t.key.level,M.setDataUniforms(v,o,a,x,g));const i=t.layerData.get(e);if(i.prepareForRendering(s),!i.outlineIndexCount)continue;const n=i.outlineVAO;null!=n&&(s.bindVAO(n),v.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),s.setStencilFunction(l.EQUAL,t.stencilRef,255),s.drawElements(c.TRIANGLES,i.outlineIndexCount,u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i.outlineIndexStart),t.triangleCount+=i.outlineIndexCount/3)}}}class x extends h{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(t,e){const{context:a,displayLevel:n,state:r,painter:s,pixelRatio:f,spriteMosaic:d,styleLayerUID:m,requestRender:g,allowDelayedRender:y}=t;if(!e.some((t=>t.layerData.get(m)?.lineIndexCount??!1)))return;const _=t.styleLayer,M=_.lineMaterial,h=s.vectorTilesMaterialManager,U=_.getPaintValue("line-translate",n),E=_.getPaintValue("line-translate-anchor",n),P=_.getPaintProperty("line-pattern"),v=void 0!==P,x=v&&P.isDataDriven;let I,S;if(v&&!x){const t=P.getValue(n);I=d.getMosaicItemPosition(t)}let R=!1;if(!v){const t=_.getPaintProperty("line-dasharray");if(S=void 0!==t,R=S&&t.isDataDriven,S&&!R){const e=t.getValue(n),a=_.getDashKey(e,_.getLayoutValue("line-cap",n));I=d.getMosaicItemPosition(a)}}const T=1/f,D=this._programOptions;D.pattern=v,D.sdf=S;const V=h.getMaterialProgram(a,M,D);if(y&&null!=g&&!V.compiled)return void g();if(a.useProgram(V),V.setUniformMatrix3fv("u_displayViewMat3",r.displayViewMat3),V.setUniformMatrix3fv("u_displayMat3",E===p.VIEWPORT?r.displayMat3:r.displayViewMat3),V.setUniform2fv("u_lineTranslation",U),V.setUniform1f("u_depth",_.z),V.setUniform1f("u_antialiasing",T),I&&null!=I){const{page:t}=I,e=d.getPageSize(t);null!=e&&(d.bind(a,o.LINEAR,t,i),V.setUniform2fv("u_mosaicSize",e),V.setUniform1i("u_texture",i))}let L=-1;for(const t of e){if(!t.layerData.has(m))continue;t.key.level!==L&&(L=t.key.level,M.setDataUniforms(V,n,_,L,d));const e=2**(n-L)/f;V.setUniform1f("u_zoomFactor",e);const r=t.layerData.get(m);if(!r.lineIndexCount)continue;r.prepareForRendering(a);const s=r.vao;if(null!=s){if(a.bindVAO(s),V.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),a.setStencilFunction(l.EQUAL,t.stencilRef,255),x||R){const t=r.patternMap;if(!t)continue;for(const[e,n]of t){const t=d.getPageSize(e);null!=t&&(d.bind(a,o.LINEAR,e,i),V.setUniform2fv("u_mosaicSize",t),V.setUniform1i("u_texture",i),a.drawElements(c.TRIANGLES,n[1],u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else a.drawElements(c.TRIANGLES,r.lineIndexCount,u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.lineIndexStart);t.triangleCount+=r.lineIndexCount/3}}}}const I=256/360,S=1/Math.LN2;function R(t){return e=t*I,(e%=256)>=0?e:e+256;var e}function T(t){return Math.log(t)*S}const D=1/65536;class V extends h{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=y()}dispose(){}drawMany(t,e){const a=t.styleLayer;this._drawIcons(t,a,e),this._drawText(t,a,e)}_drawIcons(t,e,a){const{context:n,displayLevel:r,painter:s,spriteMosaic:o,state:l,styleLayerUID:c,requestRender:f,allowDelayedRender:u}=t,d=e.iconMaterial,y=s.vectorTilesMaterialManager;let _,h=!1;for(const t of a)if(t.layerData.has(c)&&(_=t.layerData.get(c),_.iconPerPageElementsMap.size>0)){h=!0;break}if(!h)return;const U=e.getPaintValue("icon-translate",r),E=e.getPaintValue("icon-translate-anchor",r);let P=e.getLayoutValue("icon-rotation-alignment",r);P===m.AUTO&&(P=e.getLayoutValue("symbol-placement",r)===g.POINT?m.VIEWPORT:m.MAP);const v=P===m.MAP,x=e.getLayoutValue("icon-keep-upright",r)&&v,I=_.isIconSDF,S=this._iconProgramOptions;S.sdf=I;const T=y.getMaterialProgram(n,d,S);if(u&&null!=f&&!T.compiled)return void f();n.useProgram(T),T.setUniformMatrix3fv("u_displayViewMat3",P===m.MAP?l.displayViewMat3:l.displayMat3),T.setUniformMatrix3fv("u_displayMat3",E===p.VIEWPORT?l.displayMat3:l.displayViewMat3),T.setUniform2fv("u_iconTranslation",U),T.setUniform1f("u_depth",e.z),T.setUniform1f("u_mapRotation",R(l.rotation)),T.setUniform1f("u_keepUpright",x?1:0),T.setUniform1f("u_level",10*r),T.setUniform1i("u_texture",i),T.setUniform1f("u_fadeDuration",M/1e3);let D=-1;for(const i of a){if(!i.layerData.has(c))continue;if(i.key.level!==D&&(D=i.key.level,d.setDataUniforms(T,r,e,D,o)),_=i.layerData.get(c),0===_.iconPerPageElementsMap.size)continue;_.prepareForRendering(n),_.updateOpacityInfo();const a=_.iconVAO;if(null!=a){n.bindVAO(a),T.setUniformMatrix3fv("u_dvsMat3",i.transforms.displayViewScreenMat3),T.setUniform1f("u_time",(performance.now()-_.lastOpacityUpdate)/1e3);for(const[e,a]of _.iconPerPageElementsMap)this._renderIconRange(t,T,a,e,i)}}}_renderIconRange(t,e,a,n,r){const{context:s,spriteMosaic:l}=t;this._spritesTextureSize[0]=l.getWidth(n)/4,this._spritesTextureSize[1]=l.getHeight(n)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),l.bind(s,o.LINEAR,n,i),this._setStencilState(t,r),s.drawElements(c.TRIANGLES,a[1],u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3}_drawText(t,e,a){const{context:i,displayLevel:n,glyphMosaic:s,painter:o,pixelRatio:l,spriteMosaic:c,state:f,styleLayerUID:u,requestRender:d,allowDelayedRender:y}=t,h=e.textMaterial,U=o.vectorTilesMaterialManager;let E,P=!1;for(const t of a)if(t.layerData.has(u)&&(E=t.layerData.get(u),E.glyphPerPageElementsMap.size>0)){P=!0;break}if(!P)return;const v=e.getPaintProperty("text-opacity");if(v&&!v.isDataDriven&&0===v.getValue(n))return;const x=e.getPaintProperty("text-color"),I=!x||x.isDataDriven||x.getValue(n)[3]>0,S=e.getPaintProperty("text-halo-width"),T=e.getPaintProperty("text-halo-color"),V=(!S||S.isDataDriven||S.getValue(n)>0)&&(!T||T.isDataDriven||T.getValue(n)[3]>0);if(!I&&!V)return;let L=e.getLayoutValue("text-rotation-alignment",n);L===m.AUTO&&(L=e.getLayoutValue("symbol-placement",n)===g.POINT?m.VIEWPORT:m.MAP);const w=L===m.MAP,A=e.getLayoutValue("text-keep-upright",n)&&w,N=.8*3/l;this._glyphTextureSize||(this._glyphTextureSize=_(s.width/4,s.height/4));const O=e.getPaintValue("text-translate",n),b=e.getPaintValue("text-translate-anchor",n),z=this._sdfProgramOptions,k=U.getMaterialProgram(i,h,z);if(y&&null!=d&&!k.compiled)return void d();i.useProgram(k),k.setUniformMatrix3fv("u_displayViewMat3",L===m.MAP?f.displayViewMat3:f.displayMat3),k.setUniformMatrix3fv("u_displayMat3",b===p.VIEWPORT?f.displayMat3:f.displayViewMat3),k.setUniform2fv("u_textTranslation",O),k.setUniform1f("u_depth",e.z+D),k.setUniform2fv("u_mosaicSize",this._glyphTextureSize),k.setUniform1f("u_mapRotation",R(f.rotation)),k.setUniform1f("u_keepUpright",A?1:0),k.setUniform1f("u_level",10*n),k.setUniform1i("u_texture",r),k.setUniform1f("u_antialiasingWidth",N),k.setUniform1f("u_fadeDuration",M/1e3);let C=-1;for(const r of a){if(!r.layerData.has(u))continue;if(r.key.level!==C&&(C=r.key.level,h.setDataUniforms(k,n,e,C,c)),E=r.layerData.get(u),0===E.glyphPerPageElementsMap.size)continue;E.prepareForRendering(i),E.updateOpacityInfo();const a=E.textVAO;if(null==a)continue;i.bindVAO(a),k.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),this._setStencilState(t,r);const o=(performance.now()-E.lastOpacityUpdate)/1e3;k.setUniform1f("u_time",o),E.glyphPerPageElementsMap.forEach(((t,e)=>{this._renderGlyphRange(i,t,e,s,k,V,I,r)}))}}_renderGlyphRange(t,e,a,i,n,s,l,f){i.bind(t,o.LINEAR,a,r),s&&(n.setUniform1f("u_halo",1),t.drawElements(c.TRIANGLES,e[1],u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),f.triangleCount+=e[1]/3),l&&(n.setUniform1f("u_halo",0),t.drawElements(c.TRIANGLES,e[1],u.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),f.triangleCount+=e[1]/3)}_setStencilState(t,e){const{context:a,is3D:i,stencilSymbols:n}=t;if(a.setStencilTestEnabled(!0),n)return a.setStencilWriteMask(255),void a.setStencilFunction(l.ALWAYS,e.stencilRef,255);a.setStencilWriteMask(0),i?a.setStencilFunction(l.EQUAL,e.stencilRef,255):a.setStencilFunction(l.GREATER,255,255)}}export{U as W,v as a,x as b,E as c,V as d,h as e,T as l};

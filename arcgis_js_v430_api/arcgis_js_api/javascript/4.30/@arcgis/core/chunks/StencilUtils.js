/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{n as e,d as t,g as r,s as i,K as n}from"../core/lang.js";import{I as s,a,c as o}from"./mat4f64.js";import{a as l,m as c,s as u,i as d,b as h,G as m,h as f,c as _}from"./vec3.js";import{c as p,a as g}from"./Indices.js";import{O as v,R as T,T as A,S as E}from"./basicInterfaces.js";import{P as S}from"../core/scheduling.js";import{c as x,f as I,e as b,Z as P}from"./vec3f64.js";import{a as y}from"./Util.js";import{d as R,C as M,R as C}from"./Material.js";import{b as w}from"./triangle.js";import{g as L}from"../core/Accessor.js";import{V as D}from"./VertexAttribute.js";import{e as N,a as z,b as O}from"./doublePrecisionUtils.js";import{_ as F}from"./tslib.es6.js";import{f as U,n as B}from"./mat3.js";import{c as G}from"./mat3f64.js";import{U as H,b as V,a as j,F as $,c as k,M as q,D as K,S as X,R as W}from"./Matrix4PassUniform.js";import{l as Q,r as Y,h as Z,j as J,d as ee,o as te,m as re,s as ie,w as ne}from"./mat4.js";import{B as se}from"./BindType.js";import{N as ae,g as oe}from"./interfaces3.js";import{p as le,S as ce}from"./ShaderTechniqueConfiguration.js";import{c as ue}from"./mathUtils.js";import{m as de}from"./lengthUtils.js";import{d as he}from"./debugFlags2.js";import me from"../core/Error.js";import fe from"../core/Evented.js";import{f as _e,r as pe}from"./maybe.js";import{throwIfAborted as ge,onAbort as ve,createAbortError as Te}from"../core/promiseUtils.js";import{isBlobProtocol as Ae,isDataProtocol as Ee}from"../core/urlUtils.js";import{r as Se}from"./requestImageUtils.js";import{l as xe}from"../request.js";import{g as Ie}from"./assets.js";import{m as be,d as Pe,c as ye,T as Re,P as Me,g as Ce,j as we,f as Le,k as De}from"./enums.js";import{T as Ne,e as ze,a as Oe,w as Fe}from"./Texture.js";import{L as Ue}from"./Logger.js";import{g as Be}from"./vec2.js";import{c as Ge}from"./vec2f64.js";import{b as He,d as Ve}from"./renderState.js";class je{constructor(e){this.channel=e,this.id=L()}}function $e(e,t){return null==e&&(e=[]),e.push(t),e}function ke(e,t){if(null==e)return null;const r=e.filter((e=>e!==t));return 0===r.length?null:r}function qe(e,t,r,i,n){Ke[0]=e.get(t,0),Ke[1]=e.get(t,1),Ke[2]=e.get(t,2),N(Ke,Xe,3),r.set(n,0,Xe[0]),i.set(n,0,Xe[1]),r.set(n,1,Xe[2]),i.set(n,1,Xe[3]),r.set(n,2,Xe[4]),i.set(n,2,Xe[5])}const Ke=x(),Xe=new Float32Array(6);function We(t,r=!1){return t<=e?r?new Array(t).fill(0):new Array(t):new Float32Array(t)}function Qe(r){return t(r)?r.length<e?r:new Float32Array(r):r.length<e?Array.from(r):r}function Ye(r){return(t(r)?r.length:r.byteLength/8)<=e?Array.from(r):new Float32Array(r)}function Ze(e,t,r){return Array.isArray(e)?e.slice(t,t+r):e.subarray(t,t+r)}function Je(i){if(i.length<e)return Array.from(i);if(t(i))return Float64Array.from(i);if(!("BYTES_PER_ELEMENT"in i))return Array.from(i);switch(i.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(i);case 2:return r(i)?Uint16Array.from(i):Int16Array.from(i);case 4:return Float32Array.from(i);default:return Float64Array.from(i)}}class et{constructor(e,t,r){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=r,this._children=void 0,y(e.length>=1),y(3===r.size||4===r.size);const{data:i,size:n,indices:s}=r;y(s.length%this._numIndexPerPrimitive==0),y(s.length>=e.length*this._numIndexPerPrimitive);const a=e.length;let o=n*s[this._numIndexPerPrimitive*e[0]];tt.clear(),tt.push(o);const c=I(i[o],i[o+1],i[o+2]),u=b(c);for(let t=0;t<a;++t){const r=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){o=n*s[r+e],tt.push(o);let t=i[o];c[0]=Math.min(t,c[0]),u[0]=Math.max(t,u[0]),t=i[o+1],c[1]=Math.min(t,c[1]),u[1]=Math.max(t,u[1]),t=i[o+2],c[2]=Math.min(t,c[2]),u[2]=Math.max(t,u[2])}}this.bbMin=c,this.bbMax=u;const d=l(x(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(u[0]-c[0],u[1]-c[1]),u[2]-c[2]);let h=this.radius*this.radius;for(let e=0;e<tt.length;++e){o=tt.at(e);const t=i[o]-d[0],r=i[o+1]-d[1],n=i[o+2]-d[2],s=t*t+r*r+n*n;if(s<=h)continue;const a=Math.sqrt(s),l=.5*(a-this.radius);this.radius=this.radius+l,h=this.radius*this.radius;const c=l/a;d[0]+=t*c,d[1]+=r*c,d[2]+=n*c}this.center=d,tt.clear()}getChildren(){if(this._children||c(this.bbMin,this.bbMax)<=1)return this._children;const e=l(x(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,r=new Uint8Array(t),i=new Array(8);for(let e=0;e<8;++e)i[e]=0;const{data:n,size:s,indices:a}=this.position;for(let o=0;o<t;++o){let t=0;const l=this._numIndexPerPrimitive*this.primitiveIndices[o];let c=s*a[l],u=n[c],d=n[c+1],h=n[c+2];for(let e=1;e<this._numIndexPerPrimitive;++e){c=s*a[l+e];const t=n[c],r=n[c+1],i=n[c+2];t<u&&(u=t),r<d&&(d=r),i<h&&(h=i)}u<e[0]&&(t|=1),d<e[1]&&(t|=2),h<e[2]&&(t|=4),r[o]=t,++i[t]}let o=0;for(let e=0;e<8;++e)i[e]>0&&++o;if(o<2)return;const u=new Array(8);for(let e=0;e<8;++e)u[e]=i[e]>0?new Uint32Array(i[e]):void 0;for(let e=0;e<8;++e)i[e]=0;for(let e=0;e<t;++e){const t=r[e];u[t][i[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==u[e]&&this._children.push(new et(u[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){tt.prune()}}const tt=new S({deallocator:null}),rt=x(),it=x(),nt=x(),st=x();class at extends R{constructor(e,t,r=null,i=M.Mesh,n=null,s=-1){super(),this.material=e,this.mapPositions=r,this.type=i,this.objectAndLayerIdColor=n,this.edgeIndicesLength=s,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,r]of t)this._attributes.set(e,{...r,indices:p(r.indices)}),e===D.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new at(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((e,r)=>{e.exclusive=!1,t._attributes.set(r,e)})),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:Je(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const r=this._attributes.get(e);r&&this._attributes.set(e,{...r,exclusive:!0,data:t})}get indexCount(){const e=this._attributes.values().next().value.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return null==this._boundingInfo&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===M.Mesh?this._computeAttachmentOriginTriangles(e):this.type===M.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&f(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){return function(e,t){if(!e)return!1;const{size:r,data:i,indices:n}=e;u(t,0,0,0),u(st,0,0,0);let s=0,a=0;for(let e=0;e<n.length-2;e+=3){const o=n[e]*r,l=n[e+1]*r,c=n[e+2]*r;u(rt,i[o],i[o+1],i[o+2]),u(it,i[l],i[l+1],i[l+2]),u(nt,i[c],i[c+1],i[c+2]);const m=w(rt,it,nt);m?(d(rt,rt,it),d(rt,rt,nt),h(rt,rt,1/3*m),d(t,t,rt),s+=m):(d(st,st,rt),d(st,st,it),d(st,st,nt),a+=3)}return!(0===a&&0===s||(0!==s?(h(t,t,1/s),0):0===a||(h(t,st,1/a),0)))}(this.attributes.get(D.POSITION),e)}_computeAttachmentOriginLines(e){const t=this.attributes.get(D.POSITION);return function(e,t,r){if(!e)return!1;u(r,0,0,0),u(st,0,0,0);let i=0,n=0;const{size:s,data:a,indices:o}=e,l=o.length-1,c=l+(t?2:0);for(let e=0;e<c;e+=2){const t=e<l?e+1:0,c=o[e<l?e:l]*s,u=o[t]*s;rt[0]=a[c],rt[1]=a[c+1],rt[2]=a[c+2],it[0]=a[u],it[1]=a[u+1],it[2]=a[u+2],h(rt,d(rt,rt,it),.5);const f=m(rt,it);f>0?(d(r,r,h(rt,rt,f)),i+=f):0===i&&(d(st,st,rt),n++)}return 0!==i?(h(r,r,1/i),!0):0!==n&&(h(r,st,1/n),!0)}(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){return function(e,t){if(!e)return!1;const{size:r,data:i,indices:n}=e;u(t,0,0,0);let s=-1,a=0;for(let e=0;e<n.length;e++){const o=n[e]*r;s!==o&&(t[0]+=i[o],t[1]+=i[o+1],t[2]+=i[o+2],a++),s=o}return a>1&&h(t,t,1/a),a>0}(this.attributes.get(D.POSITION),e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get(D.POSITION);if(!e||0===e.indices.length)return null;const t=this.type===M.Mesh?3:1;y(e.indices.length%t==0,"Indexing error: "+e.indices.length+" not divisible by "+t);const r=g(e.indices.length/t);return new et(r,t,e)}get transformation(){return this._transformation??s}set transformation(e){this._transformation=e&&e!==s?a(e):null}addHighlight(){const e=new je(v.Highlight);return this.highlights=$e(this.highlights,e),e}removeHighlight(e){this.highlights=ke(this.highlights,e)}}class ot{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){this._techniques.release(this._technique)}get technique(){return this._technique}get _stippleTextures(){return this._techniques.constructionContext.stippleTextures}get _markerTextures(){return this._techniques.constructionContext.markerTextures}ensureTechnique(e,t){return this._technique=this._techniques.releaseAndAcquire(e,this._material.getConfiguration(this._output,t),this._technique),this._technique}ensureResources(e){return T.LOADED}}var lt,ct,ut;!function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_NO_SSAO_DEPTH=3]="OPAQUE_NO_SSAO_DEPTH",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_NO_SSAO_DEPTH=5]="TRANSPARENT_NO_SSAO_DEPTH",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=7]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.OPAQUE_ENVIRONMENT=12]="OPAQUE_ENVIRONMENT",e[e.TRANSPARENT_ENVIRONMENT=13]="TRANSPARENT_ENVIRONMENT",e[e.LASERLINES=14]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=15]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=16]="HUD_MATERIAL",e[e.LABEL_MATERIAL=17]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=18]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=19]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=20]="DRAPED_MATERIAL",e[e.DRAPED_WATER=21]="DRAPED_WATER",e[e.VIEWSHED=22]="VIEWSHED",e[e.VOXEL=23]="VOXEL",e[e.MAX_SLOTS=24]="MAX_SLOTS"}(lt||(lt={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"}(ct||(ct={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(ut||(ut={}));class dt{constructor(e){this.field=e}}class ht extends dt{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[ct.Undefined,ct.Undefined,ct.Undefined]}}class mt extends dt{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0]}}class ft extends dt{constructor(e){super(e),this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class _t{}function pt(e){return null!=e}function gt(e){return"number"==typeof e}function vt(e){return"string"==typeof e}function Tt(e,t,r,i,n){const s=e.minSize,a=e.maxSize;if(e.useSymbolValue){const e=i.symbolSize[r];return t.minSize[r]=e,t.maxSize[r]=e,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=ct.DefinedSize,!0}if(pt(e.field))return pt(e.stops)?!(2!==e.stops.length||!gt(e.stops[0].size)||!gt(e.stops[1].size)||(At(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,r),t.type[r]=ct.DefinedSize,0)):gt(s)&&gt(a)&&pt(e.minDataValue)&&pt(e.maxDataValue)?(At(s,a,e.minDataValue,e.maxDataValue,t,r),t.type[r]=ct.DefinedSize,!0):"unknown"!==e.valueUnit&&null!=de[e.valueUnit]&&(t.minSize[r]=-1/0,t.maxSize[r]=1/0,t.offset[r]=0,t.factor[r]=1/de[e.valueUnit],t.type[r]=ct.DefinedSize,!0);if(!pt(e.field)){if(e.stops?.[0]&&gt(e.stops[0].size))return t.minSize[r]=e.stops[0].size,t.maxSize[r]=e.stops[0].size,t.offset[r]=t.minSize[r],t.factor[r]=0,t.type[r]=ct.DefinedSize,!0;if(gt(s))return t.minSize[r]=s,t.maxSize[r]=s,t.offset[r]=s,t.factor[r]=0,t.type[r]=ct.DefinedSize,!0}return!1}function At(e,t,r,i,n,s){const a=Math.abs(i-r)>0?(t-e)/(i-r):0;n.minSize[s]=a>0?e:t,n.maxSize[s]=a>0?t:e,n.offset[s]=e-r*a,n.factor[s]=a}function Et(e,t,r){e[4*t]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function St(e,t,r){const i=2===r&&"arithmetic"===e.rotationType;t.offset[r]=i?90:0,t.factor[r]=i?-1:1,t.type[r]=1}class xt{constructor(e,t=[1,1,1],r=[1,1,1],i=1,n=[0,0,0],s=[1,1,1],a=[0,0,0]){this.supports=e,this.modelSize=t,this.symbolSize=r,this.unitInMeters=i,this.anchor=n,this.scale=s,this.rotation=a}}function It(e,t,r){if(!e)return null;const i=e.reduce(((e,r)=>{if(!e)return e;if(r.valueExpression)return null;switch(r.type){case"size":return t.supports.size?function(e,t,r,i){if(e.normalizationField||e.valueRepresentation)return null;if(null!=(n=e.field)&&!vt(n))return null;var n;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new ht(e.field);let s;switch(e.axis){case"width":return s=Tt(e,t.size,0,r),s?t:null;case"height":return s=Tt(e,t.size,2,r),s?t:null;case"depth":return s=Tt(e,t.size,1,r),s?t:null;case"width-and-depth":return s=Tt(e,t.size,0,r),s&&Tt(e,t.size,1,r),s?t:null;case null:case void 0:case"all":return s=Tt(e,t.size,0,r),s=s&&Tt(e,t.size,1,r),s=s&&Tt(e,t.size,2,r),s?t:null;default:return e.axis,null}}(r,e,t):e;case"color":return t.supports.color?function(e,t,r){if(e.normalizationField)return null;if(vt(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new mt(e.field);const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,Et(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,Et(t.color.colors,e,r)}}return t}(r,e):e;case"opacity":return t.supports.opacity?function(e,t,r){if(e.normalizationField)return null;if(vt(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new ft(e.field);const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=r}}return t}(r,e):null;case"rotation":return t.supports.rotation?function(e,t,r){if(!vt(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return St(e,t.rotation,0),t;case"roll":return St(e,t.rotation,1),t;case null:case void 0:case"heading":return St(e,t.rotation,2),t;default:return e.axis,null}}(r,e):e;default:return null}}),new _t);return!(e.length>0&&i)||i.size||i.color||i.opacity||i.rotation?i?.size&&!function(e,t,r){for(let r=0;r<3;++r){let i=t.unitInMeters;e.type[r]===ct.DefinedSize&&(i*=t.modelSize[r],e.type[r]=ct.DefinedScale),e.minSize[r]=e.minSize[r]/i,e.maxSize[r]=e.maxSize[r]/i,e.offset[r]=e.offset[r]/i,e.factor[r]=e.factor[r]/i}let i;if(e.type[0]!==ct.Undefined)i=0;else if(e.type[1]!==ct.Undefined)i=1;else{if(e.type[2]===ct.Undefined)return!1;i=2}for(let t=0;t<3;++t)e.type[t]===ct.Undefined&&(e.minSize[t]=e.minSize[i],e.maxSize[t]=e.maxSize[i],e.offset[t]=e.offset[i],e.factor[t]=e.factor[i],e.type[t]=e.type[i]);return!0}(i.size,t)?null:i:null}class bt{constructor(e,t,r){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=r}}function Pt(e,t){if(!e)return null;if(he.TESTS_DISABLE_FAST_UPDATES)return null;const r=It(e.visualVariables,t);return r?new bt(r,Ct(r,t),!!r.size):null}function yt(e,t,r){if(!t||!e)return!1;const i=e.visualVariables,n=It(t.visualVariables,r);return!!n&&!!(Rt(i.size,n.size,"size")&&Rt(i.color,n.color,"color")&&Rt(i.rotation,n.rotation,"rotation")&&Rt(i.opacity,n.opacity,"opacity"))&&(e.visualVariables=n,e.materialParameters=Ct(n,r),e.requiresShaderTransformation=!!n.size,!0)}function Rt(e,t,r){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===r){const r=e,i=t;for(let e=0;e<3;e++)if(r.type[e]!==i.type[e]||r.offset[e]!==i.offset[e]||r.factor[e]!==i.factor[e])return!1}return!0}class Mt extends ae{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}}function Ct(e,t){const r=new Mt(e);return r.vvSize&&(r.vvSymbolAnchor=t.anchor,Q(Ot),function(e,t,r,i=o()){const n=e||0,s=t||0,a=r||0;0!==n&&Y(i,i,-n/180*Math.PI),0!==s&&Z(i,i,s/180*Math.PI),0!==a&&J(i,i,a/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],Ot),r.vvSymbolRotationMatrix=r.vvSymbolRotationMatrix||G(),U(r.vvSymbolRotationMatrix,Ot)),r}function wt(e,t,r){if(!e.vvSize)return r;ee(Nt,r);const i=e.vvSymbolRotationMatrix;te(Ot,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),re(Nt,Nt,Ot);for(let r=0;r<3;++r){const i=e.vvSize.offset[r]+t[0]*e.vvSize.factor[r];zt[r]=ue(i,e.vvSize.minSize[r],e.vvSize.maxSize[r])}return ie(Nt,Nt,zt),ne(Nt,Nt,e.vvSymbolAnchor),Nt}function Lt(e,t,r){if(!t.vvSize)return u(e,1,1,1),e;for(let i=0;i<3;++i){const n=t.vvSize.offset[i]+r[0]*t.vvSize.factor[i];e[i]=ue(n,t.vvSize.minSize[i],t.vvSize.maxSize[i])}return e}function Dt(e,t){const r=null==e?0:t.attributes[e];return"number"==typeof r&&isFinite(r)?r:0}const Nt=o(),zt=x(),Ot=o();class Ft extends Mt{constructor(){super(...arguments),this.renderOccluded=C.Occlude,this.isDecoration=!1}}const Ut=8;var Bt;!function(e){e[e.ColorAlpha=0]="ColorAlpha",e[e.FrontFace=1]="FrontFace",e[e.NONE=2]="NONE",e[e.COUNT=3]="COUNT"}(Bt||(Bt={}));class Gt extends H{constructor(e,t){super(e,"mat4",se.Draw,((r,i,n)=>r.setUniformMatrix4fv(e,t(i,n))))}}function Ht(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",P):e.uniforms.add(new V("cameraPosition",((e,t)=>u($t,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2]))))}function Vt(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new j("proj",((e,t)=>t.camera.projectionMatrix)),new Gt("view",((e,t)=>ne(jt,t.camera.viewMatrix,e.origin))),new V("localOrigin",(e=>e.origin)));const r=e=>u($t,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]);e.uniforms.add(new j("proj",((e,t)=>t.camera.projectionMatrix)),new j("view",((e,t)=>ne(jt,t.camera.viewMatrix,r(t)))),new $("localOrigin",((e,t)=>r(t))))}const jt=o(),$t=x();function kt(e){e.uniforms.add(new j("viewNormal",((e,t)=>t.camera.viewInverseTransposeMatrix)))}function qt(e){e.uniforms.add(new k("pixelRatio",((e,t)=>t.camera.pixelRatio/t.overlayStretch)))}class Kt extends ce{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}F([le()],Kt.prototype,"instancedDoublePrecision",void 0),F([le()],Kt.prototype,"hasModelTransformation",void 0);const Xt=G();function Wt(e,t){const r=t.hasModelTransformation,i=t.instancedDoublePrecision;r&&(e.vertex.uniforms.add(new j("model",(e=>e.modelTransformation??s))),e.vertex.uniforms.add(new q("normalLocalOriginFromModel",(e=>(B(Xt,e.modelTransformation??s),Xt))))),t.instanced&&i&&(e.attributes.add(D.INSTANCEMODELORIGINHI,"vec3"),e.attributes.add(D.INSTANCEMODELORIGINLO,"vec3"),e.attributes.add(D.INSTANCEMODEL,"mat3"),e.attributes.add(D.INSTANCEMODELNORMAL,"mat3"));const n=e.vertex;i&&(n.include(K,t),n.uniforms.add(new V("viewOriginHi",((e,t)=>z(u(Qt,t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]),Qt))),new V("viewOriginLo",((e,t)=>O(u(Qt,t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]),Qt))))),n.code.add(oe`
    vec3 getVertexInLocalOriginSpace() {
      return ${r?i?"(model * vec4(instanceModel * localPosition().xyz, 1.0)).xyz":"(model * localPosition()).xyz":i?"instanceModel * localPosition().xyz":"localPosition().xyz"};
    }

    vec3 subtractOrigin(vec3 _pos) {
      ${i?oe`
          // Negated inputs are intentionally the first two arguments. The other way around the obfuscation in dpAdd() stopped
          // working for macOS 14+ and iOS 17+.
          // Issue: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/56280
          vec3 originDelta = dpAdd(-instanceModelOriginHi, -instanceModelOriginLo, viewOriginHi, viewOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),n.code.add(oe`
    vec3 dpNormal(vec4 _normal) {
      return normalize(${r?i?"normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz)":"normalLocalOriginFromModel * _normal.xyz":i?"instanceModelNormal * _normal.xyz":"_normal.xyz"});
    }
    `),t.output===X.Normal&&(kt(n),n.code.add(oe`
    vec3 dpNormalView(vec4 _normal) {
      return normalize((viewNormal * ${r?i?"vec4(normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz), 1.0)":"vec4(normalLocalOriginFromModel * _normal.xyz, 1.0)":i?"vec4(instanceModelNormal * _normal.xyz, 1.0)":"_normal"}).xyz);
    }
    `)),t.hasVertexTangents&&n.code.add(oe`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${r?i?"return vec4(normalLocalOriginFromModel * (instanceModelNormal * _tangent.xyz), _tangent.w);":"return vec4(normalLocalOriginFromModel * _tangent.xyz, _tangent.w);":i?"return vec4(instanceModelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}
    }`)}const Qt=x();class Yt extends Kt{}F([le({constValue:!0})],Yt.prototype,"hasSliceHighlight",void 0),F([le({constValue:!1})],Yt.prototype,"hasSliceInVertexProgram",void 0),F([le({constValue:se.Pass})],Yt.prototype,"pbrTextureBindType",void 0);class Zt extends ae{constructor(e){super(),this.slicePlaneLocalOrigin=e}}function Jt(e,t){tr(e,t,new $("slicePlaneOrigin",((e,r)=>sr(t,e,r))),new $("slicePlaneBasis1",((e,r)=>ar(t,e,r,r.slicePlane?.basis1))),new $("slicePlaneBasis2",((e,r)=>ar(t,e,r,r.slicePlane?.basis2))))}function er(e,t){tr(e,t,new V("slicePlaneOrigin",((e,r)=>sr(t,e,r))),new V("slicePlaneBasis1",((e,r)=>ar(t,e,r,r.slicePlane?.basis1))),new V("slicePlaneBasis2",((e,r)=>ar(t,e,r,r.slicePlane?.basis2))))}function tr(e,t,...r){if(!t.hasSlicePlane){const r=oe`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return t.hasSliceInVertexProgram&&e.vertex.code.add(r),void e.fragment.code.add(r)}t.hasSliceInVertexProgram&&e.vertex.uniforms.add(...r),e.fragment.uniforms.add(...r);const i=oe`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,n=oe`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,s=t.hasSliceHighlight?oe`
        ${n}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:oe`#define highlightSlice(_color_, _pos_) (_color_)`;t.hasSliceInVertexProgram&&e.vertex.code.add(i),e.fragment.code.add(i),e.fragment.code.add(s)}function rr(e,t,r){return e.instancedDoublePrecision?u(or,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function ir(e,t){return null!=e?_(lr,t.origin,e):t.origin}function nr(e,t,r){return e.hasSliceTranslatedView?null!=t?ne(ur,r.camera.viewMatrix,t):r.camera.viewMatrix:null}function sr(e,t,r){if(null==r.slicePlane)return P;const i=rr(e,t,r),n=ir(i,r.slicePlane),s=nr(e,i,r);return null!=s?f(lr,n,s):n}function ar(e,t,r,i){if(null==i||null==r.slicePlane)return P;const n=rr(e,t,r),s=ir(n,r.slicePlane),a=nr(e,n,r);return null!=a?(d(cr,i,s),f(lr,s,a),f(cr,cr,a),_(cr,cr,lr)):i}const or=x(),lr=x(),cr=x(),ur=o();function dr(e,t){const r=t.output===X.ObjectAndLayerIdColor,i=t.objectAndLayerIdColorInstanced;r&&(e.varyings.add("objectAndLayerIdColorVarying","vec4"),i?e.attributes.add(D.INSTANCEOBJECTANDLAYERIDCOLOR,"vec4"):e.attributes.add(D.OBJECTANDLAYERIDCOLOR,"vec4")),e.vertex.code.add(oe`
     void forwardObjectAndLayerIdColor() {
      ${r?i?oe`objectAndLayerIdColorVarying = instanceObjectAndLayerIdColor * 0.003921568627451;`:oe`objectAndLayerIdColorVarying = objectAndLayerIdColor * 0.003921568627451;`:oe``} }`),e.fragment.code.add(oe`
      void outputObjectAndLayerIdColor() {
        ${r?oe`fragColor = objectAndLayerIdColorVarying;`:oe``} }`)}class hr extends H{constructor(e,t,r){super(e,"vec4",se.Pass,((r,i,n)=>r.setUniform4fv(e,t(i,n))),r)}}class mr extends H{constructor(e,t,r){super(e,"float",se.Pass,((r,i,n)=>r.setUniform1fv(e,t(i,n))),r)}}function fr(e,t){const{vertex:r,attributes:i}=e;t.hasVvInstancing&&(t.vvSize||t.vvColor)&&i.add(D.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(r.uniforms.add(new $("vvSizeMinSize",(e=>e.vvSize.minSize))),r.uniforms.add(new $("vvSizeMaxSize",(e=>e.vvSize.maxSize))),r.uniforms.add(new $("vvSizeOffset",(e=>e.vvSize.offset))),r.uniforms.add(new $("vvSizeFactor",(e=>e.vvSize.factor))),r.uniforms.add(new q("vvSymbolRotationMatrix",(e=>e.vvSymbolRotationMatrix))),r.uniforms.add(new $("vvSymbolAnchor",(e=>e.vvSymbolAnchor))),r.code.add(oe`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),r.code.add(oe`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.hasVvInstancing?oe`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):r.code.add(oe`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(r.constants.add("vvColorNumber","int",8),r.uniforms.add(new mr("vvColorValues",(e=>e.vvColor.values),8),new hr("vvColorColors",(e=>e.vvColor.colors),8)),r.code.add(oe`
      vec4 interpolateVVColor(float value) {
        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVvInstancing?oe`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):r.code.add(oe`vec4 vvColor() { return vec4(1.0); }`)}class _r extends H{constructor(e,t){super(e,"vec4",se.Pass,((r,i,n)=>r.setUniform4fv(e,t(i,n))))}}class pr extends H{constructor(e,t){super(e,"sampler2D",se.Pass,((r,i,n)=>r.bindTexture(e,t(i,n))))}}let gr;var vr;!function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"}(vr||(vr={}));let Tr=null,Ar=null;async function Er(){return null==Ar&&(gr??=(async()=>{const e=await import("./basis_transcoder.js"),t=await e.default({locateFile:e=>Ie(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),Ar=gr,Tr=await Ar),Ar}function Sr(e,t,r,i,n){const s=ze(t?be.COMPRESSED_RGBA8_ETC2_EAC:be.COMPRESSED_RGB8_ETC2),a=n&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*i*s*a)}function xr(e){return e.getNumImages()>=1&&!e.isUASTC()}function Ir(e){return e.getFaces()>=1&&e.isETC1S()}function br(e,t,r,i,n,s,a,o){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[u,d]=l?i?[vr.ETC2_RGBA,be.COMPRESSED_RGBA8_ETC2_EAC]:[vr.ETC1_RGB,be.COMPRESSED_RGB8_ETC2]:c?i?[vr.BC3_RGBA,be.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[vr.BC1_RGB,be.COMPRESSED_RGB_S3TC_DXT1_EXT]:[vr.RGBA32,Pe.RGBA],h=t.hasMipmap?r:Math.min(1,r),m=[];for(let e=0;e<h;e++)m.push(new Uint8Array(a(e,u))),o(e,u,m[e]);return t.internalFormat=d,t.hasMipmap=m.length>1,t.samplingMode=t.hasMipmap?ye.LINEAR_MIPMAP_LINEAR:ye.LINEAR,t.width=n,t.height=s,new Ne(e,t,{type:"compressed",levels:m})}const Pr=()=>Ue.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function yr(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Rr=yr("DXT1"),Mr=yr("DXT3"),Cr=yr("DXT5");function wr(e){return 16*Math.ceil(e/16)}function Lr(e){return 16*Math.floor(e/16)}function Dr(e,t){let r=e.width*e.height;if(r<4096)return e instanceof ImageData?zr(e):e;let i=e.width,n=e.height;do{i=Math.ceil(i/2),n=Math.ceil(n/2),r=i*n}while(r>1048576||null!=t&&(i>t||n>t));return Nr(e,i,n)}function Nr(e,t,r){if(e instanceof ImageData)return Nr(zr(e),t,r);const i=document.createElement("canvas");return i.width=t,i.height=r,i.getContext("2d").drawImage(e,0,0,i.width,i.height),i}function zr(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");if(null==r)throw new me("Failed to create 2d context from HTMLCanvasElement");return r.putImageData(e,0,0),t}class Or extends R{get parameters(){return this._parameters}constructor(e,t){super(),this._data=e,this.type=M.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new fe,this._parameters={...Br,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){null!=e&&(e instanceof HTMLVideoElement?(this.frameUpdate=t=>this._frameUpdate(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(Ae(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const t=!e.paused;if(e.src=e.src,t&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){Ee(e.src)||Ae(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new Oe;return t.wrapMode=this._parameters.wrap??Re.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?ye.LINEAR_MIPMAP_LINEAR:ye.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(i(e)||n(e))return t.encoding===A.KTX2_ENCODING?function(e,t){if(null==Tr)return e.byteLength;const r=new Tr.KTX2File(new Uint8Array(e)),i=Ir(r)?Sr(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),i}(e,!!t.mipmap):t.encoding===A.BASIS_ENCODING?function(e,t){if(null==Tr)return e.byteLength;const r=new Tr.BasisFile(new Uint8Array(e)),i=xr(r)?Sr(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),i}(e,!!t.mipmap):e.byteLength;const{width:r,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Fr(e):t;return(t.mipmap?4/3:1)*r*s*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const t=this._data;return null==t?(this._glTexture=new Ne(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):(i(t)||n(t))&&this._parameters.encoding===A.DDS_ENCODING?this._loadFromDDSData(e,t):(i(t)||n(t))&&this._parameters.encoding===A.KTX2_ENCODING?this._loadFromKTX2(e,t):(i(t)||n(t))&&this._parameters.encoding===A.BASIS_ENCODING?this._loadFromBasis(e,t):n(t)?this._loadFromPixelData(e,t):i(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_frameUpdate(e,t){return null==this._glTexture||e.readyState<Ur.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=function(e,t,r){const i=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return Pr().error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return Pr().error("Unsupported format, must contain a FourCC code"),null;const i=r[21];let n,s;switch(i){case Rr:n=8,s=be.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Mr:n=16,s=be.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Cr:n=16,s=be.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Pr().error("Unsupported FourCC code:",(a=i,String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255))),null}var a;let o=1,l=r[4],c=r[3];(3&l||3&c)&&(Pr().warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,c=c+3&-4);const u=l,d=c;131072&r[2]&&!1!==t&&(o=Math.max(1,r[7]));let h,m,f=r[1]+4;const _=[];for(let t=0;t<o;++t)m=(l+3>>2)*(c+3>>2)*n,h=new Uint8Array(e,f,m),_.push(h),f+=m,l=Math.max(1,l>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:_},internalFormat:s,width:u,height:d}}(r,t.hasMipmap??!1);if(null==i)throw new Error("DDS texture data is null");const{textureData:n,internalFormat:s,width:a,height:o}=i;return t.samplingMode=n.levels.length>1?ye.LINEAR_MIPMAP_LINEAR:ye.LINEAR,t.hasMipmap=n.levels.length>1,t.internalFormat=s,t.width=a,t.height=o,new Ne(e,t,n)}(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,r){null==Tr&&(Tr=await Er());const i=new Tr.KTX2File(new Uint8Array(r));if(!Ir(i))return null;i.startTranscoding();const n=br(e,t,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),((e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1)));return i.close(),i.delete(),n}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,r){null==Tr&&(Tr=await Er());const i=new Tr.BasisFile(new Uint8Array(r));if(!xr(i))return null;i.startTranscoding();const n=br(e,t,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),((e,t)=>i.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>i.transcodeImage(r,0,e,t,0,0)));return i.close(),i.delete(),n}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){y(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this._parameters.components?Pe.LUMINANCE:3===this._parameters.components?Pe.RGB:Pe.RGBA,r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new Ne(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync((async r=>{const i=await Se(t,{signal:r});return ge(r),this._loadFromImage(e,i)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async r=>{const i=await xe(t,t.src,!1,r);return ge(r),this._loadFromImage(e,i)}))}_loadFromVideoElement(e,t){return t.readyState>=Ur.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync((r=>new Promise(((i,n)=>{const s=()=>{t.removeEventListener("loadeddata",a),t.removeEventListener("error",o),pe(l)},a=()=>{t.readyState>=Ur.HAVE_CURRENT_DATA&&(s(),i(this._loadFromImage(e,t)))},o=e=>{s(),n(e||new me("Failed to load video"))};t.addEventListener("loadeddata",a),t.addEventListener("error",o);const l=ve(r,(()=>o(Te())))}))))}_loadFromImage(e,t){let r=t;if(!(r instanceof HTMLVideoElement)){const{maxTextureSize:t}=e.parameters;r=this._parameters.downsampleUncompressed?Dr(r,t):function(e,t){const r=Math.max(e.width,e.height);if(r<=t)return e;const i=t/r;return Nr(e,Math.round(e.width*i),Math.round(e.height*i))}(r,t)}const i=Fr(r);this._parameters.width=i.width,this._parameters.height=i.height;const n=this._createDescriptor(e);return n.pixelFormat=3===this._parameters.components?Pe.RGB:Pe.RGBA,n.width=i.width,n.height=i.height,this._glTexture=new Ne(e,n,r),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(i,i),r}unload(){if(this._glTexture=_e(this._glTexture),null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}function Fr(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var Ur;!function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(Ur||(Ur={}));const Br={wrap:{s:Re.REPEAT,t:Re.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};class Gr extends H{constructor(e,t){super(e,"vec2",se.Pass,((r,i,n)=>r.setUniform2fv(e,t(i,n))))}}function Hr(e){e.include(W),e.code.add(oe`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromRGBA(vec4 depth, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(depth), nearFar);
}
float linearDepthFromTexture(sampler2D depthTexture, vec2 uv, vec2 nearFar) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
return linearDepthFromRGBA(texelFetch(depthTexture, iuv, 0), nearFar);
}`)}function Vr(e){e.uniforms.add(new Gr("zProjectionMap",((e,t)=>function(e){const t=e.projectionMatrix;return Be(jr,t[14],t[10])}(t.camera)))),e.code.add(oe`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(oe`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(oe`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}const jr=Ge();function $r(e,t){if(!t.multipassEnabled)return;e.fragment.include(Vr),e.fragment.uniforms.add(new pr("terrainDepthTexture",((e,t)=>t.multipassTerrain.depth?.attachment)));const r=t.occlusionPass;e.fragment.code.add(oe`
   ${r?"bool":"void"} terrainDepthTest(float fragmentDepth) {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${r?oe`return fragmentDepth < linearDepth && depth < 1.0;`:oe`
          if(fragmentDepth ${t.cullAboveGround?">":"<="} linearDepth){
            discard;
          }`}
    }`)}class kr{constructor(){this.cullAboveGround=!1}}function qr(e){e.vertex.code.add(oe`const float PI = 3.141592653589793;`),e.fragment.code.add(oe`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}const Kr=.1,Xr=.001;function Wr(e){e.code.add(oe`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}class Qr{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}}class Yr extends Qr{constructor(){super(...arguments),this.vertex=new ei,this.fragment=new ei,this.attributes=new ti,this.varyings=new ri,this.extensions=new ii,this.constants=new si,this.outputs=new ni}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const t=this.extensions.generateSource(e),r=this.attributes.generateSource(e),i=this.varyings.generateSource(e),n="vertex"===e?this.vertex:this.fragment,s=n.uniforms.generateSource(),a=n.code.generateSource(),o="vertex"===e?oi:ai,l=this.constants.generateSource().concat(n.constants.generateSource()),c=this.outputs.generateSource(e);return`#version 300 es\n${t.join("\n")}\n\n${o}\n\n${l.join("\n")}\n\n${s.join("\n")}\n\n${r.join("\n")}\n\n${i.join("\n")}\n\n${c.join("\n")}\n\n${a.join("\n")}`}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[se.Pass];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[se.Pass];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,n)=>{for(let s=0;s<i;++s)r[s](e,t,n)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[se.Draw];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[se.Draw];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,n,s)=>{for(let a=0;a<i;++a)r[a](e,t,n,s)}}}class Zr{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new me(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else Ue.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder").error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((e=>null!=e.arraySize?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`))}get entries(){return Array.from(this._entries.values())}}class Jr{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}}class ei extends Qr{constructor(){super(...arguments),this.uniforms=new Zr(this),this.code=new Jr(this),this.constants=new si}get builder(){return this}}class ti{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))}}class ri{constructor(){this._entries=new Map}add(e,t){this._entries.has(e)&&y(this._entries.get(e)===t),this._entries.set(e,t)}generateSource(e){const t=new Array;return this._entries.forEach(((r,i)=>t.push("vertex"===e?`out ${r} ${i};`:`in ${r} ${i};`))),t}}class ii{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?ii.ALLOWLIST_VERTEX:ii.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))}}ii.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],ii.ALLOWLIST_VERTEX=[];class ni{constructor(){this._entries=new Map}add(e,t,r=0){const i=this._entries.get(r);i?y(i.name===e&&i.type===t,`Fragment shader output location ${r} occupied`):this._entries.set(r,{name:e,type:t})}generateSource(e){if("vertex"===e)return[];0===this._entries.size&&this._entries.set(0,{name:ni.DEFAULT_NAME,type:ni.DEFAULT_TYPE});const t=new Array;return this._entries.forEach(((e,r)=>t.push(`layout(location = ${r}) out ${e.type} ${e.name};`))),t}}ni.DEFAULT_TYPE="vec4",ni.DEFAULT_NAME="fragColor";class si{constructor(){this._entries=new Set}add(e,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=si._numberToFloatStr(r);break;case"int":i=si._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${si._numberToFloatStr(r[0])},                            ${si._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${si._numberToFloatStr(r[0])},                            ${si._numberToFloatStr(r[1])},                            ${si._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${si._numberToFloatStr(r[0])},                            ${si._numberToFloatStr(r[1])},                            ${si._numberToFloatStr(r[2])},                            ${si._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${si._numberToIntStr(r[0])},                             ${si._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${si._numberToIntStr(r[0])},                             ${si._numberToIntStr(r[1])},                             ${si._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${si._numberToIntStr(r[0])},                             ${si._numberToIntStr(r[1])},                             ${si._numberToIntStr(r[2])},                             ${si._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${t}(${Array.prototype.map.call(r,(e=>si._numberToFloatStr(e))).join(", ")})`}return this._entries.add(`const ${t} ${e} = ${i};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const ai="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif",oi="precision highp float;\nprecision highp sampler2D;";class li{constructor(e,t){this._module=e,this._loadModule=t}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}class ci{constructor(e,t,r){this.release=r,this.initializeConfiguration(e,t),this._configuration=t.snapshot(),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e)}destroy(){this._program=_e(this._program),this._pipeline=this._configuration=null}reload(e){_e(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e)}get program(){return this._program}get compiled(){return this.program.compiled}get key(){return this._configuration.key}get configuration(){return this._configuration}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return Me.TRIANGLES}getPipeline(e,t,r){return this._pipeline}initializeConfiguration(e,t){}}const ui=He(Ce.SRC_ALPHA,Ce.ONE,Ce.ONE_MINUS_SRC_ALPHA,Ce.ONE_MINUS_SRC_ALPHA),di=He(Ce.ONE,Ce.ZERO,Ce.ONE,Ce.ONE_MINUS_SRC_ALPHA);function hi(e){return e===Bt.FrontFace?null:di}function mi(e){return e===Bt.FrontFace?Ve:null}const fi=5e5,_i={factor:-1,units:-2};function pi(e){return e?_i:null}function gi(e,t=we.LESS){return e===Bt.NONE||e===Bt.FrontFace?t:we.LEQUAL}function vi(e){return e===Bt.ColorAlpha?{buffers:[Le.COLOR_ATTACHMENT0,Le.COLOR_ATTACHMENT1]}:null}class Ti{constructor(e,t,r){this._context=e,this._locations=r,this._textures=new Map,this._freeTextureUnits=new S({deallocator:null}),this._glProgram=e.programCache.acquire(t.generate("vertex"),t.generate("fragment"),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this),this._fragmentUniforms=Fe()?t.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t){this._glProgram.setUniform1f(e,t)}setUniform2fv(e,t){this._glProgram.setUniform2fv(e,t)}setUniform3fv(e,t){this._glProgram.setUniform3fv(e,t)}setUniform4fv(e,t){this._glProgram.setUniform4fv(e,t)}setUniformMatrix3fv(e,t){this._glProgram.setUniformMatrix3fv(e,t)}setUniformMatrix4fv(e,t){this._glProgram.setUniformMatrix4fv(e,t)}setUniform1fv(e,t){this._glProgram.setUniform1fv(e,t)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,t){if(null==t?.glName){const t=this._textures.get(e);return t&&(this._context.bindTexture(null,t.unit),this._freeTextureUnit(t),this._textures.delete(e)),null}let r=this._textures.get(e);return null==r?(r=this._allocTextureUnit(t),this._textures.set(e,r)):r.texture=t,this._context.useProgram(this),this.setUniform1i(e,r.unit),this._context.bindTexture(t,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach(((e,t)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(t,e.unit)})),this._fragmentUniforms?.forEach((e=>{"sampler2D"!==e.type&&"samplerCube"!==e.type||this._textures.has(e.name)||console.error(`Texture sampler ${e.name} has no bound texture`)}))}_allocTextureUnit(e){return{texture:e,unit:0===this._freeTextureUnits.length?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}}const Ai={func:we.LESS},Ei={func:we.ALWAYS},Si={mask:255},xi={mask:0},Ii=e=>({function:{func:we.NOTEQUAL,ref:e,mask:e},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.KEEP}}),bi=e=>({function:{func:we.ALWAYS,ref:e,mask:e},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.REPLACE}}),Pi={function:{func:we.ALWAYS,ref:E.OutlineVisualElementMask,mask:E.OutlineVisualElementMask},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.ZERO}},yi={function:{func:we.ALWAYS,ref:E.OutlineVisualElementMask,mask:E.OutlineVisualElementMask},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.REPLACE}},Ri={function:{func:we.EQUAL,ref:E.OutlineVisualElementMask,mask:E.OutlineVisualElementMask},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.KEEP}},Mi={function:{func:we.NOTEQUAL,ref:E.OutlineVisualElementMask,mask:E.OutlineVisualElementMask},operation:{fail:De.KEEP,zFail:De.KEEP,zPass:De.KEEP}};export{Mi as $,_i as A,wr as B,Wr as C,Yt as D,Lr as E,_r as F,at as G,Vr as H,mr as I,qt as J,Lt as K,je as L,Zt as M,Gt as N,fi as O,Ti as P,Dr as Q,li as R,Yr as S,Or as T,qr as U,fr as V,Er as W,Qe as X,$e as Y,ke as Z,Ei as _,ot as a,xi as a0,Ri as a1,Ai as a2,Wt as a3,kr as a4,Dt as a5,Pt as a6,yt as a7,xt as a8,qe as a9,wt as aa,Ze as ab,Ut as ac,hr as ad,Hr as ae,Ii as af,Jt as ag,bi as ah,et as ai,Gr as b,Ht as c,Vt as d,er as e,Ye as f,pr as g,Bt as h,Kr as i,ci as j,gi as k,mi as l,$r as m,We as n,hi as o,vi as p,yi as q,Pi as r,Si as s,pi as t,lt as u,dr as v,Xr as w,ui as x,Ft as y,kt as z};

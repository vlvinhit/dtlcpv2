/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../Camera.js";import{C as t,a as n}from"./Cyclical.js";import{L as r}from"./Logger.js";import{r as i,a,d as o,g as s}from"./mathUtils.js";import{throwIfAborted as c}from"../core/promiseUtils.js";import{p as l,m as u,b as f,c as m,i as p,d,l as y,n as h,e as g,h as M,u as v,G as R,j as w}from"./vec3.js";import{c as T,f as x,e as S}from"./vec3f64.js";import{f as b,O as j,aa as C,Q as z,r as P}from"./unitUtils.js";import H from"../geometry/Point.js";import{project as A,projectWithZConversion as G}from"../geometry/projection.js";import U from"../geometry/SpatialReference.js";import{p as D,a as E}from"./projectPointToVector.js";import{p as O,a as I}from"./projectVectorToPoint.js";import{p as L}from"./projectVectorToVector.js";import{S as q,a as k}from"./spatialReferenceEllipsoidUtils.js";import{V as F}from"./ViewingMode.js";import{r as W}from"./aaBoundingRect.js";import{n as _}from"./Intersector2.js";import{z as V,h as J,f as X,A as K}from"./mat4.js";import{c as N}from"./mat4f64.js";import Y from"../geometry/Extent.js";import{geographicToWebMercator as B}from"../geometry/support/webMercatorUtils.js";import{g as Q,a as Z}from"./earthUtils.js";import{g as $}from"./ElevationProvider.js";import{i as ee}from"./spatialReferenceSupport.js";function te(e,t,n,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,oe,r)&&W(n,oe)}function ne(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function re(e,t,n,r){const i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=ae[e.viewingMode];r||(r=_(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,ae[e.viewingMode]=r);const{isGlobal:i}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||ie(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||ie(e,t.origin,n))||!!i&&function(e,t,n){const r=d(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return f(t,e.direction,i/y(e.direction)),p(t,t,e.origin),!0}(t,n,P(e.spatialReference).radius)}(e,i.ray,se)||l(se,i.center);const a=e.state.constraints,o=a.minimumPoiDistance;if(u(i.eye,se)<o){const t=a.collision.enabled;l(ce,i.viewForward),f(ce,ce,o),t?i.eye=m(oe,se,ce):p(se,i.eye,ce);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),s=a.collision.elevationMargin;t&&r<s&&(m(ce,se,i.eye),i.eye=n.setAltitude(oe,s,i.eye),p(se,i.eye,ce))}return i.center=se,i}function ie(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=ne(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:a}=i.compute(t,n,e.renderDataExtent,r,le),o=a*a;return u(t,n)>o}const ae={},oe=T(),se=T(),ce=T(),le={near:0,far:0},ue=T(),fe=T();function me(){return{direction:T(),up:T()}}function pe(e,t,n,r,o){let s=h(ue,e),c=d(s,r);const u=c>0;c=Math.abs(c),c>.99&&(c=Math.abs(d(t,r)),c<.99?(l(s,t),u&&f(s,s,-1)):s=null);let p=0;if(s){f(fe,r,d(r,s)),m(s,s,fe);const e=d(s,o)/(y(s)*y(o));g(fe,s,o),p=(d(fe,r)>0?1:-1)*i(a(e))}const M=i(a(-d(r,e)/y(e)));return n?(n.heading=p,n.tilt=M,n):{heading:p,tilt:M}}const de=x(0,1,0),ye=x(0,0,1),he=N(),ge=T(),Me=T();function ve(e,t,n,r=me()){const{direction:i,up:a}=r;return V(he,-o(t)),J(he,he,o(n)),M(i,ye,he),f(i,i,-1),M(a,de,he),r}function Re(e,t,n,r,i){const a=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return D(t,ge,a),D(t,Me,a),ge[0]-=n/2,Me[0]+=n/2,ge[1]-=r/2,Me[1]+=r/2,L(ge,a,ge,o),L(Me,a,Me,o),i?(i.xmin=ge[0],i.ymin=ge[1],i.xmax=Me[0],i.ymax=Me[1],i.spatialReference=o):i=new Y(ge[0],ge[1],Me[0],Me[1],o),i}const we=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return pe(t,n,r,ye,de)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=ve(0,n,r),a=T();return f(a,i.direction,-t),p(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return o(e)},headingTiltToDirectionUp:ve,lookAtTiltToEyeTilt:function(e){return i(e)},toExtent:Re},Symbol.toStringTag,{value:"Module"})),Te=x(0,0,1),xe=h(T(),x(1,1,1)),Se=new t(-180,180),be=N(),je=T(),Ce=T();function ze(e,t,n,r=me()){g(je,e,Te),0===d(je,je)&&g(je,e,xe),X(be,-o(t),e),K(be,be,-o(n),je);const{up:i,direction:a}=r;return g(i,je,e),h(i,i),M(i,i,be),h(a,e),v(a,a),M(a,a,be),r}function Pe(e){const t=e[1];e[1]=-e[2],e[2]=t}function He(e,t){const n=ze(t,e.heading,e.tilt);return e.up=n.up,e}function Ae(e,t,r,a,s){let c,l,u,f;const m=t.latitude,p=P(e.spatialReference).radius,d=t.longitude,y=Q(m,r,p)/2;c=d-y,l=d+y;const h=o(m),g=(1+Math.sin(h))/(1-Math.sin(h)),M=(g+1)*Math.tan(a/p/2),v=M*M;function R(e){const t=Math.PI/2;return(e=n.normalize(e,-t))>t&&(e=Math.PI-e),e}if(u=1.5*Math.PI-2*Math.atan(.5*(M+Math.sqrt(4*g+v))),f=u+a/p,u=R(u),f=R(f),f<u){const e=f;f=u,u=e}if(u=Math.max(i(u),-90),f=Math.min(i(f),90),l=Se.monotonic(c,l),l-c>180){const e=(l-c-180)/2;c+=e,l-=e}const w=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:U.WGS84;return s?(s.xmin=c,s.ymin=u,s.xmax=l,s.ymax=f,s.spatialReference=w):s=new Y(c,u,l,f,w),e.spatialReference&&e.spatialReference.isWebMercator&&B(s,!1,s),s}const Ge=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){const i=je,a=Ce;return h(i,e),g(Ce,i,Te),0===d(Ce,Ce)&&g(Ce,i,xe),g(a,Ce,i),pe(t,n,r,i,a)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:T(),up:null,tilt:r,heading:n},a=je;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const c=t,l=o(n),u=o(r),m=Math.sin(l),p=Math.cos(l),d=Math.sin(u),h=Math.cos(u),g=y(a);let M;if(Math.abs(u)<1e-8)M=c+g;else{const e=g/d,t=s(c/e),n=Math.PI-u-t;M=e*Math.sin(n)}const v=h*c,R=c*c*(d*d),w=p*p*R,x=M-v,S=x*x,b=w*(w+S-a[1]*a[1]);if(b<0)return f(i.eye,a,M/g),i.tilt=0,He(i,e);const j=Math.sqrt(b),C=a[1]*x,z=w+S;let P;if(P=p>0?-j+C:j+C,Math.abs(z)<1e-8)return g<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=c):f(i.eye,a,M/g),i.tilt=0,Pe(i.eye),He(i,e);i.eye[1]=P/z;const H=m*m*R,A=d*c,G=p*A*i.eye[1],U=i.eye[1]*i.eye[1],D=1-U,E=Math.sqrt(D),O=w*U+H-2*G*E*x+D*S;return Math.abs(O)<1e-8?(f(i.eye,a,M/g),i.tilt=0,Pe(i.eye),He(i,e)):(i.eye[0]=(D*(M*a[0]-v*a[0])-A*E*(a[0]*i.eye[1]*p+a[2]*m))/O,i.eye[2]=(D*(M*a[2]-v*a[2])-A*E*(a[2]*i.eye[1]*p-a[0]*m))/O,f(i.eye,i.eye,M),Pe(i.eye),He(i,e))},eyeTiltToLookAtTilt:function(e,t,n){const r=o(e),i=y(t);return s(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:ze,lookAtTiltToEyeTilt:function(e,t,n){const r=y(t),a=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),o=s(n/(a/Math.sin(e)));return i(e-o)},toExtent:Ae},Symbol.toStringTag,{value:"Module"})),Ue=()=>r.getLogger("esri.views.3d.support.cameraUtils"),De=39.37,Ee=96,Oe=1,Ie=8,Le=5,qe=1,ke=T(),Fe={heading:0,tilt:0},We=T(),_e=new t(-20037508.342788905,20037508.342788905),Ve=new t(-180,180);var Je;function Xe(e){return e.spatialReference??U.WGS84}function Ke(e){return"global"===e.viewingMode?Ge:we}function Ne(e,t,n,r,i){return Ke(e).headingTiltToDirectionUp(t,n,r,i)}function Ye(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=Ke(e).headingTiltToDirectionUp,i=T();if(!D(t.position,i,n))return null;const a=r(i,t.heading,t.tilt);f(a.direction,a.direction,e.state.camera.distance),p(a.direction,a.direction,i);const s=re(e,i,a.direction,a.up);return s.fov=o(t.fov),s.row=t.layout.row,s.rows=t.layout.rows,s.column=t.layout.column,s.columns=t.layout.columns,s}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(Je||(Je={}));const Be=T();function Qe(t,n,r){const a=t.renderSpatialReference,o=rt(t,n.eye,n.viewForward,n.up,Fe);let s=Xe(t);return L(n.eye,a,Be,s)||(s=U.WGS84,L(n.eye,a,Be,s)),null==r?r=new e(new H(Be,s),o.heading,o.tilt,i(n.fov)):(r.position.x=Be[0],r.position.y=Be[1],r.position.z=Be[2],r.position.spatialReference=s,r.heading=o.heading,r.tilt=o.tilt,r.fov=i(n.fov)),r.layout.row=n.row,r.layout.rows=n.rows,r.layout.column=n.column,r.layout.columns=n.columns,r}function Ze(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===F.Global&&null!=n&&(t*=Math.cos(o(n))),t/=e.renderCoordsHelper.unitInMeters,i/(Ee*De/t)/Math.tan(r.fovX/2)}function $e(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let s=Ee*De/(a/i);return e.renderCoordsHelper.viewingMode===F.Global&&null!=n&&(s/=Math.cos(o(n))),s*e.renderCoordsHelper.unitInMeters}async function et(e,t,n,r,i,a){return nt(e,t,Ze(e,n,t.latitude),r,i,a)}function tt(e,t,n,r,i,a){return Tt(e,at(e,r.heading,r.tilt,t,n,i),r.fov,a)}async function nt(e,t,n,r,i,a){const o=await ot(e,r.heading,r.tilt,t,n,i,a);return c(a),xt(e,o,r.fov,a)}function rt(e,t,n,r,i){return Ke(e).directionToHeadingTilt(t,n,r,i)}function it(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,We,e.spatialReference)&&e.elevationProvider&&($(e.elevationProvider,We)??0)>We[2]-qe)}function at(e,t,n,r,i,a){const o=r instanceof H?r:null,s=function(e,t){const n=T();if(null==t)return l(n,e.state.camera.center);if(t instanceof H){if(!D(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=$(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return l(n,t)}(e,r);return st(e,t,n,o,s,i,a)}async function ot(e,t,n,r,i,a,o){const s=r instanceof H?r:null,u=await async function(e,t,n){const r=T();if(null==t)return l(r,e.state.camera.center);if(t instanceof H){const{renderSpatialReference:i,basemapTerrain:a,elevationProvider:o}=e,s=t.spatialReference;if(await E(t,r,i,0,{signal:n}),c(n),null==t.z&&null!=a&&null!=o){const i=await o.queryElevation(t.x,t.y,t.z??0,s,"ground",n);c(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return l(r,t)}(e,r,o);return c(o),ct(e,t,n,s,u,i,a,o)}function st(e,t,n,r,i,a,o){if(null==i)return null;if(!r&&(r=new H({spatialReference:Xe(e)}),!O(i,e.renderSpatialReference,r)))return null;const s=lt(e,t,n,i,a,o);if(ut(e,n,o)&&it(e,s.eye)){const{tilt:o,mode:s}=ft(e,n,i,a);return st(e,t,o,r,i,a,s)}return mt(s,i)}async function ct(e,t,n,r,i,a,o,s){r||(r=new H({spatialReference:Xe(e)}),await I(i,e.renderSpatialReference,r,{signal:s})||(r=null)),c(s);const l=lt(e,t,n,i,a,o);if(ut(e,n,o)&&await async function(e,t,n){if(it(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,We,i))return!1;const[o,s,l]=We,u=await r.queryElevation(o,s,l,i,"ground",n)??0;return c(n),u>l-qe}(e,l.eye,s)){c(s);const{tilt:o,mode:l}=ft(e,n,i,a);return ct(e,t,o,r,i,a,l,s)}return mt(l,i)}function lt(e,t,n,r,i,a){const o=function(e,t,n,r,i,a){let o=0;return a===Je.ADJUST&&Mt(e,r,i)?(t=0,o=function(e,t,n,r){const i=wt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);const o=a.min*(1-vt)+a.max*vt;return Math.min(i,o)}(e,i,n,r)):o=wt(e,r,i,n),o=e.state.constraints.clampTilt(i,o),{heading:t,tilt:n=Rt(e,r,i,o)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),a);return(0,Ke(e).eyeForCenterWithHeadingTilt)(r,i,o.heading,o.tilt)}function ut(e,t,n){const r=e.map.ground.navigationConstraint;return n===Je.ADJUST&&"global"===e.viewingMode&&t>0&&(null==r||"stay-above"===r.type)}function ft(e,t,n,r){const i=Rt(e,n,r,function(e,t,n,r){let i=wt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),a.min*(1-vt)+i*vt}(e,r,t,n));return{tilt:i,mode:t-i<1?Je.LOCKED:Je.ADJUST}}function mt(e,t){return{...e,center:S(t)}}function pt(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&ee(i,F.Global)||n.isLocal&&r.equals(i)}function dt(e,t){let n,r,i;if(e.state.isGlobal){const e=new H(t.xmin,t.ymin,t.spatialReference),a=new H(t.xmax,t.ymax,t.spatialReference),o=t.spatialReference.isGeographic?Ve:_e;n=new H({x:o.center(e.x,a.x),y:(a.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const s=P(t.spatialReference),c=Z(n,e,a);r=c.lon,i=c.lat,o.diff(e.x,a.x)>o.range/2&&(r+=s.halfCircumference),r=Math.min(r,s.halfCircumference),i=Math.min(i,s.halfCircumference)}else{const a=e.renderSpatialReference??t.spatialReference;a.equals(t.spatialReference)||(t=A(t,a)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const o=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new H({x:t.xmin+.5*r,y:t.ymin+.5*i,z:o,spatialReference:a})}const a=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,o=e.state.camera,s=1/Math.tan(o.fovX/2),c=1/Math.tan(o.fovY/2),l=1/Math.tan(o.fov/2);return{center:n,distance:Math.max(.5*r*s,.5*i*c,.5*a*l)/Oe}}async function yt(e,t,n,r,i,a){const o=pt(e,t)?t:await G(t,e.spatialReference,{signal:a});c(a);const{center:s,distance:l}=dt(e,o),u=await ot(e,n,r,s,l,i,a);return c(a),xt(e,u,e.camera.fov,a)}function ht(e,t,n,r,i,a){let o;try{o=pt(e,t)?t:A(t,e.spatialReference)}catch(e){return null}const{center:s,distance:c}=dt(e,o),l=at(e,n,r,s,c,i);return null==l?null:Tt(e,l,e.camera.fov,a)}function gt(e,t,n){const r=e.renderSpatialReference,i=new H({spatialReference:Xe(e)});if(!O(n,r,i))return null;const a=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),s=R(t.eye,n),c=2*s*a*Oe,l=2*s*o*Oe;return"global"===e.viewingMode?Ae(e,i,c,l):Re(e,i,c,l)}function Mt(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>Ie)return!0;const i=t,a=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return w(i,a)/(Math.tan(.5*e.state.camera.fov)*r)>Le}const vt=.7;function Rt(e,t,n,r){return Ke(e).lookAtTiltToEyeTilt(r,t,n)}function wt(e,t,n,r){return Ke(e).eyeTiltToLookAtTilt(r,t,n)}function Tt(t,n,r,i){if(null==n)return null;const a=t.renderSpatialReference,o=new H({spatialReference:Xe(t)});return O(n.eye,a,o)?(i??=new e,i.position=o,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):null}async function xt(t,n,r,i){const a=t.renderSpatialReference,o=new H({spatialReference:Xe(t)});return await I(n.eye,a,o,{signal:i}),c(i),new e(o,n.heading,n.tilt,r)}function St(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);Ue().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function bt(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);Ue().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function jt(e,t){const{renderSpatialReference:n}=e,r=b(i=n,q)||j(i)?{wkid:C.GCSMARS2000}:b(i,k)||z(i)?{wkid:C.GCSMOON2000}:U.WGS84;var i;let a=null;try{L(t.center,n,ke,r)&&(a=ke[1])}catch{}return $e(e,t.distance,a)}export{Je as O,yt as a,tt as b,nt as c,$e as d,Ye as e,ht as f,Xe as g,jt as h,Qe as i,re as j,et as k,rt as l,Ne as m,me as n,ne as o,te as p,St as q,at as r,Ze as s,gt as t,bt as z};

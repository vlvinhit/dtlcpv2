/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../geometry/Extent.js";import a from"../geometry/Point.js";import l from"../geometry/SpatialReference.js";import i,{R as s}from"../layers/support/RasterInfo.js";import{p as n,e as r,a as o}from"./utils8.js";import u from"../rest/support/FeatureSet.js";async function m(m,f,p){const c=n(m),{rasterFunction:d,sourceJSON:h}=f||{},g=d?JSON.stringify(d.rasterFunctionDefinition||d):null,x=r({...c.query,renderingRule:g,f:"json"}),y=o(x,p);m=c.path;const b=h||await e(m,y).then((e=>e.data)),v=b.hasRasterAttributeTable?e(`${m}/rasterAttributeTable`,y):null,S=b.hasColormap?e(`${m}/colormap`,y):null,V=b.hasHistograms?e(`${m}/histograms`,y):null,D=b.currentVersion>=10.3?e(`${m}/keyProperties`,y):null,T=b.hasMultidimensions?e(`${m}/multidimensionalInfo`,y):null,I=await Promise.allSettled([v,S,V,D,T]);let R=null;if(b.minValues&&b.minValues.length===b.bandCount){R=[];for(let e=0;e<b.minValues.length;e++)R.push({min:b.minValues[e],max:b.maxValues[e],avg:b.meanValues[e],stddev:b.stdvValues[e]})}const w=t.fromJSON(b.extent),M=Math.ceil(w.width/b.pixelSizeX-.1),j=Math.ceil(w.height/b.pixelSizeY-.1),N=l.fromJSON(b.spatialReference||b.extent.spatialReference),J="fulfilled"===I[0].status?I[0].value?.data:null,O=J?.features?.length?u.fromJSON(J):null,k="fulfilled"===I[1].status?I[1].value?.data.colormap:null,C=k?.length?k:null,P="fulfilled"===I[2].status?I[2].value?.data.histograms:null,z=P?.[0]?.counts?.length?P:null,F="fulfilled"===I[3].status?I[3].value?.data??{}:{},$="fulfilled"===I[4].status?I[4].value?.data.multidimensionalInfo:null,H=$?.variables?.length?$:null;H&&H.variables.forEach((e=>{e.statistics?.length&&e.statistics.forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation}))}));const{defaultVariable:L,serviceDataType:A}=b;L&&L!==F.DefaultVariable&&(F.DefaultVariable=L),A?.includes("esriImageServiceDataTypeVector")&&!A.includes(F.DataType)&&(F.DataType=A.replace("esriImageServiceDataType",""));let E=b.noDataValue;b.noDataValues?.length&&b.noDataValues.some((e=>e!==E))&&(E=b.noDataValues);const q=b.transposeInfo?new s({blockWidth:256,blockHeight:256,pyramidBlockWidth:256,pyramidBlockHeight:256,pyramidScalingFactor:2,compression:"lerc",origin:new a({x:b.extent.xmin,y:b.extent.ymax,spatialReference:N}),firstPyramidLevel:1,maximumPyramidLevel:Math.max(0,Math.round(Math.log(Math.max(M,j))/Math.LN2-8)),transposeInfo:b.transposeInfo}):void 0;return new i({width:M,height:j,bandCount:b.bandCount,extent:t.fromJSON(b.extent),spatialReference:N,pixelSize:new a({x:b.pixelSizeX,y:b.pixelSizeY,spatialReference:N}),pixelType:b.pixelType.toLowerCase(),statistics:R,attributeTable:O,colormap:C,histograms:z,keyProperties:F,noDataValue:E,multidimensionalInfo:H,storageInfo:q})}function f(e,t,a){return m(e,{sourceJSON:t},a)}function p(e,t,a){return m(e,{rasterFunction:t},a)}function c(e,t){e.attributeTable||(t.hasRasterAttributeTable=!1),e.histograms||(t.hasHistograms=!1),e.colormap||(t.hasColormap=!1),e.multidimensionalInfo||(t.hasMultidimensions=!1)}export{f,p as g,c as p};

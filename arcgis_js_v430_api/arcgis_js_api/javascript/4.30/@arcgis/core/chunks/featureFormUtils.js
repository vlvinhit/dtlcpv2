/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import"../intl.js";import{i as e,equalsShallow as t}from"../core/lang.js";import{n}from"./compilerUtils.js";import{t as r,r as s,L as a}from"./Logger.js";import{b as i}from"./formUtils.js";import{isTimeOnlyField as o,a as l,b as u,D as p,NumericRangeValidationError as m,TypeValidationError as d}from"../layers/support/fieldUtils.js";import{i as c}from"./utils2.js";import{s as f}from"./substitute.js";const y=e=>"field"===e?.type,b=e=>"group"===e?.type,g=e=>"relationship"===e?.type,x=e=>"text"===e.type,T=e=>!b(e)&&null!=e.group,O=e=>e.reduce(((e,t)=>b(t)?[...e,...t.inputs]:[...e,t]),[]),h=e=>O(e).filter(y),v=e=>O(e).filter(g),N=e=>null!=e&&(F(e,"combo-box")||F(e,"radio-buttons")),F=(e,t)=>null!=e&&e.input?.type===t,j=e=>null!=e&&(F(e,"text-box")||F(e,"text-area")),E=({domain:e,inputType:t="text-box",dataType:n})=>"number"===n&&"text-box"===t&&(!e||"coded-value"!==e.type),V=e=>"items"in e;function L(t){const{attributes:n,fieldsIndex:a,label:i,timeZone:o}=t;if(!n||"object"!=typeof n)return i;const l=Object.keys(n).filter((e=>r(i,e))),u=l.map((e=>n[e])),p=l.map((e=>a.get(e))).filter(e);return function(e,t){return s(s(e,(e=>`{${e.toLowerCase()}}`)),Object.fromEntries(Object.entries(t).map((([e,t])=>[e.toLowerCase(),t]))))}(i,w({values:u,fields:p,timeZone:o}))}const _="expression/";function U(e){const[t,n]=e.split(_);return""===t&&n?n:(a.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${e} is not a valid expression reference of the form '${_}/expressionName'`),"")}function A(e){return`${_}${e}`}function I(e){return`field/${e}`}function R(e){return e.startsWith(_)}function D(e){return e.startsWith("expr/")}function w(e){const{fields:t,values:n}=e,r=e.timeZone??void 0,s=t.map(((e,t)=>{let s=n[t];if(e.domain&&"coded-value"===e.domain.type){const t=e.domain.codedValues.find((e=>e.code===s));t?.name&&(s=t.name)}return(c(e)||o(e))&&(s=l(e,s,{timeZone:r,...u(e)})),[e.name,s]}));return Object.fromEntries(s)}const $=e=>{const t={typeFieldName:null,types:[]};return e?("subtype-sublayer"===e.type?(t.typeFieldName=e.parent?.subtypeField,t.types=e.parent?.subtypes??[]):"subtype-group"===e.type||"feature"===e.type&&e.subtypes?.length?(t.typeFieldName=e.subtypeField,t.types=e.subtypes??[]):"types"in e&&e.types&&(t.typeFieldName=e.typeIdField,t.types=e.types.map((({id:e,name:t,domains:n})=>({code:e,name:t,domains:n})))),null!=t.typeFieldName&&(t.typeFieldName=e.getField(t.typeFieldName)?.name??t.typeFieldName),t):t},C=(e,t)=>{if(!e)return!0;const{operations:n}=e;switch(t){case"INSERT":return n.supportsAdd;case"UPDATE":case"DELETE":return n.supportsUpdate;default:return!0}};var S;!function(e){e.TOO_SHORT="length-validation-error::too-short",e.TOO_LONG="length-validation-error::too-long"}(S||(S={}));const Z={type:"number"},G={type:"number",intlOptions:{notation:"scientific"}};function k(e){return e>=1e7||e<=-1e7}const q=(e,t,n)=>{const{dataType:r,error:s,minLength:a,value:i,required:o}=e,l=t?.validationErrors;if(!l||!s)return null;if(o&&null===i)return l.cannotBeNull;if(s===p.VALUE_OUT_OF_RANGE||s===m.OUT_OF_RANGE){const{field:s,range:a}=e,i={type:"date",intlOptions:{timeZone:"date"===s.type&&n?n:void 0,...u(s)}},o=function(e,{validationErrors:t}){return null!=e.max&&null!=e.min?t.outsideRange:null!=e.max?t.outsideRangeMax:t.outsideRangeMin}(a,t);return f(o,a,{format:{max:"date"===r?i:null!=a.max&&k(a.max)?G:Z,min:"date"===r?i:null!=a.min&&k(a.min)?G:Z}})}return s===p.INVALID_CODED_VALUE?l.invalidCodedValue:s===d.INVALID_TYPE?l.invalidType:s===S.TOO_SHORT?f(l.tooShort,{min:a}):(S.TOO_LONG,null)},B=e=>{if(!e)return;const t=e.layer,n=t&&"geometryType"in t?t.geometryType:void 0,r=e.geometry?.type;return"polyline"===r||"polyline"===n?"line":"mesh"===r||"mesh"===n||"multipatch"===n?"cube":"multipoint"===r||"multipoint"===n?"point":r||n||"table"},H=e=>{const t=[];if(e.formTemplate){const{description:n,title:s}=e.formTemplate;e.fields?.forEach((e=>{const a=s&&r(s,e.name),i=n&&r(n,e.name);(a||i)&&t.push(e.name)}))}return t};function M(e,t){const n=t??("formTemplate"in e&&e.formTemplate);return!!n&&(n.elements?.filter(i)??[]).some((({fieldName:t})=>!e.fieldsIndex.get(t)))}function P(e,t){return null==e||t.onValue!==e&&t.offValue!==e}function W(e,t){switch(t.objectType){case"any":return!0;case"null":return null==e;case"code":return e===t.codedValue?.code;case"range":return null!=e&&null!=t.minValue&&null!=t.maxValue&&+e>=t.minValue&&+e<=t.maxValue;default:return n(t.objectType),!1}}function z(e,n,r){if(!e||!("subtypes"in e))return!1;const s=e.subtypes?.find((e=>e.code===r));if(!s)return!1;const a=e.subtypes?.find((e=>e.code===n));return!t(s.defaultValues,a?.defaultValues)&&Object.values(s.defaultValues).some((e=>null!=e))}export{h as A,v as B,W as C,S as L,j as a,N as b,y as c,w as d,C as e,H as f,$ as g,V as h,F as i,b as j,g as k,x as l,O as m,T as n,q as o,L as p,B as q,E as r,z as s,M as t,A as u,P as v,I as w,R as x,U as y,D as z};

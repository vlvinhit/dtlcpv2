/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{m as e}from"../core/lang.js";import{c as t,d as s,r as o,e as r}from"./mat3.js";import{c as i,a as n}from"./mat3f32.js";import{B as a}from"./enums3.js";import{f as l}from"./maybe.js";import"./TileStrategy.js";import{T as c}from"./TileKey2.js";import{B as h}from"./BufferObject.js";import{U as y}from"./enums.js";import{V as u}from"./VertexArrayObject.js";import{f,c as d}from"./config.js";import{T as m}from"./TiledDisplayObject.js";import{a as p,R as g,T as b}from"./StyleDefinition.js";import{i as _}from"./GeometryUtils.js";class x{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class w{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function S(e,t,s,o,r,i){const n=s-r;if(n>=0)return(t>>n)+(o-(i<<n))*(e>>n);const a=-n;return t-(i-(o<<a))*(e>>a)<<a}class I{constructor(e,t,s){this._rows=Math.ceil(t/s),this._columns=Math.ceil(e/s),this._cellSize=s,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const s=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),o=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][o]||null}getCellSpan(e,t,s,o){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function A(e,t,s){for(const[o,r]of e.symbols)T(e,t,s,r,o)}function T(e,t,s,o,r){const i=e.layerData.get(r);if(i.type===a.SYMBOL){for(const t of o){const o=t.unique;let r;if(t.selectedForRendering){const t=o.parts[0],i=t.startOpacity,n=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===n;const a=s?Math.floor(127*i)|n<<7:n?255:0;r=a<<24|a<<16|a<<8|a}else r=0;for(const[e,s]of t.iconVertexRanges)for(let t=e;t<e+s;t+=4)i.iconOpacity[t/4]=r;if(t.selectedForRendering){const t=o.parts[1],i=t.startOpacity,n=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===n;const a=s?Math.floor(127*i)|n<<7:n?255:0;r=a<<24|a<<16|a<<8|a}else r=0;for(const[e,s]of t.textVertexRanges)for(let t=e;t<e+s;t+=4)i.textOpacity[t/4]=r}i.lastOpacityUpdate=t,i.opacityChanged=!0}}function M(e,t,s,o){const r=e.colliders;let i,n,a,l;for(const c of r)if(e.unique.show&&e.unique.parts[c.partIndex].show&&(i=c.xScreen-o[0]+c.dxScreen,n=c.yScreen-o[1]+c.dyScreen,a=i+c.width,l=n+c.height,_(s,t.x,t.y,i,n,a,l)))return!0;return!1}class C{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let s=1;const o=new Uint32Array(e);this.layerUIDs=[];const r=o[s++];for(let e=0;e<r;e++)this.layerUIDs[e]=o[s++];this.bufferDataOffset=s,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}class D extends C{constructor(e,t){super(e,t),this.type=a.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const s=new Uint32Array(e);let o=this.bufferDataOffset;this.lineIndexStart=s[o++],this.lineIndexCount=s[o++];const r=s[o++];if(r>0){this.patternMap=new Map;for(let e=0;e<r;e++){const e=s[o++],t=s[o++],r=s[o++];this.patternMap.set(e,[t,r])}}this.bufferDataOffset=o}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=l(this.vao)}doPrepareForRendering(e,t,s){const o=new Uint32Array(t),r=new Int32Array(o.buffer),i=o[s++],n=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,i));s+=i;const a=o[s++],l=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,a));s+=a;const c=this.layer.lineMaterial;this.vao=new u(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:n},l)}}class O extends C{constructor(e,t){super(e,t),this.type=a.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const s=new Uint32Array(e);let o=this.bufferDataOffset;this.fillIndexStart=s[o++],this.fillIndexCount=s[o++],this.outlineIndexStart=s[o++],this.outlineIndexCount=s[o++];const r=s[o++];if(r>0){this.patternMap=new Map;for(let e=0;e<r;e++){const e=s[o++],t=s[o++],r=s[o++];this.patternMap.set(e,[t,r])}}this.bufferDataOffset=o}get memoryUsed(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=l(this.fillVAO),this.outlineVAO=l(this.outlineVAO)}doPrepareForRendering(e,t,s){const o=new Uint32Array(t),r=new Int32Array(o.buffer),i=o[s++],n=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,i));s+=i;const a=o[s++],l=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,a));s+=a;const c=o[s++],f=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,c));s+=c;const d=o[s++],m=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,d));s+=d;const p=this.layer,g=p.fillMaterial,b=p.outlineMaterial;this.fillVAO=new u(e,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:n},l),this.outlineVAO=new u(e,b.getAttributeLocations(),b.getLayoutInfo(),{geometry:f},m)}}class L extends C{constructor(e,t,s){super(e,t),this.type=a.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const o=new Uint32Array(e),r=new Int32Array(e),i=new Float32Array(e);let n=this.bufferDataOffset;this.isIconSDF=!!o[n++];const l=o[n++],h=o[n++],y=o[n++],u=new c(l,h,y,0),f=o[n++];for(let e=0;e<f;e++){const e=o[n++],t=o[n++],s=o[n++];this.iconPerPageElementsMap.set(e,[t,s])}const d=o[n++];for(let e=0;e<d;e++){const e=o[n++],t=o[n++],s=o[n++];this.glyphPerPageElementsMap.set(e,[t,s])}const m=o[n++],p=o[n++];this.iconOpacity=new Int32Array(m),this.textOpacity=new Int32Array(p),n=function(e,t,s,o,r,i,n){const a=t[o++];for(let l=0;l<a;l++){const a=new x(i,n);a.xTile=t[o++],a.yTile=t[o++],a.hash=t[o++],a.priority=t[o++],a.featureIndex=t[o++];const l=t[o++];for(let e=0;e<l;e++){const e=t[o++],r=t[o++],i=t[o++],n=t[o++],l=!!t[o++],c=t[o++],h=s[o++],y=s[o++],u=t[o++],f=t[o++];a.colliders.push({xTile:e,yTile:r,dxPixels:i,dyPixels:n,hard:l,partIndex:c,width:u,height:f,minLod:h,maxLod:y})}const c=e[o++];for(let t=0;t<c;t++)a.textVertexRanges.push([e[o++],e[o++]]);const h=e[o++];for(let t=0;t<h;t++)a.iconVertexRanges.push([e[o++],e[o++]]);r.push(a)}return o}(o,r,i,n,this.symbols,s,u),this.bufferDataOffset=n}get memoryUsed(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+e(this.iconOpacity)+e(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[t,s]of this.iconPerPageElementsMap)e+=s[1];for(const[t,s]of this.glyphPerPageElementsMap)e+=s[1];return e/3}doDestroy(){this.iconVAO=l(this.iconVAO),this.textVAO=l(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.vertexBuffers.opacity;e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const s=this.textOpacity,o=this.textVAO.vertexBuffers.opacity;s.length>0&&s.byteLength===o.usedMemory&&o.setSubData(s,0,0,s.length)}doPrepareForRendering(e,t,s){const o=new Uint32Array(t),r=new Int32Array(o.buffer),i=o[s++],n=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,i));s+=i;const a=o[s++],l=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,a));s+=a;const c=o[s++],f=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,c));s+=c;const d=o[s++],m=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,d));s+=d;const p=h.createVertex(e,y.STATIC_DRAW,this.iconOpacity.buffer),g=h.createVertex(e,y.STATIC_DRAW,this.textOpacity.buffer),b=this.layer,_=b.iconMaterial,x=b.textMaterial;this.iconVAO=new u(e,_.getAttributeLocations(),_.getLayoutInfo(),{geometry:n,opacity:p},l),this.textVAO=new u(e,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:f,opacity:g},m)}}class R extends C{constructor(e,t){super(e,t),this.type=a.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const s=new Uint32Array(e);let o=this.bufferDataOffset;this.circleIndexStart=s[o++],this.circleIndexCount=s[o++],this.bufferDataOffset=o}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=l(this.vao)}doPrepareForRendering(e,t,s){const o=new Uint32Array(t),r=new Int32Array(o.buffer),i=o[s++],n=h.createVertex(e,y.STATIC_DRAW,new Int32Array(r.buffer,4*s,i));s+=i;const a=o[s++],l=h.createIndex(e,y.STATIC_DRAW,new Uint32Array(o.buffer,4*s,a));s+=a;const c=this.layer.circleMaterial;this.vao=new u(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:n},l)}}class U extends m{constructor(e,t,s,o,r,i,n,a=null){super(e,t,s,o,r,i,4096,4096),this.styleRepository=n,this._memCache=a,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this._referenced=1,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<f}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<f)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const s of e){const e=this.layerData.get(s);e&&(this._memoryUsedByLayerData-=e.memoryUsed,e.type===a.SYMBOL&&this.symbols.delete(s)&&(t=!0),e.destroy(),this.layerData.delete(s))}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(this.featureIndex=null,v.delete(this),U._destroyRenderBuckets(this.layerData),this.layerData.clear(),this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get usedMemory(){return this._memoryUsedByLayerData+256}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:s,emptyBuckets:o}=e,r=this._createRenderBuckets(s);if(o&&o.byteLength>0){const e=new Uint32Array(o);for(const t of e)this._deleteLayerData(t)}for(const[e,s]of r)this._deleteLayerData(e),s.type===a.SYMBOL&&(this.symbols.set(e,s.symbols),t=!0),this._memoryUsedByLayerData+=s.memoryUsed,this.layerData.set(e,s);this._memCache?.updateSize(this.key.id,this,this.usedMemory)}this._hasSymbolBuckets=!1;for(const[e,t]of this.layerData)t.type===a.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const i=this.resolution/(e.resolution*e.pixelRatio),n=this.width/this.rangeX*i,a=this.height/this.rangeY*i,l=[0,0];e.toScreen(l,[this.x,this.y]);const c=this.transforms.tileUnitsToPixels;t(c),s(c,c,l),o(c,c,Math.PI*e.rotation/180),r(c,c,[n,a,1])}_createTransforms(){return{displayViewScreenMat3:i(),tileMat3:i(),tileUnitsToPixels:i()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const s of e.values())t.has(s)||(s.destroy(),t.add(s));e.clear()}_createRenderBuckets(e){const t=new Map,s=new Map;for(const o of e){const e=this._deserializeBucket(o,s);for(const s of e.layerUIDs)t.set(s,e)}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case a.FILL:s=new O(e,this.styleRepository);break;case a.LINE:s=new D(e,this.styleRepository);break;case a.SYMBOL:s=new L(e,this.styleRepository,this);break;case a.CIRCLE:s=new R(e,this.styleRepository)}return t.set(e,s),s}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e)}}const v=new Map;function P(){v.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)))}))}function V(e,t,s,o,r,i){const{iconRotationAlignment:n,textRotationAlignment:a,iconTranslate:l,iconTranslateAnchor:c,textTranslate:h,textTranslateAnchor:y}=o;let u=0;for(const o of e.colliders){const[e,f]=0===o.partIndex?l:h,d=0===o.partIndex?c:y,m=o.minLod<=i&&i<=o.maxLod;u+=m?0:1,o.enabled=m,o.xScreen=o.xTile*r[0]+o.yTile*r[3]+r[6],o.yScreen=o.xTile*r[1]+o.yTile*r[4]+r[7],d===b.MAP?(o.xScreen+=s*e-t*f,o.yScreen+=t*e+s*f):(o.xScreen+=e,o.yScreen+=f),g.VIEWPORT===(0===o.partIndex?n:a)?(o.dxScreen=o.dxPixels,o.dyScreen=o.dyPixels):(o.dxScreen=s*(o.dxPixels+o.width/2)-t*(o.dyPixels+o.height/2)-o.width/2,o.dyScreen=t*(o.dxPixels+o.width/2)+s*(o.dyPixels+o.height/2)-o.height/2)}e.colliders.length>0&&u===e.colliders.length&&(e.unique.show=!1)}class k{constructor(e,t,s,o,r,i){this._symbols=e,this._styleRepository=o,this._zoom=r,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new I(t,s,d),this._si=Math.sin(Math.PI*i/180),this._co=Math.cos(Math.PI*i/180);for(const t of e)for(const e of t.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,n(e.tile.transforms.tileUnitsToPixels))}work(e){const t=this._gridIndex;function s(e){const s=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,r=s+e.width,i=o+e.height,[n,a,l,c]=t.getCellSpan(s,o,r,i);for(let e=a;e<=c;e++)for(let a=n;a<=l;a++){const n=t.cells[e][a];for(const e of n){const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,a=t+e.width,l=n+e.height;if(!(r<t||s>a||i<n||o>l))return!0}}return!1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],r=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return!1;const i=t.symbols[this._currentSymbolCursor];if(!i.unique.show)continue;V(i,this._si,this._co,r,this._allNeededMatrices.get(i.tile),this._zoom);const n=i.unique;if(!n.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:l,textAllowOverlap:c,textIgnorePlacement:h}=r;for(const e of i.colliders){if(!e.enabled)continue;const t=n.parts[e.partIndex];t.show&&!(e.partIndex?c:a)&&s(e)&&(e.hard?n.show=!1:t.show=!1)}if(n.show)for(const e of i.colliders){if(!e.enabled)continue;if(e.partIndex?h:l)continue;if(!n.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,s=e.yScreen+e.dyScreen,o=t+e.width,r=s+e.height,[i,a,c,y]=this._gridIndex.getCellSpan(t,s,o,r);for(let t=a;t<=y;t++)for(let s=i;s<=c;s++)this._gridIndex.cells[t][s].push(e)}}}return!0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const s=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),r=o.getLayoutValue("symbol-placement",s)!==p.POINT;let i=o.getLayoutValue("icon-rotation-alignment",s);i===g.AUTO&&(i=r?g.MAP:g.VIEWPORT);let n=o.getLayoutValue("text-rotation-alignment",s);n===g.AUTO&&(n=r?g.MAP:g.VIEWPORT);const a=o.getPaintValue("icon-translate",s),l=o.getPaintValue("icon-translate-anchor",s),c=o.getPaintValue("text-translate",s),h=o.getPaintValue("text-translate-anchor",s),y={iconAllowOverlap:o.getLayoutValue("icon-allow-overlap",s),iconIgnorePlacement:o.getLayoutValue("icon-ignore-placement",s),textAllowOverlap:o.getLayoutValue("text-allow-overlap",s),textIgnorePlacement:o.getLayoutValue("text-ignore-placement",s),iconRotationAlignment:i,textRotationAlignment:n,iconTranslateAnchor:l,iconTranslate:a,textTranslateAnchor:h,textTranslate:c};return this._styleProps.set(e,y),y}}function q(e,t){if(e.priority-t.priority)return e.priority-t.priority;const s=e.tile.key,o=t.tile.key;return s.world-o.world?s.world-o.world:s.level-o.level?s.level-o.level:s.row-o.row?s.row-o.row:s.col-o.col?s.col-o.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class B{get running(){return this._running}constructor(e,t,s,o,r,i){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=s,this._assignTileSymbolsOpacity=o,this._symbolLayerSorter=r,this._isLayerVisible=i,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.uniqueSymbols.length;e++){const t=s.uniqueSymbols[e];for(const e of t.tileSymbols)e.selectedForRendering=!1}}const t=[];let s=0,o=0;const r=this._isLayerVisible,i=this._symbolLayerSorter;return{work:function(i){let n;const a=performance.now();for(;o<e.length;o++,s=0){const l=e[o],c=l.styleLayerUID;if(!r(c)){t[o]||(t[o]={styleLayerUID:c,symbols:[]});continue}t[o]=t[o]||{styleLayerUID:c,symbols:[]};const h=t[o];for(;s<l.uniqueSymbols.length;s++){if(n=l.uniqueSymbols[s],s%100==99&&performance.now()-a>i)return!1;let e=null,t=!1,o=!1;for(const s of n.tileSymbols)if(!o||!t){const r=s.tile;(!e||r.isCoverage||r.neededForCoverage&&!t)&&(e=s,(r.neededForCoverage||r.isCoverage)&&(o=!0),r.isCoverage&&(t=!0))}if(e.selectedForRendering=!0,o){h.symbols.push(e),n.show=!0;for(const e of n.parts)e.show=!0}else n.show=!1}}for(const e of t)e.symbols.sort(q);return!0},get sortedSymbols(){return t.sort(i)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let s=0;function o(t,s){const r=t.symbols;for(const[e,t]of r)J(t,s);e(t,s);for(const e of t.childrenTiles)o(e,s)}return{work(e){const r=performance.now();for(;s<t.length;s++){if(performance.now()-r>e)return!1;const i=t[s];null==i.parentTile&&o(i,performance.now())}return!0}}}}function J(e,t){for(const s of e){const e=s.unique;for(const s of e.parts){const o=s.targetOpacity>.5?1:-1;s.startOpacity+=o*((t-s.startTime)/f),s.startOpacity=Math.min(Math.max(s.startOpacity,0),1),s.startTime=t,s.targetOpacity=e.show&&s.show?1:0}}}class F{constructor(e,t,s){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=s,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,t){this._uniqueSymbolLayerArray=null;let s=this._tiles.get(e.id);s||(s={symbols:new Map},this._tiles.set(e.id,s));const o=new Map;if(t)for(const e of t)s.symbols.has(e)&&(o.set(e,s.symbols.get(e)),s.symbols.delete(e));else for(const[t,r]of e.layerData)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o);const r=e.symbols,i=new Map;for(const[e,t]of r){let o=t.length;if(o>=32){let r=this.tileCoordRange;do{r/=2,o/=4}while(o>8&&r>64);const n=new I(this.tileCoordRange,this.tileCoordRange,r);i.set(e,{flat:t,index:n}),s.symbols.set(e,{flat:t,index:n});for(const e of t)n.getCell(e.xTile,e.yTile).push(e)}else i.set(e,{flat:t}),s.symbols.set(e,{flat:t})}this._addSymbols(e.key,r)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[t,s]of this._tiles){const o=new Map;for(const t of e)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o),0===s.symbols.size&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;const t=this._tiles.get(e.id);if(!t)return;const s=new Map;for(const[o,r]of e.symbols)t.symbols.has(o)&&(s.set(o,t.symbols.get(o)),t.symbols.delete(o));this._removeSymbols(s),0===t.symbols.size&&this._tiles.delete(e.id)}querySymbols(e,t,s,o){const r=[],i=this.uniqueSymbols;for(const o of i){const i=o.styleLayerUID,n=o.uniqueSymbols;for(const o of n){const n=o.tileSymbols.find((e=>e.selectedForRendering));n&&M(n,e,t*(window.devicePixelRatio||1),s)&&r.push({vtlSymbol:n,styleLayerUID:i,tileKey:n.tile.key})}}return r}_removeSymbols(e){for(const[t,{flat:s}]of e)for(const e of s){const s=e.unique,o=s.tileSymbols,r=o.length-1;for(let t=0;t<r;t++)if(o[t]===e){o[t]=o[r];break}if(o.length=r,0===r){const e=this._uniqueSymbolsReferences.get(t);e.delete(s),0===e.size&&this._uniqueSymbolsReferences.delete(t)}e.unique=null}}_addSymbols(e,t){if(0===t.size)return;const s=this._visibleTiles;for(const o of s)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,t);for(const[e,s]of t)for(const t of s)if(null==t.unique){const s=this._createUnique();t.unique=s,s.tileSymbols.push(t);let o=this._uniqueSymbolsReferences.get(e);o||(o=new Set,this._uniqueSymbolsReferences.set(e,o)),o.add(s)}}_matchSymbols(e,t,s){if(e.key.level>t.level){const s=e.key.level-t.level;if(e.key.row>>s!==t.row||e.key.col>>s!==t.col)return}if(t.level>e.key.level){const s=t.level-e.key.level;if(t.row>>s!==e.key.row||t.col>>s!==e.key.col)return}if(t.equals(e.key)){for(const o of e.childrenTiles)this._matchSymbols(o,t,s);return}const o=new Map;for(const[r,i]of s){const s=[];for(const o of i){const r=S(this.tileCoordRange,o.xTile,t.level,t.col,e.key.level,e.key.col),i=S(this.tileCoordRange,o.yTile,t.level,t.row,e.key.level,e.key.row);r>=0&&r<this.tileCoordRange&&i>=0&&i<this.tileCoordRange&&s.push({symbol:o,xTransformed:r,yTransformed:i})}const n=[],a=20+(e.key.level<t.level?1:1<<e.key.level-t.level),l=this._tiles.get(e.id).symbols.get(r);if(l){const e=l.flat;for(const t of s){let s,o=!1;const r=t.xTransformed,i=t.yTransformed;s=null!=l.index?l.index.getCell(r,i):e;const c=t.symbol,h=c.hash;for(const e of s)if(h===e.hash&&Math.abs(r-e.xTile)<=a&&Math.abs(i-e.yTile)<=a){const t=e.unique;c.unique=t,t.tileSymbols.push(c),o=!0;break}o||n.push(c)}}n.length>0&&o.set(r,n)}for(const s of e.childrenTiles)this._matchSymbols(s,t,o)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,t=new Array(e.size);let s,o=0;for(const[r,i]of e){const e=new Array(i.size);s=0;for(const t of i)e[s++]=t;t[o]={styleLayerUID:r,uniqueSymbols:e},o++}return t}}class z extends m{_createTransforms(){return{displayViewScreenMat3:i(),tileMat3:i()}}}export{k as C,z as R,F as S,w as V,B as a,U as b,P as p,A as w};

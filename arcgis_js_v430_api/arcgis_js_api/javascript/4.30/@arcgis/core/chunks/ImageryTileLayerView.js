/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../Graphic.js";import r from"../core/Error.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import{c as a}from"./timeSupport2.js";import{g as o,p as n}from"./rasterProjectionHelper.js";import{a as l}from"./popupUtils.js";const u=u=>{let p=class extends u{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}get timeExtent(){return a(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return o(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(e){return!!n(this.layer.serviceRasterInfo,e)}async fetchPopupFeaturesAtLocation(e,i){const{layer:s}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:a}=s,o=l(s,i);if(!a||null==o)return[];const n=[],{value:u,magdirValue:p,processedValue:c}=await s.identify(e,{timeExtent:this.timeExtent,signal:i?.signal});let m="";if(u?.length){m="imagery-tile"===s.type&&s.hasStandardTime()&&null!=u[0]?u.map((e=>s.getStandardTimeValue(e))).join(", "):u.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]="imagery-tile"===s.type&&"Function"===s.raster.datasetFormat?c?.join(", "):m,e[r+".Raw"]=m;const i=s.raster?.rasterInfo??s.serviceRasterInfo,a=i?.attributeTable;if(null!=a){const{fields:t,features:i}=a,s=t.find((({name:e})=>"value"===e.toLowerCase())),o=e[r],n=s?i.find((e=>String(e.attributes[s.name])===o)):null;if(n)for(const t in n.attributes)n.attributes.hasOwnProperty(t)&&(e[this._rasterFieldPrefix+t]=n.attributes[t])}const o=i?.dataType;"vector-magdir"!==o&&"vector-uv"!==o||(e["Raster.Magnitude"]=p?.[0],e["Raster.Direction"]=p?.[1]);const l=new t({geometry:this.fullExtent.clone(),attributes:e,layer:s,sourceLayer:s});n.push(l)}return n}_getfullExtent(){return n(this.layer.serviceRasterInfo,this.view.spatialReference)}};return e([i()],p.prototype,"fullExtent",null),e([i()],p.prototype,"layer",void 0),e([i({readOnly:!0})],p.prototype,"timeExtent",null),e([i()],p.prototype,"view",void 0),e([i()],p.prototype,"tileInfo",void 0),e([i({readOnly:!0})],p.prototype,"hasTilingEffects",null),e([i()],p.prototype,"datumTransformation",null),p=e([s("esri.views.layers.ImageryTileLayerView")],p),p};export{u as I};

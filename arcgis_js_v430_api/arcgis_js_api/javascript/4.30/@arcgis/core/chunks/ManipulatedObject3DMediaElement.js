/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{d as o}from"./handleUtils.js";import{initial as r,watch as i,sync as s,syncAndInitial as n,on as a}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import{i as p}from"../core/lang.js";import"./Logger.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import"../geometry.js";import d from"../core/Accessor.js";import{U as c}from"./UpdatingHandles.js";import{initializeProjection as u,project as h,projectWithZConversion as y}from"../geometry/projection.js";import{E as g}from"./EditGeometryOperations.js";import j from"../geometry/Polygon.js";import f from"../geometry/Point.js";import{j as v}from"./vec3.js";import{c as _}from"./vec3f64.js";import{p as w}from"./projectPointToVector.js";import C from"../layers/support/ImageElement.js";import E from"../layers/support/VideoElement.js";import"../core/Handles.js";import"../config.js";import"./maybe.js";import"./ensureType.js";import"./utils.js";import"./metadata.js";import"../core/Error.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./asyncUtils.js";import"../core/Collection.js";import"./shared.js";import"./SimpleObservable.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./writer.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polyline.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./common.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./coordsUtils.js";import"./Axis.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./compilerUtils.js";import"./vec2.js";import"./vec2f64.js";import"./vec4.js";import"./vec4f64.js";import"./ViewingMode.js";import"./plane.js";import"./mat3f64.js";import"./mat4f64.js";import"./quatf64.js";import"./mathUtils2.js";import"./geometry2dUtils.js";import"./imageUtils.js";import"./uuid.js";import"../layers/support/MediaElementBase.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"./MultiOriginJSONSupport.js";import"../layers/support/ControlPointsGeoreference.js";import"../core/Clonable.js";import"./perspectiveUtils.js";import"./mat3.js";import"./screenUtils.js";import"./GeoreferenceBase.js";import"../layers/support/CornersGeoreference.js";import"../layers/support/ExtentAndRotationGeoreference.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";let b=class extends d{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c}initialize(){this.addHandles([o(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return"control-points"===e?.type?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),r)])}_elementControlPointsChanged(e){if(this._updatedElementControlPoints===e)return;const t=e?.map((({mapPoint:e})=>e)).filter(p),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,o,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this,r=new j({rings:[e.map((({x:e,y:t})=>[e,t]))],spatialReference:o});t?.trySetGeometry(r)?this.onModifiedExternally():this._replaceOperations(g.fromGeometry(r,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e||"control-points"!==e.type||!e.controlPoints)return;const o=t.data.geometry,r=e.controlPoints.map((({mapPoint:e})=>e)).filter(p);if(o.rings[0]?.length!==r.length)return void this._updateElementControlPoints(null);const i=o.rings[0].map((([e,t])=>new f({x:e,y:t,spatialReference:o.spatialReference}))),s=r.map((({spatialReference:e})=>e));this._updatingHandles.addPromise(this._whenProjected(i,s,(e=>this._updateElementControlPoints(e))))}_updateElementControlPoints(e){const{georeference:t}=this.element;if(!t||!e||"control-points"!==t.type||t.controlPoints?.length!==e?.length)return;e||(t.controlPoints=null);const o=t.controlPoints;if(o?.length===e.length)for(let t=0;t<o.length;t++)o[t].mapPoint=e[t]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:r,element:{georeference:i}}=this,s=e.map((({spatialReference:e})=>e)),n=Array.isArray(t)?t:new Array(s.length).fill(t);await u(Array.from(s).map(((e,t)=>({source:e,dest:n[t]}))));const a=e.map(((e,t)=>h(e,n[t])));r===this._operations&&i===this.element.georeference&&o(a)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e)}};e([l({constructOnly:!0})],b.prototype,"view",void 0),e([l({constructOnly:!0})],b.prototype,"layer",void 0),e([l({constructOnly:!0})],b.prototype,"element",void 0),e([l({constructOnly:!0})],b.prototype,"onModifiedExternally",void 0),e([l()],b.prototype,"_operations",void 0),e([l()],b.prototype,"operations",null),e([l()],b.prototype,"updating",null),b=e([m("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],b);let P=class extends d{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c}initialize(){this.addHandles([o(this._updatingHandles),this._updatingHandles.add((()=>this.element.georeference?.coords),(e=>this._elementCoordinatesChanged(e)),r)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this;t?.trySetGeometry(e)?this.onModifiedExternally():this._replaceOperations(g.fromGeometry(e,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const o=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const r=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,r,(e=>this._updateElementCoordinates(e))))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:r,element:{georeference:i}}=this,s=await y(e,t);r===this._operations&&i===this.element.georeference&&o(s)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};function O(e,t){if(!e||"media-3d"!==e.type||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof C||o instanceof E?o===t:"hasElement"in o&&o.hasElement(t))}e([l({constructOnly:!0})],P.prototype,"view",void 0),e([l({constructOnly:!0})],P.prototype,"layer",void 0),e([l({constructOnly:!0})],P.prototype,"element",void 0),e([l({constructOnly:!0})],P.prototype,"onModifiedExternally",void 0),e([l()],P.prototype,"_operations",void 0),e([l()],P.prototype,"operations",null),e([l()],P.prototype,"updating",null),P=e([m("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],P);let H=class extends d{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new t.EventEmitter,this.addHandles(i((()=>this.selected),(e=>this.events.emit("select-changed",{action:e?"select":"deselect"})),s))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:o,element:r}=this;if(!function(e,t,o){return O(e.allLayerViews.find((e=>e.layer===t)),o)}(t,o,r))return null;const i=t.toMap(e,{include:{layer:o,element:r}});return i&&w(i,M,t.renderSpatialReference)?v(M,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};e([l({constructOnly:!0,nonNullable:!0})],H.prototype,"element",void 0),e([l({constructOnly:!0,nonNullable:!0})],H.prototype,"layer",void 0),e([l({constructOnly:!0,nonNullable:!0})],H.prototype,"view",void 0),e([l()],H.prototype,"interactive",void 0),e([l()],H.prototype,"selectable",void 0),e([l()],H.prototype,"grabbable",void 0),e([l()],H.prototype,"grabbing",void 0),e([l()],H.prototype,"dragging",void 0),e([l()],H.prototype,"hovering",void 0),e([l()],H.prototype,"selected",void 0),e([l()],H.prototype,"cursor",void 0),H=e([m("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],H);const M=_(),U=Symbol();let x=class extends t.EventedAccessor{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((e=>e.layer===this.layer));return"media-3d"===e?.type?e:null}get visible(){return O(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return"transform"===this.tool||"control-points"!==this.element.georeference?.type?P:b}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([i((()=>this._controllerClass),(e=>this._updateController(e)),n),a((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:t,element:o}=this;return this.view.toMap(e,{include:{layer:t,element:o}})}createManipulator(e){const{view:t,layer:o,element:r}=this;return new H({view:t,layer:o,element:r,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(U);const{view:t,layer:r,element:i}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:r,element:i,onModifiedExternally:s}),s(),this.addHandles(o(this._controller),U)}};e([l({constructOnly:!0})],x.prototype,"view",void 0),e([l({constructOnly:!0})],x.prototype,"layer",void 0),e([l({constructOnly:!0})],x.prototype,"element",void 0),e([l()],x.prototype,"tool",void 0),e([l()],x.prototype,"_controller",void 0),e([l()],x.prototype,"elevationInfo",null),e([l()],x.prototype,"_layerView",null),e([l()],x.prototype,"visible",null),e([l()],x.prototype,"updating",null),e([l()],x.prototype,"_controllerClass",null),x=e([m("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],x);export{x as ManipulatedObject3DMediaElement};

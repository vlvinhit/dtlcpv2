/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{V as t}from"./VertexAttribute.js";import{p as e,q as n}from"./mat4.js";import{o,d as s,b as i,c as f,D as r,B as c}from"./BufferView.js";import{a}from"./Util.js";import{x as l,s as u,p as d,e as p,n as h}from"./vec3.js";import{c as b}from"./vec3f64.js";import{c as y,u as g,v as m}from"./aaBoundingBox.js";import{C as M}from"./Material.js";function B(t,e,n,o=1){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,1===o)for(let t=0;t<c;++t)f[n]=s[i[t]],n+=r;else for(let t=0;t<c;++t){const e=s[i[t]];for(let t=0;t<o;t++)f[n]=e,n+=r}}function O(t,e,n){const{data:o,indices:s}=t,i=e.typedBuffer,f=e.typedBufferStride,r=s.length;n*=f;for(let t=0;t<r;++t){const e=2*s[t];i[n]=o[e],i[n+1]=o[e+1],n+=f}}function R(t,e,n,o){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,null==o||1===o)for(let t=0;t<c;++t){const e=3*i[t];f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],n+=r}else for(let t=0;t<c;++t){const e=3*i[t];for(let t=0;t<o;++t)f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],n+=r}}function T(t,e,n,o=1){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,1===o)for(let t=0;t<c;++t){const e=4*i[t];f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],f[n+3]=s[e+3],n+=r}else for(let t=0;t<c;++t){const e=4*i[t];for(let t=0;t<o;++t)f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],f[n+3]=s[e+3],n+=r}}function v(t,e,n){const o=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let t=0;t<n;++t)o[e]=0,o[e+1]=0,o[e+2]=0,o[e+3]=0,e+=s}function I(t,n,o,s,i=1){if(!n)return void R(t,o,s,i);const{data:f,indices:r}=t,c=o.typedBuffer,a=o.typedBufferStride,l=r.length,u=n[0],d=n[1],p=n[2],h=n[4],b=n[5],y=n[6],g=n[8],m=n[9],M=n[10],B=n[12],O=n[13],T=n[14];s*=a;let v=0,I=0,N=0;const x=e(n)?t=>{v=f[t]+B,I=f[t+1]+O,N=f[t+2]+T}:t=>{const e=f[t],n=f[t+1],o=f[t+2];v=u*e+h*n+g*o+B,I=d*e+b*n+m*o+O,N=p*e+y*n+M*o+T};if(1===i)for(let t=0;t<l;++t)x(3*r[t]),c[s]=v,c[s+1]=I,c[s+2]=N,s+=a;else for(let t=0;t<l;++t){x(3*r[t]);for(let t=0;t<i;++t)c[s]=v,c[s+1]=I,c[s+2]=N,s+=a}}function N(t,o,s,i,f=1){if(!o)return void R(t,s,i,f);const{data:r,indices:c}=t,a=o,l=s.typedBuffer,u=s.typedBufferStride,d=c.length,p=a[0],h=a[1],b=a[2],y=a[4],g=a[5],m=a[6],M=a[8],B=a[9],O=a[10],T=!n(a),v=1e-6,I=.999999;i*=u;let N=0,x=0,S=0;const L=e(a)?t=>{N=r[t],x=r[t+1],S=r[t+2]}:t=>{const e=r[t],n=r[t+1],o=r[t+2];N=p*e+y*n+M*o,x=h*e+g*n+B*o,S=b*e+m*n+O*o};if(1===f)if(T)for(let t=0;t<d;++t){L(3*c[t]);const e=N*N+x*x+S*S;if(e<I&&e>v){const t=1/Math.sqrt(e);l[i]=N*t,l[i+1]=x*t,l[i+2]=S*t}else l[i]=N,l[i+1]=x,l[i+2]=S;i+=u}else for(let t=0;t<d;++t)L(3*c[t]),l[i]=N,l[i+1]=x,l[i+2]=S,i+=u;else for(let t=0;t<d;++t){if(L(3*c[t]),T){const t=N*N+x*x+S*S;if(t<I&&t>v){const e=1/Math.sqrt(t);N*=e,x*=e,S*=e}}for(let t=0;t<f;++t)l[i]=N,l[i+1]=x,l[i+2]=S,i+=u}}function x(t,e,n,o,s=1){const{data:i,indices:f}=t,r=n.typedBuffer,c=n.typedBufferStride,a=f.length;if(o*=c,e!==i.length||4!==e)if(1!==s)if(4!==e)for(let t=0;t<a;++t){const e=3*f[t];for(let t=0;t<s;++t)r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=255,o+=c}else for(let t=0;t<a;++t){const e=4*f[t];for(let t=0;t<s;++t)r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=i[e+3],o+=c}else{if(4===e){for(let t=0;t<a;++t){const e=4*f[t];r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=i[e+3],o+=c}return}for(let t=0;t<a;++t){const e=3*f[t];r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=255,o+=c}}else{r[o]=i[0],r[o+1]=i[1],r[o+2]=i[2],r[o+3]=i[3];const t=new Uint32Array(n.typedBuffer.buffer,n.start),e=c/4,f=t[o/=4];o+=e;const l=a*s;for(let n=1;n<l;++n)t[o]=f,o+=e}}function S(t,e,n,o,s=1){const i=e.typedBuffer,f=e.typedBufferStride;if(o*=f,1===s)for(let e=0;e<n;++e)i[o]=t[0],i[o+1]=t[1],i[o+2]=t[2],i[o+3]=t[3],o+=f;else for(let e=0;e<n;++e)for(let e=0;e<s;++e)i[o]=t[0],i[o+1]=t[1],i[o+2]=t[2],i[o+3]=t[3],o+=f}function L(e,n,s,i,f,r){for(const c of n.fields.keys()){const n=e.attributes.get(c),a=n?.indices;if(n&&a)A(c,n,s,i,f,r);else if(c===t.OBJECTANDLAYERIDCOLOR&&null!=e.objectAndLayerIdColor){const n=e.attributes.get(t.POSITION)?.indices;if(n){const t=n.length,s=f.getField(c,o);S(e.objectAndLayerIdColor,s,t,r)}}}}function A(e,l,u,d,p,h){switch(e){case t.POSITION:{a(3===l.size);const t=p.getField(e,c);a(!!t,`No buffer view for ${e}`),t&&I(l,u,t,h);break}case t.NORMAL:{a(3===l.size);const t=p.getField(e,c);a(!!t,`No buffer view for ${e}`),t&&N(l,d,t,h);break}case t.NORMALCOMPRESSED:{a(2===l.size);const t=p.getField(e,r);a(!!t,`No buffer view for ${e}`),t&&O(l,t,h);break}case t.UV0:{a(2===l.size);const t=p.getField(e,f);a(!!t,`No buffer view for ${e}`),t&&O(l,t,h);break}case t.COLOR:case t.SYMBOLCOLOR:{const t=p.getField(e,o);a(!!t,`No buffer view for ${e}`),a(3===l.size||4===l.size),!t||3!==l.size&&4!==l.size||x(l,l.size,t,h);break}case t.COLORFEATUREATTRIBUTE:{const t=p.getField(e,i);a(!!t,`No buffer view for ${e}`),a(1===l.size),t&&1===l.size&&function(t,e,n){const{data:o,indices:s}=t,i=e.typedBuffer,f=e.typedBufferStride,r=s.length,c=o[0];n*=f;for(let t=0;t<r;++t)i[n]=c,n+=f}(l,t,h);break}case t.TANGENT:{a(4===l.size);const t=p.getField(e,s);a(!!t,`No buffer view for ${e}`),t&&function(t,e,o,s,i=1){if(!e)return void T(t,o,s,i);const{data:f,indices:r}=t,c=e,a=o.typedBuffer,l=o.typedBufferStride,u=r.length,d=c[0],p=c[1],h=c[2],b=c[4],y=c[5],g=c[6],m=c[8],M=c[9],B=c[10],O=!n(c),R=1e-6,v=.999999;if(s*=l,1===i)for(let t=0;t<u;++t){const e=4*r[t],n=f[e],o=f[e+1],i=f[e+2],c=f[e+3];let u=d*n+b*o+m*i,T=p*n+y*o+M*i,I=h*n+g*o+B*i;if(O){const t=u*u+T*T+I*I;if(t<v&&t>R){const e=1/Math.sqrt(t);u*=e,T*=e,I*=e}}a[s]=u,a[s+1]=T,a[s+2]=I,a[s+3]=c,s+=l}else for(let t=0;t<u;++t){const e=4*r[t],n=f[e],o=f[e+1],c=f[e+2],u=f[e+3];let T=d*n+b*o+m*c,I=p*n+y*o+M*c,N=h*n+g*o+B*c;if(O){const t=T*T+I*I+N*N;if(t<v&&t>R){const e=1/Math.sqrt(t);T*=e,I*=e,N*=e}}for(let t=0;t<i;++t)a[s]=T,a[s+1]=I,a[s+2]=N,a[s+3]=u,s+=l}}(l,u,t,h);break}case t.PROFILERIGHT:case t.PROFILEUP:case t.PROFILEVERTEXANDNORMAL:case t.FEATUREVALUE:{a(4===l.size);const t=p.getField(e,s);a(!!t,`No buffer view for ${e}`),t&&T(l,t,h)}}}class E{constructor(t){this.vertexBufferLayout=t}elementCount(e){return e.attributes.get(t.POSITION).indices.length}write(t,e,n,o,s){L(n,this.vertexBufferLayout,t,e,o,s)}}class w{constructor(t=!1,e=!0){this.isVerticalRay=t,this.normalRequired=e}}const F=y();function z(e,n,o,s,i,f){if(!e.visible)return;const r=l(tt,s,o),c=(t,e,n)=>{f(t,n,e,!1)},u=new w(!1,n.options.normalRequired);if(e.boundingInfo){a(e.type===M.Mesh);const t=n.tolerance;q(e.boundingInfo,o,r,t,i,u,c)}else{const n=e.attributes.get(t.POSITION),s=n.indices;U(o,r,0,s.length/3,s,n.data,n.stride,i,u,c)}}const V=b();function q(t,e,n,o,s,i,f){if(null==t)return;const r=u(V,1/(c=n)[0],1/c[1],1/c[2]);var c;if(g(F,t.bbMin),m(F,t.bbMax),null!=s&&s.applyToAabb(F),Q(F,e,r,o)){const{primitiveIndices:r,position:c}=t,a=r?r.length:c.indices.length/3;if(a>Z){const r=t.getChildren();if(void 0!==r){for(const t of r)q(t,e,n,o,s,i,f);return}}!function(t,e,n,o,s,i,f,r,c,a,l){const u=t[0],d=t[1],p=t[2],h=e[0],b=e[1],y=e[2],{normalRequired:g}=a;for(let t=0;t<o;++t){const e=r[t],n=3*e,o=f*s[n];let a=i[o],m=i[o+1],M=i[o+2];const B=f*s[n+1];let O=i[B],R=i[B+1],T=i[B+2];const v=f*s[n+2];let I=i[v],N=i[v+1],x=i[v+2];null!=c&&([a,m,M]=c.applyToVertex(a,m,M,t),[O,R,T]=c.applyToVertex(O,R,T,t),[I,N,x]=c.applyToVertex(I,N,x,t));const S=O-a,L=R-m,A=T-M,E=I-a,w=N-m,F=x-M,z=b*F-w*y,V=y*E-F*h,q=h*w-E*b,C=S*z+L*V+A*q;if(Math.abs(C)<=_)continue;const k=u-a,P=d-m,U=p-M,$=k*z+P*V+U*q;if(C>0){if($<0||$>C)continue}else if($>0||$<C)continue;const D=P*A-L*U,G=U*S-A*k,H=k*L-S*P,J=h*D+b*G+y*H;if(C>0){if(J<0||$+J>C)continue}else if(J>0||$+J<C)continue;const X=(E*D+w*G+F*H)/C;X>=0&&l(X,e,g?Y(S,L,A,E,w,F,j):null)}}(e,n,0,a,c.indices,c.data,c.stride,r,s,i,f)}}const j=b();function C(t,e,n,o,s,i,f,r,c){const{data:a,stride:u}=i;U(t,l(tt,e,t),n,o,s,a,u,f,r,c)}function k(t,e,n,o,s,i,f,r,c,a=null,l=0){const u=t[0],d=t[1],p=t[2],h=e[0],b=e[1],y=e[2];for(let t=n;t<o;++t){const e=l+(a?a[t]:t),n=3*e,o=f*s[n],g=i[o],m=i[o+1],M=i[o+2],B=f*s[n+1],O=i[B],R=i[B+1],T=i[B+2],v=f*s[n+2],I=O-g,N=R-m,x=T-M,S=i[v]-g,L=i[v+1]-m,A=i[v+2]-M,E=b*A-L*y,w=y*S-A*h,F=h*L-S*b,z=I*E+N*w+x*F;if(Math.abs(z)<=_)continue;const V=u-g,q=d-m,C=p-M,k=V*E+q*w+C*F;if(z>0){if(k<0||k>z)continue}else if(k>0||k<z)continue;const P=q*x-N*C,U=C*I-x*V,$=V*N-I*q,D=h*P+b*U+y*$;if(z>0){if(D<0||k+D>z)continue}else if(D>0||k+D<z)continue;const G=(S*P+L*U+A*$)/z;G>=0&&c(G,e,r?Y(I,N,x,S,L,A,j):null)}}function P(t,e,n,o,s,i,f,r,c,a,l,u=null,d=0){const p=t[0],h=t[1],b=t[2],y=e[0],g=e[1],m=e[2];for(let t=n;t<o;++t){const e=d+(u?u[t]:t),n=3*e,o=f*s[n],M=i[o],B=i[o+1],O=i[o+2],R=f*s[n+1],T=i[R],v=i[R+1],I=i[R+2],N=f*s[n+2],x=i[N],S=i[N+1],L=i[N+2],A=O-c,E=r/Math.sqrt(M*M+B*B+A*A),w=M+M*E,F=B+B*E,z=O+A*E,V=I-c,q=r/Math.sqrt(T*T+v*v+V*V),C=T+T*q,k=v+v*q,P=I+V*q,U=L-c,$=r/Math.sqrt(x*x+S*S+U*U),D=C-w,G=k-F,H=P-z,J=x+x*$-w,X=S+S*$-F,K=L+U*$-z,Q=g*K-X*m,W=m*J-K*y,Z=y*X-J*g,tt=D*Q+G*W+H*Z;if(Math.abs(tt)<=_)continue;const et=p-w,nt=h-F,ot=b-z,st=et*Q+nt*W+ot*Z;if(tt>0){if(st<0||st>tt)continue}else if(st>0||st<tt)continue;const it=nt*H-G*ot,ft=ot*D-H*et,rt=et*G-D*nt,ct=y*it+g*ft+m*rt;if(tt>0){if(ct<0||st+ct>tt)continue}else if(ct>0||st+ct<tt)continue;const at=(J*it+X*ft+K*rt)/tt;at>=0&&l(at,e,a?Y(D,G,H,J,X,K,j):null)}}function U(t,e,n,o,s,i,f,r,c,a){const p=e,h=et,b=Math.abs(p[0]),y=Math.abs(p[1]),g=Math.abs(p[2]),m=b>=y?b>=g?0:2:y>=g?1:2,M=m,B=p[M]<0?2:1,O=(m+B)%3,R=(m+(3-B))%3,T=p[O]/p[M],v=p[R]/p[M],I=1/p[M],N=$,x=D,S=G,{normalRequired:L}=c;for(let e=n;e<o;++e){const n=3*e,o=f*s[n];u(h[0],i[o+0],i[o+1],i[o+2]);const c=f*s[n+1];u(h[1],i[c+0],i[c+1],i[c+2]);const p=f*s[n+2];u(h[2],i[p+0],i[p+1],i[p+2]),r&&(d(h[0],r.applyToVertex(h[0][0],h[0][1],h[0][2],e)),d(h[1],r.applyToVertex(h[1][0],h[1][1],h[1][2],e)),d(h[2],r.applyToVertex(h[2][0],h[2][1],h[2][2],e))),l(N,h[0],t),l(x,h[1],t),l(S,h[2],t);const b=N[O]-T*N[M],y=N[R]-v*N[M],g=x[O]-T*x[M],m=x[R]-v*x[M],B=S[O]-T*S[M],A=S[R]-v*S[M],E=B*m-A*g,w=b*A-y*B,F=g*y-m*b;if((E<0||w<0||F<0)&&(E>0||w>0||F>0))continue;const z=E+w+F;if(0===z)continue;const V=E*(I*N[M])+w*(I*x[M])+F*(I*S[M]);if(V*Math.sign(z)<0)continue;const q=V/z;q>=0&&a(q,e,L?H(h):null)}}const $=b(),D=b(),G=b();function Y(t,e,n,o,s,i,f){return u(J,t,e,n),u(X,o,s,i),p(f,J,X),h(f,f),f}function H(t){return l(J,t[1],t[0]),l(X,t[2],t[0]),p(j,J,X),h(j,j),j}const J=b(),X=b();function K(t,e,n){return u(n,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function Q(t,e,n,o){return W(t,e,n,o,1/0)}function W(t,e,n,o,s){const i=(t[0]-o-e[0])*n[0],f=(t[3]+o-e[0])*n[0];let r=Math.min(i,f),c=Math.max(i,f);const a=(t[1]-o-e[1])*n[1],l=(t[4]+o-e[1])*n[1];if(c=Math.min(c,Math.max(a,l)),c<0)return!1;if(r=Math.max(r,Math.min(a,l)),r>c)return!1;const u=(t[2]-o-e[2])*n[2],d=(t[5]+o-e[2])*n[2];return c=Math.min(c,Math.max(u,d)),!(c<0)&&(r=Math.max(r,Math.min(u,d)),!(r>c)&&r<s)}const Z=1e3,_=1e-7,tt=b(),et=[b(),b(),b()];export{E as D,w as M,A as a,L as b,I as c,N as d,x as e,T as f,v as g,S as h,z as i,C as j,Q as k,W as l,k as m,P as n,K as o,B as w};

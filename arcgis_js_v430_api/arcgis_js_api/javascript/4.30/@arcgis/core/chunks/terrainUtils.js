/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{O as t,Q as n,i,N as r,ag as l}from"./unitUtils.js";import{l as o}from"./layerUtils2.js";import{V as a}from"./ViewingMode.js";import s from"../core/Error.js";import{p as c,c as u,d as f,i as T,b as S}from"./vec3.js";import{c as m}from"./vec3f64.js";import{r as p,s as h,d as E,c as g}from"./aaBoundingRect.js";import{g as O,T as d,m as H}from"./TerrainConst.js";function y(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function _(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function R(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function W(e){return null!=e&&"type"in e&&"image+type"===e.type}var b;function x(e){return I(e)||t(e)||n(e)}function I(e){return i(e)||r(e)}!function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(b||(b={}));const w=m(),N=m(),A=m(),M=m();function U(e,t,n,i){c(w,n),w[i]=t[i];const r=u(w,w,t),l=u(N,e,t),o=f(l,r),a=f(r,r);let s;s=o<=0?t:a<=o?n:T(w,t,S(r,r,o/a));const m=u(w,e,s);return Math.PI/2-Math.atan(m[2]/Math.sqrt(m[0]*m[0]+m[1]*m[1]))}const v=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return O();const r=e.spatialReference;if(r.isGeographic&&!I(r))return new s("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const l=d.checkUnsupported(e);if(null!=l)return l;if(null==n)return new s("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const o=function(e,t){const n=e.lods,i=n[0].resolution*2**n[0].level,r=[i*e.size[0],i*e.size[1]],l=[e.origin.x,e.origin.y],o=E(t),a=g();d.computeRowColExtent(o,r,l,a);const c=(a[2]-a[0])*(a[3]-a[1]);if(c>H){const t=n[0].scale*2**n[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/i;const l=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**l)*10**l,new s("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:c,allowedNumRootTiles:H})}return null}(e,n);return o||(null==t||r.equals(t)||t.isWGS84&&r.isWebMercator?null:new s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))},isInsideExtent:function(e,t,n=0){const i=e.extent;if(null==i)return!1;if(0===n)return p(i,t);const r=Math.min(i[2]-i[0],i[3]-i[1]);return h(i,t,n*r)},tiltToExtentEdge:function(e,t,n){const i=e.extent;if(null==i)return 0;A[0]=i[0],A[1]=i[1],A[2]=n,M[0]=i[2],M[1]=i[3],M[2]=n;let r=1/0,l=1/0;return t[0]<A[0]?r=U(t,A,M,0):t[0]>M[0]&&(r=U(t,M,A,0)),t[1]<A[1]?l=U(t,A,M,1):t[1]>M[1]&&(l=U(t,M,A,1)),Math.min(r,l)}},Symbol.toStringTag,{value:"Module"})),L=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return O();const r=e?.lods.length-1,l=e.spatialReference;if(l.isWebMercator){if(!d.makeWebMercatorAuxiliarySphere(r).compatibleWith(e,i))return new s("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!x(l))return new s("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!d.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e,i))return e.spatialReference.isWGS84?new s("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new s("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),j={[a.Global]:L,[a.Local]:v};function C(e,t){e||console.warn("Terrain: "+t)}let G=!1,k=!1;function z(e){k=e,G=G||e}function V(e){G=e}function F(e,t){if(G&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function q(e){return B(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function P(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function B(e){return"imagery-tile-3d"===e?.type}function D(e){return"tile-3d"===e?.type}function Q(e){return"vector-tile-3d"===e?.type}function J(e){return"wmts-3d"===e?.type}function K(e){return"elevation-3d"===e?.type}function X(e){return"group"===e?.type}function Y(e){return e&&(D(e)||J(e)||B(e)||Q(e))}function Z(e){return e&&(D(e)||B(e)||Q(e)||J(e))}function $(e){return Z(e)||K(e)}function ee(e){return _(e?.sourceLayerInfo?.data)}function te(e){return re(e?.sourceLayerInfo)||!!e?.isVTLBackground}function ne(e){return R(e?.sourceLayerInfo?.data)}function ie(e){const t=e?.sourceLayerInfo?.data;return W(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function re(e){return y(e?.data)}function le(e){return null!=e&&"release"in e&&e.release(),null}function oe(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function ae(e,t,n,i,r){return j[i].checkIfTileInfoSupportedForViewSR(e,n,t,r)}function se(e,t,n){let i=null,r=null;if("wmts"===e?.type){const l=ce(e,t,n);i=l.tileInfo,r=l.fullExtent}else{r=P(e)?e.getCompatibleFullExtent(t):e.fullExtent;const l=n===a.Local;i=P(e)?e.getCompatibleTileInfo(t,r,l):"vector-tile"===e?.type?l&&!ue(t)||fe.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const l="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=i&&null!=r&&null==ae(i,r,t,n,l)?{tileInfo:i,fullExtent:r}:null}function ce(t,n,i){const r=o(t);if(null!=r){if(!e.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const e=r.find((e=>null==ae(e.tileInfo,e.fullExtent,n,i)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function ue(e){return e.isWGS84||e.isWebMercator||r(e)||!l(e)}const fe={force512VTL:!1};function Te(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Se(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function me(e,t,n=We){return Math.abs(e-t)<n}function pe(e){return e===b.NORTH_EAST?b.SOUTH_WEST:e===b.NORTH_WEST?b.SOUTH_EAST:e===b.SOUTH_WEST?b.NORTH_EAST:b.NORTH_WEST}function he(e){return e===b.NORTH?b.SOUTH:e===b.EAST?b.WEST:e===b.SOUTH?b.NORTH:b.EAST}function Ee(e){return e===b.NORTH_WEST||e===b.SOUTH_WEST}function ge(e){return e===b.NORTH_WEST||e===b.NORTH_EAST}function Oe(e){return e===b.NORTH_WEST||e===b.WEST||e===b.SOUTH_WEST}function de(e){return e===b.NORTH_EAST||e===b.EAST||e===b.SOUTH_EAST}function He(e){return e===b.SOUTH_EAST||e===b.SOUTH||e===b.SOUTH_WEST}function ye(e){return e===b.NORTH_EAST||e===b.NORTH||e===b.NORTH_WEST}const _e=[b.NORTH,b.EAST,b.SOUTH,b.WEST],Re=[b.NORTH_EAST,b.SOUTH_EAST,b.SOUTH_WEST,b.NORTH_WEST],We=1e-5;export{Ee as A,ge as B,me as C,Se as D,Te as E,Q as F,te as G,ee as H,ie as I,ne as J,re as K,I as L,x as M,b as N,$ as O,X as P,Z as Q,K as R,V as S,z as T,se as a,P as b,ae as c,F as d,q as e,y as f,ce as g,R as h,W as i,_ as j,Y as k,G as l,he as m,_e as n,pe as o,Re as p,ye as q,le as r,He as s,fe as t,oe as u,ue as v,C as w,Oe as x,de as y,k as z};

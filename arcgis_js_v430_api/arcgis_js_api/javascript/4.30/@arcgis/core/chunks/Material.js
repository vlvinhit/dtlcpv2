/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{f as e}from"./vec3f64.js";import{N as t}from"./interfaces3.js";import{M as a}from"../core/scheduling.js";import{D as r}from"./basicInterfaces.js";import{g as s}from"../core/Accessor.js";import{V as i}from"./VertexAttribute.js";import{E as n}from"../core/lang.js";import{l as c,d as l,c as o}from"./mathUtils.js";import{V as u}from"./ViewingMode.js";class h{constructor(){this.id=s()}}var m;!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Mesh=2]="Mesh",e[e.Line=3]="Line",e[e.Point=4]="Point",e[e.Material=5]="Material",e[e.Texture=6]="Texture",e[e.COUNT=7]="COUNT"}(m||(m={}));class d{constructor(){this.enabled=!0,this._time=a(0)}get time(){return this._time}advance({deltaTime:e,fixedTime:t}){return null!=t?this._time!==t&&(this._time=t,!0):(this._time=a(this._time+e),0!==e)}}class p{constructor(e,t){this.deltaTime=e,this.fixedTime=t}}const f=new Map([[i.POSITION,0],[i.NORMAL,1],[i.NORMALCOMPRESSED,1],[i.UV0,2],[i.COLOR,3],[i.COLORFEATUREATTRIBUTE,3],[i.SIZE,4],[i.TANGENT,4],[i.CENTEROFFSETANDDISTANCE,5],[i.SYMBOLCOLOR,5],[i.FEATUREATTRIBUTE,6],[i.INSTANCEFEATUREATTRIBUTE,6],[i.INSTANCECOLOR,7],[i.OBJECTANDLAYERIDCOLOR,7],[i.INSTANCEOBJECTANDLAYERIDCOLOR,7],[i.INSTANCEMODEL,8],[i.INSTANCEMODELNORMAL,12],[i.INSTANCEMODELORIGINHI,11],[i.INSTANCEMODELORIGINLO,15]]);function O(e,t){return new C(e,M,t)}function v(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:s}=M;return new C(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:T.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:T.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:T.minPixelSize},t)}function _(e,t,a){const r=a.parameters;return E.scale=Math.min(r.divisor/(t-r.offset),1),E.factor=function(e){return Math.abs(e*e*e)}(e),E}function g(e,t){return c(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function A(e,t,a,r){r.scale=function(e,t,a){const r=_(e,t,a);return r.minScaleFactor=0,g(1,r)}(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function F(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}class C{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,a,r={camera:{distance:0,fovY:0},divisor:0,offset:0},s){this._viewingMode=e,this._description=t,this._ellipsoidRadius=a,this.parameters=r,this._fontHeight=s,this._viewingMode===u.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new C(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:s}=this._description,{fovY:i,distance:n}=e,c=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,c),{tiltAngle:o,scaleFallOffFactor:u}=c,h=Math.sin(o)*n,m=.5*Math.PI-o-i*(.5-r*l),d=h/Math.cos(m),p=m+i*s*l,f=(d-u*(h/Math.cos(p)))/(1-u);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=f,a.divisor=d-f,a}_calculateCurvatureDependentParametersLocal(e,t,a=L){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,t,a=L){const r=this._description.curvatureDependent,s=1+e.distance/t,i=Math.sqrt(s*s-1),[n,l]=[r.min.curvature,r.max.curvature],u=o((i-n)/(l-n),0,1),[h,m]=[r.min,r.max];return a.tiltAngle=c(h.tiltAngle,m.tiltAngle,u),a.scaleFallOffFactor=c(h.scaleFallOffFactor,m.scaleFallOffFactor,u),a}_surfaceCoverageCompensationLocal(e,t,a){return(e.fovY-a.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,t,a){const r=t*t,s=a.tiltAngle+.5*Math.PI,{fovY:i,distance:n}=e,c=n*n+r-2*Math.cos(s)*n*t,l=Math.sqrt(c),o=Math.sqrt(c-r);return(Math.acos(o/l)-Math.asin(t/(l/Math.sin(s)))+.5*i)/i}}const M={curvatureDependent:{min:{curvature:l(10),tiltAngle:l(12),scaleFallOffFactor:.5},max:{curvature:l(70),tiltAngle:l(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},T={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},E={scale:0,factor:0,minScaleFactor:0},L={tiltAngle:0,scaleFallOffFactor:0};function N(e,t,a,r,s){let i=(a.screenLength||0)*e.pixelRatio;null!=s&&(i=function(e,t,a,r){return g(e,_(t,a,r))}(i,r,t,s));const n=i*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return o(n*t,a.minWorldLength||0,null!=a.maxWorldLength?a.maxWorldLength:1/0)}function S(e,t){const a=t?S(t):{};for(const t in e){let r=e[t];r?.forEach&&(r=R(r)),null==r&&t in a||(a[t]=r)}return a}function D(e,t){let a=!1;for(const r in t){const s=t[r];void 0!==s&&(Array.isArray(s)?null===e[r]?(e[r]=s.slice(),a=!0):n(e[r],s)&&(a=!0):e[r]!==s&&(a=!0,e[r]=s))}return a}function R(e){const t=[];return e.forEach((e=>t.push(e))),t}const P={multiply:1,ignore:2,replace:3,tint:4};class x extends h{constructor(t,a){super(),this.type=m.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._vertexAttributeLocations=f,this._pp0=e(0,0,1),this._pp1=e(0,0,0),this._parameters=S(t,a),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){D(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bindParameters.decorations===r.ON)&&!!(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){this.repository?.materialChanged(this)}queryRenderOccludedState(e){return this.isVisible()&&this.parameters.renderOccluded===e}intersectDraped(e,t,a,r,s,i){return this._pp0[0]=this._pp1[0]=r[0],this._pp0[1]=this._pp1[1]=r[1],this.intersect(e,t,a,this._pp0,this._pp1,s)}}class b extends p{constructor(e,t,a){super(t,a),this.camera=e}}var I;!function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(I||(I={}));class y extends t{constructor(){super(...arguments),this.renderOccluded=I.Occlude,this.isDecoration=!1}}export{d as A,m as C,f as D,x as M,I as R,b as U,y as a,g as b,F as c,h as d,P as e,v as f,O as g,A as p,D as u,N as v};

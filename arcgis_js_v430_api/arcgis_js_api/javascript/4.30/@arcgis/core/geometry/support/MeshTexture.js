/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../core/lang.js";import{w as e}from"../../chunks/imageUtils.js";import{JSONSupport as r}from"../../core/JSONSupport.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import{b as s}from"../../chunks/ensureType.js";import{r as n}from"../../chunks/reader.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{w as i}from"../../chunks/writer.js";import{a as l,w as c}from"../../chunks/persistableUrlUtils.js";import"../../request.js";import"../../config.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/Error.js";import"../../chunks/Logger.js";import"../../core/promiseUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/maybe.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";var p;const h=new WeakMap;let u=0,m=p=class extends r{constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,r,a){if(t instanceof HTMLImageElement){const s={type:"image-element",src:l(t.src,a),crossOrigin:t.crossOrigin};e[r]=s}else if(t instanceof HTMLCanvasElement){const a={type:"canvas-element",imageData:d(t.getContext("2d").getImageData(0,0,t.width,t.height))};e[r]=a}else if(t instanceof HTMLVideoElement){const s={type:"video-element",src:l(t.src,a),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=s}else if(t instanceof ImageData){const a={type:"image-data",imageData:d(t)};e[r]=a}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=g(t.imageData),r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),r}case"image-data":return g(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return f(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return f(t);if(e){const t=e.substr(e.length-4,4).toLowerCase(),r=e.substr(0,15).toLocaleLowerCase();if(".png"===t||"data:image/png;"===r)return!0}return!1}set transparent(t){this._overrideIfSome("transparent",t)}get contentHash(){const t="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(e="")=>`d:${e},t:${this.transparent},w:${t}`;return null!=this.url?e(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(h.has(this.data)||h.set(this.data,++u),e(h.get(this.data))):e()}get memoryUsage(){let t=0;if(t+=null!=this.url?this.url.length:0,null!=this.data){const e=this.data;"data"in e?t+=e.data.byteLength:e instanceof HTMLImageElement?t+=e.naturalWidth*e.naturalHeight*3:e instanceof HTMLCanvasElement&&(t+=e.width*e.height*3)}return t}clone(){const t={url:this.url,data:this.data,wrap:this._cloneWrap()};return new p(t)}cloneWithDeduplication(t){const e=t.get(this);if(e)return e;const r=this.clone();return t.set(this,r),r}_cloneWrap(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}static from(t){return"string"==typeof t?new p({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new p({data:t}):s(p,t)}};function d(t){let e="";for(let r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}}function g(t){const r=atob(t.data),a=new Uint8ClampedArray(r.length);for(let t=0;t<r.length;t++)a[t]=r.charCodeAt(t);return e(a,t.width,t.height)}function f(t){for(let e=3;e<t.data.length;e+=4)if(255!==t.data[e])return!0;return!1}t([a({type:String,json:{write:c}})],m.prototype,"url",null),t([a({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),a()],m.prototype,"data",null),t([i("data")],m.prototype,"writeData",null),t([n("data")],m.prototype,"readData",null),t([a({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],m.prototype,"transparent",null),t([a({json:{write:!0}})],m.prototype,"wrap",void 0),t([a({readOnly:!0})],m.prototype,"contentHash",null),m=p=t([o("esri.geometry.support.MeshTexture")],m);const w=m;export{w as default};

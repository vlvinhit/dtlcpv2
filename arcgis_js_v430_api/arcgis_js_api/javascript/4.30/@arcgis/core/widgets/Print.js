/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../intl.js";import e from"../core/Collection.js";import{J as o}from"../chunks/jsonMap.js";import{clone as i}from"../core/lang.js";import{watch as s,initial as l}from"../core/reactiveUtils.js";import{u as a}from"../chunks/unitFormatUtils.js";import{r as n,addProxy as r,hasSameOrigin as p}from"../core/urlUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../chunks/Logger.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{g as u}from"../chunks/utils8.js";import{t as d}from"../chunks/layoutTemplate.js";import h,{l as b}from"./Widget.js";import y from"../core/Accessor.js";import g from"./Print/PrintViewModel.js";import{g as j}from"../chunks/globalCss.js";import{H as f}from"../chunks/Heading.js";import{l as _}from"../chunks/legacyIcon.js";import{a as k,i as v}from"../chunks/widgetUtils.js";import{m as w}from"../chunks/messageBundle.js";import{t as T}from"../chunks/jsxFactory.js";import{f as C}from"../chunks/number.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/handleUtils.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../chunks/substitute.js";import"../config.js";import"../chunks/messages.js";import"../core/Error.js";import"../core/promiseUtils.js";import"../chunks/maybe.js";import"../request.js";import"../kernel.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../chunks/ObservableBase.js";import"../core/scheduling.js";import"../chunks/assets.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/asyncUtils.js";import"../chunks/ByteSizeUnit.js";import"../chunks/Cyclical.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/quantityUtils.js";import"../chunks/unitUtils.js";import"../chunks/domUtils.js";import"../core/Promise.js";import"../chunks/uuid.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../geometry/SpatialReference.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Loadable.js";import"../chunks/ReactiveMap.js";import"../chunks/screenUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../rest/geoprocessor.js";import"../rest/geoprocessor/GPOptions.js";import"../rest/support/JobInfo.js";import"../chunks/enumeration.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils9.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../layers/support/MapImage.js";import"../rest/support/ArealUnit.js";import"../chunks/networkEnums.js";import"../rest/support/DataFile.js";import"../rest/support/FeatureSet.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"../chunks/colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../rest/support/LinearUnit.js";import"../rest/support/ParameterValue.js";import"../rest/support/RasterData.js";import"../rest/support/GPMessage.js";import"../rest/print.js";import"../chunks/floorFilterUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../chunks/sizeVariableUtils.js";import"../chunks/layerViewUtils.js";import"../rest/support/PrintTemplate.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../rest/support/PrintParameters.js";import"../chunks/viewpointUtils.js";import"../Viewpoint.js";import"../Camera.js";import"../CameraLayout.js";import"../chunks/mat2d.js";import"../chunks/mat2df64.js";import"../chunks/vec2.js";import"../chunks/vec2f64.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/InputManager.js";import"../chunks/Queue.js";import"../core/signal.js";import"./Print/CustomTemplate.js";import"./Print/TemplateOptions.js";let x=class extends y{constructor(t){super(t),this.state="pending",this.url=""}initialize(){this.addHandles(s((()=>[this.extension,this.name]),(()=>this._setFormattedFileName()),l))}_setFormattedFileName(){this.name&&this.extension&&(this.formattedName=this.count?`${this.name}(${this.count})${this.extension}`:`${this.name}.${this.extension}`)}};t([c()],x.prototype,"count",void 0),t([c()],x.prototype,"error",void 0),t([c()],x.prototype,"extension",void 0),t([c()],x.prototype,"formattedName",void 0),t([c()],x.prototype,"name",void 0),t([c()],x.prototype,"state",void 0),t([c()],x.prototype,"url",void 0),x=t([m("esri.widgets.Print.FileLink")],x);const I=x,O=e.ofType(I),S="MAP_ONLY";var L;!function(t){t.layout="layoutTab",t.mapOnly="mapOnlyTab",t.export="exportTab"}(L||(L={}));const M="esri-print",$=`${M}__advanced-options-button`,E={base:M,headerTitle:`${M}__header-title`,layoutTabList:`${M}__layout-tab-list`,layoutTab:`${M}__layout-tab`,layoutSection:`${M}__layout-section`,mapOnlySection:`${M}__map-only-section`,panelItemsCentered:`${M}__panel-items--centered`,loader:`${M}__loader`,advancedOptionsButton:$,advancedOptionsButtonContainer:`${$}-container`,advancedOptionsButtonTitle:`${$}-title`,advancedOptionsButtonIconOpened:`${$}-icon--opened`,advancedOptionsButtonIconClosed:`${$}-icon--closed`,advancedOptionsButtonIconClosed_RTL:`${$}-icon--closed-rtl`,swapButton:`${M}__swap-button`,printButton:`${M}__export-button`,templateSelectContainer:`${M}__template-select-container`,templateSelectBlock:`${M}__template-select-block`,templateSelectIcon:`${M}__template-select-icon`,formSectionContainer:`${M}__form-section-container`,formCheckboxLabel:`${M}__form-checkbox-label`,advancedOptionsSection:`${M}__advanced-options-section`,advancedOptionsContainer:`${M}__advanced-options-container`,browseTemplateButtonContainer:`${M}__browse-template-button-container`,exportedFilesContainer:`${M}__export-panel-container`,exportedFilesTitle:`${M}__export-title`,exportedFile:`${M}__exported-file`,exportedFileLink:`${M}__exported-file-link`,exportedFileLinkTitle:`${M}__exported-file-link-title`,exportedFilesEmpty:`${M}__exported-files-empty`,printWidgetContainer:`${M}__container`,content:`${M}__content`,panelContainer:`${M}__panel-container`,scaleInfoContainer:`${M}__scale-info-container`,scaleInputContainer:`${M}__scale-input-container`,scaleInput:`${M}__scale-input`,sizeContainer:`${M}__size-container`,panelError:`${M}__panel--error`,exportedFileError:`${M}__exported-file--error`,exportedFileLoader:`${M}__exported-file--loader`,exportSection:`${M}__export-section`,exportSectionCentered:`${M}__export-section--centered`,templateButtonContainer:`${M}__template-button-container`,templateDoneButton:`${M}__template-done-button`,templateSelectFlowItemContainer:`${M}__template-select-flow-item-container`,templateSelectFlowItemContent:`${M}__template-select-flow-item-content`,templateSelectFlowItemListHeading:`${M}__template-select-flow-item-list-heading`};function P(t){return t?.toUpperCase()===S}function F(t){const{state:e,extension:o}=t;switch(e){case"pending":return"spinner";case"error":return"exclamation-mark-circle";default:return o?.toLowerCase()?.includes("pdf")?"file-pdf":"file"}}function U(t,e){return!!e&&t.some((t=>t.layoutItem?.id===e||t.layout===e))}const D=new o({inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers"});let A=class extends h{constructor(t,e){super(t,e),this._activeTabFocusRequested=!1,this._awaitingServerResponse=!1,this._exportedFileNameMap={},this._selectedTab=L.layout,this._pendingExportScroll=!1,this._rootNode=null,this._selectedLayout=null,this._abortController=null,this._showTemplates=!1,this.browseTemplateButtonOnClick=null,this.exportedLinks=new O,this.headingLevel=3,this.messagesCommon=null,this.messagesUnits=null,this.viewModel=new g,this._onInput=t=>{this._selectedTab===L.layout?this.templateOptions.title=t.target.value:this._selectedTab===L.mapOnly&&(this.templateOptions.fileName=t.target.value)},this._removeLink=t=>{const e=t.currentTarget["data-item"];e&&this.exportedLinks.remove(e)},this._handleLinkClick=t=>{const e=t.currentTarget["data-item"];if(!e||"ready"!==e.state||!e.url)return;const o=u(this.viewModel.effectivePrintServiceUrl),i=e.url,s=document.createElement("a");if(s.target="_blank",s.href=i,s.rel="noreferrer",s.download=e.formattedName??"",!o)return s.click(),void t.stopPropagation();t.preventDefault();const l=new URL(i);l.searchParams.set("token",o),s.href=l.href,s.click(),s.href=i},this._focusOnTabChange=this._focusOnTabChange.bind(this)}initialize(){this.addHandles([s((()=>[this.templateOptions.format,this.viewModel.templatesInfo?.format.defaultValue]),(([t,e])=>{if(e&&!t)return void(this.templateOptions.format=e);if(!t||!e||!this.viewModel.templatesInfo)return;if(this.viewModel.templatesInfo.format.choiceList.includes(t))return;const o=this.viewModel.templatesInfo.format.choiceList.find((e=>e.toUpperCase().includes(`(${t.toUpperCase()})`)));this.templateOptions.format=o??e})),s((()=>[this.templateOptions.layout,this.viewModel.templatesInfo?.layout.defaultValue]),(async([t,e])=>{if(this._selectedTab=P(t)?L.mapOnly:L.layout,this._selectedTab!==L.layout)return;const{includeDefaultTemplates:o,viewModel:s,_selectedLayout:l}=this,{portalTemplateIds:a,browseTemplates:n,templatesInfo:r}=s,p=s.defaultTemplates.filter((({layoutItem:t})=>a.includes(t?.id))),c=s.defaultTemplates.filter((({layoutItem:t})=>!a.includes(t?.id))),m=o&&c.length;t?(m?U(c,t):r?.layout.choiceList.includes(t))||U(p,t)||U(n,t)||(this.templateOptions.layout=null,this.templateOptions.layoutItem=null):(l&&((m?U(c,l):r?.layout.choiceList.includes(l))||U(p,l)||U(n,l))?await this._applyTemplate(l):(this.templateOptions.layout=null,this.templateOptions.layoutItem=null),this.templateOptions.layout||m||!e||await this._applyTemplate(e)),this._selectedLayout=this.templateOptions.layout;const u=!!this.templateOptions.layout&&this.viewModel.effectiveTemplateCustomTextElements[this.templateOptions.layout];this.templateOptions.customTextElements=u?i(u):null})),s((()=>this.templateOptions.dpi),(t=>{t<=0&&(this.templateOptions.dpi=1)})),s((()=>this.viewModel.view?.scale),(t=>{!t||this.templateOptions.scaleEnabled&&this.templateOptions.scale||(this.templateOptions.scale=t)}))]);const{height:t,width:e}=this.templateOptions;this.templateOptions.width=e||800,this.templateOptions.height=t||1100;const o=setTimeout((()=>{this._awaitingServerResponse=!0,this.scheduleRender()}),500);this.viewModel.load().then((()=>{clearTimeout(o),this._awaitingServerResponse=!1}))}loadDependencies(){return b({action:()=>import("../chunks/calcite-action.js"),block:()=>import("../chunks/calcite-block.js"),button:()=>import("../chunks/calcite-button.js"),checkbox:()=>import("../chunks/calcite-checkbox.js"),combobox:()=>import("../chunks/calcite-combobox.js"),"combobox-item":()=>import("../chunks/calcite-combobox-item.js"),flow:()=>import("../chunks/calcite-flow.js"),"flow-item":()=>import("../chunks/calcite-flow-item.js"),icon:()=>import("../chunks/calcite-icon.js"),input:()=>import("../chunks/calcite-input.js"),label:()=>import("../chunks/calcite-label.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),loader:()=>import("../chunks/calcite-loader.js"),switch:()=>import("../chunks/calcite-switch.js"),chip:()=>import("../chunks/calcite-chip.js")})}destroy(){this.viewModel.destroy()}get allowedFormats(){return this.viewModel.allowedFormats}set allowedFormats(t){this.viewModel.allowedFormats=t}get allowedLayouts(){return this.viewModel.allowedLayouts}set allowedLayouts(t){this.viewModel.allowedLayouts=t}get error(){return this.viewModel.error}get extraParameters(){return this.viewModel.extraParameters}set extraParameters(t){this.viewModel.extraParameters=t}get icon(){return"print"}set icon(t){this._overrideIfSome("icon",t)}get includeDefaultTemplates(){return this.viewModel.includeDefaultTemplates}set includeDefaultTemplates(t){this.viewModel.includeDefaultTemplates=t}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}get portal(){return this.viewModel.portal}set portal(t){this.viewModel.portal=t}get showPrintAreaEnabled(){return this.viewModel.showPrintAreaEnabled}set showPrintAreaEnabled(t){this.viewModel.showPrintAreaEnabled=t}get printServiceUrl(){return this.viewModel.printServiceUrl}set printServiceUrl(t){this.viewModel.printServiceUrl=t}get templateCustomTextElements(){return this.viewModel.templateCustomTextElements}set templateCustomTextElements(t){this.viewModel.templateCustomTextElements=t}get templateOptions(){return this.viewModel.templateOptions}set templateOptions(t){this.viewModel.templateOptions=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}render(){const{messages:t,templateOptions:e,viewModel:o,view:i}=this,{attributionEnabled:s,author:l,copyright:a,dpi:n,format:r,height:p,layout:c,legendEnabled:m,northArrowEnabled:u,scaleEnabled:h,scale:b,width:y}=e,g="ready"!==o.state||this._awaitingServerResponse||!c,v=this._renderTitleOrFileNameSection(),w=T("div",{class:E.formSectionContainer},T("calcite-label",null,t.fileFormatTitle,T("calcite-combobox",{clearDisabled:!0,label:t.formatDefaultOption,maxItems:6,placeholder:t.formatDefaultOption,selectionMode:"single-persist",onCalciteComboboxChange:({target:t})=>{this.templateOptions.format=t.selectedItems[0].value}},o.templatesInfo?.format?.choiceList.sort().map(((t,e)=>T("calcite-combobox-item",{key:`file-format-${e}`,selected:t===this.templateOptions.format,textLabel:d(t),value:t})))))),C=T("calcite-label",{layout:"inline"},T("calcite-switch",{checked:this.showPrintAreaEnabled,onCalciteSwitchChange:t=>{this.showPrintAreaEnabled=!!t.target.checked}}),t.printPreview),x=T("div",null,T("div",{class:E.formSectionContainer},T("calcite-label",null,t.template,T("div",{class:E.templateSelectContainer,onclick:()=>{this._showTemplates=!0}},T("calcite-block",{class:E.templateSelectBlock,description:this._getPageSizeLabel(c),heading:this._getTemplateLabel()}),T("calcite-icon",{class:E.templateSelectIcon,icon:k()?"chevron-left":"chevron-right",scale:"s"})))),C),I=T("div",{class:E.formSectionContainer},T("calcite-label",null,t.dpi,T("calcite-input",{bind:this,"data-input-name":"dpi",min:1,tabIndex:0,type:"number",value:`${n}`,onCalciteInputInput:this._handleDPIChange}))),O=T("div",{class:this.classes(E.scaleInfoContainer,E.formSectionContainer)},T("calcite-label",{layout:"inline"},T("calcite-checkbox",{bind:this,checked:h,"data-option-name":"scaleEnabled",tabIndex:0,onCalciteCheckboxChange:this._toggleInputValue}),t.scale),T("div",{class:E.scaleInputContainer},T("calcite-input",{"aria-label":t.scaleLabel,"aria-valuenow":`${b}`,bind:this,class:E.scaleInput,"data-input-name":"scale",disabled:!h,tabIndex:0,type:"number",value:`${b}`,onCalciteInputInput:this._updateInputValue}),T("calcite-button",{appearance:"outline","aria-label":t.reset,bind:this,disabled:!h,iconStart:"refresh",kind:"neutral",onclick:this._resetToCurrentScale,tabIndex:0}))),S=T("div",{"aria-labelledby":`${this.id}__advancedOptionsForLayout`,class:E.advancedOptionsContainer,key:"advanced-section-for-layout"},O,this.viewModel.layoutTemplateInfo?.layoutOptions?.hasAuthorText??1?T("div",{class:E.formSectionContainer,key:"author-info"},T("calcite-label",null,t.author,T("calcite-input",{bind:this,"data-input-name":"author",tabIndex:0,value:l??"",onCalciteInputInput:this._updateInputValue}))):null,this.viewModel.layoutTemplateInfo?.layoutOptions?.hasCopyrightText??1?T("div",{class:E.formSectionContainer,key:"copyright-text"},T("calcite-label",null,t.copyright,T("calcite-input",{bind:this,"data-input-name":"copyright",tabIndex:0,value:a??"",onCalciteInputInput:this._updateInputValue}))):null,I,this._renderCustomTextElementSection(),this.viewModel.layoutTemplateInfo?.layoutOptions?.hasLegend??1?T("div",{class:E.formSectionContainer,key:"legend-info"},T("calcite-label",{layout:"inline"},T("calcite-checkbox",{bind:this,checked:m,"data-option-name":"legendEnabled",tabIndex:0,onCalciteCheckboxChange:this._toggleInputValue}),t.legend)):null,this.viewModel.layoutTemplateNorthArrowInfo??1?T("div",{class:E.formSectionContainer,key:"north-arrow"},T("calcite-label",{layout:"inline"},T("calcite-checkbox",{bind:this,checked:u,"data-option-name":"northArrowEnabled",tabIndex:0,onCalciteCheckboxChange:this._toggleInputValue}),t.northArrow)):null),M=T("div",{"aria-labelledby":`${this.id}__advancedOptionsForMapOnly`,class:E.advancedOptionsContainer},O,I,T("div",{class:E.formSectionContainer},T("calcite-label",{layout:"inline"},T("calcite-checkbox",{bind:this,checked:s,"data-option-name":"attributionEnabled",tabIndex:0,onCalciteCheckboxChange:this._toggleInputValue}),t.attribution)),this._renderCustomTextElementSection()),$=this.exportedLinks.toArray(),P=this._renderExportedLink($),F={[E.exportSectionCentered]:!$.length},U=this._selectedTab===L.layout?T("section",{"aria-labelledby":`${this.id}__layoutTab`,class:E.layoutSection,id:`${this.id}__layoutContent`,key:"esri-print__layoutContent",role:"tabpanel"},T("div",{class:E.panelContainer},this.viewModel.layoutTemplateInfo?.layoutOptions?.hasTitleText??1?v:null,x,this._selectedTab===L.layout?w:null,T("calcite-block",{"aria-label":t.advancedOptions,class:this.classes(E.panelContainer,E.advancedOptionsSection),collapsible:!0,disabled:!c,heading:t.advancedOptions,id:"advancedOptionsForLayout",key:"advanced-options-for-layout"},S))):this._selectedTab===L.mapOnly?T("section",{"aria-labelledby":`${this.id}__mapOnlyTab`,class:E.mapOnlySection,id:`${this.id}__mapOnlyContent`,key:"esri-print__mapOnlyContent",role:"tabpanel"},T("div",{class:E.panelContainer},v,w,T("div",null,T("div",{class:this.classes(E.sizeContainer,E.formSectionContainer)},T("calcite-label",null,t.width,T("calcite-input",{bind:this,"data-input-name":"width",tabIndex:0,type:"number",value:`${y}`,onCalciteInputInput:this._updateInputValue})),T("calcite-label",null,t.height,T("calcite-input",{bind:this,"data-input-name":"height",tabIndex:0,type:"number",value:`${p}`,onCalciteInputInput:this._updateInputValue})),T("button",{"aria-label":t.swap,bind:this,class:this.classes(j.widgetButton,E.swapButton,_.swap),onclick:this._switchInput,tabIndex:0,type:"button"})),C),T("calcite-block",{"aria-label":t.advancedOptions,class:this.classes(E.panelContainer,E.advancedOptionsSection),collapsible:!0,heading:t.advancedOptions,id:"advancedOptionsForMapOnly",key:"advanced-options-for-map-only"},M))):T("section",{"aria-labelledby":`${this.id}__exportTab`,class:this.classes(E.exportSection,F),id:`${this.id}__exportContent`,key:"esri-print__exportContent",role:"tabpanel"},T("div",{class:E.panelContainer},T("div",{afterUpdate:this._scrollExportIntoView,bind:this,class:E.exportedFilesContainer},0===$.length?T("div",{class:E.exportedFilesEmpty},T("calcite-icon",{icon:"file",scale:"l"}),T("div",null,T(f,{class:E.exportedFilesTitle,level:this.headingLevel},t.noExportedFiles),T("div",null,t.exportHint))):P))),D={[j.buttonDisabled]:g||!c&&!r},A=!i||"2d"!==i.type,B=T("div",{class:E.panelError},A?t.sceneViewError:t.serviceError),V=$.some((({state:t})=>"pending"===t)),R=T("div",{class:E.content,key:"panel"},T("div",null,T("ul",{bind:this,class:E.layoutTabList,onclick:this._toggleLayoutPanel,onkeydown:this._handleLayoutPanelKeyDown,role:"tablist"},T("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===L.layout}`,class:E.layoutTab,"data-tab-id":L.layout,id:`${this.id}__layoutTab`,role:"tab",tabIndex:0},t.layoutTab),T("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===L.mapOnly}`,class:E.layoutTab,"data-tab-id":L.mapOnly,id:`${this.id}__mapOnlyTab`,role:"tab",tabIndex:0},t.mapOnlyTab),T("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,"aria-selected":`${this._selectedTab===L.export}`,class:E.layoutTab,"data-tab-id":L.export,id:`${this.id}__exportedFilesTab`,role:"tab",tabIndex:0},V?T("calcite-loader",{inline:!0,label:"loading",scale:"s"}):null,t.exportsTab)),U),this._selectedTab!==L.export?T("button",{"aria-label":t.exportDescription,bind:this,class:this.classes(E.printButton,j.button,D),disabled:g,onclick:this._handlePrintMap,tabIndex:0,type:"button"},t.export):null),N=T("calcite-flow",{key:"root-flow"},T("calcite-flow-item",{bind:this,key:"root-flow-item"},T("div",{class:E.printWidgetContainer},T("header",{class:E.headerTitle},t.export),this.error||A||!i?B:R)),this._renderChooseTemplateFlowItem()),z="initializing"===o.state,H=z?this._renderLoader():N,W={[E.panelItemsCentered]:z};return T("div",{bind:this,class:this.classes(E.base,j.widget,j.panel,W)},H)}_getPageSizeLabel(t){if(!t)return;const e=this.viewModel.getLayoutTemplateInfo(t);if(!e)return;const o=D.fromJSON(e.pageUnits.toLowerCase());return`${C(e.pageSize[0])} x ${C(e.pageSize[1])} ${a(this.messagesUnits,o,"abbr")}`}_getTemplateLabel(){const{messages:t,includeDefaultTemplates:e,templateOptions:o,viewModel:i}=this,{layout:s}=o,l=s?(e?i.defaultTemplates.find((({layoutItem:t,layout:e})=>s===t?.id||s===e)):null)??i.browseTemplates.find((({layoutItem:t})=>s===t?.id)):null;return l?.label?.replaceAll("_"," ")??t[s]??s?.replaceAll("_"," ")??t.selectTemplate}_renderChooseTemplateFlowItem(){if(!this._showTemplates)return null;const{includeDefaultTemplates:t,messages:e,viewModel:o}=this,{defaultTemplates:i,templatesInfo:s,browseTemplates:l,portalTemplateIds:a}=o,r=n.test(this.portal?.url),p=l.length?l.toArray().sort(((t,e)=>(t.label??"")>(e.label??"")?1:-1)).map(((t,i)=>{const s=t.layoutItem?.id??t.layout,l=this._getPageSizeLabel(s),a=s===this.templateOptions.layout;return T("calcite-list-item",{description:l,key:`browse-template-${i}`,label:t?.label?.replaceAll("_"," ")??e.untitled,selected:a,title:t.description??"",value:s},!l&&a&&t.layoutItem?.id?T("calcite-loader",{inline:!0,key:`browse-template-loader-${i}`,label:"loading",scale:"s",slot:"content-end"}):null,T("calcite-action",{icon:"trash",onclick:()=>o.removePortalTemplate(t),slot:"actions-end",text:"delete"}))})):null,c=i.length&&t?i.toArray().filter((({label:t,layoutItem:e})=>!P(t)&&a.includes(e?.id))).map(((t,o)=>{const i=t.layoutItem?.id??t.layout,s=this._getPageSizeLabel(i),l=i===this.templateOptions.layout;return T("calcite-list-item",{description:s,key:`portal-template-${i}-${l}`,label:t?.label?.replaceAll("_"," ")??e.untitled,selected:l,title:t.description??"",value:i},!s&&l&&t.layoutItem?.id?T("calcite-loader",{inline:!0,key:`portal-template-loader-${o}`,label:"loading",scale:"s",slot:"content-end"}):null)})):null,m=i.length&&t?i.toArray().filter((({label:t,layoutItem:e})=>!P(t)&&!a.includes(e?.id))).sort(((t,e)=>(t.label??"")>(e.label??"")?1:-1)).map(((t,o)=>{const i=t.layoutItem?.id??t.layout,s=this._getPageSizeLabel(i),l=i===this.templateOptions.layout;return T("calcite-list-item",{description:s,key:`default-template-${o}`,label:t?.label?.replaceAll("_"," ")??e.untitled,selected:l,title:t.description??"",value:i},!s&&l&&t.layoutItem?.id?T("calcite-loader",{inline:!0,key:`default-template-loader-${o}`,label:"loading",scale:"s",slot:"content-end"}):null)})):null,u=!s?.layout?.choiceList.length||t&&m?.length?null:s.layout.choiceList.map((t=>({label:e[t]??t.replaceAll("_"," "),value:t}))).sort(((t,e)=>t.label>e.label?1:0)).map((({label:t,value:e},o)=>T("calcite-list-item",{description:this._getPageSizeLabel(e),key:`service-template-${o}`,label:t,selected:e===this.templateOptions.layout,value:e}))),d=(p?.length??0)+(c?.length??0)+(m?.length??0)+(u?.length??0)>15;return T("calcite-flow-item",{bind:this,closable:!1,heading:e.chooseTemplate,key:"template-flow-item",onCalciteFlowItemBack:t=>{t.preventDefault(),this._showTemplates=!1}},T("div",{class:E.templateSelectFlowItemContainer},T("div",{class:E.templateSelectFlowItemContent},this.browseTemplateButtonOnClick?T("calcite-button",{appearance:"outline",class:E.browseTemplateButtonContainer,key:"browse-template-button",onclick:this.browseTemplateButtonOnClick},"Browse Templates"):null,T("calcite-list",{filterEnabled:d,key:"template-list",selectionMode:"single-persist",onCalciteListChange:({target:t})=>this._applyTemplate(t.selectedItems[0].value)},p?.length?T("div",{key:"my-templates"},T("div",{class:E.templateSelectFlowItemListHeading},e.myTemplates,T("calcite-chip",{appearance:"outline",kind:"neutral",scale:"s",value:e.beta},e.beta)),p):null,c?.length?T("div",{key:"org-templates"},T("div",{class:E.templateSelectFlowItemListHeading},e.organizationTemplates,r?T("calcite-chip",{appearance:"outline",kind:"neutral",scale:"s",value:e.beta},e.beta):null),c):null,p?.length||c?.length?m?.length?T("div",{key:"default-templates"},T("div",{class:E.templateSelectFlowItemListHeading},e.defaultTemplates),m):null:m,p?.length||c?.length?u?.length?T("div",{key:"service-templates"},T("div",{class:E.templateSelectFlowItemListHeading},e.defaultTemplates),u):null:u)),T("div",{class:E.templateButtonContainer},T("calcite-button",{class:E.templateDoneButton,onclick:()=>this._showTemplates=!1},this.messagesCommon.done))))}_renderCustomTextElementSection(){const{customTextElements:t}=this.templateOptions;return t?T("div",{class:E.formSectionContainer,key:"custom-text-elements"},t.map(((t,e)=>{const[o,i]=Object.entries(t)[0];return"date"===o?null:T("calcite-label",{key:`custom-text-elements-${o}-${e}`},o,T("calcite-input",{bind:this,"data-input-custom":!0,"data-input-name":o,value:i??"",onCalciteInputInput:this._updateInputValue}))}))):null}async _applyTemplate(t){if(this._abortController&&(this._abortController.abort(),this._abortController=null),!t)return;const e=this.viewModel.defaultTemplates.find((({layoutItem:e})=>t===e?.id))??this.viewModel.browseTemplates.find((({layoutItem:e})=>t===e?.id));if(!e)return this.templateOptions.layout=t,void(this.templateOptions.layoutItem=null);const{layoutItem:o}=e,s=e.format??this.templateOptions.format,l=o?.id??e.layout??this.templateOptions.layout;if(this.templateOptions.layout=l,!e.layoutOptions)try{this._abortController=new AbortController,await this.viewModel.fetchLayoutTemplateInfo(e,{signal:this._abortController.signal})}catch(t){return}finally{this._abortController=null}const a=e.layoutOptions?.legend??this.templateOptions.legendEnabled,n=e.layoutOptions?.northArrow??this.templateOptions.northArrowEnabled,r=l?this.viewModel.effectiveTemplateCustomTextElements[l]:null,p=r?i(r):null;this.templateOptions.set({customTextElements:p,format:s,layout:l,layoutItem:o,legendEnabled:a,northArrowEnabled:n})}_renderTitleOrFileNameSection(){const{title:t,fileName:e,titlePlaceHolder:o,fileNamePlaceHolder:i}=this.messages,s=this._selectedTab===L.layout?t:e,l=this._selectedTab===L.layout?o:i,a=this._selectedTab===L.layout?this.templateOptions.title:this.templateOptions.fileName;return T("div",{class:E.formSectionContainer,key:s},T("calcite-label",null,s,T("calcite-input",{placeholder:l,value:a??"",onCalciteInputInput:this._onInput})))}_focusOnTabChange(t){if(!this._activeTabFocusRequested)return;const e=t.getAttribute("data-tab-id");("layoutTab"===e&&this._selectedTab===L.layout||"mapOnlyTab"===e&&this._selectedTab===L.mapOnly||"exportTab"===e&&this._selectedTab===L.export)&&(t.focus(),this._activeTabFocusRequested=!1)}_renderLoader(){const t={[E.loader]:this._awaitingServerResponse};return T("div",{class:this.classes(t),key:"loader"})}_createFileLink(t,e){const o=e||this.messages.untitled,i=t.format.toLowerCase(),s=i.includes("png")?"png":i,l=o+s;return void 0!==this._exportedFileNameMap[l]?this._exportedFileNameMap[l]++:this._exportedFileNameMap[l]=0,new I({name:o,extension:s,count:this._exportedFileNameMap[l]})}_resetToCurrentScale(){this.templateOptions.scale=this.viewModel.view?.scale}_updateCustomTextElementValue(t,e,o){t.find((t=>{const[o]=Object.entries(t)[0];return o===e}))[e]=o}_updateInputValue(t){const e=t.target,o=e.getAttribute("data-input-name"),i=!!e["data-input-custom"],{templateOptions:s}=this;if(i)return void this._updateCustomTextElementValue(s.customTextElements,o,e.value);let l;if("number"===e.type){const t=Number(e.value);if(!function(t){return!isNaN(t)&&t>0}(t)){const t=s[o];return void(e.value=`${t}`)}l=t}else l=e.value;s[o]=l}_handleDPIChange(t){const{templateOptions:e}=this,o=e.dpi;this._updateInputValue(t);const i=e.dpi,{height:s,width:l}=function(t,e,o,i){const s=o/e,l=i/e;return{width:Math.round(t*s),height:Math.round(t*l)}}(i,o,e.width,e.height);e.height=s,e.width=l}_handlePrintMap(){this._pendingExportScroll=!0;const{templateOptions:t}=this,e=this.viewModel.toPrintTemplate(t),o=this._selectedTab===L.layout?e.layoutOptions?.titleText:t.fileName,i=this._createFileLink(e,o);this.exportedLinks.add(i),this.emit("submit",{link:i}),this._selectedTab=L.export,this.viewModel.print(e).then((t=>{i.set({url:t&&t.url,state:"ready"})})).catch((t=>{i.set({error:t,state:"error"})})).then((()=>{this.emit("complete",{link:i}),this.scheduleRender()}))}_switchInput(){[this.templateOptions.width,this.templateOptions.height]=[this.templateOptions.height,this.templateOptions.width]}_scrollExportIntoView(){if(!this._pendingExportScroll)return;this._pendingExportScroll=!1;const t=this._rootNode;if(!t)return;const{clientHeight:e,scrollHeight:o}=t,i=o-e;i>0&&(t.scrollTop=i)}_toggleInputValue(t){const e=t.target,o=e.getAttribute("data-option-name");this.templateOptions[o]=e.checked,"scaleEnabled"===o&&this._resetToCurrentScale()}_renderExportedLink(t){const e=this.messages,o=t.map((t=>{const{error:o,url:i,state:s}=t,l=t.formattedName??"",a="error"===s,n="pending"===s,c="ready"===s;let m=i||null;m&&(m=r(m));const u=p(i,location.href);let d;d=n?e.pending:c?e.ready:e.errorMessage;const h=a?"print-task:cim-symbol-unsupported"===o?.name?e.exportWebMapCIMError:e.exportWebMapError:"";return T("calcite-list-item",{"aria-label":d,class:E.exportedFile,"data-item":t,description:n?e.generatingExport:h||(u?e.ready:e.linkReady),key:l,label:l,title:h,onCalciteListItemSelect:this._handleLinkClick},n?T("calcite-loader",{class:E.exportedFileLoader,inline:!0,key:`${l}-loader`,label:e.generatingExport,scale:"m",slot:"content-start"}):T("calcite-icon",{icon:F(t),key:`${l}-start-icon`,scale:"s",slot:"content-start"}),c?T("calcite-icon",{"aria-label":`${l}. ${e.linkReady}`,icon:u?"download-to":"launch",key:`${l}-end-icon`,scale:"s",slot:"content-end"}):null,n?null:T("calcite-action",{"aria-label":`${h}`,"data-item":t,icon:"x",key:`${l}-action`,onclick:this._removeLink,slot:"actions-end",text:`${h}`}))}));return T("calcite-list",{filterEnabled:t?.length>10},o)}_toggleLayoutPanel(t){const e=t.target;this._toggleTab(e.getAttribute("data-tab-id"))}_toggleTab(t,e=!0){if(this._selectedTab=t,this._selectedTab===L.mapOnly)this.templateOptions.layout=S,this.templateOptions.layoutItem=null,this.templateOptions.customTextElements=null;else if(this._selectedTab===L.layout){const t=this._selectedLayout??(this.includeDefaultTemplates&&this.viewModel.defaultTemplates.length?null:this.viewModel.templatesInfo?.layout?.defaultValue);t?this._applyTemplate(t):(this.templateOptions.layout=null,this.templateOptions.layoutItem=null,this.templateOptions.customTextElements=null)}e&&(this._activeTabFocusRequested=!0)}_handleLayoutPanelKeyDown(t){const{key:e}=t,o=t.target.getAttribute("data-tab-id");if(v(e))return this._toggleTab(o),t.preventDefault(),void t.stopPropagation();if("ArrowLeft"===e||"ArrowRight"===e){switch(o){case L.layout:this._toggleTab("ArrowLeft"===e?L.export:L.mapOnly);break;case L.mapOnly:this._toggleTab("ArrowLeft"===e?L.layout:L.export);break;case L.export:this._toggleTab("ArrowLeft"===e?L.mapOnly:L.layout)}t.preventDefault(),t.stopPropagation()}}};t([c()],A.prototype,"_showTemplates",void 0),t([c()],A.prototype,"allowedFormats",null),t([c()],A.prototype,"allowedLayouts",null),t([c()],A.prototype,"browseTemplateButtonOnClick",void 0),t([c()],A.prototype,"error",null),t([c({type:O})],A.prototype,"exportedLinks",void 0),t([c()],A.prototype,"extraParameters",null),t([c()],A.prototype,"headingLevel",void 0),t([c()],A.prototype,"icon",null),t([c()],A.prototype,"includeDefaultTemplates",null),t([c()],A.prototype,"label",null),t([c(),w("esri/widgets/Print/t9n/Print")],A.prototype,"messages",void 0),t([c(),w("esri/t9n/common")],A.prototype,"messagesCommon",void 0),t([c(),w("esri/core/t9n/Units")],A.prototype,"messagesUnits",void 0),t([c()],A.prototype,"portal",null),t([c()],A.prototype,"showPrintAreaEnabled",null),t([c()],A.prototype,"printServiceUrl",null),t([c()],A.prototype,"templateCustomTextElements",null),t([c()],A.prototype,"templateOptions",null),t([c()],A.prototype,"view",null),t([c({type:g})],A.prototype,"viewModel",void 0),A=t([m("esri.widgets.Print")],A);const B=A;export{B as default};

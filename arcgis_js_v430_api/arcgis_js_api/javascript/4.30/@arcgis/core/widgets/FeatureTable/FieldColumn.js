/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{L as t}from"../../chunks/Logger.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{c as o}from"../../chunks/date.js";import{c as s,f as r}from"../../chunks/number.js";import a,{C as l}from"../../layers/support/CodedValueDomain.js";import{i as u}from"../../chunks/editableLayers.js";import{isNumericField as p,j as m,a as c,validateFieldValue as d,h,k as f,m as y,n as g,isStringField as j,isTimeOnlyField as v,isDateOnlyField as F,isTimestampOffsetField as _,p as k,o as b}from"../../layers/support/fieldUtils.js";import{i as D}from"../../chunks/utils2.js";import C from"../FeatureForm/FieldInput.js";import I from"./Grid/EditorColumn.js";import{r as E}from"../../chunks/widgetUtils.js";import"../../config.js";import"../../chunks/ensureType.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../core/Error.js";import"../../chunks/tracking.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/enumeration.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../layers/support/Domain.js";import"../../layers/catalog/catalogUtils.js";import"../../core/reactiveUtils.js";import"../../chunks/asyncUtils.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/layerUtils2.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../request.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/assets.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/collectionUtils.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/loadAll.js";import"../../portal/Portal.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/persistableUrlUtils.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils3.js";import"../../chunks/colorUtils.js";import"../../chunks/screenUtils.js";import"../../chunks/mat4.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/featureUtils.js";import"../FeatureForm/EditableInput.js";import"../../chunks/featureFormUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/formUtils.js";import"../FeatureForm/InputBase.js";import"./Grid/Column.js";import"../../chunks/uriUtils.js";const U="esri-column",x={input:`${U}__cell-input`,inputContainer:`${U}__cell__input-container`},w=o("short-date-short-time"),V=o("short-date"),L={useGrouping:!0,maximumFractionDigits:20};let O=class extends I{constructor(e){super(e),this._activeFieldInput=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{const{formatFunction:i}=this;if(i&&e){const{index:n,item:{feature:o}}=e;return i({column:this,feature:o,field:this.field,index:n,value:E.sanitize(t)})}if(null===t)return"&nbsp;";const{field:n}=this,o=this._getDomainForFeature(e?.item?.feature);if(o){const e=this._getComputedDomain(t,o);if("date"===n.type&&"range"===o.type)return this._formatDateValueForDisplay(n,e);if(p(n)&&"range"===o.type){const e=this.template?.format,i=e?s(e):L;return r(parseFloat(t),i)}return m.has(n.type)?"range"===o.type?E.sanitize(c(n,e)):E.sanitize(e):e}if("date"===n.type||m.has(n.type))return this._formatDateValueForDisplay(n,t);if(p(n)){const e=this.template?.format,i=e?s(e):L;return r(parseFloat(t),i)}return E.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:i})=>{const{field:n}=this;if(this.effectiveRequired&&(null==i||""===i))return!1;if(p(n)&&d(n,i))return t.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1;if(this._isAnyDateOrTimeField){const e=n.type,t=this._effectiveRange;if(!h({type:e,range:t,value:i}))return!1}return e!==i},this.expressionInfos=null,this.field=null,this.formatFunction=null,this.inputRenderFunction=({root:e,column:i,rowData:n})=>{if(this.editInfo||!this.effectiveEditable)return;const o=this.getCellValue(i,n),{field:s}=this;if("big-integer"===s.type&&d(s,o))return void t.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");const r=n?.item.feature;if(!r)return;this._activeFieldInput=this._setUpFieldInput(r,o);const a=document.createElement("div");a.classList.add(x.inputContainer);const l=[],u="coded-value"===this._effectiveDomain?.type;if(this._isAnyDateOrTimeField&&!u){const e=document.createElement("div"),t=this._setUpDateComponents(o),i=this._setUpDateActionBar();t.forEach((t=>e.appendChild(t))),a.appendChild(e),a.appendChild(i),l.push(...t)}else{const t=this.createInputElement({root:e,column:i,rowData:n,value:o});a.appendChild(t),l.push(t)}this._set("editInfo",{column:i,inputs:l,root:e,rowData:n,oldValue:o}),this.removeCellContent(e),e.appendChild(a),this._syncRowEditingState(e,!0),this.grid?.generateCellPartNames();const p=l[0];p&&(p.focus(),p instanceof HTMLInputElement&&p.select())},this.layer=null,this.parseInputValueFunction=({inputs:e})=>{const{editInfo:t,field:i,includeTime:n}=this;if(!t||!e.length)return null;const o=e[0];if(this._isAnyDateOrTimeField){const s=t.oldValue??void 0;if("coded-value"===this._effectiveDomain?.type)return null!=o.value?parseFloat(o.value):null;switch(i.type){case"date-only":{const e=o.value;return""!==e?e:null}case"time-only":{const e=g(o.value);return""!==e?e:null}case"timestamp-offset":{const t=n?e[1]:void 0,i=e.at(-1);return y({oldValue:s,dateComponent:o,timeComponent:t,timeZoneComponent:i,defaultTimeZone:this.timeZone})}case"date":{const{max:t,min:i}=this._effectiveRange;return f({oldValue:s,dateComponent:o,timeComponent:e[1],timeZone:this.timeZone??void 0,max:t,min:i})}}return null}const s=o.value,{effectiveRequired:r}=this;return r||""!==s?p(i)?parseFloat(s):j(i)?s.trim():s:null},this.sortable=!0,this.store=null,this.template=null,this.updateRowItemFunction=({rowData:e,column:t,value:i})=>{e&&t.path&&(e.item.feature.attributes[t.path]=i)},this.updateStoreItemFunction=async({rowData:e,column:t,value:i})=>{if(!e||!this.store||!t.path)return;const n=e.item.objectId,o=this.store.getItemIndexByObjectId(n),s=o>-1?o:e.index;await this.store.updateItem({index:s,name:t.path,value:i})}}get _effectiveDomain(){const e=this._activeFieldInput?.feature;return e?this._getDomainForFeature(e):null}get _effectiveRange(){return this._activeFieldInput?.range??{max:null,min:null}}get _isAnyDateOrTimeField(){const{field:e}=this;return D(e)||v(e)}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.field?.description??null}get effectiveEditable(){const{editable:e,field:t,layer:i,tableEditingEnabled:n}=this;if(null==t||null==i)return!1;const o=u(i),s=i.effectiveCapabilities??i.capabilities,r=s?.operations?.supportsUpdate;return!!(t.editable&&o&&r&&"oid"!==t.type&&n)&&e}get effectiveLabel(){return E.sanitize(this.label||this.alias||this.fieldName)}get effectiveRequired(){return!this.nullable||this._activeFieldInput?.required||this.required}get includeTime(){const{field:e,template:t}=this;return"time-only"===e.type||"date-only"!==e.type&&(!t?.input||"includeTime"in t.input&&!1!==t.input.includeTime)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:e,template:t}=this,i=e?.length??-1,n=t?.input&&"maxLength"in t.input?t.input.maxLength:null;return null!=n&&!isNaN(n)&&n>=-1&&(-1===i||n<=i)?n:i}get minLength(){const{template:e,maxLength:t}=this,i=e?.input&&"minLength"in e.input?e.input.minLength:null;return t&&i<=t?i:null}get name(){return this.field?.name}get nullable(){return!1!==this.field.nullable}createInputElement({value:e}){const{_effectiveDomain:t,field:i,maxLength:n,minLength:o,effectiveRequired:s}=this;let r;"coded-value"===t?.type?(r=this._createSelectElement(e,t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),s),r.onchange=()=>{r.onblur=null,l()}):(r=document.createElement("input"),r.type=p(i)?"number":"text",n>-1&&(r.maxLength=n),o>0&&(r.minLength=o)),r.classList.add(x.input),r.value=e,r.required=s;let a=!1;r.onkeydown=e=>{a="Escape"===e.key},r.onblur=()=>{r.onblur=null,l()};const l=()=>{a?this.cancel():this.submit()};return r}getCellValue({path:e},t){return e&&t?.item?.feature?.attributes?t.item.feature.attributes?.[e]:null}onEditComplete(){const e=this.editInfo?.root;e&&this._syncRowEditingState(e,!1),this._activeFieldInput=null,super.onEditComplete()}_clearActiveEditValues(){this.editInfo?.inputs?.forEach((e=>e.value=""))}_setUpDateActionBar(){const{messagesCommon:e}=this,t=e?.cancel??"",i=e?.clear??"",n=e?.save??"",o=document.createElement("calcite-action-bar");return o.expandDisabled=!0,o.layout="horizontal",o.appendChild(this.createCalciteAction({text:n,icon:"save",onclick:()=>this.submit()})),this.effectiveRequired||o.appendChild(this.createCalciteAction({text:i,icon:"trash",onclick:()=>{this._clearActiveEditValues(),this.submit()}})),o.appendChild(this.createCalciteAction({text:t,icon:"x",onclick:()=>this.cancel()})),o}_formatDateValueForDisplay(e,t){const{timeZone:i,timeZoneName:n}=this;return null!=t?c(e,t,{...this._getDateFormatOptions(),timeZone:i??void 0,timeZoneName:n??void 0}):null}_setUpDateComponents(e){const{_effectiveRange:{max:t,min:i,rawMax:n,rawMin:o},field:s,effectiveRequired:r}=this,a=this._getDateFieldValuesForComponents(s,e),l=[];if(D(s)){const e=this.createDateComponent(),u=F(s)||_(s)?n:t,p=F(s)||_(s)?o:i,m=this._getDateFieldValuesForComponents(s,u??null),c=this._getDateFieldValuesForComponents(s,p??null);e.value=a.date??"",e.max=m.date??"",e.min=c.date??"",e.required=r,e.addEventListener("calciteInputDatePickerOpen",(()=>this._onDateComponentOpen(e))),l.push(e)}if(this.includeTime){const e=this.createTimeComponent();e.value=a.time??"",e.required=r,e.addEventListener("calciteInputTimePickerOpen",(()=>this._onDateComponentOpen(e))),l.push(e)}if("timestamp-offset"===s.type){const e=this.createTimeZoneComponent();e.value=a.timeZoneOffset??"0",e.addEventListener("calciteInputTimeZoneOpen",(()=>this._onDateComponentOpen(e))),l.push(e)}return l}_onDateComponentOpen(e){this.editInfo?.inputs.forEach((t=>{t!==e&&"open"in t&&(t.open=!1)}))}_syncRowEditingState(e,t=!1){const i=this.grid?.getRowContainingNode(e);i&&(t?i.setAttribute("editing","true"):i.removeAttribute("editing"))}_getDateFieldValuesForComponents(e,t){switch(e.type){case"date":return b(t,this.timeZone??void 0);case"date-only":return{date:t};case"time-only":return{time:t};case"timestamp-offset":return k(t);default:return{}}}_createSelectElement(e,t,i=!1){let n=!1;const o=t.map((t=>{t.value===e&&(n=!0);const i=document.createElement("option");return i.text=t.name,i.value=t.value,i}));if(null!=e&&""!==e&&!n){const t=document.createElement("option");t.text=e,t.value=e,o.unshift(t)}if(!i&&null==e){const e=document.createElement("option");e.value="",o.unshift(e)}const s=document.createElement("select");return o.forEach((e=>s.add(e))),s.value=e,s}_setUpFieldInput(e,t){const{field:i,layer:n,timeZone:o}=this,s=new C({feature:e,field:i,initialFeature:e.clone(),layer:n,timeZone:o});return s.set("value",t),s}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const i=typeof e.codedValues[0].code;if("string"===i&&j(t)||"number"===i&&p(t))return!0}return!(!e||"range"!==e.type||!p(t))}_getDomainForFeature(e){const{layer:t,name:i,template:n}=this;if(!e||!t?.getFieldDomain)return null;if("wfs"===t.type||"geojson"===t.type||"csv"===t.type||"knowledge-graph-sublayer"===t.type)return null;if(n?.domain&&this._isDomainCompatible(n.domain))return n.domain;const{typeIdField:o}=t,s=o===i,r=this.field.domain;return s&&!r?new a({name:"__internal-type-based-coded-value-domain__",codedValues:t.types?.map((({id:e,name:t})=>new l({code:e,name:t})))}):o&&null!=i&&t.getFieldDomain(i,{feature:e})||r}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const i=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return i&&i.length?i[0].name:e}return null}_getDateFormatOptions(){const{template:e}=this,t=e?.format?.dateFormat;return t?o(t):e?.input&&"includeTime"in e.input&&!1===e.input.includeTime?V:w}};e([i()],O.prototype,"_effectiveDomain",null),e([i()],O.prototype,"_activeFieldInput",void 0),e([i()],O.prototype,"_effectiveRange",null),e([i()],O.prototype,"_isAnyDateOrTimeField",null),e([i({readOnly:!0})],O.prototype,"alias",null),e([i()],O.prototype,"cellValueFormatFunction",void 0),e([i()],O.prototype,"cellValueValidatorFunction",void 0),e([i({readOnly:!0})],O.prototype,"defaultValue",null),e([i({readOnly:!0})],O.prototype,"description",null),e([i()],O.prototype,"effectiveEditable",null),e([i()],O.prototype,"effectiveLabel",null),e([i()],O.prototype,"effectiveRequired",null),e([i()],O.prototype,"expressionInfos",void 0),e([i()],O.prototype,"field",void 0),e([i()],O.prototype,"formatFunction",void 0),e([i()],O.prototype,"includeTime",null),e([i()],O.prototype,"inputRenderFunction",void 0),e([i()],O.prototype,"layer",void 0),e([i({readOnly:!0})],O.prototype,"loadingMessage",null),e([i()],O.prototype,"maxLength",null),e([i()],O.prototype,"minLength",null),e([i({readOnly:!0})],O.prototype,"name",null),e([i({readOnly:!0})],O.prototype,"nullable",null),e([i()],O.prototype,"parseInputValueFunction",void 0),e([i()],O.prototype,"sortable",void 0),e([i()],O.prototype,"store",void 0),e([i()],O.prototype,"template",void 0),e([i()],O.prototype,"updateRowItemFunction",void 0),e([i()],O.prototype,"updateStoreItemFunction",void 0),O=e([n("esri.widgets.FeatureTable.FieldColumn")],O);const R=O;export{R as default};

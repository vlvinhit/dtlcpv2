/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{clone as t}from"../core/lang.js";import{watch as i,whenOnce as s,initial as o,syncAndInitial as r}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../chunks/Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{f as a}from"../chunks/date.js";import c from"../Color.js";import"../geometry.js";import p from"../Viewpoint.js";import m from"../core/Accessor.js";import d from"../core/Evented.js";import{EsriPromiseMixin as u}from"../core/Promise.js";import h from"../layers/support/ExtentAndRotationGeoreference.js";import{M as k}from"../chunks/MediaElementView.js";import j from"../layers/support/VideoElement.js";import{DOMContainer as g}from"../views/DOMContainer.js";import{l as y}from"../chunks/viewpointUtils.js";import{V as v}from"../chunks/ViewStateManager.js";import{O as f}from"../chunks/Overlay.js";import{O as w}from"../chunks/OverlayContainer.js";import b from"../geometry/SpatialReference.js";import _ from"../geometry/Extent.js";import M from"./Slider.js";import S,{l as C}from"./Widget.js";import{g as V}from"../chunks/globalCss.js";import"../chunks/widgetUtils.js";import{t as x}from"../chunks/jsxFactory.js";import O from"./VideoPlayer/VideoPlayerViewModel.js";import"../chunks/asyncUtils.js";import"../chunks/maybe.js";import"../core/promiseUtils.js";import"../chunks/handleUtils.js";import"../core/Error.js";import"../config.js";import"../core/Collection.js";import"../core/scheduling.js";import"../chunks/ensureType.js";import"../chunks/tracking.js";import"../chunks/utils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/ObservableBase.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/unitUtils.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/writer.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../Camera.js";import"../CameraLayout.js";import"../core/Clonable.js";import"../chunks/Cyclical.js";import"../chunks/screenUtils.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/GeoreferenceBase.js";import"../chunks/normalizeUtilsSync.js";import"../chunks/normalizeUtilsCommon.js";import"../layers/support/MediaElementBase.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../chunks/MultiOriginJSONSupport.js";import"../layers/support/ControlPointsGeoreference.js";import"../chunks/perspectiveUtils.js";import"../chunks/mat3.js";import"../chunks/mat3f64.js";import"../chunks/vec2.js";import"../chunks/vec2f64.js";import"../layers/support/CornersGeoreference.js";import"../chunks/domUtils.js";import"../chunks/UpdatingHandles.js";import"../chunks/projector.js";import"../chunks/mat2d.js";import"../chunks/mat2df64.js";import"../geometry/support/normalizeUtils.js";import"../chunks/simplify.js";import"../chunks/utils8.js";import"../chunks/utils9.js";import"../views/2d/ViewState.js";import"../chunks/mat2df32.js";import"../chunks/mat3f32.js";import"../chunks/vec2f32.js";import"../chunks/enums2.js";import"../chunks/DisplayObject.js";import"../chunks/utils22.js";import"../chunks/grouping.js";import"../chunks/BufferObject.js";import"../chunks/Texture.js";import"../chunks/enums.js";import"../chunks/GLObjectType.js";import"../chunks/VertexArrayObject.js";import"../chunks/vec3f32.js";import"../chunks/WGLContainer.js";import"../chunks/definitions.js";import"../chunks/dataViewUtils.js";import"../chunks/Program.js";import"../chunks/_commonjsHelpers.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/BoundingBox.js";import"../chunks/WGLBrushVTLSymbol.js";import"../chunks/vec4f32.js";import"../chunks/StyleDefinition.js";import"../chunks/config.js";import"../chunks/ShaderCompiler.js";import"../chunks/ProgramTemplate.js";import"../chunks/TiledDisplayObject.js";import"../chunks/TileKey2.js";import"../chunks/Container.js";import"../chunks/EffectView.js";import"../chunks/parser.js";import"../chunks/utils3.js";import"../chunks/mat4.js";import"../chunks/highlightReasons.js";import"../chunks/HighlightOptions.js";import"../chunks/earcut.js";import"../chunks/featureConversionUtils.js";import"../chunks/aaBoundingBox.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedGeometry.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/clippingUtils.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"./Slider/SliderViewModel.js";import"../chunks/messageBundle.js";import"../chunks/uuid.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/videoUtils.js";import"../layers/support/TelemetryData.js";import"../layers/support/VideoTimeExtent.js";const U=new c("#000");let D;async function E(){const[,{Stage:e}]=await Promise.all([import("../chunks/webglDeps.js"),import("../chunks/mapViewDeps.js")]);D=e}function P(e,t){const[i,s]=e,[o,r]=t,l=o/r,n=s*l,a=i/l;return i/s>=1?l>=1?n<=i?[n,s]:[i,a]:a<=s?[i,a]:[n,s]:l>=1?a<=s?[i,a]:[n,s]:n<=i?[n,s]:[i,a]}function T(e,t){const i=e&&y(e,t);return new p({targetGeometry:e.center,scale:i})}function B(e){return new _({xmin:0,ymin:0,xmax:e[0],ymax:e[1],spatialReference:{wkid:0}})}let $=class extends m{};$=e([n("esri.views.VideoView.Base")],$);let z=class extends(g(d.EventedMixin(u($)))){constructor(e){super(e),this.stateManager=new v,this._isValid=!1,this.layer=null,this.ready=!1,this.addHandles([i((()=>this.preconditionsReady),(e=>{e?this._startup():this._teardown()})),i((()=>this.layer),(()=>this.addResolvingPromise(s((()=>this.ready)))),o)])}initialize(){this.addResolvingPromise(Promise.all([E()]).then((()=>(this._isValid=!0,s((()=>this.ready))))))}destroy(){this._teardown()}get state(){return this.stateManager.state}get preconditionsReady(){return!(!this._isValid||0===this.width||0===this.height||0===this.videoWidth||0===this.videoHeight)}get videoHeight(){return this.layer?.videoHeight||0}get videoWidth(){return this.layer?.videoWidth||0}_startup(){if(!this.layer)return;const e=P(this.size,[this.videoWidth,this.videoHeight]),t=B(e),s=T(t,e);this._mediaElementView=new k({element:new j({video:this.layer.videoElement,georeference:new h({extent:t}),autoplay:!1}),spatialReference:new b({wkid:0})}),this.stateManager.startup(s,this.size,s.targetGeometry.spatialReference);const o=new D(this.surface,{renderingOptions:{samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},backgroundColor:U});this.stage=o,this.addHandles([i((()=>this.state.id),(()=>o.state=this.state),r),this.on("resize",(({width:e,height:t})=>{if(this._mediaElementView){const i=P([e,t],[this.videoWidth,this.videoHeight]),s=B(i);this._mediaElementView.element.georeference=new h({extent:s}),this.stateManager.viewpoint=T(s,i),this.stateManager.resize(e,t)}}))],"video-view");const l=new f(this._mediaElementView);this.overlayContainer=new w,this.overlayContainer.addChild(l),this.stage.addChild(this.overlayContainer),this._set("ready",!0)}_teardown(){this.stage.destroy(),this.stage=null,this._mediaElementView=null,this.overlayContainer.removeAllChildren(),this.overlayContainer=null,this.removeHandles("video-view"),this._set("ready",!1),this.stateManager.teardown()}};e([l()],z.prototype,"stateManager",void 0),e([l({readOnly:!0})],z.prototype,"state",null),e([l()],z.prototype,"_isValid",void 0),e([l()],z.prototype,"layer",void 0),e([l({readOnly:!0})],z.prototype,"preconditionsReady",null),e([l({readOnly:!0})],z.prototype,"ready",void 0),e([l({readOnly:!0})],z.prototype,"videoHeight",null),e([l({readOnly:!0})],z.prototype,"videoWidth",null),z=e([n("esri.views.VideoView")],z);const G=z,F="esri-video-player",H={base:F,color:`${F}__color-block`,colorActive:`${F}__color-block__active`,colorPicker:`${F}__color-picker`,playerActions:`${F}__actions`,playerControls:`${F}__controls`,playerTimecode:`${F}__timecode`,playerToolbar:`${F}__toolbar`,progress:`${F}__progress`,rangeSlider:`${F}__range-slider`,settings:`${F}__settings`,settingsFlow:`${F}__settings-flow`,slider:`${F}__slider`,sliderProgressContainer:`${F}__slider-progress-container`,videoView:`${F}__video-view`},L="esri-metadata-table",I={table:L,data:`${L}__data`,emptyState:`${L}__empty-state`};function A({viewModel:e}){const{metadata:t}=e;return t?x("calcite-block",{heading:"Metadata",open:!0},x("calcite-accordion",{appearance:"solid",selectionMode:"single"},x("calcite-accordion-item",{heading:"Mission Info"},x("div",{class:I.table},Object.keys(t.missionInfo).map((e=>[x("div",{class:I.data},e),x("div",{class:I.data},t.missionInfo[e])])))),x("calcite-accordion-item",{heading:"Platform Info"},x("div",{class:I.table},Object.keys(t.platformInfo).map((e=>[x("div",{class:I.data},e),x("div",{class:I.data},t.platformInfo[e])])))),x("calcite-accordion-item",{heading:"Frame Info"},x("div",{class:I.table},Object.keys(t.frameInfo).map((e=>[x("div",{class:I.data},e),x("div",{class:I.data},t.frameInfo[e])])))))):x("calcite-tile",{class:I.emptyState,description:"Press play or move the playhead to load metadata.",heading:"Metadata not yet loaded"})}function R({viewModel:e}){const{state:t,playing:i}=e,s="not-ready"===t||"waiting"===t,o=i?"pause":"play",r=x("calcite-action",{active:i,alignment:"center",bind:e,disabled:s,icon:i?"pause-f":"play-f",key:"play",onclick:i?e.pause:e.play,scale:"s",text:o,title:o}),l="reverse",n=x("calcite-action",{alignment:"center",bind:e,disabled:s,icon:"reverse-f",key:"reverse",onclick:e.seekBackward,scale:"s",text:l,title:l}),a="forward",c=x("calcite-action",{alignment:"center",bind:e,disabled:s,icon:"forward-f",key:"forward",onclick:e.seekForward,scale:"s",text:a,title:a}),p="beginning",m=x("calcite-action",{alignment:"center",bind:e,disabled:s,icon:"beginning-f",key:"beginning",onclick:e.seekToBeginning,scale:"s",text:p,title:p}),d=x("calcite-action",{alignment:"center",bind:e,disabled:s,icon:"end-f",key:"end",onclick:e.seekToEnding,scale:"s",text:"end",title:"end"});return x("calcite-action-bar",{class:H.playerActions,expandDisabled:!0,layout:"horizontal",scale:"s"},[m,n,r,c,d])}const q={active:null,speed:"1x",quality:"Auto",color:null},W=new c([255,127,0]);let Q=null;function N({viewModel:e,settings:t}){const{state:i}=e,s="not-ready"===i||"waiting"===i,o=x("calcite-flow-item",{heading:"Playback Speed",key:"playback-speed",onCalciteFlowItemBack:()=>{t.active=null}},x("calcite-list",{selectionMode:"single-persist"},[{label:"0.25x",value:.25},{label:"0.5x",value:.5},{label:"1x",value:1},{label:"1.5x",value:1.5},{label:"2x",value:2}].map((({label:i,value:s})=>x("calcite-list-item",{key:i,label:i,onclick:()=>{t.speed=i,e.changePlaybackSpeed(s)},selected:i===t.speed}))))),r=x("calcite-flow-item",{heading:"Quality",key:`Quality (${t.quality})`,onCalciteFlowItemBack:()=>{t.active=null}},x("calcite-list",{selectionMode:"single-persist"},["Auto"].map((e=>x("calcite-list-item",{key:e,label:e,onclick:()=>{t.quality=e},selected:e===t.quality}))))),l=x("calcite-flow-item",{heading:"Graphics",key:`Graphics (${t.color})`,onCalciteFlowItemBack:()=>{t.active=null,t.color=Q?new c(Q):null,t.color&&e.changeGraphicsColor(t.color)}},x("calcite-block",{heading:"Color",open:!0},x("calcite-color-picker",{channelsDisabled:!0,format:"hex",savedDisabled:!0,scale:"s",value:t.color?.toHex()??W.toHex(),onCalciteColorPickerChange:e=>{Q=e.target.value?.toString()}})));return x("div",{class:H.settings},x("calcite-popover",{autoClose:!0,label:"Settings",placement:"top-end",pointerDisabled:!0,referenceElement:"settings-action",scale:"s"},x("calcite-flow",{class:H.settingsFlow,key:"root-flow"},x("calcite-flow-item",{closable:!1,heading:"Settings",key:"root-flow-item"},x("calcite-list",null,x("calcite-list-item",{key:`Speed (${t.speed})`,label:"Speed",onclick:()=>{t.active="speed"}},x("div",{slot:"content-end"},x("calcite-chip",{scale:"s",value:t.speed},t.speed)),x("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})),x("calcite-list-item",{key:`Quality (${t.quality})`,label:"Quality",onclick:()=>{t.active="quality"}},x("div",{slot:"content-end"},x("calcite-chip",{scale:"s",value:t.quality},t.quality)),x("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})),x("calcite-list-item",{key:`Graphics (${t.color})`,label:"Graphics",onclick:()=>{t.active="color"}},x("calcite-color-picker-swatch",{color:t.color?.toString()??W.toString(),scale:"s",slot:"content-end"}),x("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})))),"speed"===t.active?o:null,"quality"===t.active?r:null,"color"===t.active?l:null)),x("calcite-action",{alignment:"center",bind:e,disabled:s,icon:"sliders",id:"settings-action",key:"settings",scale:"s",slot:"trigger",text:"Settings"}))}function J(e){return"follow-sensor"===e.followingMode?"zoom-to-object":"follow-frame"===e.followingMode?"follow":"video"}function K({viewModel:e,settings:t,toggleMetadata:i}){const{state:s}=e,o="not-ready"===s||"waiting"===s,r=x("div",null,x("calcite-popover",{autoClose:!0,label:"Layers",placement:"top-end",pointerDisabled:!0,referenceElement:"layers-action",scale:"s"},x("calcite-panel",{heading:"Layers"},x("calcite-list",{selectionMode:"multiple"},x("calcite-list-item",{label:"Sensor",onclick:()=>{e.toggleSensorDisplay()},selected:!!e.layer?.telemetryDisplay?.sensorLocation}),x("calcite-list-item",{label:"Sight Line",onclick:()=>{e.toggleSensorSightLineDisplay()},selected:!!e.layer?.telemetryDisplay?.lineOfSight}),x("calcite-list-item",{label:"Sensor Trail",onclick:()=>{e.toggleSensorTrailDisplay()},selected:!!e.layer?.telemetryDisplay?.sensorTrail}),x("calcite-list-item",{label:"Frame Center",onclick:()=>{e.toggleFrameCenterDisplay()},selected:!!e.layer?.telemetryDisplay?.frameCenter}),x("calcite-list-item",{label:"Frame Outline",onclick:()=>{e.toggleFrameOutlineDisplay()},selected:!!e.layer?.telemetryDisplay?.frameOutline})))),x("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"layers",id:"layers-action",key:"layers",scale:"s",slot:"trigger",text:"layers"})),l=x("div",null,x("calcite-popover",{autoClose:!0,label:"Follow",placement:"top-end",pointerDisabled:!0,referenceElement:"follow-action",scale:"s"},x("calcite-panel",{heading:"Follow"},x("calcite-list",{selectionMode:"single-persist"},x("calcite-list-item",{label:"Sensor",onclick:()=>{e.followingMode="follow-sensor"}},x("calcite-icon",{icon:"zoom-to-object",scale:"s",slot:"content-start"})),x("calcite-list-item",{label:"Frame",onclick:()=>{e.followingMode="follow-frame"}},x("calcite-icon",{icon:"follow",scale:"s",slot:"content-start"})),x("calcite-list-item",{label:"Video",onclick:()=>{e.followingMode="follow-both"},selected:!0},x("calcite-icon",{icon:"video",scale:"s",slot:"content-start"}))))),x("calcite-action",{alignment:"center",bind:e,disabled:o,icon:J(e),id:"follow-action",key:"follow",scale:"s",slot:"trigger",text:"follow"})),n=x(N,{settings:t,viewModel:e}),a=x("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"feature-details",key:"metadata",onclick:i,scale:"s",text:"metadata"});return x("calcite-action-bar",{class:H.playerControls,expandDisabled:!0,layout:"horizontal",scale:"s"},[r,l,n,a])}let Z=class extends S{constructor(e,i){super(e,i),this._settings=t(q),this._metadataVisible=!1,this._slider=new M({visibleElements:{labels:!1,rangeLabels:!1},min:0,max:100,values:[0],thumbsConstrained:!1}),this.videoView=new G({container:document.createElement("div")}),this.viewModel=new O}initialize(){this.addHandles([i((()=>this.viewModel.layer),(()=>{this.videoView.layer=this.viewModel.layer}),o),this._slider.on(["thumb-change","thumb-drag"],(({value:e})=>{const t=e*this.viewModel.duration/100;this.viewModel.seekTo(t)}))])}loadDependencies(){return Promise.all([C({action:()=>import("../chunks/calcite-action.js"),"action-bar":()=>import("../chunks/calcite-action-bar.js")}),Promise.all([C({action:()=>import("../chunks/calcite-action.js"),"action-bar":()=>import("../chunks/calcite-action-bar.js"),panel:()=>import("../chunks/calcite-panel.js"),popover:()=>import("../chunks/calcite-popover.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),icon:()=>import("../chunks/calcite-icon.js")}),C({action:()=>import("../chunks/calcite-action.js"),flow:()=>import("../chunks/calcite-flow.js"),"flow-item":()=>import("../chunks/calcite-flow-item.js"),icon:()=>import("../chunks/calcite-icon.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),popover:()=>import("../chunks/calcite-popover.js"),block:()=>import("../chunks/calcite-block.js"),"color-picker":()=>import("../chunks/calcite-color-picker.js"),chip:()=>import("../chunks/calcite-chip.js"),"color-picker-swatch":()=>import("../chunks/calcite-color-picker-swatch.js")})]),C({accordion:()=>import("../chunks/calcite-accordion.js"),"accordion-item":()=>import("../chunks/calcite-accordion-item.js"),block:()=>import("../chunks/calcite-block.js"),tile:()=>import("../chunks/calcite-tile.js")}),C({progress:()=>import("../chunks/calcite-progress.js"),panel:()=>import("../chunks/calcite-panel.js"),scrim:()=>import("../chunks/calcite-scrim.js")})])}get icon(){return"video-web"}set icon(e){this._overrideIfSome("icon",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){return x("div",{class:this.classes(H.base,V.widget)},x("calcite-panel",{heading:this.layer?.title||"Video Player"},this._renderLoadingScrim(),this._renderBuffering(),this._renderVideoSection(),this._renderActionBar(),this._renderMetadataSection()))}_renderLoadingScrim(){const{state:e}=this.viewModel;return this.videoView.ready?null:x("calcite-scrim",{loading:"error"!==e},"error"===e?"Error loading the layer":null)}_renderBuffering(){const{currentTime:e,buffered:t,duration:i}=this.viewModel,s=t/(i||1),o=e/(i||1);return this.viewModel.ended||s>o?null:x("calcite-progress",{type:"indeterminate"})}_renderVideoSection(){const{buffered:e,currentTime:t,duration:i}=this.viewModel,s=this.videoView.container;if(!s)return null;s.className=H.videoView;const o=e/(i||1),r=t/(i||1);return this._slider.values=[100*r],x("section",{afterCreate:Y,bind:s},x("div",{class:H.sliderProgressContainer},x("progress",{class:H.progress,max:"1",value:`${o}`}),x("div",{class:H.slider},this._slider.render())))}_renderActionBar(){return x("div",{class:H.playerToolbar},x(R,{viewModel:this.viewModel}),x("div",{class:H.playerTimecode},X(this.viewModel.currentTime)," / ",X(this.viewModel.duration)),x(K,{settings:this._settings,toggleMetadata:()=>this._metadataVisible=!this._metadataVisible,viewModel:this.viewModel}))}_renderMetadataSection(){return this._metadataVisible?x(A,{viewModel:this.viewModel}):null}};function X(e){return a(1e3*Math.round(e),{minute:"2-digit",second:"2-digit"})}function Y(e){e.prepend(this)}e([l()],Z.prototype,"_settings",void 0),e([l()],Z.prototype,"icon",null),e([l()],Z.prototype,"layer",null),e([l()],Z.prototype,"videoView",void 0),e([l({type:O})],Z.prototype,"viewModel",void 0),e([l()],Z.prototype,"view",null),Z=e([n("esri.widgets.VideoPlayer")],Z);const ee=Z;export{ee as default};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{clone as s,A as r,r as i}from"../../core/lang.js";import o from"../../core/Error.js";import{m as a,h as n}from"../../chunks/handleUtils.js";import{r as l,d as p}from"../../chunks/maybe.js";import{throwIfAborted as c,debounce as u,whenOrAbort as m}from"../../core/promiseUtils.js";import{watch as d,whenOnce as h,initial as y,syncAndInitial as j}from"../../core/reactiveUtils.js";import{a as f}from"../../chunks/uuid.js";import{property as g}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/Logger.js";import{subclass as b}from"../../core/accessorSupport/decorators/subclass.js";import k from"../../layers/GraphicsLayer.js";import{t as w}from"../../chunks/layerUtils2.js";import{g as v}from"../../chunks/helpMessageUtils.js";import{V as S}from"../../chunks/InputManager.js";import{S as I}from"../../chunks/isSupportedObject.js";import F from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as M}from"./CreateFeaturesWorkflowData.js";import{c as U}from"../../chunks/asyncUtils.js";import{p as V}from"../../chunks/screenUtils.js";import{d as _}from"../../chunks/diffUtils.js";import{featureHasFields as C,fixFields as L,getDisplayFieldName as A}from"../../layers/support/fieldUtils.js";import{c as x,a as T}from"../../chunks/drapedUtils.js";import{m as P}from"../../chunks/lengthUtils.js";import{b as D,T as E}from"../../chunks/sizeVariableUtils.js";import{getRotationAngle as O,getSize as R}from"../../chunks/visualVariableUtils.js";import{t as H}from"../../symbols/support/jsonUtils.js";import{getDisplayedSymbol as z}from"../../symbols/support/symbolUtils.js";import{G}from"../../chunks/GraphicState.js";import{h as B,f as q}from"../../chunks/hitTestSelectUtils.js";import{g as W}from"../../chunks/templateUtils.js";import Z from"./Workflow.js";import N from"../FeatureForm/FeatureFormViewModel.js";import Q from"../Sketch/SketchViewModel.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../config.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/Queue.js";import"../../core/signal.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/angularMeasurementUtils.js";import"../../chunks/Cyclical.js";import"../../chunks/quantityUtils.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectPointToVector.js";import"../../geometry/projection.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/dehydratedPoint.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/utils11.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils7.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../chunks/UpdatingHandles.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../chunks/formUtils.js";import"../../chunks/editableLayers.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/support/Subtype.js";import"../../chunks/featureFormUtils.js";import"../../chunks/utils2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../FeatureForm/FieldInput.js";import"../../chunks/featureUtils.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../../arcade.js";import"../../chunks/TimeOnly.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/OverrideHelper.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/portalItemUtils.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../support/popupUtils.js";import"../../chunks/interfaces2.js";import"../FeatureForm/GroupInput.js";import"../FeatureForm/RelationshipInput.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../../chunks/ReactiveMap.js";import"../../chunks/ReactiveSet.js";import"../../chunks/layerUtils.js";import"../../chunks/keybindings.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/Settings2.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/snappingUtils.js";import"../../chunks/plane.js";import"../../chunks/mat3f64.js";import"../../chunks/mat4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/utils6.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/layerViewUtils.js";import"../../chunks/viewUtils.js";import"../../geometry/geometryEngine.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../views/interactive/snapping/SnappingOptions.js";import"../../chunks/screenUtils2.js";function J(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!function(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}(t.renderer))return{rotation:null,size:null};let s=null,r=null;const i=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&null!=O(t,e)));1===i.length&&(s=function(e,t){const s="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=e.field,i=t.fields&&t.fields.filter((e=>e.name===r)),o=i&&1===i.length?i[0].type:"double",a={initial:0,current:0};return{field:r,fieldType:o,getDefault:()=>Promise.resolve(0),getValue:e=>(a.current=a.initial-s*e,K((a.current+360)%360,o)),setInitialValue:e=>{a.initial=e,a.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}(i[0],t));const o=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&D(t)===E.RealWorldSize&&null!=R(t,e)));return 1===o.length&&(r=function(e,t){const s=e.field,r=e.axis,i=t.fields&&t.fields.filter((e=>e.name===s)),o=i&&1===i.length?i[0].type:"double",a={initial:0,current:0},n=P[e.valueUnit]??1;let l;return l="area"===e.valueRepresentation?e=>(e*n/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*n/2:e=>e*n,{field:s,fieldType:o,getDefault:async(e,t)=>K(l(await async function(e,t,s){if(null==t)return 0;const{symbol:r}=H(t);if(null==r||"web-style"===r.type||"cim"===r.type)return 0;const i=r.symbolLayers.at(0);if(!i)return 0;switch(i.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../chunks/symbolLayerUtils.js");return i.size||Math.min(le.icon,(await e(i,le.icon))[0])||le.icon}case"text":return i.size||le.text;case"line":return i.size||le.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("../../chunks/symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await t(i,e.scale/le.viewScaleSizeFactor),s)}case"path":return(null!=i.width?i.width:i.height)||e.scale/le.viewScaleSizeFactor;case"extrude":return i.size||e.scale/le.viewScaleSizeFactor;default:return 0}}(t,e,r)),o),getValue:(e,t)=>(a.initial||(a.initial=t.pixelSizeAt(t.center)),a.current=a.initial*e,K(a.current,o)),setInitialValue:e=>{a.initial=e,a.current=0},isUpdatingInteractively:!1,displayUnit:ce(e.valueUnit),axis:e.axis}}(o[0],t)),{rotation:s,size:r}}function K(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function X(e,t,s){const r=await z(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:s});null!=_(e.symbol,r)&&(e.symbol=r)}async function Y(e,s,r,i,o){const a=new t({sourceLayer:s,attributes:r}),{rotation:n,size:l}=J(a);let p=await z(a,{useSourceLayer:!0,webStyleCache:i,scale:o}),c=!1;for(const t of[l,n])null!=t&&null==r[t.field]&&(r[t.field]=await t.getDefault(p,e.view),c=!0);switch(c&&(p=await z(a,{useSourceLayer:!0,webStyleCache:i,scale:o})),p?.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=p;break;case"simple-line":case"line-3d":e.polylineSymbol=p;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=p;break;case"mesh-3d":e.meshSymbol=p}$(e.tooltipOptions,l,n)}function $(e,t,s){e.visualVariables=null!=t||null!=s?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=s?{valueType:s.fieldType,rotationType:s.rotationType??"geographic"}:null}:null}async function ee(e,t,s,i){switch(t.type){case"3d":return async function(e,t,s,i){if(0===e.length)return[];const{updatable:o,graphicsByLayer:a}=await s.async((async()=>{const{results:r}=await m(B(t,s),i),o=new Map;q(r).forEach((({graphic:e})=>(e=>{const t=e.layer,s=o.get(t);if(!s){const e=new Array;return o.set(t,e),e}return s})(e).push(e)));const a=e.filter((({capabilities:e,layer:t})=>e.update.enabled&&o.has(t)));return 0!==a.length&&s.stopPropagation(),{updatable:a,graphicsByLayer:o}}));return m(Promise.allSettled(o.map((async({layer:e})=>{const t=a.get(e),s=te(e);if(t.every((e=>C(s,e))))return t;const o=[];for(const e of t){o.push(e.getObjectId());const t=Object.keys(e.attributes);r(s,t)}const n=e.createQuery();return n.returnGeometry=!1,n.objectIds=o,n.outFields=L(e.fieldsIndex,s),e.queryFeatures(n,{signal:i}).then((({features:e})=>e))}))),i)}(e,t,s,i);case"2d":return async function(e,t,s,r){if(0===e.length)return[];const{mapPoint:i}=s;if(null==i)return[];let o=null;const a=await s.async((async()=>{const{results:i}=await m(t.hitTest(s),r);if(0===i.length)return[];const a=new Set;o=q(i),o.forEach((({graphic:e})=>e&&a.add(e.layer)));const n=e.filter((e=>a.has(e.layer)&&e.supportsUpdateWorkflow));return n.length>0&&s.stopPropagation(),n}));return m(Promise.allSettled(a.map((async({layer:e})=>{const a=e.createQuery();a.returnGeometry=!1,a.outFields=te(e);const n="renderer"in e?x({renderer:e.renderer,pointerType:s.pointerType}):0;a.geometry=T(i,n,t),a.outSpatialReference=t.spatialReference;const{features:l}=await e.queryFeatures(a,{signal:r});return o?.forEach((({graphic:t})=>{t.layer!==e||l.some((e=>e.getObjectId()===t.getObjectId()))||l.push(t)})),l}))),r)}(e,t,s,i)}}function te(e){return L(e.fieldsIndex,[e.objectIdField,A({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function se(e,t,s){const{sourceLayer:r}=e,i=r.createQuery();i.objectIds=[e.getAttribute(r.objectIdField)],i.outFields=["*"],i.returnM=r.capabilities.data.supportsM,i.returnZ=r.capabilities.data.supportsZ,"scene"===r.type&&null!=r.infoFor3D||(i.outSpatialReference=t);const o=await r.queryFeatures(i,{signal:s});return c(s),o.features[0]}async function re(e){const{graphic:t,sketchViewModel:s,sourceLayer:r,visualVariables:i,webStyleCache:o}=e;let a=!1;const{rotation:n,size:l}=i;if([n,l].forEach((async e=>{if(null==e)return;const r=t.getAttribute(e.field);if(null!=r)e.setInitialValue(r);else{const r=await e.getDefault(t.symbol,s.view);e.setInitialValue(r),t.setAttribute(e.field,r),a=!0}})),a){const e="2d"===s.view?.type?s.view.scale:null;await X(t,o,e)}const p={multipleSelectionEnabled:!1};return"point"===r.geometryType&&(p.enableRotation=null!=n,p.enableScaling=null!=l),$(s.tooltipOptions,l,n),s.layer.elevationInfo=r.elevationInfo,s.update(t,p)}async function ie(e,t,s,r,i){if(null==t.geometry||"point"!==t.geometry?.type)return;const o=r.rotation,a=null==(n=s.toolEventInfo)||"rotate-start"!==n.type&&"rotate"!==n.type&&"rotate-stop"!==n.type?null:n;var n;if(null!=o&&null!=a){const{field:s,getValue:r}=o;"rotate-stop"===a.type?(o.isUpdatingInteractively=!1,o.setInitialValue(t.getAttribute(s))):(o.isUpdatingInteractively=!0,t.setAttribute(s,r(a.angle,e)))}const l=r.size,p=function(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(s.toolEventInfo);if(null!=l&&null!=p){const{field:s,getValue:r}=l;"scale-stop"===p.type?(l.isUpdatingInteractively=!1,l.setInitialValue(t.getAttribute(s))):(l.isUpdatingInteractively=!0,t.setAttribute(s,r(p.xScale,e)))}await X(t,i,"2d"===e.type?e.scale:null)}async function oe({feature:e,featureClone:t,visualVariableAttributes:s,sketchViewModel:r,view:i,onUpdate:o,webStyleCache:l}){await X(t,l,"2d"===i.type?i.scale:null);let p=null;if("2d"===r?.view?.type){const e=u((e=>X(t,l,e)));p=d((()=>r?.view?.scale),(t=>e(t)))}const c=t.sourceLayer,m=me(i,c);await re({graphic:t,sketchViewModel:r,sourceLayer:c,visualVariables:s,webStyleCache:l});let h=null;m.then((e=>h=e)).catch((()=>{}));const y=s.size,j=s.rotation,f=d((()=>e.attributes),(async e=>{let s=!1;for(const r in e){const i=e[r];i!==t.getAttribute(r)&&(t.setAttribute(r,i),null==y||y.isUpdatingInteractively||y.field!==r||y.setInitialValue(i),null==j||j.isUpdatingInteractively||j.field!==r||j.setInitialValue(i),(null==h||h.requiredFields.includes(r))&&(s=!0))}s&&await X(t,l,"2d"===i.type?i.scale:null)})),g=r.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return re({graphic:t,sketchViewModel:r,sourceLayer:c,visualVariables:s,webStyleCache:l});await ie(i,t,e,s,l),o(he(t),e)})),b=r.on(["undo","redo"],(async e=>{o(he(e.graphics[0]),e)}));return n([b,g,a((()=>r.cancel())),f,p])}async function ae(e,t,s){const r=e.view;e.layer.add(s);const i=t.sourceLayer,o=t.layer,l=t.getAttribute(o.objectIdField);let p=null;function u(e){p?.abort(),p=U((async t=>{const s=await me(r,i);c(t),s.setVisibility?.(l,e)}))}return await async function(e,t){if("3d"===e.type){const s=new G({graphic:t}),r=e.trackGraphicState(s);await h((()=>s.displaying)),r.remove()}else await h((()=>t.visible))}(r,s),u(!1),n([ne(r,s,(e=>u(!e))),a((async()=>{u(!0);try{const e=await me(r,i);await h((()=>!e.updating))}finally{e.layer.remove(s)}}))])}function ne(e,t,s){if("3d"===e.type){const r=new G({graphic:t});return n([e.trackGraphicState(r),d((()=>r.displaying),s)])}return d((()=>t.visible),s)}const le={icon:V(24),text:V(12),line:V(1),viewScaleSizeFactor:100};function pe(e,t,s){let r=!1;return e.filter((e=>!!r||(r=e===t,r))).map((e=>s[e]()))}function ce(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}const ue=e=>/-stop/.test(e)||/vertex-/.test(e),me=(e,t)=>{const s="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(s)};function de(e){return"createInteractiveEditSession"in e}function he(e){const t=e.geometry;if("mesh"===t?.type){const r=e.cloneShallow();return r.attributes=s(e.attributes),r.geometry=t.cloneShallow(),r.geometry.transform=t.transform?.clone()??null,r}return e.clone()}function ye(e){const t=e.cursor;return e.cursor="progress",a((()=>e.cursor=t))}function je(e){const t=e?.layer;return"scene"===t?.type}var fe;const ge=Symbol(),be=Symbol(),ke=Symbol();let we=fe=class extends Z{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new N,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=u(((e,t,s)=>X(e,t,s)))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.numPendingFeatures>0)return!0;const{creationInfo:e,upload:t}=this.data,s=this._sketchViewModel,{activeComponent:r}=s,i=s.createGraphic?.geometry?.type;return!("polyline"!==i&&"polygon"!==i&&"multipoint"!==i||"draw-2d"!==r?.type&&"draw-3d"!==r?.type)&&r.drawOperation.committedVertices.length>0||!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace}get helpMessage(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const s=e.layer.geometryType,r=this._sketchViewModel.createGraphic;if("mesh"===s){this._getDrawMeshHelpMessage||import("../../chunks/helpMessageUtils3d.js").then((e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}));const{view:e}=t;return"3d"===e?.type?this._getDrawMeshHelpMessage?.(r,e):void 0}return v(s,r?.geometry)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([ke])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),i(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){return await super.start(),w(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:s,isNested:r,creationInfo:i,parent:o,snappingManager:a,startAt:n,viewModel:l}=e,p=e.sketchOptions??new I,c=i?.layer,u=c?l.findEditorItemForLayer(c):void 0,m=new fe({data:new M({creationInfo:i,editorItem:u,parent:o,sketchOptions:p,snappingManager:a,viewModel:l}),isNested:r,onCommit:async e=>{const{creationInfo:r}=e;if(!r)return;const i=e.pendingFeatures.toArray(),{layer:o}=r,a=o.capabilities?.editing.supportsGlobalId&&"globalIdField"in o,n=m._attachmentFileInfos;if(a){const e=function(e,t,s){const r=[],i=t.globalIdField;return e.forEach(((t,o)=>{e[o].attributes[i]??=f(),(s?.get(t)||[]).forEach((({file:e})=>r.push({feature:t,attachment:{globalId:f(),data:e}})))})),r.length?{addFeatures:e,addAttachments:r}:{addFeatures:e}}(i,o,n);return void await s(o,e,{globalIdUsed:!0})}const l=await s(o,{addFeatures:i});if(n.size>0){const e=l?.addFeatureResults??[];await t(o,function(e,t,s,r){const i=[];return t.forEach(((t,o)=>{if(!t.error){const a=e[o],n=r.get(a)||[];a.attributes[s.objectIdField]=t.objectId,n.forEach((({form:e})=>i.push({feature:a,attachment:e})))}})),i}(i,e,o,n))}}});return m._set("steps",this._createWorkflowSteps(m,n)),m}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){l(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(be);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const s=await async function(e,t,s){const r=t.layer,i={...t.template?.prototype.attributes,...t.attributeOverrides};let o=null;const{view:n}=e,l="2d"===n?.type;if(await Y(e,r,i,s,l?n.scale:null),l){const t=u((t=>Y(e,r,i,s,t)));o=d((()=>n.scale),(e=>t(e)))}const{data:p,editing:c}=r.capabilities;return e.layer.elevationInfo=r.elevationInfo,null==t.geometryToPlace?await e.create(function(e){if(!e)throw new Error("no geometry type");return"multipatch"===e?"mesh":e}(r.geometryType),{graphicProperties:{attributes:i,sourceLayer:r},hasZ:p.supportsZ,defaultZ:(l?c.zDefault:null)??e.defaultCreateOptions.defaultZ}):await e.place(t.geometryToPlace,{graphicProperties:{attributes:i,sourceLayer:r}}),o??a()}(this._sketchViewModel,t,e);this.addHandles(s,be)}async _startUpdating(e,t){const{pendingFeatures:s}=this;s.includes(e)||s.add(e);const{_featureFormViewModel:r,_sketchViewModel:i}=this,{creationInfo:o,viewModel:a}=this.data,{attachmentsViewModel:p,layerInfos:c,view:u}=a;if(!u||!o)return;const m=o.layer,h=function(e,t){return e?.find((e=>e.layer===t))}(c,m),y=h?.formTemplate,j=u.spatialReference;if(r.set({arcadeEditType:"INSERT",feature:e,formTemplate:y,spatialReference:j,map:u.map}),"add"!==p.mode&&"edit"!==p.mode||a.activeWorkflow?.previous(),p.graphic=e,p.fileInfos.removeAll(),p.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach((({file:e,form:t})=>p.addFile(e,t))),this._removeHighlight(e),await X(e,t,"2d"===u.type?u.scale:null),this.removeHandles(be),l(this._featureFormHandle),"2d"===u.type){const s=d((()=>u.scale),(s=>this._updateGraphicDebounced(e,t,s)));this.addHandles(s,be)}return this._featureFormHandle=n([r.on("value-change",(async()=>{e.attributes=r.getValues(),await X(e,t,"2d"===u.type?u.scale:null)})),i.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&ue(e.toolEventInfo.type))&&r.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=J(e),w(m)?void 0:re({graphic:e,sketchViewModel:i,sourceLayer:m,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:s}=e,r={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:r}=s,{view:i}=r;i&&(je(t)?e.addHandles(await async function({view:e,data:t,signal:s,next:r,cancel:i}){const{creationInfo:o}=t;if(!o)return a();if(!je(o))return a();const{layer:l}=o,p=null!=o.geometryToPlace;if(o.geometryToPlace=null,p)return i(),a();const{Upload:u}=await import("../../chunks/Upload.js");c(s);const m=new u;t.upload=m;let h=null;const y=()=>h?.remove(),j=n([d((()=>m.state),(t=>{switch(t){case"default":case"error":y();break;case"pending":y(),h=ye(e);break;case"success":o.maxFeatures=1,o.geometryToPlace=m.result,y(),r()}})),a((()=>{m.cancel(),y()}))]);return m.uploadTo(l),j}({view:i,data:s,next:()=>e.next(),cancel:()=>r.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(s.parent&&t&&(e.addHandles(r.lockFeatureTemplatesViewModel(),this.id),r.featureTemplatesViewModel.layers=[t.layer]),e.addHandles(r.featureTemplatesViewModel.on("select",(({item:t})=>{t&&(s.creationInfo={...s.creationInfo,layer:t.layer,template:t.template},e.next())})),this.id)))},async tearDown(){e.removeHandles([this.id,be])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:r}=s;t.canceled&&(e.removeHandles([ke,ge,be]),r.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=s.viewModel,{graphic:r,fileInfos:i}=t;e._attachmentFileInfos.set(r,i.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=s.viewModel,{graphic:r,fileInfos:i}=t;e._attachmentFileInfos.set(r,i.toArray()),t.mode="view"}})},i=pe(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,r);return function(e,t){e.viewModel.syncFeatureTemplates();const s=e.creationInfo;if("awaiting-feature-creation-info"===t[0].id&&s){const e=s.layer,r=W(e);1===r.length&&"scene"!==e.type&&(s.template=r[0],t.shift())}return t}(s,i)}static _configureSketchViewModel(e,t){const{data:s}=e,{creationInfo:r,viewModel:o}=s,{view:l}=o,c=e._sketchViewModel;let u=null;const m=[];if(!l)return a();"2d"===l.type&&r&&m.push(e._fadeExistingFeatures(r.layer)),m.push(c.on("create",(s=>e._updatingHandles.addPromise((async s=>{if("cancel"===s.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const s=e._lastActiveGraphics.pop();return e._startUpdating(s,t)}if("complete"===s.state&&s.graphic)return e._startUpdating(s.graphic,t)})(s)))),c.on("update",(s=>e._updatingHandles.addPromise((async s=>{const{attachmentsViewModel:i}=o,{_featureFormViewModel:a}=e,n=s.graphics[0];if("complete"===s.state){n!==u&&(e._lastActiveGraphics.push(n),e._highlight(n)),u=null;const{hasPendingSubtypeChoice:p,submittable:c}=a;if(e.numPendingFeatures===r?.maxFeatures||p||!c){!c&&a.submit();const s=e._lastActiveGraphics.pop();return e._startUpdating(s,t)}if("add"!==i.mode&&"edit"!==i.mode||o.activeWorkflow?.previous(),s.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([ye(l),l.on("click",(e=>e.preventDefault()))],ge),await h((()=>!a.updating)),e.removeHandles(ge),e._startCreating(t)}"start"===s.state&&e._removeHighlight(n);const p=e._visualVariableAttributes;await ie(l,n,s,p,t);const c=n.attributes,{rotation:m,size:d}=p;if(null!=m){const{field:e}=m;a.setValue(e,c[e])}if(null!=d){const{field:e}=d;a.setValue(e,c[e])}})(s)))),c.on("delete",(t=>(t=>{const s=t.graphics[0];e.pendingFeatures.remove(s),i(e._lastActiveGraphics,s),u=s})(t))),l.on("immediate-click",(s=>e._updatingHandles.addPromise((async s=>{if(je(r))return;const{results:i}=await l.hitTest(s,{include:c.layer}),o=i.find((e=>"graphic"===e.type&&e.graphic.sourceLayer===r?.layer));if(!o)return;const a=o.graphic;if("transform"===c.activeTool||"reshape"===c.activeTool){if(c.updateGraphics.at(0)===a)return;const{submittable:s,hasPendingSubtypeChoice:r}=e._featureFormViewModel;if(!s||r)return;await e.updatePendingFeature(a,t)}})(s))),S.TOOL),a((()=>{e._preventDefaultActionOnCancel=!0,c.cancel()})),function(e,t){let s=null;const r=()=>e.snappingOptions.featureSources,i=()=>{null!=s&&(r().remove(s),s=p(s))};return n([d((()=>{const e=t.creationInfo?.layer,s=r().find((t=>t.layer===e));return{hasFeatureLayerSource:!!s,enabled:s?.enabled??!1}}),(({hasFeatureLayerSource:t,enabled:o})=>{if(!t)return i();s??=(s=new F({layer:e.layer}),r().add(s),s),s.enabled=o}),j),a(i)])}(c,s));const y=n(m);return c.addHandles(y),y}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,s=new k({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"}),r=new Q({layer:s,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=r,t?.map.add(s),this.addHandles(a((()=>{t?.destroyed||t?.map.remove(s),s.destroy()})))}async _setUpCreatingFeaturesStep(){if(this.hasHandles(ke))return;const{creationInfo:e,viewModel:s}=this.data,{attachmentsViewModel:r,view:i}=s;if(!i||!e?.layer)throw new o("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:p,layer:c}=e,u=this._sketchViewModel,m=new Map,h=[];this._lastActiveGraphics=[],this._featureFormHandle=l(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=s.findEditorItemForLayer(e.layer),function(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}(r),h.push(d((()=>r.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const j=ye(i);h.push(j);const f=w(e.layer);try{if(f){const s=p??new t({attributes:{...e.template?.prototype.attributes,...e.attributeOverrides},sourceLayer:c});await this._startUpdating(s,m)}else h.push(fe._configureSketchViewModel(this,m)),p?(u.layer.add(p),await this._startUpdating(p,m)):await this._startCreating(m)}finally{j.remove()}const g=a((()=>this.pendingFeatures.drain((e=>u.layer.remove(e))))),b=d((()=>i?.timeZone),(e=>this._featureFormViewModel.timeZone=e),y),k=a((()=>{je(e)&&s.cancelWorkflow({warnIfNoWorkflow:!1})}));this._featureFormHandle&&h.push(this._featureFormHandle),this.addHandles(h,this._handleKeys.beforeCommit),this.addHandles([a((()=>r.fileInfos.removeAll())),n(h),k,g,b],ke)}};e([g()],we.prototype,"createFeatureState",void 0),e([g()],we.prototype,"data",void 0),e([g({constructOnly:!0})],we.prototype,"isNested",void 0),e([g()],we.prototype,"featureFormViewModel",null),e([g()],we.prototype,"hasPendingEdits",null),e([g()],we.prototype,"_getDrawMeshHelpMessage",void 0),e([g()],we.prototype,"helpMessage",null),e([g()],we.prototype,"layer",null),e([g()],we.prototype,"parent",null),e([g()],we.prototype,"parentLayer",null),e([g()],we.prototype,"keyboardCancellationEnabled",null),e([g()],we.prototype,"reliesOnOwnerAdminPrivileges",null),e([g()],we.prototype,"shouldShowAttachments",null),e([g()],we.prototype,"shouldAllowAttachmentEditing",null),e([g()],we.prototype,"sketchViewModel",null),we=fe=e([b("esri.widgets.Editor.CreateFeaturesWorkflow")],we);const ve=we;export{ae as a,de as b,he as c,pe as d,ve as default,ee as e,se as f,J as g,je as h,ue as i,oe as s,X as u,me as w};

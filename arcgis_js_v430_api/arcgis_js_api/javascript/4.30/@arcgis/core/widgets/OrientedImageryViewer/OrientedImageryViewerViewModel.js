/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../Graphic.js";import{i as r,e as i,equalsShallow as s}from"../../core/lang.js";import{c as o}from"../../chunks/asyncUtils.js";import a from"../../core/Collection.js";import{d as n}from"../../core/Accessor.js";import c from"../../core/Error.js";import p from"../../core/Evented.js";import{JSONSupport as l,isSerializable as m}from"../../core/JSONSupport.js";import{L as h}from"../../chunks/Logger.js";import{r as u,d,c as g}from"../../chunks/mathUtils.js";import{d as y,a as f}from"../../chunks/maybe.js";import{throwIfNotAbortError as j,throwIfAborted as v,isAbortError as w,waitTick as b}from"../../core/promiseUtils.js";import{watch as k,syncAndInitial as M,sync as _,when as x,initial as I}from"../../core/reactiveUtils.js";import{property as F}from"../../core/accessorSupport/decorators/property.js";import{subclass as P}from"../../core/accessorSupport/decorators/subclass.js";import{isPolygon as R}from"../../geometry/support/jsonUtils.js";import{geographicToWebMercator as S,webMercatorToGeographic as C}from"../../geometry/support/webMercatorUtils.js";import z from"../../layers/GraphicsLayer.js";import O,{c as V,a as A,b as L,g as U,C as T,o as H,d as D,i as E,v as G}from"../../layers/OrientedImageryLayer.js";import{ClonableMixin as N}from"../../core/Clonable.js";import{cast as B}from"../../core/accessorSupport/decorators/cast.js";import{e as W}from"../../chunks/enumeration.js";import{r as q}from"../../chunks/reader.js";import{w as $}from"../../chunks/writer.js";import Z,{d as J}from"../../geometry/Point.js";import Q from"../../rest/support/Query.js";import K from"../../geometry/Extent.js";import{b as X,h as Y}from"../../chunks/unitUtils.js";import{z as ee,c as te}from"../../chunks/vec3f64.js";import{x as re,i as ie,d as se}from"../../chunks/vec3.js";import oe from"../../geometry/Circle.js";import ae from"../../geometry/Mesh.js";import{initializeProjection as ne,projectWithZConversion as ce,project as pe}from"../../geometry/projection.js";import{w as le}from"../../chunks/lineSegment.js";import me from"../../geometry/support/MeshComponent.js";import{M as he}from"../../chunks/MeshVertexAttributes.js";import{l as ue,c as de,F as ge}from"../../chunks/plane.js";import{c as ye}from"../../chunks/mat3f64.js";import{c as fe}from"../../chunks/mat4f64.js";import{C as je}from"../../chunks/mat4.js";import ve from"../../geometry/SpatialReference.js";import we from"../../geometry/Polygon.js";import be from"../../geometry/Multipoint.js";import{k as ke}from"../../chunks/mat3.js";import{d as Me}from"../../chunks/aaBoundingRect.js";import _e from"../../layers/ElevationLayer.js";import xe from"../../layers/ImageryLayer.js";import{TileElevationSampler as Ie}from"../../layers/support/ElevationSampler.js";import{E as Fe}from"../../chunks/ElevationTile.js";import{E as Pe}from"../../chunks/LercDecoder.js";import Re from"../../layers/support/TileInfo.js";import{T as Se}from"../../chunks/TileKey.js";import{f as Ce,e as ze}from"../../chunks/ray.js";import{h as Oe,k as Ve}from"../../chunks/sphere.js";import{i as Ae}from"../../layers/support/fieldUtils.js";import Le from"../../rest/support/AttachmentQuery.js";import{V as Ue}from"../../chunks/InputManager.js";import Te from"../../Camera.js";import He from"../../views/SceneView.js";import De from"../Widget.js";import Ee from"../../Ground.js";import Ge from"../../Map.js";import Ne from"../../request.js";import{J as Be}from"../../chunks/jsonMap.js";import We from"../Zoom.js";import qe from"../Zoom/ZoomViewModel.js";import"../../symbols.js";import $e from"../../geometry/support/MeshMaterial.js";import Ze from"../../geometry/support/MeshTexture.js";import Je from"../../symbols/MeshSymbol3D.js";import Qe from"../../symbols/FillSymbol3DLayer.js";import{g as Ke}from"../../chunks/globalCss.js";import"../../chunks/widgetUtils.js";import{v as Xe}from"../../chunks/vmEvent.js";import{t as Ye}from"../../chunks/jsxFactory.js";import et from"../../symbols/CIMSymbol.js";import tt from"../../symbols/SimpleMarkerSymbol.js";import rt from"../../symbols/SimpleFillSymbol.js";import it from"../../symbols/PointSymbol3D.js";import st from"../../symbols/IconSymbol3DLayer.js";import ot from"../../symbols/ObjectSymbol3DLayer.js";import at from"../../views/MapView.js";import{rotate as nt,intersect as ct,nearestCoordinate as pt}from"../../geometry/geometryEngine.js";import lt from"../../layers/ImageryTileLayer.js";import mt from"../../layers/support/RasterFunction.js";import{convolutionKernel as ht}from"../../layers/support/rasterFunctionConstants.js";import{w as ut}from"../../chunks/viewpointUtils.js";import"../../chunks/ensureType.js";import"../../geometry/Geometry.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/assets.js";import"../../core/urlUtils.js";import"../../kernel.js";import"../../geometry/Polyline.js";import"../../chunks/extentUtils.js";import"../../chunks/zmUtils.js";import"../../chunks/common.js";import"../../chunks/typeUtils.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/utils3.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/layerUtils2.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/OverrideHelper.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/utils7.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../chunks/formUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../chunks/uuid.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/support/Subtype.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../support/popupUtils.js";import"../../chunks/interfaces2.js";import"../../chunks/requestPresets.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/quat.js";import"../../chunks/quatf64.js";import"../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../geometry/support/MeshLocalVertexSpace.js";import"../../geometry/support/MeshTransform.js";import"../../chunks/meshVertexSpaceUtils.js";import"../../chunks/triangulationUtils.js";import"../../chunks/earcut.js";import"../../chunks/DoubleArray.js";import"../../chunks/Indices.js";import"../../chunks/deduplicate.js";import"../../chunks/projection.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../chunks/computeTranslationToOriginAndRotation.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec32.js";import"../../chunks/vec42.js";import"../../chunks/projectPointToVector.js";import"../../chunks/vertexSpaceConversion.js";import"../../chunks/External.js";import"../../chunks/infoFor3D.js";import"../../chunks/imageUtils.js";import"../../geometry/support/MeshTextureTransform.js";import"../../geometry/support/MeshMaterialMetallicRoughness.js";import"../../chunks/vec2f64.js";import"../../chunks/mathUtils2.js";import"../../layers/mixins/ArcGISCachedService.js";import"../../chunks/TileInfoTilemapCache.js";import"../../chunks/TilemapCache.js";import"../../chunks/ByteSizeUnit.js";import"../../layers/support/LOD.js";import"../../chunks/WorkerHandle.js";import"../../layers/mixins/ArcGISImageService.js";import"../../rasterRenderers.js";import"../../renderers/FlowRenderer.js";import"../../renderers/RasterColormapRenderer.js";import"../../renderers/support/ColormapInfo.js";import"../../chunks/colorRampUtils.js";import"../../renderers/RasterShadedReliefRenderer.js";import"../../renderers/RasterStretchRenderer.js";import"../../chunks/stretchRendererUtils.js";import"../../renderers/VectorFieldRenderer.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils8.js";import"../../chunks/utils9.js";import"../../chunks/vectorFieldUtils.js";import"../../layers/support/PixelBlock.js";import"../../chunks/pixelRangeUtils.js";import"../../chunks/utils11.js";import"../../symbols/support/cimSymbolUtils.js";import"../../layers/support/DimensionalDefinition.js";import"../../layers/support/MosaicRule.js";import"../../chunks/imageBitmapUtils.js";import"../../layers/support/MultidimensionalSubset.js";import"../../layers/support/RasterInfo.js";import"../../layers/support/RasterBandInfo.js";import"../../layers/support/RasterSensorInfo.js";import"../../chunks/RasterJobHandler.js";import"../../chunks/multidimensionalUtils.js";import"../../chunks/RasterSymbolizer.js";import"../../chunks/stretchUtils.js";import"../../chunks/rasterRendererHelper.js";import"../../chunks/generateRendererUtils.js";import"../../rest/imageService.js";import"../../rest/support/FindImagesParameters.js";import"../../rest/support/FindImagesResult.js";import"../../rest/support/ImageInspectionInfo.js";import"../../rest/support/CameraInfoMixin.js";import"../../rest/support/ImageAngleParameters.js";import"../../rest/support/ImageAngleResult.js";import"../../rest/support/ImageAreaParameters.js";import"../../rest/support/BaseImageMeasureParameters.js";import"../../rest/support/ImageAreaResult.js";import"../../rest/support/BaseImageMeasureResult.js";import"../../rest/support/ImageBoundaryParameters.js";import"../../rest/support/ImageBoundaryResult.js";import"../../rest/support/ImageDistanceParameters.js";import"../../rest/support/ImageDistanceResult.js";import"../../rest/support/ImageGPSInfoParameters.js";import"../../rest/support/ImageGPSInfoResult.js";import"../../rest/support/CameraInfo.js";import"../../rest/support/ImageGPSInfo.js";import"../../rest/support/ImageHeightParameters.js";import"../../rest/support/ImageHeightResult.js";import"../../rest/support/ImageHistogramParameters.js";import"../../rest/support/ImageIdentifyParameters.js";import"../../rest/support/ImageIdentifyResult.js";import"../../rest/support/ImagePixelLocationParameters.js";import"../../rest/support/ImagePixelLocationResult.js";import"../../rest/support/ImagePointParameters.js";import"../../rest/support/ImagePointResult.js";import"../../rest/support/ImageSampleParameters.js";import"../../rest/support/ImageSampleResult.js";import"../../rest/support/ImageSample.js";import"../../rest/support/ImageToMapMultirayParameters.js";import"../../rest/support/ImageToMapParameters.js";import"../../rest/support/ImageUrlParameters.js";import"../../rest/support/ImageUrlResult.js";import"../../rest/support/MapToImageParameters.js";import"../../rest/support/MeasureAreaFromImageResult.js";import"../../rest/support/MeasureFromImageParameters.js";import"../../rest/support/MeasureLengthFromImageResult.js";import"../../chunks/executeQueryJSON.js";import"../../chunks/query.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../rest/query/support/AttachmentInfo.js";import"../../chunks/executeForIds.js";import"../../chunks/fetchRasterInfo.js";import"../../chunks/dataUtils.js";import"../../chunks/ElevationSamplerData.js";import"../../core/signal.js";import"../../CameraLayout.js";import"../../chunks/Cyclical.js";import"../../Viewpoint.js";import"../../chunks/domUtils.js";import"../../chunks/projectBoundingRect.js";import"../../chunks/boundedPlane.js";import"../../chunks/RenderCoordsHelper.js";import"../../chunks/projectVectorToPoint.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/ElevationProvider.js";import"../../chunks/ViewingMode.js";import"../../chunks/scaleUtils.js";import"../../views/View.js";import"../../chunks/CollectionFlattener.js";import"../../chunks/UpdatingHandles.js";import"../../views/BasemapView.js";import"../../chunks/collectionUtils2.js";import"../../views/Magnifier.js";import"../../chunks/ReactiveMap.js";import"../../chunks/selectionUtils.js";import"../../views/Theme.js";import"../../chunks/ViewEvents.js";import"../../chunks/IViewEvents.js";import"../../chunks/interfaces.js";import"../../chunks/screenUtils2.js";import"../../views/input/Input.js";import"../../views/input/gamepad/GamepadSettings.js";import"../../views/input/gamepad/GamepadInputDevice.js";import"../../views/navigation/Navigation.js";import"../../chunks/a11yUtils.js";import"../../views/navigation/gamepad/GamepadSettings.js";import"../../chunks/heightModelInfoUtils.js";import"../../chunks/projectionUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/editableLayers.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/basemapUtils.js";import"../../support/LayersMixin.js";import"../../support/TablesMixin.js";import"../../views/BreakpointsOwner.js";import"../../views/DOMContainer.js";import"../../chunks/projector.js";import"../../views/GroundView.js";import"../../chunks/cameraUtils.js";import"../../chunks/Intersector2.js";import"../../chunks/verticalOffsetUtils.js";import"../../chunks/orientedBoundingBox.js";import"../../chunks/Attribute.js";import"../../chunks/earthUtils.js";import"../../chunks/spatialReferenceSupport.js";import"../../chunks/TerrainConst.js";import"../../views/PopupView.js";import"../../views/ViewAnimation.js";import"../../views/3d/environment/SunLighting.js";import"../../webscene/SunLighting.js";import"../../views/3d/environment/VirtualLighting.js";import"../../webscene/VirtualLighting.js";import"../../webscene/Environment.js";import"../../views/3d/environment/SunnyWeather.js";import"../../chunks/weather.js";import"../../views/3d/environment/CloudyWeather.js";import"../../views/3d/environment/FoggyWeather.js";import"../../views/3d/environment/RainyWeather.js";import"../../views/3d/environment/SnowyWeather.js";import"../../chunks/lightingTypes.js";import"../../webscene/background/Background.js";import"../../webscene/background/ColorBackground.js";import"../../chunks/quantityUtils.js";import"../../chunks/IntegerPassUniform.js";import"../../chunks/NormalAttribute.glsl.js";import"../../chunks/Matrix4PassUniform.js";import"../../chunks/interfaces3.js";import"../../chunks/BindType.js";import"../../chunks/VertexAttribute.js";import"../../chunks/VertexPosition.glsl.js";import"../../chunks/Matrix3DrawUniform.js";import"../../chunks/StencilUtils.js";import"../../chunks/basicInterfaces.js";import"../../chunks/Util.js";import"../../chunks/Material.js";import"../../chunks/triangle.js";import"../../chunks/doublePrecisionUtils.js";import"../../chunks/ShaderTechniqueConfiguration.js";import"../../chunks/debugFlags2.js";import"../../chunks/requestImageUtils.js";import"../../chunks/enums.js";import"../../chunks/Texture.js";import"../../chunks/GLObjectType.js";import"../../chunks/renderState.js";import"../../chunks/RenderGeometry.js";import"../../views/3d/webgl/RenderCamera.js";import"../../chunks/frustum.js";import"../../chunks/Scheduler.js";import"../../chunks/debugFlags.js";import"../../chunks/ScreenSpacePass.glsl.js";import"../../chunks/Float4DrawUniform.js";import"../../chunks/NestedMap.js";import"../../chunks/VertexArrayObject2.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/RibbonLineMaterial.js";import"../../chunks/Octree.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/types.js";import"../../chunks/floatRGBA.js";import"../../chunks/Intersector.js";import"../../chunks/glUtil.js";import"../../chunks/VertexElementDescriptor.js";import"../../chunks/BufferObject.js";import"../../chunks/objectResourceUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/DefaultMaterial_COLOR_GAMMA.js";import"../../chunks/resourceUtils3.js";import"../../chunks/vec2f32.js";import"../../chunks/GLTextureMaterial.js";import"../../chunks/RayIntersections.js";import"../../chunks/OutputHighlight.glsl.js";import"../../chunks/DecodeSymbolColor.glsl.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/Matrix4sPassUniform.js";import"../../views/3d/webgl/RenderNode.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/vec3f32.js";import"../../chunks/Program.js";import"../../chunks/GeometryUtil.js";import"../../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import"../../chunks/euclideanLengthMeasurementUtils.js";import"../../chunks/ElevationUpdateEvent.js";import"../../chunks/ElevationContext.js";import"../../chunks/hydratedFeatures.js";import"../../chunks/graphicUtils.js";import"../../chunks/HUDMaterial.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/featureConversionUtils.js";import"../../chunks/edgeUtils.js";import"../../chunks/SnappingCandidate.js";import"../../chunks/Normals.js";import"../../chunks/CIMSymbolHelper.js";import"../../chunks/BidiEngine.js";import"../../chunks/fontUtils.js";import"../../chunks/GeometryUtils.js";import"../../chunks/enums2.js";import"../../chunks/definitions.js";import"../../chunks/shapingUtils.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df32.js";import"../../chunks/Rect.js";import"../../chunks/BoundingBox.js";import"../../chunks/line.js";import"../../chunks/line2.js";import"../../chunks/lineStippleUtils.js";import"../../chunks/interfaces6.js";import"../../chunks/DefaultLayouts.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/Intersector3.js";import"../../chunks/ColorMaterial.js";import"../../chunks/TriangleMaterial.js";import"../../chunks/WebGLRequirements.js";import"../../chunks/capabilities2.js";import"../../chunks/contextUtils.js";import"../../chunks/ray2.js";import"../../chunks/viewpointUtils2.js";import"../../chunks/ZoomMomentumEstimator.js";import"../../chunks/labelFormatUtils.js";import"../../chunks/FeatureTileDescriptor3D.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/hitTest.js";import"../../chunks/LayerConstants.js";import"../../chunks/intersectorUtilsConversions.js";import"../../chunks/ElevationRange.js";import"../../chunks/geometryServiceUtils.js";import"../../chunks/project.js";import"../../rest/support/ProjectParameters.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/terrainUtils.js";import"../../views/3d/support/SceneViewPerformanceInfo.js";import"../../chunks/LayerViewPerformanceInfo.js";import"../../views/3d/support/LayerPerformanceInfo.js";import"../../chunks/ElevationQueryTileCache.js";import"../../chunks/RenderableTile.js";import"../../chunks/mat3f32.js";import"../../chunks/enums3.js";import"../../chunks/TileStrategy.js";import"../../chunks/TileKey2.js";import"../../chunks/QueueProcessor.js";import"../../chunks/config.js";import"../../chunks/TiledDisplayObject.js";import"../../chunks/DisplayObject.js";import"../../chunks/StyleDefinition.js";import"../../chunks/resources.js";import"../../chunks/edgeProcessing.js";import"../../chunks/Viewshed.js";import"../../views/3d/webgl.js";import"../../views/3d/webgl/ManagedFBO.js";import"../../chunks/testSVGPremultipliedAlpha.js";import"../../chunks/RenderingContext.js";import"../../chunks/ProgramCache.js";import"../../chunks/screenshotUtils.js";import"../../chunks/layerViewUtils.js";import"../../views/ui/DefaultUI.js";import"../../views/ui/UI.js";import"../../chunks/themeUtils.js";import"../Attribution.js";import"../Attribution/AttributionViewModel.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/jsxWidgetSupport.js";import"../Compass.js";import"../Compass/CompassViewModel.js";import"../../chunks/utils20.js";import"../support/GoTo.js";import"../NavigationToggle.js";import"../NavigationToggle/NavigationToggleViewModel.js";import"../../chunks/ViewStateManager.js";import"../../views/2d/ViewState.js";import"../../chunks/mat2df64.js";import"../../chunks/unitBezier.js";import"../../chunks/rbush.js";import"../../chunks/quickselect.js";import"../../chunks/Tile.js";import"../../chunks/HighlightOptions.js";import"../../chunks/clippingUtils.js";import"../../chunks/Timeline.js";import"../../chunks/utils6.js";import"../../webmap/background/ColorBackground.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../layers/mixins/ImageryTileMixin.js";import"../../chunks/RawBlockCache.js";import"../../chunks/rasterProjectionHelper.js";import"../../chunks/rasterFunctionHelper.js";import"../../chunks/focalStatUtils.js";import"../../chunks/xmlUtilities.js";import"../../chunks/GCSShiftTransform.js";const dt=new Z({x:0,y:0,z:0,spatialReference:ve.WebMercator}),gt=1e3;function yt(e,t,r){const[i,s,o,a]=t,[n,c,p,l]=r;return ft(e,i,s,o,a,n,c,p,l)}function ft(e,t,r,i,s,o,a,n,c){let p=!1;0===t.z&&0===r.z&&0===i.z&&0===s.z&&(t.z=r.z=i.z=s.z=1,e.z=1),t.z=t.z??1,r.z=r.z??1,i.z=i.z??1,s.z=s.z??1,0===o.z&&0===a.z&&0===n.z&&0===c.z&&(p=!0,o.z=a.z=n.z=c.z=1),o.z=o.z??1,a.z=a.z??1,n.z=n.z??1,c.z=c.z??1;const l=jt(t,r,i,s),m=jt(o,a,n,c),h=je(fe(),l),u=fe();u[0]=m[0]*h[0]+m[1]*h[4]+m[2]*h[8]+m[3]*h[12],u[1]=m[0]*h[1]+m[1]*h[5]+m[2]*h[9]+m[3]*h[13],u[2]=m[0]*h[2]+m[1]*h[6]+m[2]*h[10]+m[3]*h[14],u[3]=m[0]*h[3]+m[1]*h[7]+m[2]*h[11]+m[3]*h[15],u[4]=m[4]*h[0]+m[5]*h[4]+m[6]*h[8]+m[7]*h[12],u[5]=m[4]*h[1]+m[5]*h[5]+m[6]*h[9]+m[7]*h[13],u[6]=m[4]*h[2]+m[5]*h[6]+m[6]*h[10]+m[7]*h[14],u[7]=m[4]*h[3]+m[5]*h[7]+m[6]*h[11]+m[7]*h[15],u[8]=m[8]*h[0]+m[9]*h[4]+m[10]*h[8]+m[11]*h[12],u[9]=m[8]*h[1]+m[9]*h[5]+m[10]*h[9]+m[11]*h[13],u[10]=m[8]*h[2]+m[9]*h[6]+m[10]*h[10]+m[11]*h[14],u[11]=m[8]*h[3]+m[9]*h[7]+m[10]*h[11]+m[11]*h[15],u[12]=m[12]*h[0]+m[13]*h[4]+m[14]*h[8]+m[15]*h[12],u[13]=m[12]*h[1]+m[13]*h[5]+m[14]*h[9]+m[15]*h[13],u[14]=m[12]*h[2]+m[13]*h[6]+m[14]*h[10]+m[15]*h[14],u[15]=m[12]*h[3]+m[13]*h[7]+m[14]*h[11]+m[15]*h[15];const d=u[0]*e.x+u[1]*e.y+u[2]*e.z+u[3],g=u[4]*e.x+u[5]*e.y+u[6]*e.z+u[7],y=u[8]*e.x+u[9]*e.y+u[10]*e.z+u[11];let f=u[12]*e.x+u[13]*e.y+u[14]*e.z+u[15];return 0===f&&(f=1),{x:d/f,y:g/f,z:p?0:y/f}}function jt(e,t,r,i){const s=function(e,t){const[r,i,s,o]=e,a=new Array(4);return a[0]=r*t[0]+i*t[1]+s*t[2]+o*t[3],a[1]=r*t[4]+i*t[5]+s*t[6]+o*t[7],a[2]=r*t[8]+i*t[9]+s*t[10]+o*t[11],a[3]=r*t[12]+i*t[13]+s*t[14]+o*t[15],a}([i.x,i.y,i.z,1],je(new Array(16),[e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,1,1,1,1])),o=s[0],a=s[1],n=s[2],c=new Array(16);return c[0]=o*e.x,c[1]=a*t.x,c[2]=n*r.x,c[3]=0,c[4]=o*e.y,c[5]=a*t.y,c[6]=n*r.y,c[7]=0,c[8]=o*e.z,c[9]=a*t.z,c[10]=n*r.z,c[11]=0,c[12]=o,c[13]=a,c[14]=n,c[15]=1,c}function vt(e,t,r,i,s=ee()){return s[0]=e[0]+t[0]*r,s[1]=e[1]+t[1]*r,s[2]=e[2]+t[2]*(r/i),s}function wt(e,t,r){const i=ee();return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*(t/r),i}function bt(e,t){const[r,i,s]=e,o=ee();return o[0]=r*t[0]+i*t[3]+s*t[6],o[1]=r*t[1]+i*t[4]+s*t[7],o[2]=r*t[2]+i*t[5]+s*t[8],o}function kt(e,t){const r=Math.PI/180,i=ye();if("OPK"===e){const e=Number(t[0])*r,s=Number(t[1])*r,o=Number(t[2])*r;i[0]=Math.cos(s)*Math.cos(o),i[1]=Math.cos(e)*Math.sin(o)+Math.sin(e)*Math.sin(s)*Math.cos(o),i[2]=Math.sin(e)*Math.sin(o)-Math.cos(e)*Math.sin(s)*Math.cos(o),i[3]=-Math.cos(s)*Math.sin(o),i[4]=Math.cos(e)*Math.cos(o)-Math.sin(e)*Math.sin(s)*Math.sin(o),i[5]=Math.sin(e)*Math.cos(o)+Math.cos(e)*Math.sin(s)*Math.sin(o),i[6]=Math.sin(s),i[7]=-Math.sin(e)*Math.cos(s),i[8]=Math.cos(e)*Math.cos(s)}else{const e=Number(t[0])*r,s=Number(t[1])*r,o=Number(t[2])*r;i[0]=Math.cos(e)*Math.cos(o)-Math.sin(e)*Math.cos(s)*Math.sin(o),i[1]=Math.sin(e)*Math.cos(o)*-1-Math.cos(e)*Math.cos(s)*Math.sin(o),i[2]=Math.sin(o)*Math.sin(s)*-1,i[3]=Math.cos(e)*Math.sin(o)+Math.sin(e)*Math.cos(s)*Math.cos(o),i[4]=Math.sin(e)*Math.sin(o)*-1+Math.cos(e)*Math.cos(s)*Math.cos(o),i[5]=Math.cos(o)*Math.sin(s),i[6]=Math.sin(e)*Math.sin(s)*-1,i[7]=Math.cos(e)*Math.sin(s)*-1,i[8]=Math.cos(s)}return i}function Mt(e,t,r){const i=Math.sin(r*Math.PI/180),s=Math.cos(r*Math.PI/180),o=[[e,0],[e,t],[0,t]];o.forEach(((e,t)=>{o[t]=[s*e[0]-i*e[1],i*e[0]+s*e[1]]}));const a=Math.min(0,o[0][0],o[1][0],o[2][0]),n=Math.max(0,o[0][0],o[1][0],o[2][0]),c=Math.min(0,o[0][1],o[1][1],o[2][1]),p=Math.max(0,o[0][1],o[1][1],o[2][1]);return{hfov:Math.abs(n-a),vfov:Math.abs(p-c)}}function _t(e,t){const r=Math.PI/180,i=e.y*r,s=e.x*r,o=e.z||0,a=t[0]*r,n=t[1]*r,c=t[2]/Math.sqrt(1-t[3]*Math.sin(a)**2),p=s-n,l=t[2]/Math.sqrt(1-t[3]*Math.sin(i)**2),m=t[3]*(c*Math.sin(a)-l*Math.sin(i));return{x:(l+o)*Math.cos(i)*Math.sin(p),y:(l+o)*(Math.sin(i)*Math.cos(a)-Math.sin(a)*Math.cos(i)*Math.cos(p))+m*Math.cos(a),z:(l+o)*(Math.sin(i)*Math.sin(a)+Math.cos(a)*Math.cos(i)*Math.cos(p))-c+m*Math.sin(a)}}function xt(e){return e&&X(e?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/Y.radius))):1}function It(e,t,r){const i=360/t,s=180/r;return{heading:(e.x-t/2)*i,pitch:90-(e.y-r/2)*s}}function Ft(e,t,r,i){return{x:r/2+e/(360/r),y:i-t/(180/i),heading:e,pitch:t}}function Pt(e,t){const r=u(Math.acos(-e.z/t));return{heading:u(Math.atan2(e.x,e.y)),pitch:r}}function Rt(e,t,r=gt/2){return[r*(Math.sin(d(e))*Math.sin(d(t))),r*(Math.cos(d(e))*Math.sin(d(t))),r*Math.cos(d(180-t))]}function St(e,t,r){const i=Math.cos(r),s=Math.sin(r),o=[1,0,0,1,0,0],a=o[0]*i+o[2]*s,n=o[1]*i+o[3]*s,c=-o[0]*s+o[2]*i,p=-o[1]*s+o[3]*i;return o[0]=a,o[1]=n,o[2]=c,o[3]=p,[e*o[0]+t*o[2]+o[4],e*o[1]+t*o[3]+o[5]]}const Ct="esri-oriented-imagery-viewer",zt=`${Ct}__carousel`,Ot=`${Ct}__image-enhancement`,Vt=`${Ct}__navigation`,At="--oi-navigation-tool-rotation-from",Lt="--oi-navigation-tool-rotation-to",Ut={addCoverage:`${Ct}__body-additional-coverage`,addExpPoints:`${Ct}__body-additional-camera-locations`,body:`${Ct}__body`,carousel:`${Ct}__carousel`,carouselContainer:`${zt}-container`,carouselContent:`${zt}-content`,carouselItem:`${zt}-item`,carouselItemWrapper:`${zt}-item-wrapper`,close:`${Ct}__close`,currentCoverage:`${Ct}__body-current-coverage`,dock:`${Ct}--docked`,feature:`${Vt}-feature`,float:`${Ct}--floating`,footprint:`${Ct}__body-footprint`,imageEnhancementWrapper:`${Ot}-wrapper`,imageEnhancementTools:`${Ot}-tools`,imageEnhancementToolContainer:`${Ot}-tool-container`,messageBox:`${Ct}__message-box`,navigationPathOffset0:`${Vt}-feature-path-stop-offset-0`,navigationPathOffset1:`${Vt}-feature-path-stop-offset-1`,navigationWrapper:`${Vt}-wrapper`,navigationZoomed:`${Vt}-wrapper--zoomed`,north:`${Vt}-pointer-north`,outerSector:`${Vt}-sector-outer`,pointer:`${Vt}-pointer`,rotateWithAnimation:`${Vt}-animate`,selectedFeaturePath:`${Vt}-feature-path`,sector:`${Vt}-sector`,sectorCross:`${Vt}-sector-cross`,sectorDisabled:`${Vt}-sector-disabled`,sectorEnabled:`${Vt}-sector-enabled`,sectorSeparator:`${Vt}-sector-separator`,submenu:`${Ct}__submenu`,viewer:`${Ct}__viewer`,viewerContainer:`${Ct}__viewer-container`},Tt=120,Ht=[21,36,51,60],Dt=3.5,Et=["FAR_WEST","FAR_NORTH","FAR_EAST","FAR_SOUTH","WEST","NORTH","EAST","SOUTH","NEAR_WEST","NEAR_NORTH","NEAR_EAST","NEAR_SOUTH"],Gt=23.937554159486076,Nt=96.06244584051393,Bt={EAST:[Gt,Gt,Nt,Gt,60,Gt],NORTH:[Gt,Nt,Gt,Gt,Gt,60],SOUTH:[Nt,Gt,Nt,Nt,Nt,60],WEST:[Nt,Nt,Gt,Nt,60,Nt]};let Wt=class{static getCameraOrientation(e){return V(e)}static register(e,t,r){A.set(e,{desc:t,constructor:r})}};Wt=e([P("esri.layers.orientedImagery.core.cameraOrientationFactory")],Wt);const qt=Wt;let $t=class extends(N(l)){constructor(e){super(e),this.cameraOrientation=null,this.elevation=null,this.elevationSource=null,this.name=null,this.sourceMap=null}read(e,t){const r={},{attributes:i,layer:s,geometry:o}=e,a={};for(const e in i)r[e.toLowerCase()]=i[e],a[e.toLowerCase()]=e;super.read({geometry:o,layer:s??{},sourceMap:a,...r},t)}write(e,t){const r=super.write(e,t),{sourceMap:i}=this;if(!i||!r)return r;const s={};for(const e in r){const t=i[e.toLowerCase()];t&&(s[t]=r[e])}return s}readCameraHeading(e,t){const{cameraheading:r,camheading:i,layer:s}=t;return r??i??s.cameraHeading}readCameraHeight(e,t){const{cameraheight:r,avghtag:i,layer:s}=t;return r??i??s.cameraHeight}readCamOffset(e,t){const{cameraoffset:r,camoffset:i}=t;return r?.split(";").map(Number)??i?.split(";").map(Number)??null}writeCameraOffset(e,t){e&&(t.cameraOffset=e.join(";"))}readCameraOrientation(e,t){const{cameraorientation:r,camori:i}=t;return r??i}readCameraPitch(e,t){const{camerapitch:r,campitch:i,layer:s}=t;return r??i??s.cameraPitch}readCameraRoll(e,t){const{cameraroll:r,camroll:i,layer:s}=t;return r??i??s.cameraRoll}readDepthImage(e,t){const{depthimage:r,depthimg:i,layer:s}=t,o=r??i??null,{depthImagePathPrefix:a,depthImagePathSuffix:n}=s??{};return L(o,a,n)}readElevationSource(e,t){const{elevationsource:r,layer:i}=t,{demPathSuffix:s,demPathPrefix:o}=i;if(r){const e=this._parseIfJSON(r);return U(e,o,s)}return i.effectiveElevationSource}readFarDistance(e,t){const{fardistance:r,fardist:i,layer:s}=t;return r??i??s.farDistance}readHFOV(e,t){const{horizontalfieldofview:r,hfov:i,layer:s}=t;return r??i??s.horizontalFieldOfView}readImageURL(e,t){const{imagepath:r,layer:i}=t;r||function(e,t){throw new c("exposure-point:missing-attribute-value","a value for imagePath is missing in attribute table",{exposurePoint:t})}(0,this);const{imagePathPrefix:s,imagePathSuffix:o}=i;return L(r,s,o)}readImageRotation(e,t){const{imagerotation:r,imgrot:i,layer:s}=t;return r??i??s.imageRotation}get isHorizontal(){return"horizontal"===this.orientedImageryType}get isInspection(){return"inspection"===this.orientedImageryType}get isNadir(){return"nadir"===this.orientedImageryType}get isOblique(){return"oblique"===this.orientedImageryType}get isSpherical(){return"360"===this.orientedImageryType}get location(){const{cameraOrientation:e,cameraHeight:t,elevation:r}=this;if(e){const{type:t,x:r,y:i,z:s,horizontalWKID:o}=e;return new Z({x:r,y:i,z:s,spatialReference:{wkid:t===T.LTP?4326:o}})}if("number"!=typeof t)throw function(e){throw new c("exposure-point:missing-default-value","a value for cameraHeight is missing in default properties")}();const i=this.geometry.clone();return i.z=i.hasZ?i.z:(r??0)+t,i}readNearDistance(e,t){const{neardistance:r,neardist:i,layer:s}=t;return r??i??s.nearDistance}readOrientationAccuracy(e,t){const{accuracy:r,orientationaccuracy:i}=t;return i?.split(";").map(Number)??r?.split(";").map(Number)??null}writeOrientationAccuracy(e,t){e&&(t.orientationAccuracy=e.join(";"))}readOIType(e,t){const{orientedimagerytype:r,oitype:i,camerapitch:s,campitch:o,layer:a}=t,n=H.read(r??i??a.orientedImageryType),c=s??o??a.cameraPitch;return"oblique"===n?c<10?"nadir":"oblique":n}readVFOV(e,t){const{verticalfieldofview:r,vfov:i,layer:s}=t;return r??i??s.verticalFieldOfView}_parseIfJSON(e){let t=null;try{t=JSON.parse(e)}catch(t){h.getLogger(this).error("couldn't parse the given elevation source JSON",e,t)}return t}};e([F({type:Date,json:{write:{enabled:!0,target:"aquisitionDate"},name:"acquisitiondate"}})],$t.prototype,"acquisitionDate",void 0),e([F({type:Number,json:{write:!0,read:{source:["cameraheading","camheading","layer.cameraHeading"]}}})],$t.prototype,"cameraHeading",void 0),e([q("cameraHeading")],$t.prototype,"readCameraHeading",null),e([F({type:Number,json:{write:!0}})],$t.prototype,"cameraHeight",void 0),e([q("cameraHeight",["cameraheight","avghtag","layer.cameraHeight"])],$t.prototype,"readCameraHeight",null),e([F()],$t.prototype,"cameraOffset",void 0),e([q("cameraOffset",["cameraoffset","camoffset"])],$t.prototype,"readCamOffset",null),e([$("cameraOffset")],$t.prototype,"writeCameraOffset",null),e([F({json:{write:{writer:(e,t,r)=>{t[r]=e.toString()}}},type:D}),B((e=>e?qt.getCameraOrientation(e):null))],$t.prototype,"cameraOrientation",void 0),e([q("cameraOrientation",["cameraorientation","camori"])],$t.prototype,"readCameraOrientation",null),e([F({type:Number,json:{write:!0}})],$t.prototype,"cameraPitch",void 0),e([q("cameraPitch",["camerapitch","campitch","layer.cameraPitch"])],$t.prototype,"readCameraPitch",null),e([F({type:Number,json:{write:!0}})],$t.prototype,"cameraRoll",void 0),e([q("cameraRoll",["cameraroll","camroll","layer.cameraRoll"])],$t.prototype,"readCameraRoll",null),e([F({json:{write:!0},type:String})],$t.prototype,"depthImage",void 0),e([q("depthImage",["depthimage","depthimg"])],$t.prototype,"readDepthImage",null),e([F({type:Number,json:{write:!0}})],$t.prototype,"elevation",void 0),e([F({json:{write:!0},clonable:"reference"})],$t.prototype,"elevationSource",void 0),e([q("elevationSource",["elevationsource","layer.effectiveElevationSource"])],$t.prototype,"readElevationSource",null),e([F({json:{name:"exposurestationid",write:{target:"exposureStationId"}},type:String})],$t.prototype,"exposureStationId",void 0),e([F({type:Number,json:{write:!0}})],$t.prototype,"farDistance",void 0),e([q("farDistance",["fardistance","fardist","layer.farDistance"])],$t.prototype,"readFarDistance",null),e([F({type:Z,json:{name:"geometry"}})],$t.prototype,"geometry",void 0),e([F({type:Number,json:{write:!0}})],$t.prototype,"horizontalFieldOfView",void 0),e([q("horizontalFieldOfView",["horizontalfieldofview","hfov","layer.horizontalFieldOfView"])],$t.prototype,"readHFOV",null),e([F({json:{write:!0},type:String})],$t.prototype,"imagePath",void 0),e([q("imagePath",["imagepath"])],$t.prototype,"readImageURL",null),e([F({type:Number,json:{write:!0}})],$t.prototype,"imageRotation",void 0),e([q("imageRotation",["imagerotation","imgrot","layer.imageRotation"])],$t.prototype,"readImageRotation",null),e([F()],$t.prototype,"isHorizontal",null),e([F()],$t.prototype,"isInspection",null),e([F()],$t.prototype,"isNadir",null),e([F()],$t.prototype,"isOblique",null),e([F()],$t.prototype,"isSpherical",null),e([F()],$t.prototype,"location",null),e([F({json:{write:!0},type:String})],$t.prototype,"name",void 0),e([F({type:Number,json:{write:!0}})],$t.prototype,"nearDistance",void 0),e([q("nearDistance",["neardistance","neardist","layer.nearDistance"])],$t.prototype,"readNearDistance",null),e([F({json:{write:!0,name:"objectid"},type:Number})],$t.prototype,"objectId",void 0),e([F()],$t.prototype,"orientationAccuracy",void 0),e([q("orientationAccuracy",["accuracy","orientationaccuracy"])],$t.prototype,"readOrientationAccuracy",null),e([$("orientationAccuracy")],$t.prototype,"writeOrientationAccuracy",null),e([W(H)],$t.prototype,"orientedImageryType",void 0),e([q("orientedImageryType",["orientedimagerytype","oitype","layer.orientedImageryType"])],$t.prototype,"readOIType",null),e([F({type:Number,json:{name:"sortorder",write:{target:"sortOrder"}}})],$t.prototype,"sortOrder",void 0),e([F({type:Object})],$t.prototype,"sourceMap",void 0),e([F({type:Number,json:{write:!0}})],$t.prototype,"verticalFieldOfView",void 0),e([q("verticalFieldOfView",["verticalfieldofview","vfov","layer.verticalFieldOfView"])],$t.prototype,"readVFOV",null),$t=e([P("esri.layers.orientedImagery.core.ExposurePoint")],$t);const Zt=$t,Jt={},Qt=Math.PI/180;function Kt(e){return e.isSpherical?function(e){const{geometry:t,farDistance:r,objectId:i,nearDistance:s,cameraHeight:o}=e,a=xt(t),n=new oe({center:t.clone(),radius:r*a});if(n.imageID=i,s){const e=new oe({center:t.clone(),radius:s*a});n.addRing(e.rings[0])}const c=t.clone();c.z=o-r*a;const p=ae.createSphere(c,{size:2*r*a});return p.imageID=i,{polygon:n,frustum:p}}(e):function(e){const{horizontalFieldOfView:t,verticalFieldOfView:r,geometry:i,cameraHeading:s}=e,o=xt(i);let a=e.cameraPitch,n=e.cameraRoll,c=150;t>150&&(a=90,n=0,c=5);const p=Math.ceil(t/c),l=function(e,t,r){const i=[];if(e%2==0)for(let s=0;s<e/2;s++)i.push(t-r/e*(s+.5),t+r/e*(s+.5));else{i.push(t);for(let s=1;s<e/2;s++)i.push(t-r/e*s,t+r/e*s)}return i.sort(),i}(p,s,t);let m=e.farDistance?e.farDistance*o:e.cameraHeight*o/Math.cos(a*Qt);e.cameraPitch+r/2>=90&&(m=(e.farDistance||20)*o);const h=new we({spatialReference:i?.spatialReference});h.imageID=e.objectId;let u=null;for(const s of l)u=Xt(s,a,n,e,i,m,o,r,t,p,h);return u.imageID=e.objectId,{polygon:h,frustum:u}}(e)}function Xt(e,t,r,i,s,o,a,n,c,p,l){const m=kt("HPR",[e,t,r]),h=function(e,t,r){const{cameraHeight:i,cameraPitch:s,farDistance:o,geometry:a,horizontalFieldOfView:n,nearDistance:c,verticalFieldOfView:p}=e,l=tr(a),m=c<0?0:c*l;let h=i*l/Math.cos(s*Qt),u=!0;s+p/2>=90&&(h=(o??20)*l,u=!1);const d=2*Math.tan(p*Qt/2)*m,g=2*Math.tan(n*Qt/2)*m,y=2*Math.tan(p*Qt/2)*h,f=2*Math.tan(n*Qt/2)*h;let j,v;v=[0,0,-1],v=bt(v,t),j=vt([a.x,a.y,i],v,h,l),u&&(j[2]=0);const w=vt([a.x,a.y,i],v,m,l);let b=[0,1,0];b=bt(b,t);let k=[1,0,0];k=bt(k,t);let M=[],_=[];m?(_=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],M=M.concat(ie(ee(),w,re(ee(),wt(b,d/2,l),wt(k,g/2,l)))),M=M.concat(ie(ee(),w,ie(ee(),wt(b,d/2,l),wt(k,g/2,l)))),M=M.concat(re(ee(),w,re(ee(),wt(b,d/2,l),wt(k,g/2,l)))),M=M.concat(re(ee(),w,ie(ee(),wt(b,d/2,l),wt(k,g/2,l))))):(M=[a.x,a.y,i],_=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]),M=M.concat(ie(ee(),j,re(ee(),wt(b,y/2,l),wt(k,f/2,l)))),M=M.concat(ie(ee(),j,ie(ee(),wt(b,y/2,l),wt(k,f/2,l)))),M=M.concat(re(ee(),j,re(ee(),wt(b,y/2,l),wt(k,f/2,l)))),M=M.concat(re(ee(),j,ie(ee(),wt(b,y/2,l),wt(k,f/2,l))));const x=new he({position:Float64Array.from(M)});return new ae({vertexAttributes:x,components:_,spatialReference:a.spatialReference})}(i,m),u=bt([0,0,-1],m),{x:d,y:g}=s,y=vt([d,g,i.cameraHeight],u,o,a),f=2*Math.tan(n*Qt/2)*o,j=2*Math.tan(c/p*Qt/2)*o,v=bt([0,1,0],m),w=bt([1,0,0],m),b=wt(v,f/2,a),k=wt(w,j/2,a),M=re(ee(),b,k),_=ie(ee(),b,k),x=Yt([ie(ee(),y,M),ie(ee(),y,_),re(ee(),y,M),re(ee(),y,_)],i.cameraHeight,s,a);return x.push(x[0]),l.addRing(x),h}function Yt(e,t,r,i){return e.map((e=>function(e,t,r,i){{const s=Math.sqrt((e[2]-t)**2+(Math.sqrt((e[0]-r.x)**2+(e[1]-r.y)**2)/i)**2)*i,o=wt(re(ee(),[e[0],e[1],e[2]],[r.x,r.y,t]),1/s,1/i),a=t/(t-e[2]),n={x:(1-a)*r.x+a*e[0],y:(1-a)*r.y+a*e[1],z:(1-a)*t+a*e[2]},c=Math.sqrt((n.z-t)**2+(Math.sqrt((n.x-r.x)**2+(n.y-r.y)**2)/i)**2)*i,p=wt(re(ee(),[n.x,n.y,n.z],[r.x,r.y,t]),1/c,1/i);return er(o[0],p[0])&&er(o[1],p[1])&&er(o[2],p[2])||e[2]>=0?[e[0],e[1],0]:[n.x,n.y,n.z]}}(e,t,r,i)))}function er(e,t){return Math.sign(e)!==Math.sign(t)}function tr(e){return e&&X(e?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/Y.radius))):1}async function rr(e,t,r){const{cameraHeight:i,cameraLocation:s,cameraPitch:o,frustumVertices:a,horizontalFieldOfView:n,imageHeight:c,imageWidth:p,inSRS:l,outSRS:m,verticalFieldOfView:h,cameraRoll:u,imageRotation:d,options:g}=r,y=new ve(l),f=new ve(m),j=Mt(n,h,u??0),v=a.length>15;return o+j.vfov/2>=90?await async function(e,t,r,i,s,o,a,n=0,c){const p=Math.cos((n??0)*Qt),l=Math.sin((n??0)*Qt),m=Math.abs(r*p+i*l),h=Math.abs(r*-l+i*p);let u,d,g=a?new Array:[e[0],e[1],e[2]],y=new Array;const f=t.length;for(let s=0;s<f;s++){const o=[m/2,h/2],n=t[s];d=[(n[0]-o[0])*p-(n[1]-o[1])*l+o[0],(n[0]-o[0])*l+(n[1]-o[1])*p+o[1]],a?(u=ft({x:d[0],y:d[1],z:1},{x:0,y:0,z:1},{x:r,y:0,z:1},{x:r,y:i,z:1},{x:0,y:i,z:1},{x:e[0],y:e[1],z:e[2]},{x:e[3],y:e[4],z:e[5]},{x:e[6],y:e[7],z:e[8]},{x:e[9],y:e[10],z:e[11]}),g=g.concat([u.x,u.y,u.z]),u=ft({x:d[0],y:d[1],z:1},{x:0,y:0,z:1},{x:r,y:0,z:1},{x:r,y:i,z:1},{x:0,y:i,z:1},{x:e[12],y:e[13],z:e[14]},{x:e[15],y:e[16],z:e[17]},{x:e[18],y:e[19],z:e[20]},{x:e[21],y:e[22],z:e[23]}),y=y.concat([u.x,u.y,u.z])):(u=ft({x:d[0],y:d[1],z:1},{x:0,y:0,z:1},{x:r,y:0,z:1},{x:r,y:i,z:1},{x:0,y:i,z:1},{x:e[3],y:e[4],z:e[5]},{x:e[6],y:e[7],z:e[8]},{x:e[9],y:e[10],z:e[11]},{x:e[12],y:e[13],z:e[14]}),g=g.concat([u.x,u.y,u.z]))}g=g.concat(y);const j=await or(g,s,o,c);return new ae({vertexAttributes:new he({position:j}),components:pr(cr(a)),spatialReference:o})}(a,e,p,c,y,f,v,d,g):await async function(e,t,r,i,s,o,a,n,c){const p=function(e,t,r,i,s){const o=nr(e),a=nr(e,"near");if(!o)return;const{coefficients:n}=o,c=t.length;for(let e=0;e<c;e++){const t=ar([r[e][0],r[e][1]],n),c=r[e];c[2]=(c[2]>=0?t:c[2])??0;const p=[c[0]-i[0],c[1]-i[1],c[2]-(i[2]??s)];sr(i,p,e,a),ir(i,p,e,o,r,t)}return{farPlane:o,nearPlane:a}}(e,t,r,i,s);if(!p)return;const{farPlane:l,nearPlane:m}=p,h=await or([...m?.vertexPositions??e.slice(0,3),...l.vertexPositions],a,n,c);return new ae({vertexAttributes:new he({position:h}),components:pr(cr(o)),spatialReference:n})}(a,e,t,s,i,v,y,f,g)}function ir(e,t,r,i,s,o){const{coefficients:a,vertexPositions:n}=i;if(null!=o&&o>=0)n.splice(3*r,3,...s[r]);else{const i=te();ue(a,le(e,t),i)&&n.splice(3*r,3,...i)}}function sr(e,t,r,i){if(!i)return;const s=te();ue(i.coefficients,le(e,t),s)&&i.vertexPositions.splice(3*r,3,...s)}async function or(e,t,r,i){if(t.equals(r))return e;const s=e.reduce(((e,t,r)=>{const i=Math.floor(r/3);return e[i]||(e[i]=new Array),e[i].push(t),e}),new Array),{points:o}=await ce(new be(s,t),r,i);return v(i),o.flat()}function ar(e,t){if(t)return(-t[3]-t[0]*e[0]-t[1]*e[1])/t[2]}function nr(e,t="far"){const r=de();let i;switch(t){case"far":if(i=Array.from(15===e.length?e.slice(3):e.slice(12)),ge(r,i,!1))return{coefficients:r,vertexPositions:i};break;case"near":if(i=Array.from(e.slice(0,12)),15===e.length||!ge(r,i,!1))return;return{coefficients:r,vertexPositions:i}}}const cr=e=>e?[{faces:new Uint32Array([4,0,3,4,7,3])},{faces:new Uint32Array([5,1,2,5,6,2])},{faces:new Uint32Array([4,0,1,4,5,1])},{faces:new Uint32Array([6,2,3,6,7,3])}]:[{faces:new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1])}],pr=e=>e.map((e=>new me(e))),lr=Math.PI/180;async function mr(e,t,r=!1){if(!e)return[];e=e.map((e=>"esri.geometry.Point"===e.declaredClass?e:Z.fromJSON(e)));const{feature:i}=t,{attributes:s}=i;if(isNaN(parseFloat(s.elevation))){const e=await hr([i.geometry],t);i.attributes.elevation=e[0].z}return hr(e,t,r).then((e=>function(e,t){const{attributes:r}=t.feature;return r.isSpherical||360===r.horizontalFieldOfView?async function(e,t){const r=Array.isArray(e)?e:[e],i=new Array,{location:s,cameraOrientation:o,cameraHeading:a}=t.feature.attributes,n=t.imageProperties.height??1,c=t.imageProperties.width??1;return await async function(e,t,r,i,s,o,a){const n=e.spatialReference.isWGS84&&4!==a?.type?S(e):new Z(e),{latitude:c,longitude:p,ellipsoidRadius:l,squaredEccentricity:m}=a??{};for(const e of t){const t=e.spatialReference.isWGS84&&4===a?.type?new Z(_t(e,[c,p,l,m])):e.spatialReference.equals(n.spatialReference)?new Z(e):await ce(e,n.spatialReference),h=J(n,t);t.x-=n.x,t.y-=n.y,t.z=(t.z??0)-(n.z??0);const u=Pt(t,h);u.heading=(u.heading-r)%360;const{x:d,y:g}=Ft(u.heading,u.pitch,i,s);o.push(new Z(d,g,dt.spatialReference))}}(s,r,a,c,n,i,o),i}(e,t):r.cameraOrientation?.isAdvanced?function(e,t){const{feature:r}=t,{attributes:i}=r,s=i.cameraOrientation;if(!s)throw new c("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let o=new Z(i.location);o.spatialReference.isWGS84&&4!==i.cameraOrientation?.type&&(o=S(o));const a=o.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*o.y/6378137))):1;let n;if("esri.layers.orientedImagery.core.CameraOrientationOPK"===s.declaredClass){const{omega:e,phi:t,kappa:r}=s;n=kt("OPK",[e,t,r])}else{const{cameraHeading:e,cameraPitch:t,cameraRoll:r}=i;n=kt("HPR",[e,t,r])}const{principalOffsetPoint:p,focalLength:l,radialDistortionCoefficients:m,affineTransformations:h,tangentialDistortionCoefficients:u}=s;return Promise.all(e.map((async r=>{let s;return r.spatialReference.equals(o.spatialReference)?(s=new Z(r),c(s)):(await ne(e[0].spatialReference,o.spatialReference,null,t.options),s=pe(r,o.spatialReference),c(s));function c(e){if(e.spatialReference.isWGS84)if(4===i.cameraOrientation?.type){const t=i.cameraOrientation;e=new Z(_t(e,[t.latitude,t.longitude,t.ellipsoidRadius,t.squaredEccentricity]))}else e=new Z(S(e));const t=(e.z??0)-(o.z??0),r=(e.x-o.x)/a,s=(e.y-o.y)/a,c=(n[0]*r+n[1]*s+n[2]*t)/(n[6]*r+n[7]*s+n[8]*t),d=(n[3]*r+n[4]*s+n[5]*t)/(n[6]*r+n[7]*s+n[8]*t),g=c**2+d**2;let y=0,f=0,j=0,v=0,w=0,b=0,k=0;m&&(y=m[0]??0,f=m[1]??0,j=m[2]??0),u&&(v=u[0],w=u[1]),p&&(b=p[0]??0,k=p[1]??0);const M=1+(y||0)*g+(f||0)*g*g+(j||0)*g*g*g;let _=c*M+(v||0)*(g+2*c**2)+2*(w||0)*c*d,x=d*M+(w||0)*(g+2*d**2)+2*(v||0)*c*d;return _=-(l??0)*_+b,x=-(l??0)*x+k,{x:Number(h[0])+Number(h[1])*_+Number(h[2])*x,y:Number(h[3])+Number(h[4])*_+Number(h[5])*x}}})))}(e,t):Promise.resolve(function(e,t){const{feature:r,imageProperties:i}=t,{width:s,height:o}=i,{attributes:a}=r,n=kt("HPR",[a.cameraHeading,a.cameraPitch,a.cameraRoll]),c=Math.sin(a.imageRotation??0*lr),p=Math.cos(a.imageRotation??0*lr),l=s??1,m=o??1,h=[Math.abs(p*l+c*m),Math.abs(p*m-c*l)],u={horizontal:1/(2*Math.tan(a.horizontalFieldOfView*lr/2)),vertical:1/(2*Math.tan(a.verticalFieldOfView*lr/2))},d=[-u.horizontal,0,.5,0,u.vertical,.5,0,0,1];let g=new Z(a.location);g.spatialReference.isWGS84&&4!==a.cameraOrientation?.type&&(g=S(g));const y=g.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*g.y/6378137))):1,f=ke(new Array(9),n,d);return e.map((e=>{let t=new Z(e);if(t.spatialReference.isWGS84)if(4===a.cameraOrientation?.type){const e=a.cameraOrientation;t=new Z(_t(t,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))}else t=new Z(S(t));const r=(t.z??0)-(g.z??0),i=(t.x-g.x)/y,s=(t.y-g.y)/y,o=(f[0]*i+f[1]*s+f[2]*r)/(f[6]*i+f[7]*s+f[8]*r),n=(f[3]*i+f[4]*s+f[5]*r)/(f[6]*i+f[7]*s+f[8]*r),u=o*h[0],d=n*h[1];return{x:p*(u-h[0]/2)+c*(d-h[1]/2)+l/2,y:-c*(u-h[0]/2)+p*(d-h[1]/2)+m/2}}))}(e,t))}(e,t)))}async function hr(e,t,r=!1){if(r)return e;const{feature:{attributes:{cameraOrientation:i,elevationSource:s,cameraHeight:o,location:a},elevationSample:n}}=t;return n?Promise.all(e.map(ur(n,t.options))):s&&(E(s)||s.url?.length)?async function(e,t){const{feature:r,options:i,footprintExtent:s}=t,o=r.attributes.elevationSource;if(!o)return e;if(E(o)){const{constantElevation:t}=o;return"number"!=typeof t?e:dr(e,t)}const{url:a}=o;if(!a)return e;const{elevationSample:n}=r;if(!n){if(!s)return e;const t=s.clone(),{error:n,isSupported:c,isDynamic:p}=await G(a);if(!c){h.getLogger(o).warn(n);const{location:t,cameraHeight:i,cameraOrientation:s}=r.attributes;return dr(e,s&&"number"==typeof t.z?t.z-i:0)}let l,m=e;try{if(p){l=new xe({url:a,format:"lerc",rasterFunction:{functionName:o.rasterFunction??"None"}}),await l.load(i);let e,n=512,c=512;const p=s.width/s.height;p>1?(c/=p,e=t.height/c):(n*=p,e=t.width/n);const m=await l.fetchImage(s,n,c,i),h=Re.create({scales:[e],size:512,spatialReference:s.spatialReference}),u=new Se(null,0,0,0,Me(s)),d=new Pe(m.pixelData.pixelBlock.pixels[0],n,c,0),g=new Fe(u,d);r.elevationSample=new Ie(g,h,void 0)}else l=new _e(a),await l.load(),r.elevationSample=await l.createElevationSampler(t,i);m=await Promise.all(e.map(ur(r.elevationSample,i)))}catch(t){if(!w(t)){h.getLogger("esri.layers.orientedImagery.transformations.groundToImageUtils").warn(`#updateElevation() failed to update elevation using the provided elevation source URL: ${a}. Please provide a valid elevation source url.`,t);const{location:i,cameraHeight:s,cameraOrientation:o}=r.attributes;e=dr(e,o&&"number"==typeof i.z?i.z-s:0)}}finally{l?.destroy()}return m}return await ne(e[0].spatialReference,n.spatialReference,null,t.options),Promise.all(e.map(ur(n,i)))}(e,t):dr(e,i&&"number"==typeof a.z?a.z-o:0)}function ur(e,t){return v(t),async r=>{r.z=1;const i=e.queryElevation(pe(r,e.spatialReference));return i?.z&&(r.z=(await ce(i,r.spatialReference,t)).z),r}}function dr(e,t){return e.map((e=>(e.z=t,e)))}function gr(e,t){if(!e)return Promise.resolve([]);const r=t.feature;let i=r.attributes;return i instanceof Zt||(i=Zt.fromJSON(r),i&&(r.attributes=i)),function(e,t){const{attributes:r}=t.feature;if(r.isSpherical||360===r.horizontalFieldOfView){const{location:i,cameraOrientation:s,farDistance:o,cameraHeading:a,cameraHeight:n}=r;return async function(e,t,r,i,s,o,a){let n=new Z(t);n.spatialReference.isGeographic&&n.spatialReference.isWGS84&&4!==a?.type&&(n=S(n));const c=xt(n),p=new Array,[l,m,h]=n.toArray(),u=Oe([l,m,h??0],r*c),d=dt.toArray();for(const t of e){let e,r;if(Ae(t.heading)&&Ae(t.pitch))e=t.heading,r=t.pitch;else{const s=It({x:t.x,y:t.y},i[0],i[1]);e=s.heading,r=s.pitch}e=(e+s)%360;const a=Ce([d[0],d[1],d[2]],Rt(e,r)),g=ze([l,m,h??0],a.direction),y=te();Ve(u,g,y);const f=(n.z??0)-o;if(y[2]<f){const e=Math.abs((n.z-f)/-a.direction[2])*c;vt([n.x,n.y,n.z],a.direction,e,c,y)}else y[2]=f;p.push(new Z(y,n.spatialReference))}return p}(e,i,o,[t.imageProperties.width,t.imageProperties.height],a,n,s)}return async function(e,t){const{feature:r,footprintExtent:i,options:s}=t,{attributes:{cameraHeight:o,cameraOrientation:a,cameraPitch:n,cameraRoll:c,elevationSource:p,horizontalFieldOfView:l,location:m,verticalFieldOfView:h},elevationSample:u}=r,g=function(e){return 4===e?.type}(a),{vfov:y}=Mt(l,h,c??0);let f=new Z(m),j=!1;g&&(f=new Z(function(e,t){const r=Math.PI/180,i=Number(e.x),s=Number(e.y),o=Number(e.z),a=t[0]*r,n=t[1]*r,c=t[2]/Math.sqrt(1-t[3]*Math.sin(a)**2),p=i/c,l=s/c,m=o/c,h=Math.cos(a)-Math.sin(a)*l+Math.cos(a)*m,u=Math.sin(a)+Math.cos(a)*l+Math.sin(a)*m,d=Math.sqrt(h**2+p**2),g=t[3]*c*Math.sin(a),y=a,f=Math.atan(u/d-(g-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(y)**2))*Math.sin(y))/(c*d)),j=Math.atan(u/d-(g-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(f)**2))*Math.sin(f))/(c*d)),v=Math.atan(u/d-(g-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(j)**2))*Math.sin(j))/(c*d)),w=Math.atan(u/d-(g-t[3]*(t[2]/Math.sqrt(1-t[3]*Math.sin(v)**2))*Math.sin(v))/(c*d)),b=Math.atan(i/(c*h))+n;return{x:b/r,y:w/r,z:i/(Math.cos(w)*Math.sin(b-n))-t[2]/Math.sqrt(1-t[3]*Math.sin(w)**2),spatialReference:{wkid:4326}}}(f,[a.latitude,a.longitude,a.ellipsoidRadius,a.squaredEccentricity]))),f.spatialReference.isWGS84&&(j=!0,f=S(f));const v=xt(f),w=function(e,t,r){const{feature:i}=e,{attributes:s}=i,o=2*Math.tan(d(s.verticalFieldOfView)/2)*s.farDistance*r,a=2*Math.tan(d(s.horizontalFieldOfView)/2)*s.farDistance*r,n=kt("HPR",[s.cameraHeading,s.cameraPitch,s.cameraRoll??0]),c=bt([0,0,-1],n),p=vt([t.x,t.y,t.z],c,s.farDistance*r,r),l=bt([0,1,0],n),m=bt([1,0,0],n),h=wt(l,o/2,r),u=wt(m,a/2,r),g=re(ee(),h,u),y=ie(ee(),h,u);return[ie(ee(),p,g),ie(ee(),p,y),re(ee(),p,g),re(ee(),p,y)].map((e=>{const[r,i,s]=e;return new Z({x:r,y:i,z:s,spatialReference:t.spatialReference})}))}(t,f,v),b=g?w.map((e=>C(new Z(e)))):w,k=await mr(b,t,!0).then((e=>e.map((e=>({x:e.x,y:e.y,z:1}))))),M=new Array;for(const a of e){const e={...a,z:1},c={...yt(e,k,b),spatialReference:f.spatialReference},[l]=await mr([g?C(new Z(c)):new Z(c)],t,!0);await vr(e,l,k,b,f,c,g,t);const m=r.attributes.clone();m.geometry=f.clone();const{polygon:h}=Kt(m),d=h.rings[0].map((e=>new Z(e,h.spatialReference))),w=await ce(p||u?await yr({cameraLocation:f,groundFootPrint:d,projectedPoint:c,webMercatorScalingFactor:v,vfov:y,shouldConvertToLatLong:j,isCameraOrientationLTP:g,imgPoint:e},t):new Z(jr(c,f,v,f.z-o,n,y,j)),i.spatialReference,s);M.push(w)}return M}(e,t)}(e,t)}async function yr(e,t){const{cameraLocation:r,groundFootPrint:i,projectedPoint:s,webMercatorScalingFactor:o,vfov:a,shouldConvertToLatLong:n,isCameraOrientationLTP:c,imgPoint:p}=e,{cameraHeight:l,cameraPitch:m}=t.feature.attributes;await ne(r.spatialReference,t.footprintExtent.spatialReference,null,t.options);let h=await async function(e,t){const r=e[0].spatialReference.isWGS84?ve.WebMercator:e[0].spatialReference,{cameraHeight:i,location:s,elevation:o}=t.feature.attributes,a="number"==typeof s.z&&"number"==typeof o?s.z-o:i,n=Yt(e.map((({x:e,y:t,z:r})=>[e,t,r])),a,s,xt(s)),c=(await hr(n.map((e=>new Z(e,s.spatialReference))),t,!1)).map((e=>pe(e,r)));return new we({hasZ:!0,rings:[c.map((e=>[e.x,e.y,e.z]))],spatialReference:r})}(i,t),u=0,d=(r.z??0)-l,g=0;for(;g<10;){const e=wr(h,r,s);if(!e||!fr([r.x,r.y,r.z],[e.x,e.y,e.z],[s.x,s.y,s.z]))return new Z(jr(s,r,o,d,m,a,n));const i=new Z({x:e.x,y:e.y,z:e.z,spatialReference:r.spatialReference}),l=await mr([c?C(i):i],t);if(u=Math.abs(p.x-l[0].x)+Math.abs(p.y-l[0].y),d=e.z,u<=1)return new Z(jr(s,r,o,d,m,a,n));g+=1;const{extent:y}=h,f=(y?.width??0)/10,j=(y?.height??0)/10;if(f<1||j<1)return new Z(jr(s,r,o,d,m,a,n));const{x:v,y:w}=e,b=await hr(br(f,j).map((([e,t])=>new Z({x:v+e,y:w+t,spatialReference:r.spatialReference}))),t,!1);b.push(b[0]),h=new we({rings:[b.map((e=>e.toArray()))],spatialReference:r.spatialReference})}return new Z(jr(s,r,o,d,m,a,n))}const fr=(e,t,r)=>se(re(ee(),t,e),re(ee(),r,e))>0;function jr(e,t,r,i,s,o,a){const n=Math.sqrt((e.z-t.z)**2+(Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)/r)**2)*r,c=wt(re(ee(),[e.x,e.y,e.z],[t.x,t.y,t.z]),1/n,1/r);if(e.z<i||s+o/2<90){const s=Math.abs((t.z-i)/-c[2])*r,o=vt([t.x,t.y,t.z],c,s,r);e.x=o[0],e.y=o[1],e.z=o[2]}else e.z=i;return a?C(new Z(e)).toJSON():e}async function vr(e,t,r,i,s,o,a,n){let c=0;for(let p=0;p<=8;p+=1){if(c=Math.abs(e.x-t.x)+Math.abs(e.y-t.y),c<=1)return;const[p,l,m,h]=br(c,c).map((([t,o])=>({...ft({x:e.x+t,y:e.y+o,z:1},r[0],r[1],r[2],r[3],{x:i[0].x,y:i[0].y,z:i[0].z},{x:i[1].x,y:i[1].y,z:i[1].z},{x:i[2].x,y:i[2].y,z:i[2].z},{x:i[3].x,y:i[3].y,z:i[3].z}),spatialReference:s.spatialReference}))),[u,d,g,y]=await mr(a?[C(new Z(p)),C(new Z(l)),C(new Z(m)),C(new Z(h))]:[new Z(p),new Z(l),new Z(m),new Z(h)],n,!0).then((e=>e.map((e=>({...e,z:0}))))),{x:f,y:j,z:v}=ft(e,u,d,g,y,p,l,m,h);o.x=f,o.y=j,o.z=v,[t]=await mr([a?C(new Z(o)):new Z(o)],n,!0)}}function wr(e,t,r){const i=e.rings[0][0][0],s=e.rings[0][0][1],o=e.rings[0][0][2],a=e.rings[0][1][0],n=e.rings[0][1][1],c=e.rings[0][1][2],p=e.rings[0][1][0],l=e.rings[0][1][1],m=e.rings[0][1][2],h=e.rings[0][2][0],u=e.rings[0][2][1],d=e.rings[0][2][2],g=(d-m)*(n-s)-(u-l)*(c-o),y=-((d-m)*(a-i)-(c-o)*(h-p)),f=(u-l)*(a-i)-(n-s)*(h-p),j=-(g*i+y*s+f*o),v=function(e,t,r,i,s,o){const a=r*(t.x-e.x)+i*(t.y-e.y)+s*(t.z-e.z);if(0===a)return null;const n=-(r*e.x+i*e.y+s*e.z+o)/a;return{x:e.x+n*(t.x-e.x),y:e.y+n*(t.y-e.y),z:e.z+n*(t.z-e.z)}}(t.toJSON(),r,g,y,f,j);return v}const br=(e,t)=>[[-e,-t],[e,-t],[e,t],[-e,t]];function kr(e){return"esri.Graphic"===e?.declaredClass}function Mr(e){return/.*\.(tif|mrf)$/i.test(e??"")}const _r=e=>`${e}:missing-property`,xr=(e,t)=>`Property ${t} is missing in ${e}`,Ir=(e="esri.widgets.OrientedImageryViewer",t)=>{throw h.getLogger(e).error(t),t};let Fr=class extends(N(l)){constructor(e){super(e),this.maxFOV=0,this.minFOV=0,this.view=null,this.zoomFactor=5}get canZoomIn(){return!!this.view&&(0===this.minFOV||this.view.camera.fov>this.minFOV)}get canZoomOut(){return!!this.view&&(0===this.maxFOV||this.view.camera.fov<this.maxFOV)}};e([F({type:Boolean,readOnly:!0})],Fr.prototype,"canZoomIn",null),e([F({type:Boolean,readOnly:!0})],Fr.prototype,"canZoomOut",null),e([F({type:Number})],Fr.prototype,"maxFOV",void 0),e([F({type:Number})],Fr.prototype,"minFOV",void 0),e([F({type:He})],Fr.prototype,"view",void 0),e([F({type:Number})],Fr.prototype,"zoomFactor",void 0),Fr=e([P("esri.widgets.PanoramicViewer.PanoramicZoomConditions")],Fr);const Pr=Fr;let Rr=class extends qe{constructor(e){super(e),this.panoramicZoomConditions=new Pr,this.zoomTo=e=>{this.view.camera.fov=this.constrainFOV(e),this.view.camera=this.view.camera.clone()}}initialize(){this.addHandles([k((()=>[this.view?.ready,this.panoramicZoomConditions]),(()=>{this.view?.ready&&(this.panoramicZoomConditions.view=this.view,this.zoomTo(this.view.camera.fov))}),M),k((()=>[this.panoramicZoomConditions.maxFOV,this.panoramicZoomConditions.minFOV]),(([e,t])=>{null!=e&&null!=t&&this.zoomTo(this.view.camera.fov)}),_)])}get canZoomIn(){return this.panoramicZoomConditions.canZoomIn}get canZoomOut(){return this.panoramicZoomConditions.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){this._set("view",e)}constrainFOV(e){const{maxFOV:t,minFOV:r}=this.panoramicZoomConditions;return g(e,r,t)}zoomIn(){if(!this.canZoomIn)return;const e=this.view.camera.fov-this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}zoomOut(){if(!this.canZoomOut)return;const e=this.view.camera.fov+this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}};e([F()],Rr.prototype,"canZoomIn",null),e([F()],Rr.prototype,"canZoomOut",null),e([F({type:Pr})],Rr.prototype,"panoramicZoomConditions",void 0),e([F()],Rr.prototype,"state",null),e([F({type:He})],Rr.prototype,"view",null),Rr=e([P("esri.widgets.PanoramicViewer.PanoramicZoomViewModel")],Rr);const Sr=Rr;function Cr(e,t){return 2*u(Math.atan(Math.tan(d(e/2))*Math.sqrt(t**2+1)))}const zr="navigation",Or="fov-constraint";let Vr=class extends p.EventedAccessor{constructor(e){super(e),this._startPosition=null,this._targetPosition=null,this._graphics=new z({elevationInfo:{mode:"relative-to-ground"}}),this._imageGraphic=null,this._loadController=null,this._map=new Ge({ground:new Ee({opacity:0,navigationConstraint:null}),layers:new a([this._graphics])}),this._zoomViewModel=null,this.autoLoad=!1,this.clickAction="none",this.imageSize=null,this.imageSource=null,this.pitch=90,this.state="ready",this.yaw=0,this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=!0,this.imageRenderer.constraints.tilt.max=180,this.removeHandles(zr),this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",(e=>{const t=e.key;["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].includes(t)&&e.stopPropagation()}))],zr)},this._addHFOVHandles=()=>{this.removeHandles(Or),this.addHandles(k((()=>[this.maxHFOV,this.minHFOV]),(()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new Pr({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))}),M),Or)},this._addZoomHandles=()=>{this._zoomViewModel=new Sr({view:this.imageRenderer,panoramicZoomConditions:new Pr({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});const e=new We({viewModel:this._zoomViewModel});this.imageRenderer.ui.add(e,"top-left"),this._addHFOVHandles()},this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._handleDoubleClick=e=>{e.stopPropagation(),e.native.ctrlKey?this._zoomOut():this._zoomIn()},this._handleDrag=e=>{e.stopPropagation();const{action:t,x:r,y:i}=e;switch(t){case"start":this._startPosition=this._targetPosition={x:r,y:i};break;case"update":this._targetPosition={x:r,y:i},this._updateCameraHeadingAndTilt()}},this._handleImageClick=e=>{if("image-loaded"===this.state&&this.imageRenderer.ready)switch(this.clickAction){case"emit":e.stopPropagation(),this.emit("click",e);break;case"hittest":e.stopPropagation(),e.async((async()=>{const t=await this.imageRenderer.hitTest(e.screenPoint,{include:this._graphics});this.emit("hittest-response",t)}));break;case"pixel-location":{if(e.stopPropagation(),!this.imageSize||!e.mapPoint)return void this.emit("pixel-location",null);const t=function(e,t,r,i=gt/2){const{heading:s,pitch:o}=Pt(e,i);return Ft(s,o,t,r)}(e.mapPoint,this.imageSize[0],this.imageSize[1]);this.emit("pixel-location",{...t,spatialReference:ve.WebMercator,meshVertex:e.mapPoint});break}}},this._handleWheel=e=>{const t=e.deltaX??e.native.deltaX;e.stopPropagation(),t>0||e.deltaY>0?this._zoomOut():this._zoomIn()},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._zoomIn=()=>this._zoomViewModel?.zoomIn(),this._zoomOut=()=>this._zoomViewModel?.zoomOut(),this.addGraphic=(e,t)=>"image-loaded"===this.state&&!this._graphics.graphics.includes(e)&&(this._graphics.graphics.add(e,t),!0),this.addManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter((e=>!this._graphics.graphics.includes(e)));return this._graphics.graphics.addMany(t),!0},this.clearGraphics=()=>{this._graphics.graphics.removeAll()},this.clearImage=()=>{this.imageSize=null,this._removeImageSphere()},this.removeGraphic=e=>!("image-loaded"!==this.state||!this._graphics.graphics.includes(e)||(this._graphics.remove(e),0)),this.removeManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter((e=>this._graphics.graphics.includes(e)));return this._graphics.removeMany(t),!0},this._imageRenderer=new He({map:this._map,viewingMode:"local",camera:{position:dt},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:ve.WebMercator,ui:{components:["attribution"]}})}initialize(){this.state="initialized",this.addHandles([k((()=>this.imageSource),(()=>{this.imageSource&&this.autoLoad&&this._loadWithController()}),M),k((()=>this.fov),(()=>{this._reloadCamera()}),M),k((()=>this.yaw),(e=>{this.camera.heading=e,this._reloadCamera()}),M),k((()=>this.pitch),(e=>{this.camera.tilt=e,this._reloadCamera()}),M),x((()=>this.imageRenderer.ready),(()=>{this._addNavigationHandles(),this._addZoomHandles()}),M),k((()=>this.clickAction),(e=>{this.removeHandles("image-click-action"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",this._handleImageClick))}),M)],"default")}get camera(){return this.imageRenderer.camera}set camera(e){e&&(this.imageRenderer.camera=e.clone())}get fov(){return this.camera.fov}set fov(e){Number.isFinite(e)&&this._zoomViewModel?.zoomTo(e)}get hfov(){const{fov:e}=this.camera,{size:[t,r]}=this.imageRenderer,i=t/r,s=Math.atan(i);return 2*u(Math.atan(Math.tan(d(e/2))*Math.sin(s)))}get imageRenderer(){return this._imageRenderer}get maxHFOV(){const{size:[e,t]}=this.imageRenderer;return Cr(120,e/t)}get minHFOV(){const{size:[e,t]}=this.imageRenderer;return Cr(50,e/t)}get vfov(){const{fov:e}=this.camera,{size:[t,r]}=this.imageRenderer,i=t/r,s=Math.atan(i);return 2*u(Math.atan(Math.tan(d(e/2))*Math.cos(s)))}async _loadImageInternal(e,t){let r;this.state="image-loading";try{r=(await Ne(e,{responseType:"image",...t})).data}catch(e){throw w(e)?this.state="image-load-aborted":this.state="image-load-error",e}return this._updateImageSphere(r,t)}_reloadCamera(){this.camera=this.camera.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=y(this._imageGraphic)),this.state="ready",this.imageSize=null}_updateCameraHeadingAndTilt(){if(!this._startPosition||!this._targetPosition)return;const e=this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov;this.yaw=(e+360)%360;const t=this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*this.imageRenderer.camera.tilt;this.pitch=Math.min(179.5,Math.max(.5,t)),this._startPosition=this._targetPosition}async _updateImageSphere(e,r){await b(r);const{size:[i,s]}=this.imageRenderer;var o;return this._imageGraphic=(o=function(e,t=dt,r=gt){const i=t.clone();i.z=-gt/2;const s=ae.createSphere(i,{size:r,densificationFactor:2,vertexSpace:"georeferenced",material:new $e({colorTexture:new Ze({data:e})})});if(s.components[0].trustSourceNormals=!0,s.vertexAttributes.uv){const e=s.vertexAttributes.uv.length??0;for(let t=0;t<e;t++)s.vertexAttributes.uv[2*t+0]=1-s.vertexAttributes.uv[2*t+0],s.vertexAttributes.uv[2*t+1]=s.vertexAttributes.uv[2*t+1]}return s.centerAt(i),s}(e),new t({geometry:o,symbol:new Je({symbolLayers:new a([new Qe])})})),this._graphics.add(this._imageGraphic),this.fov=Cr(114,i/s),this.state="image-loaded",this.imageSize=[e.width,e.height],this._imageGraphic.geometry}async loadImage(e){return this._removeImageSphere(),this.imageSource?this._loadImageInternal(this.imageSource,e):Ir(this.declaredClass,new c(_r("panoramic-viewer"),xr("PanoramicViewerViewModel","imageSource")))}};e([F()],Vr.prototype,"_graphics",void 0),e([F()],Vr.prototype,"_imageGraphic",void 0),e([F()],Vr.prototype,"_imageRenderer",void 0),e([F()],Vr.prototype,"_loadController",void 0),e([F()],Vr.prototype,"_map",void 0),e([F()],Vr.prototype,"_zoomViewModel",void 0),e([F({type:Boolean})],Vr.prototype,"autoLoad",void 0),e([F({type:Te})],Vr.prototype,"camera",null),e([W(new Be({emit:"emit",hittest:"hittest",none:"none","pixel-location":"pixel-location"}))],Vr.prototype,"clickAction",void 0),e([F({type:Number})],Vr.prototype,"fov",null),e([F({readOnly:!0})],Vr.prototype,"hfov",null),e([F({readOnly:!0})],Vr.prototype,"imageRenderer",null),e([F()],Vr.prototype,"imageSize",void 0),e([F()],Vr.prototype,"imageSource",void 0),e([F({readOnly:!0})],Vr.prototype,"maxHFOV",null),e([F({readOnly:!0})],Vr.prototype,"minHFOV",null),e([F({type:Number})],Vr.prototype,"pitch",void 0),e([F()],Vr.prototype,"state",void 0),e([F({readOnly:!0})],Vr.prototype,"vfov",null),e([F({type:Number})],Vr.prototype,"yaw",void 0),Vr=e([P("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],Vr);const Ar=Vr;let Lr=class extends De{constructor(e){super(e),this.viewModel=new Ar,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=e=>this.viewModel.loadImage(e),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get camera(){return this.viewModel.camera}set camera(e){e&&(this.viewModel.camera=e)}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get fov(){return this.camera.fov}set fov(e){this.viewModel.fov=e}get hfov(){return this.viewModel.hfov}get icon(){return"360-view"}set icon(e){this._overrideIfSome("icon",e)}get imageRenderer(){return this.viewModel.imageRenderer}get imageSize(){return this.viewModel.imageSize}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get pitch(){return this.viewModel.pitch}set pitch(e){this.viewModel.pitch=e}get state(){return this.viewModel.state}get vfov(){return this.viewModel.vfov}get yaw(){return this.viewModel.yaw}set yaw(e){this.viewModel.yaw=e}render(){return Ye("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(Ke.widget,"esri-panoramic-viewer")})}};e([F({type:Boolean})],Lr.prototype,"autoLoad",null),e([F({type:Te})],Lr.prototype,"camera",null),e([F()],Lr.prototype,"clickAction",null),e([F({type:Number})],Lr.prototype,"fov",null),e([F({readOnly:!0,type:Number})],Lr.prototype,"hfov",null),e([F()],Lr.prototype,"icon",null),e([F({readOnly:!0,type:He})],Lr.prototype,"imageRenderer",null),e([F({readOnly:!0})],Lr.prototype,"imageSize",null),e([F()],Lr.prototype,"imageSource",null),e([F({type:Number})],Lr.prototype,"pitch",null),e([F({readOnly:!0})],Lr.prototype,"state",null),e([F({readOnly:!0,type:Number})],Lr.prototype,"vfov",null),e([Xe(["click","hittest-response","pixel-location"]),F({type:Ar})],Lr.prototype,"viewModel",void 0),e([F({type:Number})],Lr.prototype,"yaw",null),Lr=e([P("esri.widgets.PanoramicViewer")],Lr);const Ur=Lr,Tr=new tt({size:15,style:"circle",color:[255,102,102,.5],outline:null}),Hr=new tt({size:10,style:"circle",color:[0,128,192,.5],outline:null}),Dr=new rt({style:"solid",color:[0,128,192,.5],outline:null}),Er=new rt({style:"solid",color:[255,102,102,.5],outline:null}),Gr=new tt({size:10,style:"diamond",color:[255,102,102],outline:null}),Nr=new it({symbolLayers:new a([new st({size:10,material:{color:"red"},resource:{primitive:"x"},outline:{color:"black",size:1}})])}),Br=new it({symbolLayers:new a([new ot({width:9,height:9,depth:9,material:{color:[255,102,102]},resource:{primitive:"diamond"},castShadows:!1})])}),Wr=new et({data:{type:"CIMSymbolReference",symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[0,1.4142135623730951],[3.585786437626905,5],[5,3.585786437626905],[1.4142135623730951,0],[5,-3.585786437626905],[3.585786437626905,-5],[0,-1.4142135623730951],[-3.585786437626905,-5],[-5,-3.585786437626905],[-1.4142135623730951,0],[-5,3.585786437626905],[-3.585786437626905,5],[0,1.4142135623730951]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,width:1,color:[0,0,0,100]},{type:"CIMSolidFill",enable:!0,color:[255,0,0,255]}]}}]}]}}}),qr=new Je({symbolLayers:new a([new Qe({material:{color:[255,102,102,.5]},edges:null})])}),$r=new Je({symbolLayers:new a([new Qe({material:{color:[0,128,192,.25]},edges:null})])});let Zr=class extends p.EventedAccessor{constructor(e){super(e),this._imageChanged=!1,this._panConstraint=null,this._image=null,this._loadController=null,this._overlays=new z,this._map=new Ge,this.autoLoad=!1,this.clickAction="none",this.error=null,this.imageSource=null,this.imageRotation=0,this.state="ready",this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._createImageHandles=()=>{this.removeHandles("enhancements-handle"),this.addHandles(k((()=>[this.brightness,this.contrast,this.sharpness]),(([e,t,r])=>{this.image?.loaded&&(this.image.effect=`contrast(${10*(t+10)}%) brightness(${10*(e+10)}%)`,this.sharpenImage(this.image,r))}),M))},this._createPanConstraint=()=>{const{image:e,imageRenderer:t}=this,r=r=>{if(!(e&&t&&r.targetGeometry&&e.serviceRasterInfo))return r;const{extent:i}=e.serviceRasterInfo,{constraints:s,rotation:o,width:a,height:n}=t,{extent:c}=nt(we.fromExtent(i),o),{width:p,height:l}=c,m=r.targetGeometry.clone(),h=s.scaleToZoom(r.scale),u=1/2**h,d=a/n;let g=u*p,y=u*l;h&&(p/a>l/n?y=g/d:g=y*d);const f=c.clone();return f.xmin+=g/2,f.xmax-=g/2,f.ymin+=y/2,f.ymax-=y/2,r.targetGeometry=pt(f,m).coordinate,this.state="image-loaded",r};return{constrain:r,applyPanConstraint:r}},this._createResizeHandles=e=>{e.removeHandles("resize"),e.addHandles(k((()=>{if(!this.imageRenderer.ready)return;const{extent:t}=e.serviceRasterInfo,{width:r,height:i,rotation:s}=this.imageRenderer,{extent:o}=nt(we.fromExtent(t),s),{width:a,height:n}=o;return Math.max(a/r,n/i)}),(e=>{if(!this.imageRenderer||null==e)return;const{constraints:t,scale:r,spatialReference:i}=this.imageRenderer,s=t.minScale,o=ut(i),a=.25*o,n=o*e;let c=n;const p=[];for(;c>a;)p.push(c),c/=2;p.push(c);const{lods:l}=Re.create({scales:p});if(t.set({minScale:n,lods:l}),this._imageChanged)return this.imageRenderer.scale=n,void(this._imageChanged=!1);this.imageRenderer.scale=Math.abs(r-s)<=1e-6?n:r}),M),"resize")},this._loadImageInternal=(e,t={})=>{this.clearImage(),this.error=null,this._imageChanged=!0,this.state="image-loading";const r="string"==typeof e,i=r?void 0:e.datasetFormat,s=r?e:e.url,{customParameters:o,options:a}=t;return this._image=new lt({ioConfig:{skipExtensions:["aux.xml","jgw"],skipMapInfo:!0,datasetFormat:i},url:s,customParameters:o}),this._image.when((e=>{this._updatePanConstraint(),this._createResizeHandles(e),this._map.add(e),this.state="image-loaded"}),(t=>{w(t)?this.state="image-load-aborted":(this.state="image-load-error",this.error=t,h.getLogger(this).error(`error occurred while loading image ${r?e:JSON.stringify(e)}`,t),this.imageSource=null)})),this._image.load(a)},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._updatePanConstraint=()=>{this._panConstraint&&this.imageRenderer.constraints.customConstraints.remove(this._panConstraint),this._panConstraint=this._createPanConstraint(),this.imageRenderer.constraints.customConstraints.add(this._panConstraint)},this.addGraphic=(e,t)=>{this._overlays.graphics.add(e,t)},this.addManyGraphics=e=>{this._overlays.addMany(e)},this.clearGraphics=()=>{this._overlays.graphics.removeAll()},this.clearImage=()=>{this.image&&(this._map.layers.remove(this.image),this._image=y(this._image))},this.loadImage=e=>{const{customParameters:t,imageSource:r}=this;return r?this._loadImageInternal(r,{customParameters:t,options:e}):Ir(this.declaredClass,new c(_r("image-viewer"),xr("ImageViewerViewModel","imageSource")))},this.removeGraphic=e=>{this._overlays.remove(e)},this.removeManyGraphics=e=>{this._overlays.removeMany(e)},this._imageRenderer=new at({constraints:{snapToZoom:!0,rotationEnabled:!1},map:this._map,popupEnabled:!1,spatialReference:ve.WebMercator,ui:{components:["zoom"]}})}initialize(){this.state="initialized",this.addHandles([k((()=>this.imageSource),(e=>{e&&this.autoLoad&&this._loadWithController()}),M),k((()=>this.image?.loaded),(()=>{this._createImageHandles()})),k((()=>this.imageRotation),(()=>{this._rotateImage()})),k((()=>this.imageRenderer.map),((e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)}),I),k((()=>this.imageRenderer.map.allLayers.length),(e=>{e&&this.imageRenderer.map.layers.reorder(this._overlays,e-1)}),M),k((()=>this.clickAction),(e=>{this.removeHandles("click-handle"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",(t=>{if(this.image?.loaded&&this.imageRenderer.ready)switch(e){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.async((async()=>{const e=await this.imageRenderer.hitTest(t.screenPoint,{include:this._overlays});this.emit("hittest-response",e)}));break;case"pixel-location":{if(t.stopPropagation(),!this.image?.serviceRasterInfo||!t.mapPoint)return void this.emit("pixel-location",null);const{extent:e,pixelSize:r}=this.image.serviceRasterInfo,i=(t.mapPoint.x-e.xmin)*r.x,s=(e.ymax-t.mapPoint.y)*r.y,o=new Z({x:i,y:s,spatialReference:e.spatialReference});this.emit("pixel-location",o);break}}})))}),M)])}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",g(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",g(e,-10,10))}get image(){return this._image}get imagePointsInView(){const{extent:e,ready:t}=this.imageRenderer,r=this.imageRotation,i=this.image?.fullExtent,s=this.image?.serviceRasterInfo,o=!0===this._imageRenderer.allLayerViews.find((({layer:e})=>e===this.image))?.attached;if(!(t&&e&&i&&s&&o))return null;const a=nt(we.fromExtent(e),r),n=we.fromExtent(i),c=ct(a,n),{rings:p}=c;return p.flat().map((([e,t])=>({x:(e-s.extent.xmin)*s.pixelSize.x,y:(s.extent.ymax-t)*s.pixelSize.y})))}get imageSize(){const{image:e}=this;if(!e?.raster)return null;const{width:t,height:r}=e.raster.rasterInfo;return[t,r]}get imageRenderer(){return this._imageRenderer}get imageView(){return this.imageRenderer.allLayerViews.find((e=>e.layer===this.image))}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",g(e,0,1))}_rotateImage(){this.imageRenderer.constraints.rotationEnabled=!0,this.imageRenderer.rotation=this.imageRotation,this.imageRenderer.constraints.rotationEnabled=!1}sharpenImage(e,t){if(!t)return void(e.rasterFunction=null);const r=[0,-1*t,0,-1*t,4*t+1,-1*t,0,-1*t,0],i=new mt({functionName:"Convolution",functionArguments:{type:ht.userDefined,cols:3,rows:3,kernel:r,convolutionType:ht.userDefined}});e.rasterFunction=i}};e([F()],Zr.prototype,"_image",void 0),e([F()],Zr.prototype,"_imageRenderer",void 0),e([F()],Zr.prototype,"_loadController",void 0),e([F()],Zr.prototype,"_overlays",void 0),e([F()],Zr.prototype,"_map",void 0),e([F({type:Boolean})],Zr.prototype,"autoLoad",void 0),e([F({type:Number})],Zr.prototype,"brightness",null),e([F()],Zr.prototype,"clickAction",void 0),e([F({type:Number})],Zr.prototype,"contrast",null),e([F({type:Object})],Zr.prototype,"customParameters",void 0),e([F({type:c})],Zr.prototype,"error",void 0),e([F({readOnly:!0})],Zr.prototype,"image",null),e([F({readOnly:!0})],Zr.prototype,"imagePointsInView",null),e([F({readOnly:!0})],Zr.prototype,"imageSize",null),e([F({cast:function(e){return"string"==typeof e&&e.length?e:function(e){return e&&e.url&&e.datasetFormat?e:null}(e)}})],Zr.prototype,"imageSource",void 0),e([F({readOnly:!0})],Zr.prototype,"imageRenderer",null),e([F({type:Number})],Zr.prototype,"imageRotation",void 0),e([F()],Zr.prototype,"imageView",null),e([F({type:Number})],Zr.prototype,"sharpness",null),e([F()],Zr.prototype,"state",void 0),Zr=e([P("esri.widgets.OrientedImageryViewer.components.ImageViewerViewModel")],Zr);const Jr=Zr;let Qr=class extends De{constructor(){super(...arguments),this.viewModel=new Jr,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=async e=>this.viewModel.loadImage(e),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get brightness(){return this.viewModel.brightness}set brightness(e){this.viewModel.brightness=e}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get contrast(){return this.viewModel.contrast}set contrast(e){this.viewModel.contrast=e}get customParameters(){return this.viewModel.customParameters}set customParameters(e){this.viewModel.customParameters=e}get error(){return this.viewModel.error}get imageSize(){const e=this.viewModel.image?.serviceRasterInfo;return e?[e.width,e.height]:[0,0]}get imagePointsInView(){return this.viewModel.imagePointsInView}get imageRenderer(){return this.viewModel.imageRenderer}get imageRotation(){return this.viewModel.imageRotation}set imageRotation(e){this.viewModel.imageRotation=e}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get sharpness(){return this.viewModel.sharpness}set sharpness(e){this.viewModel.sharpness=e}get state(){return this.viewModel.state}render(){return Ye("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(Ke.widget,"esri-image-viewer")})}};e([F({type:Boolean})],Qr.prototype,"autoLoad",null),e([F({type:Number}),F()],Qr.prototype,"brightness",null),e([F()],Qr.prototype,"clickAction",null),e([F({type:Number})],Qr.prototype,"contrast",null),e([F({type:Object})],Qr.prototype,"customParameters",null),e([F({readOnly:!0})],Qr.prototype,"error",null),e([F()],Qr.prototype,"imageSize",null),e([F({readOnly:!0})],Qr.prototype,"imagePointsInView",null),e([F({readOnly:!0,type:at})],Qr.prototype,"imageRenderer",null),e([F()],Qr.prototype,"imageRotation",null),e([F()],Qr.prototype,"imageSource",null),e([Xe(["click","hittest-response","pixel-location"]),F({type:Jr})],Qr.prototype,"viewModel",void 0),e([F({type:Number})],Qr.prototype,"sharpness",null),e([F({readOnly:!0})],Qr.prototype,"state",null),Qr=e([P("esri.widgets.OrientedImageryViewer.components.ImageViewer")],Qr);const Kr=Qr,Xr="view-click",Yr="image-click",ei="interaction-handles",ti=new Set(["JPG","JPEG"]),ri=/\.(\w+)$/;let ii=class extends p.EventedAccessor{constructor(e){super(e),this.additionalFeatures=new a,this.bestFeatureAngle=0,this.coverageFrustums=new a,this.coveragePolygons=new a,this.currentBestFeature=null,this.currentCoverageVisible=!0,this.determineWorkflowForFeature=()=>{f(this._featureChangedTask),this._featureChangedTask=o((async e=>{const{currentBestFeature:t,selectedPoint:r,view:i}=this;if(i?.closePopup(),t&&r){this._initialCurrentCoverageUpdate=!0;try{await this._updatePointsAndPolygons({signal:e}),await this._loadImage({signal:e})}catch(e){w(e)||(this.loadImageError(e),h.getLogger(this).error("#loadIImage()","error occured while loading image",e))}}}))},this.disabled=!1,this.displayMessage={key:"onLoadMessage",type:"info"},this.drawFootprint=()=>{this.bestFeatureFootprint&&this.updateCurrentCoveragePolygon(this.bestFeatureFootprint)},this.features=new a,this.isAdditionalCoverageVisible=!1,this.isAdditionalPointSourcesVisible=!1,this.layer=null,this.localPort=null,this.mapImageConversionToolState=!1,this.navigatorCurrentBestFeature=null,this.pointSources=new a,this.previousFeatureAngle=0,this.selectedPoint=null,this.shouldShowSelectedImage=!1,this.updateFootprint=async(e,t)=>{"image-loaded"===this.state&&await(this._adapter?.updateFootprint(e,t))},this.updateFootprintPanorama=async(e,t)=>{await(this._adapter?.updateFootprintPanorama(e,t))},this._adapter=null,this.additionalFootprints=new a,this.additionalCameraLocations=new a,this.bestFeatureCurrentFootprint=null,this._fetchFeaturesController=null,this._highlightedFeatureHandle=null,this._imageViewer=new Kr,this.bestFeatureFootprint=null,this._initialCurrentCoverageUpdate=!0,this._loading=!1,this._overlays=new z({listMode:"hide",internal:!0,elevationInfo:{mode:"absolute-height"}}),this._panoramicViewer=new Ur,this._referencePointOnGround=null,this._referencePointOnImage=null,this._sectorData=null,this._crossSymbol=null,this.footprintExtent=null,this._featureChangedTask=null,this._openPopupTask=null,this._suitabilities=null,this._transformController=new AbortController,this._updateFootprintTask=null,this.highlight=e=>{if(!this._overlaysView)return;this.removeHighlight();const t=this.additionalFootprints.find((({attributes:{imageID:t}})=>t===Number(e)));this._highlightedFeatureHandle=t?this._overlaysView?.highlight(t):null},this.loadImageFromSource=async(e,t)=>{const{mode:r,imageRotation:i,options:s}=t,o="string"==typeof e,a=o?e:e.url;let n=o?e.match(ri)?.[1]??"":e.datasetFormat;if(!n){const e=await(async(e,t)=>{try{const r=await Ne(e,{...t,method:"head"});return r?.getHeader?.("Content-Type")}catch(e){return h.getLogger("esri.widgets.OrientedImagery").error("failed to fetch Content-Type",e),null}})(a,{...t.options});e&&(n=e.split("/")[1]),n??="UNKNOWN FORMAT"}switch(r){case"default":{this._imageViewer.imageSource={datasetFormat:n.toUpperCase(),url:a};const e=new URL(a);this._imageViewer.customParameters=Object.fromEntries(e.searchParams),this._imageViewer.imageRotation=i??0,await this._imageViewer.loadImage(s);break}case"panoramic":if(this._loading=!0,ti.has(n.toUpperCase())){const{selectedPoint:e}=this,{pitch:r,yaw:i,cameraLocation:o,viewAngle:n}=t;this._panoramicViewer.imageSource=a;let c=i??0;"number"==typeof n?c=n-c:o&&e&&(c=await async function(e,t,r){await ne(t.spatialReference,e.spatialReference,null,r);const i=await ce(t,e.spatialReference,r);let s=u(Math.atan2(i.y-e.y,i.x-e.x));return s=s>=0&&s<=90?90-s:s>90&&s<=180?360-s+90:90+Math.abs(s),s}(o,e)-c),this._panoramicViewer.pitch=r??0,this._panoramicViewer.yaw=c,this._loading=!1,await this._panoramicViewer.loadImage(s)}else this.setMessage("unsupportedPanoramicImageryError","error",void 0,{datasetFormat:n})}},this.loadImageViewer=e=>{this._imageViewer.container=e},this.loadPanoramicViewer=e=>{this._panoramicViewer.container=e},this.removeHighlight=()=>this._highlightedFeatureHandle?.remove(),this.toggleImageAttributes=()=>{f(this._openPopupTask),this._openPopupTask=o((async e=>{const{currentBestFeature:r,popupEnabled:i,layer:s,view:o}=this;if(o?.closePopup(),!(o&&r&&i&&s))return;const{attributes:a,geometry:n}=r,c=new t({geometry:n,attributes:a.toJSON(),popupTemplate:s.popupTemplate});v(e),await o.openPopup({features:[c],location:a.location.clone()})}))},this._getImageSourceFromAttachment=async(e,t,r)=>{const i=new Le({objectIds:[t]}),s=await e.queryAttachments(i,r),o=s[`${t}`]?.[0],a=o?.url;if(!a)throw new c("NoAttachmentError","no attachments found",{[e.objectIdField]:t,layer:e});return{datasetFormat:o.contentType.split("/")[1].toUpperCase(),url:a}},this._loadImage=async e=>{const{currentBestFeature:t,layer:r,mode:i}=this;if(this.clearGraphics(),!r||!t||"none"===i)return;const{attributes:s}=t,{imagePath:o,imageRotation:a,cameraHeading:n,cameraRoll:c,cameraPitch:p,objectId:l,cameraOrientation:m,location:u}=s,d=(c??0)+(a??0),g=u.spatialReference.isWGS84&&4!==m?.type?S(u):new Z(u);let y=o;if("FA"===o)try{y=await this._getImageSourceFromAttachment(r,l,e)}catch(e){if(w(e))return;return function(e){return"NoAttachmentError"===e?.name}(e)?(h.getLogger(this).error(e),void this.setMessage("noAttachment","error",`${r.objectIdField}: ${l}`)):(h.getLogger(this).error(e,{[r.objectIdField]:l,layer:r}),void this.setMessage("imageLoadError","error",`query-attachments-failed:${r.objectIdField} ${l}`))}try{await this.loadImageFromSource(y,{imageRotation:d,options:e,pitch:p,yaw:n,mode:i,cameraLocation:g}),v(e),await this.transformAndPlotSelectedLocation(e)}catch(e){w(e)||this.loadImageError(e)}},this._mapImageConversionToolViewClickHandler=e=>{e.stopPropagation(),e.preventDefault(),e.mapPoint&&this.plotMapPoint(e.mapPoint)},this._viewClickHandler=e=>{"mouse"===e.pointerType&&0!==e.button||(e.stopPropagation(),e.preventDefault(),e.mapPoint&&this.loadBestImage(e.mapPoint))},this.plotSelectedPointOnImage=async(e,r)=>{if(await b(r),!e)return;const i=new Z({...m(e)?e.toJSON():e,spatialReference:ve.WebMercator});if("default"===this.mode)i.x-=.5,i.y=.5-i.y,this._crossSymbol=new t({geometry:i,symbol:Wr}),this._imageViewer.addGraphic(this._crossSymbol,0);else if("panoramic"===this.mode){const{imageSize:r}=this._panoramicViewer;if(!r)return;const[i,s]=r,{heading:o,pitch:a}=It(e,i,s),n=Rt(o,a);this._crossSymbol=new t({geometry:new Z(n,ve.WebMercator),symbol:Nr}),this._panoramicViewer.addGraphic(this._crossSymbol,0)}},this.handleSectorClick=this.handleSectorClick.bind(this),this.searchBestImage=this.searchBestImage.bind(this),this.transformAndPlotReferencePointOnImage=this.transformAndPlotReferencePointOnImage.bind(this),this.updateSuitabilities=this.updateSuitabilities.bind(this),this.determineWorkflowForFeature=this.determineWorkflowForFeature.bind(this),this.selectBestFeature=this.selectBestFeature.bind(this),this.drawFootprint=this.drawFootprint.bind(this)}initialize(){this.addHandles([k((()=>this.view),(async e=>{if(e){switch(this._loading=!0,e.type){case"2d":{const{default:e}=await import("../../chunks/OrientedImageryViewerViewModelAdapter2D.js");this._adapter=new e(this);break}case"3d":{const{default:e}=await import("../../chunks/OrientedImageryViewerViewModelAdapter3D.js");this._adapter=new e(this);break}}this._loading=!1}else this._adapter=null}),M),k((()=>this.view?.map),((e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)}),I),k((()=>this.view?.map?.allLayers?.length),(e=>{e&&this.view?.map?.layers.reorder(this._overlays,e-1)}),I),k((()=>[this.state,this.mapImageConversionToolState,this.view]),(()=>{if(this.removeHandles(Xr),"disabled"===this.state||null==this.view)return;const e=this.mapImageConversionToolState&&"image-loaded"===this.state?this._mapImageConversionToolViewClickHandler:this._viewClickHandler;this.addHandles(this.view.on("click",e,Ue.WIDGET),Xr),this.removeHandles(Yr);const{mapImageConversionToolState:t,mode:r}=this;if(t&&"none"!==r)switch(r){case"default":this._imageViewer.clickAction="pixel-location",this.addHandles(this._imageViewer.on("pixel-location",(async e=>{this.plotReferencePointOnImage(e);const t=this.currentBestFeature;if(t){const r=(await gr([e.toJSON()],{feature:t,imageProperties:{width:this._imageViewer.imageSize[0],height:this._imageViewer.imageSize[1]},options:{signal:this._transformController?.signal},footprintExtent:this.footprintExtent}))[0];r&&this.plotReferencePointOnGround(r)}})),Yr);break;case"panoramic":this._panoramicViewer.clickAction="pixel-location",this.addHandles(this._panoramicViewer.on("pixel-location",(async e=>{this.plotReferencePointOnImage(e);const t=this.currentBestFeature,{imageSize:r}=this._panoramicViewer;if(t&&e&&r){const i=(await gr([e],{feature:t,imageProperties:{width:r[0],height:r[1]},options:{signal:this._transformController?.signal},footprintExtent:this.footprintExtent}))[0];i&&this.plotReferencePointOnGround(i)}})),Yr)}}),M),k((()=>this.bestFeatureAngle),((e,t)=>{this.previousFeatureAngle=t??0}),M),k((()=>this.currentBestFeature),((e,t)=>{this.determineWorkflowForFeature(e,t)}),{sync:!0}),k((()=>this.mode),(e=>{switch(this.removeHandles(ei),e){case"default":this.addHandles(k((()=>this._imageViewer.imagePointsInView),(e=>{e&&(f(this._updateFootprintTask),this._updateFootprintTask=o((async t=>{await this.updateFootprint(e,{signal:t})})))}),{...M,equals:(e,t)=>i(e,t,s)}),ei);break;case"panoramic":this.addHandles(k((()=>{const{currentBestFeature:e}=this,{imageSize:t,vfov:r,hfov:i,pitch:s,yaw:o}=this._panoramicViewer;return e&&t?[r,i,o,s]:null}),(e=>{if(!e||"image-loading"===this.state)return;const[t,r,i,s]=e;f(this._updateFootprintTask),this._updateFootprintTask=o((async e=>{await this.updateFootprintPanorama({verticalFieldOfView:t,horizontalFieldOfView:r,yaw:i,pitch:s},{signal:e})}))}),{...M,equals:(e,t)=>i(e,t,s)}),ei)}}),M),k((()=>[this.brightness,this.contrast,this.sharpness]),(()=>{const{_imageViewer:e,brightness:t,contrast:r,mode:i,sharpness:s}=this;"default"===i&&(e.brightness=t,e.contrast=r,e.sharpness=s)}),M)])}destroy(){this._updateFootprintTask=f(this._updateFootprintTask),this._cancelFetchingFeatures(),this.coverageFrustums.destroy(),this.coveragePolygons.destroy(),this.pointSources.destroy(),this.additionalFootprints.destroy(),this.additionalCameraLocations.destroy(),this.bestFeatureFootprint=y(this.bestFeatureFootprint),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),this._crossSymbol=y(this._crossSymbol),this._referencePointOnGround=y(this._referencePointOnGround),this._referencePointOnImage=y(this._referencePointOnImage),this._overlays&&this.view?.map?.remove(this._overlays),this._overlays.destroy()}get activeLayer(){return n(h.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){n(h.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get activeViewer(){const{_imageViewer:e,_panoramicViewer:t,mode:r}=this;switch(r){case"default":return e;case"panoramic":return t;default:return null}}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",e>10?10:e<-10?-10:e)}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",g(e,-10,10))}get featureCount(){return this.features?.length??0}get imageGalleryEnabled(){return Mr(this.currentBestFeature?.attributes.imagePath.trim())}get imageLoaded(){return n(h.getLogger(this),"imageLoaded",{replacement:'Use OrientedImageryViewer.state === "image-loaded"',version:"4.29",warnOnce:!0}),"image-loaded"===this.state}get imagePointsInView(){const{mode:e,_imageViewer:t}=this;return"default"===e?t.imagePointsInView:null}get mode(){const e=this.currentBestFeature?.attributes;if(!e)return"none";const{horizontalFieldOfView:t,isSpherical:r}=e;return 360===t||r?"panoramic":"default"}get popupEnabled(){return null!==this.layer&&this.layer.popupEnabled}get referencePoint(){return this._referencePointOnGround?.geometry}get sectorData(){const{_sectorData:e}=this;return e?Et.map((t=>e[t])):null}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",g(e,0,1))}get state(){const{mode:e,disabled:t}=this;if(t)return"disabled";if(this._loading)return"image-loading";switch(e){case"default":return this._imageViewer.state;case"panoramic":return this._panoramicViewer.state}return"ready"}get thumbnails(){const{features:e}=this;return e?new a(e.map((({attributes:{imagePath:e,objectId:t,cameraRoll:r,imageRotation:i}})=>{const s=e.trim();return Mr(s)?{url:s,objectId:t,rotation:(r??0)+(i??0)}:null})).filter(r)):null}set view(e){this._set("view",e)}get _overlaysView(){return this.view?.layerViews.find((({layer:e})=>e===this._overlays))}filterByFootprints(e,t){const r=[],i=[],s=[];return e.forEach((e=>{const{layer:{coveragePercent:o},attributes:a}=e;let n;const{polygon:c,frustum:p}=Kt(a);if(n=c.clone(),a.isInspection&&(n=function(e){const{spatialReference:t,x:r,y:i}=e.geometry,{cameraHeading:s,cameraPitch:o,farDistance:a,nearDistance:n}=e,c=tr(e.geometry),p=new we({spatialReference:t}),l=Math.abs(1.44*a*c);let m=Math.abs(1.44*n*c);(o<20||null==s)&&(m=l);const h=[];return h[0]={x:r+l*Math.sin((s-45)*Qt),y:i+l*Math.cos((s-45)*Qt)},h[1]={x:r+l*Math.sin((s+45)*Qt),y:i+l*Math.cos((s+45)*Qt)},h[2]={x:r+m*Math.sin((s+135)*Qt),y:i+m*Math.cos((s+135)*Qt)},h[3]={x:r+m*Math.sin((s+225)*Qt),y:i+m*Math.cos((s+225)*Qt)},p.addRing([[h[0].x,h[0].y,0],[h[1].x,h[1].y,0],[h[2].x,h[2].y,0],[h[3].x,h[3].y,0],[h[0].x,h[0].y,0]]),p}(a)),o&&(n=function(e,t){const r=1+t/100;if("esri.geometry.Circle"===e.declaredClass){const{radius:t,center:i}=e,s=new oe({radius:t*r,center:i});return e.rings.length>1&&s.addRing(e.rings[1]),s}if("esri.geometry.Polygon"===e.declaredClass){const t=new we({spatialReference:e.spatialReference}),i=e.centroid;if(i){const s=[];for(let t=0;t<e.rings[0].length;t++){const o=Math.sqrt((i.x-e.rings[0][t][0])**2+(i.y-e.rings[0][t][1])**2),a=wt(re(ee(),[e.rings[0][t][0],e.rings[0][t][1],0],[i.x,i.y,0]),1/o,1),n=vt([i.x,i.y,0],a,o*r,1);s.push({x:n[0],y:n[1]})}t.addRing([[s[0].x,s[0].y,0],[s[1].x,s[1].y,0],[s[2].x,s[2].y,0],[s[3].x,s[3].y,0],[s[0].x,s[0].y,0]])}return t}return e}(n,o)),function(e,t){return e.contains(t)}(n,t)){s.push(e);const{cameraHeading:t,geometry:o,objectId:n,cameraHeight:l}=a,m=o.clone();m.z=l,m.imageID=n,this.pointSources.push(m),-999!==t&&(r.push(c),p&&i.push(p))}})),{features:s,polygons:r,frustums:i}}getCurrentCoveragePolygon(){return this.bestFeatureCurrentFootprint}getCurrentBestFeaturePolygon(){return this.bestFeatureFootprint}handleSectorClick(e){if(isNaN(e))return;const t=this._sectorData?.[Et[e]];t?.length&&this._updateCurrentBestFeature(t.at(0))}handleFeatureClick(e){const{sector:t,featureIndexInSector:r}=e;if(isNaN(r))return;const i=this._sectorData?.[t];i?.length&&this._updateCurrentBestFeature(i.at(r))}async loadBestImage(e){this._loading=!0,this.view?.closePopup(),this.displayMessage=null,this.selectedPoint=e.spatialReference.isGeographic?S(e):e.clone(),this.features.removeAll(),this.currentBestFeature=null,this.additionalFeatures.removeAll(),this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),this._overlays?.removeAll(),await this._fetchFeaturesWithController(e)}loadImageError(e){h.getLogger(this).error("oriented-imagery-viewer:load-image",e),this.setMessage("imageLoadError","error",e.message)}async plotMapPoint(e){return this.plotReferencePoint(e),this.transformAndPlotReferencePointOnImage({feature:this.currentBestFeature,selectedLocation:e,options:{signal:this._transformController?.signal}})}plotReferencePointOnGround(e){this._referencePointOnGround&&(this._overlays?.remove(this._referencePointOnGround),this._referencePointOnGround.destroy()),null!=e&&(this._referencePointOnGround=new t({geometry:new Z({...e.toJSON()}),symbol:Gr}),this.view?this._overlays?.add(this._referencePointOnGround):this.emit("plot-ground-point",{data:{point:this._referencePointOnGround?.geometry}}))}plotReferencePointOnImage(e){if("image-loaded"===this.state)switch(this._referencePointOnImage&&(this._imageViewer.removeGraphic(this._referencePointOnImage),this._panoramicViewer.removeGraphic(this._referencePointOnImage),this._referencePointOnImage.destroy()),this.mode){case"default":{const r=m(e)?e.toJSON():e;r.x-=.5,r.y=.5-r.y,this._referencePointOnImage=new t({geometry:new Z({spatialReference:this._imageViewer.imageRenderer.spatialReference,...r}),symbol:Gr}),this._imageViewer.addGraphic(this._referencePointOnImage,0);break}case"panoramic":{const{imageSize:r}=this._panoramicViewer;if(!r)return;const[i,s]=r,{heading:o,pitch:a}=It(e,i,s),n=Rt(o,a);this._referencePointOnImage=new t({geometry:new Z(n,ve.WebMercator),symbol:Br}),this._panoramicViewer.addGraphic(this._referencePointOnImage,0);break}}}resetImage(){switch(this.setMessage("onLoadMessage","info"),this.mode){case"default":this._imageViewer.clearImage(),this._imageViewer.clearGraphics();break;case"panoramic":this._panoramicViewer.clearGraphics()}this._cancelFetchingFeatures()}async searchBestImage(e,t){try{const r=await async function(e,t){const{point:r,queryParams:i}=e;if(null==r)return null;const s={};let o=e.layerInstanceOrURL;const a=r.spatialReference.isGeographic?S(r.clone()):r.clone();if(s.outSpatialReference=a.spatialReference,i&&(s.maxRecordCountFactor=i.maxRecordCountFactor??5,s.outFields=i.outFields??["*"],s.where=i.where??"1=1",s.returnGeometry=i.returnGeometry??!0,s.outSpatialReference=i.outSpatialReference),"string"==typeof o&&(Jt.layer&&Jt.layer.url===o?o=Jt.layer:(Jt.layer?.destroy(),o=Jt.layer=new O({url:o}))),o)try{await o.load();const e=o,r=function(e,t){const r=e.x-t,i=e.x+t,s=e.y-t,o=e.y+t;return new K({xmin:r,xmax:i,ymin:s,ymax:o,spatialReference:e.spatialReference})}(a,i?.maximumDistance??e.maximumDistance??1e3);s.returnZ=e.hasZ;const n=new Q({geometry:r,...s}),c=await e.queryFeatures(n,t);return function(e){return t=>{const{features:r,spatialReference:i}=t;return r.forEach((t=>{t.geometry&&(t.geometry.spatialReference=i);const r=Zt.fromJSON({...t.toJSON(),layer:e});r&&(t.attributes=r),t.layer=e,t.spatialReference=i})),t}}(e)(c)}catch(e){j(e)}return null}(e,t);r&&await this._processFeatureResponse(r,e.point,{signal:t?.signal})}catch(e){w(e)||(this.setMessage("imageLoadError","error",e.message),h.getLogger(this).error("error occurred while finding best image",e))}}selectBestFeature(e){this.currentBestFeature=this.features?.find((({attributes:t})=>t.objectId===Number(e)))}setAdditionalCameraLocationsVisibility(e){this.additionalCameraLocations.forEach((t=>{t.visible=e}))}setAdditionalCoverageVisibility(e){this.additionalFootprints.forEach((t=>{t.visible=e}))}setCurrentCoverageVisibility(e){this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.visible=e),this.currentBestFeatureLocation&&(this.currentBestFeatureLocation.visible=e)}setMapImageConversionToolState(e){this.mapImageConversionToolState=e}async transformAndPlotReferencePointOnImage(e){const{selectedLocation:t,options:r}=e,i=this.bestFeatureFootprint?.geometry,s=R(i)&&i.contains(t),o="mesh"===i?.type&&i?.extent.contains(t);if(!s&&!o)return;const a=await this.transformPoint(t,r);return a?(this.plotReferencePointOnImage(a),{x:a.x,y:a.y}):void 0}updateSuitabilities(e){this._suitabilities=e.sort(((e,t)=>e.suitability-t.suitability));const t=this._suitabilities.map((e=>e.feature));this._updateFeatures(t),this._groupFeaturesBySectors(),this._initialCurrentCoverageUpdate=!0}_cancelFetchingFeatures(e){const t=this._fetchFeaturesController;t&&t.abort(e),this._fetchFeaturesController=null}async _fetchFeatures(e,t){if(!this.view)return;const r=this.layer;if(r){const i={include:r},s=this.view.toScreen(e);if(!s)return;const o=await this.view.hitTest(s,i);this._processHitTestResults(r,o,t)}}async _fetchFeaturesWithController(e){this._cancelFetchingFeatures();const t=new AbortController,{signal:r}=t;this._fetchFeaturesController=t;try{await this._fetchFeatures(e,{signal:r}).finally((()=>{this._fetchFeaturesController=null}))}catch(e){this.setMessage("imageLoadError","error"),h.getLogger(this).error("error occurred while fetching features",e)}}_groupFeaturesBySectors(){const{_suitabilities:e,additionalFeatures:t,currentBestFeature:r,features:i}=this;if(!(e&&t&&r&&i))return void(this._sectorData=null);this._sectorData={};for(const e of Et)this._sectorData[e]=new a;const s=e.map(((e,t)=>({...e,featureIndex:t})));s.sort(((e,t)=>e.trueSuitability-t.trueSuitability));const o=s.map((({distance:e})=>e)),n=Math.max(...o);s.forEach((e=>{const{distance:t,angle:r,featureIndex:s}=e,o=t/n*Ht[2],a=function(e,t){const r=e/t*Ht[2];return r<=Ht[0]?"NEAR":r<=Ht[1]?"":"FAR"}(t,n),c=function(e){return Math.abs(e)>=135?"WEST":e<-45&&e>-135?"SOUTH":e<=45?"EAST":"NORTH"}(r);if(!this._sectorData)return;const p=Ht[3]+o*Math.sin(r*Math.PI/180),l=Ht[3]+o*Math.cos(r*Math.PI/180);let m;const h=i.at(s),u=h===this.currentBestFeature,d=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5;if(u&&d)m=-90;else{const e=p-Ht[3],t=l-Ht[3],r=t/Math.sqrt(e**2+t**2);let i=180*Math.acos(r)/Math.PI;(e<0&&t<0||e<0&&t>0)&&(i*=-1),m=i}const g=""===a?c:`${a}_${c}`;u&&(m===this.bestFeatureAngle?this.previousFeatureAngle=m:this.bestFeatureAngle=m,this.navigatorCurrentBestFeature=d?null:{x:p,y:l,direction:c});const y=this._sectorData[g];y.add({angle:r,featureIndex:s,x:p,y:l,objectID:h.attributes.objectId,sector:g,featureIndexInSector:y.length})}))}async _processFeatureResponse(e,t,r){const{features:i}=e;if(!i?.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.removeAll(),this.coverageFrustums.removeAll(),this.pointSources.removeAll();const{features:s,polygons:o,frustums:a}=this.filterByFootprints(i,t);if(!s.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.addMany(o),this.coverageFrustums.addMany(a);const n=new we({spatialReference:o[0].spatialReference});for(const{rings:e}of o)n.addRing(e[0]);const c=[];for(const{geometry:e}of s)n.contains(e)||c.push(e);n.addRing(c);const p=n.extent;var l;let m;if((l=p).xmin/=2,l.xmax*=2,l.ymin/=2,l.ymax*=2,this.footprintExtent=p,this.view?.supportsGround)try{m=await this.view.map.ground.createElevationSampler(p,r)}catch(e){w(e)||h.getLogger(this).error(e)}if(s[0].elevationSample=m,(m||s[0].attributes.elevationSource)&&p){const e=await hr([t],{feature:s[0],footprintExtent:p,options:r});if(e[0]){const r=e[0];t.elevation=r.z}}var u;s[0].elevationSample&&s.forEach((e=>{e.elevationSample=s[0].elevationSample})),this._suitabilities=function(e){const{camera:t,features:r,selectedPoint:i}=e;if(!r.length)return[];e.currentImage??={attributes:{cameraHeading:0,cameraPitch:0}};const s=function(e,t,r){return t.z??=0,t.elevation??=0,i=>{const{hfovWeight:s,vfovWeight:o,distanceWeight:a}=function(e,t){const r="isOblique"in e?e:new Zt(e),{isOblique:i,isSpherical:s,isNadir:o}=r;return s?{hfovWeight:"2d"===t?0:1,vfovWeight:"2d"===t?0:.6,distanceWeight:"2d"===t?1:.5}:o?{hfovWeight:.25,vfovWeight:1,distanceWeight:1}:i?{hfovWeight:1,vfovWeight:.25,distanceWeight:1}:{hfovWeight:1,vfovWeight:1,distanceWeight:1}}(i.attributes,e?"3d":"2d"),n=i.attributes,{cameraHeight:c,cameraHeading:p,cameraPitch:l,farDistance:m,horizontalFieldOfView:h,verticalFieldOfView:u,isOblique:d}=n,g=n.geometry,y=180*Math.atan2(g.y-t.y,g.x-t.x)/Math.PI,f=J(t,g);let j,v,w=h,b=u,k=!1;e?(j=e.heading,v=e.tilt,w=180,b=180,k=!0):!d||l<10?(j=p,v=l,k=!1):(j=r.attributes.cameraHeading,v=l,k=!0,w=180),j>180&&(j-=360);let M=1;g.spatialReference.isWebMercator&&(M=1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*g.y/Y.radius))));const _=Math.sqrt((Math.sqrt((t.x-g.x)**2+(t.y-g.y)**2)/M)**2+((t.z??0)-(t.elevation??0)-c)**2),x=90-180*Math.atan2(t.y-g.y,t.x-g.x)/Math.PI;let I=(Math.abs(x-j)>180?Math.abs(360-Math.abs(x-j)):Math.abs(x-j))/w;I=4*I+1;const F=180*Math.acos((n.cameraHeight-(t.z??0)+(t.elevation??0))/_)/Math.PI;let P=Math.abs(F-v)/b;P=4*P+1;let R=_/Math.sqrt(m**2+c**2);R=4*R+1;const S=s*I+o*P+a*R;let C;if(k){const e=p>180?p-360:p;C=s*((Math.abs(x-e)>180?Math.abs(360-Math.abs(x-e)):Math.abs(x-e))/h*4+1)+o*(Math.abs(F-l)/u*4+1)+a*R}else C=S;return{suitability:S,trueSuitability:C,feature:i,angle:y,distance:f,verticalAngle:Math.abs(180*Math.atan(f/c)/Math.PI)}}}(t,i,e.currentImage);return r.map(s)}({features:s,selectedPoint:t,camera:(u=this.view,"3d"===u?.type?this.view.camera:null),currentImage:this.currentBestFeature}),this.updateSuitabilities(this._suitabilities);const d=this._suitabilities.map((e=>e.feature));this.currentBestFeature=d[0],this._loading=!1}async _processHitTestResults(e,t,r){const{screenPoint:i,results:[s]}=t,o="graphic"===s?.type&&this.shouldShowSelectedImage,a=s?.mapPoint??this.view?.toMap(i);if(!a)return;const n={layerInstanceOrURL:e,point:a,queryParams:{where:e.definitionExpression??"1=1",maximumDistance:e.maximumDistance,objectIds:o?[s.graphic.getAttribute(e.objectIdField)]:void 0}};await this.searchBestImage(n,r)}_updateFeatures(e){if(!e.length)return this.currentBestFeature=null,void this.additionalFeatures.removeAll();this.features.removeAll(),this.features.addMany(e),this.currentBestFeature=e[0],e.length>1?this.additionalFeatures.addMany(e.slice(1)):this.additionalFeatures.removeAll()}async _updatePointsAndPolygons(e){const{pointSources:r,currentBestFeature:i,currentCoverageVisible:s,isAdditionalPointSourcesVisible:o}=this;if(i){this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.destroy(),this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null),await(this._adapter?.createFootprints(e)),v(e);for(const e of r)e.imageID===i.attributes.objectId?this.currentBestFeatureLocation=new t({attributes:{imageID:e.imageID},geometry:e,symbol:Tr,visible:s}):this.additionalCameraLocations.push(new t({attributes:{imageID:e.imageID},geometry:e,symbol:Hr,visible:o}))}}_updateCurrentBestFeature(e){if(!e)return;this.currentBestFeature=this.features?.at(e.featureIndex);const t=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5;let r;if(t)r=-90;else{const t=e.x-Ht[3],i=e.y-Ht[3],s=i/Math.sqrt(t**2+i**2);let o=180*Math.acos(s)/Math.PI;(t<0&&i<0||t<0&&i>0)&&(o*=-1),r=o}r===this.bestFeatureAngle?this.previousFeatureAngle=r:this.bestFeatureAngle=r,this.navigatorCurrentBestFeature=t?null:{x:e.x,y:e.y,direction:e.sector.includes("_")?e.sector.split("_")[1]:e.sector}}clearGraphics(){this._imageViewer.clearGraphics(),this._panoramicViewer.clearGraphics()}plotReferencePoint(e){"mapPoint"in e?this.plotReferencePointOnGround(e.mapPoint):this.plotReferencePointOnGround(e)}setMessage(e,t,r,i){this._loading=!1,this.displayMessage={key:e,type:t,data:r,map:i}}async transformAndPlotSelectedLocation(e){const{currentBestFeature:t,selectedPoint:r,state:i}=this;if(this._crossSymbol&&(this._panoramicViewer.removeGraphic(this._crossSymbol),this._imageViewer.removeGraphic(this._crossSymbol),this._crossSymbol=y(this._crossSymbol)),!r||!t||"image-loaded"!==i)return;let s;try{s=await this.transformPoint(r,e),v(e),await this.plotSelectedPointOnImage(s,e)}catch(e){w(e)||h.getLogger(this).error("failed to transform map point to pixel, cross symbol will not be plotted on image",{error:e,selectedPoint:r,feature:t})}}async transformPoint(e,t){if("none"===this.mode)return;const r=this.currentBestFeature,i=await mr([e],{feature:r,imageProperties:"default"===this.mode?this._imageViewer.viewModel.image.serviceRasterInfo:{width:this._panoramicViewer.imageSize?.[0],height:this._panoramicViewer.imageSize?.[1]},options:t},"3d"===this.view?.type);return i.length?i[0]:void 0}updateCurrentCoveragePolygon(e){const{additionalFootprints:r,additionalCameraLocations:i,currentBestFeature:s,currentBestFeatureLocation:o,currentCoverageVisible:a,selectedPoint:n,view:c,_adapter:p}=this,{attributes:{objectId:l},elevationSample:m}=s;if(this._initialCurrentCoverageUpdate){if(this._overlays?.removeAll(),this._initialCurrentCoverageUpdate=!1,this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),e&&(e.visible=a,this.bestFeatureCurrentFootprint=e),c){const e=[...r,...i,this.bestFeatureCurrentFootprint,o].filter(kr);c.supportsGround&&m&&p?.updateGroundElevation&&p.updateGroundElevation(e,m),n&&e.push(new t({geometry:n.clone(),symbol:Wr.clone(),attributes:{imageID:l}})),this._overlays.graphics.addMany(e)}}else if(c){this.bestFeatureCurrentFootprint&&(this._overlays?.remove(this.bestFeatureCurrentFootprint),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint));const t=this.bestFeatureCurrentFootprint&&this._overlays?this._overlays.graphics.indexOf(this.bestFeatureCurrentFootprint):-1;e&&(this.bestFeatureCurrentFootprint=e,c?.supportsGround&&m&&p?.updateGroundElevation&&p.updateGroundElevation([e],m),e.visible=this.currentCoverageVisible,this._overlays?.graphics.add(this.bestFeatureCurrentFootprint,t>=0?t:this._overlays.graphics.length-1))}}};e([F()],ii.prototype,"activeLayer",null),e([F({readOnly:!0})],ii.prototype,"activeViewer",null),e([F()],ii.prototype,"additionalFeatures",void 0),e([F()],ii.prototype,"bestFeatureAngle",void 0),e([F({type:Number})],ii.prototype,"brightness",null),e([F({type:Number})],ii.prototype,"contrast",null),e([F()],ii.prototype,"coverageFrustums",void 0),e([F()],ii.prototype,"coveragePolygons",void 0),e([F()],ii.prototype,"currentBestFeature",void 0),e([F()],ii.prototype,"currentCoverageVisible",void 0),e([F({json:{write:!1}})],ii.prototype,"determineWorkflowForFeature",void 0),e([F()],ii.prototype,"disabled",void 0),e([F()],ii.prototype,"displayMessage",void 0),e([F()],ii.prototype,"drawFootprint",void 0),e([F({readOnly:!0})],ii.prototype,"featureCount",null),e([F()],ii.prototype,"features",void 0),e([F({readOnly:!0})],ii.prototype,"imageGalleryEnabled",null),e([F({readOnly:!0})],ii.prototype,"imageLoaded",null),e([F()],ii.prototype,"imagePointsInView",null),e([F()],ii.prototype,"isAdditionalCoverageVisible",void 0),e([F()],ii.prototype,"isAdditionalPointSourcesVisible",void 0),e([F()],ii.prototype,"layer",void 0),e([F({type:Number})],ii.prototype,"localPort",void 0),e([F()],ii.prototype,"mapImageConversionToolState",void 0),e([F({readOnly:!0,value:"none"})],ii.prototype,"mode",null),e([F()],ii.prototype,"navigatorCurrentBestFeature",void 0),e([F()],ii.prototype,"pointSources",void 0),e([F({readOnly:!0})],ii.prototype,"popupEnabled",null),e([F()],ii.prototype,"previousFeatureAngle",void 0),e([F()],ii.prototype,"referencePoint",null),e([F({readOnly:!0})],ii.prototype,"sectorData",null),e([F()],ii.prototype,"selectedPoint",void 0),e([F({type:Number})],ii.prototype,"sharpness",null),e([F()],ii.prototype,"shouldShowSelectedImage",void 0),e([F({readOnly:!0})],ii.prototype,"state",null),e([F({readOnly:!0})],ii.prototype,"thumbnails",null),e([F()],ii.prototype,"updateFootprint",void 0),e([F()],ii.prototype,"updateFootprintPanorama",void 0),e([F({value:null})],ii.prototype,"view",null),e([F()],ii.prototype,"_adapter",void 0),e([F({type:a.ofType(t)})],ii.prototype,"additionalFootprints",void 0),e([F({type:a.ofType(t)})],ii.prototype,"additionalCameraLocations",void 0),e([F()],ii.prototype,"bestFeatureCurrentFootprint",void 0),e([F()],ii.prototype,"_fetchFeaturesController",void 0),e([F()],ii.prototype,"_highlightedFeatureHandle",void 0),e([F()],ii.prototype,"_imageViewer",void 0),e([F({type:t})],ii.prototype,"bestFeatureFootprint",void 0),e([F()],ii.prototype,"_initialCurrentCoverageUpdate",void 0),e([F()],ii.prototype,"_loading",void 0),e([F()],ii.prototype,"_overlays",void 0),e([F({readOnly:!0})],ii.prototype,"_overlaysView",null),e([F()],ii.prototype,"_panoramicViewer",void 0),e([F()],ii.prototype,"_referencePointOnGround",void 0),e([F()],ii.prototype,"_referencePointOnImage",void 0),e([F()],ii.prototype,"currentBestFeatureLocation",void 0),e([F()],ii.prototype,"_sectorData",void 0),e([F()],ii.prototype,"footprintExtent",void 0),ii=e([P("esri.widgets.OrientedImageryViewer.OrientedImageryViewerViewModel")],ii);const si=ii;export{Er as a,or as b,Ft as c,qr as d,si as default,$r as e,Kt as f,Ut as g,Dt as h,Tt as i,Ht as j,At as k,Lt as l,Ct as m,Vt as n,Dr as p,St as r,Bt as s,gr as t,rr as u};
